<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>TradeVia (Live Edition)</title>
    
    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TradeVia">
    <meta name="theme-color" content="#0b0f19">
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="/apple-touch-icon.svg">
    <link rel="apple-touch-icon" href="/apple-touch-icon.svg">
    
    <!-- Fonts & Libraries -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    

    <style>
        /* --- HD GÖRÜNTÜ VE NET YAZILAR --- */
body {
    -webkit-font-smoothing: antialiased; /* iOS/Mac için */
    -moz-osx-font-smoothing: grayscale;  /* Firefox için */
    text-rendering: optimizeLegibility;  /* Okunabilirlik optimizasyonu */
}

                    .bottom-nav {
            position: fixed;       /* Ekrana çivile */
            bottom: 0 !important;  /* Kesinlikle en altta olsun */
            left: 0 !important;    /* Kesinlikle en solda olsun */
            right: 0 !important;   /* Kesinlikle en sağa kadar gitsin */
            width: 100%;           /* Ekranı tam kapla */
            height: 70px;          
            background: rgba(21, 27, 43, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 99999;        /* Her şeyin en en üstünde */
            margin: 0;             /* Dış boşluk yok */
            padding-bottom: env(safe-area-inset-bottom); /* iPhone çizgisi için */
        }

        
/* --- TEMALAR & DEĞİŞKENLER (MEGA PAKET) --- */
:root {
    /* 1. OKYANUS (ORİJİNAL VARSAYILAN) */
    --bg-body: #0b0f19;
    --bg-card: #151b2b;
    --bg-input: #1e2538;
    --text-main: #ffffff;
    --text-sub: #94a3b8;
    --accent: #3b82f6;
    --success: #10b981;
    --danger: #ef4444;
    --gold: #f59e0b;
    --kap: #8b5cf6;
    --radius: 16px;
    --accent-glow: rgba(59, 130, 246, 0.5);

    /* Yeni sistem için uyumluluk ekleri */
    --nav-bg: rgba(21, 27, 43, 0.95);
    --border-color: rgba(255, 255, 255, 0.05);
    --text-on-accent: #ffffff;
}

/* 2. MOR (ORİJİNAL) */
[data-theme="purple"] {
    --bg-body: #0f0718;
    --bg-card: #1a0b2e;
    --bg-input: #261245;
    --accent: #8b5cf6;
    --text-sub: #a78bfa;
    --accent-glow: rgba(139, 92, 246, 0.5);
    
    --nav-bg: rgba(26, 11, 46, 0.95);
    --border-color: rgba(139, 92, 246, 0.2);
    --text-on-accent: #ffffff;
}

/* 3. KOYU (ORİJİNAL) */
[data-theme="dark"] {
    --bg-body: #000000;
    --bg-card: #111111;
    --bg-input: #222222;
    --accent: #ffffff;
    --text-sub: #666666;
    --accent-glow: rgba(255, 255, 255, 0.3);
    
    --nav-bg: rgba(17, 17, 17, 0.95);
    --border-color: rgba(255, 255, 255, 0.1);
    --text-on-accent: #000000;
}

/* 4. SİBER (YENİ - NEON) */
[data-theme="cyber"] {
    --bg-body: #0f0518;
    --bg-card: rgba(26, 11, 46, 0.7);
    --bg-input: rgba(45, 20, 80, 0.5);
    --text-sub: #a78bfa;
    --accent: #d946ef;
    --accent-glow: rgba(217, 70, 239, 0.6);
    
    --nav-bg: rgba(20, 5, 30, 0.95);
    --border-color: rgba(217, 70, 239, 0.2);
    --text-on-accent: #ffffff;
}

/* 5. OLED (YENİ - TAM SİYAH) */
[data-theme="oled"] {
    --bg-body: #000000;
    --bg-card: #000000; 
    --bg-input: #111111;
    --text-sub: #888888;
    --accent: #ffffff;
    --accent-glow: rgba(255, 255, 255, 0.3);
    
    --nav-bg: #000000;
    --border-color: #333333;
    --text-on-accent: #000000; 
}

/* 6. LÜKS (YENİ - ALTIN) */
[data-theme="luxury"] {
    --bg-body: #1c1917;
    --bg-card: rgba(41, 37, 36, 0.7);
    --bg-input: rgba(60, 50, 40, 0.5);
    --text-sub: #d6d3d1;
    --accent: #f59e0b;
    --accent-glow: rgba(245, 158, 11, 0.5);
    
    --nav-bg: rgba(28, 25, 23, 0.95);
    --border-color: rgba(245, 158, 11, 0.2);
    --text-on-accent: #000000;
}

        
        /* --- ARKA PLAN ANİMASYONU --- */
#bg-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* Her şeyin arkasında */
    pointer-events: none; /* Tıklamaları engellemez */
    opacity: 0.6; /* Çok baskın olmaması için */
}

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
                body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: background 0.3s; }


        /* ÜST BAR */
.top-bar {
    /* --- SENİN MEVCUT ÖZELLİKLERİN --- */
    flex-shrink: 0;
    background: var(--bg-body);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;

    /* --- GÜNCELLENEN KISIM --- */
    /* Sağ ve Soldan 20px boşluk */
    padding-left: 20px;
    padding-right: 20px;
    
    /* Üstten boşluk: Android'de 0px olur, iPhone'da çentik kadar olur */
    padding-top: env(safe-area-inset-top, 0px);
    padding-bottom: 0;

    /* Yükseklik: Android'de 60px olur, iPhone'da 60px + çentik olur */
    height: calc(60px + env(safe-area-inset-top, 0px));
}


        .icon-btn { position: relative; width: 38px; height: 38px; border-radius: 10px; background: var(--bg-input); color: var(--text-main); border: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.95); }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 10px; font-weight: 800; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-body); display: none; }
        .notif-badge.active { display: flex; animation: bounce 0.3s; }
        @keyframes bounce { 0%{transform:scale(0);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }

        .content-area { flex: 1; overflow: hidden; position: relative; }
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; overflow-y: auto; padding: 15px; padding-bottom: 140px; }
        .page.active { display: flex; z-index: 10; }

        /* GENEL BİLEŞENLER */
        .card, .analysis-card { background: var(--bg-card); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.03); color: var(--text-main); }
        .modern-input { width: 100%; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px; border-radius: 10px; font-size: 16px; margin-bottom: 5px; outline: none; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-main { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 700; font-size: 13px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-sec { background: var(--bg-input); color: var(--text-main); border: 1px solid rgba(255,255,255,0.05); }
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }

        /* --- SKELETON LOADING (Modern/Soft) --- */
        .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.02) 25%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.02) 75%); background-size: 200% 100%; animation: shimmer 2s infinite; border-radius: 16px; height: 70px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.02); }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* --- CÜZDAN SIRALAMA BUTONLARI --- */
        .sort-scroll-wrapper { display: flex; gap: 8px; overflow-x: auto; padding: 5px 2px 10px 2px; margin-bottom: 5px; scrollbar-width: none; }
        .sort-chip { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); color: var(--text-sub); padding: 8px 16px; border-radius: 12px; font-size: 11px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; align-items: center; gap: 6px; backdrop-filter: blur(5px); }
        .sort-chip i { font-size: 11px; opacity: 0.7; }
        .sort-chip.active { background: rgba(59, 130, 246, 0.15); color: var(--accent); border-color: var(--accent); box-shadow: 0 0 15px rgba(59, 130, 246, 0.25); transform: translateY(-1px); }
        .sort-chip:active { transform: scale(0.96); }

        /* --- PİYASA LİSTESİ --- */
        .market-list-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; max-height: 250px; overflow-y: auto; }
        .market-row-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .market-row-item:active { transform: scale(0.98); background: var(--bg-input); }
        .market-row-item:hover { border-color: rgba(255,255,255,0.15); }
        .market-row-item.active { border: 1px solid var(--accent); background: rgba(59, 130, 246, 0.05); }
        .m-row-left { display: flex; align-items: center; gap: 10px; }
        .m-row-info { display: flex; flex-direction: column; }
        .m-row-sym { font-size: 13px; font-weight: 800; color: white; }
        .m-row-name { font-size: 10px; color: var(--text-sub); }
        .m-row-right { text-align: right; }
        .m-row-price { font-size: 14px; font-weight: 700; color: white; display: block; }
        .m-row-change { font-size: 11px; font-weight: 700; display: block; margin-top: 2px; }
        .val-up { color: var(--success); } .val-down { color: var(--danger); } .val-neutral { color: var(--text-sub); }

        /* SATIŞ MODALI & DİĞERLERİ */
        .sell-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sell-ratio-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .ratio-btn { flex: 1; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: var(--text-sub); font-size: 11px; font-weight: 700; padding: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .ratio-btn.active, .ratio-btn:active { background: var(--accent); color: white; }
        .sell-summary-box { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 12px; margin-top: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .ss-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 12px; }
        .ss-row:last-child { margin-bottom: 0; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 8px; margin-top: 5px; }
        .ss-lbl { color: var(--text-sub); font-weight: 600; }
        .ss-val { color: white; font-weight: 800; }
        .ss-pnl { font-weight: 800; }

        /* SİMÜLATÖR */
        .sim-tab-group { display: flex; gap: 5px; background: var(--bg-input); padding: 4px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .sim-tab { flex: 1; text-align: center; padding: 10px 5px; font-size: 11px; font-weight: 700; color: var(--text-sub); border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .sim-tab i { font-size: 14px; margin-bottom: 2px; }
        .sim-tab.active { background: var(--bg-card); color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }
        .sim-content-pane { display: none; animation: fadeIn 0.3s; }
        .sim-content-pane.active { display: block; }
        .sim-result-box { background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%); border: 1px solid rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-top: 15px; position: relative; overflow: hidden; }
        .sim-result-box::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--text-sub); }
        .sim-result-box.profit::before { background: var(--success); }
        .sim-result-box.loss::before { background: var(--danger); }
        .sim-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; align-items: center; }
        .sim-row.big { font-size: 14px; font-weight: 800; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; margin-top: 10px; margin-bottom: 0; }
        .sim-lbl { color: var(--text-sub); }

        /* PROFİL & DİĞERLERİ */
        .profile-section { text-align: center; margin-bottom: 20px; margin-top: 10px; }
        .profile-img-wrap { width: 90px; height: 90px; margin: 0 auto 10px auto; position: relative; border-radius: 50%; border: 2px solid var(--accent); padding: 3px; box-shadow: 0 0 25px var(--accent-glow); }
        .profile-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; background: var(--bg-input); }
        .profile-upload-btn { position: absolute; bottom: 0; right: 0; background: var(--accent); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid var(--bg-card); font-size: 14px; transition: 0.2s; }
        .profile-name { font-size: 18px; font-weight: 800; color: white; margin-bottom: 2px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .profile-tag { font-size: 12px; color: var(--accent); margin-bottom: 10px; display: block; font-weight: 600; }
        .membership-badge { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 800; display: inline-flex; align-items: center; gap: 5px; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); text-transform: uppercase; letter-spacing: 1px; }
        .membership-card-pro { background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(59, 130, 246, 0.15) 100%); border: 1px solid rgba(59, 130, 246, 0.3); padding: 15px; border-radius: 16px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .mc-left { display: flex; flex-direction: column; }
        .mc-title { font-size: 15px; font-weight: 800; color: white; margin-bottom: 4px; }
        .mc-sub { font-size: 11px; color: var(--text-sub); opacity: 0.8; }
        .stat-box { background: linear-gradient(180deg, var(--bg-input) 0%, var(--bg-card) 100%); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .stat-val { color: var(--text-main); font-size: 15px; text-shadow: 0 0 10px rgba(255,255,255,0.1); }
        .stat-label { color: var(--text-sub); font-weight: 700; }
        .collapsible-header { cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; }
        .rotate-icon { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .rotate-icon.rotated { transform: rotate(180deg); }
        .collapsible-content { max-height: 1200px; opacity: 1; overflow: hidden; transition: max-height 0.4s ease, opacity 0.4s ease, margin 0.3s ease; }
        .collapsible-content.collapsed { max-height: 0; opacity: 0; margin-top: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; border:none !important; }
        .trade-card { background: linear-gradient(145deg, var(--bg-card) 0%, rgba(21, 27, 43, 0.6) 100%); border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; padding: 20px; margin-bottom: 15px; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.2); transition: 0.3s; }
        .trade-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; }
        .trade-card.open .trade-header { margin-bottom: 15px; } 
        .trade-title { font-size: 14px; font-weight: 800; color: white; display: flex; align-items: center; gap: 8px; }
        .currency-toggle-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: var(--bg-input); color: var(--text-sub); font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; z-index: 2; }
        .currency-toggle-btn.active-try { color: var(--success); border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .currency-toggle-btn.active-usd { color: var(--accent); border-color: var(--accent); background: rgba(59, 130, 246, 0.1); }
        .trade-input-group { position: relative; margin-bottom: 10px; }
        .trade-input { width: 100%; background: var(--bg-body); border: 1px solid rgba(255,255,255,0.08); color: white; padding: 14px 14px 14px 40px; border-radius: 12px; font-size: 15px; font-weight: 600; outline: none; transition: 0.3s; }
        .trade-input:focus { border-color: var(--accent); background: var(--bg-input); }
        .input-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 14px; pointer-events: none; }
        .trade-summary-box { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .ts-label { color: var(--text-sub); font-weight: 600; }
        .ts-val { color: white; font-weight: 800; font-size: 14px; }
        .add-btn-pro { width: 100%; background: linear-gradient(90deg, var(--accent) 0%, #2563eb 100%); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 800; font-size: 14px; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); transition: 0.2s; }
        .add-btn-pro:active { transform: scale(0.98); }
        .balance-hero { text-align: center; padding: 20px; background: linear-gradient(180deg, var(--bg-input) 0%, var(--bg-body) 100%); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; transition: 0.5s; }
        .balance-hero.profit { background: linear-gradient(180deg, rgba(16, 185, 129, 0.2) 0%, var(--bg-body) 100%); border-color: rgba(16, 185, 129, 0.4); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.1); }
        .balance-hero.loss { background: linear-gradient(180deg, rgba(239, 68, 68, 0.2) 0%, var(--bg-body) 100%); border-color: rgba(239, 68, 68, 0.4); box-shadow: 0 10px 30px rgba(239, 68, 68, 0.1); }
        .val-lg { font-size: 38px; font-weight: 800; margin: 5px 0 15px 0; color: white; letter-spacing: -1px; }
        .hero-stats-row { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .hero-pill { background: rgba(255,255,255,0.05); padding: 8px 14px; border-radius: 20px; font-size: 11px; font-weight: 600; border: 1px solid rgba(255,255,255,0.1); display: inline-flex; align-items: center; gap: 6px; color:white; }
        .hero-pill.cash { background: rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        .hero-actions { display: flex; gap: 8px; justify-content: center; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 15px; }
        .hero-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.08); color: white; padding: 10px 18px; border-radius: 12px; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .asset-card { background: var(--bg-card); border-radius: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.03); overflow: hidden; position: relative; color: white; transition: 0.3s; }
        .asset-card.profit-bg { background: linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, var(--bg-card) 100%); border-color: rgba(16, 185, 129, 0.25); }
        .asset-card.loss-bg { background: linear-gradient(135deg, rgba(239, 68, 68, 0.12) 0%, var(--bg-card) 100%); border-color: rgba(239, 68, 68, 0.25); }
        .asset-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; cursor: pointer; user-select: none; }
        .asset-left { display: flex; align-items: center; }
        .asset-logo-wrap { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--bg-input); margin-right: 12px; border: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; overflow: hidden; }
        .asset-logo-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .asset-avatar-text { font-size: 14px; font-weight: 800; color: var(--text-sub); }
        .asset-name { font-size: 15px; font-weight: 800; display: block; color:white; }
        .asset-meta { font-size: 11px; color: var(--text-sub); }
        .asset-pnl { font-size: 13px; font-weight: 700; padding: 4px 8px; border-radius: 6px; display:flex; align-items:center; gap:8px;}
        .pnl-up { color: var(--success); background: rgba(16, 185, 129, 0.1); } .pnl-down { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .asset-body-content { padding-bottom: 5px; } 
        .asset-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 0 16px 16px 16px; font-size: 12px; }
        .detail-item { display: flex; flex-direction: column; }
        .detail-label { color: var(--text-sub); font-size: 9px; font-weight: 600; text-transform: uppercase; }
        .detail-val { font-weight: 700; color:white; }
        .asset-footer { background: rgba(0,0,0,0.2); padding: 8px 16px; display: flex; justify-content: flex-end; gap: 12px; }
        .tool-btn { background: none; border: none; font-size: 14px; color: var(--text-sub); cursor: pointer; transition: 0.2s; padding: 4px 8px; } 
        .tool-btn:hover { color:white; }
        .tool-btn.active-sim { color: var(--kap) !important; background: rgba(139, 92, 246, 0.15); border-radius: 6px; }
        .active-alarm { color: var(--gold) !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0%{opacity:1;} 50%{opacity:0.5;} 100%{opacity:1;} }
        .asset-note { font-size: 11px; color: var(--gold); background: rgba(245, 158, 11, 0.1); padding: 6px; margin: 0 16px 10px 16px; border-radius: 6px; }
        .asset-mini-chart { height: 0; overflow: hidden; transition: height 0.4s cubic-bezier(0.25, 1, 0.5, 1); background: #131722; border-radius: 0 0 16px 16px; position: relative; }
        .asset-mini-chart.active { height: 320px; border-top: 1px solid rgba(255,255,255,0.05); }
        .chart-loader-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-sub); font-size: 12px; z-index: 0; }
        .tool-btn.chart-on { color: var(--accent) !important; background: rgba(59, 130, 246, 0.15); border-radius: 6px; }
        .notif-card { background: var(--bg-card); padding: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; display: flex; gap: 12px; align-items: flex-start; animation: slideIn 0.3s ease; position: relative; }
        .notif-card.unread { border-left: 3px solid var(--accent); background: rgba(59, 130, 246, 0.05); }
        .notif-icon-box { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px; }
        .notif-content { flex: 1; }
        .notif-title { font-size: 13px; font-weight: 700; color: white; margin-bottom: 2px; }
        .notif-msg { font-size: 11px; color: var(--text-sub); line-height: 1.4; }
        .notif-time { font-size: 9px; color: var(--text-sub); opacity: 0.6; position: absolute; top: 12px; right: 12px; }
        .n-success .notif-icon-box { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .n-danger .notif-icon-box { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .n-info .notif-icon-box { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
        .n-warn .notif-icon-box { background: rgba(245, 158, 11, 0.15); color: var(--gold); }
        @keyframes slideIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
        .currency-pill-wrapper { display: flex; justify-content: flex-end; margin-bottom: 8px; }
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .an-card { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; padding: 16px; color: white; }
        .an-card.full-width { grid-column: span 2; }
        .an-label { font-size: 10px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; margin-bottom: 6px; display: flex; justify-content: space-between; }
        .an-val { font-size: 22px; font-weight: 800; color: white; }
        .an-card.up .an-val { color: var(--success); } .an-card.down .an-val { color: var(--danger); }
        .goal-wrapper { margin-top: 10px; background: var(--bg-input); border-radius: 6px; padding: 2px; }
        .goal-fill { height: 10px; width: 0%; border-radius: 4px; transition: width 1s; }
        .goal-fill.low { background: linear-gradient(90deg, #ef4444, #f87171); } 
        .goal-fill.mid { background: linear-gradient(90deg, #f59e0b, #fbbf24); } 
        .goal-fill.high { background: linear-gradient(90deg, #10b981, #34d399); }
        .chart-toggle-group { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
        .chart-time-btn { background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: var(--text-sub); padding: 6px 16px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; }
        .chart-time-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .stat-circle { width: 100%; height: 250px; position: relative; min-height:250px; }
        .market-switcher { display: flex; background: var(--bg-input); border-radius: 12px; padding: 4px; margin-bottom: 15px; }
        .ms-btn { flex: 1; text-align: center; padding: 12px; font-size: 13px; font-weight: 800; color: var(--text-sub); border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .ms-btn.active { background: var(--bg-card); color: var(--accent); }
        .market-view-section { display: none; } .market-view-section.active { display: block; }
        .market-tabs-pro { display: flex; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 12px; margin-bottom: 10px; overflow-x: auto; scrollbar-width: none; }
        .m-tab-pro { flex: 1; text-align: center; padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; color: var(--text-sub); cursor: pointer; white-space: nowrap; }
        .m-tab-pro.active { background: var(--accent); color: white; }
        .chart-container-pro { position: relative; height: 420px; width: 100%; background: #131722; border-radius: 16px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
        .chart-search-overlay { position: absolute; top: 10px; right: 10px; z-index: 10; background: rgba(30, 41, 59, 0.9); padding: 5px 10px; border-radius: 8px; display: flex; gap: 5px; width: 160px; }
        .cso-input { background: transparent; border: none; color: white; font-size: 11px; width: 100%; outline: none; font-weight: 600; text-transform: uppercase; }
        #tradingview_container { width: 100%; height: 100%; min-height: 420px; }
        .wl-card-classic { background-color: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; position: relative; border: 1px solid rgba(255,255,255,0.05); border-left: 5px solid var(--text-sub); }
        .wl-c-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .wl-c-sym { font-size: 18px; font-weight: 800; color: white; display: block; }
        .wl-c-tag { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; margin-top: 5px; display: inline-block; color: #1e293b; }
        .wl-c-tag.kripto { background: #f59e0b; color: #451a03; } .wl-c-tag.borsa { background: #3b82f6; color: #172554; }
        .wl-c-price-box { text-align: right; }
        .wl-c-price { font-size: 24px; font-weight: 800; color: white; display: block; line-height: 1; }
        .wl-c-change { font-size: 12px; font-weight: 700; margin-top: 4px; display: block; }
        .wl-c-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; }
        .wl-c-stat-item { text-align: center; border-right: 1px solid rgba(255,255,255,0.05); }
        .wl-c-stat-item:last-child { border-right: none; }
        .wl-c-lbl { font-size: 9px; color: var(--text-sub); display: block; margin-bottom: 3px; font-weight: 600; }
        .wl-c-val { font-size: 12px; font-weight: 700; color:white; }
        .wl-c-del { position: absolute; bottom: 12px; right: 12px; background: rgba(239, 68, 68, 0.2); color: var(--danger); width: 32px; height: 32px; border-radius: 8px; border:none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .wl-search-wrapper { position: sticky; top: 0; background: var(--bg-body); padding: 10px 0; z-index: 20; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .wl-search-box { display: flex; gap: 10px; align-items: center; background: var(--bg-input); border-radius: 12px; padding: 5px 10px; border: 1px solid rgba(255,255,255,0.1); }
        .wl-search-input { flex: 1; background: transparent; border: none; color: white; padding: 10px; font-size: 14px; outline: none; }
        .wl-add-btn { background: var(--accent); color: white; border: none; width: 40px; height: 40px; border-radius: 10px; font-size: 18px; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        #wlLiveInfo { font-size: 12px; color: var(--text-sub); padding: 5px; height: 20px; font-weight: 600; display: block; }
        .news-card-pro { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); border-left: 4px solid var(--text-sub); transition: transform 0.2s; }
        .nc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap:5px; }
        .nc-tags-row { display: flex; gap: 4px; flex-wrap: wrap; }
        .nc-tag { font-size: 9px; font-weight: 800; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; color: #1e293b; display: inline-block; }
        .nc-tag.kripto { background: #f59e0b; color: #451a03; } .nc-tag.borsa { background: #3b82f6; color: #172554; } .nc-tag.finans { background: #10b981; color: #064e3b; }
        .nc-asset-tag { background: rgba(255,255,255,0.1); color: white; border:1px solid rgba(255,255,255,0.15); display: flex; align-items: center; gap: 4px; }
        .nc-title { font-size: 14px; font-weight: 700; line-height: 1.4; color: white; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .nc-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px; }
        .nc-source { font-size: 11px; color: var(--text-sub); font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .nc-read-btn { background: rgba(255,255,255,0.05); color: var(--text-main); padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-decoration: none; display: flex; align-items: center; gap: 4px; transition: 0.2s; }
        .news-toolbar-fixed { display: flex; gap: 8px; margin-bottom: 20px; align-items: stretch; }
        .news-input-fix { flex: 1; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.08); color: white; padding: 0 12px; border-radius: 12px; font-size: 13px; height: 44px; outline: none; }
        .news-btn-fix { width: 44px; height: 44px; background: var(--accent); color: white; border: none; border-radius: 12px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .kap-btn-fix { background: var(--kap); color: white; border: none; border-radius: 12px; padding: 0 15px; font-weight: 800; font-size: 12px; height: 44px; cursor: pointer; }
        .hist-filter-scroll { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 15px; scrollbar-width: none; }
        .h-filter-btn { background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: var(--text-sub); padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer; white-space: nowrap; }
        .h-filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
       
         
            
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 9999;
            
            transform: none !important;  /* Ortalamayı iptal et */
            max-width: none !important;  /* Genişlik sınırını kaldır */
            padding-bottom: env(safe-area-inset-bottom); /* iPhone alt çizgi payı */
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2); /* Hafif gölge */
        }

                     .nav-item { 
            color: #64748b;        /* Pasif ikon rengi (Gri) */
            padding: 0;
            height: 100%;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            gap: 4px;              /* İkon ve yazı arası boşluk */
            flex: 1; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }

        .nav-item i {
            font-size: 20px;       /* İkon boyutu */
            transition: 0.3s;
        }
        
        .nav-item span {
            font-size: 10px;       /* Yazı boyutu */
            font-weight: 600;
        }

        /* Aktif Olduğunda Ne Olsun? */
        .nav-item.active { 
            color: white; 
            transform: translateY(-4px); /* Seçilince hafif yukarı çıksın */
        }
        
        .nav-item.active i {
            color: #3b82f6;       /* Mavi renk */
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.6)); /* NEON PARLAMA */
        }

            /* --- GÜNCELLENMİŞ MODAL & AYARLAR STİLİ (TAŞMA KORUMALI) --- */
        
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.85); 
            z-index: 200; 
            
            /* Merkezleme ve Dış Boşluk */
            display: none; 
            align-items: center !important; 
            justify-content: center !important; 
            
            backdrop-filter: blur(5px); 
            padding: 20px; /* Dış çerçeve güvenli alanı */
        }

        .modal { 
            background: var(--bg-card); 
            /* İç boşluğu artırdık, içerik kenara yapışmaz */
            padding: 25px; 
            
            border-radius: 24px;
            width: 100%; 
            max-width: 360px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: white; 
            
            /* Ekranın tepesine/altına çok yapışmaması için %80 yaptık */
            max-height: 80vh; 
            
            /* Kaydırma Ayarları */
            overflow-y: auto; 
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            
            /* SİHİRLİ KOD: Kaydırırken arka planın oynamasını engeller */
            overscroll-behavior: contain; 
            
            /* Açılış Animasyonu */
            animation: zoomInModal 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Scroll çubuğunu gizle ama kaydırmaya izin ver */
        .modal::-webkit-scrollbar { display: none; }

        @keyframes zoomInModal {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* --- DİĞER MEVCUT STİLLER (AYNEN KORUNDU) --- */
        .privacy-blur { filter: blur(8px); opacity: 0.5; transition: 0.3s; }
        .settings-tabs { display: flex; background: var(--bg-input); border-radius: 12px; padding: 4px; margin-bottom: 15px; }
        .s-tab { flex: 1; text-align: center; padding: 10px; font-size: 12px; font-weight: 700; color: var(--text-sub); border-radius: 8px; cursor: pointer; }
        .s-tab.active { background: var(--bg-card); color: var(--accent); }
        .settings-content { display: none; } .settings-content.active { display: block; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .setting-select { background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 8px 12px; border-radius: 8px; font-size: 12px; outline: none; }
        .poly-wrapper { position: relative; display: flex; align-items: center; gap: 10px; }
        .poly-status-dot { width: 12px; height: 12px; border-radius: 50%; background-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); transition: 0.3s; flex-shrink: 0; }
        .poly-status-dot.active { background-color: var(--success); box-shadow: 0 0 15px var(--success); }
        .poly-status-dot.error { background-color: var(--danger); box-shadow: 0 0 15px var(--danger); }
        .poly-status-dot.idle { background-color: var(--text-sub); box-shadow: none; opacity: 0.5; }
        .nav-container { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .nav-hidden { transform: translate(-50%, 200%) !important; }

        /* --- ORİJİNAL LOGO SPLASH SCREEN (HIZLI & LÜKS) --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            z-index: 9999999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.4s ease-out, visibility 0.4s;
        }
        #splash-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .original-logo-container { width: 200px; height: 200px; animation: zoomInLogo 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
        .tm-part { opacity: 0; animation: fadeInPart 0.5s ease-out forwards; }
        .tm-shield-outer { animation-delay: 0.1s; } .tm-shield-blue { animation-delay: 0.2s; } .tm-shield-gold { animation-delay: 0.3s; }
        .tm-bull-bear { animation-delay: 0.4s; } .tm-letters { animation-delay: 0.5s; } .tm-arrow { animation-delay: 0.6s; transform-origin: center; animation: drawArrowOriginal 0.6s ease-out forwards 0.6s; opacity: 0; }
        .splash-brand-name { margin-top: 30px; font-family: 'Inter', sans-serif; font-size: 28px; letter-spacing: 4px; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; opacity: 0; animation: fadeUpText 0.5s ease-out forwards 0.7s; }
        .splash-loader-bar { width: 140px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 20px; overflow: hidden; opacity: 0; animation: fadeInPart 0.3s ease-out forwards 0.8s; }
        .splash-loader-bar::after { content: ''; display: block; width: 40%; height: 100%; background: linear-gradient(90deg, #f59e0b, #d97706); animation: loadingMove 1s infinite ease-in-out; }
        @keyframes zoomInLogo { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeInPart { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeUpText { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes drawArrowOriginal { from { opacity: 0; transform: translate(-20px, 20px) scale(0.8); } to { opacity: 1; transform: translate(0, 0) scale(1); } }
        @keyframes loadingMove { 0% { transform: translateX(-100%); } 100% { transform: translateX(300%); } }

        /* === CRYSTAL PREMIUM LOGO STYLES === */
        .crystal-logo-wrapper {
            position: relative;
            animation: crystalFloat 4s ease-in-out infinite;
        }
        
        .crystal-logo-svg {
            filter: drop-shadow(0 0 30px rgba(59, 130, 246, 0.4));
            animation: crystalGlow 3s ease-in-out infinite;
        }
        
        @keyframes crystalFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes crystalGlow {
            0%, 100% { filter: drop-shadow(0 0 30px rgba(59, 130, 246, 0.4)); }
            50% { filter: drop-shadow(0 0 50px rgba(59, 130, 246, 0.7)); }
        }
        
        .glass-reflection-overlay {
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 40%,
                rgba(255,255,255,0.03) 45%,
                rgba(255,255,255,0.05) 50%,
                rgba(255,255,255,0.03) 55%,
                transparent 60%
            );
            animation: glassShimmer 6s infinite linear;
            pointer-events: none;
            z-index: 10;
        }
        
        @keyframes glassShimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        /* === KİLİT EKRANI (LOCK SCREEN) === */
        #lock-screen {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            z-index: 99999999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.4s ease-out, visibility 0.4s;
            padding: 20px;
        }
        #lock-screen.active { display: flex; }
        #lock-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        .lock-logo-mini {
            width: 80px; height: 80px;
            margin-bottom: 20px;
            filter: drop-shadow(0 10px 30px rgba(59, 130, 246, 0.4));
            animation: lockPulse 3s ease-in-out infinite;
        }
        @keyframes lockPulse {
            0%, 100% { filter: drop-shadow(0 10px 30px rgba(59, 130, 246, 0.4)); }
            50% { filter: drop-shadow(0 10px 40px rgba(59, 130, 246, 0.6)); }
        }

        .lock-title {
            font-family: 'Inter', sans-serif;
            font-size: 22px;
            font-weight: 800;
            color: #ffffff;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        .lock-subtitle {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 35px;
            font-weight: 500;
        }

        /* PIN Girişi */
        .pin-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 300px;
        }

        .pin-dots {
            display: flex;
            gap: 18px;
            margin-bottom: 35px;
        }
        .pin-dot {
            width: 16px; height: 16px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .pin-dot.filled {
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
            border-color: transparent;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            transform: scale(1.1);
        }
        .pin-dot.error {
            background: #ef4444;
            border-color: #ef4444;
            animation: pinShake 0.5s ease;
        }
        @keyframes pinShake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }

        /* Numpad */
        .pin-numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            width: 100%;
            max-width: 280px;
        }
        .numpad-btn {
            width: 75px; height: 75px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #ffffff;
            font-size: 28px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            backdrop-filter: blur(10px);
        }
        .numpad-btn:active {
            background: rgba(59, 130, 246, 0.3);
            border-color: rgba(59, 130, 246, 0.5);
            transform: scale(0.95);
        }
        .numpad-btn.action {
            background: transparent;
            border-color: transparent;
            font-size: 22px;
            color: #94a3b8;
        }
        .numpad-btn.action:active {
            color: #ffffff;
            background: transparent;
        }
        .numpad-btn.action i { font-size: 20px; }

        .lock-error-msg {
            color: #ef4444;
            font-size: 12px;
            font-weight: 600;
            margin-top: 20px;
            min-height: 20px;
            text-align: center;
        }

        .lock-forgot-link {
            margin-top: 30px;
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
        }
        .lock-forgot-link:hover { color: rgba(255, 255, 255, 0.7); }

        /* Şifre Ayarlama Modalı */
        .pin-setup-modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 99999998;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(10px);
        }
        .pin-setup-modal.active { display: flex; }

        .pin-setup-card {
            background: linear-gradient(165deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.98) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 30px 25px;
            width: 100%;
            max-width: 340px;
            text-align: center;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .pin-setup-title {
            font-size: 18px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 8px;
        }
        .pin-setup-desc {
            font-size: 13px;
            color: #94a3b8;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        .pin-setup-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px; height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .pin-setup-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Ayarlar Sayfası - Güvenlik Bölümü */
        .security-setting-card {
            background: linear-gradient(165deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .security-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .security-icon {
            width: 44px; height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #3b82f6;
        }
        .security-info h3 {
            font-size: 15px;
            font-weight: 700;
            color: white;
            margin: 0 0 3px 0;
        }
        .security-info p {
            font-size: 12px;
            color: #94a3b8;
            margin: 0;
        }
        .security-toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        .security-toggle-label {
            font-size: 13px;
            font-weight: 600;
            color: #e2e8f0;
        }
        .security-btn-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .security-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .security-btn.primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
        }
        .security-btn.danger {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .security-btn:active { transform: scale(0.98); }

        .pin-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
        }
        .pin-status-badge.active {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
        }
        .pin-status-badge.inactive {
            background: rgba(148, 163, 184, 0.15);
            color: #94a3b8;
        }

        /* Premium Toggle Switch */
        .premium-switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }
        .premium-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .premium-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(148, 163, 184, 0.3);
            border-radius: 34px;
            transition: 0.3s;
        }
        .premium-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .premium-switch input:checked + .premium-slider {
            background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
        }
        .premium-switch input:checked + .premium-slider:before {
            transform: translateX(24px);
        }

        /* === PREMIUM PERFORMANCE DASHBOARD v2 === */
        
        /* Performance Section Container */
        #an-view-perf {
            --perf-bg-deep: #030712;
            --perf-card-bg: rgba(15, 23, 42, 0.5);
            --perf-glass: rgba(255, 255, 255, 0.02);
            --perf-border: rgba(255, 255, 255, 0.06);
            --perf-glow-blue: rgba(59, 130, 246, 0.4);
            --perf-glow-green: rgba(16, 185, 129, 0.4);
            --perf-glow-gold: rgba(251, 191, 36, 0.4);
            --perf-glow-purple: rgba(139, 92, 246, 0.4);
            --perf-accent-cyan: #22d3ee;
            --perf-accent-emerald: #34d399;
            --perf-accent-rose: #fb7185;
        }
        
        /* Dashboard Grid */
        .dashboard-container { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
            padding-bottom: 20px;
            position: relative;
        }
        
        /* Premium Card Base */
        .dash-card { 
            background: linear-gradient(165deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 24px; 
            padding: 20px; 
            position: relative; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .dash-card:hover {
            border-color: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
        }
        
        .dash-card.full-width { grid-column: span 2; }
        
        /* Card Glow Effect */
        .dash-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
        }
        
        .dash-card::after { 
            content: ''; 
            position: absolute; 
            top: -50%; 
            left: -50%; 
            width: 200%; 
            height: 200%; 
            background: radial-gradient(ellipse at center, rgba(59, 130, 246, 0.03) 0%, transparent 70%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .dash-card:hover::after {
            opacity: 1;
        }
        
        /* Premium Metric Title */
        .metric-title { 
            font-size: 10px; 
            color: rgba(148, 163, 184, 0.9);
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 1.5px; 
            margin-bottom: 12px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            position: relative;
        }
        
        .metric-title i {
            font-size: 12px;
            opacity: 0.7;
            margin-right: 6px;
        }
        
        /* Premium Large Value */
        .metric-value { 
            font-size: 32px; 
            font-weight: 800; 
            color: white; 
            letter-spacing: -1px;
            background: linear-gradient(135deg, #ffffff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
        }
        
        .metric-sub { 
            font-size: 11px; 
            font-weight: 500; 
            margin-top: 8px; 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        
        /* Premium Trend Pills */
        .trend-up { 
            color: #34d399; 
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
            padding: 4px 10px; 
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
            border: 1px solid rgba(16, 185, 129, 0.2);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.1);
        }
        
        .trend-down { 
            color: #fb7185; 
            background: linear-gradient(135deg, rgba(244, 63, 94, 0.15) 0%, rgba(244, 63, 94, 0.05) 100%);
            padding: 4px 10px; 
            border-radius: 20px;
            font-weight: 700;
            font-size: 12px;
            border: 1px solid rgba(244, 63, 94, 0.2);
            box-shadow: 0 0 20px rgba(244, 63, 94, 0.1);
        }
        
        /* Win Rate Premium Container */
        .win-rate-container { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            position: relative; 
            height: 130px;
        }
        
        .win-rate-text { 
            position: absolute; 
            text-align: center;
            z-index: 2;
        }
        
        .wr-val { 
            font-size: 26px; 
            font-weight: 800; 
            display: block; 
            background: linear-gradient(135deg, #ffffff 0%, #22d3ee 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .wr-lbl { 
            font-size: 9px; 
            color: rgba(148, 163, 184, 0.7);
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        /* Top Performers Premium List */
        .top-performer-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 14px 16px;
            margin: 6px 0;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.04);
            transition: all 0.3s ease;
        }
        
        .top-performer-row:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.08);
            transform: translateX(4px);
        }
        
        .tp-name { 
            font-weight: 600; 
            font-size: 13px; 
            color: rgba(255, 255, 255, 0.9);
            display: flex; 
            align-items: center; 
            gap: 12px;
        }
        
        .tp-val { 
            font-weight: 700; 
            font-size: 14px;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }
        
        /* Premium Rank Badges */
        .rank-badge { 
            width: 28px; 
            height: 28px; 
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 11px; 
            font-weight: 700; 
            color: rgba(148, 163, 184, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }
        
        .rank-1 { 
            background: linear-gradient(145deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.1) 100%);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.15);
        }
        
        .rank-badge.rank-2 {
            background: linear-gradient(145deg, rgba(192, 192, 192, 0.15) 0%, rgba(148, 163, 184, 0.1) 100%);
            color: #cbd5e1;
            border: 1px solid rgba(203, 213, 225, 0.2);
        }
        
        .rank-badge.rank-3 {
            background: linear-gradient(145deg, rgba(205, 127, 50, 0.15) 0%, rgba(180, 83, 9, 0.1) 100%);
            color: #d97706;
            border: 1px solid rgba(217, 119, 6, 0.2);
        }
        
        /* Chart Header Premium */
        .chart-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 16px;
        }
        
        .chart-filter-btn { 
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.06);
            color: rgba(148, 163, 184, 0.8);
            font-size: 10px; 
            font-weight: 600;
            padding: 6px 14px; 
            border-radius: 10px; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: 0.5px;
        }
        
        .chart-filter-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.2);
        }
        
        .chart-filter-btn.active { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3) 0%, rgba(59, 130, 246, 0.15) 100%);
            color: #60a5fa;
            border-color: rgba(59, 130, 246, 0.4);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.15);
        }
        
        /* === HERO NET WORTH CARD === */
        .dash-card.perf-hero-card {
            background: linear-gradient(165deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.9) 50%, rgba(10, 15, 30, 0.95) 100%);
            border: 1px solid rgba(59, 130, 246, 0.15);
            padding: 24px;
            position: relative;
            overflow: hidden;
        }
        
        .dash-card.perf-hero-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.6), rgba(139, 92, 246, 0.4), transparent);
        }
        
        .dash-card.perf-hero-card::after {
            content: '';
            position: absolute;
            top: -100px;
            right: -100px;
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .perf-hero-card .metric-title {
            color: rgba(96, 165, 250, 0.9);
            font-size: 11px;
            letter-spacing: 2px;
        }
        
        .perf-hero-card .metric-value {
            font-size: 38px;
            background: linear-gradient(135deg, #ffffff 0%, #60a5fa 50%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 8px 0;
        }
        
        /* === TRADER REPORT CARD PREMIUM === */
        .dash-card.perf-trader-card {
            background: linear-gradient(165deg, rgba(30, 41, 59, 0.6) 0%, rgba(20, 15, 35, 0.8) 100%);
            border: 1px solid rgba(251, 191, 36, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .dash-card.perf-trader-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(251, 191, 36, 0.5), rgba(245, 158, 11, 0.3), transparent);
        }
        
        .perf-trader-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .perf-trader-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(251, 191, 36, 0.9);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }
        
        .perf-trader-title i {
            font-size: 14px;
            color: #fbbf24;
        }
        
        .perf-score-badge {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.08) 100%);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.25);
        }
        
        .perf-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .perf-stat-box {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.04);
            border-radius: 16px;
            padding: 14px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .perf-stat-box:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(255, 255, 255, 0.08);
        }
        
        .perf-stat-label {
            font-size: 9px;
            color: rgba(148, 163, 184, 0.8);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        
        .perf-stat-value {
            font-size: 20px;
            font-weight: 800;
            color: white;
        }
        
        .perf-stat-desc {
            font-size: 9px;
            color: rgba(148, 163, 184, 0.5);
            margin-top: 4px;
        }
        
        .perf-stat-box.full-span {
            grid-column: span 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
        }
        
        .perf-stat-box.full-span .stat-left,
        .perf-stat-box.full-span .stat-right {
            text-align: center;
        }
        
        .perf-stat-box.full-span .divider {
            width: 1px;
            height: 35px;
            background: rgba(255, 255, 255, 0.08);
        }
        
        /* === CHART CARD PREMIUM === */
        .dash-card.perf-chart-card {
            background: linear-gradient(165deg, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.85) 100%);
            border: 1px solid rgba(34, 211, 238, 0.1);
        }
        
        .dash-card.perf-chart-card::before {
            background: linear-gradient(90deg, transparent, rgba(34, 211, 238, 0.3), transparent);
        }
        
        .perf-chart-card .metric-title {
            color: rgba(34, 211, 238, 0.8);
        }
        
        .perf-chart-info {
            font-size: 10px;
            color: rgba(148, 163, 184, 0.5);
            text-align: center;
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .perf-chart-info i {
            font-size: 11px;
            opacity: 0.6;
        }
        
        /* === ALLOCATION CARD === */
        .dash-card.perf-allocation-card {
            background: linear-gradient(165deg, rgba(30, 41, 59, 0.5) 0%, rgba(20, 30, 45, 0.85) 100%);
            border: 1px solid rgba(139, 92, 246, 0.1);
        }
        
        .dash-card.perf-allocation-card::before {
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.3), transparent);
        }
        
        .perf-allocation-card .metric-title {
            color: rgba(167, 139, 250, 0.8);
        }
        
        /* === TOP PERFORMERS CARD === */
        .dash-card.perf-top-card {
            background: linear-gradient(165deg, rgba(30, 41, 59, 0.5) 0%, rgba(15, 30, 35, 0.85) 100%);
            border: 1px solid rgba(16, 185, 129, 0.1);
        }
        
        .dash-card.perf-top-card::before {
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.3), transparent);
        }
        
        .perf-top-card .metric-title {
            color: rgba(52, 211, 153, 0.8);
        }
        
        /* === SMALL STAT CARDS === */
        .dash-card.perf-mini-card {
            padding: 18px;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .perf-mini-card.win-rate-card {
            border-color: rgba(34, 211, 238, 0.15);
        }
        
        .perf-mini-card.win-rate-card::before {
            background: linear-gradient(90deg, transparent, rgba(34, 211, 238, 0.4), transparent);
        }
        
        .perf-mini-card.cash-ratio-card {
            border-color: rgba(251, 191, 36, 0.15);
        }
        
        .perf-mini-card.cash-ratio-card::before {
            background: linear-gradient(90deg, transparent, rgba(251, 191, 36, 0.4), transparent);
        }
        
        /* Premium Progress Bar */
        .perf-progress-wrapper {
            margin-top: 8px;
        }
        
        .perf-progress-bg {
            height: 6px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .perf-progress-fill {
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .perf-progress-label {
            font-size: 10px;
            color: rgba(148, 163, 184, 0.6);
            margin-top: 6px;
        }
        
        /* Goal Progress Premium */
        .goal-wrapper {
            height: 6px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .goal-fill {
            height: 100%;
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* --- PRO MUHASEBE STİLLERİ --- */
        .accounting-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .acc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .acc-item { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 10px; }
        .acc-lbl { font-size: 10px; color: var(--text-sub); text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 4px; }
        .acc-val { font-size: 16px; font-weight: 800; color: white; letter-spacing: 0.5px; font-family: 'Inter', monospace; }
        .acc-net { grid-column: span 2; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); }
        .month-separator { font-size: 11px; font-weight: 800; color: var(--text-sub); margin: 20px 0 10px 5px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        .month-separator::after { content:''; flex:1; height:1px; background: rgba(255,255,255,0.1); }
        .ledger-card { background: var(--bg-card); border-radius: 12px; padding: 14px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.03); display: flex; align-items: center; justify-content: space-between; transition: transform 0.2s; position: relative; overflow: hidden; }
        .ledger-card:active { transform: scale(0.98); background: var(--bg-input); }
        .ledger-card::before { content:''; position: absolute; left:0; top:0; bottom:0; width: 4px; }
        .l-type-in { border-left-color: var(--success); } .l-type-in::before { background: var(--success); }
        .l-type-out { border-left-color: var(--danger); } .l-type-out::before { background: var(--danger); }
        .l-type-neutral { border-left-color: var(--text-sub); } .l-type-neutral::before { background: var(--text-sub); }
        .lc-left { display: flex; align-items: center; gap: 12px; }
        .lc-icon { width: 36px; height: 36px; border-radius: 10px; background: var(--bg-input); display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--text-sub); }
        .lc-info { display: flex; flex-direction: column; }
        .lc-title { font-weight: 700; font-size: 13px; color: white; }
        .lc-date { font-size: 10px; color: var(--text-sub); margin-top: 2px; }
        .lc-right { text-align: right; }
        .lc-amount { font-family: 'Inter', monospace; font-weight: 700; font-size: 14px; display: block; }
        .lc-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text-sub); font-weight: 600; margin-top: 4px; display: inline-block; }
        .cash-modal-btn { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: var(--bg-input); color: white; font-weight: 700; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.2s; }
        .cash-modal-btn.deposit:hover, .cash-modal-btn.deposit.active { background: rgba(16, 185, 129, 0.15); border-color: var(--success); color: var(--success); }
        .cash-modal-btn.withdraw:hover, .cash-modal-btn.withdraw.active { background: rgba(239, 68, 68, 0.15); border-color: var(--danger); color: var(--danger); }
      /* --- YENİ PİYASA LİSTE STİLLERİ (PREMIUM TASARIM) --- */
.market-filter-group { 
    display: flex; gap: 8px; padding: 0 5px 10px 5px; 
    overflow-x: auto; scrollbar-width: none; 
}
.mf-chip { 
    background: rgba(255,255,255,0.03); 
    border: 1px solid rgba(255,255,255,0.08); 
    color: var(--text-sub); 
    padding: 8px 16px; 
    border-radius: 12px; 
    font-size: 11px; font-weight: 700; 
    cursor: pointer; white-space: nowrap; 
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.mf-chip.active { 
    background: rgba(59, 130, 246, 0.15); 
    color: var(--accent); 
    border-color: var(--accent); 
    box-shadow: 0 0 15px rgba(59, 130, 246, 0.25);
}

.infinite-list-container { 
    height: calc(100vh - 200px); /* Alt navigasyon payı */
    overflow-y: auto; 
    padding: 5px; 
    padding-bottom: 80px; 
}

/* --- TEMA UYUMLU LİSTE KARTLARI --- */
.infinite-item { 
    display: flex; justify-content: space-between; align-items: center; 
    
    /* ESKİ SABİT RENKLER YERİNE TEMA RENGİ */
    background: var(--bg-card) !important;
    border: 1px solid var(--border-color) !important;
    
    padding: 12px 14px; 
    border-radius: 16px; 
    margin-bottom: 8px; 
    cursor: pointer; 
    
    /* Animasyonlar */
    transition: transform 0.2s, background 0.4s ease, border-color 0.4s ease;
    position: relative;
    overflow: hidden;
}

.infinite-item:active { 
    transform: scale(0.98); 
    background: var(--bg-input) !important; 
}

/* Sol Taraf */
.ii-left { display: flex; align-items: center; gap: 12px; }

/* Sıralama Rozeti (Tema Uyumlu) */
.ii-rank { 
    font-size: 10px; color: var(--text-sub); 
    width: 22px; height: 22px; 
    display: flex; align-items: center; justify-content: center;
    border-radius: 6px; 
    font-weight: 800; 
    
    /* Tema Renkleri */
    background: var(--bg-input) !important;
    border: 1px solid var(--border-color) !important;
}

/* İlk 3 Sıra İçin Özel Renkler (Bunlar kalabilir, vurgu iyidir) */
.rank-gold { background: rgba(245, 158, 11, 0.15) !important; color: #fbbf24 !important; border-color: rgba(245, 158, 11, 0.3) !important; }
.rank-silver { background: rgba(148, 163, 184, 0.15) !important; color: #e2e8f0 !important; border-color: rgba(148, 163, 184, 0.3) !important; }
.rank-bronze { background: rgba(180, 83, 9, 0.15) !important; color: #fdba74 !important; border-color: rgba(180, 83, 9, 0.3) !important; }

.ii-info { display: flex; flex-direction: column; gap: 2px; }
.ii-sym { font-size: 14px; font-weight: 800; color: var(--text-main); letter-spacing: 0.3px; }
.ii-vol { font-size: 10px; color: var(--text-sub); opacity: 0.7; font-weight: 500; }

/* Sağ Taraf */
.ii-right { text-align: right; display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
.ii-price { font-size: 15px; font-weight: 700; color: var(--text-main); letter-spacing: -0.5px; }

/* Yüzde Rozeti */
.ii-change { 
    font-size: 11px; font-weight: 800; 
    padding: 4px 10px; 
    border-radius: 8px; 
    min-width: 65px; 
    text-align: center;
    display: flex; align-items: center; justify-content: center; gap: 4px;
}
.bg-up { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
.bg-down { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }

.loader-spinner { text-align: center; padding: 20px; color: var(--text-sub); font-size: 11px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; display: none; }
.loader-spinner.active { display: block; animation: pulse 1s infinite; }

/* --- TEMA UYUMLU MARKET DETAY MODAL --- */
.market-sheet {
    width: 100%;
    max-width: 100%;
    border-radius: 20px 20px 0 0;
    padding: 20px;
    
    /* Tema Entegrasyonu */
    background: var(--bg-card) !important;
    border-top: 1px solid var(--border-color) !important;
    
    animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    margin: 0;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.sheet-title { font-size: 18px; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px; }

.sheet-close-btn { 
    background: var(--bg-input) !important; 
    border: 1px solid var(--border-color) !important;
    color: var(--text-sub); 
    width: 32px; height: 32px; border-radius: 50%; 
    cursor: pointer; display:flex; align-items:center; justify-content:center;
}

.chart-box-lg {
    width: 100%;
    height: 300px;
    background: #131722; /* TradingView arka planı sabit kalmalı */
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 15px;
    border: 1px solid var(--border-color) !important;
}

.sheet-actions { display: flex; gap: 10px; }
.sheet-actions .btn-main { padding: 16px; font-size: 14px; }

/* --- GELİŞMİŞ DETAY MODAL STİLLERİ --- */
.md-header-hero {
    text-align: center; padding: 20px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px;
    transition: background 0.3s; border-radius: 20px 20px 0 0;
}
.md-header-hero.up { background: linear-gradient(180deg, rgba(16, 185, 129, 0.15) 0%, transparent 100%); }
.md-header-hero.down { background: linear-gradient(180deg, rgba(239, 68, 68, 0.15) 0%, transparent 100%); }

.md-big-price { font-size: 32px; font-weight: 900; color: white; letter-spacing: -1px; margin: 5px 0; }
.md-change-pill { font-size: 14px; font-weight: 700; padding: 4px 12px; border-radius: 12px; display: inline-block; }

/* Sekmeler */
.md-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.md-tab { padding: 10px 15px; font-size: 13px; font-weight: 700; color: var(--text-sub); cursor: pointer; border-bottom: 2px solid transparent; transition: 0.2s; }
.md-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* İçerik Alanları */
.md-content { display: none; animation: fadeIn 0.3s; }
.md-content.active { display: block; }

/* İstatistik Grid */
.md-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.md-stat-box { background: var(--bg-input); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
.md-stat-lbl { font-size: 10px; color: var(--text-sub); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
.md-stat-val { font-size: 14px; font-weight: 800; color: white; }

/* Range Bar (Günlük Aralık) */
.range-container { margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 12px; }
.range-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-sub); margin-bottom: 5px; font-weight: 700; }
.range-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; position: relative; overflow: hidden; }
.range-fill { height: 100%; background: linear-gradient(90deg, var(--danger), var(--gold), var(--success)); width: 100%; opacity: 0.5; }
.range-dot { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 12px; height: 12px; background: white; border: 2px solid var(--bg-card); border-radius: 50%; box-shadow: 0 0 10px rgba(255,255,255,0.5); transition: left 1s cubic-bezier(0.2, 0.8, 0.2, 1); }

/* Hızlı Aksiyonlar */
.md-action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.btn-quick { padding: 12px; border-radius: 12px; font-weight: 800; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; transition: 0.2s; }
.btn-quick:active { transform: scale(0.96); }
.bq-buy { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
.bq-sell { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
.bq-sub { font-size: 9px; opacity: 0.8; font-weight: 600; }

/* --- ORTALI MODAL DÜZELTMESİ --- */

/* Dış Kaplayıcıyı Ortala */
#marketDetailModal {
    align-items: center !important; /* En alttan ortaya çeker */
    justify-content: center !important;
    padding: 20px; /* Kenarlardan biraz boşluk kalsın */
}

/* Modal Kutusunun Şeklini Değiştir */
.market-sheet {
    width: 95% !important;        /* Mobilde ekranı tam kaplamasın, kenar kalsın */
    max-width: 400px !important;  /* Tablet/PC'de çok genişlemesin */
    border-radius: 24px !important; /* Sadece üstler değil, her köşe yuvarlak olsun */
    max-height: 85vh;             /* Ekranın %85'inden büyük olmasın */
    margin: 0 auto !important;    /* Ortala */
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); /* Derinlik gölgesi ekle */
    
    /* Animasyonu değiştirelim (Alttan kayma yerine, ortada büyüme) */
    animation: modalZoomIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
}

/* Yeni Animasyon: Hafif Büyüyerek Açılma */
@keyframes modalZoomIn {
    0% { opacity: 0; transform: scale(0.9) translateY(20px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
}

/* --- GÜNCELLENMİŞ TEMA UYUMLU MARKET HEADER (KONTRAST DÜZELTMELİ) --- */
.market-unified-header {
    /* KONUMLANDIRMA */
    position: sticky;
    top: 0;
    z-index: 100;
    
    /* BOYUTLANDIRMA & GÖRÜNÜM */
    width: 100%;
    margin: 0;
    margin-bottom: 0;
    
    /* YENİ SIKI BOŞLUKLAR */
    padding: 8px 12px; 
    gap: 6px; 
    
    /* ŞEKİL */
    border-radius: 0;
    border: none;
    
    /* --- TEMA RENGİ BURADA DEĞİŞİYOR --- */
    background: var(--nav-bg) !important; 
    border-bottom: 1px solid var(--border-color) !important;

    backdrop-filter: blur(15px);        
    -webkit-backdrop-filter: blur(15px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);

    /* İÇ DÜZEN */
    display: flex;
    flex-direction: column;
    
    /* Renk Geçiş Animasyonu */
    transition: background 0.4s ease, border-color 0.4s ease;
}

/* 1. SATIR: Başlık ve Kontroller */
.muh-top-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2px !important;
}

/* Sol Taraf: Toggle Switch (Tema Uyumlu) */
.view-toggle-group {
    background: var(--bg-input) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: 20px;
    padding: 2px;
    display: flex;
}
.vt-btn {
    padding: 5px 12px;
    font-size: 11px;
    font-weight: 700;
    color: var(--text-sub);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.vt-btn.active {
    background: var(--accent);
    
    /* DÜZELTME: OLED temasında siyah, diğerlerinde beyaz olması için */
    color: var(--text-on-accent) !important; 
    
    box-shadow: 0 2px 10px var(--accent-glow);
}

/* Sağ Taraf: Arama İkonu (Tema Uyumlu) */
.muh-search-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    
    /* Tema Renkleri */
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    color: var(--text-main);
    
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 13px;
    transition: 0.2s;
}
.muh-search-btn.active {
    background: var(--accent);
    
    /* DÜZELTME: Akıllı metin rengi */
    color: var(--text-on-accent) !important;
    
    border-color: var(--accent);
}

/* 2. SATIR: Gizli Arama Inputu */
.muh-search-container {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.muh-search-container.open {
    max-height: 50px;
    margin-bottom: 5px;
}
.muh-input-wrap {
    position: relative;
    width: 100%;
}
.muh-input {
    width: 100%;
    /* Tema Renkleri */
    background: var(--bg-input);
    border: 1px solid var(--border-color);
    color: var(--text-main);
    
    border-radius: 10px;
    padding: 8px 10px 8px 35px;
    font-size: 12px;
    outline: none;
}
.muh-input:focus {
    border-color: var(--accent);
}
.muh-search-icon-pos {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-sub);
    font-size: 12px;
}


/* 3. SATIR: Kategoriler (Tabs) */
/* --- GÜNCELLENMİŞ KOMPAKT TABLAR --- */

.muh-tabs-scroll {
    display: flex;
    gap: 6px; /* Butonlar arası boşluğu azalttık (10px -> 6px) */
    overflow-x: auto;
    scrollbar-width: none;
    border-bottom: none;
    padding-bottom: 0px;
    width: 100%; /* Genişliği tam kapla */
}

.muh-tab {
    flex: 1; /* SİHİRLİ KOD: Hepsi eşit genişlikte olsun ve ekrana yayılsın */
    display: flex;
    align-items: center;
    justify-content: center; /* İçeriği ortala */
    
    background: var(--bg-input); 
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 10px; /* Biraz daha az yuvarlak */
    
    /* Küçültülmüş Değerler: */
    padding: 8px 4px; /* Üst-Alt: 8px, Sağ-Sol: 4px (Kenarlardan kıstık) */
    gap: 5px; /* İkon ve yazı arasını yaklaştırdık */
    
    font-size: 11px; /* Yazı boyutu küçüldü (12px -> 11px) */
    font-weight: 700;
    color: var(--text-sub);
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

/* İkon Boyutu ve Renklendirme */
.muh-tab i {
    font-size: 16px; 
    opacity: 0.6; 
    transition: all 0.2s ease;
}

.muh-tab.active i {
    opacity: 1;
    transform: scale(1.15);
}

/* Kategoriye Özel Renkler */
.muh-tab:nth-child(1).active i { color: #f59e0b; } /* Kripto - Turuncu */
.muh-tab:nth-child(2).active i { color: #3b82f6; } /* BIST - Mavi */
.muh-tab:nth-child(3).active i { color: #eab308; } /* Emtia - Sarı */
.muh-tab:nth-child(4).active i { color: #10b981; } /* Döviz - Yeşil */

/* Aktif Durum */
.muh-tab.active {
    background: var(--bg-card);
    border-color: var(--accent);
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

/* Aktif olunca alt çizgi yok */
.muh-tab.active::after { display: none; }


/* 4. SATIR: Filtre Çipleri (Chips) */
.muh-filters {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scrollbar-width: none;
    padding-bottom: 15px; /* Alt boşluk */
}
.muh-chip {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.05);
    color: var(--text-sub);
    padding: 6px 12px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    white-space: nowrap;
    cursor: pointer;
    transition: 0.2s;
}
.muh-chip.active {
    background: rgba(59, 130, 246, 0.15);
    color: var(--accent);
    border-color: var(--accent);
}

/* --- TOGGLE SWITCH (ANAHTAR) STİLLERİ --- */
.switch-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.switch-row:last-child { border-bottom: none; }
.switch-label { font-size: 13px; color: white; font-weight: 600; }
.switch-desc { font-size: 10px; color: var(--text-sub); display: block; margin-top: 2px; }

.tgl-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.tgl-switch input { opacity: 0; width: 0; height: 0; }
.tgl-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-input); transition: .4s; border-radius: 34px; border: 1px solid rgba(255,255,255,0.1); }
.tgl-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .tgl-slider { background-color: var(--success); border-color: var(--success); }
input:checked + .tgl-slider:before { transform: translateX(20px); }
/* --- TRADER KARNESİ TEMA DÜZELTMESİ --- */

/* 1. Ana Kartın Rengini Temaya Bağla */
.dash-card[style*="linear-gradient"], 
.dash-card.full-width[style*="linear-gradient"] {
    background: var(--bg-card) !important;
    border: 1px solid var(--border-color) !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1) !important;
}

/* 2. İçindeki Puan Kutucuklarını (Kâr Faktörü, Beklenti) Temaya Bağla */
/* (Arka planı elle yazılmış div'leri yakalar ve tema rengi yapar) */
.dash-card div[style*="background:rgba(255,255,255,0.03)"] {
    background: var(--bg-input) !important;
    border: 1px solid var(--border-color) !important;
    color: var(--text-main) !important;
}

/* 3. İçindeki Ayraç Çizgisi */
.dash-card div[style*="background:rgba(255,255,255,0.1)"] {
    background: var(--border-color) !important;
}

/* 4. Alt Bilgi Metni (İtalik olan) */
.dash-card div[style*="color:var(--text-sub)"] {
    color: var(--text-sub) !important;
    opacity: 0.7;
}

/* --- APP SETTINGS (DÜZELTİLMİŞ & SABİTLENMİŞ) --- */
.app-settings-container { 
    /* Üstten 80px boşluk bırakarak menünün altında kalmasını engelliyoruz */
    padding: 20px 20px 100px 20px !important; 
    
    /* İçeriğin taşmasını engellemek için */
    width: 100%;
    box-sizing: border-box;
    overflow-y: auto;
    height: 100vh;
}


/* 1. PROFİL KARTI (Aynen Koruyoruz) */
.profile-banner-card {
    background: var(--bg-card);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 20px;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    position: relative;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.profile-banner-card.premium-glow {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(180, 83, 9, 0.05) 100%);
    border: 1px solid rgba(245, 158, 11, 0.4);
    box-shadow: 0 10px 30px rgba(245, 158, 11, 0.15);
}
.pbc-img {
    width: 60px; height: 60px; border-radius: 50%; object-fit: cover;
    border: 2px solid var(--accent); flex-shrink: 0; /* Küçülmeyi önle */
}
.profile-banner-card.premium-glow .pbc-img { border-color: var(--gold); }
.pbc-info { display: flex; flex-direction: column; }
.pbc-name { font-size: 18px; font-weight: 800; color: white; margin-bottom: 4px; }
.pbc-badge { font-size: 10px; font-weight: 700; background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 8px; width: fit-content; }
.profile-banner-card.premium-glow .pbc-badge { background: #334155; color: #94a3b8; }


/* 2. TAB MENÜSÜ (SEGMENTED) */
.settings-tabs.segmented {
    display: flex; gap: 5px;
    background: rgba(255,255,255,0.03);
    padding: 4px; border-radius: 12px; margin-bottom: 20px;
}
.s-tab.seg-style {
    flex: 1; text-align: center; padding: 10px; font-size: 12px; font-weight: 600;
    color: var(--text-sub); border-radius: 8px; cursor: pointer; transition: 0.2s;
}
.s-tab.seg-style.active {
    background: var(--bg-card); color: white; font-weight: 700;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}


/* Segmented Control (iOS tarzı sekmeler) */
.settings-tabs.segmented {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 4px;
    display: flex;
    gap: 5px;
}
.s-tab.seg-style {
    flex: 1;
    text-align: center;
    padding: 8px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-sub);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}
.s-tab.seg-style.active {
    background: var(--bg-card);
    color: white;
    font-weight: 800;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.05);
}



/* 3. MENÜ LİSTESİ (SORUNLU KISIM DÜZELTİLDİ) */
.menu-list-wrapper {
    background: var(--bg-card);
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.05);
    margin-bottom: 20px;
}

/* Satır Yapısı - Flexbox Zorlaması */
.menu-list-item {
    display: flex !important; /* Kesinlikle yan yana */
    align-items: center !important;
    justify-content: space-between !important;
    width: 100% !important;
    padding: 16px !important;
    background: transparent !important; /* Arka plan karışmasın */
    border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
    box-sizing: border-box;
}
.menu-list-item:active { background: rgba(255,255,255,0.03) !important; }
.menu-list-item:last-child { border-bottom: none; }

/* Sol Taraf (İkon + Yazı) */
.mli-left {
    display: flex !important;
    align-items: center !important;
    gap: 15px !important;
}

/* İkon Kutusu - Boyut Sabitleme */
.mli-icon-box {
    width: 36px !important;
    height: 36px !important;
    min-width: 36px !important; /* Asla küçülme */
    min-height: 36px !important;
    border-radius: 10px;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 16px;
    color: white;
    flex-shrink: 0 !important; /* Sıkışmayı önle */
}

/* İkon Renkleri (Gradientli) */
.bg-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.bg-orange { background: linear-gradient(135deg, #f59e0b, #d97706); }
.bg-green { background: linear-gradient(135deg, #10b981, #059669); }
.bg-red { background: linear-gradient(135deg, #ef4444, #dc2626); }

.mli-text {
    font-size: 15px !important;
    font-weight: 600 !important;
    color: white !important;
    white-space: nowrap;
}

.mli-arrow { font-size: 12px; color: var(--text-sub); opacity: 0.5; }

/* Detay Sayfaları */
.settings-detail-wrapper { display: none; padding-top: 10px; }
.sub-header { 
    display: flex; 
    align-items: center; 
    margin-bottom: 20px; 
    padding-bottom: 15px; 
    border-bottom: 1px solid rgba(255,255,255,0.1);
    
    /* Geri tuşunun tıklanabilir olduğundan emin olmak için */
    position: relative; 
    z-index: 10; 
    background: var(--bg-body); /* Arka plan karışmasın */
}

.back-btn { background:none; border:none; color:var(--accent); font-size:16px; font-weight:600; display:flex; align-items:center; gap:5px; cursor:pointer;}
.sub-title { flex:1; text-align:center; font-weight:700; font-size:16px; transform:translateX(-30px); color:white; }



/* --- SPLASH SCREEN YASAL LİNKLER --- */
.splash-legal-footer {
    position: absolute;
    bottom: 30px;        /* Ekranın en altından 30px yukarıda */
    width: 100%;
    text-align: center;
    z-index: 2;
    opacity: 0;          /* Başlangıçta gizli */
    animation: fadeUpText 0.5s ease-out forwards 1s; /* Logo geldikten sonra belirsin */
}

.splash-legal-footer a {
    color: rgba(255, 255, 255, 0.5); /* Hafif silik beyaz */
    text-decoration: none;
    font-size: 11px;
    font-weight: 600;
    transition: color 0.3s;
    font-family: 'Inter', sans-serif;
}

.splash-legal-footer a:hover {
    color: #ffffff;      /* Üzerine gelince parlasın */
    text-decoration: underline;
}

.splash-legal-footer .sep {
    color: rgba(255, 255, 255, 0.2);
    margin: 0 8px;
    font-size: 10px;
}

/* --- YENİ LAB LİSTE TASARIMI --- */
.lab-list-container {
    max-height: 350px;
    overflow-y: auto;
    padding-right: 5px; /* Scrollbar için boşluk */
}

.lab-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 12px 15px;
    margin-bottom: 8px;
    transition: transform 0.2s;
}

.lab-row:hover {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.1);
}

.lab-col-left {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.lab-month-badge {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-sub);
    text-transform: uppercase;
    letter-spacing: 1px;
    background: rgba(255,255,255,0.05);
    padding: 3px 8px;
    border-radius: 6px;
    width: fit-content;
}

.lab-balance-val {
    font-size: 15px;
    font-weight: 800;
    color: white;
    letter-spacing: 0.5px;
}

.lab-col-right {
    text-align: right;
}

.lab-profit-lbl {
    font-size: 9px;
    color: var(--text-sub);
    display: block;
    margin-bottom: 2px;
}

.lab-profit-val {
    font-size: 13px;
    font-weight: 800;
    color: var(--success);
    text-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
}

/* --- MUHASEBE & DENETİM TASARIMI --- */
.accounting-hero {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.05);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.acc-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.acc-row:last-child { margin-bottom: 0; padding-bottom: 0; border: none; }

.acc-stat-box { flex: 1; }
.acc-stat-box.right { text-align: right; }

.acc-val-lg { font-size: 24px; font-weight: 800; color: white; letter-spacing: -0.5px; }
.acc-val-sm { font-size: 16px; font-weight: 700; color: white; }
.acc-lbl-sub { font-size: 10px; color: var(--text-sub); text-transform: uppercase; font-weight: 700; }

.trash-btn {
    width: 100%;
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    border: 1px dashed rgba(239, 68, 68, 0.3);
    padding: 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 15px;
    transition: 0.2s;
}
.trash-btn:hover { background: rgba(239, 68, 68, 0.2); }

/* Silinen Öğe Kartı */
.deleted-item {
    background: rgba(0,0,0,0.3);
    border-left: 3px solid var(--text-sub);
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    opacity: 0.7;
}
.del-restore-btn {
    background: var(--success);
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 700;
    cursor: pointer;
}
/* --- YENİ HEDEF BARI VE LİSTE STİLLERİ (FİNAL) --- */

/* 1. İnce Barın Dış Çerçevesi */
.goal-strip-container {
    height: 24px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    position: relative;
    overflow: hidden;
    margin-top: 5px;
    border: 1px solid rgba(255,255,255,0.1);
}

/* 2. Barın İçindeki Renkli Dolgu */
.goal-strip-fill {
    height: 100%;
    width: 0%; /* JS ile artacak */
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    font-size: 11px;
    font-weight: 800;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    transition: width 1s ease, background 1s ease;
    white-space: nowrap;
}

/* 3. Renk Aşamaları (Kırmızı -> Sarı -> Yeşil) */
.gs-red { background: linear-gradient(90deg, #7f1d1d, #ef4444); } 
.gs-yellow { background: linear-gradient(90deg, #b45309, #f59e0b); } 
.gs-green { background: linear-gradient(90deg, #065f46, #10b981); }

/* 4. Günlük Kayıt Listesi Kutusu */
.daily-log-container {
    max-height: 200px;
    overflow-y: auto;
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
    padding: 5px;
    border: 1px solid rgba(255,255,255,0.05);
}

/* 5. Listedeki Satırlar */
.daily-log-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    font-size: 11px;
    transition: background 0.2s;
}
.daily-log-row:last-child { border-bottom: none; }
.log-date { color: var(--text-sub); font-weight: 600; }
/* Hedef Barı Yazı Katmanı */
.goal-text-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: space-between; /* Yazıları iki uca yasla */
    align-items: center;
    padding: 0 10px;
    font-size: 10px;
    font-weight: 800;
    z-index: 5; /* Barın üstünde dursun */
    pointer-events: none; /* Tıklamayı engellemesin */
}

/* PSİKOLOJİ SEKMESİ STİLLERİ */
.regret-item {
    background: rgba(255,255,255,0.03);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 8px;
    border: 1px solid rgba(255,255,255,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.regret-item.missed { border-left: 3px solid var(--danger); } /* Kaçan Fırsat (Kırmızı) */
.regret-item.saved { border-left: 3px solid var(--success); }  /* İyi ki satmışsın (Yeşil) */

.ri-left { display: flex; flex-direction: column; }
.ri-sym { font-weight: 800; font-size: 13px; color: white; }
.ri-date { font-size: 10px; color: var(--text-sub); }

.ri-right { text-align: right; }
.ri-val { font-weight: 800; font-size: 13px; }
.ri-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 700; display: inline-block; margin-top: 2px; }

.missed .ri-val { color: var(--danger); }
.missed .ri-badge { background: rgba(239, 68, 68, 0.15); color: var(--danger); }

.saved .ri-val { color: var(--success); }
.saved .ri-badge { background: rgba(16, 185, 129, 0.15); color: var(--success); }
/* ==========================================================================
   PSİKOLOJİ MERKEZİ (TAMİR EDİLMİŞ FİNAL TASARIM)
   Bu kod bloğu, kartların dışarı taşmasını engeller.
   ========================================================================== */

.psycho-hub-container {
    background: linear-gradient(145deg, #1e293b, #0f172a);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 0;
    margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    position: relative;
    overflow: hidden; /* Taşmayı kesin olarak engeller */
    display: flex;
    flex-direction: column;
}

/* Başlık */
.psycho-header {
    background: rgba(0, 0, 0, 0.3);
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.psycho-title {
    font-size: 15px;
    font-weight: 700;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Tab Menü */
.psycho-tabs {
    display: flex;
    background: rgba(0, 0, 0, 0.2);
    padding: 4px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.p-tab-btn {
    flex: 1;
    background: transparent;
    border: none;
    padding: 10px;
    color: #94a3b8;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 2px solid transparent;
}

.p-tab-btn.active {
    color: #38bdf8;
    border-bottom: 2px solid #38bdf8;
    background: linear-gradient(to top, rgba(56, 189, 248, 0.1), transparent);
}

/* İçerik Alanı */
.psycho-content-area {
    padding: 15px;
    width: 100%;
    box-sizing: border-box; /* Padding dahil genişlik hesapla */
}

.psycho-view {
    display: none;
    width: 100%;
    animation: fadeIn 0.4s ease;
}
.psycho-view.active { display: block; }

/* --- KART TASARIMI (TAŞMA SORUNUNU ÇÖZEN KISIM) --- */
.stat-card-modern {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 12px;
    padding: 15px; /* İç boşluk */
    margin-bottom: 10px;
    
    /* Esnek Yapı */
    display: flex;
    justify-content: space-between;
    align-items: center;
    
    border-left: 3px solid #64748b;
    
    /* Genişlik Ayarları */
    width: 100%; 
    box-sizing: border-box; /* Çok önemli: padding taşma yapmaz */
    position: relative;
    overflow: hidden; /* İçerik taşarsa gizle */
}

/* Kart Renkleri */
.stat-card-modern.success { border-left-color: #10b981; }
.stat-card-modern.danger { border-left-color: #ef4444; }
.stat-card-modern.warning { border-left-color: #f59e0b; }

/* Kart İçi Yazılar */
.sc-label { font-size: 10px; color: #94a3b8; text-transform: uppercase; font-weight: 700; }
.sc-value { font-size: 14px; font-weight: 800; color: #f1f5f9; margin-top: 2px; }
.sc-sub { font-size: 10px; color: #64748b; opacity: 0.8; }

/* --- YENİ İŞLEM MODU SEÇİCİSİ --- */
.trade-mode-switch {
    display: flex;
    background: var(--bg-input);
    padding: 4px;
    border-radius: 12px;
    margin-bottom: 10px;
    border: 1px solid rgba(255,255,255,0.05);
}
.tm-switch-btn {
    flex: 1;
    border: none;
    background: transparent;
    color: var(--text-sub);
    padding: 8px;
    font-size: 11px;
    font-weight: 800;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}
.tm-switch-btn.active {
    color: white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}
/* Kripto Aktifse Turuncu */
.tm-switch-btn.active.mode-crypto {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}
/* Borsa Aktifse Mavi */
.tm-switch-btn.active.mode-borsa {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}
/* --- YENİ EKLENEN STİLLER (Slider & Strateji) --- */
.modern-range {
    -webkit-appearance: none; width: 100%; height: 6px;
    background: rgba(255,255,255,0.1); border-radius: 5px; outline: none; margin: 10px 0;
}
.modern-range::-webkit-slider-thumb {
    -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
    background: #3b82f6; border-radius: 50%; cursor: pointer;
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); border: 2px solid #1e40af;
}

.strategy-step-card {
    background: rgba(255,255,255,0.03); border-left: 3px solid rgba(255,255,255,0.2);
    padding: 10px; border-radius: 0 8px 8px 0; margin-bottom: 8px; font-size: 11px;
    display: flex; justify-content: space-between; align-items: center; transition: 0.2s;
}
.step-badge {
    background: rgba(59, 130, 246, 0.2); color: #60a5fa; font-weight: 700;
    padding: 3px 8px; border-radius: 6px; font-size: 10px; margin-right: 10px;
}

/* --- YENİ IMMERSIVE HABER TASARIMI (CSS) --- */

/* 1. Büyük Manşet Alanı (Sabit) */
.hero-section {
    position: fixed; top: 0; left: 0; width: 100%;
    height: 300px; /* Yükseklik */
    z-index: 90;
    background: #1e293b;
    box-shadow: 0 10px 50px rgba(0,0,0,0.6);
    transition: all 0.3s ease;
}

.hero-bg {
    width: 100%; height: 100%;
    object-fit: cover;
    opacity: 0.5; /* Yazı okunabilirliği için koyuluk */
    transition: opacity 0.3s ease;
}

.hero-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: linear-gradient(to bottom, rgba(11,15,25,0.2) 0%, rgba(11,15,25,0.9) 85%, #0b0f19 100%);
}

.hero-content {
    position: absolute; bottom: 65px; left: 20px; right: 20px;
    z-index: 95;
}

.category-badge {
    display: inline-block; padding: 4px 10px; border-radius: 4px;
    font-size: 10px; font-weight: 800; color: #fff;
    background: #3b82f6; margin-bottom: 8px; text-transform: uppercase;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.hero-headline {
    font-size: 20px; font-weight: 800; line-height: 1.3; color: #fff;
    text-shadow: 0 4px 15px rgba(0,0,0,0.8);
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
}

/* 2. Kategori Butonları (Sabit Şerit) */
.sticky-controls {
    position: fixed; top: 300px; /* Hero yüksekliği kadar aşağıda */
    left: 0; width: 100%;
    z-index: 95;
    background: #0b0f19; /* Sayfa rengiyle bütünleşsin */
    margin-top: -1px; /* Çizgi oluşmasını engelle */
}

.tabs-container {
    display: flex; gap: 10px;
    overflow-x: auto;
    padding: 0 20px 15px 20px;
    scrollbar-width: none;
}
.tabs-container::-webkit-scrollbar { display: none; }

.tab-btn {
    padding: 8px 20px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 50px;
    font-size: 12px; font-weight: 600;
    color: #94a3b8; white-space: nowrap; cursor: pointer;
    transition: all 0.2s;
}

.tab-btn.active {
    background: #fff; color: #000; border-color: #fff;
    box-shadow: 0 0 15px rgba(255,255,255,0.15); transform: scale(1.05);
}

/* 3. Haber Listesi (Kaydırılabilir Alan) */
.news-scroll-area {
    padding: 360px 20px 120px 20px; /* Üstten Hero+Buton kadar boşluk */
    width: 100%;
    min-height: 100vh;
}

.news-card {
    display: flex; gap: 15px; padding: 18px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer; animation: fadeIn 0.5s ease;
}
.news-card:last-child { border-bottom: none; }
@keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

.news-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }

.news-meta { display: flex; align-items: center; gap: 6px; margin-bottom: 5px; }
.news-source { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; }
.news-time { font-size: 10px; color: #475569; }

.news-title {
    font-size: 14px; line-height: 1.4; color: #e2e8f0; font-weight: 500;
    display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
}

.news-thumb {
    width: 85px; height: 85px; border-radius: 12px;
    background: #1e293b; object-fit: cover; flex-shrink: 0;
    border: 1px solid rgba(255,255,255,0.05);
}

/* --- PROFİL ÇERÇEVE SİSTEMİ --- */

/* FREE KULLANICI (Standart Çerçeve) */
.profile-frame-free {
    border: 3px solid #475569; /* Koyu Gri/Mavi */
    filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
}

/* PRO KULLANICI (Altın Çerçeve & Efekt) */
.profile-frame-pro {
    border: 3px solid #f59e0b; /* Altın Sarısı */
    box-shadow: 0 0 15px rgba(245, 158, 11, 0.6); /* Parlama Efekti */
    animation: proGlow 3s infinite alternate;
}

@keyframes proGlow {
    from { box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }
    to { box-shadow: 0 0 20px rgba(245, 158, 11, 0.8); }
}

/* KARNE BLURLAMA (Free üyeler detayları göremez) */
.blur-content {
    filter: blur(5px);
    user-select: none;
    pointer-events: none;
}

/* --- GLOBAL BASMA (TICKLAMA) ANİMASYONU --- */

/* 1. Tüm Butonlar, Menü Öğeleri ve Kartlar için Ortak Efekt */
button:active, 
.btn:active, 
.btn-primary:active, 
.btn-danger:active, 
.btn-secondary:active,
.nav-item:active,       /* Alt menü ikonları */
.floating-btn:active,   /* Sağ alttaki yuvarlak (+) butonu */
.tgl-switch:active,     /* Ayarlardaki switchler */
.action-btn:active,     /* Tablo içindeki sil/düzenle butonları */
.filter-chip:active,    /* Filtre butonları */
.currency-toggle-btn:active, /* USD/TRY butonu */
.quick-action-btn:active /* Hızlı işlem butonları */
{
    transform: scale(0.94) !important; /* %6 Küçülme */
    transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0.9; /* Hafif saydamlık */
}

/* 2. Mobilde Dokunma İzini Kaldır (Daha Native Hissettirir) */
* {
    -webkit-tap-highlight-color: transparent;
}
/* --- ARGE / KONTROL MERKEZİ TASARIMI --- */
.arge-wrapper {
    background: rgba(20, 20, 30, 0.6);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.08);
    padding: 25px;
    margin: 15px 0;
    box-shadow: 0 20px 50px rgba(0,0,0,0.3);
    position: relative;
    overflow: hidden;
}

/* Arka plana hafif kodsal süsleme (Decoration) */
.arge-wrapper::before {
    content: '';
    position: absolute;
    top: -50px; right: -50px;
    width: 150px; height: 150px;
    background: radial-gradient(circle, rgba(66, 133, 244, 0.15) 0%, transparent 70%);
    border-radius: 50%;
    pointer-events: none;
}

.arge-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.arge-title {
    font-size: 1.2rem;
    font-weight: 700;
    background: linear-gradient(90deg, #fff, #aab);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: 0.5px;
}

.arge-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* Yan yana 2 kutu */
    gap: 15px;
}

.arge-card {
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    padding: 20px 15px;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

/* Tıklanınca efekt */
.arge-card:active {
    transform: scale(0.96);
    background: rgba(255, 255, 255, 0.06);
}

.arge-icon-box {
    width: 50px;
    height: 50px; /* Eksik değer eklendi */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    border-radius: 12px;
    margin-bottom: 10px;
} /* Kapanış parantezi eklendi */

/* 1. TÜM KUTULARI SIFIRLA ... */
*, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}


/* === TRADEVIA 3D WHITE ICONS (FİNAL & MAVİ VURGU YOK) === */

:root {
    /* Blok Rengi (Koyu Füme Cam) */
    --dock-bg: rgba(30, 35, 45, 0.85); 
    --dock-border: rgba(255, 255, 255, 0.15);
}

/* 1. 3D SAHNE */
.dock-wrapper {
    position: fixed !important;
    bottom: 25px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 94% !important;
    max-width: 420px !important;
    z-index: 10000 !important;
    padding-bottom: env(safe-area-inset-bottom);
    
    /* Derinlik Hissi */
    perspective: 800px !important;
}

/* 2. 3D CAM BLOK GÖVDE */
.nav-container {
    position: relative !important;
    height: 75px !important;
    width: 100% !important;
    
    /* Zemin */
    background: var(--dock-bg) !important;
    backdrop-filter: blur(25px) !important;
    -webkit-backdrop-filter: blur(25px) !important;
    
    /* 3D Kenarlar */
    border: 1px solid var(--dock-border) !important;
    border-top: 1px solid rgba(255,255,255,0.3) !important; /* Üst Parlama */
    border-bottom: 6px solid rgba(0, 0, 0, 0.5) !important;  /* Alt Kalınlık (3D) */
    border-radius: 28px !important;
    
    /* Gölge */
    box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6) !important;

    /* Duruş Açısı */
    transform: rotateX(12deg) !important;
    transform-style: preserve-3d !important;
    
    display: flex !important;
    justify-content: space-around !important;
    align-items: center !important;
    padding: 0 10px !important;
    margin: 0 !important;
}

/* 3. İKON KUTULARI */
.nav-item {
    flex: 1;
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    gap: 5px !important;
    
    /* --- RENGİ SABİTLE (Beyaz) --- */
    color: #ffffff !important; 
    opacity: 0.7; /* Pasifken biraz sönük dursun */
    
    cursor: pointer !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    background: transparent !important;
    border: none !important;
    height: 100% !important;
    
    /* --- MAVİ TIKLAMA VURGUSUNU KAPATAN KODLAR --- */
    -webkit-tap-highlight-color: transparent !important;
    outline: none !important;
    user-select: none !important;
    
    /* Aşağı İtme (3-4px) */
    padding-top: 4px !important;
    
    /* Zeminin üstünde tut */
    transform: translateZ(10px) !important;
}

.nav-item i {
    font-size: 22px !important;
    transition: 0.3s !important;
    filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5));
    color: #ffffff !important; /* İkon rengini beyaza zorla */
}

.nav-item span {
    font-size: 10px !important;
    font-weight: 600 !important;
    letter-spacing: 0.5px;
    color: #ffffff !important; /* Yazı rengini beyaza zorla */
}

/* 4. AKTİF DURUM */
.nav-item.active {
    opacity: 1 !important; /* Tam Parlak */
    
    /* Hafif yukarı kalksın */
    transform: translateZ(20px) translateY(-6px) !important;
}

.nav-item.active i {
    /* Beyaz Neon Parlama */
    text-shadow: 0 0 15px rgba(255, 255, 255, 0.9) !important;
    transform: scale(1.15) !important;
}

/* 5. ARKADAKİ BEYAZ PULSE HALKASI */
.nav-item.active::before {
    content: '';
    position: absolute;
    width: 50px;
    height: 50px;
    
    /* Bembeyaz Buzlu Cam */
    background: rgba(255, 255, 255, 0.15); 
    border: 1px solid rgba(255, 255, 255, 0.4);
    
    border-radius: 18px;
    z-index: -1; 
    
    /* Ortala ve biraz aşağı al (ikonla hizalamak için) */
    top: 50%; left: 50%;
    margin-top: -23px;
    margin-left: -25px;
    
    /* Beyaz Animasyon */
    animation: whitePulse 2s infinite !important;
}

/* Beyaz Nefes Alma Animasyonu */
@keyframes whitePulse {
    0% { 
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); 
    }
    70% { 
        box-shadow: 0 0 0 12px rgba(255, 255, 255, 0); 
    }
    100% { 
        box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); 
    }
}

/* --- AERO NAVİGASYON DÜZELTME KODU --- */
.dock-wrapper {
    position: fixed !important;
    bottom: 5px !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    width: 100% !important;
    max-width: 550px !important;
    z-index: 9999 !important;
}

.nav-container {
    position: relative !important; /* Fixed değil relative olmalı */
    bottom: auto !important;
    left: auto !important;
    width: 100% !important;
    height: 75px !important;
    background: rgba(20, 25, 40, 0.8) !important;
    backdrop-filter: blur(25px) !important;
    border-radius: 30px !important; /* Köşeleri yuvarlat */
    border: 1px solid rgba(255, 255, 255, 0.12) !important;
    margin: 0 !important;
    padding: 0 10px !important;
}
/* --- CÜZDAN KARTLARI: DİPSİZ KUYU DERİNLİĞİ --- */
.asset-card {
    /* 1. Eski dış gölgeyi kaldırıyoruz */
    box-shadow: none !important;

    /* 2. YENİ DERİNLİK EFEKTİ (İçe doğru koyu gölge) */
    /* Üstten aşağıya doğru inen güçlü bir iç karanlık */
    box-shadow: 
        inset 0 15px 30px -15px rgba(0, 0, 0, 0.9), /* Ana derinlik gölgesi */
        inset 0 2px 10px rgba(0, 0, 0, 0.5),       /* Kenar yumuşatma */
        0 1px 0 rgba(255,255,255,0.02)             /* Alt kenarda çok ince bir ışık çizgisi (çukur hissini artırır) */
        !important;

    /* 3. Kenarlıkları bu derinliğe göre ayarlıyoruz */
    /* Üst kenar daha karanlık, alt kenar daha aydınlık */
    border: none !important;
    border-top: 1px solid rgba(0, 0, 0, 0.4) !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
    border-left: 1px solid rgba(255, 255, 255, 0.02) !important;
    border-right: 1px solid rgba(255, 255, 255, 0.02) !important;

    /* Kartın orijinal renklerini korumak için background'a dokunmuyoruz.
       Sadece gölge ile oynuyoruz. */

    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1) !important;
}

/* Tıklayınca daha da derine gömülme efekti */
.asset-card:active {
    transform: scale(0.98) !important;
    /* Gölgeyi koyulaştır ve büyüt */
    box-shadow: 
        inset 0 20px 40px -10px rgba(0, 0, 0, 1),
        inset 0 5px 15px rgba(0, 0, 0, 0.7)
        !important;
}
/* --- PİYASA LİSTESİ (DİPSİZ KUYU EFEKTİ) --- */
.infinite-item {
    /* 1. Eski dış kabarıklığı sıfırla */
    box-shadow: none !important;

    /* 2. İÇE DOĞRU DERİNLİK (Kuyu Hissi) */
    /* Üstten ve soldan içeri giren koyu gölge */
    box-shadow: 
        inset 3px 3px 8px rgba(0, 0, 0, 0.8),     /* Ana derinlik */
        inset -1px -1px 2px rgba(255, 255, 255, 0.03), /* Sağ alttan çok hafif parlama */
        0 1px 0 rgba(255, 255, 255, 0.02)         /* En alta incecik çizgi */
        !important;

    /* 3. Kenarlık Işıklandırması */
    border: none !important;
    border-top: 1px solid rgba(0, 0, 0, 0.6) !important;   /* Üst taraf karanlık */
    border-left: 1px solid rgba(0, 0, 0, 0.4) !important;  /* Sol taraf karanlık */
    border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important; /* Alt taraf aydınlık */

    /* Geçişleri yumuşat */
    transition: transform 0.1s, background 0.3s !important;
}

/* Tıklayınca gömülme efekti */
.infinite-item:active {
    transform: scale(0.98) !important;
    background: var(--bg-input) !important; /* Tıklanınca hafif renk değişimi */
    box-shadow: 
        inset 5px 5px 12px rgba(0, 0, 0, 0.95) !important;
}
/* --- VARLIK & HIZLI İŞLEM (DİPSİZ KUYU EFEKTİ) --- */
.deep-inset {
    /* 1. Varsa dış gölgeyi kaldır */
    box-shadow: none !important;
    
    /* 2. İÇE DOĞRU DERİNLİK (GÜÇLÜ) */
    box-shadow: 
        inset 5px 5px 15px rgba(0, 0, 0, 0.8),    /* Sol/Üst Derinlik */
        inset -1px -1px 2px rgba(255, 255, 255, 0.05), /* Sağ/Alt Işık */
        0 1px 0 rgba(255, 255, 255, 0.02)         /* Alt Çizgi */
        !important;

    /* 3. Kenarlıklar (Işık yönüne göre) */
    border: none !important;
    border-top: 1px solid rgba(0, 0, 0, 0.6) !important;
    border-left: 1px solid rgba(0, 0, 0, 0.5) !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
    
    /* Orijinal renkleri koru ama yapıyı bozma */
    overflow: hidden !important; /* Taşmaları engelle */
    transition: transform 0.2s;
}

/* Tıklanırsa (Örn: Hızlı İşlem açılırken) tepki ver */
.deep-inset:active {
    transform: scale(0.99);
}
/* --- DİPSİZ KUYU EFEKTİ (DÜZELTİLMİŞ VERSİYON) --- */
.deep-inset {
    /* 1. Dış gölgeyi kaldır */
    box-shadow: none !important;
    
    /* 2. İÇE DOĞRU DERİNLİK */
    box-shadow: 
        inset 5px 5px 15px rgba(0, 0, 0, 0.8),    /* Derinlik */
        inset -1px -1px 2px rgba(255, 255, 255, 0.05), /* Işık */
        0 1px 0 rgba(255, 255, 255, 0.02)         /* Alt Çizgi */
        !important;

    /* 3. Kenarlıklar */
    border: none !important;
    border-top: 1px solid rgba(0, 0, 0, 0.6) !important;
    border-left: 1px solid rgba(0, 0, 0, 0.5) !important;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
    
    /* ÖNEMLİ DÜZELTME: Menünün açılmasını engelleyen kodu kaldırdık */
    overflow: visible !important; 
    transition: transform 0.2s;
}

/* Menü açıldığında rahatça uzaması için ek ayar */
#tradeCard.deep-inset {
    height: auto !important;
}

/* Tıklama efekti */
.deep-inset:active {
    transform: scale(0.99);
}
/* --- PİYASA BAŞLIĞI DÜZELTME --- */
.market-unified-header.deep-inset {
    /* BURAYA DİKKAT: 'background' komutunu bilerek yazmıyoruz! */
    /* Böylece sistem kendi orijinal rengini kullanmaya devam eder. */

    /* Sadece şekil ve sınırları koruyoruz */
    border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
    margin-bottom: 15px;
    border-radius: 0 0 20px 20px; /* Alt köşeler yuvarlak */
    z-index: 999;
    
    /* Eğer kenarlar çok karanlık olduysa, deep-inset'in gölgesini biraz yumuşatıyoruz */
    box-shadow: 
        inset 0 -10px 20px -10px rgba(0,0,0,0.5) /* Sadece alta doğru hafif gölge */
        !important;
}
/* --- AKTİF ALARM GÖRSELİ --- */
.alarm-active-icon {
    color: #fbbf24 !important; /* Altın Sarısı */
    text-shadow: 0 0 10px rgba(251, 191, 36, 0.6);
    animation: alarmPulse 2s infinite ease-in-out;
}

@keyframes alarmPulse {
    0% { opacity: 0.6; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.2); text-shadow: 0 0 20px rgba(251, 191, 36, 0.9); }
    100% { opacity: 0.6; transform: scale(1); }
}

/* Bildirim Sayfası Sekmeleri */
.notif-tabs { display: flex; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; }
.notif-tab-btn { flex: 1; padding: 10px; background: none; border: none; color: #888; border-bottom: 2px solid transparent; font-weight: 600; cursor: pointer; }
.notif-tab-btn.active { color: #fbbf24; border-bottom-color: #fbbf24; }
.notif-panel { display: none; }
.notif-panel.active { display: block; animation: fadeIn 0.3s; }
/* --- GÜVENLİK / KİLİT EKRANI STİLLERİ --- */
#lockScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #0b0f19; /* Ana tema rengi */
    z-index: 99999; /* Her şeyin üstünde olsun */
    display: none; /* Varsayılan olarak gizli */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #fff;
}

.lock-icon {
    font-size: 3rem;
    margin-bottom: 20px;
    color: #00e5ff;
}

.pin-dots {
    display: flex;
    gap: 15px;
    margin-bottom: 40px;
}

.pin-dot {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background-color: rgba(255,255,255,0.2);
    transition: all 0.2s ease;
}

.pin-dot.filled {
    background-color: #00e5ff;
    box-shadow: 0 0 10px #00e5ff;
}

.numpad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    width: 280px;
}

.num-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    background-color: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: #fff;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s;
}

.num-btn:active {
    background-color: rgba(0, 229, 255, 0.2);
}

.num-btn.dummy {
    background: transparent;
    border: none;
    cursor: default;
}
/* --- AKILLI RENKLİ SLIDER --- */
input[type=range]#aaBudgetSlider {
    -webkit-appearance: none; /* Standart görünümü kapat */
    width: 100%;
    height: 12px; /* Biraz kalınlaştırdık */
    background: #1e293b; /* Boş kalan yerin rengi */
    border-radius: 6px;
    outline: none;
    transition: background 0.1s; /* Renk geçişi yumuşak olsun */
}

/* Yuvarlak Tutamaç (Thumb) */
input[type=range]#aaBudgetSlider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    background: #ffffff; /* İçi beyaz */
    border: 4px solid #1e293b; /* Çerçevesi dinamik değişecek */
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    transition: transform 0.2s, border-color 0.2s;
    margin-top: -1px; /* Ortalamak için */
}

/* Tıklayınca büyüsün */
input[type=range]#aaBudgetSlider:active::-webkit-slider-thumb {
    transform: scale(1.3);
}

</style>

<script>
    (function(){
        let meta = document.querySelector('meta[name="viewport"]');
        if (!meta) {
            meta = document.createElement('meta');
            meta.name = "viewport";
            document.head.appendChild(meta);
        }
        meta.content = "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover";
    })();
</script>

    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5912166843737955"
     crossorigin="anonymous"></script>
     
     
     <head>
    
<body>
    <canvas id="bg-canvas"></canvas>
 

<div id="splash-screen">
    
    <div class="original-logo-container">
        <div class="crystal-logo-wrapper" style="
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            position:relative;
            padding: 20px;
        ">
            <!-- Glass Reflection Effect -->
            <div class="glass-reflection-overlay"></div>
    
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 280 280" width="180" height="180" class="crystal-logo-svg">
                <defs>
                    <!-- Premium Gradients -->
                    <linearGradient id="crystalCoreGrad" x1="0%" y1="100%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#020617"/>
                        <stop offset="30%" stop-color="#0f172a"/>
                        <stop offset="70%" stop-color="#1e3a8a"/>
                        <stop offset="100%" stop-color="#2563eb"/>
                    </linearGradient>
                    
                    <linearGradient id="crystalEdgeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#60a5fa" stop-opacity="0.8"/>
                        <stop offset="50%" stop-color="#3b82f6" stop-opacity="0.4"/>
                        <stop offset="100%" stop-color="#1d4ed8" stop-opacity="0.2"/>
                    </linearGradient>
                    
                    <linearGradient id="crystalPathGrad" x1="0%" y1="100%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#3b82f6"/>
                        <stop offset="35%" stop-color="#06b6d4"/>
                        <stop offset="65%" stop-color="#10b981"/>
                        <stop offset="100%" stop-color="#34d399"/>
                    </linearGradient>
                    
                    <linearGradient id="crystalGoldAccent" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#fcd34d"/>
                        <stop offset="50%" stop-color="#f59e0b"/>
                        <stop offset="100%" stop-color="#d97706"/>
                    </linearGradient>
                    
                    <!-- Premium Filters -->
                    <filter id="crystalInnerShadow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="3" result="blur"/>
                        <feOffset dx="2" dy="4" result="offsetBlur"/>
                        <feComposite in="SourceGraphic" in2="offsetBlur" operator="out" result="inverse"/>
                        <feFlood flood-color="#000" flood-opacity="0.3" result="color"/>
                        <feComposite in="color" in2="inverse" operator="in" result="shadow"/>
                        <feComposite in="shadow" in2="SourceGraphic" operator="over"/>
                    </filter>
                    
                    <filter id="crystalGlow" x="-100%" y="-100%" width="300%" height="300%">
                        <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur1"/>
                        <feGaussianBlur in="SourceGraphic" stdDeviation="8" result="blur2"/>
                        <feMerge>
                            <feMergeNode in="blur2"/>
                            <feMergeNode in="blur1"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                    
                    <filter id="crystalStarGlow">
                        <feGaussianBlur stdDeviation="3" result="blur"/>
                        <feMerge>
                            <feMergeNode in="blur"/>
                            <feMergeNode in="blur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                
                <!-- Outer Glow Ring -->
                <circle cx="140" cy="140" r="130" fill="none" stroke="url(#crystalEdgeGrad)" stroke-width="1" opacity="0.3"/>
                
                <!-- Background Grid Pattern -->
                <g opacity="0.08" stroke="#3b82f6" stroke-width="0.5">
                    <line x1="60" y1="140" x2="220" y2="140"/>
                    <line x1="140" y1="60" x2="140" y2="220"/>
                    <line x1="80" y1="80" x2="200" y2="200"/>
                    <line x1="200" y1="80" x2="80" y2="200"/>
                </g>
                
                <!-- Main Hexagon with 3D effect -->
                <g filter="url(#crystalInnerShadow)">
                    <!-- Back face (depth) -->
                    <path d="M140 45 L215 95 L215 185 L140 235 L65 185 L65 95 Z" 
                          fill="#020617" transform="translate(3, 3)" opacity="0.5"/>
                    
                    <!-- Main face -->
                    <path d="M140 45 L215 95 L215 185 L140 235 L65 185 L65 95 Z" 
                          fill="url(#crystalCoreGrad)"/>
                </g>
                
                <!-- Hexagon Border Glow -->
                <path d="M140 45 L215 95 L215 185 L140 235 L65 185 L65 95 Z" 
                      fill="none" stroke="url(#crystalEdgeGrad)" stroke-width="2"/>
                
                <!-- Top Edge Highlight -->
                <path d="M65 95 L140 45 L215 95" 
                      fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1.5" stroke-linecap="round"/>
                
                <!-- Inner Hexagon Pattern -->
                <path d="M140 70 L190 105 L190 175 L140 210 L90 175 L90 105 Z" 
                      fill="none" stroke="rgba(59, 130, 246, 0.15)" stroke-width="1"/>
                
                <!-- Main Chart Path with Enhanced Glow -->
                <g filter="url(#crystalGlow)">
                    <path d="M90 175 L125 190 L165 155 L165 85 L205 50" 
                          stroke="url(#crystalPathGrad)" stroke-width="7" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </g>
                
                <!-- Path Reflection -->
                <path d="M90 175 L125 190 L165 155 L165 85 L205 50" 
                      stroke="rgba(255,255,255,0.3)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"
                      transform="translate(-1, -1)"/>
                
                <!-- Data Points -->
                <circle cx="90" cy="175" r="4" fill="#3b82f6" opacity="0.8"/>
                <circle cx="125" cy="190" r="4" fill="#06b6d4" opacity="0.8"/>
                <circle cx="165" cy="155" r="4" fill="#10b981" opacity="0.8"/>
                <circle cx="165" cy="85" r="4" fill="#10b981" opacity="0.8"/>
                
                <!-- Premium Star Point -->
                <g filter="url(#crystalStarGlow)">
                    <circle cx="205" cy="50" r="10" fill="url(#crystalGoldAccent)">
                        <animate attributeName="r" values="10;13;10" dur="2s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="205" cy="50" r="5" fill="#ffffff">
                        <animate attributeName="opacity" values="1;0.7;1" dur="2s" repeatCount="indefinite"/>
                    </circle>
                </g>
                
                <!-- Sparkle Effects -->
                <g fill="#ffffff" opacity="0.8">
                    <circle cx="80" cy="75" r="1.5">
                        <animate attributeName="opacity" values="0;1;0" dur="3s" repeatCount="indefinite" begin="0s"/>
                    </circle>
                    <circle cx="200" cy="130" r="1">
                        <animate attributeName="opacity" values="0;1;0" dur="2.5s" repeatCount="indefinite" begin="0.5s"/>
                    </circle>
                    <circle cx="100" cy="200" r="1.5">
                        <animate attributeName="opacity" values="0;1;0" dur="4s" repeatCount="indefinite" begin="1s"/>
                    </circle>
                </g>
            </svg>

            <!-- Premium Text -->
            <div style="text-align:center; z-index:1; margin-top: 15px;">
                <h1 style="
                    margin: 0;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                    font-size: 40px; 
                    font-weight: 900; 
                    letter-spacing: -1px;
                    background: linear-gradient(180deg, #ffffff 0%, #cbd5e1 100%);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                ">
                    TRADE<span style="
                        background: linear-gradient(135deg, #60a5fa 0%, #34d399 50%, #fcd34d 100%);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                    ">VIA</span>
                </h1>
                
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 12px;
                    margin-top: 12px;
                ">
                    <div style="width: 30px; height: 1px; background: linear-gradient(90deg, transparent, #f59e0b);"></div>
                    <p style="
                        margin: 0;
                        font-family: 'Inter', sans-serif; 
                        font-size: 9px; 
                        font-weight: 700; 
                        color: #f59e0b; 
                        letter-spacing: 4px; 
                        text-transform: uppercase;
                    ">
                        GELİŞMİŞ FİNANS TERMİNALİ
                    </p>
                    <div style="width: 30px; height: 1px; background: linear-gradient(90deg, #f59e0b, transparent);"></div>
                </div>
            </div>
        </div>
    </div> <div class="splash-loader-bar"></div>

    <div class="splash-legal-footer">
        <a href="gizlilik.html" target="_blank">Gizlilik Politikası</a>
        <span class="sep">•</span>
        <a href="kullanim-kosullari.html" target="_blank">Yasal Uyarı</a>
        <span class="sep">•</span>
        <a href="iletisim.html" target="_blank">İletişim</a>
    </div>

        
    </div>

</div>

    </div>
    


    
</div>

<!-- === KİLİT EKRANI (LOCK SCREEN) === -->
<div id="lock-screen">
    <!-- Crystal Premium Mini Logo -->
    <svg class="lock-logo-mini" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 280 280">
        <defs>
            <linearGradient id="lockCrystalCore" x1="0%" y1="100%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#020617"/>
                <stop offset="30%" stop-color="#0f172a"/>
                <stop offset="70%" stop-color="#1e3a8a"/>
                <stop offset="100%" stop-color="#2563eb"/>
            </linearGradient>
            <linearGradient id="lockCrystalEdge" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#60a5fa" stop-opacity="0.8"/>
                <stop offset="50%" stop-color="#3b82f6" stop-opacity="0.4"/>
                <stop offset="100%" stop-color="#1d4ed8" stop-opacity="0.2"/>
            </linearGradient>
            <linearGradient id="lockCrystalPath" x1="0%" y1="100%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#3b82f6"/>
                <stop offset="35%" stop-color="#06b6d4"/>
                <stop offset="65%" stop-color="#10b981"/>
                <stop offset="100%" stop-color="#34d399"/>
            </linearGradient>
            <linearGradient id="lockCrystalGold" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#fcd34d"/>
                <stop offset="50%" stop-color="#f59e0b"/>
                <stop offset="100%" stop-color="#d97706"/>
            </linearGradient>
            <filter id="lockCrystalGlow" x="-100%" y="-100%" width="300%" height="300%">
                <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur1"/>
                <feGaussianBlur in="SourceGraphic" stdDeviation="6" result="blur2"/>
                <feMerge>
                    <feMergeNode in="blur2"/>
                    <feMergeNode in="blur1"/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            </filter>
            <filter id="lockStarGlow">
                <feGaussianBlur stdDeviation="2" result="blur"/>
                <feMerge>
                    <feMergeNode in="blur"/>
                    <feMergeNode in="blur"/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            </filter>
        </defs>
        
        <!-- Outer Ring -->
        <circle cx="140" cy="140" r="130" fill="none" stroke="url(#lockCrystalEdge)" stroke-width="1" opacity="0.3"/>
        
        <!-- 3D Hexagon -->
        <path d="M140 45 L215 95 L215 185 L140 235 L65 185 L65 95 Z" fill="#020617" transform="translate(2, 2)" opacity="0.4"/>
        <path d="M140 45 L215 95 L215 185 L140 235 L65 185 L65 95 Z" fill="url(#lockCrystalCore)" stroke="url(#lockCrystalEdge)" stroke-width="1.5"/>
        
        <!-- Top Highlight -->
        <path d="M65 95 L140 45 L215 95" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="1" stroke-linecap="round"/>
        
        <!-- Inner Hex -->
        <path d="M140 70 L190 105 L190 175 L140 210 L90 175 L90 105 Z" fill="none" stroke="rgba(59, 130, 246, 0.15)" stroke-width="1"/>
        
        <!-- Chart Line -->
        <g filter="url(#lockCrystalGlow)">
            <path d="M90 175 L125 190 L165 155 L165 85 L205 50" stroke="url(#lockCrystalPath)" stroke-width="5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </g>
        
        <!-- Data Points -->
        <circle cx="90" cy="175" r="3" fill="#3b82f6" opacity="0.7"/>
        <circle cx="125" cy="190" r="3" fill="#06b6d4" opacity="0.7"/>
        <circle cx="165" cy="155" r="3" fill="#10b981" opacity="0.7"/>
        <circle cx="165" cy="85" r="3" fill="#10b981" opacity="0.7"/>
        
        <!-- Gold Star Point -->
        <g filter="url(#lockStarGlow)">
            <circle cx="205" cy="50" r="8" fill="url(#lockCrystalGold)">
                <animate attributeName="r" values="8;10;8" dur="2s" repeatCount="indefinite"/>
            </circle>
            <circle cx="205" cy="50" r="4" fill="#ffffff">
                <animate attributeName="opacity" values="1;0.7;1" dur="2s" repeatCount="indefinite"/>
            </circle>
        </g>
        
        <!-- Sparkles -->
        <circle cx="80" cy="75" r="1" fill="#ffffff" opacity="0.6">
            <animate attributeName="opacity" values="0;1;0" dur="3s" repeatCount="indefinite"/>
        </circle>
        <circle cx="200" cy="130" r="1" fill="#ffffff" opacity="0.6">
            <animate attributeName="opacity" values="0;1;0" dur="2.5s" repeatCount="indefinite" begin="0.5s"/>
        </circle>
    </svg>

    <div class="lock-title">TradeVia Kilitli</div>
    <div class="lock-subtitle">Devam etmek için PIN kodunuzu girin</div>

    <div class="pin-container">
        <!-- PIN Noktaları -->
        <div class="pin-dots" id="pinDots">
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
            <div class="pin-dot"></div>
        </div>

        <!-- Numpad -->
        <div class="pin-numpad">
            <button class="numpad-btn" onclick="AppLock.enterDigit('1')">1</button>
            <button class="numpad-btn" onclick="AppLock.enterDigit('2')">2</button>
            <button class="numpad-btn" onclick="AppLock.enterDigit('3')">3</button>
            <button class="numpad-btn" onclick="AppLock.enterDigit('4')">4</button>
            <button class="numpad-btn" onclick="AppLock.enterDigit('5')">5</button>
            <button class="numpad-btn" onclick="AppLock.enterDigit('6')">6</button>
            <button class="numpad-btn" onclick="AppLock.enterDigit('7')">7</button>
            <button class="numpad-btn" onclick="AppLock.enterDigit('8')">8</button>
            <button class="numpad-btn" onclick="AppLock.enterDigit('9')">9</button>
            <button class="numpad-btn action" onclick="AppLock.forgotPin()"><i class="fas fa-question-circle"></i></button>
            <button class="numpad-btn" onclick="AppLock.enterDigit('0')">0</button>
            <button class="numpad-btn action" onclick="AppLock.deleteDigit()"><i class="fas fa-backspace"></i></button>
        </div>

        <div class="lock-error-msg" id="lockErrorMsg"></div>
    </div>

    <div class="lock-forgot-link" onclick="AppLock.forgotPin()">
        <i class="fas fa-info-circle"></i> Şifremi unuttum
    </div>
</div>

<!-- === ŞİFRE AYARLAMA MODALI === -->
<div class="pin-setup-modal" id="pinSetupModal">
    <button class="pin-setup-close" onclick="AppLock.closeSetupModal()">
        <i class="fas fa-times"></i>
    </button>
    
    <div class="pin-setup-card">
        <div id="pinSetupContent">
            <!-- İçerik JS ile doldurulacak -->
        </div>
    </div>
</div>

<div class="top-bar" id="mainTopBar">
    
    <div style="display:flex; align-items:center;">
        <div id="manualBackBtn" onclick="goBackHome()" style="display:none; margin-right:10px; cursor:pointer; width:30px; height:30px; align-items:center; justify-content:center;">
            <i class="fas fa-arrow-left" style="font-size:18px; color:white;"></i>
        </div>
        
        <div class="app-title">Trade<span>Via</span></div>
        
        <div  
        <span style="font-size:12px; color:#f59e0b; opacity:0.8;">BETA</span></div>

        
    </div>
    
    <div class="header-icons">
        <div class="icon-btn" onclick="switchPage('notifications', document.querySelector('.nav-item'))">
            <i class="fas fa-bell"></i>
            <span id="notifBadge" class="notif-badge">0</span>
        </div>
    </div>
</div>


<div class="content-area">
    <div id="page-portfolio" class="page active">
       

<div class="balance-hero">
    
    <style>
        /* Üst Başlık Alanı */
        .hero-header-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            opacity: 0.7;
        }

        /* Aksiyon Butonları Izgarası (Grid) */
        .hero-actions-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 Eşit Parça */
            gap: 8px; /* Butonlar arası boşluk */
            margin-top: 15px;
        }

        /* Standart Aksiyon Butonu */
        .action-btn {
            display: flex;
            flex-direction: column; /* İkon üste, yazı alta */
            justify-content: center;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            padding: 10px 0;
            border-radius: 10px; /* Hafif yuvarlak köşeler */
            min-width: 0;
            transition: all 0.2s ease;
        }

        /* İkon Boyutu */
        .action-btn i {
            font-size: 13px;
            margin-bottom: 2px;
        }

        /* Özel Cüzdan Butonu (Altın Sarısı) */
        .btn-gold {
            background: rgba(255, 215, 0, 0.1) !important;
            color: #FFD700 !important;
            border: 1px solid rgba(255, 215, 0, 0.3) !important;
        }
        
        /* Cüzdan butonuna hover efekti */
        .btn-gold:active {
            background: rgba(255, 215, 0, 0.2) !important;
        }
    </style>

    <div class="hero-header-row">
        <span class="lbl-sm" style="font-weight:600; letter-spacing:1px;">TOPLAM VARLIK</span>
        <button onclick="togglePrivacy()" style="background:none; border:none; color:var(--text-sub); cursor:pointer;">
            <i class="fas fa-eye"></i>
        </button>
    </div>

    <div class="val-lg" id="totalWallet">--</div>

    <div class="hero-stats-row">
        <div class="hero-pill"><i class="fas fa-coins"></i> Kâr: <span id="realizedPnLVal">--</span></div>
        <div class="hero-pill cash"><i class="fas fa-wallet"></i> Nakit: <span id="cashBalance">--</span></div>
    </div>

    <div class="hero-actions-grid">
        
        <button class="hero-btn action-btn" onclick="modifyCash(1)">
            <i class="fas fa-plus"></i> Yatır
        </button>
        
        <button class="hero-btn action-btn" onclick="modifyCash(-1)">
            <i class="fas fa-minus"></i> Çek
        </button>
        
        <button class="hero-btn action-btn" onclick="addDividend()">
            <i class="fas fa-gift"></i> Temettü
        </button>

        <button class="hero-btn action-btn btn-gold" onclick="openPortfolioModal()">
            <i class="fas fa-exchange-alt"></i> Cüzdan
        </button>

    </div>
</div>


        <div class="trade-card deep-inset" id="tradeCard">
    <div class="trade-header collapsible-header" onclick="toggleTradeMenu()">
                <div class="trade-title">
                    <i class="fas fa-chevron-down rotate-icon" id="tradeChevron" style="font-size:12px; margin-right:5px; color:var(--text-sub);"></i>
                    <i class="fas fa-bolt" style="color:var(--gold)"></i> Hızlı İşlem
                </div>
                <button id="currencyToggle" class="currency-toggle-btn active-try" onclick="event.stopPropagation(); toggleEntryCurrency()">₺</button>
            </div>
            <div id="tradeContent" class="collapsible-content collapsed">
    <div style="padding-top:10px;">
        
        <div class="trade-mode-switch">
            <button class="tm-switch-btn mode-crypto active" onclick="setTradeSearchMode('CRYPTO', this)">
                <i class="fab fa-bitcoin"></i> KRİPTO
            </button>
            <button class="tm-switch-btn mode-borsa" onclick="setTradeSearchMode('BORSA', this)">
                <i class="fas fa-building"></i> BORSA & FX
            </button>
        </div>
        <input type="hidden" id="activeSearchMode" value="CRYPTO">
        <div class="trade-input-group">
            <i class="fas fa-search input-icon"></i>
            <input type="text" id="addSymbol" class="trade-input" style="text-transform:uppercase;" placeholder="Sembol (BTC, ETH...)" onkeyup="debouncedPreview(this.value); calcDca();">
        </div>
        
        <div id="liveInfo" style="font-size:11px; color:var(--text-sub); margin-bottom:10px; height:15px; padding-left:5px; font-weight:600;"></div>
        <div class="input-row">
            <div class="trade-input-group"><i class="fas fa-layer-group input-icon"></i><input type="number" id="addAmount" class="trade-input" placeholder="Adet" onkeyup="calcDca(); calcLiveTotal();"></div>
            <div class="trade-input-group"><i class="fas fa-tag input-icon"></i><input type="number" id="addBuyPrice" class="trade-input" placeholder="Fiyat" onkeyup="calcDca(); calcLiveTotal();"></div>
        </div>
        <div id="dcaPreview" style="display:none; margin-bottom:10px; font-size:11px; padding:8px; background:rgba(59,130,246,0.1); border-radius:8px; color:var(--accent);"><i class="fas fa-calculator"></i> <span id="dcaText">--</span></div>
        <div class="trade-summary-box"><span class="ts-label">TOPLAM TUTAR</span><span class="ts-val" id="liveTradeTotal">0.00</span></div>
        <button class="add-btn-pro" onclick="addToPortfolio()" data-lang="add_btn">PORTFÖYE EKLE</button>
    </div>
</div>

        </div>
        <div id="portfolioList"></div>
    </div>

    <div id="page-notifications" class="page">
    <div class="main-header" style="display:flex; justify-content:space-between; align-items:center;">
    <h1>Bildirim Merkezi</h1>
    <button onclick="clearNotifications()" style="background:rgba(239, 68, 68, 0.15); color:#ef4444; border:none; padding:8px 12px; border-radius:8px; font-size:11px; font-weight:800; cursor:pointer; display:flex; align-items:center; gap:5px;">
        <i class="fas fa-trash"></i> TEMİZLE
    </button>
</div>


    <div class="notif-tabs">
        <button class="notif-tab-btn active" onclick="showNotifTab('history')">
            <i class="fas fa-history"></i> GEÇMİŞ
        </button>
        <button class="notif-tab-btn" onclick="showNotifTab('alarms')">
            <i class="fas fa-bell"></i> BEKLEYENLER
        </button>
    </div>

    <div id="panel-history" class="notif-panel active">
        <ul class="notification-list" id="notificationList">
            <div class="empty-state">Henüz bildirim yok</div>
        </ul>
    </div>

    <div id="panel-alarms" class="notif-panel">
        <ul class="notification-list" id="activeAlarmsList">
            </ul>
    </div>
</div>

    
    <div id="page-market" class="page" style="padding: 0; padding-bottom: 80px;">
    
    <div class="market-unified-header deep-inset">
        
        
        <div class="muh-top-row">
            <div class="view-toggle-group">
                <div id="btn-view-main" class="vt-btn active" onclick="switchMarketMode('main', this)">Piyasa</div>
                <div id="btn-view-watch" class="vt-btn" onclick="switchMarketMode('watchlist', this)">İzleme Listem</div>
            </div>
            
            <div class="muh-search-btn" onclick="toggleUnifiedSearch(this)">
                <i class="fas fa-search"></i>
            </div>
        </div>

        <div id="unifiedSearchBox" class="muh-search-container">
            <div class="muh-input-wrap">
                <i class="fas fa-search muh-search-icon-pos"></i>
                <input type="text" id="unifiedSearchInput" class="muh-input" placeholder="Sembol ara..." onkeyup="filterUnifiedList(this.value)">
            </div>
        </div>

        <div id="unifiedCategories" class="muh-tabs-scroll">
    <div class="muh-tab active" onclick="loadMarketCategory('kripto', this)">
        <i class="fab fa-bitcoin"></i>
        <span>Kripto</span>
    </div>
    
    <div class="muh-tab" onclick="loadMarketCategory('hisse', this)">
        <i class="fas fa-chart-line"></i>
        <span>BORSA</span>
    </div>
    
    <div class="muh-tab" onclick="loadMarketCategory('altin', this)">
        <i class="fas fa-gem"></i>
        <span>Emtia</span>
    </div>
    
    <div class="muh-tab" onclick="loadMarketCategory('doviz', this)">
        <i class="fas fa-money-bill-wave"></i>
        <span>Döviz</span>
    </div>
</div>
        <div id="unifiedFilters" class="muh-filters" style="display:none !important;"></div>


    </div>
    <div style="padding: 0 15px;">
        
        <div id="mv-main" class="market-view-section active">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:10px; color:var(--text-sub); font-weight:700; text-transform:uppercase; padding:0 5px;">
                <span>Varlık</span>
                <span>Fiyat / 24S</span>
            </div>
            <div id="infiniteMarketList" class="infinite-list-container" style="overflow-y: auto; padding-bottom: 20px;"></div>
            
            

            <div id="marketLoader" class="loader-spinner">Yükleniyor...</div>
        </div>

        <div id="mv-watchlist" class="market-view-section">
            <div id="wlLiveInfo" style="font-size:11px; color:var(--text-sub); text-align:center; margin-bottom:10px;"></div>
            <div id="wlList" style="padding-bottom:100px;"></div>
        </div>

    </div>
</div>


<div id="page-news" class="page" style="display:none; background:#0a0e17; padding:0; overflow:hidden;">

<style>
#page-news * { box-sizing: border-box; }

.news-hero {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 300px;
    z-index: 50;
    background: #0f172a;
}
.news-hero-img {
    width: 100%; height: 100%;
    object-fit: cover;
    opacity: 0.55;
    transition: opacity 0.5s;
}
.news-hero-gradient {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(to bottom, rgba(10,14,23,0.3) 0%, rgba(10,14,23,0.5) 50%, #0a0e17 100%);
}

.news-menu-btn, .news-refresh-btn {
    position: absolute;
    top: 50px;
    width: 42px; height: 42px;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 60;
    border: 1px solid rgba(255,255,255,0.15);
    transition: transform 0.2s;
}
.news-menu-btn { left: 20px; flex-direction: column; gap: 4px; }
.news-refresh-btn { right: 20px; color: #fff; font-size: 15px; }
.news-menu-btn:active, .news-refresh-btn:active { transform: scale(0.92); }
.news-menu-btn span { width: 16px; height: 2px; background: #fff; border-radius: 2px; }

.news-hero-content {
    position: absolute;
    bottom: 24px; left: 20px; right: 20px;
    z-index: 55;
}
.news-hero-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    font-size: 10px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 10px;
    text-transform: uppercase;
}
.news-hero-title {
    font-size: 18px;
    font-weight: 700;
    color: #fff;
    line-height: 1.4;
    text-shadow: 0 2px 15px rgba(0,0,0,0.5);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.news-hero-meta {
    margin-top: 8px;
    font-size: 11px;
    color: rgba(255,255,255,0.6);
}

.news-hero-dots {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 5px;
    z-index: 56;
}
.news-hero-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: rgba(255,255,255,0.35);
    cursor: pointer;
    transition: all 0.3s;
}
.news-hero-dot.active {
    width: 20px;
    border-radius: 3px;
    background: #fff;
}

.news-cat-bar {
    position: fixed;
    top: 300px; left: 0; right: 0;
    height: 46px;
    background: #0a0e17;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
    z-index: 50;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.news-cat-chip {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 12px;
    background: rgba(255,255,255,0.08);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 18px;
    color: #fff;
    font-size: 12px;
    font-weight: 600;
}
.news-count {
    font-size: 11px;
    color: #64748b;
}
.news-count strong { color: #94a3b8; }

.news-list {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    overflow-y: auto;
    padding: 356px 16px 100px;
}

.news-card {
    display: flex;
    gap: 12px;
    padding: 14px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    cursor: pointer;
}
.news-card:active { opacity: 0.6; }
.news-card-body { flex: 1; min-width: 0; }
.news-card-src {
    font-size: 11px;
    font-weight: 600;
    margin-bottom: 5px;
}
.news-card-src span { color: #64748b; font-weight: 400; }
.news-card-title {
    font-size: 14px;
    font-weight: 500;
    color: #e2e8f0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.news-card-img {
    width: 76px; height: 76px;
    border-radius: 10px;
    object-fit: cover;
    background: #1e293b;
    flex-shrink: 0;
}

.news-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    z-index: 500;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
}
.news-overlay.show { opacity: 1; visibility: visible; }

.news-panel {
    position: fixed;
    top: 0; left: 0; bottom: 0;
    width: 270px;
    z-index: 501;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    overflow: hidden;
}
.news-panel.show { transform: translateX(0); }

.np-bg {
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background-size: cover;
    background-position: center;
    transition: background-image 0.4s;
}
.np-bg::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: linear-gradient(180deg, rgba(0,0,0,0.5) 0%, rgba(0,0,0,0.85) 100%);
}

.np-content {
    position: relative;
    z-index: 2;
    display: flex;
    flex-direction: column;
    height: 100%;
}

.np-header {
    padding: 50px 20px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.np-title { font-size: 20px; font-weight: 700; color: #fff; }
.np-sub { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px; }

.np-body {
    flex: 1;
    overflow-y: auto;
    padding: 10px 8px;
}

.np-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 11px 12px;
    border-radius: 10px;
    cursor: pointer;
    margin-bottom: 3px;
    transition: background 0.2s;
}
.np-item:active { opacity: 0.7; }
.np-item.active { background: rgba(255,255,255,0.12); }

.np-icon {
    width: 34px; height: 34px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 15px;
    color: #fff;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.1);
}

.np-name {
    flex: 1;
    font-size: 14px;
    font-weight: 500;
    color: rgba(255,255,255,0.7);
}
.np-item.active .np-name { color: #fff; font-weight: 600; }

.np-check {
    width: 18px; height: 18px;
    border-radius: 50%;
    background: #fff;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    color: #000;
}
.np-item.active .np-check { display: flex; }

.np-footer {
    padding: 12px 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
    font-size: 10px;
    color: rgba(255,255,255,0.4);
    display: flex;
    align-items: center;
    gap: 6px;
}
.np-footer::before {
    content: '';
    width: 5px; height: 5px;
    background: #22c55e;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.news-loading {
    text-align: center;
    padding: 50px 20px;
    color: #64748b;
}
.news-loading i { font-size: 22px; color: #3b82f6; margin-bottom: 10px; display: block; }

@keyframes fadeUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>

<div class="news-hero">
    <img class="news-hero-img" id="heroImg" src="https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=800">
    <div class="news-hero-gradient"></div>
    <div class="news-menu-btn" onclick="NewsPanel.toggle()"><span></span><span></span><span></span></div>
    <div class="news-refresh-btn" onclick="NewsApp.refresh()"><i class="fas fa-sync-alt"></i></div>
    <div class="news-hero-content">
        <div class="news-hero-badge" id="heroBadge"><i class="fas fa-chart-bar"></i> PİYASA</div>
        <div class="news-hero-title" id="heroTitle">Haberler yükleniyor...</div>
        <div class="news-hero-meta" id="heroMeta">--</div>
    </div>
    <div class="news-hero-dots" id="heroDots"></div>
</div>

<div class="news-cat-bar">
    <div class="news-cat-chip" id="catChip"><i class="fas fa-chart-bar"></i> Piyasa</div>
    <div class="news-count" id="newsCount">Son 24 saat • <strong>0</strong> haber</div>
</div>

<div class="news-list" id="newsList">
    <div class="news-loading"><i class="fas fa-spinner fa-spin"></i>Yükleniyor...</div>
</div>

<div class="news-overlay" id="newsOverlay" onclick="NewsPanel.toggle()"></div>
<div class="news-panel" id="newsPanel">
    <div class="np-bg" id="npBg"></div>
    <div class="np-content">
        <div class="np-header">
            <div class="np-title">Kategoriler</div>
            <div class="np-sub">Haber türü seçin</div>
        </div>
        <div class="np-body" id="npBody"></div>
        <div class="np-footer" id="npFooter">Güncelleme: --:--</div>
    </div>
</div>

<script>
(function() {
    // KATEGORİLER
    const CATEGORIES = [
        { id: 'piyasa', name: 'Piyasa', icon: 'fas fa-chart-bar', bg: 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=600' },
        { id: 'kripto', name: 'Kripto', icon: 'fab fa-bitcoin', bg: 'https://images.unsplash.com/photo-1639762681485-074b7f938ba0?w=600' },
        { id: 'borsa', name: 'Borsa', icon: 'fas fa-chart-line', bg: 'https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?w=600' },
        { id: 'emtia', name: 'Emtia', icon: 'fas fa-coins', bg: 'https://images.unsplash.com/photo-1610375461246-83df859d849d?w=600' },
        { id: 'doviz', name: 'Döviz', icon: 'fas fa-dollar-sign', bg: 'https://images.unsplash.com/photo-1580519542036-c47de6196ba5?w=600' },
        { id: 'ekonomi', name: 'Ekonomi', icon: 'fas fa-landmark', bg: 'https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?w=600' }
    ];

    // TÜM KAYNAKLAR (Mevcut + Investing + TradingView)
    const SOURCES = {
        piyasa: [
            'https://news.google.com/rss/search?q=borsa+dolar+altın+ekonomi&hl=tr&gl=TR&ceid=TR:tr',
            'https://www.bloomberght.com/rss',
            'https://www.dunya.com/rss',
            'https://bigpara.hurriyet.com.tr/rss/',
            'https://tr.investing.com/rss/news.rss',
            'https://www.aa.com.tr/tr/rss/default?cat=ekonomi',
            'https://www.tradingview.com/feed/'
        ],
        kripto: [
            'https://tr.cointelegraph.com/rss',
            'https://koinbulteni.com/feed/',
            'https://uzmancoin.com/feed/',
            'https://coinotag.com/feed/',
            'https://bitcoinhaber.net/feed/',
            'https://tr.investing.com/rss/news_301.rss',
            'https://www.tradingview.com/feed/?sort=crypto'
        ],
        borsa: [
            'https://www.bloomberght.com/rss',
            'https://bigpara.hurriyet.com.tr/rss/',
            'https://www.dunya.com/rss',
            'https://tr.investing.com/rss/news.rss',
            'https://tr.investing.com/rss/stock_Ede.rss',
            'https://www.aa.com.tr/tr/rss/default?cat=ekonomi',
            'https://www.tradingview.com/feed/?sort=stock'
        ],
        emtia: [
            'https://tr.investing.com/rss/commodities_Ede.rss',
            'https://www.bloomberght.com/rss',
            'https://bigpara.hurriyet.com.tr/rss/',
            'https://www.dunya.com/rss',
            'https://tr.investing.com/rss/news_14.rss',
            'https://www.tradingview.com/feed/?sort=commodities'
        ],
        doviz: [
            'https://www.doviz.com/rss/haberler',
            'https://tr.investing.com/rss/forex_Ede.rss',
            'https://www.bloomberght.com/rss',
            'https://bigpara.hurriyet.com.tr/rss/',
            'https://www.dunya.com/rss',
            'https://tr.investing.com/rss/news_1.rss',
            'https://www.tradingview.com/feed/?sort=forex'
        ],
        ekonomi: [
            'https://www.bloomberght.com/rss',
            'https://www.dunya.com/rss',
            'https://www.aa.com.tr/tr/rss/default?cat=ekonomi',
            'https://bigpara.hurriyet.com.tr/rss/',
            'https://tr.investing.com/rss/news_95.rss',
            'https://tr.investing.com/rss/news.rss',
            'https://www.tradingview.com/feed/'
        ]
    };

    // FALLBACK RESİMLER
    const FALLBACK_IMAGES = {
        piyasa: 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=800',
        kripto: 'https://images.unsplash.com/photo-1639762681485-074b7f938ba0?w=800',
        borsa: 'https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?w=800',
        emtia: 'https://images.unsplash.com/photo-1610375461246-83df859d849d?w=800',
        doviz: 'https://images.unsplash.com/photo-1580519542036-c47de6196ba5?w=800',
        ekonomi: 'https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?w=800'
    };

    // ANAHTAR KELİME RESİMLERİ
    const KEYWORD_IMAGES = {
        bitcoin: 'https://images.unsplash.com/photo-1518546305927-5a555bb7020d?w=400',
        btc: 'https://images.unsplash.com/photo-1518546305927-5a555bb7020d?w=400',
        ethereum: 'https://images.unsplash.com/photo-1622630998477-166aead6616d?w=400',
        eth: 'https://images.unsplash.com/photo-1622630998477-166aead6616d?w=400',
        kripto: 'https://images.unsplash.com/photo-1639762681485-074b7f938ba0?w=400',
        altın: 'https://images.unsplash.com/photo-1610375461246-83df859d849d?w=400',
        ons: 'https://images.unsplash.com/photo-1610375461246-83df859d849d?w=400',
        gold: 'https://images.unsplash.com/photo-1610375461246-83df859d849d?w=400',
        petrol: 'https://images.unsplash.com/photo-1518709766631-a6a7f45921c3?w=400',
        brent: 'https://images.unsplash.com/photo-1518709766631-a6a7f45921c3?w=400',
        dolar: 'https://images.unsplash.com/photo-1580519542036-c47de6196ba5?w=400',
        euro: 'https://images.unsplash.com/photo-1580519542036-c47de6196ba5?w=400',
        kur: 'https://images.unsplash.com/photo-1580519542036-c47de6196ba5?w=400',
        borsa: 'https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?w=400',
        bist: 'https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?w=400',
        hisse: 'https://images.unsplash.com/photo-1590283603385-17ffb3a7f29f?w=400',
        faiz: 'https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?w=400',
        enflasyon: 'https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?w=400',
        tcmb: 'https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?w=400',
        merkez: 'https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?w=400',
        fed: 'https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?w=400'
    };

    // KAYNAK İSİMLERİ
    const PROVIDER_NAMES = {
        google: 'Google',
        bloomberg: 'Bloomberg',
        dunya: 'Dünya',
        bigpara: 'Bigpara',
        investing: 'Investing',
        cointelegraph: 'Cointelegraph',
        koinbulteni: 'Koin Bülteni',
        uzmancoin: 'Uzman Coin',
        coinotag: 'Coinotag',
        bitcoinhaber: 'BTC Haber',
        doviz: 'Doviz.com',
        'aa.com': 'AA',
        tradingview: 'TradingView'
    };

    // KAYNAK RENKLERİ
    const PROVIDER_COLORS = {
        Google: '#4285f4',
        Bloomberg: '#7c3aed',
        Dünya: '#0d9488',
        Bigpara: '#f59e0b',
        Investing: '#22c55e',
        Cointelegraph: '#f7931a',
        'Koin Bülteni': '#3b82f6',
        'Uzman Coin': '#8b5cf6',
        Coinotag: '#eab308',
        'BTC Haber': '#f97316',
        'Doviz.com': '#10b981',
        AA: '#16a34a',
        TradingView: '#2962ff'
    };

    // PANEL KONTROL
    window.NewsPanel = {
        isOpen: false,
        toggle: function() {
            this.isOpen = !this.isOpen;
            document.getElementById('newsPanel').classList.toggle('show', this.isOpen);
            document.getElementById('newsOverlay').classList.toggle('show', this.isOpen);
        }
    };

    // ANA UYGULAMA
    window.NewsApp = {
        currentCategory: 'piyasa',
        currentSlide: 0,
        topNews: [],
        sliderTimer: null,
        refreshTimer: null,
        cache: {},

        // Başlat
        init: function() {
            this.renderPanel();
            this.setBackground('piyasa');
            this.loadNews('piyasa');
            this.startSlider();
            this.startAutoRefresh();
            console.log('📰 Haber modülü başlatıldı');
        },

        // Panel render
        renderPanel: function() {
            var html = '';
            for (var i = 0; i < CATEGORIES.length; i++) {
                var c = CATEGORIES[i];
                var isActive = c.id === 'piyasa' ? 'active' : '';
                html += '<div class="np-item ' + isActive + '" data-id="' + c.id + '" onclick="NewsApp.selectCategory(\'' + c.id + '\')">';
                html += '<div class="np-icon"><i class="' + c.icon + '"></i></div>';
                html += '<div class="np-name">' + c.name + '</div>';
                html += '<div class="np-check"><i class="fas fa-check"></i></div>';
                html += '</div>';
            }
            document.getElementById('npBody').innerHTML = html;
        },

        // Arka plan ayarla
        setBackground: function(id) {
            for (var i = 0; i < CATEGORIES.length; i++) {
                if (CATEGORIES[i].id === id) {
                    document.getElementById('npBg').style.backgroundImage = 'url(' + CATEGORIES[i].bg + ')';
                    break;
                }
            }
        },

        // Kategori seç
        selectCategory: function(id) {
            var items = document.querySelectorAll('.np-item');
            for (var i = 0; i < items.length; i++) {
                items[i].classList.toggle('active', items[i].dataset.id === id);
            }
            this.setBackground(id);
            var self = this;
            setTimeout(function() { NewsPanel.toggle(); }, 150);
            this.loadNews(id);
        },

        // Haberleri yükle
        loadNews: function(id) {
            this.currentCategory = id;
            var category = null;
            for (var i = 0; i < CATEGORIES.length; i++) {
                if (CATEGORIES[i].id === id) {
                    category = CATEGORIES[i];
                    break;
                }
            }

            document.getElementById('catChip').innerHTML = '<i class="' + category.icon + '"></i> ' + category.name;
            document.getElementById('heroBadge').innerHTML = '<i class="' + category.icon + '"></i> ' + category.name.toUpperCase();
            document.getElementById('newsList').innerHTML = '<div class="news-loading"><i class="fas fa-satellite-dish fa-spin"></i> Haberler taranıyor...</div>';

            this.fetchNews(id);
        },

        // Haberleri çek
        fetchNews: function(category) {
            var self = this;
            var cacheData = this.cache[category];
            
            // 3 dakika cache
            if (cacheData && Date.now() - cacheData.timestamp < 180000) {
                this.renderNews(cacheData.items);
                return;
            }

            var proxy = 'https://api.rss2json.com/v1/api.json?rss_url=';
            var urls = SOURCES[category] || [];
            var completed = 0;
            var allItems = [];

            if (urls.length === 0) {
                this.renderNews([]);
                return;
            }

            for (var i = 0; i < urls.length; i++) {
                (function(url) {
                    var xhr = new XMLHttpRequest();
                    xhr.timeout = 10000;
                    xhr.open('GET', proxy + encodeURIComponent(url), true);
                    
                    xhr.onload = function() {
                        if (xhr.status === 200) {
                            try {
                                var data = JSON.parse(xhr.responseText);
                                if (data && data.status === 'ok' && data.items) {
                                    var provider = self.getProviderName(data.feed ? data.feed.title : '', url);
                                    for (var j = 0; j < data.items.length; j++) {
                                        data.items[j].provider = provider;
                                        allItems.push(data.items[j]);
                                    }
                                }
                            } catch (e) {}
                        }
                        checkComplete();
                    };

                    xhr.onerror = function() { checkComplete(); };
                    xhr.ontimeout = function() { checkComplete(); };
                    xhr.send();
                })(urls[i]);
            }

            function checkComplete() {
                completed++;
                if (completed === urls.length) {
                    self.processNews(allItems, category);
                }
            }
        },

        // Haberleri işle
        processNews: function(items, category) {
            var now = Date.now();
            var oneDayAgo = now - 86400000; // 24 saat
            var filtered = [];
            var seen = {};

            // Son 24 saat filtrele ve duplicate temizle
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var pubDate = new Date(item.pubDate).getTime();
                
                if (pubDate > oneDayAgo) {
                    var key = item.title.toLowerCase().substring(0, 50);
                    if (!seen[key]) {
                        seen[key] = true;
                        filtered.push(item);
                    }
                }
            }

            // Tarihe göre sırala (yeniden eskiye)
            filtered.sort(function(a, b) {
                return new Date(b.pubDate) - new Date(a.pubDate);
            });

            // Cache'e kaydet
            this.cache[category] = {
                items: filtered,
                timestamp: Date.now()
            };

            this.renderNews(filtered);
        },

        // Haberleri göster
        renderNews: function(items) {
            var self = this;
            
            // Hero slider
            this.topNews = items.slice(0, 5);
            this.currentSlide = 0;

            if (this.topNews.length > 0) {
                this.showSlide(0);
                var dotsHtml = '';
                for (var i = 0; i < this.topNews.length; i++) {
                    dotsHtml += '<div class="news-hero-dot ' + (i === 0 ? 'active' : '') + '" onclick="NewsApp.goToSlide(' + i + ')"></div>';
                }
                document.getElementById('heroDots').innerHTML = dotsHtml;
            }

            // Güncelleme zamanı
            var now = new Date();
            var timeStr = ('0' + now.getHours()).slice(-2) + ':' + ('0' + now.getMinutes()).slice(-2);
            document.getElementById('newsCount').innerHTML = 'Son 24 saat • <strong>' + items.length + '</strong> haber';
            document.getElementById('npFooter').textContent = 'Güncelleme: ' + timeStr;

            // Liste
            var listItems = items.slice(5);

            if (listItems.length === 0) {
                if (items.length > 0) {
                    document.getElementById('newsList').innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;"><i class="fas fa-check-circle" style="color:#22c55e;font-size:24px;display:block;margin-bottom:10px;"></i>Tüm haberler yukarıda</div>';
                } else {
                    document.getElementById('newsList').innerHTML = '<div style="text-align:center;padding:40px;color:#64748b;"><i class="fas fa-inbox" style="font-size:24px;display:block;margin-bottom:10px;"></i>Haber bulunamadı</div>';
                }
                return;
            }

            var html = '';
            for (var i = 0; i < listItems.length; i++) {
                var item = listItems[i];
                var color = PROVIDER_COLORS[item.provider] || '#64748b';
                var img = this.getImage(item);
                var title = this.cleanTitle(item.title);
                var ago = this.timeAgo(new Date(item.pubDate));

                html += '<div class="news-card" onclick="window.open(\'' + item.link + '\',\'_blank\')" style="animation:fadeUp .25s ease ' + (i * 0.02) + 's both">';
                html += '<div class="news-card-body">';
                html += '<div class="news-card-src" style="color:' + color + '">' + item.provider + ' <span>• ' + ago + '</span></div>';
                html += '<div class="news-card-title">' + title + '</div>';
                html += '</div>';
                html += '<img class="news-card-img" src="' + img + '" onerror="this.src=\'' + FALLBACK_IMAGES[self.currentCategory] + '\'">';
                html += '</div>';
            }

            document.getElementById('newsList').innerHTML = html;
        },

        // Slide göster
        showSlide: function(index) {
            var item = this.topNews[index];
            if (!item) return;

            var self = this;
            var img = document.getElementById('heroImg');
            img.style.opacity = '0.3';

            setTimeout(function() {
                img.src = self.getImage(item);
                img.onerror = function() { img.src = FALLBACK_IMAGES[self.currentCategory]; };
                document.getElementById('heroTitle').textContent = self.cleanTitle(item.title);
                document.getElementById('heroMeta').innerHTML = '<i class="far fa-clock"></i> ' + item.provider + ' • ' + self.timeAgo(new Date(item.pubDate));
                img.style.opacity = '0.55';
            }, 150);

            var dots = document.querySelectorAll('.news-hero-dot');
            for (var i = 0; i < dots.length; i++) {
                dots[i].classList.toggle('active', i === index);
            }
        },

        // Slide'a git
        goToSlide: function(index) {
            this.currentSlide = index;
            this.showSlide(index);
            this.resetSlider();
        },

        // Sonraki slide
        nextSlide: function() {
            if (this.topNews.length > 0) {
                this.currentSlide = (this.currentSlide + 1) % this.topNews.length;
                this.showSlide(this.currentSlide);
            }
        },

        // Slider başlat
        startSlider: function() {
            var self = this;
            if (this.sliderTimer) clearInterval(this.sliderTimer);
            this.sliderTimer = setInterval(function() {
                self.nextSlide();
            }, 5000);
        },

        // Slider sıfırla
        resetSlider: function() {
            this.startSlider();
        },

        // Otomatik yenileme başlat (3 dakika)
        startAutoRefresh: function() {
            var self = this;
            if (this.refreshTimer) clearInterval(this.refreshTimer);
            
            this.refreshTimer = setInterval(function() {
                var page = document.getElementById('page-news');
                if (page && page.style.display !== 'none') {
                    console.log('🔄 Otomatik yenileme: ' + new Date().toLocaleTimeString());
                    self.cache = {};
                    self.loadNews(self.currentCategory);
                }
            }, 180000); // 3 dakika
        },

        // Manuel yenile
        refresh: function() {
            var btn = document.querySelector('.news-refresh-btn i');
            if (btn) {
                btn.classList.remove('fa-sync-alt');
                btn.classList.add('fa-spinner', 'fa-spin');
            }

            this.cache = {};
            this.loadNews(this.currentCategory);

            setTimeout(function() {
                if (btn) {
                    btn.classList.remove('fa-spinner', 'fa-spin');
                    btn.classList.add('fa-sync-alt');
                }
            }, 2000);
        },

        // Resim al
        getImage: function(item) {
            // 1. Thumbnail
            if (item.thumbnail && item.thumbnail.length > 20 && !this.isBadImage(item.thumbnail)) {
                return item.thumbnail;
            }

            // 2. Enclosure
            if (item.enclosure) {
                var encUrl = item.enclosure.link || item.enclosure.url;
                if (encUrl && encUrl.length > 20 && !this.isBadImage(encUrl)) {
                    return encUrl;
                }
            }

            // 3. İçerikten ara
            var content = (item.description || '') + (item.content || '');
            var imgMatch = content.match(/<img[^>]+src=["']([^"']+)["']/i);
            if (imgMatch && imgMatch[1] && !this.isBadImage(imgMatch[1])) {
                return imgMatch[1];
            }

            // 4. Anahtar kelime
            var title = (item.title || '').toLowerCase();
            for (var keyword in KEYWORD_IMAGES) {
                if (title.indexOf(keyword) !== -1) {
                    return KEYWORD_IMAGES[keyword];
                }
            }

            // 5. Fallback
            return FALLBACK_IMAGES[this.currentCategory];
        },

        // Kötü resim kontrolü
        isBadImage: function(url) {
            if (!url) return true;
            var badWords = ['spacer', '1x1', 'pixel', 'blank', 'placeholder', 'logo', 'icon', 'avatar', 'tracking', 'analytics', 'badge', 'button', 'sprite', 'transparent'];
            var lowerUrl = url.toLowerCase();
            
            for (var i = 0; i < badWords.length; i++) {
                if (lowerUrl.indexOf(badWords[i]) !== -1) return true;
            }
            
            if (lowerUrl.indexOf('.gif') !== -1 && lowerUrl.indexOf('giphy') === -1) return true;
            if (lowerUrl.indexOf('width=1') !== -1 || lowerUrl.indexOf('size=1') !== -1 || lowerUrl.indexOf('w=1') !== -1) return true;
            
            return false;
        },

        // Kaynak adı al
        getProviderName: function(title, url) {
            var text = ((title || '') + url).toLowerCase();
            for (var key in PROVIDER_NAMES) {
                if (text.indexOf(key) !== -1) {
                    return PROVIDER_NAMES[key];
                }
            }
            return 'Kaynak';
        },

        // Başlık temizle
        cleanTitle: function(title) {
            if (!title) return '';
            return title.replace(/\s*[-–|]\s*[^|–-]{0,30}$/i, '').trim();
        },

        // Zaman farkı
        timeAgo: function(date) {
            var seconds = Math.floor((Date.now() - date) / 1000);
            if (seconds < 60) return 'Şimdi';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' dk';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' sa';
            return Math.floor(seconds / 86400) + ' gün';
        }
    };

    // BAŞLAT
    function initNews() {
        setTimeout(function() {
            NewsApp.init();
        }, 300);
    }

    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initNews();
    } else {
        document.addEventListener('DOMContentLoaded', initNews);
    }

    // Tab değişikliğinde kontrol
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            var page = document.getElementById('page-news');
            if (page && page.style.display !== 'none') {
                var cacheData = NewsApp.cache[NewsApp.currentCategory];
                var lastUpdate = cacheData ? cacheData.timestamp : 0;
                if (Date.now() - lastUpdate > 180000) {
                    console.log('🔄 Tab aktif, haberler yenileniyor...');
                    NewsApp.cache = {};
                    NewsApp.loadNews(NewsApp.currentCategory);
                }
            }
        }
    });

})();
</script>

</div>


<div id="page-analysis" class="page">
    
    <div style="margin-bottom: 20px;">
        <h2 style="margin:0; font-size:22px; font-weight:800; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Finansal Planlama</h2>
        <span style="font-size:12px; color:var(--text-sub);">Gelecekteki Varlığınızı Bugünden Kurgulayın</span>
    </div>

    <div class="settings-tabs segmented" style="margin-bottom: 20px;">
        <div class="s-tab seg-style active" onclick="switchAnTab('perf', this)">PERFORMANS</div>
        
        <div class="s-tab seg-style" onclick="switchAnTab('vision', this)">HEDEFLERİM</div>
        <div class="s-tab seg-style" onclick="switchAnTab('psycho', this)">PSİKOLOJİ</div>

        <div class="s-tab seg-style" onclick="switchAnTab('lab', this)">AR-GE</div>
    </div>

    
        <div id="an-view-perf" class="an-view-section active">
        <div class="dashboard-container">
            
            
            
            <!-- HERO NET WORTH CARD -->
            <div class="dash-card full-width perf-hero-card">
                <div class="metric-title">
                    <span><i class="fas fa-gem"></i> TOPLAM NET VARLIK</span>
                </div>
                <div class="metric-value" id="anNetWorth">--</div>
                <div class="metric-sub" id="anNetWorthSub">
                    <span id="anPnlPill">--</span> <span style="color:rgba(148, 163, 184, 0.6)">Toplam Kâr/Zarar</span>
                </div>
            </div>

            <!-- WIN RATE CARD -->
            <div class="dash-card perf-mini-card win-rate-card">
                <div class="metric-title"><i class="fas fa-bullseye"></i> BAŞARI ORANI</div>
                <div class="win-rate-container">
                    <canvas id="winRateChart"></canvas>
                    <div class="win-rate-text">
                        <span class="wr-val" id="winRateVal">%--</span>
                        <span class="wr-lbl">Win Rate</span>
                    </div>
                </div>
            </div>

            <!-- CASH RATIO CARD -->
            <div class="dash-card perf-mini-card cash-ratio-card">
                <div class="metric-title"><i class="fas fa-vault"></i> NAKİT ORANI</div>
                <div style="display:flex; flex-direction:column; flex:1; justify-content:center;">
                    <div class="metric-value" id="anCashRatioVal" style="font-size:22px; background: linear-gradient(135deg, #fbbf24, #f59e0b); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">--</div>
                    <div class="perf-progress-wrapper">
                        <div class="perf-progress-bg">
                            <div id="cashRatioBar" class="perf-progress-fill" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="perf-progress-label">Kasada: <span id="anCashRaw" style="color:rgba(251, 191, 36, 0.8); font-weight:600;">--</span></div>
                </div>
            </div>

            <!-- TRADER KARNESI PREMIUM -->
            <div class="dash-card full-width perf-trader-card">
                <div class="perf-trader-header">
                    <div class="perf-trader-title">
                        <i class="fas fa-award"></i> TRADER KARNESİ
                    </div>
                    <div id="scoreBadge" class="perf-score-badge">VERİ YOK</div>
                </div>

                <div class="perf-stats-grid">
                    <div class="perf-stat-box">
                        <div class="perf-stat-label">KÂR FAKTÖRÜ</div>
                        <div id="pfScore" class="perf-stat-value">--</div>
                        <div id="pfDesc" class="perf-stat-desc">Bekleniyor</div>
                    </div>

                    <div class="perf-stat-box">
                        <div class="perf-stat-label">İŞLEM BEKLENTİSİ</div>
                        <div id="expScore" class="perf-stat-value">--</div>
                        <div id="expDesc" class="perf-stat-desc">Bekleniyor</div>
                    </div>
                    
                    <div class="perf-stat-box full-span">
                        <div class="stat-left">
                            <div class="perf-stat-label" style="color:rgba(52, 211, 153, 0.9);">ORT. KAZANÇ</div>
                            <div id="avgWinVal" class="perf-stat-value" style="color:#34d399;">--</div>
                        </div>
                        <div class="divider"></div>
                        <div class="stat-right">
                            <div class="perf-stat-label" style="color:rgba(251, 113, 133, 0.9);">ORT. KAYIP</div>
                            <div id="avgLossVal" class="perf-stat-value" style="color:#fb7185;">--</div>
                        </div>
                    </div>
                </div>
                
                <div style="font-size:9px; color:rgba(148, 163, 184, 0.4); text-align:center; font-style:italic; margin-top:14px;">
                    <i class="fas fa-info-circle" style="margin-right:4px;"></i> Geçmiş satış işlemleriniz üzerinden hesaplanır.
                </div>
            </div>

            <!-- GROWTH CHART PREMIUM -->
            <div class="dash-card full-width perf-chart-card">
                <div class="chart-header">
                    <div class="metric-title" style="margin:0;"><i class="fas fa-chart-area"></i> PORTFÖY BÜYÜMESİ</div>
                    <div style="display:flex; gap:6px;">
                        <button class="chart-filter-btn active" onclick="updateGrowthChart(7)">7G</button>
                        <button class="chart-filter-btn" onclick="updateGrowthChart(30)">30G</button>
                    </div>
                </div>
                <div style="height: 200px; width: 100%;">
                    <canvas id="realGrowthChart"></canvas>
                </div>
                <div class="perf-chart-info">
                    <i class="fas fa-sync-alt"></i> Grafik, her gün sisteme giriş yaptığınızda otomatik kaydedilir.
                </div>
            </div>

            <!-- TOP PERFORMERS PREMIUM -->
            <div class="dash-card full-width perf-top-card">
                <div class="metric-title"><i class="fas fa-trophy"></i> EN ÇOK KAZANDIRANLAR</div>
                <div id="topPerformersList"></div>
            </div>

            <!-- ALLOCATION CHART PREMIUM -->
            <div class="dash-card full-width perf-allocation-card">
                <div class="metric-title"><i class="fas fa-chart-pie"></i> VARLIK DAĞILIMI</div>
                <div style="height: 200px; display:flex; justify-content:center;">
                    <canvas id="newAllocationChart"></canvas>
                </div>
            </div>
        </div> 
    </div>

    <!-- VISION SECTION - Premium Design -->
<!-- Bu kodu mevcut an-view-vision section'ının yerine yapıştır -->

<style>
/* VISION PREMIUM STYLES */

/* Fullscreen Mode */
#an-view-vision.vision-fullscreen-mode {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    height: 100% !important;
    z-index: 9999 !important;
    background: linear-gradient(165deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%) !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow: hidden !important;
}

#an-view-vision {
    --vision-bg-deep: #0f172a;
    --vision-bg-card: rgba(30, 41, 59, 0.5);
    --vision-bg-elevated: rgba(51, 65, 85, 0.4);
    --vision-glass-border: rgba(255, 255, 255, 0.1);
    --vision-accent-purple: #a78bfa;
    --vision-accent-purple-dim: rgba(167, 139, 250, 0.2);
    --vision-accent-pink: #c084fc;
    --vision-accent-pink-dim: rgba(192, 132, 252, 0.15);
    --vision-accent-orange: #f97316;
    --vision-accent-orange-dim: rgba(249, 115, 22, 0.12);
    --vision-accent-emerald: #34d399;
    --vision-accent-emerald-dim: rgba(52, 211, 153, 0.12);
    --vision-accent-gold: #fbbf24;
    --vision-accent-gold-dim: rgba(251, 191, 36, 0.12);
    --vision-text-primary: #f8fafc;
    --vision-text-secondary: #cbd5e1;
    --vision-text-muted: #64748b;
}

/* Top Navigation Bar */
#an-view-vision .vision-topbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: rgba(15, 23, 42, 0.85);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    z-index: 10000;
    height: 64px;
}

#an-view-vision .vision-back-btn {
    width: 40px;
    height: 40px;
    background: transparent;
    border: none;
    border-radius: 12px;
    color: var(--vision-text-primary);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

#an-view-vision .vision-back-btn:hover {
    background: var(--vision-bg-elevated);
}

#an-view-vision .vision-back-btn:active {
    transform: scale(0.95);
}

#an-view-vision .vision-topbar-title {
    display: flex;
    align-items: center;
    gap: 8px;
}

#an-view-vision .vision-topbar-brand {
    font-size: 20px;
    font-weight: 800;
    color: var(--vision-text-primary);
    letter-spacing: -0.5px;
}

#an-view-vision .vision-topbar-beta {
    font-size: 10px;
    font-weight: 700;
    color: #fb7185;
    letter-spacing: 0.5px;
}

/* Scrollable Content */
#an-view-vision .vision-content {
    position: absolute;
    top: 64px;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 16px;
    padding-bottom: 100px;
    -webkit-overflow-scrolling: touch;
}

#an-view-vision .vision-content::-webkit-scrollbar {
    width: 4px;
}

#an-view-vision .vision-content::-webkit-scrollbar-track {
    background: transparent;
}

#an-view-vision .vision-content::-webkit-scrollbar-thumb {
    background: var(--vision-text-muted);
    border-radius: 4px;
}

/* Ambient Background - PREMIUM ANIMATED */
#an-view-vision .vision-ambient-bg {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
    background: 
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(120, 119, 198, 0.15), transparent),
        radial-gradient(ellipse 60% 40% at 100% 100%, rgba(139, 92, 246, 0.1), transparent),
        radial-gradient(ellipse 50% 30% at 0% 80%, rgba(99, 102, 241, 0.08), transparent);
}

#an-view-vision .vision-ambient-orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(60px);
}

#an-view-vision .vision-orb-1 {
    width: 400px; height: 400px;
    background: radial-gradient(circle, rgba(139, 92, 246, 0.35) 0%, rgba(139, 92, 246, 0.1) 40%, transparent 70%);
    top: -15%; right: -10%;
    animation: orb1Float 25s ease-in-out infinite;
}

#an-view-vision .vision-orb-2 {
    width: 350px; height: 350px;
    background: radial-gradient(circle, rgba(99, 102, 241, 0.3) 0%, rgba(99, 102, 241, 0.08) 40%, transparent 70%);
    bottom: 10%; left: -15%;
    animation: orb2Float 30s ease-in-out infinite;
}

/* Ek orb'lar için CSS - HTML'e de eklenecek */
#an-view-vision .vision-orb-3 {
    width: 250px; height: 250px;
    background: radial-gradient(circle, rgba(192, 132, 252, 0.25) 0%, transparent 60%);
    top: 40%; right: -5%;
    animation: orb3Float 20s ease-in-out infinite;
}

#an-view-vision .vision-orb-4 {
    width: 200px; height: 200px;
    background: radial-gradient(circle, rgba(129, 140, 248, 0.2) 0%, transparent 60%);
    bottom: 30%; left: 50%;
    animation: orb4Float 22s ease-in-out infinite;
}

/* Mesh gradient overlay */
#an-view-vision .vision-ambient-bg::before {
    content: '';
    position: absolute;
    inset: 0;
    background: 
        linear-gradient(180deg, transparent 0%, rgba(15, 23, 42, 0.3) 100%);
    pointer-events: none;
}

/* Subtle grid pattern */
#an-view-vision .vision-ambient-bg::after {
    content: '';
    position: absolute;
    inset: 0;
    background-image: 
        linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
    background-size: 50px 50px;
    opacity: 0.5;
}

@keyframes orb1Float {
    0%, 100% { 
        transform: translate(0, 0) scale(1); 
        opacity: 0.6;
    }
    25% { 
        transform: translate(-30px, 40px) scale(1.1); 
        opacity: 0.8;
    }
    50% { 
        transform: translate(20px, 60px) scale(0.95); 
        opacity: 0.5;
    }
    75% { 
        transform: translate(40px, 20px) scale(1.05); 
        opacity: 0.7;
    }
}

@keyframes orb2Float {
    0%, 100% { 
        transform: translate(0, 0) scale(1); 
        opacity: 0.5;
    }
    33% { 
        transform: translate(50px, -30px) scale(1.15); 
        opacity: 0.7;
    }
    66% { 
        transform: translate(20px, -60px) scale(0.9); 
        opacity: 0.6;
    }
}

@keyframes orb3Float {
    0%, 100% { 
        transform: translate(0, 0) rotate(0deg); 
        opacity: 0.4;
    }
    50% { 
        transform: translate(-40px, 30px) rotate(180deg); 
        opacity: 0.6;
    }
}

@keyframes orb4Float {
    0%, 100% { 
        transform: translate(0, 0); 
        opacity: 0.3;
    }
    50% { 
        transform: translate(30px, -40px); 
        opacity: 0.5;
    }
}

/* Twinkling stars effect */
#an-view-vision .vision-stars {
    position: absolute;
    inset: 0;
    overflow: hidden;
}

#an-view-vision .vision-star {
    position: absolute;
    width: 2px;
    height: 2px;
    background: rgba(255, 255, 255, 0.6);
    border-radius: 50%;
    animation: twinkle 3s ease-in-out infinite;
}

@keyframes twinkle {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.5); }
}

/* Header Section */
#an-view-vision .vision-header {
    text-align: center;
    padding: 20px 16px 10px;
    position: relative;
    z-index: 1;
}

#an-view-vision .vision-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, var(--vision-accent-purple-dim), transparent);
    border: 1px solid rgba(168, 85, 247, 0.3);
    padding: 5px 14px;
    border-radius: 100px;
    font-size: 9px;
    font-weight: 700;
    color: var(--vision-accent-purple);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 12px;
}

#an-view-vision .vision-title {
    font-size: 24px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, #fff 0%, #a855f7 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 6px;
}

#an-view-vision .vision-subtitle {
    font-size: 12px;
    color: var(--vision-text-secondary);
}

/* Goal Progress Card */
#an-view-vision .vision-goal-card {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(15, 23, 42, 0.8));
    backdrop-filter: blur(20px);
    border: 1px solid rgba(168, 85, 247, 0.2);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
    z-index: 1;
    overflow: hidden;
}

#an-view-vision .vision-goal-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--vision-accent-purple), var(--vision-accent-pink), transparent);
}

#an-view-vision .vision-goal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

#an-view-vision .vision-goal-title {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--vision-text-muted);
    display: flex;
    align-items: center;
    gap: 8px;
}

#an-view-vision .vision-goal-title i {
    color: var(--vision-accent-purple);
}

#an-view-vision .vision-edit-btn {
    background: rgba(168, 85, 247, 0.1);
    border: 1px solid rgba(168, 85, 247, 0.2);
    border-radius: 8px;
    padding: 6px 12px;
    font-size: 10px;
    font-weight: 600;
    color: var(--vision-accent-purple);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

#an-view-vision .vision-edit-btn:hover {
    background: rgba(168, 85, 247, 0.2);
}

/* Progress Bar - Eski class isimleri korundu */
#an-view-vision .goal-strip-container {
    position: relative;
    height: 48px;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 12px;
    overflow: hidden;
}

#an-view-vision .goal-strip-fill {
    height: 100%;
    border-radius: 12px;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

#an-view-vision .goal-strip-fill::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.2) 50%, transparent 100%);
    animation: visionShine 2.5s ease-in-out infinite;
}

@keyframes visionShine {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

#an-view-vision .goal-strip-fill.gs-red {
    background: linear-gradient(90deg, #ef4444, #f97316);
}

#an-view-vision .goal-strip-fill.gs-orange {
    background: linear-gradient(90deg, #f97316, #fbbf24);
}

#an-view-vision .goal-strip-fill.gs-yellow {
    background: linear-gradient(90deg, #fbbf24, #a3e635);
}

#an-view-vision .goal-strip-fill.gs-green {
    background: linear-gradient(90deg, #22c55e, #10b981);
}

#an-view-vision .goal-strip-fill.gs-complete {
    background: linear-gradient(90deg, #a855f7, #d946ef);
}

#an-view-vision .goal-text-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 16px;
    z-index: 2;
}

#an-view-vision .goal-text-overlay span:first-child {
    font-size: 16px;
    font-weight: 800;
    color: white;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}

#an-view-vision .goal-text-overlay span:last-child {
    font-size: 11px;
    font-weight: 600;
    color: #d8b4fe;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
}

/* Stats Row */
#an-view-vision .vision-stats-row {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-top: 16px;
}

#an-view-vision .vision-stat-mini {
    background: rgba(0, 0, 0, 0.25);
    border-radius: 10px;
    padding: 12px;
    text-align: center;
}

#an-view-vision .vision-stat-mini-value {
    font-size: 16px;
    font-weight: 700;
    color: var(--vision-text-primary);
    margin-bottom: 2px;
}

#an-view-vision .vision-stat-mini-label {
    font-size: 8px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--vision-text-muted);
}

/* Glass Card */
#an-view-vision .vision-glass-card {
    background: var(--vision-bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--vision-glass-border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
    z-index: 1;
    overflow: hidden;
}

#an-view-vision .vision-glass-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
}

/* Section Label */
#an-view-vision .vision-section-label,
#an-view-vision .lbl-sm {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: var(--vision-text-muted);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Form Elements */
#an-view-vision .vision-form-grid,
#an-view-vision .input-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

#an-view-vision .vision-form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

#an-view-vision .vision-form-label {
    font-size: 10px;
    font-weight: 500;
    color: var(--vision-text-secondary);
    display: flex;
    align-items: center;
    gap: 6px;
}

#an-view-vision .vision-input,
#an-view-vision .modern-input {
    width: 100%;
    padding: 14px 16px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--vision-glass-border);
    border-radius: 12px;
    font-family: 'JetBrains Mono', 'SF Mono', monospace;
    font-size: 14px;
    font-weight: 600;
    color: var(--vision-text-primary);
    transition: all 0.2s;
    outline: none;
}

#an-view-vision .vision-input::placeholder,
#an-view-vision .modern-input::placeholder {
    color: var(--vision-text-muted);
    font-family: inherit;
    font-weight: 400;
}

#an-view-vision .vision-input:focus,
#an-view-vision .modern-input:focus {
    border-color: var(--vision-accent-purple);
    box-shadow: 0 0 0 3px var(--vision-accent-purple-dim);
}

/* Primary Button */
#an-view-vision .vision-btn-primary,
#an-view-vision .btn-main {
    width: 100%;
    padding: 16px 24px;
    background: linear-gradient(135deg, var(--vision-accent-purple), var(--vision-accent-pink)) !important;
    border: none;
    border-radius: 14px;
    font-family: inherit;
    font-size: 13px;
    font-weight: 700;
    color: white;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#an-view-vision .vision-btn-primary:hover,
#an-view-vision .btn-main:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px -10px rgba(168, 85, 247, 0.5);
}

/* Chart Card */
#an-view-vision .vision-chart-card,
#an-view-vision .dash-card {
    background: linear-gradient(145deg, rgba(15, 23, 42, 0.8), rgba(10, 15, 26, 0.9));
    backdrop-filter: blur(20px);
    border: 1px solid var(--vision-glass-border);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
    z-index: 1;
    overflow: hidden;
}

#an-view-vision .vision-chart-card::before,
#an-view-vision .dash-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--vision-accent-pink), var(--vision-accent-orange), transparent);
}

#an-view-vision .vision-chart-header,
#an-view-vision .metric-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    font-size: 12px;
    font-weight: 700;
    color: var(--vision-text-primary);
}

#an-view-vision .vision-chart-legend {
    display: flex;
    gap: 12px;
    font-size: 9px;
    font-weight: 600;
}

#an-view-vision .vision-legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    color: var(--vision-text-secondary);
}

#an-view-vision .vision-legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

#an-view-vision .vision-legend-dot.purple {
    background: linear-gradient(135deg, var(--vision-accent-purple), var(--vision-accent-pink));
    box-shadow: 0 0 8px var(--vision-accent-pink);
}

#an-view-vision .vision-legend-dot.orange {
    background: linear-gradient(135deg, var(--vision-accent-orange), #fb923c);
    box-shadow: 0 0 8px var(--vision-accent-orange);
}

#an-view-vision .vision-chart-container {
    position: relative;
    height: 280px;
    width: 100%;
}

/* Daily Log Section */
#an-view-vision .vision-log-card {
    background: var(--vision-bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--vision-glass-border);
    border-radius: 16px;
    padding: 20px;
    position: relative;
    z-index: 1;
}

#an-view-vision .daily-log-container,
#an-view-vision .vision-log-list {
    max-height: 350px;
    overflow-y: auto;
    padding-right: 8px;
}

#an-view-vision .daily-log-container::-webkit-scrollbar,
#an-view-vision .vision-log-list::-webkit-scrollbar {
    width: 4px;
}

#an-view-vision .daily-log-container::-webkit-scrollbar-track,
#an-view-vision .vision-log-list::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
}

#an-view-vision .daily-log-container::-webkit-scrollbar-thumb,
#an-view-vision .vision-log-list::-webkit-scrollbar-thumb {
    background: var(--vision-text-muted);
    border-radius: 4px;
}

/* Mobile Responsive */
@media (max-width: 480px) {
    #an-view-vision .vision-title { font-size: 20px; }
    #an-view-vision .vision-form-grid,
    #an-view-vision .input-row { grid-template-columns: 1fr; }
    #an-view-vision .vision-stats-row { gap: 6px; }
    #an-view-vision .vision-stat-mini { padding: 10px 8px; }
    #an-view-vision .vision-stat-mini-value { font-size: 14px; }
    #an-view-vision .vision-chart-container { height: 220px; }
}

/* ================================================
   ÇOKLU HEDEF SİSTEMİ STİLLERİ - PREMIUM EDITION
   ================================================ */

/* Premium Tab Bar - LIGHT & ANIMATED */
#an-view-vision .goals-tab-bar {
    display: flex;
    gap: 6px;
    margin-bottom: 18px;
    background: rgba(30, 41, 59, 0.6);
    padding: 5px;
    border-radius: 14px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(12px);
}

#an-view-vision .goals-tab {
    flex: 1;
    padding: 11px 12px;
    background: transparent;
    border: none;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    color: rgba(203, 213, 225, 0.8);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    position: relative;
    overflow: hidden;
}

#an-view-vision .goals-tab i {
    font-size: 12px;
    transition: transform 0.3s ease;
}

#an-view-vision .goals-tab:hover {
    background: rgba(255, 255, 255, 0.08);
    color: #fff;
}

#an-view-vision .goals-tab:hover i {
    transform: scale(1.15);
}

#an-view-vision .goals-tab.active {
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.25));
    color: #fff;
    box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
}

#an-view-vision .goals-tab.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 20%;
    right: 20%;
    height: 2px;
    background: linear-gradient(90deg, #818cf8, #a78bfa);
    border-radius: 2px;
}

#an-view-vision .goals-tab-count {
    background: rgba(139, 92, 246, 0.4);
    padding: 2px 7px;
    border-radius: 8px;
    font-size: 10px;
    font-weight: 700;
}

/* Ana Hedef Özet - LIGHT & PREMIUM */
#an-view-vision .main-goal-summary {
    background: linear-gradient(165deg, 
        rgba(30, 41, 59, 0.7) 0%,
        rgba(30, 27, 75, 0.5) 100%);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 24px;
    padding: 24px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

#an-view-vision .main-goal-summary::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(129, 140, 248, 0.6) 25%,
        rgba(167, 139, 250, 0.6) 50%,
        rgba(129, 140, 248, 0.6) 75%,
        transparent 100%);
    animation: borderGlow 3s ease-in-out infinite;
}

@keyframes borderGlow {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
}

#an-view-vision .main-goal-summary::after {
    content: '';
    position: absolute;
    top: -80px;
    right: -80px;
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, rgba(99, 102, 241, 0.12) 0%, transparent 70%);
    pointer-events: none;
    animation: ambientFloat 6s ease-in-out infinite;
}

@keyframes ambientFloat {
    0%, 100% { transform: translate(0, 0); }
    50% { transform: translate(-20px, 20px); }
}

#an-view-vision .summary-flex {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    position: relative;
    z-index: 1;
}

#an-view-vision .summary-left {
    flex: 1;
}

#an-view-vision .summary-label {
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    color: rgba(167, 139, 250, 0.9);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}

#an-view-vision .summary-label::before {
    content: '';
    width: 6px;
    height: 6px;
    background: linear-gradient(135deg, #818cf8, #a78bfa);
    border-radius: 50%;
    animation: dotPulse 2s ease-in-out infinite;
}

@keyframes dotPulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.7; }
}

#an-view-vision .summary-value {
    font-size: 32px;
    font-weight: 800;
    background: linear-gradient(135deg, #fff 0%, #e0e7ff 50%, #c7d2fe 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1.1;
    letter-spacing: -0.5px;
}

#an-view-vision .summary-sub {
    font-size: 13px;
    color: rgba(203, 213, 225, 0.9);
    margin-top: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
}

#an-view-vision .summary-sub .highlight {
    color: #6ee7b7;
    font-weight: 700;
}

/* Circular Progress - ANIMATED */
#an-view-vision .circular-progress {
    position: relative;
    width: 80px;
    height: 80px;
    flex-shrink: 0;
}

#an-view-vision .circular-progress::before {
    content: '';
    position: absolute;
    inset: -3px;
    border-radius: 50%;
    background: linear-gradient(135deg, rgba(129, 140, 248, 0.3), rgba(167, 139, 250, 0.2));
    filter: blur(6px);
    animation: ringPulse 3s ease-in-out infinite;
}

@keyframes ringPulse {
    0%, 100% { opacity: 0.4; transform: scale(0.97); }
    50% { opacity: 0.8; transform: scale(1.03); }
}

#an-view-vision .circular-progress svg {
    transform: rotate(-90deg);
    width: 80px;
    height: 80px;
    position: relative;
    z-index: 1;
}

#an-view-vision .circular-progress .ring-bg {
    fill: none;
    stroke: rgba(255, 255, 255, 0.1);
    stroke-width: 6;
}

#an-view-vision .circular-progress .ring-fill {
    fill: none;
    stroke: url(#visionRingGradient);
    stroke-width: 6;
    stroke-linecap: round;
    stroke-dasharray: 226;
    stroke-dashoffset: 226;
    transition: stroke-dashoffset 1.2s cubic-bezier(0.4, 0, 0.2, 1);
    filter: drop-shadow(0 0 6px rgba(129, 140, 248, 0.4));
}

#an-view-vision .circular-text {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 2;
}

#an-view-vision .circular-pct {
    font-size: 18px;
    font-weight: 800;
    color: #fff;
}

#an-view-vision .circular-label {
    font-size: 9px;
    color: rgba(203, 213, 225, 0.7);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
}

/* Hedef Stats Mini Grid - LIGHT & ANIMATED */
#an-view-vision .goal-stats-mini {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
    position: relative;
    z-index: 1;
}

#an-view-vision .goal-stat-box {
    background: rgba(30, 41, 59, 0.6);
    border-radius: 14px;
    padding: 14px 8px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

#an-view-vision .goal-stat-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--stat-color, linear-gradient(90deg, #818cf8, #a78bfa));
    opacity: 0;
    transition: opacity 0.3s ease;
}

#an-view-vision .goal-stat-box:nth-child(1) { --stat-color: linear-gradient(90deg, #818cf8, #a78bfa); }
#an-view-vision .goal-stat-box:nth-child(2) { --stat-color: linear-gradient(90deg, #34d399, #6ee7b7); }
#an-view-vision .goal-stat-box:nth-child(3) { --stat-color: linear-gradient(90deg, #fb923c, #fdba74); }
#an-view-vision .goal-stat-box:nth-child(4) { --stat-color: linear-gradient(90deg, #fbbf24, #fcd34d); }

#an-view-vision .goal-stat-box:hover {
    background: rgba(30, 41, 59, 0.8);
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
}

#an-view-vision .goal-stat-box:hover::before {
    opacity: 1;
}

#an-view-vision .goal-stat-icon {
    font-size: 16px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
}

#an-view-vision .goal-stat-num {
    font-size: 18px;
    font-weight: 700;
    color: #fff;
}

#an-view-vision .goal-stat-txt {
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: rgba(203, 213, 225, 0.6);
    margin-top: 4px;
}

/* Hedef Ekleme Butonu - ANIMATED */
#an-view-vision .add-goal-btn {
    width: 100%;
    padding: 16px 20px;
    background: linear-gradient(135deg, 
        rgba(255, 255, 255, 0.08) 0%,
        rgba(255, 255, 255, 0.04) 100%);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 16px;
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.3px;
    color: rgba(255, 255, 255, 0.85);
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

#an-view-vision .add-goal-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, 
        rgba(99, 102, 241, 0.15) 0%,
        rgba(139, 92, 246, 0.1) 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

#an-view-vision .add-goal-btn:hover {
    border-color: rgba(139, 92, 246, 0.4);
    color: #fff;
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2);
}

#an-view-vision .add-goal-btn:hover::before {
    opacity: 1;
}

#an-view-vision .add-goal-btn:active {
    transform: translateY(-1px);
}

#an-view-vision .add-goal-btn i {
    font-size: 18px;
    color: rgba(167, 139, 250, 0.9);
    transition: all 0.4s ease;
    position: relative;
    z-index: 1;
}

#an-view-vision .add-goal-btn:hover i {
    color: #c7d2fe;
    transform: rotate(90deg) scale(1.15);
}

/* Hedef Kartı - LIGHT & ANIMATED */
#an-view-vision .goal-item-card {
    background: rgba(30, 41, 59, 0.65);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 18px;
    padding: 18px;
    margin-bottom: 14px;
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

#an-view-vision .goal-item-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 4px;
    height: 100%;
    border-radius: 18px 0 0 18px;
    transition: all 0.3s ease;
}

#an-view-vision .goal-item-card:hover {
    background: rgba(30, 41, 59, 0.8);
    border-color: rgba(255, 255, 255, 0.18);
    transform: translateY(-4px);
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.25);
}

#an-view-vision .goal-item-card:hover::before {
    width: 5px;
    box-shadow: 0 0 15px var(--card-glow, rgba(129, 140, 248, 0.4));
}

/* Category Colors */
#an-view-vision .goal-item-card.cat-savings::before { background: linear-gradient(180deg, #10b981, #34d399); --card-glow: rgba(16, 185, 129, 0.4); }
#an-view-vision .goal-item-card.cat-investment::before { background: linear-gradient(180deg, #8b5cf6, #a78bfa); --card-glow: rgba(139, 92, 246, 0.4); }
#an-view-vision .goal-item-card.cat-travel::before { background: linear-gradient(180deg, #3b82f6, #60a5fa); --card-glow: rgba(59, 130, 246, 0.4); }
#an-view-vision .goal-item-card.cat-tech::before { background: linear-gradient(180deg, #f97316, #fb923c); --card-glow: rgba(249, 115, 22, 0.4); }
#an-view-vision .goal-item-card.cat-property::before { background: linear-gradient(180deg, #ec4899, #f472b6); --card-glow: rgba(236, 72, 153, 0.4); }
#an-view-vision .goal-item-card.cat-education::before { background: linear-gradient(180deg, #8b5cf6, #a78bfa); --card-glow: rgba(139, 92, 246, 0.4); }
#an-view-vision .goal-item-card.cat-car::before { background: linear-gradient(180deg, #06b6d4, #22d3ee); --card-glow: rgba(6, 182, 212, 0.4); }
#an-view-vision .goal-item-card.cat-emergency::before { background: linear-gradient(180deg, #ef4444, #f87171); --card-glow: rgba(239, 68, 68, 0.4); }
#an-view-vision .goal-item-card.cat-luxury::before { background: linear-gradient(180deg, #f59e0b, #fbbf24); --card-glow: rgba(245, 158, 11, 0.4); }

#an-view-vision .goal-item-card.completed {
    background: rgba(16, 185, 129, 0.12);
    border-color: rgba(16, 185, 129, 0.25);
}

#an-view-vision .goal-item-card.completed::before {
    animation: completedGlow 2s ease-in-out infinite;
}

@keyframes completedGlow {
    0%, 100% { box-shadow: 0 0 8px rgba(16, 185, 129, 0.4); }
    50% { box-shadow: 0 0 18px rgba(16, 185, 129, 0.7); }
}

#an-view-vision .goal-card-top {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    margin-bottom: 14px;
}

#an-view-vision .goal-emoji {
    width: 48px;
    height: 48px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    flex-shrink: 0;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.3s ease;
}

#an-view-vision .goal-item-card:hover .goal-emoji {
    transform: scale(1.08) rotate(-3deg);
}

#an-view-vision .goal-details {
    flex: 1;
    min-width: 0;
}

#an-view-vision .goal-name {
    font-size: 15px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

#an-view-vision .goal-priority {
    font-size: 9px;
    padding: 3px 8px;
    border-radius: 6px;
    font-weight: 700;
    text-transform: uppercase;
}

#an-view-vision .goal-priority.high { 
    background: rgba(239, 68, 68, 0.2); 
    color: #fca5a5; 
}
#an-view-vision .goal-priority.medium { 
    background: rgba(251, 191, 36, 0.2); 
    color: #fcd34d; 
}
#an-view-vision .goal-priority.low { 
    background: rgba(107, 114, 128, 0.2); 
    color: #d1d5db; 
}

#an-view-vision .goal-target-info {
    font-size: 12px;
    color: rgba(203, 213, 225, 0.9);
}

#an-view-vision .goal-target-info .amount {
    color: #c7d2fe;
    font-weight: 600;
}

#an-view-vision .goal-actions {
    display: flex;
    gap: 6px;
}

#an-view-vision .goal-action {
    width: 32px;
    height: 32px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    background: rgba(255, 255, 255, 0.06);
    color: rgba(203, 213, 225, 0.7);
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

#an-view-vision .goal-action:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: rgba(139, 92, 246, 0.4);
    color: #c7d2fe;
    transform: translateY(-2px);
}

#an-view-vision .goal-action.delete:hover {
    background: rgba(239, 68, 68, 0.2);
    border-color: rgba(239, 68, 68, 0.4);
    color: #fca5a5;
}

/* Progress Bar - ANIMATED */
#an-view-vision .goal-progress {
    margin-bottom: 12px;
}

#an-view-vision .goal-bar-track {
    height: 8px;
    background: rgba(0, 0, 0, 0.25);
    border-radius: 8px;
    overflow: hidden;
}

#an-view-vision .goal-bar-fill {
    height: 100%;
    border-radius: 8px;
    transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

#an-view-vision .goal-bar-fill::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 50%;
    background: linear-gradient(180deg, rgba(255, 255, 255, 0.25), transparent);
    border-radius: 8px 8px 0 0;
}

#an-view-vision .goal-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer 2.5s ease-in-out infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 200%; }
}

#an-view-vision .goal-bar-fill.gf-red { background: linear-gradient(90deg, #ef4444, #f97316); }
#an-view-vision .goal-bar-fill.gf-orange { background: linear-gradient(90deg, #f97316, #fbbf24); }
#an-view-vision .goal-bar-fill.gf-yellow { background: linear-gradient(90deg, #fbbf24, #84cc16); }
#an-view-vision .goal-bar-fill.gf-green { background: linear-gradient(90deg, #22c55e, #10b981); }
#an-view-vision .goal-bar-fill.gf-complete { 
    background: linear-gradient(90deg, #8b5cf6, #a78bfa, #c4b5fd); 
    box-shadow: 0 0 12px rgba(139, 92, 246, 0.4);
}

#an-view-vision .goal-bar-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 8px;
    align-items: center;
}

#an-view-vision .goal-current {
    font-size: 13px;
    font-weight: 700;
    color: #fff;
}

#an-view-vision .goal-pct {
    font-size: 12px;
    font-weight: 600;
    color: rgba(203, 213, 225, 0.8);
}

/* Milestones - ANIMATED */
#an-view-vision .goal-milestones {
    display: flex;
    justify-content: space-between;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    position: relative;
}

#an-view-vision .goal-milestones::before {
    content: '';
    position: absolute;
    top: 26px;
    left: 28px;
    right: 28px;
    height: 2px;
    background: linear-gradient(90deg, rgba(139, 92, 246, 0.2), rgba(251, 191, 36, 0.2), rgba(16, 185, 129, 0.2));
    border-radius: 2px;
    z-index: 0;
}

#an-view-vision .milestone {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    position: relative;
    z-index: 1;
}

#an-view-vision .milestone-icon {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    background: rgba(30, 41, 59, 0.8);
    color: rgba(203, 213, 225, 0.5);
    border: 2px solid rgba(255, 255, 255, 0.12);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

#an-view-vision .milestone.reached .milestone-icon {
    background: linear-gradient(135deg, #8b5cf6, #a78bfa);
    color: #fff;
    border-color: transparent;
    box-shadow: 0 0 15px rgba(139, 92, 246, 0.4);
    transform: scale(1.1);
}

#an-view-vision .milestone.current .milestone-icon {
    background: rgba(251, 191, 36, 0.2);
    color: #fbbf24;
    border-color: rgba(251, 191, 36, 0.6);
    animation: currentPulse 2s ease-in-out infinite;
}

@keyframes currentPulse {
    0%, 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4); }
    50% { box-shadow: 0 0 0 8px rgba(251, 191, 36, 0); }
}

#an-view-vision .milestone-label {
    font-size: 9px;
    font-weight: 600;
    color: rgba(203, 213, 225, 0.5);
}

#an-view-vision .milestone.reached .milestone-label {
    color: #c7d2fe;
}

#an-view-vision .milestone.current .milestone-label {
    color: #fbbf24;
}

/* Tahmin - CLEAN */
#an-view-vision .goal-estimate {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: rgba(139, 92, 246, 0.08);
    border-radius: 10px;
    margin-top: 12px;
}

#an-view-vision .goal-estimate i {
    color: #a78bfa;
    font-size: 13px;
}

#an-view-vision .goal-estimate-text {
    font-size: 11px;
    color: rgba(148, 163, 184, 0.9);
}

#an-view-vision .goal-estimate-text strong {
    color: #c4b5fd;
}

/* Tamamlandı Badge - CLEAN */
#an-view-vision .completed-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 9px;
    padding: 4px 10px;
    background: rgba(16, 185, 129, 0.15);
    color: #6ee7b7;
    border-radius: 6px;
    font-weight: 700;
    margin-left: auto;
    text-transform: uppercase;
}

/* Başarımlar - ANIMATED */
#an-view-vision .achievements-card {
    background: rgba(30, 41, 59, 0.65);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 18px;
    padding: 18px;
    margin-bottom: 18px;
    position: relative;
    overflow: hidden;
}

#an-view-vision .achievements-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(251, 191, 36, 0.5), transparent);
}

#an-view-vision .achievements-title {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: rgba(251, 191, 36, 0.9);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

#an-view-vision .achievements-title i {
    color: #fbbf24;
    font-size: 14px;
}

#an-view-vision .achievements-row {
    display: flex;
    gap: 12px;
    overflow-x: auto;
    padding-bottom: 6px;
}

#an-view-vision .achievements-row::-webkit-scrollbar { 
    height: 3px;
}

#an-view-vision .achievements-row::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
}

#an-view-vision .achievements-row::-webkit-scrollbar-thumb {
    background: rgba(251, 191, 36, 0.5);
    border-radius: 3px;
}

#an-view-vision .achievement {
    flex-shrink: 0;
    width: 64px;
    text-align: center;
    transition: transform 0.3s ease;
}

#an-view-vision .achievement:hover {
    transform: translateY(-3px);
}

#an-view-vision .achievement-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(30, 41, 59, 0.8);
    border: 2px solid rgba(255, 255, 255, 0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    color: rgba(203, 213, 225, 0.4);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

#an-view-vision .achievement.unlocked .achievement-icon {
    background: linear-gradient(135deg, #fbbf24, #f59e0b);
    border-color: transparent;
    color: #fff;
    box-shadow: 0 4px 20px rgba(251, 191, 36, 0.4);
    animation: unlockBounce 0.5s ease-out;
}

@keyframes unlockBounce {
    0% { transform: scale(0.8); }
    50% { transform: scale(1.15); }
    100% { transform: scale(1); }
}

#an-view-vision .achievement-label {
    font-size: 9px;
    font-weight: 600;
    color: rgba(203, 213, 225, 0.6);
}

#an-view-vision .achievement.unlocked .achievement-label {
    color: #fcd34d;
}

/* Modal */
#an-view-vision .goal-modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    z-index: 100000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
}

#an-view-vision .goal-modal-overlay.show {
    display: flex;
}

#an-view-vision .goal-modal {
    width: 100%;
    max-width: 400px;
    max-height: 80vh;
    background: linear-gradient(145deg, #0f172a, #0a0f1a);
    border: 1px solid rgba(168, 85, 247, 0.2);
    border-radius: 20px;
    overflow: hidden;
    animation: goalModalIn 0.3s ease-out;
}

@keyframes goalModalIn {
    from { opacity: 0; transform: translateY(20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
}

#an-view-vision .goal-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 16px 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), transparent);
}

#an-view-vision .goal-modal-title {
    font-size: 15px;
    font-weight: 700;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
}

#an-view-vision .goal-modal-title i {
    color: #a855f7;
}

#an-view-vision .goal-modal-close {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: none;
    background: rgba(255, 255, 255, 0.05);
    color: var(--vision-text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
}

#an-view-vision .goal-modal-close:hover {
    background: rgba(239, 68, 68, 0.2);
    color: #f87171;
}

#an-view-vision .goal-modal-body {
    padding: 20px;
    overflow-y: auto;
    max-height: calc(80vh - 120px);
}

#an-view-vision .goal-form-group {
    margin-bottom: 16px;
}

#an-view-vision .goal-form-label {
    display: block;
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--vision-text-muted);
    margin-bottom: 6px;
}

#an-view-vision .goal-form-input {
    width: 100%;
    padding: 12px 14px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 10px;
    font-family: inherit;
    font-size: 13px;
    color: #fff;
    transition: all 0.2s;
    outline: none;
}

#an-view-vision .goal-form-input::placeholder {
    color: var(--vision-text-muted);
}

#an-view-vision .goal-form-input:focus {
    border-color: #a855f7;
    box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.15);
}

#an-view-vision .goal-form-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
}

/* Emoji Picker */
#an-view-vision .emoji-grid {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

#an-view-vision .emoji-opt {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.08);
    background: rgba(0, 0, 0, 0.2);
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}

#an-view-vision .emoji-opt:hover {
    border-color: rgba(168, 85, 247, 0.4);
    transform: scale(1.08);
}

#an-view-vision .emoji-opt.selected {
    border-color: #a855f7;
    background: rgba(168, 85, 247, 0.2);
    box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
}

/* Kategori Picker */
#an-view-vision .cat-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
}

#an-view-vision .cat-opt {
    padding: 10px 6px;
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.08);
    background: rgba(0, 0, 0, 0.2);
    font-size: 10px;
    font-weight: 600;
    color: var(--vision-text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}

#an-view-vision .cat-opt:hover {
    border-color: rgba(168, 85, 247, 0.3);
}

#an-view-vision .cat-opt.selected {
    border-color: #a855f7;
    background: rgba(168, 85, 247, 0.15);
    color: #d8b4fe;
}

#an-view-vision .cat-opt i {
    display: block;
    font-size: 16px;
    margin-bottom: 4px;
}

/* Öncelik Picker */
#an-view-vision .priority-row {
    display: flex;
    gap: 6px;
}

#an-view-vision .priority-opt {
    flex: 1;
    padding: 10px;
    border-radius: 10px;
    border: 2px solid rgba(255, 255, 255, 0.08);
    background: rgba(0, 0, 0, 0.2);
    font-size: 10px;
    font-weight: 600;
    color: var(--vision-text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}

#an-view-vision .priority-opt.high.selected {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.15);
    color: #f87171;
}

#an-view-vision .priority-opt.medium.selected {
    border-color: #fbbf24;
    background: rgba(251, 191, 36, 0.15);
    color: #fcd34d;
}

#an-view-vision .priority-opt.low.selected {
    border-color: #6b7280;
    background: rgba(107, 114, 128, 0.15);
    color: #9ca3af;
}

/* Kaydet Butonu */
#an-view-vision .goal-save-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, #a855f7, #d946ef);
    border: none;
    border-radius: 12px;
    font-family: inherit;
    font-size: 13px;
    font-weight: 700;
    color: #fff;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 8px;
}

#an-view-vision .goal-save-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px -8px rgba(168, 85, 247, 0.5);
}

#an-view-vision .goal-save-btn.green {
    background: linear-gradient(135deg, #10b981, #34d399);
}

/* Konfeti */
@keyframes confettiFall {
    0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

.goal-confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    top: 0;
    z-index: 100001;
    pointer-events: none;
    animation: confettiFall 3s linear forwards;
}

/* Boş State - LIGHT */
#an-view-vision .goals-empty {
    text-align: center;
    padding: 40px 24px;
    color: rgba(203, 213, 225, 0.6);
}

#an-view-vision .goals-empty i {
    font-size: 48px;
    opacity: 0.4;
    margin-bottom: 14px;
    display: block;
    color: rgba(167, 139, 250, 0.6);
    animation: emptyFloat 3s ease-in-out infinite;
}

@keyframes emptyFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-8px); }
}

#an-view-vision .goals-empty-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 6px;
    color: rgba(255, 255, 255, 0.75);
}

#an-view-vision .goals-empty-sub {
    font-size: 12px;
    color: rgba(203, 213, 225, 0.6);
    max-width: 220px;
    margin: 0 auto;
    line-height: 1.5;
}

/* Section Divider */
#an-view-vision .section-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 20px 0 16px;
}

#an-view-vision .section-divider-line {
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(168, 85, 247, 0.3), transparent);
}

#an-view-vision .section-divider-text {
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--vision-text-muted);
}

@media (max-width: 380px) {
    #an-view-vision .goal-stats-mini { grid-template-columns: repeat(2, 1fr); gap: 8px; }
    #an-view-vision .goal-form-row { grid-template-columns: 1fr; }
    #an-view-vision .cat-grid { grid-template-columns: repeat(2, 1fr); }
    #an-view-vision .goal-item-card { padding: 16px; }
    #an-view-vision .goal-emoji { width: 44px; height: 44px; }
    #an-view-vision .summary-value { font-size: 28px; }
    #an-view-vision .circular-progress { width: 76px; height: 76px; }
    #an-view-vision .circular-progress svg { width: 76px; height: 76px; }
    #an-view-vision .milestone-icon { width: 28px; height: 28px; }
}

/* Chart Period Buttons - PREMIUM */
#an-view-vision .chart-period-btn {
    padding: 8px 14px;
    background: linear-gradient(145deg, rgba(30, 35, 50, 0.8), rgba(20, 25, 40, 0.9));
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    color: rgba(148, 163, 184, 0.8);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

#an-view-vision .chart-period-btn:hover {
    background: linear-gradient(145deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.08));
    border-color: rgba(168, 85, 247, 0.3);
    color: #d8b4fe;
    transform: translateY(-2px);
}

#an-view-vision .chart-period-btn.active {
    background: linear-gradient(135deg, rgba(168, 85, 247, 0.25), rgba(217, 70, 239, 0.2));
    border-color: rgba(168, 85, 247, 0.4);
    color: #e9d5ff;
    box-shadow: 0 0 15px rgba(168, 85, 247, 0.2);
}

/* Milestone icons with FA - PREMIUM */
#an-view-vision .milestone-icon i {
    font-size: 12px;
    transition: all 0.3s ease;
}

#an-view-vision .milestone.reached .milestone-icon i {
    color: #fff;
    filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.5));
}

#an-view-vision .milestone.current .milestone-icon i {
    color: #fbbf24;
    animation: iconBounce 1s ease-in-out infinite;
}

@keyframes iconBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-2px); }
}

/* Vision Log Card - LIGHT & ANIMATED */
#an-view-vision .vision-log-card {
    background: rgba(30, 41, 59, 0.65);
    backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 18px;
    padding: 18px;
    margin-bottom: 18px;
    position: relative;
    overflow: hidden;
}

#an-view-vision .vision-log-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.5), transparent);
}

/* Premium Portföy Info Card - LIGHT */
#an-view-vision .portfolio-info-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 18px;
    background: rgba(59, 130, 246, 0.12);
    border: 1px solid rgba(59, 130, 246, 0.2);
    border-radius: 14px;
    margin-top: 18px;
    margin-bottom: 18px;
    position: relative;
    overflow: hidden;
}

#an-view-vision .portfolio-info-card::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 3px;
    background: linear-gradient(180deg, #3b82f6, #60a5fa);
}

/* Premium Allocation Card - LIGHT */
#an-view-vision .allocation-card {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.15);
    border-radius: 14px;
    padding: 14px;
    margin-bottom: 18px;
}

#an-view-vision .allocation-bar-track {
    height: 6px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 6px;
    margin-top: 12px;
    overflow: hidden;
}

#an-view-vision .allocation-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #60a5fa);
    border-radius: 6px;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}

#an-view-vision .allocation-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer 2s ease-in-out infinite;
}

/* Section Divider Premium */
</style>

<div id="an-view-vision" class="an-view-section vision-fullscreen-mode" style="display:none;">
    
    <!-- Ambient Background - PREMIUM -->
    <div class="vision-ambient-bg">
        <div class="vision-ambient-orb vision-orb-1"></div>
        <div class="vision-ambient-orb vision-orb-2"></div>
        <div class="vision-ambient-orb vision-orb-3"></div>
        <div class="vision-ambient-orb vision-orb-4"></div>
        <div class="vision-stars" id="visionStars"></div>
    </div>

    <!-- Top Navigation Bar -->
    <div class="vision-topbar">
        <button class="vision-back-btn" onclick="closeVisionView()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="vision-topbar-title">
            <span class="vision-topbar-brand">TradeVia</span>
            <span class="vision-topbar-beta">BETA</span>
        </div>
        <div style="width: 40px;"></div>
    </div>

    <!-- Scrollable Content -->
    <div class="vision-content">

        <!-- SVG Gradient -->
        <svg width="0" height="0" style="position:absolute;">
            <defs>
                <linearGradient id="visionRingGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" stop-color="#a855f7"/>
                    <stop offset="50%" stop-color="#d946ef"/>
                    <stop offset="100%" stop-color="#f97316"/>
                </linearGradient>
            </defs>
        </svg>

        <!-- Header -->
        <div class="vision-header">
            <div class="vision-badge"><i class="fas fa-rocket"></i> HEDEFLERİM</div>
            <h1 class="vision-title">Finansal Vizyon</h1>
            <p class="vision-subtitle">Geleceğini bugünden planla</p>
        </div>

        <!-- Tab Sistemi -->
        <div class="goals-tab-bar">
            <button class="goals-tab active" onclick="switchGoalsTab('summary', this)">
                <i class="fas fa-chart-pie"></i> ÖZET
            </button>
            <button class="goals-tab" onclick="switchGoalsTab('goals', this)">
                <i class="fas fa-bullseye"></i> HEDEFLER <span class="goals-tab-count" id="goalsTabCount">0</span>
            </button>
            <button class="goals-tab" onclick="switchGoalsTab('simulation', this)">
                <i class="fas fa-flask"></i> SİMÜLASYON
            </button>
        </div>

        <!-- ========== ÖZET TAB ========== -->
        <div id="goalsTabSummary" class="goals-tab-content">
            
            <!-- Toplam Hedef Özeti - YENİ TASARIM -->
            <div class="main-goal-summary">
                <div class="summary-flex">
                    <div class="summary-left">
                        <div class="summary-label">TOPLAM HEDEF DEĞERİ</div>
                        <div class="summary-value" id="multiGoalTotal">₺0</div>
                        <div class="summary-sub">Biriktirilen: <span class="highlight" id="multiGoalSaved">₺0</span></div>
                    </div>
                    <div class="circular-progress">
                        <svg viewBox="0 0 72 72">
                            <circle class="ring-bg" cx="36" cy="36" r="32"/>
                            <circle class="ring-fill" id="multiGoalRing" cx="36" cy="36" r="32"/>
                        </svg>
                        <div class="circular-text">
                            <div class="circular-pct" id="multiGoalPct">0%</div>
                            <div class="circular-label">İlerleme</div>
                        </div>
                    </div>
                </div>
                
                <!-- Portföy Bilgisi - PREMIUM -->
                <div class="portfolio-info-card">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="width:44px; height:44px; border-radius:12px; background:linear-gradient(135deg, rgba(59,130,246,0.2), rgba(59,130,246,0.1)); display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(59,130,246,0.2);">
                            <i class="fas fa-wallet" style="color:#60a5fa; font-size:18px; filter:drop-shadow(0 0 8px rgba(96,165,250,0.5));"></i>
                        </div>
                        <div>
                            <div style="font-size:9px; color:rgba(148,163,184,0.7); text-transform:uppercase; letter-spacing:1px; font-weight:700;">Toplam Portföy</div>
                            <div style="font-size:20px; font-weight:800; color:#fff; text-shadow:0 2px 10px rgba(0,0,0,0.3);" id="portfolioTotalDisplay">₺0</div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:9px; color:rgba(148,163,184,0.7); text-transform:uppercase; letter-spacing:0.5px; font-weight:600;">Kalan Hedef</div>
                        <div style="font-size:18px; font-weight:700; color:#fca5a5; text-shadow:0 0 15px rgba(239,68,68,0.3);" id="remainingTargetDisplay">₺0</div>
                    </div>
                </div>
                
                <div class="goal-stats-mini">
                    <div class="goal-stat-box">
                        <div class="goal-stat-icon"><i class="fas fa-bullseye" style="color:#a855f7;"></i></div>
                        <div class="goal-stat-num" id="statGoalCount">0</div>
                        <div class="goal-stat-txt">Hedef</div>
                    </div>
                    <div class="goal-stat-box">
                        <div class="goal-stat-icon"><i class="fas fa-check-circle" style="color:#10b981;"></i></div>
                        <div class="goal-stat-num" id="statCompleteCount">0</div>
                        <div class="goal-stat-txt">Tamamlandı</div>
                    </div>
                    <div class="goal-stat-box">
                        <div class="goal-stat-icon"><i class="fas fa-fire" style="color:#f97316;"></i></div>
                        <div class="goal-stat-num" id="statStreakCount">0</div>
                        <div class="goal-stat-txt">Seri Gün</div>
                    </div>
                    <div class="goal-stat-box">
                        <div class="goal-stat-icon"><i class="fas fa-hourglass-half" style="color:#fbbf24;"></i></div>
                        <div class="goal-stat-num" id="statAvgMonth">--</div>
                        <div class="goal-stat-txt">Ort. Ay</div>
                    </div>
                </div>
            </div>

            <!-- Başarımlar -->
            <div class="achievements-card">
                <div class="achievements-title"><i class="fas fa-medal"></i> BAŞARIMLAR</div>
                <div class="achievements-row" id="achievementsList">
                    <div class="achievement" data-ach="first-goal">
                        <div class="achievement-icon"><i class="fas fa-flag" style="font-size:18px;"></i></div>
                        <div class="achievement-label">İlk Hedef</div>
                    </div>
                    <div class="achievement" data-ach="first-100k">
                        <div class="achievement-icon"><i class="fas fa-gem" style="font-size:18px;"></i></div>
                        <div class="achievement-label">₺100K</div>
                    </div>
                    <div class="achievement" data-ach="goal-complete">
                        <div class="achievement-icon"><i class="fas fa-trophy" style="font-size:18px;"></i></div>
                        <div class="achievement-label">Tamamlayıcı</div>
                    </div>
                    <div class="achievement" data-ach="streak-7">
                        <div class="achievement-icon"><i class="fas fa-fire-alt" style="font-size:18px;"></i></div>
                        <div class="achievement-label">7 Gün</div>
                    </div>
                    <div class="achievement" data-ach="multi-goal">
                        <div class="achievement-icon"><i class="fas fa-layer-group" style="font-size:18px;"></i></div>
                        <div class="achievement-label">5 Hedef</div>
                    </div>
                    <div class="achievement" data-ach="millionaire">
                        <div class="achievement-icon"><i class="fas fa-crown" style="font-size:18px;"></i></div>
                        <div class="achievement-label">Milyoner</div>
                    </div>
                </div>
            </div>


            <!-- Günlük Kazanç Raporu - ULTRA PREMIUM -->
            <div class="vision-log-card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg, rgba(168,85,247,0.2), rgba(168,85,247,0.1)); display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-history" style="color:#a855f7; font-size:14px; filter:drop-shadow(0 0 6px rgba(168,85,247,0.5));"></i>
                        </div>
                        <div class="lbl-sm" style="margin:0; font-size:10px; letter-spacing:1.5px;">GÜNLÜK KAZANÇ RAPORU</div>
                    </div>
                    <div style="font-size:10px; color:rgba(148,163,184,0.6); background:rgba(0,0,0,0.2); padding:4px 10px; border-radius:8px; font-weight:600;" id="logEntryCount">0 kayıt</div>
                </div>
                
                <!-- Özet Kartları - PREMIUM -->
                <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-bottom:16px;">
                    <div style="background:linear-gradient(145deg, rgba(16,185,129,0.12), rgba(16,185,129,0.06)); border:1px solid rgba(16,185,129,0.2); padding:14px; border-radius:14px; position:relative; overflow:hidden;">
                        <div style="position:absolute; top:0; left:0; width:3px; height:100%; background:linear-gradient(180deg,#10b981,#34d399); border-radius:3px 0 0 3px;"></div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="width:32px; height:32px; border-radius:8px; background:rgba(16,185,129,0.15); display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-arrow-up" style="color:#34d399; font-size:12px;"></i>
                            </div>
                            <div>
                                <div style="font-size:8px; color:rgba(148,163,184,0.7); text-transform:uppercase; letter-spacing:0.8px; font-weight:700;">EN İYİ GÜN</div>
                                <div style="font-size:14px; font-weight:800; color:#6ee7b7; text-shadow:0 0 15px rgba(52,211,153,0.4);" id="logBestDay">+₺0</div>
                            </div>
                        </div>
                    </div>
                    <div style="background:linear-gradient(145deg, rgba(239,68,68,0.12), rgba(239,68,68,0.06)); border:1px solid rgba(239,68,68,0.2); padding:14px; border-radius:14px; position:relative; overflow:hidden;">
                        <div style="position:absolute; top:0; left:0; width:3px; height:100%; background:linear-gradient(180deg,#ef4444,#f87171); border-radius:3px 0 0 3px;"></div>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="width:32px; height:32px; border-radius:8px; background:rgba(239,68,68,0.15); display:flex; align-items:center; justify-content:center;">
                                <i class="fas fa-arrow-down" style="color:#f87171; font-size:12px;"></i>
                            </div>
                            <div>
                                <div style="font-size:8px; color:rgba(148,163,184,0.7); text-transform:uppercase; letter-spacing:0.8px; font-weight:700;">EN KÖTÜ GÜN</div>
                                <div style="font-size:14px; font-weight:800; color:#fca5a5; text-shadow:0 0 15px rgba(248,113,113,0.4);" id="logWorstDay">₺0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="dailyLogList" class="daily-log-container">
                    <div style="text-align:center; padding:20px; color:var(--vision-text-secondary);">Veriler yükleniyor...</div>
                </div>
            </div>

        </div>

        <!-- ========== HEDEFLER TAB ========== -->
        <div id="goalsTabGoals" class="goals-tab-content" style="display:none;">
            
            <!-- Allocation Özeti - PREMIUM -->
            <div class="allocation-card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg, rgba(59,130,246,0.2), rgba(59,130,246,0.1)); display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-chart-pie" style="color:#60a5fa; font-size:14px; filter:drop-shadow(0 0 6px rgba(96,165,250,0.5));"></i>
                        </div>
                        <span style="font-size:12px; color:rgba(148,163,184,0.9); font-weight:600;">Portföy Dağılımı</span>
                    </div>
                    <div style="display:flex; align-items:baseline; gap:4px;">
                        <span style="font-size:18px; font-weight:800; background:linear-gradient(135deg,#60a5fa,#3b82f6); -webkit-background-clip:text; -webkit-text-fill-color:transparent;" id="totalAllocationDisplay">%0</span>
                        <span style="font-size:11px; color:rgba(148,163,184,0.6); font-weight:600;"> / %100</span>
                    </div>
                </div>
                <div class="allocation-bar-track">
                    <div class="allocation-bar-fill" id="allocationBar" style="width:0%;"></div>
                </div>
            </div>
            
            <!-- Hedef Ekle Butonu -->
            <button class="add-goal-btn" onclick="openGoalModal()">
                <i class="fas fa-plus-circle"></i>
                YENİ HEDEF EKLE
            </button>

            <!-- Hedefler Listesi -->
            <div id="multiGoalsList">
                <!-- Dinamik içerik -->
            </div>

        </div>

        <!-- ========== SİMÜLASYON TAB ========== -->
        <div id="goalsTabSimulation" class="goals-tab-content" style="display:none;">
            
            <!-- Simülasyon Ayarları -->
            <div class="vision-glass-card">
                <div class="lbl-sm">SİMÜLASYON AYARLARI</div>

                <div class="input-row">
                    <div class="vision-form-group">
                        <span class="vision-form-label"><i class="fas fa-percent"></i> Aylık Kâr Beklentisi (%)</span>
                        <input type="number" id="visionRate" class="modern-input" value="5" placeholder="Örn: 5">
                    </div>
                    <div class="vision-form-group">
                        <span class="vision-form-label"><i class="fas fa-plus-circle"></i> Aylık Ek Yatırım</span>
                        <input type="number" id="visionAdd" class="modern-input" value="1000" placeholder="Örn: 1000">
                    </div>
                </div>

                <button class="btn-main" style="margin-top:10px;" onclick="manualUpdateVision()">
                    <i class="fas fa-calculator"></i> SİMÜLASYONU GÜNCELLE
                </button>
            </div>

            <!-- Simülasyon Grafiği -->
            <div class="dash-card full-width" style="padding-bottom: 10px;">
                <div class="metric-title">
                    <i class="fas fa-crystal-ball" style="color: var(--vision-accent-purple); margin-right: 8px;"></i>
                    GELECEK TAHMİNİ (24 AY)
                </div>
                <div class="vision-chart-container">
                    <canvas id="visionSimChart"></canvas>
                </div>
            </div>

            <!-- Senaryo Kartları -->
            <div class="lbl-sm" style="margin-top:16px;"><i class="fas fa-lightbulb" style="color:#fbbf24; margin-right:8px;"></i>SENARYO ANALİZİ</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="vision-stat-mini" style="background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.2);">
                    <div class="vision-stat-mini-value" id="simBestCase" style="color:#34d399;">--</div>
                    <div class="vision-stat-mini-label">İyi Senaryo (+2%)</div>
                </div>
                <div class="vision-stat-mini" style="background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.2);">
                    <div class="vision-stat-mini-value" id="simWorstCase" style="color:#f87171;">--</div>
                    <div class="vision-stat-mini-label">Kötü Senaryo (-2%)</div>
                </div>
            </div>

        </div>

    </div> <!-- vision-content kapanışı -->

    <!-- ========== HEDEF EKLEME MODALI ========== -->
    <div class="goal-modal-overlay" id="goalModalOverlay" onclick="closeGoalModal(event)">
        <div class="goal-modal" onclick="event.stopPropagation()">
            <div class="goal-modal-header">
                <div class="goal-modal-title">
                    <i class="fas fa-bullseye"></i>
                    <span id="goalModalTitle">Yeni Hedef</span>
                </div>
                <button class="goal-modal-close" onclick="closeGoalModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="goal-modal-body">
                <input type="hidden" id="editingGoalId" value="">
                
                <div class="goal-form-group">
                    <label class="goal-form-label">Hedef Adı</label>
                    <input type="text" class="goal-form-input" id="goalNameInput" placeholder="Örn: Yeni Araba">
                </div>
                
                <div class="goal-form-group">
                    <label class="goal-form-label">İkon Seç</label>
                    <div class="emoji-grid" id="emojiPicker">
                        <div class="emoji-opt selected" data-emoji="fa-bullseye" data-color="#a855f7"><i class="fas fa-bullseye" style="color:#a855f7;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-home" data-color="#ec4899"><i class="fas fa-home" style="color:#ec4899;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-car" data-color="#06b6d4"><i class="fas fa-car" style="color:#06b6d4;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-plane" data-color="#3b82f6"><i class="fas fa-plane" style="color:#3b82f6;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-laptop" data-color="#f97316"><i class="fas fa-laptop" style="color:#f97316;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-graduation-cap" data-color="#8b5cf6"><i class="fas fa-graduation-cap" style="color:#8b5cf6;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-piggy-bank" data-color="#10b981"><i class="fas fa-piggy-bank" style="color:#10b981;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-shield-alt" data-color="#ef4444"><i class="fas fa-shield-alt" style="color:#ef4444;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-gem" data-color="#fbbf24"><i class="fas fa-gem" style="color:#fbbf24;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-gift" data-color="#f472b6"><i class="fas fa-gift" style="color:#f472b6;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-mobile-alt" data-color="#60a5fa"><i class="fas fa-mobile-alt" style="color:#60a5fa;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-heart" data-color="#fb7185"><i class="fas fa-heart" style="color:#fb7185;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-chart-line" data-color="#34d399"><i class="fas fa-chart-line" style="color:#34d399;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-wallet" data-color="#a78bfa"><i class="fas fa-wallet" style="color:#a78bfa;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-baby" data-color="#fcd34d"><i class="fas fa-baby" style="color:#fcd34d;"></i></div>
                        <div class="emoji-opt" data-emoji="fa-ring" data-color="#f9a8d4"><i class="fas fa-ring" style="color:#f9a8d4;"></i></div>
                    </div>
                </div>
                
                <div class="goal-form-group">
                    <label class="goal-form-label">Kategori</label>
                    <div class="cat-grid" id="catPicker">
                        <div class="cat-opt selected" data-cat="savings"><i class="fas fa-piggy-bank" style="color:#10b981;"></i>Birikim</div>
                        <div class="cat-opt" data-cat="investment"><i class="fas fa-chart-line" style="color:#a855f7;"></i>Yatırım</div>
                        <div class="cat-opt" data-cat="travel"><i class="fas fa-plane" style="color:#3b82f6;"></i>Seyahat</div>
                        <div class="cat-opt" data-cat="tech"><i class="fas fa-laptop" style="color:#f97316;"></i>Teknoloji</div>
                        <div class="cat-opt" data-cat="property"><i class="fas fa-home" style="color:#ec4899;"></i>Emlak</div>
                        <div class="cat-opt" data-cat="car"><i class="fas fa-car" style="color:#06b6d4;"></i>Araç</div>
                        <div class="cat-opt" data-cat="education"><i class="fas fa-graduation-cap" style="color:#8b5cf6;"></i>Eğitim</div>
                        <div class="cat-opt" data-cat="emergency"><i class="fas fa-shield-alt" style="color:#ef4444;"></i>Acil</div>
                        <div class="cat-opt" data-cat="luxury"><i class="fas fa-gem" style="color:#fbbf24;"></i>Lüks</div>
                    </div>
                </div>
                
                <div class="goal-form-row">
                    <div class="goal-form-group">
                        <label class="goal-form-label">Hedef Tutar</label>
                        <input type="number" class="goal-form-input" id="goalTargetInput" placeholder="100000">
                    </div>
                    <div class="goal-form-group">
                        <label class="goal-form-label">Portföy Payı (%)</label>
                        <input type="number" class="goal-form-input" id="goalAllocationInput" placeholder="25" min="0" max="100">
                        <div style="font-size:9px; color:var(--vision-text-muted); margin-top:4px;">Portföyün bu hedefe ayrılan yüzdesi</div>
                    </div>
                </div>
                
                <div class="goal-form-row">
                    <div class="goal-form-group">
                        <label class="goal-form-label">Hedef Tarihi</label>
                        <input type="date" class="goal-form-input" id="goalDeadlineInput">
                    </div>
                    <div class="goal-form-group">
                        <label class="goal-form-label">Aylık Katkı (Tahmini)</label>
                        <input type="number" class="goal-form-input" id="goalMonthlyInput" placeholder="5000">
                    </div>
                </div>
                
                <div class="goal-form-group">
                    <label class="goal-form-label">Öncelik</label>
                    <div class="priority-row" id="priorityPicker">
                        <div class="priority-opt high" data-priority="high">🔴 Yüksek</div>
                        <div class="priority-opt medium selected" data-priority="medium">🟡 Orta</div>
                        <div class="priority-opt low" data-priority="low">⚪ Düşük</div>
                    </div>
                </div>
                
                <button class="goal-save-btn" onclick="saveMultiGoal()">
                    <i class="fas fa-save"></i> HEDEFİ KAYDET
                </button>
            </div>
        </div>
    </div>

    <!-- Para Ekleme Modalı -->
    <div class="goal-modal-overlay" id="addMoneyOverlay" onclick="closeAddMoneyModal(event)">
        <div class="goal-modal" onclick="event.stopPropagation()" style="max-width:340px;">
            <div class="goal-modal-header">
                <div class="goal-modal-title">
                    <i class="fas fa-plus-circle" style="color:#10b981;"></i>
                    <span>Para Ekle</span>
                </div>
                <button class="goal-modal-close" onclick="closeAddMoneyModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="goal-modal-body">
                <input type="hidden" id="addMoneyGoalId" value="">
                <div class="goal-form-group">
                    <label class="goal-form-label">Eklenecek Tutar</label>
                    <input type="number" class="goal-form-input" id="addMoneyAmount" placeholder="1000">
                </div>
                <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px;">
                    <button style="padding:6px 12px; background:rgba(16,185,129,0.15); border:1px solid rgba(16,185,129,0.3); border-radius:8px; font-size:10px; font-weight:600; color:#34d399; cursor:pointer;" onclick="document.getElementById('addMoneyAmount').value=1000">+₺1K</button>
                    <button style="padding:6px 12px; background:rgba(16,185,129,0.15); border:1px solid rgba(16,185,129,0.3); border-radius:8px; font-size:10px; font-weight:600; color:#34d399; cursor:pointer;" onclick="document.getElementById('addMoneyAmount').value=5000">+₺5K</button>
                    <button style="padding:6px 12px; background:rgba(16,185,129,0.15); border:1px solid rgba(16,185,129,0.3); border-radius:8px; font-size:10px; font-weight:600; color:#34d399; cursor:pointer;" onclick="document.getElementById('addMoneyAmount').value=10000">+₺10K</button>
                    <button style="padding:6px 12px; background:rgba(16,185,129,0.15); border:1px solid rgba(16,185,129,0.3); border-radius:8px; font-size:10px; font-weight:600; color:#34d399; cursor:pointer;" onclick="document.getElementById('addMoneyAmount').value=25000">+₺25K</button>
                </div>
                <button class="goal-save-btn green" onclick="confirmAddMoney()">
                    <i class="fas fa-check"></i> EKLE
                </button>
            </div>
        </div>
    </div>

</div>

<script>
// Vision'ı kapatıp Analiz sayfasına dön
function closeVisionView() {
    const visionView = document.getElementById('an-view-vision');
    visionView.style.display = 'none';
    document.body.style.overflow = '';
    const tabs = document.querySelectorAll('.chart-filter-btn, .an-tab-btn, .tab-btn');
    tabs.forEach(tab => {
        const text = tab.textContent.trim().toUpperCase();
        if (text.includes('PERFORMANS') || text.includes('PERFORM')) {
            tab.click();
        }
    });
}

// ================================================
// ÇOKLU HEDEF SİSTEMİ - JAVASCRIPT
// ================================================

let multiGoals = [];
let goalAchievements = [];
let goalStreak = 0;

// Tab Değiştirme
window.switchGoalsTab = function(tab, btn) {
    document.querySelectorAll('.goals-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.goals-tab-content').forEach(c => c.style.display = 'none');
    if (tab === 'summary') document.getElementById('goalsTabSummary').style.display = 'block';
    else if (tab === 'goals') document.getElementById('goalsTabGoals').style.display = 'block';
    else if (tab === 'simulation') document.getElementById('goalsTabSimulation').style.display = 'block';
};

// LocalStorage'dan Yükle
function loadMultiGoals() {
    const saved = localStorage.getItem('tradevia_multi_goals');
    if (saved) multiGoals = JSON.parse(saved);
    const achSaved = localStorage.getItem('tradevia_goal_achievements');
    if (achSaved) goalAchievements = JSON.parse(achSaved);
    const streakData = localStorage.getItem('tradevia_goal_streak');
    if (streakData) {
        const parsed = JSON.parse(streakData);
        const today = new Date().toDateString();
        const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
        if (parsed.lastDate === today || parsed.lastDate === yesterday.toDateString()) {
            goalStreak = parsed.count;
        } else { goalStreak = 0; }
    }
}

function saveMultiGoals() { localStorage.setItem('tradevia_multi_goals', JSON.stringify(multiGoals)); }
function saveGoalAchievements() { localStorage.setItem('tradevia_goal_achievements', JSON.stringify(goalAchievements)); }

// Hedef Listesi Render
function renderMultiGoalsList() {
    const container = document.getElementById('multiGoalsList');
    if (!container) return;
    const countEl = document.getElementById('goalsTabCount');
    if (countEl) countEl.textContent = multiGoals.length;
    if (multiGoals.length === 0) {
        container.innerHTML = '<div class="goals-empty"><i class="fas fa-bullseye"></i><div class="goals-empty-title">Henüz hedef yok</div><div class="goals-empty-sub">Yukarıdaki butona tıklayarak ilk hedefini ekle!</div></div>';
        return;
    }
    const priorityOrder = { high: 1, medium: 2, low: 3 };
    const sorted = [...multiGoals].sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
    let html = '';
    sorted.forEach(goal => { html += renderSingleGoalCard(goal); });
    container.innerHTML = html;
    
    // Progress bar animasyonları - portföy entegrasyonlu
    const portfolioTotal = typeof getSafeBalance === 'function' ? getSafeBalance() : 0;
    setTimeout(() => {
        sorted.forEach(goal => {
            const bar = document.getElementById('gbar_' + goal.id);
            if (bar) {
                const currentValue = goal.allocation > 0 ? (portfolioTotal * goal.allocation) / 100 : (goal.current || 0);
                const pct = Math.min(100, (currentValue / goal.target) * 100);
                bar.style.width = pct + '%';
            }
        });
    }, 50);
}

function renderSingleGoalCard(goal) {
    // Portföyden otomatik hesapla
    const portfolioTotal = typeof getSafeBalance === 'function' ? getSafeBalance() : 0;
    const allocation = goal.allocation || 0;
    const currentFromPortfolio = (portfolioTotal * allocation) / 100;
    
    // Eğer manuel giriş varsa onu kullan, yoksa portföyden hesapla
    const currentValue = allocation > 0 ? currentFromPortfolio : (goal.current || 0);
    
    const pct = Math.min(100, (currentValue / goal.target) * 100);
    const isComplete = currentValue >= goal.target;
    const remaining = Math.max(0, goal.target - currentValue);
    const sym = typeof getCurrencySymbol === 'function' ? getCurrencySymbol() : '₺';
    let pctClass = 'gf-red';
    if (pct >= 75) pctClass = 'gf-green';
    else if (pct >= 50) pctClass = 'gf-yellow';
    else if (pct >= 25) pctClass = 'gf-orange';
    if (isComplete) pctClass = 'gf-complete';
    let estimateHtml = '';
    if (goal.monthly > 0 && !isComplete) {
        const monthsLeft = Math.ceil(remaining / goal.monthly);
        const targetDate = new Date(); targetDate.setMonth(targetDate.getMonth() + monthsLeft);
        const mNames = ['Oca','Şub','Mar','Nis','May','Haz','Tem','Ağu','Eyl','Eki','Kas','Ara'];
        estimateHtml = '<div class="goal-estimate"><i class="fas fa-calendar-alt"></i><span class="goal-estimate-text">Tahmini: <strong>'+mNames[targetDate.getMonth()]+' '+targetDate.getFullYear()+'</strong> ('+monthsLeft+' ay)</span></div>';
    }
    let deadlineHtml = '';
    if (goal.deadline) {
        const dl = new Date(goal.deadline), today = new Date();
        const daysLeft = Math.ceil((dl - today) / (1000*60*60*24));
        if (daysLeft > 0) deadlineHtml = ' · <i class="fas fa-clock"></i> '+daysLeft+' gün';
        else if (daysLeft === 0) deadlineHtml = ' · <span style="color:#f87171;"><i class="fas fa-exclamation-circle"></i> Bugün!</span>';
        else deadlineHtml = ' · <span style="color:#ef4444;"><i class="fas fa-exclamation-triangle"></i> Gecikti</span>';
    }
    // Allocation badge
    let allocBadge = '';
    if (allocation > 0) {
        allocBadge = '<span style="font-size:9px; background:rgba(59,130,246,0.2); color:#60a5fa; padding:2px 6px; border-radius:4px; margin-left:6px;"><i class="fas fa-wallet"></i> %'+allocation+'</span>';
    }
    
    // İkon - FontAwesome veya emoji
    let iconHtml = '';
    if (goal.emoji && goal.emoji.startsWith('fa-')) {
        const iconColor = goal.iconColor || '#a855f7';
        iconHtml = '<i class="fas '+goal.emoji+'" style="font-size:20px; color:'+iconColor+';"></i>';
    } else {
        iconHtml = goal.emoji || '<i class="fas fa-bullseye" style="font-size:20px; color:#a855f7;"></i>';
    }
    
    const milestones = [{pct:25,icon:'<i class="fas fa-seedling"></i>'},{pct:50,icon:'<i class="fas fa-leaf"></i>'},{pct:75,icon:'<i class="fas fa-tree"></i>'},{pct:100,icon:'<i class="fas fa-star"></i>'}];
    let msHtml = milestones.map(m => {
        let cls = ''; if (pct >= m.pct) cls = 'reached'; else if (pct >= m.pct - 15) cls = 'current';
        return '<div class="milestone '+cls+'"><div class="milestone-icon">'+m.icon+'</div><div class="milestone-label">'+m.pct+'%</div></div>';
    }).join('');
    return '<div class="goal-item-card cat-'+goal.category+(isComplete?' completed':'')+'" data-id="'+goal.id+'"><div class="goal-card-top"><div class="goal-emoji">'+iconHtml+'</div><div class="goal-details"><div class="goal-name">'+goal.name+(goal.priority==='high'?'<span class="goal-priority high">ÖNCELİK</span>':'')+(isComplete?'<span class="completed-badge"><i class="fas fa-check"></i> TAMAM</span>':'')+'</div><div class="goal-target-info">Hedef: <span class="amount">'+sym+goal.target.toLocaleString()+'</span>'+allocBadge+deadlineHtml+'</div></div><div class="goal-actions"><button class="goal-action" onclick="editMultiGoal(\''+goal.id+'\')" title="Düzenle"><i class="fas fa-edit"></i></button><button class="goal-action delete" onclick="deleteMultiGoal(\''+goal.id+'\')" title="Sil"><i class="fas fa-trash"></i></button></div></div><div class="goal-progress"><div class="goal-bar-track"><div class="goal-bar-fill '+pctClass+'" id="gbar_'+goal.id+'" style="width:0%;"></div></div><div class="goal-bar-labels"><span class="goal-current">'+sym+currentValue.toLocaleString(undefined,{maximumFractionDigits:0})+'</span><span class="goal-pct">%'+pct.toFixed(1)+'</span></div></div><div class="goal-milestones">'+msHtml+'</div>'+estimateHtml+'</div>';
}

function updateMultiGoalsSummary() {
    const portfolioTotal = typeof getSafeBalance === 'function' ? getSafeBalance() : 0;
    const totalTarget = multiGoals.reduce((s,g) => s + g.target, 0);
    
    // Toplam biriktirilen: Portföyden allocation'a göre veya manuel
    let totalSaved = 0;
    let totalAllocation = 0;
    multiGoals.forEach(g => {
        totalAllocation += (g.allocation || 0);
        if (g.allocation > 0) {
            totalSaved += (portfolioTotal * g.allocation) / 100;
        } else {
            totalSaved += g.current || 0;
        }
    });
    
    const completedCount = multiGoals.filter(g => {
        const curr = g.allocation > 0 ? (portfolioTotal * g.allocation) / 100 : (g.current || 0);
        return curr >= g.target;
    }).length;
    
    const pct = totalTarget > 0 ? (totalSaved / totalTarget) * 100 : 0;
    const sym = typeof getCurrencySymbol === 'function' ? getCurrencySymbol() : '₺';
    const elTotal = document.getElementById('multiGoalTotal');
    const elSaved = document.getElementById('multiGoalSaved');
    const elPct = document.getElementById('multiGoalPct');
    const elRing = document.getElementById('multiGoalRing');
    if (elTotal) elTotal.textContent = sym + totalTarget.toLocaleString();
    if (elSaved) elSaved.textContent = sym + totalSaved.toLocaleString(undefined,{maximumFractionDigits:0});
    if (elPct) elPct.textContent = pct.toFixed(0) + '%';
    if (elRing) { const circ = 2 * Math.PI * 32; setTimeout(() => { elRing.style.strokeDashoffset = circ - (pct/100)*circ; }, 100); }
    
    // Portföy bilgisi güncelle
    const elPortfolio = document.getElementById('portfolioTotalDisplay');
    const elRemaining = document.getElementById('remainingTargetDisplay');
    if (elPortfolio) elPortfolio.textContent = sym + portfolioTotal.toLocaleString(undefined,{maximumFractionDigits:0});
    if (elRemaining) elRemaining.textContent = sym + Math.max(0, totalTarget - totalSaved).toLocaleString(undefined,{maximumFractionDigits:0});
    
    // Allocation bar güncelle
    const elAllocDisplay = document.getElementById('totalAllocationDisplay');
    const elAllocBar = document.getElementById('allocationBar');
    if (elAllocDisplay) elAllocDisplay.textContent = '%' + totalAllocation.toFixed(0);
    if (elAllocBar) elAllocBar.style.width = Math.min(100, totalAllocation) + '%';
    
    const elCount = document.getElementById('statGoalCount');
    const elComplete = document.getElementById('statCompleteCount');
    const elStreak = document.getElementById('statStreakCount');
    const elAvg = document.getElementById('statAvgMonth');
    if (elCount) elCount.textContent = multiGoals.length;
    if (elComplete) elComplete.textContent = completedCount;
    if (elStreak) elStreak.textContent = goalStreak;
    if (elAvg) {
        const withMonthly = multiGoals.filter(g => {
            const curr = g.allocation > 0 ? (portfolioTotal * g.allocation) / 100 : (g.current || 0);
            return g.monthly > 0 && curr < g.target;
        });
        if (withMonthly.length > 0) {
            const avg = withMonthly.reduce((s,g) => {
                const curr = g.allocation > 0 ? (portfolioTotal * g.allocation) / 100 : (g.current || 0);
                return s + Math.ceil((g.target - curr) / g.monthly);
            }, 0) / withMonthly.length;
            elAvg.textContent = avg.toFixed(0);
        } else { elAvg.textContent = '--'; }
    }
    const tabCount = document.getElementById('goalsTabCount');
    if (tabCount) tabCount.textContent = multiGoals.length;
    checkGoalAchievements(totalSaved, completedCount);
}

function checkGoalAchievements(totalSaved, completedCount) {
    if (multiGoals.length >= 1) unlockGoalAchievement('first-goal');
    if (multiGoals.length >= 5) unlockGoalAchievement('multi-goal');
    if (completedCount >= 1) unlockGoalAchievement('goal-complete');
    if (totalSaved >= 100000) unlockGoalAchievement('first-100k');
    if (totalSaved >= 1000000) unlockGoalAchievement('millionaire');
    if (goalStreak >= 7) unlockGoalAchievement('streak-7');
    updateAchievementsUI();
}

function unlockGoalAchievement(id) {
    if (!goalAchievements.includes(id)) {
        goalAchievements.push(id);
        saveGoalAchievements();
        const names = {'first-goal':'🎯 İlk Hedefini Oluşturdun!','first-100k':'💯 ₺100K Biriktirdin!','goal-complete':'🏆 İlk Hedefini Tamamladın!','streak-7':'🔥 7 Günlük Seri!','multi-goal':'🎪 5 Hedef Oluşturdun!','millionaire':'👑 1 Milyon TL!'};
        if (typeof addNotification === 'function') addNotification('success', 'Başarım Açıldı!', names[id] || 'Yeni Rozet!');
        triggerGoalConfetti();
    }
}

function updateAchievementsUI() {
    const container = document.getElementById('achievementsList');
    if (!container) return;
    goalAchievements.forEach(id => {
        const el = container.querySelector('[data-ach="'+id+'"]');
        if (el) el.classList.add('unlocked');
    });
}

function triggerGoalConfetti() {
    const colors = ['#a855f7','#d946ef','#f97316','#10b981','#fbbf24','#3b82f6'];
    for (let i = 0; i < 40; i++) {
        setTimeout(() => {
            const c = document.createElement('div');
            c.className = 'goal-confetti';
            c.style.left = Math.random()*100 + 'vw';
            c.style.background = colors[Math.floor(Math.random()*colors.length)];
            c.style.animationDuration = (2+Math.random()*2)+'s';
            c.style.borderRadius = Math.random()>0.5?'50%':'0';
            document.body.appendChild(c);
            setTimeout(() => c.remove(), 4000);
        }, i*25);
    }
}

window.openGoalModal = function(editId) {
    document.getElementById('goalModalOverlay').classList.add('show');
    document.getElementById('editingGoalId').value = editId || '';
    document.getElementById('goalModalTitle').textContent = editId ? 'Hedefi Düzenle' : 'Yeni Hedef';
    if (editId) {
        const goal = multiGoals.find(g => g.id === editId);
        if (goal) {
            document.getElementById('goalNameInput').value = goal.name;
            document.getElementById('goalTargetInput').value = goal.target;
            document.getElementById('goalAllocationInput').value = goal.allocation || '';
            document.getElementById('goalDeadlineInput').value = goal.deadline || '';
            document.getElementById('goalMonthlyInput').value = goal.monthly || '';
            document.querySelectorAll('.emoji-opt').forEach(e => e.classList.toggle('selected', e.dataset.emoji === goal.emoji));
            document.querySelectorAll('.cat-opt').forEach(c => c.classList.toggle('selected', c.dataset.cat === goal.category));
            document.querySelectorAll('.priority-opt').forEach(p => p.classList.toggle('selected', p.dataset.priority === goal.priority));
        }
    } else {
        document.getElementById('goalNameInput').value = '';
        document.getElementById('goalTargetInput').value = '';
        document.getElementById('goalAllocationInput').value = '';
        document.getElementById('goalDeadlineInput').value = '';
        document.getElementById('goalMonthlyInput').value = '';
        document.querySelectorAll('.emoji-opt').forEach((e,i) => e.classList.toggle('selected', i===0));
        document.querySelectorAll('.cat-opt').forEach((c,i) => c.classList.toggle('selected', i===0));
        document.querySelectorAll('.priority-opt').forEach(p => p.classList.toggle('selected', p.dataset.priority==='medium'));
    }
};

window.closeGoalModal = function(e) {
    if (e && e.target !== e.currentTarget) return;
    document.getElementById('goalModalOverlay').classList.remove('show');
};

window.saveMultiGoal = function() {
    const editId = document.getElementById('editingGoalId').value;
    const name = document.getElementById('goalNameInput').value.trim();
    const target = parseFloat(document.getElementById('goalTargetInput').value) || 0;
    const allocation = parseFloat(document.getElementById('goalAllocationInput').value) || 0;
    const deadline = document.getElementById('goalDeadlineInput').value;
    const monthly = parseFloat(document.getElementById('goalMonthlyInput').value) || 0;
    const selectedIcon = document.querySelector('.emoji-opt.selected');
    const emoji = selectedIcon?.dataset.emoji || 'fa-bullseye';
    const iconColor = selectedIcon?.dataset.color || '#a855f7';
    const category = document.querySelector('.cat-opt.selected')?.dataset.cat || 'savings';
    const priority = document.querySelector('.priority-opt.selected')?.dataset.priority || 'medium';
    if (!name) { if (typeof addNotification==='function') addNotification('danger','Hata','Hedef adı girin.'); return; }
    if (target <= 0) { if (typeof addNotification==='function') addNotification('danger','Hata','Geçerli hedef tutar girin.'); return; }
    
    // Toplam allocation kontrolü
    let totalAlloc = allocation;
    multiGoals.forEach(g => {
        if (g.id !== editId) totalAlloc += (g.allocation || 0);
    });
    if (totalAlloc > 100) {
        if (typeof addNotification==='function') addNotification('danger','Hata','Toplam portföy payı %100\'ü geçemez! (Şu an: %'+totalAlloc+')');
        return;
    }
    
    if (editId) {
        const idx = multiGoals.findIndex(g => g.id === editId);
        if (idx !== -1) multiGoals[idx] = {...multiGoals[idx], name, emoji, iconColor, category, target, allocation, deadline, monthly, priority};
    } else {
        multiGoals.push({id:'goal_'+Date.now(), name, emoji, iconColor, category, target, allocation, current: 0, deadline, monthly, priority, createdAt: new Date().toISOString()});
    }
    saveMultiGoals(); renderMultiGoalsList(); updateMultiGoalsSummary(); closeGoalModal();
    if (typeof addNotification==='function') addNotification('success', editId?'Güncellendi':'Eklendi', '"'+name+'" '+(editId?'güncellendi':'eklendi')+'.');
};

window.editMultiGoal = function(id) { openGoalModal(id); };

window.deleteMultiGoal = function(id) {
    if (!confirm('Bu hedefi silmek istediğinize emin misiniz?')) return;
    multiGoals = multiGoals.filter(g => g.id !== id);
    saveMultiGoals(); renderMultiGoalsList(); updateMultiGoalsSummary();
    if (typeof addNotification==='function') addNotification('success','Silindi','Hedef silindi.');
};

window.openAddMoneyModal = function(goalId) {
    document.getElementById('addMoneyOverlay').classList.add('show');
    document.getElementById('addMoneyGoalId').value = goalId;
    document.getElementById('addMoneyAmount').value = '';
};

window.closeAddMoneyModal = function(e) {
    if (e && e.target !== e.currentTarget) return;
    document.getElementById('addMoneyOverlay').classList.remove('show');
};

window.confirmAddMoney = function() {
    const goalId = document.getElementById('addMoneyGoalId').value;
    const amount = parseFloat(document.getElementById('addMoneyAmount').value) || 0;
    if (amount <= 0) { if (typeof addNotification==='function') addNotification('danger','Hata','Geçerli tutar girin.'); return; }
    const goal = multiGoals.find(g => g.id === goalId);
    if (goal) {
        const wasComplete = goal.current >= goal.target;
        goal.current += amount;
        saveMultiGoals();
        if (!wasComplete && goal.current >= goal.target) {
            triggerGoalConfetti();
            if (typeof addNotification==='function') addNotification('success','🎉 Tebrikler!','"'+goal.name+'" hedefine ulaştın!');
        } else {
            const sym = typeof getCurrencySymbol==='function'?getCurrencySymbol():'₺';
            if (typeof addNotification==='function') addNotification('success','Eklendi',sym+amount.toLocaleString()+' eklendi.');
        }
        updateGoalStreak();
        renderMultiGoalsList(); updateMultiGoalsSummary();
    }
    closeAddMoneyModal();
};

function updateGoalStreak() {
    const today = new Date().toDateString();
    const data = JSON.parse(localStorage.getItem('tradevia_goal_streak') || '{}');
    if (data.lastDate === today) return;
    const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
    if (data.lastDate === yesterday.toDateString()) goalStreak = (data.count||0)+1;
    else goalStreak = 1;
    localStorage.setItem('tradevia_goal_streak', JSON.stringify({lastDate:today, count:goalStreak}));
}

function setupGoalPickers() {
    document.querySelectorAll('.emoji-opt').forEach(opt => {
        opt.onclick = function() {
            document.querySelectorAll('.emoji-opt').forEach(e => e.classList.remove('selected'));
            this.classList.add('selected');
        };
    });
    document.querySelectorAll('.cat-opt').forEach(opt => {
        opt.onclick = function() {
            document.querySelectorAll('.cat-opt').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
        };
    });
    document.querySelectorAll('.priority-opt').forEach(opt => {
        opt.onclick = function() {
            document.querySelectorAll('.priority-opt').forEach(p => p.classList.remove('selected'));
            this.classList.add('selected');
        };
    });
}

// ================================================
// SİMÜLASYON GRAFİĞİ
// ================================================
let visionSimChartInstance = null;

function renderSimulationChart() {
    const canvas = document.getElementById('visionSimChart');
    if (!canvas) return;
    
    const rate = parseFloat(document.getElementById('visionRate')?.value) || 5;
    const add = parseFloat(document.getElementById('visionAdd')?.value) || 1000;
    const current = typeof getSafeBalance === 'function' ? getSafeBalance() : 50000;
    const sym = typeof getCurrencySymbol === 'function' ? getCurrencySymbol() : '₺';
    
    const months = 24;
    const labels = [];
    const projectedData = [];
    const principalData = [];
    const bestCaseData = [];
    const worstCaseData = [];
    
    let balance = current;
    let principal = current;
    let bestBalance = current;
    let worstBalance = current;
    
    const now = new Date();
    const monthNames = ['Oca','Şub','Mar','Nis','May','Haz','Tem','Ağu','Eyl','Eki','Kas','Ara'];
    
    for (let i = 0; i <= months; i++) {
        const futureDate = new Date(now.getFullYear(), now.getMonth() + i, 1);
        labels.push(monthNames[futureDate.getMonth()] + ' ' + (futureDate.getFullYear() % 100));
        
        projectedData.push(Math.round(balance));
        principalData.push(Math.round(principal));
        bestCaseData.push(Math.round(bestBalance));
        worstCaseData.push(Math.round(worstBalance));
        
        // Sonraki ay için hesapla
        balance = balance * (1 + rate / 100) + add;
        principal = principal + add;
        bestBalance = bestBalance * (1 + (rate + 2) / 100) + add;
        worstBalance = worstBalance * (1 + Math.max(0, rate - 2) / 100) + add;
    }
    
    // Senaryo değerlerini güncelle
    const elBest = document.getElementById('simBestCase');
    const elWorst = document.getElementById('simWorstCase');
    if (elBest) elBest.textContent = sym + bestCaseData[months].toLocaleString();
    if (elWorst) elWorst.textContent = sym + worstCaseData[months].toLocaleString();
    
    // Eski grafiği yok et
    if (visionSimChartInstance) {
        visionSimChartInstance.destroy();
        visionSimChartInstance = null;
    }
    
    const ctx = canvas.getContext('2d');
    
    // Gradient oluştur
    const gradientPurple = ctx.createLinearGradient(0, 0, 0, 280);
    gradientPurple.addColorStop(0, 'rgba(168, 85, 247, 0.4)');
    gradientPurple.addColorStop(1, 'rgba(168, 85, 247, 0)');
    
    const gradientOrange = ctx.createLinearGradient(0, 0, 0, 280);
    gradientOrange.addColorStop(0, 'rgba(249, 115, 22, 0.3)');
    gradientOrange.addColorStop(1, 'rgba(249, 115, 22, 0)');
    
    visionSimChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Tahmini Değer',
                    data: projectedData,
                    borderColor: '#a855f7',
                    backgroundColor: gradientPurple,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#a855f7',
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 2
                },
                {
                    label: 'Anapara',
                    data: principalData,
                    borderColor: '#f97316',
                    backgroundColor: gradientOrange,
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 4
                },
                {
                    label: 'İyi Senaryo',
                    data: bestCaseData,
                    borderColor: 'rgba(52, 211, 153, 0.5)',
                    borderWidth: 1,
                    borderDash: [3, 3],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0
                },
                {
                    label: 'Kötü Senaryo',
                    data: worstCaseData,
                    borderColor: 'rgba(248, 113, 113, 0.5)',
                    borderWidth: 1,
                    borderDash: [3, 3],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#94a3b8',
                        font: { size: 10, family: 'Inter' },
                        boxWidth: 12,
                        padding: 10,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    titleColor: '#f1f5f9',
                    bodyColor: '#94a3b8',
                    borderColor: 'rgba(168, 85, 247, 0.3)',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + sym + context.raw.toLocaleString();
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { color: 'rgba(255, 255, 255, 0.03)' },
                    ticks: { 
                        color: '#64748b', 
                        font: { size: 9 },
                        maxRotation: 45,
                        minRotation: 45
                    }
                },
                y: {
                    grid: { color: 'rgba(255, 255, 255, 0.03)' },
                    ticks: { 
                        color: '#64748b', 
                        font: { size: 9 },
                        callback: function(value) {
                            if (value >= 1000000) return sym + (value / 1000000).toFixed(1) + 'M';
                            if (value >= 1000) return sym + (value / 1000).toFixed(0) + 'K';
                            return sym + value;
                        }
                    }
                }
            }
        }
    });
}

// Tab değiştiğinde simülasyon grafiğini çiz
window.switchGoalsTab = function(tab, btn) {
    document.querySelectorAll('.goals-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.goals-tab-content').forEach(c => c.style.display = 'none');
    
    if (tab === 'summary') {
        document.getElementById('goalsTabSummary').style.display = 'block';
    } else if (tab === 'goals') {
        document.getElementById('goalsTabGoals').style.display = 'block';
    } else if (tab === 'simulation') {
        document.getElementById('goalsTabSimulation').style.display = 'block';
        // Grafik çiz
        setTimeout(renderSimulationChart, 100);
    }
};

// manualUpdateVision'ı genişlet - simülasyon grafiğini de güncelle
const _origManualUpdate = window.manualUpdateVision;
window.manualUpdateVision = function() {
    if (typeof _origManualUpdate === 'function') _origManualUpdate();
    renderSimulationChart();
};

// Mevcut loadVisionData'yı genişlet
const _origLoadVision = window.loadVisionData;
window.loadVisionData = function() {
    if (typeof _origLoadVision === 'function') _origLoadVision();
    loadMultiGoals();
    setupGoalPickers();
    renderMultiGoalsList();
    updateMultiGoalsSummary();
    createVisionStars(); // Yıldızları oluştur
};

// Yıldız efekti oluştur
function createVisionStars() {
    const container = document.getElementById('visionStars');
    if (!container || container.children.length > 0) return;
    
    for (let i = 0; i < 30; i++) {
        const star = document.createElement('div');
        star.className = 'vision-star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.animationDelay = Math.random() * 3 + 's';
        star.style.animationDuration = (2 + Math.random() * 2) + 's';
        container.appendChild(star);
    }
}

// Sayfa yüklendiğinde çalıştır
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        loadMultiGoals();
        renderMultiGoalsList(); // <--- BU SATIRI EKLEYİN
        if(typeof updateMultiGoalsSummary === 'function') updateMultiGoalsSummary(); // Özetleri de güncellemek için
        setupGoalPickers();
        createVisionStars(); // Yıldızları oluştur
    }, 500);
});

</script>


<!-- LAB SECTION - Premium Design -->
<!-- Bu kodu mevcut an-view-lab section'ının yerine yapıştır -->

<style>
/* LAB PREMIUM STYLES */

/* Fullscreen Mode - Tüm ekranı kapla */
#an-view-lab.lab-fullscreen-mode {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    height: 100% !important;
    z-index: 9999 !important;
    background: #030712 !important;
    margin: 0 !important;
    padding: 0 !important;
    overflow: hidden !important;
}

#an-view-lab {
    --lab-bg-deep: #030712;
    --lab-bg-card: rgba(15, 23, 42, 0.6);
    --lab-bg-elevated: rgba(30, 41, 59, 0.4);
    --lab-glass-border: rgba(255, 255, 255, 0.06);
    --lab-accent-gold: #d4a574;
    --lab-accent-gold-dim: rgba(212, 165, 116, 0.15);
    --lab-accent-emerald: #34d399;
    --lab-accent-emerald-dim: rgba(52, 211, 153, 0.12);
    --lab-accent-rose: #fb7185;
    --lab-accent-rose-dim: rgba(251, 113, 133, 0.12);
    --lab-accent-violet: #a78bfa;
    --lab-accent-violet-dim: rgba(167, 139, 250, 0.12);
    --lab-accent-sky: #38bdf8;
    --lab-accent-sky-dim: rgba(56, 189, 248, 0.12);
    --lab-text-primary: #f1f5f9;
    --lab-text-secondary: #94a3b8;
    --lab-text-muted: #475569;
}

/* Top Navigation Bar - Fixed at top */
#an-view-lab .lab-topbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    background: rgba(3, 7, 18, 0.95);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--lab-glass-border);
    z-index: 10000;
    height: 64px;
}

#an-view-lab .lab-back-btn {
    width: 40px;
    height: 40px;
    background: transparent;
    border: none;
    border-radius: 12px;
    color: var(--lab-text-primary);
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

#an-view-lab .lab-back-btn:hover {
    background: var(--lab-bg-elevated);
}

#an-view-lab .lab-back-btn:active {
    transform: scale(0.95);
}

#an-view-lab .lab-topbar-title {
    display: flex;
    align-items: center;
    gap: 8px;
}

#an-view-lab .lab-topbar-brand {
    font-size: 20px;
    font-weight: 800;
    color: var(--lab-text-primary);
    letter-spacing: -0.5px;
}

#an-view-lab .lab-topbar-beta {
    font-size: 10px;
    font-weight: 700;
    color: var(--lab-accent-rose);
    letter-spacing: 0.5px;
}

#an-view-lab .lab-notify-btn {
    width: 44px;
    height: 44px;
    background: var(--lab-bg-card);
    border: 1px solid var(--lab-glass-border);
    border-radius: 14px;
    color: var(--lab-text-secondary);
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

#an-view-lab .lab-notify-btn:hover {
    background: var(--lab-bg-elevated);
    color: var(--lab-text-primary);
}

/* Scrollable Content Area */
#an-view-lab .lab-content {
    position: absolute;
    top: 64px;
    left: 0;
    right: 0;
    bottom: 0;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 0 16px 100px 16px;
    -webkit-overflow-scrolling: touch;
}

#an-view-lab .lab-content::-webkit-scrollbar {
    width: 4px;
}

#an-view-lab .lab-content::-webkit-scrollbar-track {
    background: transparent;
}

#an-view-lab .lab-content::-webkit-scrollbar-thumb {
    background: var(--lab-text-muted);
    border-radius: 4px;
}

#an-view-lab .lab-ambient-bg {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
    border-radius: 20px;
}

#an-view-lab .lab-ambient-orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
    opacity: 0.3;
    animation: labFloat 20s ease-in-out infinite;
}

#an-view-lab .lab-orb-1 {
    width: 300px; height: 300px;
    background: radial-gradient(circle, var(--lab-accent-gold) 0%, transparent 70%);
    top: -15%; right: -10%;
}

#an-view-lab .lab-orb-2 {
    width: 250px; height: 250px;
    background: radial-gradient(circle, var(--lab-accent-violet) 0%, transparent 70%);
    bottom: 10%; left: -15%;
    animation-delay: -7s;
}

@keyframes labFloat {
    0%, 100% { transform: translate(0, 0) scale(1); }
    50% { transform: translate(20px, -20px) scale(1.05); }
}

#an-view-lab .lab-header {
    text-align: center;
    padding: 30px 20px;
    margin-bottom: 20px;
    position: relative;
    z-index: 1;
}

#an-view-lab .lab-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: linear-gradient(135deg, var(--lab-accent-gold-dim), transparent);
    border: 1px solid rgba(212, 165, 116, 0.3);
    padding: 6px 16px;
    border-radius: 100px;
    font-size: 10px;
    font-weight: 700;
    color: var(--lab-accent-gold);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 15px;
    animation: labShimmer 3s ease-in-out infinite;
}

@keyframes labShimmer {
    0%, 100% { box-shadow: 0 0 15px rgba(212, 165, 116, 0.1); }
    50% { box-shadow: 0 0 25px rgba(212, 165, 116, 0.25); }
}

#an-view-lab .lab-title {
    font-size: 28px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
}

#an-view-lab .lab-subtitle {
    font-size: 13px;
    color: var(--lab-text-secondary);
}

/* Tab Navigation - Mevcut yapıya uyumlu */
#an-view-lab .lab-tab-nav {
    display: flex;
    gap: 4px;
    padding: 4px;
    background: var(--lab-bg-card);
    backdrop-filter: blur(20px);
    border-radius: 12px;
    border: 1px solid var(--lab-glass-border);
    margin-bottom: 20px;
    overflow: hidden;
    position: relative;
    z-index: 1;
}

#an-view-lab .lab-tab-nav .chart-filter-btn {
    flex: 1;
    padding: 10px 6px;
    background: transparent;
    border: none;
    border-radius: 8px;
    font-family: inherit;
    font-size: 9px;
    font-weight: 600;
    color: var(--lab-text-secondary);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    white-space: nowrap;
}

#an-view-lab .lab-tab-nav .chart-filter-btn i {
    font-size: 16px;
}

#an-view-lab .lab-tab-nav .chart-filter-btn:hover {
    color: var(--lab-text-primary);
    background: var(--lab-bg-elevated);
}

#an-view-lab .lab-tab-nav .chart-filter-btn.active {
    background: linear-gradient(135deg, rgba(212, 165, 116, 0.15), rgba(212, 165, 116, 0.05));
    color: var(--lab-accent-gold);
    box-shadow: 0 0 0 1px rgba(212, 165, 116, 0.3), 0 4px 15px -4px rgba(212, 165, 116, 0.2);
}

/* Zaman Makinesi özel stil */
#an-view-lab .lab-tab-nav .chart-filter-btn[onclick*="time"] {
    background: linear-gradient(135deg, var(--lab-accent-violet-dim), transparent);
    color: var(--lab-accent-violet);
}

#an-view-lab .lab-tab-nav .chart-filter-btn[onclick*="time"].active {
    background: linear-gradient(135deg, rgba(167, 139, 250, 0.2), rgba(167, 139, 250, 0.05));
    box-shadow: 0 0 0 1px rgba(167, 139, 250, 0.4);
}

/* Tool Containers */
#an-view-lab .lab-tool-container {
    animation: labPanelIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    z-index: 1;
}

@keyframes labPanelIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Glass Card */
#an-view-lab .lab-glass-card {
    background: var(--lab-bg-card);
    backdrop-filter: blur(20px);
    border: 1px solid var(--lab-glass-border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
}

#an-view-lab .lab-glass-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
}

/* Tool Header */
#an-view-lab .lab-tool-header {
    display: flex;
    align-items: center;
    gap: 14px;
    margin-bottom: 20px;
}

#an-view-lab .lab-tool-icon {
    width: 48px; height: 48px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    position: relative;
}

#an-view-lab .lab-tool-icon.gold {
    background: linear-gradient(135deg, var(--lab-accent-gold-dim), transparent);
    color: var(--lab-accent-gold);
    box-shadow: 0 6px 24px -6px rgba(212, 165, 116, 0.3);
}

#an-view-lab .lab-tool-icon.rose {
    background: linear-gradient(135deg, var(--lab-accent-rose-dim), transparent);
    color: var(--lab-accent-rose);
    box-shadow: 0 6px 24px -6px rgba(251, 113, 133, 0.3);
}

#an-view-lab .lab-tool-icon.sky {
    background: linear-gradient(135deg, var(--lab-accent-sky-dim), transparent);
    color: var(--lab-accent-sky);
    box-shadow: 0 6px 24px -6px rgba(56, 189, 248, 0.3);
}

#an-view-lab .lab-tool-icon.violet {
    background: linear-gradient(135deg, var(--lab-accent-violet-dim), transparent);
    color: var(--lab-accent-violet);
    box-shadow: 0 6px 24px -6px rgba(167, 139, 250, 0.3);
}

#an-view-lab .lab-tool-icon.emerald {
    background: linear-gradient(135deg, var(--lab-accent-emerald-dim), transparent);
    color: var(--lab-accent-emerald);
    box-shadow: 0 6px 24px -6px rgba(52, 211, 153, 0.3);
}

#an-view-lab .lab-tool-info h3 {
    font-size: 17px;
    font-weight: 700;
    color: var(--lab-text-primary);
    margin-bottom: 3px;
}

#an-view-lab .lab-tool-info p {
    font-size: 11px;
    color: var(--lab-text-secondary);
}

/* Section Label */
#an-view-lab .lab-section-label {
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 1.2px;
    text-transform: uppercase;
    color: var(--lab-text-muted);
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

#an-view-lab .lab-section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--lab-glass-border), transparent);
}

/* Form Elements */
#an-view-lab .lab-form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}

#an-view-lab .lab-form-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

#an-view-lab .lab-form-group.full {
    grid-column: 1 / -1;
}

#an-view-lab .lab-form-label {
    font-size: 10px;
    font-weight: 500;
    color: var(--lab-text-secondary);
}

#an-view-lab .lab-input {
    width: 100%;
    padding: 12px 14px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--lab-glass-border);
    border-radius: 10px;
    font-family: 'JetBrains Mono', 'SF Mono', monospace;
    font-size: 13px;
    font-weight: 500;
    color: var(--lab-text-primary);
    transition: all 0.2s;
    outline: none;
}

#an-view-lab .lab-input::placeholder {
    color: var(--lab-text-muted);
    font-family: inherit;
}

#an-view-lab .lab-input:focus {
    border-color: var(--lab-accent-gold);
    box-shadow: 0 0 0 3px var(--lab-accent-gold-dim);
}

#an-view-lab .lab-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 14px center;
    padding-right: 36px;
    cursor: pointer;
}

/* Primary Button */
#an-view-lab .lab-btn-primary {
    width: 100%;
    padding: 14px 20px;
    background: linear-gradient(135deg, var(--lab-accent-gold), #b8956a);
    border: none;
    border-radius: 12px;
    font-family: inherit;
    font-size: 13px;
    font-weight: 700;
    color: #0a0f1a;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#an-view-lab .lab-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px -8px rgba(212, 165, 116, 0.5);
}

#an-view-lab .lab-btn-primary.rose {
    background: linear-gradient(135deg, var(--lab-accent-rose), #e11d48);
}

#an-view-lab .lab-btn-primary.rose:hover {
    box-shadow: 0 8px 25px -8px rgba(251, 113, 133, 0.5);
}

#an-view-lab .lab-btn-primary.sky {
    background: linear-gradient(135deg, var(--lab-accent-sky), #0ea5e9);
}

#an-view-lab .lab-btn-primary.sky:hover {
    box-shadow: 0 8px 25px -8px rgba(56, 189, 248, 0.5);
}

#an-view-lab .lab-btn-primary.violet {
    background: linear-gradient(135deg, var(--lab-accent-violet), #8b5cf6);
    color: white;
}

#an-view-lab .lab-btn-primary.violet:hover {
    box-shadow: 0 8px 25px -8px rgba(167, 139, 250, 0.5);
}

/* Secondary Button */
#an-view-lab .lab-btn-secondary {
    padding: 10px 16px;
    background: var(--lab-bg-elevated);
    border: 1px solid var(--lab-glass-border);
    border-radius: 8px;
    font-family: inherit;
    font-size: 11px;
    font-weight: 600;
    color: var(--lab-text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
}

#an-view-lab .lab-btn-secondary:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--lab-text-primary);
}

/* Results Card */
#an-view-lab .lab-results-card {
    background: linear-gradient(145deg, rgba(15, 23, 42, 0.8), rgba(10, 15, 26, 0.9));
    border: 1px solid var(--lab-glass-border);
    border-radius: 16px;
    padding: 20px;
    margin-top: 20px;
    position: relative;
    overflow: hidden;
}

#an-view-lab .lab-results-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
}

#an-view-lab .lab-results-card.gold {
    border-color: rgba(212, 165, 116, 0.3);
}
#an-view-lab .lab-results-card.gold::before {
    background: linear-gradient(90deg, transparent, var(--lab-accent-gold), transparent);
}

#an-view-lab .lab-results-card.rose {
    border-color: rgba(251, 113, 133, 0.3);
}
#an-view-lab .lab-results-card.rose::before {
    background: linear-gradient(90deg, transparent, var(--lab-accent-rose), transparent);
}

#an-view-lab .lab-results-card.sky {
    border-color: rgba(56, 189, 248, 0.3);
}
#an-view-lab .lab-results-card.sky::before {
    background: linear-gradient(90deg, transparent, var(--lab-accent-sky), transparent);
}

#an-view-lab .lab-results-card.emerald {
    border-color: rgba(52, 211, 153, 0.3);
}
#an-view-lab .lab-results-card.emerald::before {
    background: linear-gradient(90deg, transparent, var(--lab-accent-emerald), transparent);
}

/* Big Number */
#an-view-lab .lab-big-number {
    text-align: center;
    padding: 16px 0;
}

#an-view-lab .lab-big-number-label {
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: var(--lab-text-muted);
    margin-bottom: 6px;
}

#an-view-lab .lab-big-number-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 36px;
    font-weight: 700;
    letter-spacing: -1px;
    background: linear-gradient(135deg, #fff, #94a3b8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

#an-view-lab .lab-big-number-value.gold {
    background: linear-gradient(135deg, var(--lab-accent-gold), #fbbf24);
    -webkit-background-clip: text;
    background-clip: text;
}

#an-view-lab .lab-big-number-value.emerald {
    background: linear-gradient(135deg, var(--lab-accent-emerald), #6ee7b7);
    -webkit-background-clip: text;
    background-clip: text;
}

/* Stats Grid */
#an-view-lab .lab-stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin: 16px 0;
}

#an-view-lab .lab-stat-item {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    padding: 14px;
    border: 1px solid var(--lab-glass-border);
}

#an-view-lab .lab-stat-label {
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--lab-text-muted);
    margin-bottom: 4px;
}

#an-view-lab .lab-stat-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 16px;
    font-weight: 700;
    color: var(--lab-text-primary);
}

#an-view-lab .lab-stat-value.emerald { color: var(--lab-accent-emerald); }
#an-view-lab .lab-stat-value.rose { color: var(--lab-accent-rose); }
#an-view-lab .lab-stat-value.gold { color: var(--lab-accent-gold); }

/* Scenario Select */
#an-view-lab .lab-scenario-select {
    width: 100%;
    padding: 14px 18px;
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(15, 23, 42, 0.8));
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: 12px;
    font-family: inherit;
    font-size: 13px;
    font-weight: 600;
    color: var(--lab-text-primary);
    cursor: pointer;
    appearance: none;
    margin-bottom: 16px;
}

#an-view-lab .lab-scenario-select:focus {
    outline: none;
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.15);
}

#an-view-lab .lab-scenario-select option {
    background: var(--bg-card);
    color: var(--lab-text-primary);
}

/* Progress Bar */
#an-view-lab .lab-progress-container {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    height: 36px;
    position: relative;
    overflow: hidden;
    margin: 12px 0;
}

#an-view-lab .lab-progress-fill {
    height: 100%;
    border-radius: 8px;
    transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

#an-view-lab .lab-progress-text {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    color: white;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

/* Advice Box */
#an-view-lab .lab-advice-box {
    background: rgba(0, 0, 0, 0.25);
    border-radius: 10px;
    padding: 14px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin-top: 12px;
}

#an-view-lab .lab-advice-box i {
    font-size: 16px;
    margin-top: 1px;
}

#an-view-lab .lab-advice-box p {
    font-size: 11px;
    line-height: 1.5;
    color: var(--lab-text-secondary);
}

/* Mode Toggle */
#an-view-lab .lab-mode-toggle {
    display: flex;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    padding: 4px;
    margin-bottom: 16px;
}

#an-view-lab .lab-mode-toggle .sim-tab {
    flex: 1;
    padding: 10px 14px;
    background: transparent;
    border: none;
    border-radius: 8px;
    font-family: inherit;
    font-size: 12px;
    font-weight: 600;
    color: var(--lab-text-secondary);
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
}

#an-view-lab .lab-mode-toggle .sim-tab.active {
    background: var(--lab-bg-elevated);
    color: var(--lab-text-primary);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}

/* Range Slider */
#an-view-lab .lab-range-slider {
    width: 100%;
    height: 6px;
    -webkit-appearance: none;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    outline: none;
    margin: 10px 0;
}

#an-view-lab .lab-range-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: linear-gradient(135deg, var(--lab-accent-sky), #0ea5e9);
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(56, 189, 248, 0.4);
}

/* Strategy Steps */
#an-view-lab .lab-strategy-step {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    margin-bottom: 8px;
    border-left: 3px solid var(--lab-accent-sky);
    transition: all 0.2s;
}

#an-view-lab .lab-strategy-step:hover {
    background: rgba(0, 0, 0, 0.3);
    transform: translateX(4px);
}

#an-view-lab .lab-step-number {
    width: 28px; height: 28px;
    background: var(--lab-accent-sky-dim);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    color: var(--lab-accent-sky);
}

/* Data Table */
#an-view-lab .lab-data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 11px;
}

#an-view-lab .lab-data-table th {
    padding: 12px 10px;
    background: rgba(0, 0, 0, 0.3);
    text-align: right;
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--lab-text-muted);
    white-space: nowrap;
}

#an-view-lab .lab-data-table th:first-child { text-align: left; }

#an-view-lab .lab-data-table td {
    padding: 12px 10px;
    text-align: right;
    border-top: 1px solid var(--lab-glass-border);
    font-family: 'JetBrains Mono', monospace;
    font-weight: 500;
    color: var(--lab-text-primary);
}

#an-view-lab .lab-data-table td:first-child {
    text-align: left;
    font-family: inherit;
    font-weight: 600;
}

/* DNA Card */
#an-view-lab .lab-dna-card {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(15, 23, 42, 0.6));
    border: 1px solid rgba(16, 185, 129, 0.2);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
}

#an-view-lab .lab-dna-type {
    padding: 3px 10px;
    border-radius: 5px;
    font-size: 10px;
    font-weight: 700;
}

#an-view-lab .lab-dna-type.conservative {
    background: rgba(52, 211, 153, 0.15);
    color: var(--lab-accent-emerald);
}

#an-view-lab .lab-dna-type.moderate {
    background: rgba(56, 189, 248, 0.15);
    color: var(--lab-accent-sky);
}

#an-view-lab .lab-dna-type.aggressive {
    background: rgba(251, 113, 133, 0.15);
    color: var(--lab-accent-rose);
}

/* Monthly Report */
#an-view-lab .lab-monthly-report {
    max-height: 350px;
    overflow-y: auto;
}

#an-view-lab .lab-monthly-report::-webkit-scrollbar { width: 5px; }
#an-view-lab .lab-monthly-report::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 8px; }
#an-view-lab .lab-monthly-report::-webkit-scrollbar-thumb { background: var(--lab-text-muted); border-radius: 8px; }

#an-view-lab .lab-month-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 12px 14px;
    background: rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    margin-bottom: 6px;
    border-left: 3px solid transparent;
    transition: all 0.2s;
}

#an-view-lab .lab-month-item:hover {
    background: rgba(0, 0, 0, 0.25);
    border-left-color: var(--lab-accent-gold);
}

#an-view-lab .lab-month-number {
    width: 32px; height: 32px;
    background: var(--lab-accent-gold-dim);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 700;
    color: var(--lab-accent-gold);
}

/* Projection Item */
#an-view-lab .lab-projection-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    margin-bottom: 8px;
    border-left: 3px solid var(--lab-accent-sky);
}

#an-view-lab .lab-projection-bar {
    flex: 1;
    height: 6px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    overflow: hidden;
}

#an-view-lab .lab-projection-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--lab-accent-sky), var(--lab-accent-emerald));
    border-radius: 8px;
}

/* Risk Alert */
#an-view-lab .lab-risk-alert {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.2);
    border-radius: 10px;
    padding: 14px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin: 16px 0;
}

/* Disclaimer */
#an-view-lab .lab-disclaimer {
    text-align: center;
    padding: 14px;
    font-size: 9px;
    color: var(--lab-text-muted);
    border-top: 1px solid var(--lab-glass-border);
    margin-top: 20px;
}

/* Mobile Responsive */
@media (max-width: 640px) {
    #an-view-lab .lab-title { font-size: 24px; }
    #an-view-lab .lab-form-grid { grid-template-columns: 1fr; }
    #an-view-lab .lab-stats-grid { grid-template-columns: 1fr; }
    #an-view-lab .lab-big-number-value { font-size: 28px; }
    #an-view-lab .lab-tool-header { flex-direction: column; text-align: center; }
}
</style>

<div id="an-view-lab" class="an-view-section lab-fullscreen-mode" style="display:none;">
    
    <!-- Ambient Background -->
    <div class="lab-ambient-bg">
        <div class="lab-ambient-orb lab-orb-1"></div>
        <div class="lab-ambient-orb lab-orb-2"></div>
    </div>

    <!-- Top Navigation Bar - Sticky -->
    <div class="lab-topbar">
        <button class="lab-back-btn" onclick="closeLabView()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="lab-topbar-title">
            <span class="lab-topbar-brand">TradeVia</span>
            <span class="lab-topbar-beta">BETA</span>
        </div>
        <div style="width: 40px;"></div>
    </div>

    <!-- Scrollable Content -->
    <div class="lab-content">
        <!-- Header -->
        <div class="lab-header">
            <div class="lab-badge"><i class="fas fa-flask"></i> AR-GE LAB</div>
            <h1 class="lab-title">Strateji Laboratuvarı</h1>
            <p class="lab-subtitle">Profesyonel yatırım araçları ve simülasyonlar</p>
        </div>

    <!-- Tab Navigation - Kompakt versiyon -->
    <div class="lab-tab-nav">
        <button class="chart-filter-btn active" onclick="switchLabTool('growth', this)">
            <i class="fas fa-chart-line"></i>
            <span>Büyüme</span>
        </button>
        <button class="chart-filter-btn" onclick="switchLabTool('risk', this)">
            <i class="fas fa-shield-halved"></i>
            <span>Risk</span>
        </button>
        <button class="chart-filter-btn" onclick="switchLabTool('avg', this)">
            <i class="fas fa-chess-knight"></i>
            <span>Maliyet</span>
        </button>
        <button class="chart-filter-btn" onclick="switchLabTool('time', this)">
            <i class="fas fa-clock-rotate-left"></i>
            <span>Zaman</span>
        </button>
        <button class="chart-filter-btn" onclick="switchLabTool('pos', this)">
            <i class="fas fa-wand-magic-sparkles"></i>
            <span>Sihirbaz</span>
        </button>
    </div>

    <!-- ========== GROWTH TOOL ========== -->
    <div id="lab-tool-growth" class="lab-tool-container">
        <div class="lab-glass-card">
            <div class="lab-tool-header">
                <div class="lab-tool-icon gold"><i class="fas fa-flask"></i></div>
                <div class="lab-tool-info">
                    <h3>Bileşik Getiri Testi</h3>
                    <p>Strateji test laboratuvarında büyüme potansiyelini simüle edin</p>
                </div>
            </div>

            <div class="lab-section-label">Deney Parametreleri</div>

            <div class="lab-form-grid">
                <div class="lab-form-group">
                    <label class="lab-form-label"><i class="fas fa-wallet"></i> Başlangıç Sermayesi</label>
                    <input type="number" id="labStart" class="lab-input" placeholder="Örn: 10000">
                </div>
                <div class="lab-form-group">
                    <label class="lab-form-label"><i class="fas fa-percent"></i> İşlem Başı Kâr Hedefi (%)</label>
                    <input type="number" id="labWinPct" class="lab-input" value="2">
                </div>
                <div class="lab-form-group">
                    <label class="lab-form-label"><i class="fas fa-repeat"></i> Haftalık İşlem Sayısı</label>
                    <input type="number" id="labFreq" class="lab-input" value="2">
                </div>
                <div class="lab-form-group">
                    <label class="lab-form-label"><i class="fas fa-calendar"></i> Süre (Ay)</label>
                    <input type="number" id="labDuration" class="lab-input" value="12">
                </div>
            </div>

            <button class="lab-btn-primary" onclick="runLabTest()">
                <i class="fas fa-play"></i> DENEYİ BAŞLAT
            </button>
        </div>

        <!-- Results -->
        <div id="labResults" style="display:none;">
            <div class="lab-results-card gold">
                <div class="lab-section-label" style="color: var(--lab-accent-gold);">Deney Sonucu</div>
                <div class="lab-stats-grid">
                    <div class="lab-stat-item">
                        <div class="lab-stat-label">Başlangıç</div>
                        <div class="lab-stat-value" id="resLabStart">--</div>
                    </div>
                    <div class="lab-stat-item">
                        <div class="lab-stat-label">Bitiş (Tahmini)</div>
                        <div class="lab-stat-value emerald" id="resLabEnd">--</div>
                    </div>
                </div>
                <div class="lab-big-number">
                    <div class="lab-big-number-label">Toplam Büyüme</div>
                    <div class="lab-big-number-value gold" id="resLabGrowth">+0%</div>
                </div>
            </div>

            <div class="lab-glass-card" style="margin-top: 16px;">
                <div class="lab-section-label">Aylık İlerleme Raporu</div>
                <div id="labListContainer" class="lab-monthly-report"></div>
            </div>
        </div>
    </div>

    <!-- ========== RISK TOOL ========== -->
    <div id="lab-tool-risk" class="lab-tool-container" style="display:none;">
        <div class="lab-glass-card">
            <div class="lab-tool-header">
                <div class="lab-tool-icon rose"><i class="fas fa-radiation"></i></div>
                <div class="lab-tool-info">
                    <h3>Risk & Pozisyon Yönetimi</h3>
                    <p>Portföyünün krizlere dayanıklılığını test edin</p>
                </div>
            </div>

            <!-- Chaos Room -->
            <div class="lab-section-label" style="color: var(--lab-accent-rose);">Kaos Odası</div>
            
            <select id="chaosScenario" class="lab-input lab-select lab-scenario-select" onchange="runChaosSimulation()">
                <option value="0">🔮 Senaryo Seçiniz...</option>
                <option value="crypto_winter">❄️ Kripto Kışı (Bitcoin -%60)</option>
                <option value="market_crash">📉 Küresel Borsa Çöküşü (-%35)</option>
                <option value="currency_shock">💱 Kur Şoku (Dolar +%40)</option>
                <option value="gold_rush">🥇 Güvenli Liman (Altın +%25)</option>
                <option value="black_monday">⚫ Kara Pazartesi (Her Şey -%20)</option>
            </select>

            <div id="chaosResult" style="display:none;">
                <div class="lab-stat-label">Senaryo Sonrası Tahmini Bakiye</div>
                <div class="lab-big-number">
                    <div class="lab-big-number-value" id="chaosBalance">--</div>
                </div>
                
                <div class="lab-progress-container">
                    <div id="chaosBar" class="lab-progress-fill" style="width: 100%; background: linear-gradient(90deg, #ef4444, #f59e0b);"></div>
                    <div class="lab-progress-text">
                        <span id="chaosChangeText">--</span>
                    </div>
                </div>

                <div class="lab-advice-box">
                    <i class="fas fa-lightbulb" style="color: var(--lab-accent-gold);"></i>
                    <p id="chaosAdvice">--</p>
                </div>
            </div>
        </div>

        <!-- Position Calculator -->
        <div class="lab-glass-card">
            <div class="lab-section-label">Pozisyon Hesaplama</div>

            <div style="background: rgba(0,0,0,0.2); padding: 14px; border-radius: 10px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="lab-form-label"><i class="fas fa-folder-open"></i> Portföyden Seç</span>
                    <button onclick="populateRiskAssets()" class="lab-btn-secondary"><i class="fas fa-sync-alt"></i></button>
                </div>
                <select id="riskAssetSelect" class="lab-input lab-select" onchange="fillRiskFromAsset()">
                    <option value="-1">Manuel Giriş / Seçiniz</option>
                </select>
            </div>

            <div class="lab-form-grid">
                <div class="lab-form-group">
                    <label class="lab-form-label">Sermaye (Varlık Değeri)</label>
                    <input type="number" id="riskBalance" class="lab-input" placeholder="Otomatik çekilir">
                </div>
                <div class="lab-form-group">
                    <label class="lab-form-label">Risk İştahı (%)</label>
                    <input type="number" id="riskPct" class="lab-input" value="1" placeholder="%1">
                </div>
                <div class="lab-form-group">
                    <label class="lab-form-label">Giriş Fiyatı</label>
                    <input type="number" id="riskEntry" class="lab-input" placeholder="0.00">
                </div>
                <div class="lab-form-group">
                    <label class="lab-form-label">Stop Fiyatı</label>
                    <input type="number" id="riskStop" class="lab-input" placeholder="0.00">
                </div>
            </div>

            <button class="lab-btn-primary rose" onclick="calcLabRisk()">
                <i class="fas fa-calculator"></i> POZİSYON HESAPLA
            </button>
        </div>

        <!-- Risk Results -->
        <div id="riskResultBox" style="display:none;">
            <div class="lab-results-card rose">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">
                    <div class="lab-section-label" style="color: var(--lab-accent-rose); margin: 0;">İşlem Planı</div>
                    <span style="font-size: 10px; color: var(--lab-text-muted);">STOP ZARARI: <span id="resRiskLoss" style="color: white; font-weight: 700;">--</span></span>
                </div>
                <div class="lab-stats-grid">
                    <div class="lab-stat-item">
                        <div class="lab-stat-label">Alınacak Adet</div>
                        <div class="lab-stat-value" id="resRiskQty">--</div>
                    </div>
                    <div class="lab-stat-item">
                        <div class="lab-stat-label">Gereken Nakit</div>
                        <div class="lab-stat-value gold" id="resPosSize">--</div>
                    </div>
                </div>
                <div class="lab-advice-box">
                    <i class="fas fa-wallet" style="color: var(--lab-text-secondary);"></i>
                    <p id="riskRatioText">--</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== AVERAGE DOWN TOOL ========== -->
    <div id="lab-tool-avg" class="lab-tool-container" style="display:none;">
        <div class="lab-glass-card">
            <div class="lab-tool-header">
                <div class="lab-tool-icon sky"><i class="fas fa-chess-knight"></i></div>
                <div class="lab-tool-info">
                    <h3>Akıllı Strateji Merkezi</h3>
                    <p>Sadece maliyet düşürme değil, geleceği planla ve riski yönet</p>
                </div>
            </div>

            <div style="margin-bottom: 16px;">
                <label class="lab-form-label"><i class="fas fa-folder-open"></i> Varlık Seç (Otomatik Doldur)</label>
                <select id="advAvgSelect" class="lab-input lab-select" style="margin-top: 6px;" onchange="fillAdvAvgData()">
                    <option value="-1">Manuel Giriş Yap</option>
                </select>
            </div>

            <div class="lab-mode-toggle">
    <div class="sim-tab active" onclick="switchAvgMode('budget', this)">
        <i class="fas fa-wallet"></i> Bütçe Planı
    </div>
    <div class="sim-tab" onclick="switchAvgMode('target', this)">
        <i class="fas fa-crosshairs"></i> Hedef Fiyat
    </div>
    <div class="sim-tab" onclick="switchAvgMode('auto', this)">
        <i class="fas fa-life-ring"></i> AI Kurtarıcı
    </div>
</div>


    

            <div id="avg-manual-inputs" class="lab-form-grid">
    <div class="lab-form-group">
        <label class="lab-form-label">Eldeki Adet</label>
        <input type="number" id="aaOldQty" class="lab-input" placeholder="0">
    </div>
    <div class="lab-form-group">
        <label class="lab-form-label">Maliyetim</label>
        <input type="number" id="aaOldPrice" class="lab-input" placeholder="0.00">
    </div>
    <div class="lab-form-group full">
        <label class="lab-form-label">Şu Anki Piyasa Fiyatı</label>
        <input type="number" id="aaCurPrice" class="lab-input" placeholder="Güncel fiyat">
    </div>
</div>

<hr style="border: 0; border-top: 1px solid var(--lab-glass-border); margin: 16px 0;">

            <!-- Budget Mode -->
            <div id="avg-mode-budget">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="lab-form-label" style="color: var(--lab-accent-sky);">Ne kadar ekleyebilirsin? (Nakit)</span>
                    <span id="sliderValDisplay" style="font-size: 11px; color: var(--lab-accent-sky); font-weight: 600;">0</span>
                </div>
                
                <input type="range" id="aaBudgetSlider" class="lab-range-slider" min="0" max="1000000" step="100" value="0" oninput="syncBudgetSlider('slider')">
                
                <div style="display: flex; justify-content: space-between; font-size: 9px; color: var(--lab-text-muted); margin-bottom: 12px;">
                    <span>Az</span><span>Çok</span>
                </div>

                <input type="number" id="aaBudget" class="lab-input" style="margin-bottom: 16px;" placeholder="Veya direkt tutar girin" onkeyup="syncBudgetSlider('input')">

                <button class="lab-btn-primary sky" onclick="calcAdvAvg('budget')">
                    <i class="fas fa-rocket"></i> STRATEJİYİ OLUŞTUR
                </button>
            </div>

            <!-- Target Mode -->
            <div id="avg-mode-target" style="display:none;">
                <div class="lab-form-group" style="margin-bottom: 16px;">
                    <label class="lab-form-label" style="color: var(--lab-accent-rose);">Hedeflediğin Ortalama Kaç?</label>
                    <input type="number" id="aaTarget" class="lab-input" placeholder="Örn: 50.00">
                </div>
                <button class="lab-btn-primary rose" onclick="calcAdvAvg('target')">
                    <i class="fas fa-crosshairs"></i> GEREKENİ HESAPLA
                </button>
            </div>
        </div>


<div id="avg-mode-auto" style="display:none; animation: fadeIn 0.4s;">
    
    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(6, 182, 212, 0.1)); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 16px; padding: 20px; margin-bottom: 20px; position:relative; overflow:hidden;">
        <div style="position:absolute; top:-20px; right:-20px; width:100px; height:100px; background:radial-gradient(circle, rgba(52,211,153,0.2) 0%, transparent 70%); border-radius:50%;"></div>
        
        <div style="display:flex; align-items:flex-start; gap:15px; position:relative; z-index:1;">
            <div style="min-width:44px; height:44px; background:linear-gradient(135deg, #10b981, #059669); border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; box-shadow:0 4px 15px rgba(16,185,129,0.3);">
                <i class="fas fa-brain" style="font-size:20px;"></i>
            </div>
            <div>
                <div style="font-size:15px; font-weight:800; color:white; margin-bottom:6px;">DeepScan™ Analiz Motoru</div>
                <div style="font-size:11px; color:#cbd5e1; line-height:1.5;">
                    Yapay zeka, varlıkların <b>son 90 günlük</b> verilerini tarar; RSI, Volatilite ve Trend analizi yaparak hangisinin "ölü yatırım" hangisinin "fırsat" olduğunu belirler.
                </div>
            </div>
        </div>
        <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:12px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:11px; font-weight:700; color:#94a3b8;">KULLANILABİLİR KASA</span>
            <span style="font-size:16px; font-weight:800; color:#34d399; letter-spacing:0.5px;" id="aiRescueCash">--</span>
        </div>
    </div>

    <button id="btnAiStart" class="lab-btn-primary emerald" onclick="runDeepDiveAnalysis()">
        <i class="fas fa-microchip"></i> DETAYLI ANALİZİ BAŞLAT
    </button>

    <div id="aiLoadingScreen" style="display:none; text-align:center; padding:30px 0;">
        <div style="width:50px; height:50px; border:3px solid rgba(16,185,129,0.1); border-top:3px solid #10b981; border-radius:50%; margin:0 auto 15px; animation:spin 1s linear infinite;"></div>
        <div id="aiLoadingText" style="font-size:12px; color:#34d399; font-weight:700;">Veriler toplanıyor...</div>
        <div id="aiLoadingSub" style="font-size:10px; color:#64748b; margin-top:5px;">Geçmiş grafikler inceleniyor</div>
    </div>

    <div id="aiRescueResult" style="display:none; margin-top:20px;">
        <div class="lab-section-label" style="color:#34d399; display:flex; justify-content:space-between; align-items:center;">
            <span><i class="fas fa-clipboard-check"></i> STRATEJİ RAPORU</span>
            <span style="font-size:9px; background:rgba(16,185,129,0.1); padding:2px 8px; border-radius:10px;">AI Önerisi</span>
        </div>
        <div id="aiRescueList"></div>
    </div>
</div>

        <!-- Risk Alert -->
        <div id="aaRiskAlert" class="lab-risk-alert" style="display:none;">
            <i class="fas fa-triangle-exclamation" style="font-size: 18px; color: #ef4444;"></i>
            <div>
                <div style="font-weight: 700; color: #ef4444; margin-bottom: 3px; font-size: 12px;">YÜKSEK KONSANTRASYON RİSKİ!</div>
                <div id="aaRiskMsg" style="font-size: 11px; color: #fca5a5;">--</div>
            </div>
        </div>

        <!-- Results -->
        <div id="aaResultBox" style="display:none;">
            <div class="lab-results-card sky">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div class="lab-section-label" style="color: var(--lab-accent-sky); margin: 0;">Ana Senaryo Sonucu</div>
                    <span id="aaSavingBadge" style="padding: 3px 8px; border-radius: 5px; font-size: 9px; font-weight: 700; background: var(--lab-accent-emerald-dim); color: var(--lab-accent-emerald);">--</span>
                </div>

                <div class="lab-big-number">
                    <div class="lab-big-number-label">Yeni Ortalamanız</div>
                    <div class="lab-big-number-value" id="aaResAvg" style="font-size: 32px;">--</div>
                    <div style="display: flex; justify-content: center; gap: 10px; margin-top: 6px; align-items: center;">
                        <span style="font-size: 12px; color: var(--lab-accent-rose); text-decoration: line-through;" id="aaResOldAvg">--</span>
                        <i class="fas fa-arrow-right" style="font-size: 9px; color: var(--lab-text-muted);"></i>
                        <span id="aaResDiff" style="font-size: 11px; font-weight: 700; color: var(--lab-accent-emerald); background: var(--lab-accent-emerald-dim); padding: 3px 8px; border-radius: 100px;">--</span>
                    </div>
                </div>

                <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 14px; margin-top: 16px; font-size: 11px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--lab-text-muted);">Alınacak Adet:</span>
                        <span style="font-weight: 700; color: white;" id="aaResQty">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--lab-text-muted);">Gereken Nakit:</span>
                        <span style="font-weight: 700; color: var(--lab-accent-gold);" id="aaResCost">--</span>
                    </div>
                    <div style="border-top: 1px solid var(--lab-glass-border); padding-top: 8px; display: flex; justify-content: space-between;">
                        <span style="color: var(--lab-text-muted);">Yeni Toplam Maliyet:</span>
                        <span style="font-weight: 700;" id="aaResTotal">--</span>
                    </div>
                </div>

                <div id="aaBreakEvenMsg" style="margin-top: 12px; text-align: center; font-size: 11px; color: var(--lab-accent-sky); background: var(--lab-accent-sky-dim); padding: 10px; border-radius: 8px;"></div>

                <!-- Strategy Steps -->
                <div id="aaStrategyBox" style="margin-top: 18px; border-top: 1px solid var(--lab-glass-border); padding-top: 14px;">
                    <div class="lab-section-label" style="color: var(--lab-accent-sky);">
                        <i class="fas fa-layer-group"></i> Profesyonel Kademeli Alım Planı
                    </div>
                    <p style="font-size: 10px; color: var(--lab-text-muted); margin-bottom: 12px;">Paranı tek seferde harcamak yerine, düşüşleri fırsata çevir:</p>
                    <div id="strategyStepsContainer"></div>
                </div>

                <button onclick="saveCurrentScenario()" class="lab-btn-secondary" style="width: 100%; margin-top: 16px; justify-content: center;">
                    <i class="fas fa-bookmark"></i> Bu Senaryoyu İzleme Listeme Kaydet
                </button>

                <div style="margin-top: 20px; padding-top: 14px; border-top: 1px dashed var(--lab-glass-border);">
                    <div style="font-size: 10px; font-weight: 700; color: var(--lab-text-muted); margin-bottom: 10px;">
                        <i class="fas fa-folder-open"></i> KAYITLI STRATEJİLERİM
                    </div>
                    <div id="savedStrategiesList">
                        <div style="text-align: center; font-size: 10px; color: var(--lab-text-muted); opacity: 0.5;">Henüz kayıtlı plan yok.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== TIME MACHINE TOOL ========== -->
    <div id="lab-tool-time" class="lab-tool-container" style="display:none;">
    
    <div class="lab-glass-card" style="border: 1px solid rgba(139, 92, 246, 0.3); background: linear-gradient(145deg, rgba(15, 23, 42, 0.9), rgba(20, 10, 40, 0.95)); box-shadow: 0 0 40px rgba(139, 92, 246, 0.1);">
        <div class="lab-tool-header" style="margin-bottom: 15px;">
            <div class="lab-tool-icon violet" style="width:44px; height:44px; font-size:20px; box-shadow: 0 0 15px #8b5cf6;">
                <i class="fas fa-atom fa-spin" style="--fa-animation-duration: 4s;"></i>
            </div>
            <div class="lab-tool-info">
                <h3 style="color: #e9d5ff; font-family: 'Inter', sans-serif; letter-spacing: 1px;">TIME MACHINE<span style="font-size:9px; color:#a78bfa; margin-left:5px; border:1px solid #a78bfa; padding:1px 4px; border-radius:4px;">PRO</span></h3>
                <p style="color: #a78bfa;">Yapay Zeka Destekli Gelecek Simülasyonu</p>
            </div>
        </div>

        <div style="display:flex; gap:10px; align-items:flex-end;">
            <div style="flex:1;">
                <label class="lab-form-label" style="color:#a78bfa; font-size:10px; margin-bottom:4px;">VARLIK SEÇ</label>
                <select id="timeMachineSelect" class="lab-input lab-select" onchange="fillTimeMachineSymbol()" style="background:rgba(0,0,0,0.4); border-color:rgba(139,92,246,0.3); color:white;">
                    <option value="-1">Manuel Giriş</option>
                </select>
            </div>
            <div style="flex:1;">
                <label class="lab-form-label" style="color:#a78bfa; font-size:10px; margin-bottom:4px;">SEMBOL</label>
                <input type="text" id="statSymbol" class="lab-input" placeholder="BTC..." style="background:rgba(0,0,0,0.4); border-color:rgba(139,92,246,0.3); color:#fff; font-weight:800; letter-spacing:1px; text-transform:uppercase;">
            </div>
            <button onclick="runStatisticalAnalysis()" class="lab-btn-primary violet" style="width:50px; height:46px; border-radius:12px; font-size:18px; padding:0; background: linear-gradient(135deg, #7c3aed, #db2777); box-shadow: 0 0 20px rgba(219, 39, 119, 0.4);">
                <i class="fas fa-power-off"></i>
            </button>
        </div>
    </div>

    <div id="statResult" style="display:none; margin-top:20px; animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);">
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-bottom:20px;">
            <div class="lab-glass-card" style="padding:15px; text-align:center; background:rgba(20,20,30,0.6); margin:0; border:1px solid rgba(255,255,255,0.05);">
                <div style="font-size:10px; color:#94a3b8; letter-spacing:1px; margin-bottom:10px;">VOLATİLİTE RİSKİ</div>
                <div style="position:relative; width:80px; height:40px; margin:0 auto; overflow:hidden;">
                    <div id="gaugeRiskBg" style="width:80px; height:80px; background:conic-gradient(from 180deg, #10b981 0deg, #f59e0b 90deg, #ef4444 180deg); border-radius:50%;"></div>
                    <div style="position:absolute; top:5px; left:5px; width:70px; height:70px; background:#131316; border-radius:50%;"></div>
                    <div id="gaugeRiskNeedle" style="position:absolute; bottom:0; left:50%; width:2px; height:35px; background:white; transform-origin:bottom center; transform:rotate(-90deg); transition: transform 1s cubic-bezier(0.34, 1.56, 0.64, 1);"></div>
                </div>
                <div id="gaugeRiskText" style="font-size:16px; font-weight:800; color:white; margin-top:5px;">--</div>
            </div>

            <div class="lab-glass-card" style="padding:15px; text-align:center; background:rgba(20,20,30,0.6); margin:0; border:1px solid rgba(255,255,255,0.05);">
                <div style="font-size:10px; color:#94a3b8; letter-spacing:1px; margin-bottom:10px;">HACİM İLGİSİ</div>
                <div style="position:relative; width:80px; height:40px; margin:0 auto; overflow:hidden;">
                    <div id="gaugeVolBg" style="width:80px; height:80px; background:conic-gradient(from 180deg, #64748b 0deg, #3b82f6 90deg, #d946ef 180deg); border-radius:50%;"></div>
                    <div style="position:absolute; top:5px; left:5px; width:70px; height:70px; background:#131316; border-radius:50%;"></div>
                    <div id="gaugeVolNeedle" style="position:absolute; bottom:0; left:50%; width:2px; height:35px; background:white; transform-origin:bottom center; transform:rotate(-90deg); transition: transform 1s cubic-bezier(0.34, 1.56, 0.64, 1);"></div>
                </div>
                <div id="gaugeVolText" style="font-size:16px; font-weight:800; color:white; margin-top:5px;">--</div>
            </div>
        </div>

        <div class="lab-section-label" style="color:#d8b4fe; margin-left:10px;"><i class="fas fa-road"></i> OLASILIK YOLCULUĞU</div>
        <div id="projectionList" style="position:relative; padding-left:20px; border-left:2px dashed rgba(139, 92, 246, 0.3); margin-left:10px;"></div>

        <div class="lab-glass-card" style="margin-top:25px; padding:0; overflow:hidden;">
            <div style="padding:10px 15px; background:rgba(255,255,255,0.03); font-size:10px; font-weight:700; color:#94a3b8;">
                <i class="fas fa-database"></i> KARA KUTU VERİLERİ (GEÇMİŞ)
            </div>
            <div style="overflow-x:auto;">
                <table class="lab-data-table">
                    <thead>
                        <tr style="background:rgba(0,0,0,0.2);">
                            <th style="color:#a78bfa;">YIL</th>
                            <th style="color:#fff;">FİYAT</th>
                            <th style="color:#10b981;">TEPE</th>
                            <th style="color:#ef4444;">DİP</th>
                            <th style="color:#f59e0b;">M.CAP</th> <th style="color:#38bdf8;">HACİM</th>
                            <th style="color:#fff;">DEĞİŞİM</th> </tr>
                    </thead>
                    <tbody id="statTableBody"></tbody>
                </table>
            </div>
        </div>

    </div>
</div>

    <!-- ========== CHAOS TOOL (empty placeholder) ========== -->
    <div id="lab-tool-chaos" class="lab-tool-container" style="display:none;"></div>

    <!-- ========== POSITION WIZARD TOOL ========== -->
    <div id="lab-tool-pos" class="lab-tool-container" style="display:none;">
        <div class="lab-glass-card">
            <div class="lab-tool-header">
                <div class="lab-tool-icon emerald"><i class="fas fa-wand-magic-sparkles"></i></div>
                <div class="lab-tool-info">
                    <h3>Risk Sihirbazı</h3>
                    <p>Yapay zeka destekli kasa ve risk yönetimi</p>
                </div>
            </div>

            <!-- DNA Card -->
            <div id="dnaCard" class="lab-dna-card" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span style="font-size: 9px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; color: var(--lab-text-muted);">Sistemin Senin Hakkındaki Görüşü</span>
                    <span id="dnaType" class="lab-dna-type moderate">ANALİZ EDİLİYOR...</span>
                </div>
                <p id="dnaMsg" style="font-size: 12px; line-height: 1.5; color: var(--lab-text-secondary);">Veriler yükleniyor...</p>
            </div>

            <div class="lab-form-group" style="margin-bottom: 14px;">
                <label class="lab-form-label"><i class="fas fa-vault"></i> Toplam Kasa (Sermaye)</label>
                <div style="display: flex; gap: 8px; margin-top: 6px;">
                    <input type="number" id="posBalance" class="lab-input" placeholder="Toplam paranız (TL/$)" onkeyup="calcPositionSize()">
                    <button onclick="fillPosBalance()" class="lab-btn-secondary" style="padding: 12px 16px;"><i class="fas fa-wallet"></i></button>
                </div>
            </div>

            <div class="lab-form-grid">
                <div class="lab-form-group">
                    <label class="lab-form-label">Risk (%)</label>
                    <select id="posRiskPct" class="lab-input lab-select" onchange="calcPositionSize()">
                        <option value="1">%1 (Profesyonel)</option>
                        <option value="2" selected>%2 (Standart)</option>
                        <option value="3">%3 (Agresif)</option>
                        <option value="5">%5 (Kumarbaz)</option>
                    </select>
                </div>
                <div class="lab-form-group">
                    <label class="lab-form-label">Stop Uzaklığı (%)</label>
                    <input type="number" id="posStopDist" class="lab-input" placeholder="% Örn: 5" value="5" onkeyup="calcPositionSize()">
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="lab-results-card emerald">
            <div class="lab-stats-grid">
                <div class="lab-stat-item">
                    <div class="lab-stat-label">Güvenli İşlem Büyüklüğü</div>
                    <div class="lab-stat-value" id="posResultSize" style="font-size: 20px;">0 ₺</div>
                </div>
                <div class="lab-stat-item">
                    <div class="lab-stat-label">Maksimum Kayıp Riski</div>
                    <div class="lab-stat-value rose" id="posResultRisk" style="font-size: 18px;">0 ₺</div>
                </div>
            </div>

            <div class="lab-advice-box" style="background: var(--lab-accent-emerald-dim); border: 1px solid rgba(52, 211, 153, 0.2);">
                <i class="fas fa-check-circle" style="color: var(--lab-accent-emerald);"></i>
                <p style="color: var(--lab-accent-emerald);">Psikolojini bozmamak için işleme bu tutarla girmelisin.</p>
            </div>
        </div>
    </div>

    </div> <!-- lab-content kapanışı -->

</div>

<script>
// TÜM LAB SONUÇ EKRANLARINI TEMİZLEYEN FONKSİYON
function resetAllLabResults() {
    const resultIds = [
        'aiRescueResult',    // AI Kurtarıcı Sonuçları
        'aaResultBox',       // Maliyet Düşürme Sonuçları
        'labResults',        // Büyüme Hesaplayıcı
        'riskResultBox',     // Risk Hesaplayıcı  
        'statResult',        // Zaman Makinesi
        'chaosResult',       // Kaos Testi
        'aiLoadingScreen'    // Yükleme ekranı
    ];
    
    resultIds.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.style.display = 'none';
    });
    
    // AI listesini temizle
    const aiList = document.getElementById('aiRescueList');
    if(aiList) aiList.innerHTML = '';
    
    // Risk alert'i temizle
    const riskAlert = document.getElementById('aaRiskAlert');
    if(riskAlert) riskAlert.style.display = 'none';
    
    // AI Başlat butonunu sıfırla
    const btnAiStart = document.getElementById('btnAiStart');
    if(btnAiStart) {
        btnAiStart.style.display = 'flex';
        btnAiStart.innerHTML = '<i class="fas fa-brain"></i> ANALİZİ BAŞLAT';
    }
}

// Lab'ı kapatıp Analiz sayfasına dön
function closeLabView() {
    // ÖNCELİKLE TÜM SONUÇ EKRANLARINI TEMİZLE
    resetAllLabResults();
    
    // Lab'ı gizle
    const labView = document.getElementById('an-view-lab');
    labView.style.display = 'none';
    
    // Body scroll'u geri aç
    document.body.style.overflow = '';
    
    // AR-GE tabını pasif yap ve başka bir taba (PERFORMANS) tıkla
    const tabs = document.querySelectorAll('.chart-filter-btn, .an-tab-btn, .tab-btn');
    tabs.forEach(tab => {
        const text = tab.textContent.trim().toUpperCase();
        if (text.includes('PERFORMANS') || text.includes('PERFORM')) {
            tab.click();
        }
    });
    
    // Alternatif: Eğer switchLabTool varsa onu kullan
    if (typeof switchLabTool === 'function') {
        // Hiçbir şey yapma, tab tıklaması yeterli
    }
    
    // Analiz view'ı göster
    const analizViews = document.querySelectorAll('[id*="analiz"], [id*="analysis"], [id*="perform"]');
    analizViews.forEach(view => {
        if (!view.id.includes('lab')) {
            view.style.display = 'block';
        }
    });
}

// Lab açıldığında çağrılacak fonksiyon (opsiyonel)
function openLabFullscreen() {
    const labView = document.getElementById('an-view-lab');
    labView.style.display = 'block';
    
    // Scroll'u en üste al
    const content = labView.querySelector('.lab-content');
    if (content) content.scrollTop = 0;
}
</script>

 
    <div id="an-view-psycho" class="an-view-section" style="display:none;">
        
    
    <div class="psycho-hub-container">
        
        <div class="psycho-header">
            <div class="psycho-title">
                <i class="fas fa-brain"></i>
                YATIRIMCI ZEKA MERKEZİ
            </div>
            <div style="font-size: 11px; color: #64748b;">AI Powered Logic</div>
        </div>
        

        <div class="psycho-tabs">
            <button class="p-tab-btn active" onclick="switchPsychoTab('tab-karne')">
                <i class="fa-solid fa-brain"></i> Zeka
            </button>
            <button class="p-tab-btn" onclick="switchPsychoTab('tab-regret')">
                <i class="fa-solid fa-ghost"></i> Pişmanlık
            </button>
            <button class="p-tab-btn" onclick="switchPsychoTab('tab-fomo')">
                <i class="fa-solid fa-fire"></i> FOMO
            </button>
            <button class="p-tab-btn" onclick="switchPsychoTab('tab-coach')">
                <i class="fa-solid fa-robot"></i> AI Koç
            </button>
        </div>

        <div class="psycho-content-area">
            
            <!-- ZEKA SEKMESİ - ORİJİNAL + NABIZ + PATTERN -->
            <div id="tab-karne" class="psycho-view active">
                <!-- ORİJİNAL KARNE ALANI -->
                <div id="inject-winrate-modern">
                    <div style="text-align:center; color:#64748b; padding:20px;">
                        <i class="fas fa-circle-notch fa-spin"></i> Veri toplanıyor...
                    </div>
                </div>

                <!-- KİŞİSEL AÇGÖZLÜLÜK ENDEKSİ -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 10px; color: #64748b; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-heart-pulse"></i> KİŞİSEL AÇGÖZLÜLÜK ENDEKSİ
                        <span style="font-size: 8px; background: rgba(139,92,246,0.2); color: #a78bfa; padding: 2px 6px; border-radius: 10px; margin-left: auto;">Senin Verilerin</span>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(239,68,68,0.08), rgba(16,185,129,0.08)); border-radius: 12px; padding: 12px; border: 1px solid rgba(255,255,255,0.05);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="text-align: center; min-width: 55px;">
                                <div style="font-size: 26px; font-weight: 800;" id="nabizScore">50</div>
                                <div style="font-size: 9px;" id="nabizLabel">Nötr</div>
                            </div>
                            <div style="flex: 1;">
                                <div style="width: 100%; height: 8px; background: linear-gradient(to right, #ef4444 0%, #f59e0b 50%, #10b981 100%); border-radius: 10px; position: relative;">
                                    <div id="nabizNeedle" style="position: absolute; top: -4px; width: 4px; height: 16px; background: white; border-radius: 2px; box-shadow: 0 0 8px rgba(255,255,255,0.9); left: 50%; transition: left 0.5s ease;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 8px; color: #64748b; margin-top: 5px;">
                                    <span>😱 Aşırı Korku</span>
                                    <span>😐 Nötr</span>
                                    <span>🤑 Aşırı Açgözlü</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DAVRANIŞ PATTERNLERİ -->
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 10px; color: #64748b; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-fingerprint"></i> DAVRANIŞ PATTERNLERİ
                    </div>
                    <div id="patternCards" style="display: flex; flex-direction: column; gap: 8px;">
                        <div style="text-align:center; color:#64748b; padding:10px; font-size: 11px;">
                            <i class="fas fa-circle-notch fa-spin"></i> Analiz ediliyor...
                        </div>
                    </div>
                </div>
            </div>

            <!-- PİŞMANLIK SEKMESİ - ORİJİNAL -->
            <div id="tab-regret" class="psycho-view">
                <div style="margin-bottom:15px; font-size:12px; color:#94a3b8; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                    <i class="fa-solid fa-circle-info"></i> "Keşke satmasaydım" veya "İyi ki satmışım" dediğiniz işlemlerin analizi.
                </div>
                <div id="inject-regret-modern"></div>
            </div>

            <!-- FOMO SEKMESİ - ORİJİNAL -->
            <div id="tab-fomo" class="psycho-view">
                <div id="inject-fomo-modern"></div>
            </div>

            <!-- AI KOÇ SEKMESİ -->
            <div id="tab-coach" class="psycho-view">
                <!-- AI Profil Kartı -->
                <div style="background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); border-radius: 16px; overflow: hidden; margin-bottom: 12px; border: 1px solid rgba(139,92,246,0.2);">
                    <!-- Header -->
                    <div style="background: rgba(139,92,246,0.15); padding: 12px 15px; display: flex; align-items: center; gap: 12px;">
                        <div style="width: 42px; height: 42px; background: linear-gradient(135deg, #8b5cf6, #6366f1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 15px rgba(139,92,246,0.3);">🧠</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #fff; font-size: 14px;">TradeVia AI Koç</div>
                            <div style="font-size: 9px; color: #a78bfa;">Tüm davranışlarını analiz ediyorum</div>
                        </div>
                        <div id="aiDataCount" style="background: rgba(16,185,129,0.2); padding: 4px 8px; border-radius: 8px; font-size: 9px; color: #10b981; font-weight: 600;">
                            0 veri
                        </div>
                    </div>
                    
                    <!-- Ana Mesaj -->
                    <div id="aiCoachMessage" style="padding: 15px; font-size: 12px; color: #e2e8f0; line-height: 1.7; min-height: 80px;">
                        <i class="fas fa-circle-notch fa-spin" style="color: #64748b;"></i> <span style="color: #64748b;">Veriler analiz ediliyor...</span>
                    </div>
                    
                    <!-- Profil Özeti -->
                    <div style="background: rgba(0,0,0,0.2); padding: 10px 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; border-top: 1px solid rgba(255,255,255,0.05);">
                        <div style="text-align: center;">
                            <div style="font-size: 14px; font-weight: 800; color: #fff;" id="aiTraderType">-</div>
                            <div style="font-size: 7px; color: #64748b;">Trader Tipi</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 14px; font-weight: 800;" id="aiRiskLevel">-</div>
                            <div style="font-size: 7px; color: #64748b;">Risk Seviyesi</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 14px; font-weight: 800;" id="aiFocusArea">-</div>
                            <div style="font-size: 7px; color: #64748b;">Odak Alanı</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 14px; font-weight: 800;" id="aiScore">-</div>
                            <div style="font-size: 7px; color: #64748b;">AI Skor</div>
                        </div>
                    </div>
                </div>

                <!-- Kullanım İstatistikleri -->
                <div style="background: rgba(255,255,255,0.02); border-radius: 12px; padding: 12px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 10px; color: #64748b; margin-bottom: 10px; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-chart-bar"></i> KULLANIM ANALİZİ
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        <div style="background: rgba(59,130,246,0.1); border-radius: 8px; padding: 10px; text-align: center;">
                            <div style="font-size: 16px; font-weight: 800; color: #3b82f6;" id="statMostUsedFeature">-</div>
                            <div style="font-size: 8px; color: #64748b;">En Çok Kullanılan</div>
                        </div>
                        <div style="background: rgba(245,158,11,0.1); border-radius: 8px; padding: 10px; text-align: center;">
                            <div style="font-size: 16px; font-weight: 800; color: #f59e0b;" id="statMostSearched">-</div>
                            <div style="font-size: 8px; color: #64748b;">En Çok Aranan</div>
                        </div>
                        <div style="background: rgba(16,185,129,0.1); border-radius: 8px; padding: 10px; text-align: center;">
                            <div style="font-size: 16px; font-weight: 800; color: #10b981;" id="statTimeSpent">-</div>
                            <div style="font-size: 8px; color: #64748b;">Aktif Süre</div>
                        </div>
                    </div>
                </div>

                <!-- Detaylı Analiz Butonları -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button onclick="runAIAnalysis('strength')" style="padding: 14px 10px; background: linear-gradient(135deg, rgba(16,185,129,0.12), rgba(16,185,129,0.05)); border: 1px solid rgba(16,185,129,0.25); border-radius: 12px; color: #10b981; font-size: 10px; font-weight: 700; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-shield-alt" style="font-size: 16px; display: block; margin-bottom: 5px;"></i>
                        Güçlü Yönlerin
                    </button>
                    <button onclick="runAIAnalysis('weakness')" style="padding: 14px 10px; background: linear-gradient(135deg, rgba(239,68,68,0.12), rgba(239,68,68,0.05)); border: 1px solid rgba(239,68,68,0.25); border-radius: 12px; color: #ef4444; font-size: 10px; font-weight: 700; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 16px; display: block; margin-bottom: 5px;"></i>
                        Zayıf Yönlerin
                    </button>
                    <button onclick="runAIAnalysis('behavior')" style="padding: 14px 10px; background: linear-gradient(135deg, rgba(139,92,246,0.12), rgba(139,92,246,0.05)); border: 1px solid rgba(139,92,246,0.25); border-radius: 12px; color: #8b5cf6; font-size: 10px; font-weight: 700; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-user-secret" style="font-size: 16px; display: block; margin-bottom: 5px;"></i>
                        Davranış Raporu
                    </button>
                    <button onclick="runAIAnalysis('advice')" style="padding: 14px 10px; background: linear-gradient(135deg, rgba(245,158,11,0.12), rgba(245,158,11,0.05)); border: 1px solid rgba(245,158,11,0.25); border-radius: 12px; color: #f59e0b; font-size: 10px; font-weight: 700; cursor: pointer; transition: all 0.2s;">
                        <i class="fas fa-lightbulb" style="font-size: 16px; display: block; margin-bottom: 5px;"></i>
                        Kişisel Tavsiyeler
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div style="height: 100px; width: 100%; clear: both;"></div>

</div>

</div>

<!-- ============================================
     TRADEVIA PREMIUM AYARLAR SAYFASI
  
     ============================================ -->

<style>
    @keyframes goldGlow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
</style>
<div id="page-settings" class="page" style="
    padding: 0;
    min-height: 100vh;
    color: #e0e0e0;
    /* Siyah, Koyu Gri ve Altın Tozu Rengi */
    background: linear-gradient(-45deg, #000000, #1c1910, #000000, #2b2200);
    background-size: 400% 400%;
    animation: goldGlow 10s ease infinite;
">

    
    
    
    
    <!-- Ambient Background Orbs -->
    <div style="position:fixed; inset:0; pointer-events:none; z-index:0; overflow:hidden;">
        <div style="position:absolute; width:500px; height:500px; background:radial-gradient(circle, rgba(255,214,10,0.15) 0%, transparent 70%); top:-200px; right:-150px; border-radius:50%; filter:blur(100px); opacity:0.5; animation:orbFloat1 25s ease-in-out infinite;"></div>
        <div style="position:absolute; width:400px; height:400px; background:radial-gradient(circle, rgba(10,132,255,0.12) 0%, transparent 70%); bottom:10%; left:-150px; border-radius:50%; filter:blur(100px); opacity:0.5; animation:orbFloat2 30s ease-in-out infinite;"></div>
        <div style="position:absolute; width:300px; height:300px; background:radial-gradient(circle, rgba(48,209,88,0.1) 0%, transparent 70%); top:50%; right:-100px; border-radius:50%; filter:blur(100px); opacity:0.5; animation:orbFloat3 20s ease-in-out infinite;"></div>
    </div>
    
    <style>
        @keyframes orbFloat1 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(-30px, 40px) scale(1.1); }
            50% { transform: translate(20px, -20px) scale(0.9); }
            75% { transform: translate(-40px, -30px) scale(1.05); }
        }
        @keyframes orbFloat2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(50px, -40px) scale(1.15); }
            66% { transform: translate(-30px, 30px) scale(0.95); }
        }
        @keyframes orbFloat3 {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-40px, 40px) rotate(180deg); }
        }
        
        /* Premium Settings Styles */
        #page-settings .ps-container { position:relative; z-index:1; max-width:480px; margin:0 auto; padding:20px 20px 120px; }
        
        /* Profile Hero */
        #page-settings .ps-profile-hero {
            position:relative; background:#131316; border:1px solid rgba(255,255,255,0.08);
            border-radius:24px; padding:24px; margin-bottom:16px; overflow:hidden;
            cursor:pointer; transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #page-settings .ps-profile-hero::before {
            content:''; position:absolute; top:0; left:0; right:0; height:100px;
            background:linear-gradient(135deg, #FFD60A 0%, #FF9500 50%, #FF6B00 100%);
            opacity:0.08; mask-image:linear-gradient(180deg, black 0%, transparent 100%);
            -webkit-mask-image:linear-gradient(180deg, black 0%, transparent 100%);
        }
        #page-settings .ps-profile-hero:hover { border-color:rgba(255,255,255,0.12); transform:translateY(-2px); box-shadow:0 8px 32px rgba(0,0,0,0.6); }
        #page-settings .ps-profile-hero:active { transform:translateY(0) scale(0.99); }
        
        #page-settings .ps-profile-content { position:relative; display:flex; align-items:center; gap:18px; }
        #page-settings .ps-avatar-wrap { position:relative; flex-shrink:0; }
        #page-settings .ps-avatar { width:72px; height:72px; border-radius:20px; object-fit:cover; border:2px solid rgba(255,255,255,0.08); transition:all 0.25s; }
        #page-settings .ps-profile-hero:hover .ps-avatar { border-color:#FFD60A; box-shadow:0 0 20px rgba(255,214,10,0.2); }
        #page-settings .ps-status-dot { position:absolute; bottom:2px; right:2px; width:18px; height:18px; background:#30D158; border:3px solid #131316; border-radius:50%; }
        #page-settings .ps-profile-info { flex:1; min-width:0; }
        #page-settings .ps-profile-name { font-size:20px; font-weight:700; color:#fff; margin-bottom:6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        #page-settings .ps-badge { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:9999px; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; }
        #page-settings .ps-badge.free { background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); color:rgba(255,255,255,0.72); }
        #page-settings .ps-badge.pro { background:linear-gradient(135deg, #FFD60A 0%, #FF9500 100%); color:#000; border:none; box-shadow:0 4px 16px rgba(255,214,10,0.3); }
        #page-settings .ps-badge i { font-size:10px; }
        #page-settings .ps-arrow { width:40px; height:40px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.04); border-radius:12px; color:rgba(255,255,255,0.48); font-size:14px; transition:all 0.25s; }
        #page-settings .ps-profile-hero:hover .ps-arrow { background:rgba(255,255,255,0.06); color:#fff; transform:translateX(4px); }
        
        /* Kompakt Membership Button */
        #page-settings .ps-membership-btn {
            display:flex; align-items:center; justify-content:space-between;
            background:linear-gradient(135deg, rgba(255,214,10,0.1) 0%, rgba(255,149,0,0.05) 100%);
            border:1px solid rgba(255,214,10,0.25); border-radius:16px;
            padding:14px 18px; margin-bottom:24px; cursor:pointer;
            transition:all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #page-settings .ps-membership-btn:hover {
            border-color:rgba(255,214,10,0.4);
            box-shadow:0 0 30px rgba(255,214,10,0.15);
            transform:translateY(-1px);
        }
        #page-settings .ps-membership-btn:active { transform:scale(0.99); }
        #page-settings .ps-membership-btn-left { display:flex; align-items:center; gap:12px; }
        #page-settings .ps-membership-btn-icon {
            width:36px; height:36px; border-radius:10px;
            background:linear-gradient(135deg, #FFD60A 0%, #FF9500 100%);
            display:flex; align-items:center; justify-content:center;
            font-size:16px; color:#000;
        }
        #page-settings .ps-membership-btn-text { font-size:14px; font-weight:600; color:#fff; }
        #page-settings .ps-membership-btn-sub { font-size:11px; color:rgba(255,255,255,0.5); }
        #page-settings .ps-membership-btn-arrow { color:#FFD60A; font-size:14px; }
        
        /* PRO durumunda buton */
        #page-settings .ps-membership-btn.is-pro {
            background:linear-gradient(135deg, rgba(48,209,88,0.1) 0%, rgba(16,185,129,0.05) 100%);
            border-color:rgba(48,209,88,0.25);
        }
        #page-settings .ps-membership-btn.is-pro:hover {
            border-color:rgba(48,209,88,0.4);
            box-shadow:0 0 30px rgba(48,209,88,0.15);
        }
        #page-settings .ps-membership-btn.is-pro .ps-membership-btn-icon {
            background:linear-gradient(135deg, #30D158 0%, #00A040 100%);
        }
        #page-settings .ps-membership-btn.is-pro .ps-membership-btn-arrow { color:#30D158; }
        
        /* Premium Modal Overlay */
        #page-settings .ps-modal-overlay {
            position:fixed; inset:0; background:rgba(0,0,0,0.85);
            backdrop-filter:blur(10px); -webkit-backdrop-filter:blur(10px);
            z-index:9999; display:none; align-items:center; justify-content:center;
            padding:20px; opacity:0; transition:opacity 0.3s ease;
        }
        #page-settings .ps-modal-overlay.active { display:flex; opacity:1; }
        
        /* Premium Modal */
        #page-settings .ps-premium-modal {
            width:100%; max-width:360px; background:#131316;
            border:1px solid rgba(255,255,255,0.1); border-radius:28px;
            overflow:hidden; position:relative;
            transform:scale(0.9) translateY(20px);
            transition:transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #page-settings .ps-modal-overlay.active .ps-premium-modal {
            transform:scale(1) translateY(0);
        }
        
        /* Modal Header */
        #page-settings .ps-modal-header {
            position:relative; padding:30px 24px 20px; text-align:center;
            background:linear-gradient(180deg, rgba(255,214,10,0.15) 0%, transparent 100%);
        }
        #page-settings .ps-modal-close {
            position:absolute; top:16px; right:16px;
            width:32px; height:32px; border-radius:50%;
            background:rgba(255,255,255,0.1); border:none;
            color:#fff; font-size:14px; cursor:pointer;
            display:flex; align-items:center; justify-content:center;
            transition:all 0.2s;
        }
        #page-settings .ps-modal-close:hover { background:rgba(255,255,255,0.15); transform:rotate(90deg); }
        
        #page-settings .ps-modal-icon {
            width:72px; height:72px; margin:0 auto 16px;
            background:linear-gradient(135deg, #FFD60A 0%, #FF9500 50%, #FF6B00 100%);
            border-radius:20px; display:flex; align-items:center; justify-content:center;
            font-size:32px; color:#000; box-shadow:0 12px 40px rgba(255,214,10,0.4);
        }
        #page-settings .ps-modal-title { font-size:24px; font-weight:800; color:#fff; margin-bottom:8px; }
        #page-settings .ps-modal-subtitle { font-size:14px; color:rgba(255,255,255,0.6); }
        
        /* Modal Body */
        #page-settings .ps-modal-body { padding:24px; }
        
        /* Features List */
        #page-settings .ps-features-list { margin-bottom:24px; }
        #page-settings .ps-feature-item {
            display:flex; align-items:center; gap:14px;
            padding:14px 0; border-bottom:1px solid rgba(255,255,255,0.05);
        }
        #page-settings .ps-feature-item:last-child { border-bottom:none; }
        #page-settings .ps-feature-icon {
            width:40px; height:40px; border-radius:12px;
            background:rgba(255,214,10,0.1); border:1px solid rgba(255,214,10,0.2);
            display:flex; align-items:center; justify-content:center;
            font-size:16px; color:#FFD60A; flex-shrink:0;
        }
        #page-settings .ps-feature-text { flex:1; }
        #page-settings .ps-feature-title { font-size:14px; font-weight:600; color:#fff; margin-bottom:2px; }
        #page-settings .ps-feature-desc { font-size:12px; color:rgba(255,255,255,0.5); }
        
        /* Upgrade Button */
        #page-settings .ps-modal-upgrade-btn {
            width:100%; padding:18px 24px;
            background:linear-gradient(135deg, #FFD60A 0%, #FF9500 100%);
            border:none; border-radius:16px; font-family:inherit;
            font-size:16px; font-weight:700; color:#000; cursor:pointer;
            display:flex; align-items:center; justify-content:center; gap:10px;
            transition:all 0.25s; box-shadow:0 8px 32px rgba(255,214,10,0.3);
        }
        #page-settings .ps-modal-upgrade-btn:hover {
            transform:translateY(-2px);
            box-shadow:0 12px 40px rgba(255,214,10,0.4);
        }
        #page-settings .ps-modal-upgrade-btn:active { transform:scale(0.98); }
        
        /* Downgrade Button */
        #page-settings .ps-modal-downgrade-btn {
            width:100%; padding:14px; margin-top:12px;
            background:rgba(255,69,58,0.1); border:1px solid rgba(255,69,58,0.2);
            border-radius:12px; font-family:inherit; font-size:14px;
            font-weight:600; color:#FF453A; cursor:pointer;
            display:none; transition:all 0.2s;
        }
        #page-settings .ps-modal-downgrade-btn:hover { background:rgba(255,69,58,0.15); }
        
        /* PRO Active State */
        #page-settings .ps-modal-header.is-pro { background:linear-gradient(180deg, rgba(48,209,88,0.15) 0%, transparent 100%); }
        #page-settings .ps-modal-header.is-pro .ps-modal-icon {
            background:linear-gradient(135deg, #30D158 0%, #00A040 100%);
            box-shadow:0 12px 40px rgba(48,209,88,0.4);
        }
        #page-settings .ps-feature-item.active .ps-feature-icon {
            background:rgba(48,209,88,0.15); border-color:rgba(48,209,88,0.3); color:#30D158;
        }
        #page-settings .ps-feature-item.active .ps-feature-title::after {
            content:' ✓'; color:#30D158;
        }
        
        /* Section Label */
        #page-settings .ps-section-label { font-size:12px; font-weight:600; color:rgba(255,255,255,0.32); text-transform:uppercase; letter-spacing:1px; padding:0 4px; margin-bottom:12px; }
        
        /* Menu List */
        #page-settings .ps-menu-list { background:#131316; border:1px solid rgba(255,255,255,0.04); border-radius:20px; overflow:hidden; margin-bottom:32px; }
        #page-settings .ps-menu-item {
            display:flex; align-items:center; padding:16px 18px; cursor:pointer;
            transition:all 0.15s; border-bottom:1px solid rgba(255,255,255,0.04); position:relative;
        }
        #page-settings .ps-menu-item:last-child { border-bottom:none; }
        #page-settings .ps-menu-item::before { content:''; position:absolute; inset:0; background:rgba(255,255,255,0.08); opacity:0; transition:opacity 0.15s; }
        #page-settings .ps-menu-item:hover::before { opacity:1; }
        #page-settings .ps-menu-item:active { transform:scale(0.99); }
        
        #page-settings .ps-menu-icon { width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:16px; margin-right:14px; position:relative; flex-shrink:0; color:#fff; }
        #page-settings .ps-menu-icon.blue { background:linear-gradient(135deg, #0A84FF, #0066CC); }
        #page-settings .ps-menu-icon.orange { background:linear-gradient(135deg, #FF9F0A, #FF6B00); }
        #page-settings .ps-menu-icon.green { background:linear-gradient(135deg, #30D158, #00A040); }
        #page-settings .ps-menu-icon.purple { background:linear-gradient(135deg, #BF5AF2, #9933FF); }
        #page-settings .ps-menu-icon.cyan { background:linear-gradient(135deg, #64D2FF, #00B4D8); }
        #page-settings .ps-menu-icon.gray { background:linear-gradient(135deg, #636366, #48484A); }
        #page-settings .ps-menu-icon.red { background:linear-gradient(135deg, #FF453A, #CC0000); }
        
        #page-settings .ps-menu-text { flex:1; position:relative; }
        #page-settings .ps-menu-title { font-size:15px; font-weight:500; color:#fff; margin-bottom:2px; }
        #page-settings .ps-menu-title.danger { color:#FF453A; }
        #page-settings .ps-menu-subtitle { font-size:12px; color:rgba(255,255,255,0.48); }
        #page-settings .ps-menu-arrow { color:rgba(255,255,255,0.32); font-size:12px; position:relative; transition:all 0.15s; }
        #page-settings .ps-menu-item:hover .ps-menu-arrow { color:rgba(255,255,255,0.48); transform:translateX(3px); }
        
        /* Detail Page Styles */
        #page-settings .ps-detail-header {
            position:sticky; top:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);
            padding:16px 0; margin:0 -20px 24px; padding-left:20px; padding-right:20px; z-index:100;
            display:flex; align-items:center; gap:16px; border-bottom:1px solid rgba(255,255,255,0.04);
        }
        #page-settings .ps-btn-back {
            width:40px; height:40px; display:flex; align-items:center; justify-content:center;
            background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08); border-radius:12px;
            color:#fff; font-size:16px; cursor:pointer; transition:all 0.15s;
        }
        #page-settings .ps-btn-back:hover { background:rgba(255,255,255,0.06); transform:translateX(-2px); }
        #page-settings .ps-detail-title { font-size:18px; font-weight:700; color:#fff; }
        
        /* Card */
        #page-settings .ps-card { background:#131316; border:1px solid rgba(255,255,255,0.04); border-radius:20px; padding:20px; margin-bottom:20px; }
        #page-settings .ps-card-label { font-size:11px; font-weight:700; color:rgba(255,255,255,0.32); text-transform:uppercase; letter-spacing:1px; margin-bottom:16px; }
        
        /* Input */
        #page-settings .ps-input-group { margin-bottom:16px; }
        #page-settings .ps-input-group:last-child { margin-bottom:0; }
        #page-settings .ps-input-label { display:block; font-size:12px; font-weight:500; color:rgba(255,255,255,0.48); margin-bottom:8px; }
        #page-settings .ps-input {
            width:100%; padding:14px 16px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.08);
            border-radius:12px; font-family:inherit; font-size:15px; color:#fff; transition:all 0.15s;
        }
        #page-settings .ps-input:focus { outline:none; border-color:#FFD60A; background:rgba(255,214,10,0.04); box-shadow:0 0 0 3px rgba(255,214,10,0.1); }
        #page-settings .ps-input::placeholder { color:rgba(255,255,255,0.32); }
        
        /* Select */
        #page-settings .ps-select {
            padding:14px 40px 14px 16px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.08);
            border-radius:12px; font-family:inherit; font-size:15px; color:#fff; cursor:pointer; appearance:none;
            background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23ffffff' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat:no-repeat; background-position:right 12px center; background-size:20px; transition:all 0.15s;
        }
        #page-settings .ps-select:focus { outline:none; border-color:#FFD60A; }
        #page-settings .ps-select option { background:#1A1A1F; color:#fff; }
        
        /* Setting Row */
        #page-settings .ps-setting-row { display:flex; align-items:center; justify-content:space-between; padding:14px 0; border-bottom:1px solid rgba(255,255,255,0.04); }
        #page-settings .ps-setting-row:last-child { border-bottom:none; padding-bottom:0; }
        #page-settings .ps-setting-row:first-child { padding-top:0; }
        #page-settings .ps-setting-info { flex:1; margin-right:16px; }
        #page-settings .ps-setting-title { font-size:15px; font-weight:500; color:#fff; margin-bottom:2px; }
        #page-settings .ps-setting-desc { font-size:12px; color:rgba(255,255,255,0.48); }
        
        /* Toggle */
        #page-settings .ps-toggle { position:relative; width:51px; height:31px; flex-shrink:0; }
        #page-settings .ps-toggle input { opacity:0; width:0; height:0; }
        #page-settings .ps-toggle-track { position:absolute; cursor:pointer; inset:0; background:rgba(255,255,255,0.06); border-radius:9999px; transition:all 0.25s; }
        #page-settings .ps-toggle-thumb { position:absolute; top:2px; left:2px; width:27px; height:27px; background:#fff; border-radius:50%; transition:all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow:0 2px 8px rgba(0,0,0,0.3); }
        #page-settings .ps-toggle input:checked + .ps-toggle-track { background:#30D158; }
        #page-settings .ps-toggle input:checked + .ps-toggle-track .ps-toggle-thumb { transform:translateX(20px); }
        
        /* Stats Grid */
        #page-settings .ps-stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        #page-settings .ps-stat-card { background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); border-radius:16px; padding:18px; text-align:center; }
        #page-settings .ps-stat-label { font-size:10px; font-weight:600; color:rgba(255,255,255,0.32); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px; }
        #page-settings .ps-stat-value { font-size:26px; font-weight:800; color:#fff; }
        
        /* Accounting Hero */
        #page-settings .ps-accounting-hero {
            background:linear-gradient(135deg, rgba(48,209,88,0.08) 0%, rgba(10,132,255,0.04) 100%);
            border:1px solid rgba(48,209,88,0.15); border-radius:24px; padding:24px; margin-bottom:24px;
        }
        #page-settings .ps-acc-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px; }
        #page-settings .ps-acc-item { text-align:left; }
        #page-settings .ps-acc-item.right { text-align:right; }
        #page-settings .ps-acc-label { font-size:10px; font-weight:600; color:rgba(255,255,255,0.32); text-transform:uppercase; letter-spacing:0.5px; margin-bottom:4px; }
        #page-settings .ps-acc-label.success { color:#30D158; }
        #page-settings .ps-acc-value { font-size:22px; font-weight:800; color:#fff; }
        #page-settings .ps-acc-value.success { color:#30D158; }
        #page-settings .ps-acc-value.small { font-size:16px; font-weight:600; color:rgba(255,255,255,0.72); }
        
        #page-settings .ps-btn-salary {
            width:100%; padding:16px 24px; background:linear-gradient(135deg, #30D158, #00A040);
            border:none; border-radius:16px; font-family:inherit; font-size:14px; font-weight:700; color:#fff;
            cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition:all 0.25s;
        }
        #page-settings .ps-btn-salary:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(48,209,88,0.3); }
        
        /* Filter Chips */
        #page-settings .ps-filter-scroll { display:flex; gap:8px; overflow-x:auto; padding:4px 0 16px; scrollbar-width:none; -webkit-overflow-scrolling:touch; }
        #page-settings .ps-filter-scroll::-webkit-scrollbar { display:none; }
        #page-settings .ps-filter-chip {
            padding:10px 18px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);
            border-radius:9999px; font-family:inherit; font-size:13px; font-weight:500; color:rgba(255,255,255,0.72);
            white-space:nowrap; cursor:pointer; transition:all 0.15s;
        }
        #page-settings .ps-filter-chip:hover { background:rgba(255,255,255,0.06); }
        #page-settings .ps-filter-chip.active { background:#FFD60A; border-color:#FFD60A; color:#000; font-weight:600; }
        
        /* Buttons */
        #page-settings .ps-btn {
            padding:16px 24px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);
            border-radius:16px; font-family:inherit; font-size:14px; font-weight:600; color:#fff;
            cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; transition:all 0.15s;
        }
        #page-settings .ps-btn:hover { background:rgba(255,255,255,0.06); }
        #page-settings .ps-btn-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        #page-settings .ps-btn.success { background:#30D158; border-color:#30D158; }
        #page-settings .ps-btn.success:hover { background:#00A040; }
        #page-settings .ps-btn.primary { background:#0A84FF; border-color:#0A84FF; }
        #page-settings .ps-btn.primary:hover { background:#0066CC; }
        
        #page-settings .ps-btn-trash {
            width:100%; padding:16px; background:rgba(255,69,58,0.16); border:1px solid rgba(255,69,58,0.2);
            border-radius:16px; font-family:inherit; font-size:14px; font-weight:500; color:#FF453A;
            cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; margin-top:24px; transition:all 0.15s;
        }
        #page-settings .ps-btn-trash:hover { background:rgba(255,69,58,0.24); }
        
        /* Drive Section */
        #page-settings .ps-drive-section { margin-top:20px; padding-top:20px; border-top:1px solid rgba(255,255,255,0.04); }
        #page-settings .ps-drive-header { display:flex; align-items:center; gap:14px; margin-bottom:14px; }
        #page-settings .ps-drive-logo { width:40px; height:40px; background:linear-gradient(135deg, #4285F4 25%, #34A853 25%, #34A853 50%, #FBBC05 50%, #FBBC05 75%, #EA4335 75%); border-radius:12px; display:flex; align-items:center; justify-content:center; }
        #page-settings .ps-drive-logo i { color:#fff; font-size:18px; text-shadow:0 1px 3px rgba(0,0,0,0.3); }
        #page-settings .ps-drive-info h4 { font-size:15px; font-weight:600; color:#fff; margin:0 0 2px 0; }
        #page-settings .ps-drive-status { font-size:12px; color:rgba(255,255,255,0.48); }
        
        /* Permission Alert */
        #page-settings .ps-perm-alert {
            display:none; align-items:center; justify-content:space-between; padding:16px;
            background:rgba(255,159,10,0.1); border:1px solid rgba(255,159,10,0.2); border-left:4px solid #FF9F0A;
            border-radius:16px; margin-bottom:20px;
        }
        #page-settings .ps-perm-alert-text { font-size:13px; font-weight:600; color:#FF9F0A; }
        #page-settings .ps-perm-alert-btn {
            padding:8px 16px; background:#FF9F0A; border:none; border-radius:8px;
            font-family:inherit; font-size:12px; font-weight:700; color:#000; cursor:pointer; transition:all 0.15s;
        }
        #page-settings .ps-perm-alert-btn:hover { transform:scale(1.05); }
        
        /* Profile Edit */
        #page-settings .ps-profile-edit-hero { text-align:center; padding:24px 0; }
        #page-settings .ps-avatar-editor { position:relative; width:120px; height:120px; margin:0 auto 16px; }
        #page-settings .ps-avatar-preview { width:120px; height:120px; border-radius:24px; object-fit:cover; border:3px solid rgba(255,255,255,0.08); transition:all 0.25s; }
        #page-settings .ps-avatar-upload-btn {
            position:absolute; bottom:-6px; right:-6px; width:40px; height:40px; background:#FFD60A;
            border-radius:12px; display:flex; align-items:center; justify-content:center; color:#000; font-size:16px;
            cursor:pointer; transition:all 0.15s; box-shadow:0 4px 16px rgba(255,214,10,0.4); border:none;
        }
        #page-settings .ps-avatar-upload-btn:hover { transform:scale(1.1); }
        #page-settings .ps-avatar-hint { font-size:13px; color:rgba(255,255,255,0.48); }
        
        /* History Header */
        #page-settings .ps-history-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
        #page-settings .ps-tool-btn {
            padding:8px 14px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);
            border-radius:12px; font-family:inherit; font-size:13px; font-weight:500; color:#fff;
            cursor:pointer; display:flex; align-items:center; gap:6px; transition:all 0.15s;
        }
        #page-settings .ps-tool-btn:hover { background:rgba(255,255,255,0.06); }
    </style>

    <div class="app-settings-container ps-container">

        <!-- ========== ANA SAYFA (settings-home) ========== -->
        <div id="settings-home" class="settings-home-wrapper">
            
            <!-- Profile Hero -->
            <div class="ps-profile-hero" onclick="openSubPage('profile')">
                <div class="ps-profile-content">
                    <div class="ps-avatar-wrap">
                        <img id="menuProfileImg" 
                             src="https://via.placeholder.com/150/1e2538/ffffff?text=TR" 
                             class="ps-avatar"
                             onerror="this.src='https://via.placeholder.com/150/1e2538/ffffff?text=USER'">
                        <div class="ps-status-dot"></div>
                    </div>
                    <div class="ps-profile-info">
                        <div class="ps-profile-name" id="menuProfileName">Yükleniyor...</div>
                        <div class="ps-badge free pbc-badge" id="mainBadge">
                            <i class="fas fa-user"></i> FREE ÜYE
                        </div>
                    </div>
                    <div class="ps-arrow">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            </div>

            <!-- Kompakt Membership Button -->
            <div class="ps-membership-btn" id="membershipBtn" onclick="openPremiumModal()">
                <div class="ps-membership-btn-left">
                    <div class="ps-membership-btn-icon">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div>
                        <div class="ps-membership-btn-text" id="membershipBtnText">PRO'ya Yükselt</div>
                        <div class="ps-membership-btn-sub" id="membershipBtnSub">Tüm özellikleri aç</div>
                    </div>
                </div>
                <div class="ps-membership-btn-arrow">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>

            <!-- Uygulama Ayarları -->
            <div class="ps-section-label">Uygulama Ayarları</div>
            <div class="ps-menu-list">
                <!-- YENİ: Güvenlik -->
                <div class="ps-menu-item" onclick="openSubPage('security')">
                    <div class="ps-menu-icon cyan"><i class="fas fa-lock"></i></div>
                    <div class="ps-menu-text">
                        <div class="ps-menu-title">Güvenlik</div>
                        <div class="ps-menu-subtitle">
                            <span id="securityStatusBadge">
                                <!-- JS ile doldurulacak -->
                            </span>
                        </div>
                    </div>
                    <div class="ps-menu-arrow"><i class="fas fa-chevron-right"></i></div>
                </div>
                <div class="ps-menu-item" onclick="openSubPage('general')">
                    <div class="ps-menu-icon blue"><i class="fas fa-sliders-h"></i></div>
                    <div class="ps-menu-text">
                        <div class="ps-menu-title">Genel & Görünüm</div>
                        <div class="ps-menu-subtitle">Tema, dil, para birimi</div>
                    </div>
                    <div class="ps-menu-arrow"><i class="fas fa-chevron-right"></i></div>
                </div>
                <div class="ps-menu-item" onclick="openSubPage('notify')">
                    <div class="ps-menu-icon orange"><i class="fas fa-bell"></i></div>
                    <div class="ps-menu-text">
                        <div class="ps-menu-title">Bildirimler</div>
                        <div class="ps-menu-subtitle">Alarm ve uyarı ayarları</div>
                    </div>
                    <div class="ps-menu-arrow"><i class="fas fa-chevron-right"></i></div>
                </div>
                <div class="ps-menu-item" onclick="openSubPage('history')">
                    <div class="ps-menu-icon green"><i class="fas fa-wallet"></i></div>
                    <div class="ps-menu-text">
                        <div class="ps-menu-title">Kasa & Geçmiş</div>
                        <div class="ps-menu-subtitle">İşlem kayıtları ve muhasebe</div>
                    </div>
                    <div class="ps-menu-arrow"><i class="fas fa-chevron-right"></i></div>
                </div>
            </div>

            <!-- Destek & Yasal -->
            <div class="ps-section-label">Destek & Yasal</div>
            <div class="ps-menu-list">
                <div class="ps-menu-item" onclick="window.open('iletisim.html','_blank')">
                    <div class="ps-menu-icon purple"><i class="fas fa-envelope"></i></div>
                    <div class="ps-menu-text">
                        <div class="ps-menu-title">Bize Ulaşın</div>
                    </div>
                    <div class="ps-menu-arrow"><i class="fas fa-chevron-right"></i></div>
                </div>
                <div class="ps-menu-item" onclick="window.open('gizlilik.html','_blank')">
                    <div class="ps-menu-icon cyan"><i class="fas fa-shield-alt"></i></div>
                    <div class="ps-menu-text">
                        <div class="ps-menu-title">Gizlilik Politikası</div>
                    </div>
                    <div class="ps-menu-arrow"><i class="fas fa-chevron-right"></i></div>
                </div>
                <div class="ps-menu-item" onclick="window.open('kullanim-kosullari.html','_blank')">
                    <div class="ps-menu-icon gray"><i class="fas fa-file-contract"></i></div>
                    <div class="ps-menu-text">
                        <div class="ps-menu-title">Kullanım Koşulları</div>
                    </div>
                    <div class="ps-menu-arrow"><i class="fas fa-chevron-right"></i></div>
                </div>
            </div>

            <!-- Verileri Sıfırla -->
            <div class="ps-menu-list" style="margin-bottom:120px;">
                <div class="ps-menu-item" onclick="clearAllData()">
                    <div class="ps-menu-icon red"><i class="fas fa-trash-alt"></i></div>
                    <div class="ps-menu-text">
                        <div class="ps-menu-title danger" data-lang="reset_data">Verileri Sıfırla</div>
                        <div class="ps-menu-subtitle">Tüm veriler kalıcı olarak silinir</div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ========== PREMIUM MODAL ========== -->
        <div class="ps-modal-overlay" id="premiumModalOverlay" onclick="closePremiumModal(event)" style="z-index: 999999;">
    <div class="ps-premium-modal" onclick="event.stopPropagation()">
        
        <div class="ps-modal-header" id="premiumModalHeader">
            <button class="ps-modal-close" onclick="closePremiumModal()">
                <i class="fas fa-times"></i>
            </button>
            <div class="ps-modal-icon" id="premiumModalIcon">
                <i class="fas fa-crown"></i>
            </div>
            <div class="ps-modal-title" id="premiumModalTitle">TRADEVIA PRO</div>
            <div class="ps-modal-subtitle" id="premiumModalSubtitle">Sınırları kaldır, piyasaya hükmet.</div>
        </div>
        
        <div class="ps-modal-body">
            <div class="ps-features-list">
                
                <div class="ps-feature-item">
                    <div class="ps-feature-icon"><i class="fas fa-brain"></i></div>
                    <div class="ps-feature-text">
                        <div class="ps-feature-title">Zeka Merkezi</div>
                        <div class="ps-feature-desc">Yapay zeka yatırımcı analizi</div>
                    </div>
                </div>

                <div class="ps-feature-item">
                    <div class="ps-feature-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="ps-feature-text">
                        <div class="ps-feature-title">FOMO Skor</div>
                        <div class="ps-feature-desc">Duygusal işlem ölçümü</div>
                    </div>
                </div>

                <div class="ps-feature-item">
                    <div class="ps-feature-icon"><i class="fas fa-graduation-cap"></i></div>
                    <div class="ps-feature-text">
                        <div class="ps-feature-title">Trader Karnesi</div>
                        <div class="ps-feature-desc">Başarı puanın</div>
                    </div>
                </div>

                <div class="ps-feature-item">
                    <div class="ps-feature-icon"><i class="fas fa-history"></i></div>
                    <div class="ps-feature-text">
                        <div class="ps-feature-title">Zaman Makinesi</div>
                        <div class="ps-feature-desc">Sınırsız analiz (Free: 3 Hak)</div>
                    </div>
                </div>

                <div class="ps-feature-item">
                    <div class="ps-feature-icon"><i class="fas fa-wand-magic-sparkles"></i></div>
                    <div class="ps-feature-text">
                        <div class="ps-feature-title">Maliyet Sihirbazı</div>
                        <div class="ps-feature-desc">Portföyden otomatik veri çekme</div>
                    </div>
                </div>

            </div>
            
            <button class="ps-modal-upgrade-btn" id="btnUpgrade" onclick="MembershipSystem.processPayment()">
                <i class="fas fa-gem"></i>
                PRO'YA GEÇ (99₺)
            </button>
            
            <button class="ps-modal-downgrade-btn" id="btnDowngrade" onclick="MembershipSystem.downgrade(); closePremiumModal();">
                <i class="fas fa-times-circle"></i> Üyeliği İptal Et
            </button>
        </div>
    </div>
</div>

        <!-- ========== DETAY SAYFALARI ========== -->
        <div id="settings-detail" class="settings-detail-wrapper">
            
            <!-- Header -->
            <div class="ps-detail-header sub-header">
                <button class="ps-btn-back back-btn" onclick="closeSubPage()"><i class="fas fa-chevron-left"></i></button>
                <div class="ps-detail-title sub-title" id="subPageTitle">Detay</div>
            </div>

            <!-- ===== PROFİL SAYFASI ===== -->
            <div id="set-profile" class="settings-content" style="display:none;">
                <div class="ps-profile-edit-hero">
                    <div class="ps-avatar-editor">
                        <img id="displayProfileImg" src="" class="ps-avatar-preview">
                        <label class="ps-avatar-upload-btn">
                            <i class="fas fa-camera"></i>
                            <input type="file" id="imgUploadInput" style="display:none;" accept="image/*" onchange="uploadProfileImg(this)">
                        </label>
                    </div>
                    <p class="ps-avatar-hint">Fotoğrafı değiştirmek için tıkla</p>
                </div>

                <div class="ps-card card">
                    <div class="ps-card-label lbl-sm">Bilgiler</div>
                    <div class="ps-input-group">
                        <label class="ps-input-label">Ad Soyad</label>
                        <input type="text" id="profileNameInput" class="ps-input modern-input" placeholder="İsminizi girin" onchange="saveProfileData()">
                    </div>
                    <div class="ps-input-group">
                        <label class="ps-input-label">Bio / Ünvan</label>
                        <input type="text" id="profileBioInput" class="ps-input modern-input" placeholder="Kısa bir açıklama" onchange="saveProfileData()">
                    </div>
                    <div id="displayProfileName" style="display:none;"></div>
                    <div id="displayProfileBio" style="display:none;"></div>
                    <div id="membershipBadge" style="display:none;"></div>
                </div>

                <div class="ps-card card">
                    <div class="ps-card-label lbl-sm">İstatistikler</div>
                    <div class="ps-stats-grid stats-grid">
                        <div class="ps-stat-card stat-box">
                            <div class="ps-stat-label stat-label">Toplam İşlem</div>
                            <div class="ps-stat-value stat-val" id="profileTradeCount">0</div>
                        </div>
                        <div class="ps-stat-card stat-box">
                            <div class="ps-stat-label stat-label">Üyelik Tarihi</div>
                            <div class="ps-stat-value stat-val" id="profileJoinDate" style="font-size:18px">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== GENEL & GÖRÜNÜM SAYFASI ===== -->
            <div id="set-general" class="settings-content" style="display:none;">
                <div class="ps-card card">
                    <div class="ps-card-label lbl-sm">Tercihler</div>
                    <div class="ps-setting-row setting-item">
                        <span class="ps-setting-title">Para Birimi</span>
                        <select id="currSelect" class="ps-select setting-select" style="width:auto;" onchange="changeBaseCurrency(this.value)">
                            <option value="TRY">TRY (₺)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                    <div class="ps-setting-row setting-item">
                        <span class="ps-setting-title">Dil</span>
                        <select id="langSelect" class="ps-select setting-select" style="width:auto;" onchange="changeLanguage(this.value)">
                            <option value="tr">Türkçe</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                    <div class="ps-setting-row setting-item">
    <span class="ps-setting-title">Tema</span>
    <select id="themeSelect" class="ps-select setting-select" style="width:auto;" onchange="changeTheme(this.value)">
        <option value="ocean"> Okyanus (Mavi)</option>
        <option value="cyber"> Siber (Neon Mor)</option>
        <option value="oled"> Zifiri (OLED Siyah)</option>
        <option value="luxury"> Lüks (Altın)</option>
    </select>
</div>

                
                    <div class="ps-setting-row setting-item">
    <div class="ps-setting-info">
        <span class="ps-setting-title">Açılış Sayfası</span>
        <span class="ps-setting-desc"> </span>
    </div>
    <select id="startPageSelect" class="ps-select setting-select" style="width:auto;" onchange="changeStartPage(this.value)">
        <option value="portfolio">Cüzdan</option>
        <option value="market">Piyasa</option>
        <option value="analysis">Analiz</option>
        <option value="news">Haberler</option>
    </select>
</div>

                </div>
                
                <div style="display:none;">
                    <input type="text" id="polyKey">
                    <div id="polyStatusText"></div>
                    <div id="polyIndicator"></div>
                </div>

                <div class="ps-card card">
                    <div class="ps-card-label lbl-sm">Yedekleme</div>
                    <div class="ps-btn-grid" style="margin-bottom:12px">
                        <button class="ps-btn btn-main btn-sec" onclick="downloadBackup()">
                            <i class="fas fa-download"></i> İndir
                        </button>
                        <label class="ps-btn btn-main btn-sec" style="cursor:pointer; margin:0;">
                            <i class="fas fa-upload"></i> Yükle
                            <input type="file" id="excelInput" style="display:none" onchange="baslatExcelYukleme(this)" accept=".xlsx, .xls">
                            
                    
                        </label>
                    </div>
                    <button class="ps-btn btn-main btn-sec" style="width:100%" onclick="exportComprehensiveReport()">
    <i class="fas fa-file-invoice-dollar"></i> Kapsamlı Excel Raporu
</button>



                    <div class="ps-drive-section">
                        <div class="ps-drive-header">
                            <div class="ps-drive-logo"><i class="fab fa-google-drive"></i></div>
                            <div class="ps-drive-info">
                                <h4>Google Drive</h4>
                                <div class="ps-drive-status" id="drive-status">Bağlantı bekleniyor...</div>
                            </div>
                        </div>
                        <div class="ps-btn-grid" style="margin-bottom:12px">
                            <button class="ps-btn" onclick="handleAuthClick()"><i class="fas fa-sign-in-alt"></i> Giriş</button>
                            <button class="ps-btn" onclick="handleSignoutClick()"><i class="fas fa-sign-out-alt"></i> Çıkış</button>
                        </div>
                        <div class="ps-btn-grid">
                            <button class="ps-btn success" onclick="uploadToDrive()"><i class="fas fa-cloud-upload-alt"></i> Yedekle</button>
                            <button class="ps-btn primary" onclick="downloadFromDrive()"><i class="fas fa-cloud-download-alt"></i> Geri Yükle</button>
                        </div>
                        <div style="height:80px;"></div>
                    </div>
                </div>
            </div>

            <!-- ===== BİLDİRİMLER SAYFASI ===== -->
            <div id="set-notify" class="settings-content" style="display:none;">
                
                <div class="ps-perm-alert" id="permRequestCard">
                    <span class="ps-perm-alert-text"><i class="fas fa-exclamation-triangle"></i> Bildirim izni gerekli</span>
                    <button class="ps-perm-alert-btn" onclick="requestNotifyPermission()">İZİN VER</button>
                </div>

                <div class="ps-card card">
                    <div class="ps-card-label lbl-sm">Bildirim Türleri</div>
                    <div class="ps-setting-row switch-row">
                        <div class="ps-setting-info">
                            <div class="ps-setting-title switch-label">Fiyat Alarmları</div>
                            <div class="ps-setting-desc switch-desc">Hedef fiyata ulaşıldığında bildir</div>
                        </div>
                        <label class="ps-toggle tgl-switch">
                            <input type="checkbox" id="ntf_price" onchange="saveNotifySettings()">
                            <div class="ps-toggle-track tgl-slider"><div class="ps-toggle-thumb"></div></div>
                        </label>
                    </div>
                    <div class="ps-setting-row switch-row">
                        <div class="ps-setting-info">
                            <div class="ps-setting-title switch-label">İşlem Onayları</div>
                            <div class="ps-setting-desc switch-desc">Alım/satım sonrası onay</div>
                        </div>
                        <label class="ps-toggle tgl-switch">
                            <input type="checkbox" id="ntf_trade" onchange="saveNotifySettings()">
                            <div class="ps-toggle-track tgl-slider"><div class="ps-toggle-thumb"></div></div>
                        </label>
                    </div>
                    <div class="ps-setting-row switch-row">
                        <div class="ps-setting-info">
                            <div class="ps-setting-title switch-label">Haberler</div>
                            <div class="ps-setting-desc switch-desc">Önemli piyasa haberleri</div>
                        </div>
                        <label class="ps-toggle tgl-switch">
                            <input type="checkbox" id="ntf_news" onchange="saveNotifySettings()">
                            <div class="ps-toggle-track tgl-slider"><div class="ps-toggle-thumb"></div></div>
                        </label>
                    </div>
                </div>

                <div class="ps-card card">
                    <div class="ps-card-label lbl-sm">Ses & Titreşim</div>
                    <div class="ps-setting-row switch-row">
                        <div class="ps-setting-info">
                            <div class="ps-setting-title switch-label">Ses</div>
                        </div>
                        <label class="ps-toggle tgl-switch">
                            <input type="checkbox" id="ntf_sound" onchange="saveNotifySettings()">
                            <div class="ps-toggle-track tgl-slider"><div class="ps-toggle-thumb"></div></div>
                        </label>
                    </div>
                    <div class="ps-setting-row switch-row">
                        <div class="ps-setting-info">
                            <div class="ps-setting-title switch-label">Titreşim</div>
                        </div>
                        <label class="ps-toggle tgl-switch">
                            <input type="checkbox" id="ntf_vibrate" onchange="saveNotifySettings()">
                            <div class="ps-toggle-track tgl-slider"><div class="ps-toggle-thumb"></div></div>
                        </label>
                    </div>
                </div>

                <div class="ps-card card">
                    <div class="ps-card-label lbl-sm">Gelişmiş</div>
                    <div class="ps-setting-row switch-row">
                        <div class="ps-setting-info">
                            <div class="ps-setting-title switch-label" style="color:#FFD60A;">Gizli Mod</div>
                            <div class="ps-setting-desc switch-desc">API ve sistem mesajlarını gizle</div>
                        </div>
                        <label class="ps-toggle tgl-switch">
                            <input type="checkbox" id="muteAllToggle" onchange="toggleSecretMode()">
                            <div class="ps-toggle-track tgl-slider"><div class="ps-toggle-thumb"></div></div>
                        </label>
                    </div>
                </div>

                <button id="btnTestNotify" class="ps-btn" style="width:100%">
    <i class="fas fa-bell"></i> Test Bildirimi Gönder
</button>
            </div>

            <!-- ===== KASA & GEÇMİŞ SAYFASI ===== -->
            <div id="set-history" class="settings-content" style="display:none;">
                
                <!-- Accounting Hero -->
                <div class="ps-accounting-hero accounting-hero">
                    <div class="ps-acc-grid acc-row">
                        <div class="ps-acc-item acc-stat-box">
                            <div class="ps-acc-label acc-lbl-sub">Toplam Özkaynak</div>
                            <div class="ps-acc-value acc-val-lg" id="accTotalEquity">--</div>
                        </div>
                        <div class="ps-acc-item right acc-stat-box">
                            <div class="ps-acc-label acc-lbl-sub">Net Kâr/Zarar</div>
                            <div class="ps-acc-value acc-val-lg" id="accNetPnl">--</div>
                        </div>
                    </div>
                    <div class="ps-acc-grid acc-row" style="margin-bottom:0">
                        <div class="ps-acc-item acc-stat-box">
                            <div class="ps-acc-label acc-lbl-sub">Yatırım Sermayesi</div>
                            <div class="ps-acc-value small acc-val-sm" id="accCapital">--</div>
                        </div>
                        <div class="ps-acc-item right acc-stat-box">
                            <div class="ps-acc-label success acc-lbl-sub" style="color:#30D158;">Çekilen Kâr (Maaş)</div>
                            <div class="ps-acc-value small success acc-val-sm" id="accDividend" style="color:#30D158;">--</div>
                        </div>
                    </div>
                    <button class="ps-btn-salary btn-main" onclick="openSalaryModal()">
                        <i class="fas fa-hand-holding-usd"></i> KÂR DAĞITIMI YAP (MAAŞ ÖDE)
                    </button>
                </div>

                <!-- History Header -->
                <div class="ps-history-header">
                    <div class="ps-card-label lbl-sm" style="margin:0">Defter Kayıtları</div>
                    <button class="ps-tool-btn tool-btn" onclick="openCashModal()">
                        <i class="fas fa-plus"></i> İşlem Ekle
                    </button>
                </div>

                <!-- Filter Chips -->
                <div class="ps-filter-scroll hist-filter-scroll">
                    <button class="ps-filter-chip h-filter-btn active" onclick="filterHistory('all', this)">Tümü</button>
                    <button class="ps-filter-chip h-filter-btn" onclick="filterHistory('NAKİT', this)">Kasa</button>
                    <button class="ps-filter-chip h-filter-btn" onclick="filterHistory('ALIM', this)">Alım</button>
                    <button class="ps-filter-chip h-filter-btn" onclick="filterHistory('SATIM', this)">Satım</button>
                    <button class="ps-filter-chip h-filter-btn" onclick="filterHistory('MAAŞ', this)">Maaş</button>
                </div>

                <!-- History List -->
                <div id="historyListFull"></div>

                <!-- Trash Button -->
                <button class="ps-btn-trash trash-btn" onclick="openTrashModal()">
                    <i class="fas fa-trash-restore"></i> SİLİNEN KAYITLAR (<span id="trashCount">0</span>)
                </button>
            </div>

            <!-- ===== GÜVENLİK SAYFASI ===== -->
            <div id="set-security" class="settings-content" style="display:none;">
                
                <!-- Güvenlik Hero Kartı -->
                <div class="security-setting-card">
                    <div class="security-header">
                        <div class="security-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="security-info">
                            <h3>Uygulama Kilidi</h3>
                            <p>PIN koduyla uygulamanızı koruyun</p>
                        </div>
                    </div>

                    <!-- Durum Göstergesi -->
                    <div id="pinStatusDisplay" style="margin-bottom: 15px;">
                        <!-- JS ile doldurulacak -->
                    </div>

                    <!-- Toggle Satırı -->
                    <div class="security-toggle-row">
                        <span class="security-toggle-label">Uygulama Kilidi</span>
                        <label class="premium-switch" style="position:relative;">
                            <input type="checkbox" id="appLockToggle" onchange="AppLock.toggleLock(this.checked)">
                            <span class="premium-slider"></span>
                        </label>
                    </div>

                    <!-- Butonlar -->
                    <div class="security-btn-row" id="securityBtnRow" style="display: none;">
                        <button class="security-btn primary" onclick="AppLock.openChangePin()">
                            <i class="fas fa-key"></i> PIN Değiştir
                        </button>
                        <button class="security-btn danger" onclick="AppLock.removePin()">
                            <i class="fas fa-trash-alt"></i> Kaldır
                        </button>
                    </div>
                </div>

                <!-- Güvenlik İpuçları -->
                <div style="background: rgba(59, 130, 246, 0.08); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 15px; margin-top: 15px;">
                    <div style="display: flex; align-items: flex-start; gap: 12px;">
                        <div style="width: 32px; height: 32px; border-radius: 8px; background: rgba(59, 130, 246, 0.2); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-info-circle" style="color: #3b82f6; font-size: 14px;"></i>
                        </div>
                        <div>
                            <div style="font-size: 13px; font-weight: 600; color: #e2e8f0; margin-bottom: 6px;">Güvenlik İpuçları</div>
                            <ul style="font-size: 12px; color: #94a3b8; margin: 0; padding-left: 16px; line-height: 1.6;">
                                <li>Kolay tahmin edilebilir PIN'ler kullanmayın (1234, 0000)</li>
                                <li>PIN kodunuzu kimseyle paylaşmayın</li>
                                <li>PIN'inizi unutursanız verilerinizi sıfırlamanız gerekebilir</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Uyarı Mesajı -->
                <div style="background: rgba(245, 158, 11, 0.08); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 12px; padding: 15px; margin-top: 12px;">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-exclamation-triangle" style="color: #f59e0b; font-size: 16px;"></i>
                        <div style="font-size: 12px; color: #fbbf24; font-weight: 500;">
                            PIN'inizi unutursanız, uygulamaya erişmek için tüm verileri sıfırlamanız gerekecektir.
                        </div>
                    </div>
                </div>

            </div>

        </div>

    </div>
</div>

<script>
// Premium Modal Fonksiyonları
function openPremiumModal() {
    var overlay = document.getElementById('premiumModalOverlay');
    overlay.style.display = 'flex';
    setTimeout(function() { overlay.classList.add('active'); }, 10);
    updatePremiumModalUI();
}

function closePremiumModal(event) {
    if (event && event.target !== event.currentTarget) return;
    var overlay = document.getElementById('premiumModalOverlay');
    overlay.classList.remove('active');
    setTimeout(function() { overlay.style.display = 'none'; }, 300);
}

function updatePremiumModalUI() {
    var isPro = (typeof Membership !== 'undefined' && Membership.isPro());
    var header = document.getElementById('premiumModalHeader');
    var icon = document.getElementById('premiumModalIcon');
    var title = document.getElementById('premiumModalTitle');
    var subtitle = document.getElementById('premiumModalSubtitle');
    var btnUp = document.getElementById('btnUpgrade');
    var btnDown = document.getElementById('btnDowngrade');
    var features = document.querySelectorAll('.ps-feature-item');
    
    if (isPro) {
        header.classList.add('is-pro');
        icon.innerHTML = '<i class="fas fa-check"></i>';
        title.textContent = 'PRO Aktif';
        subtitle.textContent = 'Tüm özellikler açık';
        btnUp.style.display = 'none';
        btnDown.style.display = 'block';
        features.forEach(function(f) { f.classList.add('active'); });
    } else {
        header.classList.remove('is-pro');
        icon.innerHTML = '<i class="fas fa-crown"></i>';
        title.textContent = 'PRO Üyelik';
        subtitle.textContent = 'Tüm özelliklerin kilidini aç';
        btnUp.style.display = 'block';
        btnDown.style.display = 'none';
        features.forEach(function(f) { f.classList.remove('active'); });
    }
}

// Membership Buton UI Güncelleme
function updateMembershipBtnUI() {
    var isPro = (typeof Membership !== 'undefined' && Membership.isPro());
    var btn = document.getElementById('membershipBtn');
    var btnText = document.getElementById('membershipBtnText');
    var btnSub = document.getElementById('membershipBtnSub');
    var badge = document.getElementById('mainBadge');
    
    if (isPro) {
        btn.classList.add('is-pro');
        btnText.textContent = 'PRO Üyelik Aktif';
        btnSub.textContent = 'Ayarları görüntüle';
        btn.querySelector('.ps-membership-btn-icon i').className = 'fas fa-gem';
        
        if (badge) {
            badge.className = 'ps-badge pro pbc-badge';
            badge.innerHTML = '<i class="fas fa-gem"></i> PRO';
        }
    } else {
        btn.classList.remove('is-pro');
        btnText.textContent = 'PRO\'ya Yükselt';
        btnSub.textContent = 'Tüm özellikleri aç';
        btn.querySelector('.ps-membership-btn-icon i').className = 'fas fa-crown';
        
        if (badge) {
            badge.className = 'ps-badge free pbc-badge';
            badge.innerHTML = '<i class="fas fa-user"></i> FREE ÜYE';
        }
    }
}

// Sayfa yüklendiğinde UI'ı güncelle
document.addEventListener('DOMContentLoaded', function() {
    updateMembershipBtnUI();
});

// Mevcut Membership objesini wrap et
if (typeof Membership !== 'undefined') {
    var originalUpgrade = Membership.upgradeToPro;
    var originalDowngrade = Membership.downgrade;
    
    Membership.upgradeToPro = function() {
        if (originalUpgrade) originalUpgrade.call(Membership);
        updateMembershipBtnUI();
        updatePremiumModalUI();
    };
    
    Membership.downgrade = function() {
        if (originalDowngrade) originalDowngrade.call(Membership);
        updateMembershipBtnUI();
        updatePremiumModalUI();
    };
}

// Sayfa ilk açıldığında kontrol
if (typeof Membership !== 'undefined' && Membership.isPro()) {
    updateMembershipBtnUI();
}
</script>

<div class="dock-wrapper">
    <div class="nav-container">
        
        <div class="nav-item active" onclick="switchPage('portfolio', this)">
            <i class="fas fa-wallet"></i>
            <span data-lang="nav_wallet">Cüzdan</span>
        </div>

        <div class="nav-item" onclick="switchPage('market', this)">
            <i class="fas fa-chart-line"></i>
            <span data-lang="nav_market">Piyasa</span>
        </div>

        <div class="nav-item" onclick="switchPage('analysis', this)">
            <i class="fas fa-chart-pie"></i>
            <span>Analiz</span>
        </div>

        <div class="nav-item" onclick="switchPage('news', this)">
            <i class="far fa-newspaper"></i>
            <span data-lang="nav_news">Haber</span>
        </div>

        <div class="nav-item" onclick="switchPage('settings', this)">
            <i class="fas fa-cog"></i>
            <span data-lang="nav_settings">Ayarlar</span>
        </div>

    </div>
</div>

<div id="sellModal" class="modal-overlay">
    <div class="modal">
        <div class="sell-header-row">
            <div class="card-title" style="margin:0; font-size:14px;">SATIŞ EMRİ</div>
            <button id="sellCurrencyToggle" class="currency-toggle-btn active-try" onclick="toggleExitCurrency()">₺</button>
        </div>
        <input type="hidden" id="sellIdx">
        <div style="margin-bottom:5px; font-size:11px; color:var(--text-sub);">Miktar (<span id="sellMaxAmt">0</span> Mevcut)</div>
        <div class="sell-ratio-group">
            <button class="ratio-btn" onclick="setSellRatio(0.25)">%25</button>
            <button class="ratio-btn" onclick="setSellRatio(0.50)">%50</button>
            <button class="ratio-btn" onclick="setSellRatio(0.75)">%75</button>
            <button class="ratio-btn" onclick="setSellRatio(1.0)">TÜMÜ</button>
        </div>
        <input type="number" id="sellAmt" class="modern-input" placeholder="Adet Giriniz" onkeyup="calcSellPreview()">
        <div style="margin-bottom:5px; font-size:11px; color:var(--text-sub); margin-top:5px;">Satış Fiyatı (Birim)</div>
        <input type="number" id="sellPrice" class="modern-input" placeholder="Fiyat Giriniz" onkeyup="calcSellPreview()">
        <div class="sell-summary-box" id="sellSummaryBox" style="display:none;">
            <div class="ss-row"><span class="ss-lbl">Tahmini Tutar:</span><span class="ss-val" id="ssTotal">0.00</span></div>
            <div class="ss-row"><span class="ss-lbl">Bu İşlemden Kâr/Zarar:</span><span class="ss-pnl" id="ssPnL">0.00</span></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-main btn-sec" onclick="document.getElementById('sellModal').style.display='none'">İptal</button>
            <button class="btn-main" onclick="confirmSell()">SATIŞI ONAYLA</button>
        </div>
    </div>
</div>

<div id="legalModal" class="modal-overlay">
    <div class="modal" style="max-height: 80vh; overflow-y: auto;">
        <h3 style="text-align:center; color:var(--text-sub); margin-bottom:15px;"><i class="fas fa-balance-scale"></i> Yasal Uyarı</h3>
        <div style="font-size:11px; line-height:1.6; color:var(--text-sub); text-align:justify;">
            <p style="margin-bottom:10px;"><strong>Burada yer alan yatırım bilgi, yorum ve tavsiyeleri yatırım danışmanlığı kapsamında değildir.</strong></p>
            <p style="margin-bottom:10px;">Yatırım danışmanlığı hizmeti; aracı kurumlar, portföy yönetim şirketleri, mevduat kabul etmeyen bankalar ile müşteri arasında imzalanacak yatırım danışmanlığı sözleşmesi çerçevesinde sunulmaktadır.</p>
            <p style="margin-bottom:10px;">Burada yer alan yorum ve tavsiyeler, yorum ve tavsiyede bulunanların kişisel görüşlerine dayanmaktadır. Bu görüşler mali durumunuz ile risk ve getiri tercihlerinize uygun olmayabilir.</p>
            <p>Bu nedenle, sadece burada yer alan bilgilere dayanılarak yatırım kararı verilmesi beklentilerinize uygun sonuçlar doğurmayabilir. TradeMaster uygulaması bir simülasyon ve takip aracıdır, gerçek piyasa emri iletmez.</p>
        </div>
        <button class="btn-main btn-sec" style="margin-top:15px;" onclick="document.getElementById('legalModal').style.display='none'">Okudum, Anladım</button>
    </div>
</div>

<div id="feedbackModal" class="modal-overlay">
    <div class="modal">
        <h3 style="text-align:center; margin-bottom:15px;">Bize Ulaşın</h3>
        <p style="font-size:12px; color:var(--text-sub); text-align:center; margin-bottom:15px;">Hata bildirimi, özellik isteği veya görüşleriniz için yazabilirsiniz.</p>
        
        <div style="margin-bottom:10px;">
            <span style="font-size:11px; color:var(--text-sub);">Konu</span>
            <select id="fbSubject" class="modern-input">
                <option>Hata Bildirimi (Bug)</option>
                <option>Özellik İsteği</option>
                <option>Teşekkür / Diğer</option>
            </select>
        </div>
        
        <div style="margin-bottom:10px;">
            <span style="font-size:11px; color:var(--text-sub);">Mesajınız</span>
            <textarea id="fbMessage" class="modern-input" rows="4" placeholder="Mesajınızı buraya yazın..."></textarea>
        </div>

        <button class="btn-main" onclick="sendFeedback()">GÖNDER</button>
        <button class="btn-main btn-sec" style="margin-top:10px;" onclick="document.getElementById('feedbackModal').style.display='none'">Vazgeç</button>
    </div>
</div>


<div id="manualHistoryModal" class="modal-overlay">
    <div class="modal">
        <h3 style="text-align:center; margin-bottom:15px;">Geçmiş İşlem Ekle</h3>
        
        <div style="background:rgba(245, 158, 11, 0.1); padding:10px; border-radius:8px; font-size:11px; color:var(--gold); margin-bottom:15px; line-height:1.4;">
            <i class="fas fa-info-circle"></i> Bu özellik sadece <b>Geçmiş</b> ve <b>Trader Karnesi</b> verilerini etkiler. Cüzdan bakiyenizi veya portföyünüzü değiştirmez.
        </div>

        <div class="sim-tab-group">
            <div class="sim-tab active" onclick="setManualType('ALIM', this)">ALIM</div>
            <div class="sim-tab" onclick="setManualType('SATIM', this)">SATIM</div>
        </div>
        <input type="hidden" id="manualType" value="ALIM">

        <div class="input-row">
            <div>
                <span style="font-size:11px; color:var(--text-sub);">Sembol</span>
                <input type="text" id="manualSym" class="modern-input" placeholder="BTC, THYAO..." style="text-transform:uppercase;">
            </div>
            <div>
                <span style="font-size:11px; color:var(--text-sub);">Tarih</span>
                <input type="date" id="manualDate" class="modern-input" style="padding: 10px;">
            </div>
        </div>

        <div class="input-row">
            <div>
                <span style="font-size:11px; color:var(--text-sub);">Adet</span>
                <input type="number" id="manualAmt" class="modern-input" placeholder="0">
            </div>
            <div>
                <span style="font-size:11px; color:var(--text-sub);">Fiyat</span>
                <input type="number" id="manualPrice" class="modern-input" placeholder="0.00">
            </div>
        </div>

        <div id="manualCostArea" style="display:none; margin-top:5px;">
            <span style="font-size:11px; color:var(--text-sub);">Bu malı kaçtan almıştınız? (Kâr Hesabı İçin)</span>
            <input type="number" id="manualBuyCost" class="modern-input" placeholder="Alış Maliyeti Giriniz">
        </div>

        <button class="btn-main" style="margin-top:15px;" onclick="saveManualHistory()">KAYDET</button>
        <button class="btn-main btn-sec" style="margin-top:10px;" onclick="document.getElementById('manualHistoryModal').style.display='none'">İptal</button>
    </div>
</div>

<div id="alarmModal" class="modal-overlay">
    <div class="modal">
        <h3 id="alarmAssetTitle" style="text-align:center; margin-bottom:15px; color:var(--accent);">Fiyat Alarmı</h3>
        <input type="hidden" id="alarmIdx">
        <div class="sim-tab-group" style="margin-bottom:15px;">
            <div class="sim-tab active" onclick="switchAlarmTab('price', this)"><i class="fas fa-tag"></i> Fiyat Hedefi</div>
            <div class="sim-tab" onclick="switchAlarmTab('percent', this)"><i class="fas fa-percent"></i> Yüzde (%)</div>
        </div>
        <div id="alarm-pane-price" class="alarm-pane active" style="display:block;">
            <div style="font-size:11px; color:var(--text-sub); margin-bottom:5px;">Yükseliş Hedefi (Üst Sınır)</div>
            <div class="trade-input-group" style="margin-bottom:10px;"><i class="fas fa-arrow-up input-icon" style="color:var(--success);"></i><input type="number" id="alarmUpper" class="trade-input" placeholder="Örn: 150.00"></div>
            <div style="font-size:11px; color:var(--text-sub); margin-bottom:5px;">Düşüş Sınırı (Stop-Loss)</div>
            <div class="trade-input-group"><i class="fas fa-arrow-down input-icon" style="color:var(--danger);"></i><input type="number" id="alarmLower" class="trade-input" placeholder="Örn: 130.00"></div>
        </div>
        <div id="alarm-pane-percent" class="alarm-pane" style="display:none;">
            <div style="background:rgba(59,130,246,0.1); padding:10px; border-radius:8px; font-size:11px; color:var(--accent); margin-bottom:10px;"><i class="fas fa-info-circle"></i> Maliyetinize göre hesaplanır.</div>
            <div style="font-size:11px; color:var(--text-sub); margin-bottom:5px;">% Kaç Kâr Edince Uyar?</div>
            <div class="trade-input-group" style="margin-bottom:10px;"><i class="fas fa-plus input-icon" style="color:var(--success);"></i><input type="number" id="alarmPctUp" class="trade-input" placeholder="Örn: 10 (Yüzde 10 artarsa)"></div>
            <div style="font-size:11px; color:var(--text-sub); margin-bottom:5px;">% Kaç Düşüşte Uyar?</div>
            <div class="trade-input-group"><i class="fas fa-minus input-icon" style="color:var(--danger);"></i><input type="number" id="alarmPctDown" class="trade-input" placeholder="Örn: 5 (Yüzde 5 düşerse)"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-main btn-danger" style="flex:1;" onclick="clearAssetAlarms()">Sıfırla</button>
            <button class="btn-main" style="flex:2;" onclick="saveAlarm()">KAYDET</button>
        </div>
        <button class="btn-main btn-sec" style="margin-top:10px;" onclick="closeModal('alarmModal')">Vazgeç</button>
    </div>
</div>

<div id="simModal" class="modal-overlay">
    <div class="modal" style="max-width:360px; padding-top: 15px;"> <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
            
            <div onclick="closeModal('simModal')" style="cursor:pointer; width:30px; height:30px; display:flex; align-items:center; justify-content:flex-start; color:var(--text-sub);">
                <i class="fas fa-times" style="font-size:20px;"></i>
            </div>

            <h3 id="simAssetTitle" style="margin:0; font-size:16px; font-weight:700; text-align:center; flex:1;">--</h3>

            <div style="width:30px;"></div>
        </div>
        
        <div class="sim-tab-group">
            <div class="sim-tab active" onclick="switchSimTab('scenario', this)"><i class="fas fa-chart-bar"></i> Senaryo</div>
            <div class="sim-tab" onclick="switchSimTab('avg', this)"><i class="fas fa-balance-scale"></i> Maliyet</div>
            <div class="sim-tab" onclick="switchSimTab('holder', this)"><i class="fas fa-piggy-bank"></i> Holder</div>
            <div class="sim-tab" onclick="switchSimTab('realize', this)"><i class="fas fa-hand-holding-usd"></i> Satış</div>
        </div>

        <div id="sim-pane-scenario" class="sim-content-pane active">
            <div style="margin-bottom:5px; font-size:11px; color:var(--text-sub);">Varsayım Fiyatı:</div>
            <input type="number" id="simTargetPrice" class="modern-input" placeholder="Örn: 100.00" onkeyup="calcSimScenario()">
            <div style="margin-bottom:5px; font-size:11px; color:var(--text-sub); margin-top:5px;">Veya Yüzde Değişim (%):</div>
            <div class="input-row">
                <input type="number" id="simPercent" class="modern-input" placeholder="Örn: 10" onkeyup="calcSimScenarioPercent()">
                <button class="btn-main" style="padding:0;" onclick="calcSimScenarioPercent()">Hesapla</button>
            </div>
            <div id="simResScenario" class="sim-result-box" style="display:none;">
                <div class="sim-row"><span class="sim-lbl">Potansiyel Değer:</span><span id="resSimVal" style="font-weight:700;">--</span></div>
                <div class="sim-row"><span class="sim-lbl">Fiyat Farkı:</span><span id="resSimDiff">--</span></div>
                <div class="sim-row big"><span class="sim-lbl">Tahmini Kâr/Zarar:</span><span id="resSimPnL">--</span></div>
            </div>
        </div>

        <div id="sim-pane-avg" class="sim-content-pane">
            <div class="input-row">
                <div><div style="font-size:11px; color:var(--text-sub); margin-bottom:3px;">Alınacak Adet</div><input type="number" id="simAddAmt" class="modern-input" placeholder="Adet"></div>
                <div><div style="font-size:11px; color:var(--text-sub); margin-bottom:3px;">Alım Fiyatı</div><input type="number" id="simAddPrice" class="modern-input" placeholder="Fiyat"></div>
            </div>
            <button class="btn-main" onclick="calcSimAvg()">Yeni Ortalamayı Gör</button>
            <div id="simResAvg" class="sim-result-box" style="display:none;">
                <div class="sim-row"><span class="sim-lbl">Eski Ortalama:</span><span id="resOldAvg">--</span></div>
                <div class="sim-row big"><span class="sim-lbl">YENİ ORTALAMA:</span><span id="resNewAvg" style="color:var(--accent);">--</span></div>
                <div class="sim-row"><span class="sim-lbl">Toplam Yeni Maliyet:</span><span id="resTotalCost">--</span></div>
            </div>
        </div>

        <div id="sim-pane-holder" class="sim-content-pane">
            <div class="input-row">
                <div>
                    <div style="font-size:10px; color:var(--text-sub); margin-bottom:3px;">Vade (Yıl)</div>
                    <input type="number" id="hYear" class="modern-input" placeholder="1" value="1">
                </div>
                <div>
                    <div style="font-size:10px; color:var(--text-sub); margin-bottom:3px;">Beklenen Artış (%)</div>
                    <input type="number" id="hReturn" class="modern-input" placeholder="Yıllık %">
                </div>
            </div>
            <div style="margin-bottom:10px;">
                <div style="font-size:10px; color:var(--text-sub); margin-bottom:3px;">Tahmini Yıllık Enflasyon (%)</div>
                <input type="number" id="hInflation" class="modern-input" placeholder="Örn: 50" value="45">
            </div>
            <button class="btn-main" onclick="calcHolderAnalysis()">ANALİZ ET</button>
            <div id="simResHolder" class="sim-result-box" style="display:none; margin-top:10px;"></div>
        </div>

        <div id="sim-pane-realize" class="sim-content-pane">
            <div style="margin-bottom:5px; font-size:11px; color:var(--text-sub);">Satılacak Miktar (Adet):</div>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="number" id="simSellAmt" class="modern-input" placeholder="Adet" style="margin:0;">
                <button class="btn-main btn-sec" style="width:auto; padding:0 15px;" onclick="fillSimSell(0.5)">%50</button>
                <button class="btn-main btn-sec" style="width:auto; padding:0 15px;" onclick="fillSimSell(1)">Tümü</button>
            </div>
            <div style="margin-bottom:5px; font-size:11px; color:var(--text-sub);">Satış Fiyatı:</div>
            <input type="number" id="simRealizePrice" class="modern-input" placeholder="Güncel Fiyat">
            <button class="btn-main" onclick="calcSimRealize()">Analiz Et</button>
            <div id="simResRealize" class="sim-result-box" style="display:none;">
                <div class="sim-row big"><span class="sim-lbl">KASAYA GİRECEK:</span><span id="resCashIn" style="color:var(--success);">--</span></div>
                <div class="sim-row"><span class="sim-lbl">Realize Edilen Kâr:</span><span id="resRealizedPnL">--</span></div>
                <div class="sim-row"><span class="sim-lbl">Kalan Adet:</span><span id="resLeftAmt">--</span></div>
            </div>
        </div>

    </div>
</div>

</div>

<div id="marketDetailModal" class="modal-overlay" style="align-items: center; justify-content: center;">
    <div class="modal market-sheet" style="padding: 0; overflow: hidden; max-height: 85vh; display: flex; flex-direction: column; width: 95%; max-width: 400px; border-radius: 24px;">
        
        <div id="mdHero" class="md-header-hero">
            <div style="display:flex; justify-content:space-between; padding: 0 20px;">
                <button class="sheet-close-btn" onclick="closeMarketDetail()" style="background:rgba(0,0,0,0.2); color: white;">
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                <div id="mdAssetLogo" style="transform: scale(0.8);"></div>
                
                <button class="sheet-close-btn" onclick="actionWatchFromMarket()" style="background:rgba(0,0,0,0.2);">
                    <i id="mdWatchIcon" class="fas fa-star" style="transition: color 0.3s; color: var(--text-sub);"></i>
                </button>
            </div>
            
            <div id="mdSymbolTitle" style="font-size:12px; font-weight:800; color:var(--text-sub); margin-top:5px; letter-spacing:1px;">--</div>
            <div id="mdBigPrice" class="md-big-price">--</div>
            <div id="mdChangePill" class="md-change-pill">--</div>
        </div>

        <div style="padding: 0 20px 20px 20px; overflow-y: auto;">
            <div class="md-tabs">
                <div class="md-tab active" onclick="switchMdTab('overview', this)">GENEL BAKIŞ</div>
                <div class="md-tab" onclick="switchMdTab('chart', this)">GRAFİK</div>
                <div class="md-tab" onclick="switchMdTab('calc', this)">İŞLEM</div>
            </div>

            <div id="md-tab-overview" class="md-content active">
    <div class="range-container">
        <div class="range-labels">
            <span>GÜN DÜŞÜK: <span id="mdLow" style="color:var(--text-main)">--</span></span>
            <span>GÜN YÜKSEK: <span id="mdHigh" style="color:var(--text-main)">--</span></span>
        </div>
        <div class="range-track">
            <div class="range-fill"></div>
            <div id="mdRangeDot" class="range-dot" style="left: 50%;"></div>
        </div>
    </div>

    <div class="md-stat-grid">
        <div class="md-stat-box"><div class="md-stat-lbl">24S HACİM</div><div class="md-stat-val" id="mdVol">--</div></div>
        <div class="md-stat-box"><div class="md-stat-lbl">TÜR</div><div class="md-stat-val" id="mdType" style="color:var(--accent)">--</div></div>
        <div class="md-stat-box"><div class="md-stat-lbl">ORTALAMA (VWAP)</div><div class="md-stat-val" id="mdVwap">--</div></div>
        <div class="md-stat-box"><div class="md-stat-lbl">DURUM</div><div class="md-stat-val" id="mdStatus">AÇIK</div></div>
    </div>

    <div id="mdDisclaimer" style="font-size:10px; color:var(--text-sub); text-align:center; margin-top:10px; font-style: italic; opacity: 0.7; line-height: 1.5;">
    <i class="fas fa-info-circle"></i> Veri yükleniyor...
</div>
</div>


            <div id="md-tab-chart" class="md-content">
                <div id="mdChartContainer" class="chart-box-lg" style="height: 350px;"></div>
            </div>

            <div id="md-tab-calc" class="md-content">
                <div class="card" style="background: rgba(255,255,255,0.02);">
                    <div class="lbl-sm">BAKİYENİZ</div>
                    <div style="font-size:18px; font-weight:800; color:white; margin-bottom:10px;" id="mdUserBalance">--</div>
                    <div style="font-size:11px; color:var(--text-sub);">Tahmini Alınabilir Miktar: <span id="mdMaxBuy" style="color:var(--success); font-weight:700;">--</span></div>
                </div>
                <div class="md-action-grid">
                    <button class="btn-quick bq-buy" onclick="actionBuyFromMarket()"><span><i class="fas fa-arrow-down"></i> ALIM YAP</span><span class="bq-sub">Portföye Ekle</span></button>
                    <button class="btn-quick bq-sell" onclick="actionSellFromMarket()">
    <span><i class="fas fa-arrow-up"></i> SATIŞ YAP</span><span class="bq-sub">Portföyden Sat</span>
</button>

                </div>
            </div>
        </div>
    </div>
</div>


<div id="newsRedirectModal" class="modal-overlay" style="align-items: center; justify-content: center; backdrop-filter: blur(5px);">
    
    <div class="modal market-sheet" style="padding: 0; width: 90%; max-width: 360px; height: 65vh; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; background: #151b2b; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 20px 40px rgba(0,0,0,0.6);">
        
        <div style="flex: 1; padding: 16px; display: flex; flex-direction: column; background: #151b2b;">
            
            <div id="newsAdSpace" style="
                flex: 1; 
                width: 100%; 
                background: rgba(0, 0, 0, 0.2); /* Daha koyu ve nötr zemin */
                border-radius: 16px; 
                border: 2px dashed rgba(255, 255, 255, 0.1); /* Göze batmayan çerçeve */
                display: flex; 
                align-items: center; 
                justify-content: center; 
                flex-direction: column;
                margin-bottom: 15px;
                position: relative;
                overflow: hidden;">
                
                <div style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-ad" style="font-size: 24px; color: var(--text-sub); opacity: 0.5;"></i>
                </div>
                
                <span style="font-size: 10px; color: var(--text-sub); opacity: 0.5; font-weight: 700; margin-top: 15px; letter-spacing: 1px;">REKLAM</span>
            </div>

            <div style="flex-shrink: 0; display: flex; gap: 10px; height: 44px;">
                
                <button onclick="closeNewsModal()" style="
                    flex: 1;
                    height: 100%;
                    background: #1e2538; /* Uygulama input rengi */
                    color: #94a3b8;      /* Uygulama yan metin rengi */
                    border: 1px solid rgba(255,255,255,0.05);
                    border-radius: 12px;
                    font-weight: 600;
                    font-size: 12px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: 0.2s;">
                    Vazgeç
                </button>

                <button onclick="proceedToNews()" style="
                    flex: 2;
                    height: 100%;
                    background: #3b82f6; /* TradeMaster Mavisi */
                    color: white;
                    border: none;
                    border-radius: 12px;
                    font-weight: 700;
                    font-size: 13px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* Hafif gölge */
                    transition: 0.1s;">
                    <span>Kaynağa Git</span>
                    <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 10px;">
                <span style="font-size: 9px; color: var(--text-sub); opacity: 0.3;">Güvenli Bağlantı</span>
            </div>
        </div>
    </div>
</div>

<div id="cashModal" class="modal-overlay">
    <div class="modal">
        <h3 style="text-align:center; margin-bottom:15px;">Nakit İşlemi</h3>
        
        <input type="hidden" id="cashTypeVal" value="in">

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <div id="btnCashIn" class="cash-modal-btn deposit active" onclick="setCashType('in', this)">
                <i class="fas fa-arrow-down"></i>
                <span>YATIR</span>
            </div>
            <div id="btnCashOut" class="cash-modal-btn withdraw" onclick="setCashType('out', this)">
                <i class="fas fa-arrow-up"></i>
                <span>ÇEK</span>
            </div>
        </div>

        <div style="margin-bottom:10px;">
            <span style="font-size:11px; color:var(--text-sub);">Miktar</span>
            <input type="number" id="cashAmountInput" class="modern-input" placeholder="0.00">
        </div>

        <div style="margin-bottom:15px;">
            <span style="font-size:11px; color:var(--text-sub);">Açıklama (Opsiyonel)</span>
            <input type="text" id="cashDescInput" class="modern-input" placeholder="Örn: Banka transferi">
        </div>

        <button class="btn-main" onclick="submitCashTransaction()">İŞLEMİ ONAYLA</button>
        <button class="btn-main btn-sec" style="margin-top:10px;" onclick="document.getElementById('cashModal').style.display='none'">İptal</button>
    </div>
</div>

<div id="salaryModal" class="modal-overlay">
    <div class="modal">
        <h3 style="text-align:center; color:var(--success); margin-bottom:10px;">Kâr Dağıtımı</h3>
        <p style="font-size:11px; color:var(--text-sub); text-align:center; margin-bottom:20px;">
            Şirketinizden (Portföyünüzden) kendinize maaş ödemesi yapın. Bu işlem, sermayenizi düşürmez, kâr hanesinden düşülür.
        </p>
        
        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:15px; text-align:center;">
            <div style="font-size:10px; color:var(--text-sub);">Çekilebilir Kâr Tutarı</div>
            <div id="salaryAvailable" style="font-size:18px; font-weight:800; color:white;">--</div>
        </div>

        <span style="font-size:11px; color:var(--text-sub);">Çekilecek Tutar</span>
        <input type="number" id="salaryAmt" class="modern-input" placeholder="0.00">

        <button class="btn-main" style="background:#10b981; margin-top:10px;" onclick="confirmSalary()">ONAYLA VE ÇEK</button>
        <button class="btn-main btn-sec" style="margin-top:10px;" onclick="closeModal('salaryModal')">İptal</button>
    </div>
</div>

<div id="trashModal" class="modal-overlay">
    <div class="modal">
        <h3 style="text-align:center; margin-bottom:15px;"><i class="fas fa-trash-restore"></i> Geri Dönüşüm</h3>
        <div style="font-size:11px; color:var(--text-sub); margin-bottom:15px; text-align:center;">
            Yanlışlıkla silinen kayıtlar burada tutulur. Sermaye tutarsızlığını önlemek için geri yükleyebilirsiniz.
        </div>
        <div id="trashList" style="max-height:300px; overflow-y:auto;">
            </div>
        <button class="btn-main btn-sec" style="margin-top:15px;" onclick="closeModal('trashModal')">Kapat</button>
    </div>
</div>


<div id="portfolioModal" class="modal-overlay">
    <div class="modal" style="max-width:320px;">
        <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0; font-size:16px;">Portföylerim</h3>
            <button onclick="document.getElementById('portfolioModal').style.display='none'" style="background:none; border:none; color:white; font-size:16px;"><i class="fas fa-times"></i></button>
        </div>

        <div id="portfolioListContainer" style="margin-bottom:15px; max-height:200px; overflow-y:auto;">
            </div>

        <div style="display:flex; gap:5px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
            <input type="text" id="newPortfolioName" class="modern-input" placeholder="Yeni Cüzdan Adı" style="margin:0; font-size:12px;">
            <button onclick="MultiPortfolio.create()" class="btn-main" style="width:auto; padding:0 15px;"><i class="fas fa-plus"></i></button>
        </div>
    </div>
</div>

<div id="lockScreen">
    <div class="lock-icon">
        <i class="fas fa-shield-alt"></i>
    </div>
    <h3 id="lockTitle" style="margin-bottom: 10px; font-weight: 500;">TradeVia Güvenlik</h3>
    <p id="lockSub" style="color: #8899a6; margin-bottom: 30px; font-size: 0.9rem;">Giriş yapmak için şifrenizi girin</p>

    <div class="pin-dots">
        <div class="pin-dot" id="dot1"></div>
        <div class="pin-dot" id="dot2"></div>
        <div class="pin-dot" id="dot3"></div>
        <div class="pin-dot" id="dot4"></div>
    </div>

    <div class="numpad">
        <div class="num-btn" onclick="pressKey(1)">1</div>
        <div class="num-btn" onclick="pressKey(2)">2</div>
        <div class="num-btn" onclick="pressKey(3)">3</div>
        <div class="num-btn" onclick="pressKey(4)">4</div>
        <div class="num-btn" onclick="pressKey(5)">5</div>
        <div class="num-btn" onclick="pressKey(6)">6</div>
        <div class="num-btn" onclick="pressKey(7)">7</div>
        <div class="num-btn" onclick="pressKey(8)">8</div>
        <div class="num-btn" onclick="pressKey(9)">9</div>
        <div class="num-btn dummy"></div> <div class="num-btn" onclick="pressKey(0)">0</div>
        <div class="num-btn" onclick="clearPin()" style="font-size: 1.2rem;"><i class="fas fa-backspace"></i></div>
    </div>
</div>

</body>


<script>
    
    /* --- ÜYELİK YÖNETİM SİSTEMİ --- */
const Membership = {
    // Durum Kontrolü
    isPro: function() {
        return localStorage.getItem('userPlan') === 'PRO';
    },

    // Pro Satın Alma (Simülasyon)
    upgradeToPro: function() {
        if(confirm("TradeVia PRO Paket (Aylık 49₺)\n\nÖzellikler:\n- Sınırsız Zaman Makinesi\n- Detaylı Trader Karnesi\n- Altın Profil Çerçevesi\n\nOnaylıyor musunuz?")) {
            localStorage.setItem('userPlan', 'PRO');
            alert("Tebrikler! Artık PRO üyesiniz. Hoş geldiniz!");
            location.reload();
        }
    },

    // Üyeliği İptal Etme (Test için)
    downgrade: function() {
        localStorage.setItem('userPlan', 'FREE');
        alert("Üyelik Free pakete düşürüldü.");
        location.reload();
    },

    // ZAMAN MAKİNESİ LİMİT KONTROLÜ
    checkTimeMachineLimit: function() {
        if (this.isPro()) return true; // Pro'ya limit yok

        // Bugünün tarihi (Örn: "21.01.2026")
        let today = new Date().toLocaleDateString();
        let usageData = JSON.parse(localStorage.getItem('tm_usage')) || { date: today, count: 0 };

        // Tarih değiştiyse sayacı sıfırla
        if (usageData.date !== today) {
            usageData = { date: today, count: 0 };
        }

        // Limit kontrolü (3 Hak)
        if (usageData.count >= 3) {
            alert("🔒 GÜNLÜK LİMİT DOLDU!\n\nFree pakette günde sadece 3 kez Zaman Makinesi kullanabilirsin.\nSınırsız analiz için Ayarlar'dan PRO'ya geç.");
            return false; // Engelle
        }

        // Kullanım hakkını düş ve kaydet
        usageData.count++;
        localStorage.setItem('tm_usage', JSON.stringify(usageData));
        console.log(`Zaman Makinesi: ${usageData.count}/3 kullanıldı.`);
        return true; // İzin ver
    }
};

// Sayfa Yüklenince Profil Çerçevesini Ayarla
document.addEventListener("DOMContentLoaded", () => {
    let avatar = document.getElementById('userAvatar'); // Avatar resminin ID'si
    if(avatar) {
        avatar.className = ""; // Eski sınıfları temizle
        avatar.classList.add(Membership.isPro() ? 'profile-frame-pro' : 'profile-frame-free');
    }
});

    
    /* --- GÜVENLİ VERSİYON KONTROL SİSTEMİ (VERİ SİLMEZ) --- */
(function() {
    // BURAYI HER GÜNCELLEMEDE 1 ARTTIR (Örn: "2.5", "2.6"...)
    const CURRENT_VERSION = "1.6"; 

    const savedVersion = localStorage.getItem('TradeVia_Version');

    if (savedVersion !== CURRENT_VERSION) {
        console.log("Yeni sürüm (" + CURRENT_VERSION + ") tespit edildi. Sistem güncelleniyor...");

        // 1. Sadece Versiyon Numarasını Güncelle (Diğer verilere dokunma!)
        localStorage.setItem('TradeVia_Version', CURRENT_VERSION);

        // 2. Service Worker (PWA) Varsa Önbelleğini Temizle
        // (Bu sadece eski kod dosyalarını siler, portföy verisini silmez)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }

        // 3. Sayfayı Sunucudan Taze Şekilde Yeniden Yükle
        // (Cache'deki eski HTML/JS'yi yok sayar)
        window.location.reload(true);
    }
})();

    
    // 1. Sağ Tık Engelleme
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });

    // 2. Geliştirici Araçları Kısayollarını Engelleme (F12, Ctrl+Shift+I, Ctrl+U vb.)
    document.onkeydown = function(e) {
        if (event.keyCode == 123) { // F12
            return false;
        }
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { // Ctrl+Shift+I
            return false;
        }
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { // Ctrl+Shift+C
            return false;
        }
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { // Ctrl+Shift+J
            return false;
        }
        if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // Ctrl+U (Kaynak Görüntüle)
            return false;
        }
    }

    // 3. Konsol Açıldığında Sayfayı Zorlaştırma (Debugger Tuzağı)
    // Konsol açılırsa tarayıcı sürekli duraklatılır ve kod akışı kesilir.
    setInterval(function() {
        const startTime = performance.now();
        debugger; // Burası konsol açıksa çalışmayı durdurur
        const endTime = performance.now();
        
        // Eğer debugger'da çok vakit geçtiyse konsol açık demektir, sayfayı temizle veya yönlendir
        if (endTime - startTime > 100) {
            document.body.innerHTML = "Lütfen Geliştirici Araçlarını Kapatın!";
            window.location.reload(); 
        }
    }, 1000);

    // 4. Konsol Loglarını Temizleme (Console.log'ları siler)
    console.log = function() {};
    console.warn = function() {};
    console.error = function() {};


/* --- PWA İPTAL VE TEMİZLİK KODU --- */
if ('serviceWorker' in navigator) {
    // Mevcut tüm Service Worker'ları bul ve hepsini sil (unregister)
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
            registration.unregister().then(function(boolean) {
                console.log('Eski Service Worker silindi: ' + boolean);
            });
        }
    });

    // Önbellekleri (Cache) temizle
    caches.keys().then(function(names) {
        for (let name of names) {
            caches.delete(name);
        }
    });
}


    
/* --- AYARLAR VE GLOBAL DEĞİŞKENLER --- */
        
const AUTO_CG_KEY = "CG-ufWXFF5T5UzW7J7SmKAf5eoN";
let coingeckoApiKey = AUTO_CG_KEY; 
  
let notifySettings = JSON.parse(localStorage.getItem('tm_notify_settings')) || {
    price: true, trade: true, news: false, sound: true, vibrate: true
};

const trans = { tr: { loading:"Yükleniyor..." }, en: { loading:"Loading..." } };
let appSettings = JSON.parse(localStorage.getItem('tm_settings')) || {currency:'TRY', lang:'tr', theme:'ocean'};
let userProfile = JSON.parse(localStorage.getItem('tm_user_profile')) || { name: 'Misafir', bio: 'Yatırımcı', joinDate: new Date().toLocaleDateString(), img: null };

let lastMassiveUpdate = 0; 

// --- GÜNCELLENDİ: TESTTE ÇALIŞAN MASSIVE ANAHTARI (S3 ANAHTARI) ---
let polyApiKey = localStorage.getItem('tm_poly_key') || 'SKlgEqfjqAiyyR7atS2g7OEGQRYVYOMm';

let usdTryRate = 36.5; 
let cashBalance = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
let tradeHistory = JSON.parse(localStorage.getItem('tm_full_trade_history')) || [];
let notifications = JSON.parse(localStorage.getItem('tm_notifications')) || [];
let realizedPnL = parseFloat(localStorage.getItem('tm_realized_pnl')) || 0;

let entryCurrency = 'TRY'; let exitCurrency = 'TRY';
let isPrivacyMode = false; let currentSortMode = 'value_desc';
let currentMarketTab = 'kripto'; 
let currentHistoryFilter = 'all';
let currentSimAssetIndex = -1;
let selectedMarketSymbol = ""; 
let currentRenderId = 0; 
let liveUpdateInterval; 

/* --- BAŞLATMA VE AÇILIŞ EKRANI (GÜNCELLENMİŞ FİNAL) --- */
function initApp(){
    // 1. Kayıtlı Ayarları Inputlara Doldur
    document.getElementById('currSelect').value = appSettings.currency;
    document.getElementById('langSelect').value = appSettings.lang;
    document.getElementById('themeSelect').value = appSettings.theme || 'ocean';
    
    // Açılış Sayfası Ayarını Yükle
    document.getElementById('startPageSelect').value = appSettings.startPage || 'market'; 

    document.getElementById('polyKey').value = polyApiKey;
    
    // 2. Görünüm ve Dil Ayarlarını Uygula
    applyTheme(appSettings.theme);
    applyLang();
    loadNotifyUI();
    checkNotifyPermission();
    updateBadge();
    loadProfile();
    
    if(typeof checkPolyInit === 'function') checkPolyInit();
    
    // 3. Portföyü Çizdir (Önbellekten)
    renderPortfolioHTML(JSON.parse(localStorage.getItem('myPF_final')) || []);

    // 4. İnternetten Veri Çek ve Güncelle
    fetchUsdRate().then(async ()=>{ 
        await loadPF(true); 
        takePortfolioSnapshot(); 
        updateWatchlist();
        
        // Haber kutusu boşsa doldur
        setTimeout(() => { 
            if(document.getElementById('newsFeed') && document.getElementById('newsFeed').innerHTML==="") fetchNewsCustom(); 
        }, 2500); 
        
        startLiveUpdates();
    });

    // 5. Splash Ekranını Gizle ve Geçmişi Yükle
    setTimeout(() => { hideSplashScreen(); }, 3500); 
    renderHistory();
    setEntryCurrency('TRY'); 

    // 6. KİŞİSELLEŞTİRİLMİŞ AÇILIŞ YÖNLENDİRMESİ
    setTimeout(() => {
        // Kayıtlı ayarı al, yoksa varsayılan 'market' olsun
        const targetPage = appSettings.startPage || 'market';
        
        // Sayfa isimlerini alt menüdeki buton sırasına (index) eşle
        const pageIndexMap = {
            'portfolio': 0, // Cüzdan
            'market': 1,    // Piyasa
            'analysis': 2,  // Analiz
            'news': 3,      // Haber
            'settings': 4   // Ayarlar
        };

        // Doğru butonu bul
        const targetIndex = pageIndexMap[targetPage] !== undefined ? pageIndexMap[targetPage] : 1;
        const navButtons = document.querySelectorAll('.nav-item');
        const targetBtn = navButtons[targetIndex];

        // O sayfaya git
        if(targetBtn) {
            switchPage(targetPage, targetBtn);
        }
    }, 100); 
}

function hideSplashScreen() {
    const splash = document.getElementById('splash-screen');
    if(splash && !splash.classList.contains('hidden')) {
        splash.classList.add('hidden');
        setTimeout(() => { splash.remove(); }, 400); 
    }
}
/* --- EKSİK OLAN SIRALAMA FONKSİYONU --- */
function setSortMode(mode) {
    // 1. Yeni sıralama modunu ayarla
    currentSortMode = mode;
    
    // 2. Portföyü (internetten veri çekmeden) yeniden ekrana bas
    // (Bu işlem renderPortfolioHTML'i tetikler ve listeyi yeni moda göre sıralar)
    loadPF(false); 
}

/* --- SAYFA GEÇİŞ FONKSİYONU (YENİ TASARIM İÇİN GÜNCELLENDİ) --- */
function switchPage(pageId, btn) {
    
    // 1. SAYFA GÖRÜNÜMÜNÜ SIFIRLA VE YENİSİNİ AÇ
    document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
        page.style.display = 'none'; 
    });

    const targetPage = document.getElementById('page-' + pageId);
    if (targetPage) {
        targetPage.style.display = 'flex'; // Flex yapısını koru
        // Animasyonun tetiklenmesi için minik gecikme
        setTimeout(() => targetPage.classList.add('active'), 10);
    }

    // 2. ALT MENÜ BUTONLARINI GÜNCELLE
    // Eğer buton parametresi gelmediyse (manuel çağrılarda), otomatik bul
    if (!btn) {
        // İlgili butonu bul (basit mantık: ikon veya sıraya göre)
        const allBtns = document.querySelectorAll('.nav-item');
        if(pageId === 'portfolio') btn = allBtns[0];
        else if(pageId === 'market') btn = allBtns[1];
        else if(pageId === 'analysis') btn = allBtns[2];
        else if(pageId === 'news') btn = allBtns[3];
        else if(pageId === 'settings') btn = allBtns[4];
    }

    if (btn) {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        btn.classList.add('active');
        
        // Haptic Feedback (Titreşim - Mobil için)
        if(navigator.vibrate) navigator.vibrate(10);
    }

    // 3. ARAYÜZ ELEMANLARINI YÖNET
    manageUIElements(pageId);

    // 4. SAYFAYA ÖZEL FONKSİYONLARI ÇALIŞTIR
    runPageSpecificLogic(pageId);
}

/* --- YARDIMCI: ARAYÜZ YÖNETİCİSİ --- */
function manageUIElements(pageId) {
    const topBar = document.querySelector('.top-bar');
    const backBtn = document.getElementById('manualBackBtn');

    // A) Üst Bar Yönetimi (Haberler ve Ayarlar'da Gizle)
    if (pageId === 'news' || pageId === 'settings') {
        if (topBar) topBar.style.display = 'none';
    } else {
        if (topBar) topBar.style.display = 'flex';
    }

    // B) Geri Butonu Yönetimi (Sadece Cüzdan'da Gizle)
    if (backBtn) {
        backBtn.style.display = (pageId === 'portfolio') ? 'none' : 'flex';
    }
}

/* --- YARDIMCI: SAYFA MANTIK YÖNETİCİSİ --- */
function runPageSpecificLogic(pageId) {
    // -- Önceki Haber Zamanlayıcısını Temizle --
    if (typeof newsInterval !== 'undefined') clearInterval(newsInterval);

    switch (pageId) {
        case 'portfolio':
            if(typeof loadPF === 'function') loadPF(false); // Cüzdanı yenile
            break;

        case 'market':
            if (!currentMarketTab) currentMarketTab = 'kripto';
            if(typeof loadMarketCategory === 'function') loadMarketCategory(currentMarketTab);
            if(typeof startLiveUpdates === 'function') startLiveUpdates();
            break;

        case 'analysis':
            // Eğer analiz sayfasında özel render fonksiyonları varsa çağır
            if (typeof renderAnalyticsPage === 'function') renderAnalyticsPage();
            
            // Psikoloji sekmesi render hatasını düzelt
            const psychoTab = document.getElementById('an-view-psycho');
            if (psychoTab && psychoTab.classList.contains('active')) {
                psychoTab.style.display = 'none';
                setTimeout(() => { psychoTab.style.display = 'block'; }, 50);
            }
            break;

        case 'news':
            const tl = document.getElementById('newsTimeline');
            // İçerik boşsa sistemi başlat
            if (tl && (tl.innerHTML.trim() === "" || tl.innerHTML.includes('Yükleniyor'))) {
                if (typeof initNewsSystem === 'function') initNewsSystem();
            } else {
                if (typeof startNewsTimer === 'function') startNewsTimer();
            }
            break;

        case 'notifications':
            if(typeof renderNotifications === 'function') renderNotifications();
            break;
    }
}

/* ==========================================================
   ✅ DÜZELTİLMİŞ FİYAT MOTORU (DONMA SORUNU GİDERİLDİ)
   ========================================================== */

// NOT: 'polyApiKey' değişkeni dosyanın en başında tanımlı olduğu için 
// burada tekrar tanımlamıyoruz. Sistem mevcut anahtarı kullanacak.

/* --- 1. ANA YÖNETİCİ (MOD SİSTEMİYLE UYUMLU) --- */
async function getPrice(s, forceCategory = null) {
    s = s.toUpperCase().trim(); 
    if(!s) return { price: 0, origin: 'TRY', change: 0 };

    // Aktif Modu Belirle
    let currentMode = forceCategory;
    if (!currentMode) {
        const modeEl = document.getElementById('activeSearchMode');
        currentMode = modeEl ? modeEl.value : 'CRYPTO';
    }

    // Özel Eşleştirmeler
    const mapping = { 'TESLA': 'TSLA', 'APPLE': 'AAPL', 'MICROSOFT': 'MSFT', 'AMAZON': 'AMZN', 'GOOGLE': 'GOOGL', 'FACEBOOK': 'META', 'NVIDIA': 'NVDA' };
    if(mapping[s]) s = mapping[s];

    // --- MOD 1: KRİPTO ---
    if (currentMode === 'CRYPTO') {
        // CoinGecko (Varsa)
        if(typeof coingeckoApiKey !== 'undefined' && coingeckoApiKey) {
            try {
                const searchRes = await fetch(`https://api.coingecko.com/api/v3/search?query=${s}&x_cg_demo_api_key=${coingeckoApiKey}`);
                const searchData = await searchRes.json();
                if(searchData.coins && searchData.coins.length > 0) {
                    let coin = searchData.coins.find(c => c.symbol.toUpperCase() === s) || searchData.coins[0];
                    if(coin) {
                        const priceRes = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coin.id}&vs_currencies=usd&include_24hr_change=true&x_cg_demo_api_key=${coingeckoApiKey}`);
                        const priceData = await priceRes.json();
                        if(priceData[coin.id]) {
                            return { 
                                price: priceData[coin.id].usd, 
                                origin: 'USD', 
                                change: priceData[coin.id].usd_24h_change, 
                                source: 'CG',
                                image: coin.large, 
                                correctedSymbol: coin.symbol.toUpperCase() 
                            };
                        }
                    }
                }
            } catch(e) {}
        }
        
        // Binance (Yedek)
        let binanceSym = s.replace('BINANCE:', '').replace('USDT', '');
        try {
            let r = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${binanceSym}USDT`);
            if(r.ok) {
                let d = await r.json();
                return { 
                    price: parseFloat(d.lastPrice), 
                    origin: 'USD', 
                    change: parseFloat(d.priceChangePercent), 
                    source: 'BINANCE',
                    correctedSymbol: binanceSym + 'USDT'
                };
            }
        } catch(e){}
        
        return { price: 0, origin: 'USD', change: 0 };
    }

    // --- MOD 2: BORSA (HİSSE & EMTİA) ---
    if (currentMode === 'BORSA') {
        
        // Altın/Döviz Kontrolü
        const goldKeywords = ['ONS', 'GRAM', '24K', 'ÇEYREK', 'YARIM', 'TAM', 'CUMHURİYET', 'ATA'];
        if(goldKeywords.some(k => s.includes(k))) {
             try {
                const res = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbols=["PAXGUSDT","USDTTRY"]');
                const data = await res.json();
                const paxg = data.find(x => x.symbol === 'PAXGUSDT');
                const usdt = data.find(x => x.symbol === 'USDTTRY');
                if (paxg && usdt) {
                    let ons = parseFloat(paxg.lastPrice);
                    let usdTry = parseFloat(usdt.lastPrice);
                    let factor = 1; let type = 'GRAM24';
                    if(s.includes('ONS')) { factor=0; type='ONS'; }
                    else if(s.includes('ÇEYREK')) { factor=1.635; type='CEYREK'; }
                    let finalP = (type==='ONS') ? ons : ((ons*usdTry)/31.1035)*factor;
                    let org = (type==='ONS')?'USD':'TRY';
                    return { price: finalP, origin: org, change: parseFloat(paxg.priceChangePercent), source: 'KUYUMCU', image: null };
                }
             } catch(e){}
        }

// --- MOD 3: MASSIVE (ABD HİSSELERİ - EKLENECEK KISIM) ---
    if (currentMode === 'MASSIVE') {
        if(typeof polyApiKey !== 'undefined' && polyApiKey) {
            let res = await tryPolygon(s); 
            if(res) return res;
        }
        return { price: 0, origin: 'USD', change: 0 };
    }
    
        // 1. Yahoo (BIST & Yedek) - Önce buna baksın (Daha hızlıdır)
        let resYahoo = await tryYahoo(s);
        if(resYahoo) return resYahoo;

        // 2. Massive (Global Hisse) - Bulamazsa buraya gitsin
        // Hata koruması: polyApiKey tanımlı mı diye bakar
        if(typeof polyApiKey !== 'undefined' && polyApiKey && !s.includes('.IS')) {
            let resMassive = await tryPolygon(s);
            if(resMassive) return resMassive;
        }

        return { price: 0, origin: 'TRY', change: 0 };
    }

    return { price: 0, origin: 'TRY', change: 0 };
}

/* --- 2. MASSIVE (AKILLI SİSTEM: CANLI + PREV) --- */
async function tryPolygon(symbol) {
    if(typeof polyApiKey === 'undefined' || !polyApiKey) return null;
    let cleanSym = symbol.replace('BINANCE:','').replace('USDT','').toUpperCase().trim();
    if(cleanSym.length === 6 && !cleanSym.includes('.') && (cleanSym.startsWith('USD') || cleanSym.startsWith('EUR'))) cleanSym = "C:" + cleanSym;

    // --- ADIM 1: BUGÜNÜN CANLI VERİSİ (Piyasa Açıksa) ---
    // (Saat 17:30'dan sonra burası çalışır)
    let d = new Date();
    let dateStr = d.toISOString().split('T')[0];
    let urlToday = `https://api.massive.com/v2/aggs/ticker/${cleanSym}/range/1/day/${dateStr}/${dateStr}?adjusted=true&sort=desc&limit=1&apiKey=${polyApiKey}`;

    try {
        let r = await fetch(urlToday);
        if(r.ok) {
            let dData = await r.json();
            if(dData.results && dData.results.length > 0) {
                 return await processPolyResult(dData.results[0], cleanSym, polyApiKey);
            }
        }
    } catch(e) {}

    // --- ADIM 2: EN SON KAPANIŞ (Yedek Kuvvet) ---
    // Piyasa kapalıysa veya tatilse, son işlem gününü otomatik bulur.
    let urlPrev = `https://api.massive.com/v2/aggs/ticker/${cleanSym}/prev?adjusted=true&apiKey=${polyApiKey}`;

    try {
        let rPrev = await fetch(urlPrev);
        if(rPrev.ok) {
            let dPrev = await rPrev.json();
            // Prev endpoint'i bazen tek obje bazen array döner, ikisini de kapsayalım
            let result = (dPrev.results && dPrev.results.length) ? dPrev.results[0] : (dPrev.results ? dPrev.results : null);
            
            if(result) {
                 return await processPolyResult(result, cleanSym, polyApiKey);
            }
        }
    } catch(e) {}

    return null;
}

// --- YARDIMCI FONKSİYON (Logoyu ve Fiyatı Hazırlar) ---
async function processPolyResult(res, sym, key) {
    let logoUrl = null;
    try {
        let urlDetails = `https://api.massive.com/v3/reference/tickers/${sym}?apiKey=${key}`;
        let rDet = await fetch(urlDetails);
        if(rDet.ok) {
            let dDet = await rDet.json();
            if(dDet.results?.branding?.icon_url) {
                logoUrl = dDet.results.branding.icon_url + `?apiKey=${key}`;
            }
        }
    } catch(imgErr) {}

    return { 
        price: res.c, 
        origin: 'USD', 
        change: ((res.c - res.o) / res.o) * 100, 
        source: '⚡ MASSIVE', 
        image: logoUrl 
    };
}

/* --- 3. YAHOO (HİSSE YEDEĞİ) --- */
async function tryYahoo(symbol) {
    let s = symbol.toUpperCase().trim();
    if(!s.includes('=') && !s.includes('.') && s.length <= 5 && !s.includes('USD') && !s.includes('EUR')) s += '.IS';
    
    const proxy = "https://api.allorigins.win/raw?url=";
    const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${s}?interval=1d&range=1d`;

    try {
        const response = await fetch(proxy + encodeURIComponent(targetUrl));
        if (response.ok) {
            const d = await response.json();
            if (d.chart && d.chart.result && d.chart.result[0]) {
                let meta = d.chart.result[0].meta;
                let price = meta.regularMarketPrice;
                let prevClose = meta.chartPreviousClose;
                
                let change = (prevClose > 0) ? ((price - prevClose) / prevClose) * 100 : 0;
                let origin = (s.includes('=F') || s.includes('=X') || s.includes('USD')) ? 'USD' : 'TRY';
                
                return { 
                    price: parseFloat(price), 
                    origin: origin, 
                    change: change, 
                    source: 'YAHOO',
                    image: null
                };
            }
        }
    } catch (err) {}
    return null;
}

/* --- 4. TOPLU VERİ ÇEKME (Cüzdan İçin) --- */
async function fetchMassiveQuotes(symbolsArray) {
    if(!symbolsArray || symbolsArray.length === 0) return [];
    
    const promises = symbolsArray.map(async (sym) => {
        // Önce Borsa modunda dene
        let data = await getPrice(sym, 'BORSA');
        
        // Eğer Borsa bulamazsa ve Kripto ise Kripto dene
        if((!data || data.price === 0) && (sym.includes('USDT') || sym.includes('BTC'))) {
            data = await getPrice(sym, 'CRYPTO');
        }

        if(data && data.price > 0) {
            return {
                symbol: sym,
                regularMarketPrice: data.price,
                regularMarketChangePercent: data.change,
                currency: data.origin
            };
        }
        return null;
    });

    const results = await Promise.all(promises);
    return results.filter(r => r !== null);
}

/* --- BINANCE (KRİPTO YEDEĞİ) --- */
async function tryBinance(symbol) {
    let s = symbol.replace('BINANCE:', '').trim();
    if(!s.includes('USDT') && !s.includes('TRY')) s += 'USDT';
    try { let r = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${s}`); if(r.ok) { let d = await r.json(); return { price: parseFloat(d.lastPrice), origin: 'USD', change: parseFloat(d.priceChangePercent), source: 'BINANCE' }; } } catch(e){} return null;
}

/* --- CANLI GÜNCELLEME (MEVCUT KOD) --- */
function startLiveUpdates() {
    if(liveUpdateInterval) clearInterval(liveUpdateInterval);
    liveUpdateInterval = setInterval(async () => {
        if(!document.getElementById('page-portfolio').classList.contains('active')) return;
        loadPF(true); // Basitçe mevcut fonksiyonu çağır
    }, 60000); 
}

/* --- YÖNETİCİ: CÜZDAN YENİLEME (SIRALI VE GARANTİLİ MOD) --- */
async function loadPF(refreshData = false) {
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    if (as.length === 0) {
        renderPortfolioHTML([]);
        return;
    }

    if (refreshData) {
        document.getElementById('totalWallet').style.opacity = "0.5";
        
        let updatedAssets = []; // Yeni listeyi burada toplayacağız

        // --- ÖNEMLİ DEĞİŞİKLİK: Promise.all YERİNE FOR DÖNGÜSÜ ---
        // Bu, varlıkları teker teker günceller. Daha yavaştır ama HATA VERMEZ.
        for (let i = 0; i < as.length; i++) {
            let a = as[i];
            
            try {
                let savedSource = (a.source || "").toUpperCase();
                let strictOrder = null;

                // --- MOD BELİRLEME ---
                if (savedSource.includes('MASSIVE')) {
                    strictOrder = 'MASSIVE';
                } 
                else if (savedSource.includes('BINANCE') || savedSource.includes('CG') || a.name.includes('USDT') || a.name.includes('BTC')) {
                    strictOrder = 'CRYPTO';
                } 
                else if (savedSource.includes('YAHOO') || savedSource.includes('BIST') || a.name.includes('.IS')) {
                    strictOrder = 'BORSA'; 
                }

                // API ÇAĞRISI (Her varlık için anlık bekleme)
                let live = await getPrice(a.name, strictOrder);
                
                if (live && live.price > 0) {
                    a.curr = live.price;
                    if (live.source && live.source !== 'Piyasa') a.source = live.source;
                }

            } catch (err) {
                console.error("Varlık hatası:", a.name, err);
                // Hata olsa bile varlığı listeye ekle (silinmesin)
            }
            
            // İşlenen varlığı yeni listeye ekle
            updatedAssets.push(a); 
        }

        // Tüm döngü bitince kaydet
        localStorage.setItem('myPF_final', JSON.stringify(updatedAssets));
        as = updatedAssets;
        
        // Massive zaman damgasını güncelle (Artık engel yok, her seferinde güncel)
        lastMassiveUpdate = Date.now();
        
        document.getElementById('totalWallet').style.opacity = "1";
    }
    renderPortfolioHTML(as);
}


/* --- PİYASA SAYFASI YÖNETİMİ --- */
function switchMarketMode(mode, btn) {
    currentMarketTab = (mode === 'main') ? 'kripto' : mode; // Varsayılan Kripto
    
    // Buton görselliği
    let btns = document.querySelectorAll('.ms-btn');
    btns.forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    
    // Listeyi Yükle
    loadMarketCategory(currentMarketTab);
}

async function loadMarketCategory(cat) {
    const listDiv = document.getElementById('marketList');
    listDiv.innerHTML = `<div style="padding:20px; text-align:center;">${trans[appSettings.lang].loading}</div>`;
    
    let symbols = [];
    
    // KATEGORİYE GÖRE LİSTE BELİRLE
    if(cat === 'hisse') {
        // Sadece Massive ve Yahoo çalışacak
        symbols = ['AAPL', 'TSLA', 'AMZN', 'MSFT', 'GOOGL', 'NVDA', 'THYAO.IS', 'ASELS.IS', 'GARAN.IS', 'SASA.IS'];
    } else if(cat === 'emtia') {
        symbols = ['ONS', 'GRAM HAS', 'ÇEYREK', 'USDTRY', 'EURTRY'];
    } else {
        // Kripto (Varsayılan)
        symbols = ['BTC', 'ETH', 'SOL', 'AVAX', 'XRP', 'DOGE', 'SHIB', 'PEPE', 'ARB', 'RENDER'];
    }
    
    let html = "";
    
    // Paralel veri çekimi
    const promises = symbols.map(async (s) => {
        let data = await getPrice(s);
        let name = s.replace('.IS','');
        let icon = data.image || '';
        // Eğer logo yoksa harf koy
        let iconHtml = icon ? `<img src="${icon}" class="asset-icon-img">` : `<div class="asset-icon">${name[0]}</div>`;
        
        let pnlClass = data.change >= 0 ? 'trend-up' : 'trend-down';
        let sym = data.origin === 'USD' ? '$' : '₺';
        
        return `
        <div class="market-row" onclick="openTradeModal('${s}')">
            <div style="display:flex; align-items:center; gap:10px;">
                ${iconHtml}
                <div>
                    <div style="font-weight:bold; font-size:14px;">${name}</div>
                    <div style="font-size:10px; opacity:0.7;">${data.source}</div>
                </div>
            </div>
            <div style="text-align:right;">
                <div style="font-weight:bold;">${sym}${data.price.toLocaleString()}</div>
                <div class="${pnlClass}" style="font-size:11px;">%${data.change.toFixed(2)}</div>
            </div>
        </div>`;
    });
    
    let results = await Promise.all(promises);
    listDiv.innerHTML = results.join('');
}


    /* --- GÜNCELLENMİŞ CÜZDAN GÖRÜNÜMÜ (KAYNAK ETİKETLİ) --- */
function renderPortfolioHTML(as) {
    let l = document.getElementById('portfolioList'); 
    if(!l) return;
    
    if(!as || as.length === 0) {
        if(cashBalance > 0 && tradeHistory.length === 0 && (!as || as.length === 0)) { 
            l.innerHTML = "<div style='text-align:center; padding:30px; color:var(--text-sub); opacity:0.6;'><i class='fas fa-wallet' style='font-size:32px; margin-bottom:10px;'></i><br>Portföy Boş</div>"; 
        } else { 
            l.innerHTML = '<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>'; 
        }
        updateHeaderTotals(0, 0, { bist: 0, crypto: 0, other: 0, cash: cashBalance });
        return;
    }

    let totalVal = 0; 
    let chartData = { bist: 0, crypto: 0, other: 0, cash: cashBalance }; 
    let uCurr = appSettings.currency; 
    let sym = uCurr==='TRY'?'₺':'$'; 
    let totalUnrealizedPnL = 0;
    
    // Sıralama ve Hesaplama Mantığı
    let displayAssets = (as || []).map((a, i) => { 
        let rp = (a.curr && a.curr > 0) ? a.curr : a.buy; 
        let dVal = 0; let dCost = 0; 
        if(uCurr === 'TRY') { 
            if(a.origin === 'USD') { dVal = rp * a.amt * usdTryRate; dCost = a.buy * a.amt * usdTryRate; } 
            else { dVal = rp * a.amt; dCost = a.buy * a.amt; } 
        } else { 
            if(a.origin === 'TRY') { dVal = (rp * a.amt) / usdTryRate; dCost = (a.buy * a.amt) / usdTryRate; } 
            else { dVal = rp * a.amt; dCost = a.buy * a.amt; } 
        } 
        let pnl = dVal - dCost; 
        let pnlPercent = (dCost > 0) ? (pnl / dCost) * 100 : 0; 
        totalUnrealizedPnL += pnl; 
        return { ...a, originalIndex: i, dVal, dCost, pnl, pnlPercent, rp }; 
    });

    // Sıralama
    if(currentSortMode === 'value_desc') displayAssets.sort((a,b) => b.dVal - a.dVal); 
    else if(currentSortMode === 'pnl_desc') displayAssets.sort((a,b) => b.pnl - a.pnl); 
    else if(currentSortMode === 'pnl_asc') displayAssets.sort((a,b) => a.pnl - b.pnl); 
    else if(currentSortMode === 'percent_desc') displayAssets.sort((a,b) => b.pnlPercent - a.pnlPercent); 
    else if(currentSortMode === 'alpha_asc') displayAssets.sort((a,b) => a.name.localeCompare(b.name));

    let htmlBuilder = ""; 
    if(displayAssets.length > 0) { 
        htmlBuilder += `<div class="sort-scroll-wrapper"><div class="sort-chip ${currentSortMode==='value_desc'?'active':''}" onclick="setSortMode('value_desc')"><i class="fas fa-coins"></i> Değer</div><div class="sort-chip ${currentSortMode==='percent_desc'?'active':''}" onclick="setSortMode('percent_desc')"><i class="fas fa-percent"></i> Kâr (%)</div><div class="sort-chip ${currentSortMode==='pnl_desc'?'active':''}" onclick="setSortMode('pnl_desc')"><i class="fas fa-arrow-up"></i> Kazanç</div><div class="sort-chip ${currentSortMode==='pnl_asc'?'active':''}" onclick="setSortMode('pnl_asc')"><i class="fas fa-arrow-down"></i> Kayıp</div><div class="sort-chip ${currentSortMode==='alpha_asc'?'active':''}" onclick="setSortMode('alpha_asc')">A-Z</div></div>`; 
    }

    displayAssets.forEach((a) => { 
        totalVal += a.dVal; 
        let tag = getAssetTag(a.name).t; 
        if(tag === 'KRİPTO') chartData.crypto += a.dVal; 
        else if(tag === 'BORSA') chartData.bist += a.dVal; 
        else chartData.other += a.dVal;

        let cls = a.pnl >= 0 ? 'pnl-up' : 'pnl-down'; 
        let priceUnit = a.origin === 'USD' ? `<b id="live_price_${a.originalIndex}">$${a.rp.toFixed(2)}</b>` : `<b id="live_price_${a.originalIndex}">₺${a.rp.toFixed(2)}</b>`; 
        
        let logoHtml = "";
        if(a.image) logoHtml = `<div class="asset-logo-wrap" style="background:transparent; border:none;"><img src="${a.image}" class="asset-logo-img"></div>`;
        else logoHtml = getAssetLogoHtml(a.name.replace('.IS',''));
        
        let cardColorClass = 'asset-card' + (a.pnl > 0 ? ' profit-bg' : (a.pnl < 0 ? ' loss-bg' : '')); 
        let chartId = `mini_chart_${a.originalIndex}`; 
        let percentBadge = `<span id="live_pct_${a.originalIndex}" style="font-size:10px; opacity:0.8; margin-right:4px;">(%${a.pnlPercent.toFixed(1)})</span>`; 
        
        // --- YENİ ETİKET MANTIĞI BURADA ---
        let sourceBadge = "";
        if(a.source) {
            let sColor = "#94a3b8"; // Varsayılan Gri
            let sText = a.source;
            
            if(a.source === 'CG' || a.source.includes('RANK')) { sColor = "#8bc34a"; sText = "GECKO"; } // Yeşil
            else if(a.source === 'BINANCE') { sColor = "#f59e0b"; } // Turuncu
            else if(a.source === 'BIST') { sColor = "#3b82f6"; } // Mavi
            else if(a.source === 'YAHOO') { sColor = "#8b5cf6"; } // Mor
            
            sourceBadge = `<span style="font-size:8px; font-weight:800; background:${sColor}20; color:${sColor}; padding:2px 6px; border-radius:4px; margin-left:6px; letter-spacing:0.5px;">${sText}</span>`;
        }
        
        
        // ----------------------------------

        htmlBuilder += `<div class="${cardColorClass}" id="card_bg_${a.originalIndex}"><div class="asset-header collapsible-header" onclick="toggleAssetDetails(${a.originalIndex})"><div class="asset-left">${logoHtml}<div><span class="asset-name">${a.name.replace('.IS','')}${sourceBadge}</span><div class="asset-meta">${a.amt} Adet</div></div></div><div style="display:flex; align-items:center; gap:10px;"><div class="asset-pnl ${cls}" id="live_pnl_badge_${a.originalIndex}">${percentBadge}${sym}<span id="live_pnl_val_${a.originalIndex}">${a.pnl.toFixed(0)}</span></div><i id="asset-chevron-${a.originalIndex}" class="fas fa-chevron-down rotate-icon" style="font-size:12px; color:var(--text-sub);"></i></div></div><div id="asset-content-${a.originalIndex}" class="collapsible-content collapsed"><div class="asset-body-content"><div class="asset-details-grid"><div class="detail-item"><span class="detail-label">Ortalama</span><span class="detail-val">${a.buy.toFixed(2)} ${a.origin==='USD'?'$':'₺'}</span></div><div class="detail-item" style="text-align:right;"><span class="detail-label">Güncel</span><span class="detail-val accent">${priceUnit}</span></div><div class="detail-item"><span class="detail-label">Maliyet</span><span class="detail-val">${sym}${a.dCost.toFixed(0)}</span></div><div class="detail-item" style="text-align:right;"><span class="detail-label">Toplam Değer</span><span class="detail-val" id="live_total_val_${a.originalIndex}">${sym}${a.dVal.toFixed(0)}</span></div></div>${a.note ? `<div class="asset-note"><i class="fas fa-sticky-note"></i> ${a.note}</div>` : ''}<div class="asset-footer"><button class="tool-btn" onclick="toggleAssetChart('${a.name}', '${chartId}', this)"><i class="fas fa-chart-area"></i></button><button class="tool-btn ${a.alarm?'active-alarm':''}" onclick="openAlarmModal(${a.originalIndex})"><i class="fas fa-bell"></i></button><button class="tool-btn active-sim" onclick="openSimulator(${a.originalIndex})"><i class="fas fa-magic"></i></button><button class="tool-btn" onclick="editNote(${a.originalIndex})"><i class="fas fa-edit"></i></button><button class="tool-btn" onclick="openSell(${a.originalIndex})"><i class="fas fa-coins"></i></button><button class="tool-btn" onclick="delAsset(${a.originalIndex})"><i class="fas fa-trash"></i></button></div><div id="${chartId}" class="asset-mini-chart"></div></div></div></div>`; 
    });
    
    l.innerHTML = htmlBuilder;
    updateHeaderTotals(totalVal, totalUnrealizedPnL, chartData);
    checkAllAlarms();
}


    function updateHeaderTotals(totalVal, totalUnrealizedPnL, chartData) {
        let sym = appSettings.currency==='TRY'?'₺':'$';
        let grandTotal = totalVal + cashBalance; 
        document.getElementById('totalWallet').innerText = sym + grandTotal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}); 
        document.getElementById('cashBalance').innerText = sym + cashBalance.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}); 
        document.getElementById('realizedPnLVal').innerText = sym + realizedPnL.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        const hero = document.querySelector('.balance-hero'); 
        if(hero) { if(totalUnrealizedPnL >= 0) { hero.classList.remove('loss'); hero.classList.add('profit'); } else { hero.classList.remove('profit'); hero.classList.add('loss'); } }
        if(isPrivacyMode) document.getElementById('totalWallet').classList.add('privacy-blur'); else document.getElementById('totalWallet').classList.remove('privacy-blur');
    }
    
    function setTradeSearchMode(mode, btn) {
    // 1. Durumu kaydet
    document.getElementById('activeSearchMode').value = mode;
    
    // 2. Buton stillerini ayarla
    document.querySelectorAll('.tm-switch-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    
    // 3. Kullanıcıya ipucu ver (Placeholder değiştir)
    const input = document.getElementById('addSymbol');
    if(mode === 'CRYPTO') {
        input.placeholder = "Sembol (BTC, ETH, PEPE...)";
    } else {
        input.placeholder = "Sembol (THYAO, AAPL, USDTRY...)";
    }
    
    // 4. Eğer inputta yazı varsa yeniden ara (yeni modda)
    if(input.value.length > 1) {
        debouncedPreview(input.value);
    }
}

/* --- YENİ MUHASEBE VE GÜVENLİ SİLME MOTORU (FİNAL - DETAY KARTLI) --- */

// Global Değişken: Silinenleri hafızadan çek
let deletedHistory = JSON.parse(localStorage.getItem('tm_deleted_history')) || [];

/* --- GÜNCELLENMİŞ VE HATA KORUMALI GEÇMİŞ LİSTELEME --- */
function renderHistory() {
    let l = document.getElementById('historyListFull');
    if (!l) return;
    l.innerHTML = "";

    // Çöp Kutusu Sayacını Güncelle (Hata vermemesi için kontrol ekledim)
    let trashCountEl = document.getElementById('trashCount');
    let deletedHistory = JSON.parse(localStorage.getItem('tm_deleted_history')) || [];
    if(trashCountEl) trashCountEl.innerText = deletedHistory.length;

    let globalSym = (typeof appSettings !== 'undefined' && appSettings.currency === 'TRY') ? '₺' : '$';
    let currentUsd = (typeof usdTryRate !== 'undefined' && usdTryRate > 0) ? usdTryRate : 36.50;
    
    // --- MUHASEBE HESAPLAMALARI ---
    let totalInvested = 0; 
    let totalRealizedProfit = 0; 
    let totalSalaryPaid = 0; 
    
    // Geçmiş veriyi güvenli çek
    let historyData = JSON.parse(localStorage.getItem('tm_full_trade_history')) || [];

    historyData.forEach(t => {
        // HATA ÖNLEYİCİ: Sayı değilse 0 kabul et (NaN Hatasını Çözer)
        let val = parseFloat(t.total) || 0;
        let pnl = parseFloat(t.pnl) || 0;
        
        let transCurr = t.curr || 'TRY'; // Para birimi yoksa TRY varsay
        
        // Kur Dönüşümü (Otomatik)
        if (appSettings.currency === 'TRY' && transCurr === 'USD') { val *= currentUsd; pnl *= currentUsd; }
        else if (appSettings.currency === 'USD' && transCurr === 'TRY') { val /= currentUsd; pnl /= currentUsd; }

        if (t.type === 'YATIRMA') totalInvested += val;
        else if (t.type === 'ÇEKME') totalInvested -= val;
        else if (t.type === 'MAAŞ') totalSalaryPaid += val;
        else if (t.type === 'SATIM') totalRealizedProfit += pnl;
        else if (t.type === 'TEMETTÜ') totalRealizedProfit += val;
    });

    // Anlık Portföy Değeri
    let currentPortfolioValue = 0;
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    as.forEach(a => {
        let p = a.curr || a.buy || 0;
        let v = 0;
        if(appSettings.currency === 'TRY') {
             v = (a.origin === 'USD') ? (p * a.amt * currentUsd) : (p * a.amt);
        } else {
             v = (a.origin === 'TRY') ? ((p * a.amt) / currentUsd) : (p * a.amt);
        }
        currentPortfolioValue += v;
    });
    
    let cash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
    let totalEquity = cash + currentPortfolioValue;
    let netPnL = totalEquity - totalInvested;

    // --- EKRANA YAZDIR (Muhasebe Özeti) ---
    const setTxt = (id, val, color) => {
        let el = document.getElementById(id);
        if(el) {
            el.innerText = globalSym + val.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0});
            if(color) el.style.color = color;
        }
    };

    setTxt('accTotalEquity', totalEquity);
    setTxt('accCapital', totalInvested);
    setTxt('accDividend', totalSalaryPaid);
    
    let elNet = document.getElementById('accNetPnl');
    if(elNet) {
        elNet.innerText = (netPnL >= 0 ? '+' : '') + globalSym + netPnL.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0});
        elNet.style.color = netPnL >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    let withdrawableProfit = Math.max(0, totalRealizedProfit - totalSalaryPaid);
    let elSalAvail = document.getElementById('salaryAvailable');
    if(elSalAvail) elSalAvail.innerText = globalSym + withdrawableProfit.toLocaleString();

    // --- LİSTELEME (FİLTRELEME) ---
    // Eğer currentHistoryFilter tanımlı değilse 'all' yap
    if(typeof currentHistoryFilter === 'undefined') currentHistoryFilter = 'all';

    let filteredHistory = historyData.slice().reverse().filter(t => {
        if (currentHistoryFilter === 'all') return true;
        if (currentHistoryFilter === 'NAKİT') return (t.type === 'YATIRMA' || t.type === 'ÇEKME');
        return t.type === currentHistoryFilter;
    });

    if (filteredHistory.length === 0) {
        l.innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-sub); opacity:0.6;'>Kayıt Yok</div>";
        return;
    }

    filteredHistory.forEach((t) => {
        let realIndex = historyData.indexOf(t);
        
        // Değer hesaplama (Hata önleyici ile)
        let displayVal = parseFloat(t.total) || 0;
        let transCurr = t.curr || appSettings.currency;
        
        if (appSettings.currency === 'TRY' && transCurr === 'USD') displayVal *= currentUsd;
        else if (appSettings.currency === 'USD' && transCurr === 'TRY') displayVal /= currentUsd;

        let icon = 'circle'; let cls = 'l-type-neutral'; let sign = ''; let color = 'white'; let desc = t.sym;

        if (t.type === 'ALIM') { icon = 'arrow-down'; cls = 'l-type-out'; color = 'var(--danger)'; desc = `${t.sym} Alımı`; } 
        else if (t.type === 'SATIM') { icon = 'arrow-up'; cls = 'l-type-in'; color = 'var(--success)'; sign = '+'; desc = `${t.sym} Satışı`; } 
        else if (t.type === 'MAAŞ') { icon = 'hand-holding-usd'; cls = 'l-type-out'; color = '#10b981'; sign = '-'; desc = 'Kâr Dağıtımı'; }
        else if (t.type === 'YATIRMA') { icon = 'plus'; cls = 'l-type-in'; color = 'var(--success)'; sign = '+'; desc = t.desc || 'Sermaye Girişi'; } 
        else if (t.type === 'ÇEKME') { icon = 'minus'; cls = 'l-type-out'; color = 'var(--danger)'; sign = '-'; desc = t.desc || 'Sermaye Çıkışı'; }
        else if (t.type === 'TEMETTÜ') { icon = 'gift'; cls = 'l-type-in'; color = 'var(--gold)'; sign = '+'; desc = 'Temettü / Ek Gelir'; }

        // Kartın Altındaki Detay (Varsa)
        let detailCardHtml = "";
        if (t.type === 'SATIM') {
            let myAvg = parseFloat(t.avgCost) || 0;
            let mySellP = parseFloat(t.price) || 0;
            let myPnL = parseFloat(t.pnl) || 0;
            let myPct = parseFloat(t.plPercent) || 0;
            let itemSym = transCurr === 'USD' ? '$' : '₺';
            
            // Sadece veri varsa detayı göster
            if(myAvg > 0) {
                let isProfit = myPnL >= 0;
                let profitColor = isProfit ? 'var(--success)' : 'var(--danger)';
                let cardBg = isProfit ? 'rgba(16, 185, 129, 0.05)' : 'rgba(239, 68, 68, 0.05)';

                detailCardHtml = `
                <div style="margin-top:10px; background:${cardBg}; border-radius:8px; padding:10px; font-size:11px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:6px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:4px;">
                         <span style="color:var(--text-sub)">Alış: ${itemSym}${myAvg.toFixed(2)}</span>
                         <span style="color:var(--text-sub)">Satış: ${itemSym}${mySellP.toFixed(2)}</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-weight:700;">
                        <span style="color:var(--text-sub)">SONUÇ:</span>
                        <span style="color:${profitColor}">${myPnL>=0?'+':''}${itemSym}${myPnL.toLocaleString()} (%${myPct.toFixed(2)})</span>
                    </div>
                </div>`;
            }
        }

        // HTML'i ekle
        l.innerHTML += `
        <div class="ledger-card ${cls}" style="flex-direction:column; align-items:stretch;">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <div class="lc-left">
                    <div class="lc-icon"><i class="fas fa-${icon}"></i></div>
                    <div class="lc-info">
                        <span class="lc-title">${desc}</span>
                        <span class="lc-date">${t.date} • ${t.type}</span>
                    </div>
                </div>
                <div class="lc-right">
                    <span class="lc-amount" style="color:${color}">${sign}${globalSym}${displayVal.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                    <button onclick="safeDeleteHistory(${realIndex})" style="background:none; border:none; color:var(--text-sub); margin-left:10px; cursor:pointer;"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            ${detailCardHtml}
        </div>`;
    });
}

/* 2. Güvenli Silme (Safe Delete) */
function safeDeleteHistory(index) {
    if(index === -1) return;
    let item = tradeHistory[index];
    if(!confirm(`"${item.type}" işlemini silmek istediğinize emin misiniz?`)) return;

    deletedHistory.push(item);
    localStorage.setItem('tm_deleted_history', JSON.stringify(deletedHistory));

    tradeHistory.splice(index, 1);
    localStorage.setItem('tm_full_trade_history', JSON.stringify(tradeHistory));

    addNotification('info', 'Arşivlendi', 'İşlem çöp kutusuna taşındı.');
    renderHistory();
}

/* 3. Çöp Kutusunu Aç ve Yönet */
function openTrashModal() {
    let l = document.getElementById('trashList');
    l.innerHTML = "";
    
    if(deletedHistory.length === 0) {
        l.innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-sub);'>Çöp kutusu boş.</div>";
    } else {
        deletedHistory.forEach((item, idx) => {
            l.innerHTML += `
            <div class="deleted-item">
                <div>
                    <div style="font-weight:700; font-size:12px; color:white;">${item.type} - ${item.sym || 'Nakit'}</div>
                    <div style="font-size:10px; color:var(--text-sub);">${item.date} • ${item.total}</div>
                </div>
                <button class="del-restore-btn" onclick="restoreHistory(${idx})">GERİ YÜKLE</button>
            </div>`;
        });
    }
    openModal('trashModal');
}

function restoreHistory(idx) {
    let item = deletedHistory[idx];
    tradeHistory.push(item);
    tradeHistory.sort((a, b) => new Date(convertToDate(a.date)) - new Date(convertToDate(b.date)));
    deletedHistory.splice(idx, 1);
    
    localStorage.setItem('tm_deleted_history', JSON.stringify(deletedHistory));
    localStorage.setItem('tm_full_trade_history', JSON.stringify(tradeHistory));
    
    addNotification('success', 'Geri Yüklendi', 'Kayıt deftere geri eklendi.');
    openTrashModal();
    renderHistory();
}

function convertToDate(dateStr) {
    if(!dateStr) return new Date();
    let parts = dateStr.split('.');
    if(parts.length < 3) return new Date();
    return new Date(parts[2], parts[1] - 1, parts[0]);
}

/* 4. Maaş Ödeme Fonksiyonu */
function openSalaryModal() { openModal('salaryModal'); }

function confirmSalary() {
    let amt = parseFloat(document.getElementById('salaryAmt').value);
    if(!amt || amt <= 0) return alert("Tutar giriniz.");
    if(amt > cashBalance) return alert("Kasada bu kadar nakit yok!");

    cashBalance -= amt;
    localStorage.setItem('tm_cash_balance', cashBalance);

    logHistory('MAAŞ', 'NAKİT', 1, amt, 'Kâr Dağıtımı', appSettings.currency);

    addNotification('success', 'Ödeme Yapıldı', `Kendinize ${amt} ödeme yaptınız. Bereketli olsun!`);
    closeModal('salaryModal');
    renderHistory();
    loadPF(false);
}

    /* --- GÜNCELLENMİŞ KAYIT FONKSİYONU (KARNE DESTEKLİ) --- */
function logHistory(type, s, a, p, desc='', curr = null, pnl = 0, details = {}) { 
    let d = new Date(); 
    let transactionCurrency = curr ? curr : appSettings.currency;
    
    let t = { 
        date: d.toLocaleDateString('tr-TR'), 
        time: d.toLocaleTimeString('tr-TR').substring(0,5), 
        type: type, 
        sym: s, 
        qty: a, 
        price: p, 
        total: a*p, 
        desc: desc, 
        curr: transactionCurrency,
        pnl: pnl, // Net Kâr/Zarar
        
        // --- YENİ EKLENEN KARNE VERİLERİ ---
        avgCost: details.avgCost || 0,          // Maliyetimiz neydi?
        plPercent: details.plPercent || 0,      // Yüzde kaç kazandık?
        usdRateAtSell: details.usdRateAtSell || 0, // Dolar kuru kaçtı?
        note: details.note || ''                // İşlem notu
    }; 
    
    tradeHistory.push(t); 
    localStorage.setItem('tm_full_trade_history', JSON.stringify(tradeHistory)); 
    renderHistory(); 
}

    // --- NAKİT İŞLEMLERİ ---
    function modifyCash(m) { openCashModal(); }
    function openCashModal() { document.getElementById('cashModal').style.display = 'flex'; document.getElementById('cashAmountInput').value = ''; document.getElementById('cashDescInput').value = ''; }
    function setCashType(type, btn) { document.getElementById('cashTypeVal').value = type; document.querySelectorAll('.cash-modal-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    
    function submitCashTransaction() {
        let type = document.getElementById('cashTypeVal').value; let amt = parseFloat(document.getElementById('cashAmountInput').value); let desc = document.getElementById('cashDescInput').value.trim();
        if(!amt || amt <= 0) return addNotification('warn', 'Hata', 'Geçerli miktar giriniz.');
        let currentAppCurrency = appSettings.currency;
        if(type === 'in') { 
            cashBalance += amt; 
            logHistory('YATIRMA', 'NAKİT', 1, amt, desc ? desc : 'Kasa Girişi', currentAppCurrency); 
            addNotification('success', 'Nakit Eklendi', `${amt} tutarında giriş yapıldı.`); 
        } else { 
            if(amt > cashBalance) return addNotification('danger', 'Yetersiz Bakiye', 'Kasada bu kadar nakit yok.'); 
            cashBalance -= amt; 
            logHistory('ÇEKME', 'NAKİT', 1, amt, desc ? desc : 'Kasa Çıkışı', currentAppCurrency); 
            addNotification('warn', 'Nakit Çekildi', `${amt} tutarında çıkış yapıldı.`); 
        }
        localStorage.setItem('tm_cash_balance', cashBalance); 
        loadPF(false); 
        takePortfolioSnapshot(); 
        closeModal('cashModal');
    }

    function addDividend(){ let v=parseFloat(prompt("Temettü:")); if(v){cashBalance+=v; logHistory('TEMETTÜ','NAKİT',1,v, '', appSettings.currency); localStorage.setItem('tm_cash_balance',cashBalance); loadPF(); addNotification('success', 'Temettü Eklendi', `Kasa giriş: ${v}`); }}
    function filterHistory(type, btn) { currentHistoryFilter = type; document.querySelectorAll('.h-filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderHistory(); }

    /* --- PRO ANALİZ MOTORU --- */
    function takePortfolioSnapshot() {
        let history = JSON.parse(localStorage.getItem('tm_networth_history')) || []; let today = new Date().toLocaleDateString('tr-TR'); let as = JSON.parse(localStorage.getItem('myPF_final')) || []; let assetVal = 0;
        as.forEach(a => { let p = a.curr || a.buy; let v = (a.origin === 'USD' && appSettings.currency === 'TRY') ? (p * a.amt * usdTryRate) : (a.origin === 'TRY' && appSettings.currency === 'USD') ? ((p * a.amt) / usdTryRate) : (p * a.amt); assetVal += v; });
        let total = assetVal + cashBalance; let lastEntry = history[history.length - 1];
        if (!lastEntry || lastEntry.date !== today) { history.push({ date: today, val: total }); if(history.length > 30) history.shift(); localStorage.setItem('tm_networth_history', JSON.stringify(history)); } else { lastEntry.val = total; localStorage.setItem('tm_networth_history', JSON.stringify(history)); }
    }
    
    /* --- BURADAN KOPYALA --- */

/* --- DÜZELTİLMİŞ ANALİZ SAYFASI RENDER MOTORU --- */
function renderAnalyticsPage() {
    // 1. Portföy VE Geçmiş Verisini Çek
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let history = JSON.parse(localStorage.getItem('tm_full_trade_history')) || []; 
    
    let sym = appSettings.currency === 'TRY' ? '₺' : '$'; 
    let totalAssetVal = 0; 
    let totalCost = 0;

    // 2. Net Varlık Hesapla
    as.forEach(a => { 
        let p = a.curr || a.buy; 
        let val = 0; 
        let cost = 0; 
        if(appSettings.currency === 'TRY') { 
            val = (a.origin === 'USD') ? (p * a.amt * usdTryRate) : (p * a.amt); 
            cost = (a.origin === 'USD') ? (a.buy * a.amt * usdTryRate) : (a.buy * a.amt); 
        } else { 
            val = (a.origin === 'TRY') ? ((p * a.amt) / usdTryRate) : (p * a.amt); 
            cost = (a.origin === 'TRY') ? ((a.buy * a.amt) / usdTryRate) : (a.buy * a.amt); 
        } 
        totalAssetVal += val; 
        totalCost += cost; 
    });
    
    let netWorth = totalAssetVal + cashBalance; 
    let unrealizedPnL = totalAssetVal - totalCost;

    // DOM Güncelleme
    document.getElementById('anNetWorth').innerText = sym + netWorth.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
    let pnlEl = document.getElementById('anPnlPill'); 
    pnlEl.innerText = `${unrealizedPnL >= 0 ? '+' : ''}${sym}${unrealizedPnL.toLocaleString(undefined, {minimumFractionDigits:0})}`; 
    pnlEl.className = unrealizedPnL >= 0 ? 'trend-up' : 'trend-down';

    // --- 3. DÜZELTİLMİŞ WIN RATE HESAPLAMA ---
    let wins = 0; 
    let totalTrades = 0; 

    // A) Geçmişteki SATIŞLARI hesaba kat
    let sales = history.filter(t => t.type === 'SATIM');
    sales.forEach(t => {
        totalTrades++;
        if(parseFloat(t.pnl) > 0) wins++;
    });

    // B) Elindeki Açık Pozisyonları da hesaba kat
    if(as.length > 0) { 
        as.forEach(a => { 
            totalTrades++; 
            if((a.curr || a.buy) >= a.buy) wins++; 
        }); 
    } 
    
    // Oranı Hesapla
    let winRate = totalTrades > 0 ? Math.round((wins / totalTrades) * 100) : 0;
    
    // Değeri Yazdır
    document.getElementById('winRateVal').innerText = `%${winRate}`; 
    
    // Grafiği Çizdir
    renderWinRateChart(winRate);

    // --- 4. Diğer Grafikler ---
    let cashRatio = netWorth > 0 ? (cashBalance / netWorth) * 100 : 0; 
    document.getElementById('anCashRatioVal').innerText = `%${cashRatio.toFixed(1)}`; 
    document.getElementById('anCashRaw').innerText = sym + cashBalance.toLocaleString();
    
    let bar = document.getElementById('cashRatioBar'); 
    if(bar) {
        bar.style.width = `${cashRatio}%`; 
        bar.className = 'goal-fill ' + (cashRatio > 50 ? 'mid' : (cashRatio > 20 ? 'high' : 'low'));
    }

    renderRealGrowthChart();
    renderNewAllocationChart(as);
    
    // En çok kazandıranlar listesi
    let sortedAssets = [...as].sort((a, b) => { 
        let valA = (a.curr || a.buy) * a.amt; let costA = a.buy * a.amt; let pnlA = valA - costA; 
        let valB = (b.curr || b.buy) * b.amt; let costB = b.buy * b.amt; let pnlB = valB - costB; 
        return pnlB - pnlA; 
    }).slice(0, 3);
    
    let topListHTML = ""; 
    if(sortedAssets.length === 0) topListHTML = "<div style='text-align:center; font-size:11px; color:var(--text-sub); padding:10px;'>Veri Yok</div>";
    
    sortedAssets.forEach((a, i) => { 
        let currentP = a.curr || a.buy; 
        let rawPnL = (currentP - a.buy) * a.amt; 
        let pnlColor = rawPnL >= 0 ? '#34d399' : '#fb7185'; 
        let rankClass = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : i === 2 ? 'rank-3' : '';
        topListHTML += `<div class="top-performer-row"><div class="tp-name"><div class="rank-badge ${rankClass}">${i+1}</div>${a.name.replace('.IS','')}</div><div class="tp-val" style="color:${pnlColor}">${rawPnL >= 0 ? '+' : ''}${rawPnL.toFixed(0)}</div></div>`; 
    });
    
    document.getElementById('topPerformersList').innerHTML = topListHTML; 
    
    if(typeof calculateTraderScore === 'function') calculateTraderScore();
}

/* --- DÜZELTİLMİŞ GRAFİK RENDER MOTORU --- */
let wrChartInstance = null; 

function renderWinRateChart(rate) { 
    const canvas = document.getElementById('winRateChart');
    if(!canvas) return;

    // 1. Önceki grafiği temizle
    if (wrChartInstance) {
        wrChartInstance.destroy();
        wrChartInstance = null;
    }
    
    // Chart.js hafızasını da temizle (Hata önleyici)
    const existingChart = Chart.getChart("winRateChart");
    if (existingChart) {
        existingChart.destroy();
    }

    const ctx = canvas.getContext('2d'); 
    let color = rate >= 50 ? '#10b981' : '#ef4444'; 
    
    // Veri yoksa gri halka göster
    let dataSet = [rate, 100 - rate];
    let bgColors = [color, 'rgba(255,255,255,0.05)'];
    
    if(rate === 0 && (!JSON.parse(localStorage.getItem('tm_full_trade_history'))?.length)) {
        dataSet = [0, 100]; 
        bgColors = ['transparent', 'rgba(255,255,255,0.05)'];
    }

    wrChartInstance = new Chart(ctx, { 
        type: 'doughnut', 
        data: { 
            labels: ['Win', 'Loss'], 
            datasets: [{ 
                data: dataSet, 
                backgroundColor: bgColors, 
                borderWidth: 0, 
                cutout: '85%', 
                borderRadius: 20 
            }] 
        }, 
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            animation: { animateScale: true, animateRotate: true },
            plugins: { 
                legend: { display: false }, 
                tooltip: { enabled: false } 
            } 
        } 
    }); 
}
/* --- BURAYA KADAR --- */

    let growthChartReal = null; function renderRealGrowthChart() { const ctx = document.getElementById('realGrowthChart').getContext('2d'); if(growthChartReal) growthChartReal.destroy(); let history = JSON.parse(localStorage.getItem('tm_networth_history')) || []; if(history.length === 0) history.push({ date: new Date().toLocaleDateString('tr-TR'), val: 0 }); let labels = history.map(h => h.date.substring(0, 5)); let data = history.map(h => h.val); let gradient = ctx.createLinearGradient(0, 0, 0, 400); gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)'); growthChartReal = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Net Varlık', data: data, borderColor: '#3b82f6', backgroundColor: gradient, borderWidth: 2, pointBackgroundColor: '#1e1e1e', pointBorderColor: '#3b82f6', pointRadius: 4, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#64748b', font: {size: 10} } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: {size: 10} } } } } }); }
    let allocChartNew = null; function renderNewAllocationChart(as) { const ctx = document.getElementById('newAllocationChart').getContext('2d'); if(allocChartNew) allocChartNew.destroy(); let crypto = 0, bist = 0, forex = 0, cash = cashBalance; as.forEach(a => { let val = (a.curr || a.buy) * a.amt; if(appSettings.currency === 'TRY' && a.origin === 'USD') val *= usdTryRate; let tag = getAssetTag(a.name).t; if(tag === 'KRİPTO') crypto += val; else if(tag === 'BORSA') bist += val; else forex += val; }); allocChartNew = new Chart(ctx, { type: 'doughnut', data: { labels: ['Kripto', 'Borsa', 'Döviz', 'Nakit'], datasets: [{ data: [crypto, bist, forex, cash], backgroundColor: ['#f59e0b', '#3b82f6', '#8b5cf6', '#10b981'], borderWidth: 0, hoverOffset: 10 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: 'white', boxWidth: 10, font: {size: 10} } } } } }); }
    function updateGrowthChart(days) { document.querySelectorAll('.chart-filter-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); renderRealGrowthChart(); }
    /* --- DİĞER YARDIMCI FONKSİYONLAR --- */
    /* --- GÜNCELLENMİŞ ÖNİZLEME (KAYNAK GÖSTERGELİ) --- */
let debounceTimer; 
function debouncedPreview(val) { 
    clearTimeout(debounceTimer); 
    const infoDiv = document.getElementById('liveInfo'); 
    
    if(val.length < 2) { 
        infoDiv.innerText = ""; 
        return; 
    } 
    
    infoDiv.innerHTML = "<i class='fas fa-circle-notch fa-spin'></i> Aranıyor..."; 
    
    debounceTimer = setTimeout(async () => { 
        let res = await getPrice(val); 
        
        if (res.price > 0) { 
            let sym = res.origin === 'USD' ? '$' : '₺'; 
            let sourceColor = "var(--text-sub)";
            let sourceText = res.source || "PİYASA";

            // Kaynağa göre renkler
            if(sourceText === 'CG') { sourceText = "COINGECKO"; sourceColor = "#8bc34a"; }
            else if(sourceText === 'BINANCE') { sourceColor = "#f59e0b"; }
            else if(sourceText === 'BIST') { sourceColor = "#3b82f6"; }

            infoDiv.innerHTML = `
                <span style="color:var(--success); font-weight:700;">
                    ${val.toUpperCase()} 
                    <span style="font-size:9px; background:${sourceColor}20; color:${sourceColor}; padding:2px 5px; border-radius:4px; margin-left:5px;">${sourceText}</span>
                </span>
                <span style="color:white; margin-left:5px;">
                    : ${sym}${res.price.toFixed(2)}
                </span>`; 
        } else { 
            infoDiv.innerText = "Bulunamadı"; 
            infoDiv.style.color = "var(--text-sub)"; 
        } 
    }, 800); // 0.8 sn bekleme (API tasarrufu için)
}

    
    // --- GÜNCELLENMİŞ: ANLIK TUTAR HESAPLAMA VE RENK DEĞİŞİMİ ---
    function calcLiveTotal() { 
        let amt = parseFloat(document.getElementById('addAmount').value) || 0; 
        let pr = parseFloat(document.getElementById('addBuyPrice').value) || 0; 
        
        // Toplam Tutar
        let total = amt * pr; 
        let sym = entryCurrency === 'TRY' ? '₺' : '$'; 
        let totalEl = document.getElementById('liveTradeTotal');
        
        totalEl.innerText = sym + total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); 

        // --- GÖRSEL UYARI KONTROLÜ ---
        let costInWallet = 0;
        if (appSettings.currency === entryCurrency) {
            costInWallet = total;
        } else {
            if (appSettings.currency === 'TRY' && entryCurrency === 'USD') costInWallet = total * usdTryRate;
            else if (appSettings.currency === 'USD' && entryCurrency === 'TRY') costInWallet = total / usdTryRate;
        }

        // Para yetmiyorsa Kırmızı, yetiyorsa Beyaz yap
        if(costInWallet > cashBalance) {
            totalEl.style.color = 'var(--danger)'; 
            totalEl.style.fontWeight = '800';
        } else {
            totalEl.style.color = 'white';
            totalEl.style.fontWeight = '800';
        }
    }
    
 /* --- GÜNCELLENMİŞ PORTFÖYE EKLEME (IŞIK HIZINDA) --- */
async function addToPortfolio(){ 
    // 1. Kullanıcının yazdığını al
    let rawInput = document.getElementById('addSymbol').value.trim();
    let a = parseFloat(document.getElementById('addAmount').value); 
    let b = parseFloat(document.getElementById('addBuyPrice').value); 
    
    if(!rawInput || !a || !b) return addNotification('danger', 'Hata', 'Eksik bilgi girdiniz.'); 

    // 2. Fiyatı ve DOĞRU SEMBOLÜ tekrar çek
    addNotification('info', 'İşleniyor', 'Varlık doğrulanıyor...');
    let checkRes = await getPrice(rawInput);
    
    let s = checkRes.correctedSymbol ? checkRes.correctedSymbol : rawInput.toUpperCase();

    let totalCostInEntry = a * b; 
    let costInWallet = 0; 
    
    if (appSettings.currency === entryCurrency) { 
        costInWallet = totalCostInEntry; 
    } else { 
        if (appSettings.currency === 'TRY' && entryCurrency === 'USD') costInWallet = totalCostInEntry * usdTryRate;
        else if (appSettings.currency === 'USD' && entryCurrency === 'TRY') costInWallet = totalCostInEntry / usdTryRate;
    } 
    
    if(costInWallet > cashBalance) { 
        openModal('noCashModal');
        return; 
    } 
    
    cashBalance -= costInWallet; 
    localStorage.setItem('tm_cash_balance', cashBalance); 
    
    let as = JSON.parse(localStorage.getItem('myPF_final')) || []; 
    let ex = as.find(i=>i.name===s); 
    let assetOrigin = entryCurrency; 
    
    if(ex){ 
        let existingTotal = ex.amt * ex.buy; 
        let newTotal = 0;
        if(ex.origin === entryCurrency) newTotal = totalCostInEntry;
        else newTotal = (ex.origin === 'USD') ? totalCostInEntry / usdTryRate : totalCostInEntry * usdTryRate;
        
        let finalTotal = existingTotal + newTotal; 
        let finalAmt = ex.amt + a; 
        ex.buy = finalTotal / finalAmt; 
        ex.amt = finalAmt; 
        
        if(checkRes.image) ex.image = checkRes.image;
        if(checkRes.source) ex.source = checkRes.source;

    } else { 
        as.push({
            name: s, 
            amt: a, 
            buy: b, 
            curr: checkRes.price || b, 
            origin: assetOrigin,
            image: checkRes.image || null, 
            source: checkRes.source || null 
        }); 
    } 
    
    localStorage.setItem('myPF_final', JSON.stringify(as)); 
    logHistory('ALIM', s, a, b, '', entryCurrency); 
    
    addNotification('success', 'İşlem Başarılı', `${s} portföye eklendi.`); 
    
    document.getElementById('addSymbol').value=""; 
    document.getElementById('addAmount').value=""; 
    document.getElementById('addBuyPrice').value=""; 
    document.getElementById('liveInfo').innerText=""; 
    document.getElementById('dcaPreview').style.display='none'; 
    document.getElementById('liveTradeTotal').innerText="0.00"; 
    
    // --- HIZ AYARI BURADA YAPILDI ---
    // Eskiden: loadPF(true); -> Her şeyi yeniden indiriyordu.
    // Şimdi: loadPF(false); -> Sadece listeyi çiziyor (İnterneti meşgul etmiyor).
    loadPF(false); 
    
    fetchNewsCustom(); 
    loadProfile(); 
}


    /* --- FINAL GRAFİK MOTORU (CRYPTO + ABD + BIST + FOREX) --- */
function toggleAssetChart(symbol, id, btn) {
    let el = document.getElementById(id);
    let isActive = el.classList.contains('active');

    if (isActive) {
        el.classList.remove('active');
        btn.classList.remove('chart-on');
        setTimeout(() => { el.innerHTML = ''; }, 400);
    } else {
        el.classList.add('active');
        btn.classList.add('chart-on');
        el.innerHTML = '<div class="chart-loader-text">Grafik Yükleniyor...</div><div id="tv_' + id + '" style="height:100%; width:100%; border-radius:0 0 16px 16px; overflow:hidden;"></div>';

        let s = symbol.toUpperCase().trim();
        let tvSymbol = s;

        // 1. ÖZEL PREFİX VARSA KORU (Kullanıcı elle BIST: vs girdiyse)
        if (s.includes('BIST:') || s.includes('BINANCE:') || s.includes('TVC:') || s.includes('FX:') || s.includes('NASDAQ:') || s.includes('NYSE:')) {
            tvSymbol = s;
        }
        // 2. TÜRK HİSSELERİ
        else if (s.endsWith('.IS')) {
            tvSymbol = "BIST:" + s.replace('.IS', '');
        }
        // 3. ALTIN & DÖVİZ (Özel Tanımlar)
        else if (s === 'ALTIN' || s === 'GOLD' || s === 'ONS' || s === 'XAUUSD') { tvSymbol = "TVC:GOLD"; }
        else if (s === 'GRAM' || s === 'XAUTRY') { tvSymbol = "FX:XAUTRY"; }
        else if (s === 'GÜMÜŞ' || s === 'SILVER') { tvSymbol = "TVC:SILVER"; }
        else if (['USD', 'EUR', 'GBP', 'USDTRY', 'EURTRY'].includes(s)) { 
            if(s.length===3) tvSymbol = "FX:" + s + "TRY";
            else tvSymbol = "FX:" + s;
        }
        // 4. ABD HİSSELERİ (Özel Liste - Bunlar Kesin NASDAQ)
        else if (['AAPL','TSLA','AMZN','MSFT','GOOGL','META','NVDA','AMD','NFLX','COIN','GME','INTC','PLTR','MSTR','HOOD','BABA'].includes(s)) {
            tvSymbol = "NASDAQ:" + s;
        }
        // 5. GENEL KRİPTO PARA (CoinGecko ve Binance Dahil)
        // Eğer yukarıdaki hisselerden biri değilse ve içinde nokta yoksa Coin varsayıyoruz.
        else if (!s.includes('.')) {
            // Eğer sonunda zaten USDT yoksa ekle (Örn: KAS -> KASUSDT)
            let cleanSym = s;
            if (!s.endsWith('USDT') && !s.endsWith('USD')) {
                cleanSym = s + "USDT";
            }
            
            // ÖNEMLİ: Başına "BINANCE:" koymuyoruz! 
            // Sadece sembolü gönderiyoruz (Örn: KASUSDT).
            // Böylece TradingView, Binance'de yoksa Gate.io veya Kucoin verisini açar.
            tvSymbol = cleanSym;
        }

        new TradingView.widget({
            "autosize": true,
            "symbol": tvSymbol,
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "tr",
            "toolbar_bg": "#f1f3f6",
            "enable_publishing": false,
            "hide_top_toolbar": true,
            "hide_legend": false,
            "save_image": false,
            "container_id": "tv_" + id
        });
    }
}

    /* --- GÜNCELLENMİŞ ALARM KONTROLÜ (30 GÜNLÜK GERÇEK ANALİZ) --- */
async function checkAllAlarms() {
    let alarms = JSON.parse(localStorage.getItem('tradeVia_alarms')) || [];
    if (alarms.length === 0) return;

    let updated = false;
    let pf = JSON.parse(localStorage.getItem('myPF_final')) || [];

    for (let alarm of alarms) {
        if (!alarm.active) continue;

        // Fiyatı Bul (Portföyden hızlıca)
        let currentPrice = 0;
        let asset = pf.find(p => p.name === alarm.symbol);
        
        // Eğer portföyde güncel fiyat varsa al, yoksa pas geç (Hız için)
        if (asset && asset.curr) currentPrice = asset.curr;
        else continue; 

        let triggered = false;
        let triggerMsg = "";
        let triggerIcon = "";

        // --- 1. FİYAT HEDEFİ KONTROLÜ (Klasik) ---
        if (alarm.type === 'PRICE') {
            if (alarm.direction === 'UP' && currentPrice >= alarm.target) {
                triggerMsg = `HEDEF GELDİ: $${currentPrice}`; triggerIcon = "🚀"; triggered = true;
            }
            if (alarm.direction === 'DOWN' && currentPrice <= alarm.target) {
                triggerMsg = `DÜŞÜŞ LİMİTİ: $${currentPrice}`; triggerIcon = "🔻"; triggered = true;
            }
        }

        // --- 2. VOLATİLİTE KONTROLÜ (Ani Hareket) ---
        else if (alarm.type === 'VOLATILITY') {
            let rawChange = ((currentPrice - alarm.basePrice) / alarm.basePrice) * 100;
            
            if ((alarm.direction === 'UP' || alarm.direction === 'BOTH') && rawChange >= alarm.percent) {
                triggerMsg = `ANİ YÜKSELİŞ: +%${rawChange.toFixed(2)} 🚀`; triggerIcon = "⚡"; triggered = true;
            }
            if ((alarm.direction === 'DOWN' || alarm.direction === 'BOTH') && rawChange <= -alarm.percent) {
                triggerMsg = `ANİ ÇÖKÜŞ: %${rawChange.toFixed(2)} 🔻`; triggerIcon = "📉"; triggered = true;
            }
        }

        // --- 3. İNDİKATÖR (AKILLI 30 GÜNLÜK ANALİZ) ---
        else if (alarm.type === 'RSI') {
            // Sadece Kripto paralar için Binance verisi çekebiliriz (Şimdilik)
            if (asset.name.includes('USDT') || (!asset.name.includes('.') && asset.name.length <= 5)) {
                try {
                    // API YÜKÜNÜ AZALTMAK İÇİN: Sadece %10 ihtimalle veya her 5 dakikada bir kontrol edilebilir.
                    // Şimdilik her döngüde kontrol ediyoruz ama "try/catch" ile koruyoruz.
                    
                    let cleanSym = asset.name.replace('BINANCE:','').replace('USDT','') + "USDT";
                    
                    // BINANCE KLINES (MUM) VERİSİ: 1 Günlük mumlardan son 30 tanesini getir
                    let res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${cleanSym}&interval=1d&limit=30`);
                    
                    if(res.ok) {
                        let candles = await res.json();
                        
                        // Son 30 günün EN YÜKSEK ve EN DÜŞÜK değerini bul
                        let high30 = -Infinity;
                        let low30 = Infinity;
                        
                        // Binance Mum Formatı: [Time, Open, High, Low, Close, ...]
                        // High = index 2, Low = index 3
                        candles.forEach(c => {
                            let h = parseFloat(c[2]);
                            let l = parseFloat(c[3]);
                            if(h > high30) high30 = h;
                            if(l < low30) low30 = l;
                        });

                        // Stochastic Mantığı: Fiyat bu aralığın neresinde? (0 - 100 arası)
                        // 0 = 30 günün en dibinde, 100 = 30 günün en tepesinde
                        let location = ((currentPrice - low30) / (high30 - low30)) * 100;
                        
                        // ALT SINIR (DİP FIRSATI - UCUZLUK) -> %10'un altındaysa
                        if (location < 10) { 
                            triggerMsg = `AYLIK DİP FIRSATI! ($${currentPrice})`;
                            triggerIcon = "💎"; // Elmas (Fırsat)
                            triggered = true;
                        }
                        
                        // ÜST SINIR (TEPE NOKTASI - PAHALILIK) -> %90'ın üzerindeyse
                        if (location > 90) { 
                            triggerMsg = `AYLIK ZİRVE! SATIŞ BÖLGESİ ($${currentPrice})`;
                            triggerIcon = "⚠️"; 
                            triggered = true;
                        }
                    }
                } catch(e) {
                    // API hatası olursa sessizce geç, sonraki turda tekrar dener
                    console.log("RSI Check Error:", e);
                }
            }
        }

        // --- TETİKLEME AKSİYONU ---
        if (triggered) {
            alarm.active = false; // Tekrar tekrar ötmesin diye kapatıyoruz
            updated = true;
            
            let color = triggerIcon.includes('🚀') || triggerIcon.includes('💎') ? 'success' : 'danger';
            
            // Uygulama İçi Bildirim
            addNotification(color, `${alarm.symbol} ${triggerIcon}`, triggerMsg);

            // Telefon Bildirimi (Android/iOS)
            if (window.Android && window.Android.showNotification) {
                window.Android.showNotification("TradeVia Sinyal", `${alarm.symbol}: ${triggerMsg}`);
            } else if ("Notification" in window && Notification.permission === "granted") {
                new Notification(`TradeVia: ${alarm.symbol}`, { body: triggerMsg, icon: 'ikon.png' });
            }
        }
    }

    if (updated) {
        let activeAlarms = alarms.filter(a => a.active); 
        localStorage.setItem('tradeVia_alarms', JSON.stringify(activeAlarms));
        if(typeof renderActiveAlarmsList === 'function') renderActiveAlarmsList();
    }
}
/* ==========================================================================
   FİNAL ALARM SİSTEMİ (HATASIZ & MODERN ARAYÜZ)
   ========================================================================== */

// 1. MODAL AÇMA VE ARAYÜZ (UI) - FİNAL DÜZELTİLMİŞ HALİ
function openAlarmModal(i) {
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let asset = as[i];
    
    if (!asset) {
        if(typeof addNotification === 'function') addNotification('danger', 'Hata', 'Varlık bulunamadı!');
        return;
    }

    // Mevcut fiyatı al
    let currentPrice = asset.curr || asset.buy;
    let priceText = currentPrice > 0 ? currentPrice.toFixed(2) : "0.00";

    // --- ÖZEL CSS STİLLERİ ---
    const customStyles = `
        <style>
            .alarm-tabs { display: flex; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 4px; margin-bottom: 20px; }
            .a-tab { flex: 1; text-align: center; padding: 10px; font-size: 12px; font-weight: 700; color: #64748b; cursor: pointer; border-radius: 8px; transition: 0.3s; }
            .a-tab.active { background: var(--bg-card); color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
            .a-tab.active i { transform: scale(1.2); }
            
            .alarm-input-box { position: relative; margin-bottom: 15px; }
            .alarm-input-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }
            .alarm-fancy-input { width: 100%; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); padding: 14px 14px 14px 40px; border-radius: 12px; color: white; font-weight: 700; font-size: 16px; outline: none; transition: 0.3s; }
            .alarm-fancy-input:focus { border-color: var(--accent); background: rgba(59,130,246,0.05); }
            
            .dir-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
            .dir-btn { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); padding: 12px 5px; border-radius: 10px; color: var(--text-sub); font-size: 10px; font-weight: 700; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.2s; }
            .dir-btn i { font-size: 16px; margin-bottom: 2px; }
            .dir-btn.active { border-color: var(--accent); background: rgba(59,130,246,0.15); color: white; }
            .dir-btn.up.active { border-color: #10b981; background: rgba(16,185,129,0.15); color: #10b981; }
            .dir-btn.down.active { border-color: #ef4444; background: rgba(239,68,68,0.15); color: #ef4444; }
            
            .ai-pulse-container { position: relative; width: 80px; height: 80px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; }
            .ai-core { width: 50px; height: 50px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); border-radius: 50%; z-index: 2; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(139, 92, 246, 0.6); }
            .ai-core i { font-size: 22px; color: white; }
            .ai-ripple { position: absolute; width: 100%; height: 100%; border: 2px solid rgba(139, 92, 246, 0.5); border-radius: 50%; opacity: 0; animation: ripple 2s infinite cubic-bezier(0, 0.2, 0.8, 1); }
            .ai-ripple:nth-child(2) { animation-delay: -0.5s; }
            @keyframes ripple { 0% { transform: scale(0.8); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
            
            .rsi-label { display: flex; justify-content: space-between; font-size: 9px; color: var(--text-sub); font-weight: 700; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        </style>
    `;

    // --- HTML İÇERİĞİ ---
    let modalInner = `
        ${customStyles}
        
        <input type="hidden" id="alarmIdx" value="${i}">
        <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 18px; font-weight: 800; color: white;">${asset.name}</div>
            <div style="font-size: 12px; color: var(--text-sub);">Şu Anki Fiyat: <span style="color:var(--accent); font-weight:700;">${priceText}</span></div>
        </div>

        <div class="alarm-tabs">
            <div class="a-tab active" onclick="switchNewTab('price', this)"><i class="fas fa-crosshairs"></i> Fiyat</div>
            <div class="a-tab" onclick="switchNewTab('volatility', this)"><i class="fas fa-bolt"></i> Volatilite</div>
            <div class="a-tab" onclick="switchNewTab('rsi', this)"><i class="fas fa-wave-square"></i> İndikatör</div>
        </div>

        <div id="tab-content-price" class="alarm-tab-content">
            <div style="font-size:11px; color:var(--text-sub); margin-bottom:8px; font-weight:600;">HEDEF FİYAT (YUKARI)</div>
            <div class="alarm-input-box">
                <i class="fas fa-arrow-up" style="color:#10b981"></i>
                <input type="number" id="alarmUpper" class="alarm-fancy-input" placeholder="Örn: ${ (currentPrice * 1.05).toFixed(2) }">
            </div>

            <div style="font-size:11px; color:var(--text-sub); margin-bottom:8px; font-weight:600;">STOP / DÜŞÜŞ (AŞAĞI)</div>
            <div class="alarm-input-box">
                <i class="fas fa-arrow-down" style="color:#ef4444"></i>
                <input type="number" id="alarmLower" class="alarm-fancy-input" placeholder="Örn: ${ (currentPrice * 0.95).toFixed(2) }">
            </div>
            
            <button class="btn-main" onclick="saveAlarm('PRICE')">ALARM KUR</button>
        </div>

        <div id="tab-content-volatility" class="alarm-tab-content" style="display:none;">
            <div style="background:rgba(245,158,11,0.1); padding:12px; border-radius:12px; font-size:11px; color:#fbbf24; margin-bottom:15px; border:1px solid rgba(245,158,11,0.2);">
                <i class="fas fa-info-circle"></i> <b>Ani Hareket Yakalayıcı:</b><br>
                Fiyat aniden sert bir hareket yaparsa (Pump veya Dump) seni uyarır.
            </div>

            <div style="font-size:11px; color:var(--text-sub); margin-bottom:8px; font-weight:600;">TAKİP YÖNÜ</div>
            <div class="dir-grid">
                <div class="dir-btn up" onclick="selectDirection('UP', this)"><i class="fas fa-rocket"></i> Ralli</div>
                <div class="dir-btn active" onclick="selectDirection('BOTH', this)"><i class="fas fa-arrows-alt-v"></i> Farketmez</div>
                <div class="dir-btn down" onclick="selectDirection('DOWN', this)"><i class="fas fa-crash"></i> Çöküş</div>
            </div>
            <input type="hidden" id="volDirection" value="BOTH">

            <div style="font-size:11px; color:var(--text-sub); margin-bottom:8px; font-weight:600;">YÜZDE KAÇ OYNARSA?</div>
            <div class="alarm-input-box">
                <i class="fas fa-percent" style="color:#fbbf24"></i>
                <input type="number" id="alarmPctUp" class="alarm-fancy-input" placeholder="%5">
            </div>
            
            <div style="display:flex; gap:8px; justify-content:center; margin-bottom:15px;">
                <button class="ratio-btn" onclick="document.getElementById('alarmPctUp').value=3">%3</button>
                <button class="ratio-btn" onclick="document.getElementById('alarmPctUp').value=5">%5</button>
                <button class="ratio-btn" onclick="document.getElementById('alarmPctUp').value=10">%10</button>
            </div>

            <button class="btn-main" onclick="saveAlarm('VOLATILITY')">TAKİBİ BAŞLAT</button>
        </div>

        <div id="tab-content-rsi" class="alarm-tab-content" style="display:none;">
            <div style="text-align:center; padding:10px 0;">
                
                <div class="ai-pulse-container">
                    <div class="ai-ripple"></div>
                    <div class="ai-ripple"></div>
                    <div class="ai-core">
                        <i class="fas fa-brain"></i>
                    </div>
                </div>

                <div style="font-size:15px; font-weight:800; color:white;">AI Trend Analizi</div>
                <p style="font-size:11px; color:var(--text-sub); margin:10px 0; line-height:1.6;">
                    Yapay zeka, <b>${asset.name}</b> fiyatının <b>son 30 günün</b> zirve ve dip noktalarına göre konumunu izler.<br>Fırsat oluştuğunda otomatik bildirir.
                </p>
                
                <div class="rsi-label">
                    <span style="color:#10b981"><i class="fas fa-arrow-down"></i> AYLIK DİP</span>
                    <span style="color:#ef4444">AYLIK ZİRVE <i class="fas fa-arrow-up"></i></span>
                </div>
            </div>
            
            <button class="btn-main" onclick="saveAlarm('RSI')" style="margin-top:20px; background:linear-gradient(135deg, #8b5cf6, #3b82f6); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);">
                <i class="fas fa-magic"></i> ANALİZİ BAŞLAT
            </button>
        </div>
        
        <div style="margin-top:15px; text-align:center;">
            <button onclick="closeModal('alarmModal')" style="background:none; border:none; color:var(--text-sub); font-size:12px; cursor:pointer;">Vazgeç</button>
        </div>
    `;

    // Eski modalın içini temizle ve yenisini bas
    let modalEl = document.querySelector('#alarmModal .modal');
    if(modalEl) {
        modalEl.innerHTML = modalInner;
        document.getElementById('alarmModal').style.display = 'flex';
    } else {
        console.error("Alarm Modal HTML yapısı bulunamadı!");
    }
}

// Sekme Değiştirme
function switchNewTab(tabName, btn) {
    document.querySelectorAll('.alarm-tab-content').forEach(el => el.style.display = 'none');
    let target = document.getElementById('tab-content-' + tabName);
    if(target) target.style.display = 'block';
    
    document.querySelectorAll('.a-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
}

// Yön Seçimi
function selectDirection(dir, btn) {
    document.getElementById('volDirection').value = dir;
    document.querySelectorAll('.dir-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

// 2. KAYIT VE UNDEFINED HATASINI ÖNLEYEN FONKSİYON
function saveAlarm(type) {
    let idxElement = document.getElementById('alarmIdx');
    if (!idxElement) {
        alert("Sistem hatası: Index bulunamadı.");
        return;
    }
    
    let idx = idxElement.value;
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let asset = as[idx];

    // --- UNDEFINED HATASI ÇÖZÜMÜ ---
    if (!asset) {
        alert("Varlık bilgisi alınamadı! Lütfen sayfayı yenileyip tekrar deneyin.");
        return;
    }

    let alarms = JSON.parse(localStorage.getItem('tradeVia_alarms')) || [];
    let addedCount = 0;

    // A) FİYAT ALARMI
    if (type === 'PRICE') {
        let upInput = document.getElementById('alarmUpper');
        let downInput = document.getElementById('alarmLower');
        
        let up = upInput ? parseFloat(upInput.value) : 0;
        let down = downInput ? parseFloat(downInput.value) : 0;
        
        if (!up && !down) return addNotification('warn', 'Eksik', 'Lütfen en az bir fiyat girin.');

        if (up) {
            alarms.push({ id: Date.now() + 1, symbol: asset.name, target: up, direction: 'UP', type: 'PRICE', active: true });
            addedCount++;
        }
        if (down) {
            alarms.push({ id: Date.now() + 2, symbol: asset.name, target: down, direction: 'DOWN', type: 'PRICE', active: true });
            addedCount++;
        }
    }

    // B) VOLATİLİTE ALARMI
    else if (type === 'VOLATILITY') {
        let pctInput = document.getElementById('alarmPctUp');
        let dirInput = document.getElementById('volDirection');
        
        let pct = pctInput ? parseFloat(pctInput.value) : 0;
        let dir = dirInput ? dirInput.value : 'BOTH';
        let basePrice = asset.curr || asset.buy;

        if (!pct) return addNotification('warn', 'Eksik', 'Yüzde değeri giriniz.');

        alarms.push({ 
            id: Date.now() + 3, 
            symbol: asset.name, 
            basePrice: basePrice, 
            percent: pct, 
            direction: dir, 
            type: 'VOLATILITY', 
            active: true 
        });
        addedCount++;
    }

    // C) RSI ALARMI
    else if (type === 'RSI') {
        // Zaten var mı kontrolü
        let exists = alarms.find(a => a.symbol === asset.name && a.type === 'RSI' && a.active);
        if (exists) return addNotification('info', 'Zaten Var', 'Bu varlık zaten takip ediliyor.');

        alarms.push({ 
            id: Date.now() + 4, 
            symbol: asset.name, 
            type: 'RSI', 
            active: true 
        });
        addedCount++;
    }

    // KAYDETME İŞLEMİ
    if (addedCount > 0) {
        localStorage.setItem('tradeVia_alarms', JSON.stringify(alarms));
        
        // Karttaki zili yakmak için flag ekle
        asset.alarm = true;
        localStorage.setItem('myPF_final', JSON.stringify(as));

        addNotification('success', 'Alarm Kuruldu', `${asset.name} için ${addedCount} kural aktif.`);
        document.getElementById('alarmModal').style.display = 'none';
        
        // Arayüzü yenile
        if(typeof loadPF === 'function') loadPF(false);
        if(typeof renderActiveAlarmsList === 'function') renderActiveAlarmsList();
    }
}

// 3. SİLME FONKSİYONU
function removeAlarm(id) {
    if(!confirm("Bu alarmı silmek istiyor musunuz?")) return;
    let alarms = JSON.parse(localStorage.getItem('tradeVia_alarms')) || [];
    let deletedAlarm = alarms.find(a => a.id === id);
    
    alarms = alarms.filter(a => a.id !== id);
    localStorage.setItem('tradeVia_alarms', JSON.stringify(alarms));
    
    // Eğer bu varlığa ait başka alarm kalmadıysa, karttaki zili söndür
    if(deletedAlarm) {
        let remaining = alarms.filter(a => a.symbol === deletedAlarm.symbol);
        if(remaining.length === 0) {
            let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
            let asset = as.find(a => a.name === deletedAlarm.symbol);
            if(asset) {
                delete asset.alarm;
                localStorage.setItem('myPF_final', JSON.stringify(as));
                if(typeof loadPF === 'function') loadPF(false);
            }
        }
    }

    if(typeof renderActiveAlarmsList === 'function') renderActiveAlarmsList();
}

/* --- GÜNCELLENMİŞ ALARM KONTROLÜ (ÖNCELİK: COINGECKO -> YEDEK: BINANCE) --- */
async function checkAllAlarms() {
    let alarms = JSON.parse(localStorage.getItem('tradeVia_alarms')) || [];
    if (alarms.length === 0) return;

    let updated = false;
    let pf = JSON.parse(localStorage.getItem('myPF_final')) || [];

    // Döngü her alarm için çalışır
    for (let alarm of alarms) {
        if (!alarm.active) continue;

        let asset = pf.find(p => p.name === alarm.symbol);
        if (!asset || !asset.curr) continue; 

        let currentPrice = asset.curr;
        let triggered = false;
        let triggerMsg = "";
        let triggerIcon = "";

        // --- 1. FİYAT ALARMI ---
        if (alarm.type === 'PRICE') {
            if (alarm.direction === 'UP' && currentPrice >= alarm.target) {
                triggerMsg = `HEDEF GELDİ: ${currentPrice}`; triggerIcon = "🚀"; triggered = true;
            }
            if (alarm.direction === 'DOWN' && currentPrice <= alarm.target) {
                triggerMsg = `DÜŞÜŞ LİMİTİ: ${currentPrice}`; triggerIcon = "🔻"; triggered = true;
            }
        }

        // --- 2. VOLATİLİTE ALARMI ---
        else if (alarm.type === 'VOLATILITY') {
            let rawChange = ((currentPrice - alarm.basePrice) / alarm.basePrice) * 100;
            
            if ((alarm.direction === 'UP' || alarm.direction === 'BOTH') && rawChange >= alarm.percent) {
                triggerMsg = `ANİ YÜKSELİŞ: +%${rawChange.toFixed(2)} 🚀`; triggerIcon = "⚡"; triggered = true;
            }
            if ((alarm.direction === 'DOWN' || alarm.direction === 'BOTH') && rawChange <= -alarm.percent) {
                triggerMsg = `ANİ ÇÖKÜŞ: %${rawChange.toFixed(2)} 🔻`; triggerIcon = "📉"; triggered = true;
            }
        }

        // --- 3. AI TREND / İNDİKATÖR (30 GÜNLÜK ANALİZ) ---
        else if (alarm.type === 'RSI') {
            
            // API yükünü dengelemek için %20 şansla çalıştır (Saniyede bir sorgu atmasın diye)
            if(Math.random() > 0.8) { 
                // Sembolü temizle (Örn: BINANCE:BTCUSDT -> BTC)
                let cleanSym = asset.name.replace('BINANCE:','').replace('USDT','').replace('TRY','').trim();
                let high30 = -Infinity; 
                let low30 = Infinity;
                let dataFound = false;

                // --- PLAN A: COINGECKO ---
                try {
                    if(!coingeckoApiKey) throw new Error("No Key");

                    // 1. Arama yapıp ID bul
                    const searchRes = await fetch(`https://api.coingecko.com/api/v3/search?query=${cleanSym}&x_cg_demo_api_key=${coingeckoApiKey}`);
                    const searchData = await searchRes.json();
                    
                    if(searchData.coins && searchData.coins.length > 0) {
                        // En iyi eşleşmeyi al
                        let coinId = searchData.coins[0].id;
                        let exact = searchData.coins.find(c => c.symbol.toUpperCase() === cleanSym.toUpperCase());
                        if(exact) coinId = exact.id;

                        // 2. 30 Günlük Market Chart Çek
                        const chartRes = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=30&x_cg_demo_api_key=${coingeckoApiKey}`);
                        const chartData = await chartRes.json();

                        if(chartData.prices && chartData.prices.length > 0) {
                            // Fiyatları tara
                            chartData.prices.forEach(p => {
                                let val = p[1];
                                if(val > high30) high30 = val;
                                if(val < low30) low30 = val;
                            });
                            dataFound = true;
                        }
                    }
                } catch(cgError) {
                    // CoinGecko hatası olursa sessizce Binance'e geç (Plan B)
                }

                // --- PLAN B: BINANCE (YEDEK) ---
                if (!dataFound) {
                    try {
                        let binSym = cleanSym.toUpperCase() + "USDT";
                        let res = await fetch(`https://api.binance.com/api/v3/klines?symbol=${binSym}&interval=1d&limit=30`);
                        if(res.ok) {
                            let candles = await res.json();
                            // Binance formatı: [Time, Open, High, Low, Close...]
                            candles.forEach(c => {
                                let h = parseFloat(c[2]); let l = parseFloat(c[3]);
                                if(h > high30) high30 = h; 
                                if(l < low30) low30 = l;
                            });
                            dataFound = true;
                        }
                    } catch(binError) {
                        // İkisi de çalışmazsa bu seferlik pas geç
                    }
                }

                // --- SONUÇ DEĞERLENDİRME ---
                if (dataFound && high30 !== -Infinity) {
                    // Konum Hesapla (0 = Dip, 100 = Zirve)
                    let loc = ((currentPrice - low30) / (high30 - low30)) * 100;
                    
                    if (loc < 10) { 
                        triggerMsg = `DİP FIRSATI (Aylık)`; 
                        triggerIcon = "💎"; 
                        triggered = true; 
                    }
                    if (loc > 90) { 
                        triggerMsg = `TEPE NOKTASI (Aylık)`; 
                        triggerIcon = "⚠️"; 
                        triggered = true; 
                    }
                }
            }
        }

        // --- BİLDİRİM GÖNDERME ---
        if (triggered) {
            alarm.active = false; 
            updated = true;
            let color = triggerIcon.includes('🚀') || triggerIcon.includes('💎') ? 'success' : 'danger';
            
            // 1. Uygulama İçi
            if(typeof addNotification === 'function') addNotification(color, `${alarm.symbol} ${triggerIcon}`, triggerMsg);
            
            // 2. Android WebView (Varsa)
            if (window.Android && window.Android.showNotification) {
                window.Android.showNotification("TradeVia AI", `${asset.name}: ${triggerMsg}`);
            } 
            // 3. Web Tarayıcı
            else if ("Notification" in window && Notification.permission === "granted") {
                new Notification(`TradeVia AI: ${alarm.symbol}`, { body: triggerMsg, icon: 'ikon.png' });
            }
        }
    }

    if (updated) {
        let activeAlarms = alarms.filter(a => a.active); 
        localStorage.setItem('tradeVia_alarms', JSON.stringify(activeAlarms));
        if(typeof renderActiveAlarmsList === 'function') renderActiveAlarmsList();
    }
}

    function toggleExitCurrency() { exitCurrency = (exitCurrency === 'TRY') ? 'USD' : 'TRY'; let btn = document.getElementById('sellCurrencyToggle'); if(exitCurrency === 'TRY') { btn.innerText = '₺'; btn.className = 'currency-toggle-btn active-try'; } else { btn.innerText = '$'; btn.className = 'currency-toggle-btn active-usd'; } calcSellPreview(); }
    
    function openSell(i) { let as = JSON.parse(localStorage.getItem('myPF_final')) || []; let asset = as[i]; if(!asset) return; document.getElementById('sellIdx').value = i; document.getElementById('sellMaxAmt').innerText = asset.amt; document.getElementById('sellAmt').value = ""; exitCurrency = asset.origin; let btn = document.getElementById('sellCurrencyToggle'); if(exitCurrency === 'TRY') { btn.innerText = '₺'; btn.className = 'currency-toggle-btn active-try'; } else { btn.innerText = '$'; btn.className = 'currency-toggle-btn active-usd'; } let currentP = asset.curr || asset.buy; document.getElementById('sellPrice').value = currentP.toFixed(2); document.getElementById('sellSummaryBox').style.display = 'none'; document.getElementById('sellModal').style.display = 'flex'; calcSellPreview(); }
    
    function setSellRatio(ratio) { let i = document.getElementById('sellIdx').value; let as = JSON.parse(localStorage.getItem('myPF_final')); if(as[i]) { let val = Math.floor(as[i].amt * ratio * 1000) / 1000; document.getElementById('sellAmt').value = val; calcSellPreview(); } }
    
    function calcSellPreview() { let i = document.getElementById('sellIdx').value; let as = JSON.parse(localStorage.getItem('myPF_final')); let asset = as[i]; let amt = parseFloat(document.getElementById('sellAmt').value) || 0; let price = parseFloat(document.getElementById('sellPrice').value) || 0; if(amt > 0 && price > 0) { let total = amt * price; let sym = exitCurrency === 'TRY' ? '₺' : '$'; let buyPriceNormalized = asset.buy; if(asset.origin === 'USD' && exitCurrency === 'TRY') buyPriceNormalized = asset.buy * usdTryRate; else if(asset.origin === 'TRY' && exitCurrency === 'USD') buyPriceNormalized = asset.buy / usdTryRate; let pnl = (price - buyPriceNormalized) * amt; document.getElementById('ssTotal').innerText = sym + total.toLocaleString(undefined, {minimumFractionDigits:2}); let pnlEl = document.getElementById('ssPnL'); pnlEl.innerText = (pnl >= 0 ? '+' : '') + sym + pnl.toLocaleString(undefined, {minimumFractionDigits:2}); pnlEl.style.color = pnl >= 0 ? 'var(--success)' : 'var(--danger)'; document.getElementById('sellSummaryBox').style.display = 'block'; } else { document.getElementById('sellSummaryBox').style.display = 'none'; } }
    
/* --- DÜZELTİLMİŞ VE GARANTİLİ SATIŞ ONAYI --- */
function confirmSell() { 
    let i = document.getElementById('sellIdx').value; 
    
    // Girdileri Sayıya Çevir (Hata payını sıfırla)
    let amt = parseFloat(document.getElementById('sellAmt').value); 
    let pr = parseFloat(document.getElementById('sellPrice').value); 
    
    if (!amt || !pr) return addNotification('warn', 'Eksik Bilgi', 'Miktar ve fiyat giriniz.'); 
    
    let as = JSON.parse(localStorage.getItem('myPF_final')) || []; 
    let ast = as[i]; 
    
    if (!ast) return addNotification('danger', 'Hata', 'Varlık bulunamadı.');
    if (amt > ast.amt) return addNotification('danger', 'Hata', 'Sahip olduğunuzdan fazlasını satamazsınız.'); 

    // Satışın yapıldığı para birimi (USD mi TL mi?)
    let transactionCurrency = exitCurrency; 
    let globalUsdRate = (typeof usdTryRate !== 'undefined' && usdTryRate > 0) ? usdTryRate : 36.50;

    // --- 1. MALİYET HESABI (CRITICAL FIX) ---
    // Varlığın alış maliyetini, satış yaptığımız para birimine çevirelim
    let buyCostPerUnit = parseFloat(ast.buy); // Varlığın orijinal alış fiyatı
    
    // Eğer varlık USD ise ama biz TL satıyorsak -> Maliyeti TL'ye çevir
    if(ast.origin === 'USD' && transactionCurrency === 'TRY') {
        buyCostPerUnit = buyCostPerUnit * globalUsdRate;
    }
    // Eğer varlık TL ise ama biz USD satıyorsak -> Maliyeti USD'ye çevir
    else if(ast.origin === 'TRY' && transactionCurrency === 'USD') {
        buyCostPerUnit = buyCostPerUnit / globalUsdRate;
    }
    
    // --- 2. KÂR/ZARAR HESABI ---
    let totalSaleRevenue = amt * pr;               // Kasaya Girecek Para
    let totalCostBasis = amt * buyCostPerUnit;     // Bu malın bize maliyeti
    let tradePnL = totalSaleRevenue - totalCostBasis; // NET KÂR

    // --- 3. DETAYLARI OLUŞTUR (Analiz Sayfası İçin) ---
    let plPercent = 0;
    if(buyCostPerUnit > 0) {
        plPercent = ((pr - buyCostPerUnit) / buyCostPerUnit) * 100;
    }

    let note = "";
    if(tradePnL > 0) note = `Kâr: %${plPercent.toFixed(2)}`;
    else if(tradePnL < 0) note = `Zarar: %${plPercent.toFixed(2)}`;
    else note = "Başabaş İşlem";

    let detailObj = {
        avgCost: buyCostPerUnit, // Dönüştürülmüş maliyet
        plPercent: plPercent,
        usdRateAtSell: globalUsdRate,
        note: note
    };

    // --- 4. KASAYA İŞLEME (Dönüşümlü) ---
    // Kasaya her zaman uygulamanın ana para birimi (appSettings.currency) cinsinden eklenir
    let cashToAdd = 0;
    let profitToAdd = 0;

    if(appSettings.currency === transactionCurrency) {
        cashToAdd = totalSaleRevenue;
        profitToAdd = tradePnL;
    } else {
        // Eğer uygulama TL ise ama işlem USD ise -> TL'ye çevirip kasaya koy
        if(appSettings.currency === 'TRY' && transactionCurrency === 'USD') {
            cashToAdd = totalSaleRevenue * globalUsdRate;
            profitToAdd = tradePnL * globalUsdRate;
        } 
        // Eğer uygulama USD ise ama işlem TRY ise -> USD'ye çevirip kasaya koy
        else if(appSettings.currency === 'USD' && transactionCurrency === 'TRY') {
            cashToAdd = totalSaleRevenue / globalUsdRate;
            profitToAdd = tradePnL / globalUsdRate;
        }
    }

    cashBalance += cashToAdd; 
    realizedPnL += profitToAdd; 
    
    localStorage.setItem('tm_cash_balance', cashBalance); 
    localStorage.setItem('tm_realized_pnl', realizedPnL); 
    
    // 5. GEÇMİŞE KAYDET
    logHistory('SATIM', ast.name, amt, pr, '', transactionCurrency, tradePnL, detailObj); 
    
    // Portföyden Düş
    ast.amt -= amt; 
    if (ast.amt <= 0) as.splice(i, 1); // Hepsi satıldıysa listeden sil
    localStorage.setItem('myPF_final', JSON.stringify(as)); 
    
    addNotification('success', 'Satış Başarılı', `Kâr/Zarar: ${tradePnL.toFixed(2)} ${transactionCurrency === 'USD' ? '$' : '₺'}`); 
    document.getElementById('sellModal').style.display = 'none'; 
    
    loadPF(true); 
    renderHistory(); 
    loadProfile(); 
}

    function openSimulator(idx) { currentSimAssetIndex = idx; let as = JSON.parse(localStorage.getItem('myPF_final')) || []; let asset = as[idx]; if(!asset) return; document.getElementById('simAssetTitle').innerText = `${asset.name} Simülatörü`; let currentPrice = asset.curr || asset.buy; document.getElementById('simTargetPrice').value = currentPrice.toFixed(2); document.getElementById('simAddPrice').value = currentPrice.toFixed(2); document.getElementById('simRealizePrice').value = currentPrice.toFixed(2); document.querySelectorAll('.sim-result-box').forEach(x => x.style.display = 'none'); document.getElementById('simPercent').value = ""; document.getElementById('simAddAmt').value = ""; document.getElementById('simSellAmt').value = ""; switchSimTab('scenario', document.querySelectorAll('.sim-tab')[0]); document.getElementById('simModal').style.display = 'flex'; }
    function switchSimTab(tabName, btn) { document.querySelectorAll('.sim-content-pane').forEach(p => p.classList.remove('active')); document.getElementById('sim-pane-' + tabName).classList.add('active'); document.querySelectorAll('.sim-tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); }
    function fillSimSell(ratio) { let as = JSON.parse(localStorage.getItem('myPF_final')); let asset = as[currentSimAssetIndex]; if(asset) { document.getElementById('simSellAmt').value = Math.floor(asset.amt * ratio); } }
    function calcSimScenario() { let targetP = parseFloat(document.getElementById('simTargetPrice').value); if(isNaN(targetP)) return; let as = JSON.parse(localStorage.getItem('myPF_final')); let asset = as[currentSimAssetIndex]; let diffPerUnit = targetP - asset.buy; let totalPnL = diffPerUnit * asset.amt; let totalVal = targetP * asset.amt; let percentChange = ((targetP - asset.buy) / asset.buy) * 100; let sym = asset.origin === 'USD' ? '$' : '₺'; document.getElementById('resSimVal').innerText = sym + totalVal.toLocaleString(undefined, {minimumFractionDigits:2}); document.getElementById('resSimDiff').innerText = `%${percentChange.toFixed(2)}`; let pnlEl = document.getElementById('resSimPnL'); pnlEl.innerText = (totalPnL >= 0 ? '+' : '') + sym + totalPnL.toLocaleString(undefined, {minimumFractionDigits:2}); pnlEl.className = totalPnL >= 0 ? 'val-up' : 'val-down'; let box = document.getElementById('simResScenario'); box.style.display = 'block'; box.className = 'sim-result-box ' + (totalPnL >= 0 ? 'profit' : 'loss'); }
    function calcSimScenarioPercent() { let p = parseFloat(document.getElementById('simPercent').value); if(isNaN(p)) return; let as = JSON.parse(localStorage.getItem('myPF_final')); let asset = as[currentSimAssetIndex]; let targetP = asset.buy * (1 + (p/100)); document.getElementById('simTargetPrice').value = targetP.toFixed(2); calcSimScenario(); }
    function calcSimAvg() { let newAmt = parseFloat(document.getElementById('simAddAmt').value); let newPrice = parseFloat(document.getElementById('simAddPrice').value); if(!newAmt || !newPrice) return; let as = JSON.parse(localStorage.getItem('myPF_final')); let asset = as[currentSimAssetIndex]; let oldTotal = asset.amt * asset.buy; let newTotal = newAmt * newPrice; let finalAmt = asset.amt + newAmt; let finalAvg = (oldTotal + newTotal) / finalAmt; let sym = asset.origin === 'USD' ? '$' : '₺'; document.getElementById('resOldAvg').innerText = sym + asset.buy.toFixed(2); document.getElementById('resNewAvg').innerText = sym + finalAvg.toFixed(2); document.getElementById('resTotalCost').innerText = sym + (oldTotal + newTotal).toLocaleString(undefined, {minimumFractionDigits:2}); let box = document.getElementById('simResAvg'); box.style.display = 'block'; box.className = 'sim-result-box'; }
    function calcSimRealize() { let sellAmt = parseFloat(document.getElementById('simSellAmt').value); let sellPrice = parseFloat(document.getElementById('simRealizePrice').value); if(!sellAmt || !sellPrice) return; let as = JSON.parse(localStorage.getItem('myPF_final')); let asset = as[currentSimAssetIndex]; if(sellAmt > asset.amt) { alert("Fazla miktar!"); return; } let cashIn = sellAmt * sellPrice; let profit = (sellPrice - asset.buy) * sellAmt; let remaining = asset.amt - sellAmt; let sym = asset.origin === 'USD' ? '$' : '₺'; document.getElementById('resCashIn').innerText = sym + cashIn.toLocaleString(undefined, {minimumFractionDigits:2}); let pnlEl = document.getElementById('resRealizedPnL'); pnlEl.innerText = (profit >= 0 ? '+' : '') + sym + profit.toLocaleString(undefined, {minimumFractionDigits:2}); pnlEl.className = profit >= 0 ? 'val-up' : 'val-down'; document.getElementById('resLeftAmt').innerText = remaining + " Adet"; let box = document.getElementById('simResRealize'); box.style.display = 'block'; box.className = 'sim-result-box ' + (profit >= 0 ? 'profit' : 'loss'); }
    
    /* --- YENİ GELİŞMİŞ HABER MOTORU --- */
let newsInterval;
let newsCountdown = 60;
let isNewsPaused = false;
let currentNewsQuery = "Ekonomi";

function initNewsSystem() {
    loadNews(currentNewsQuery);
    startNewsTimer();
}

function startNewsTimer() {
    clearInterval(newsInterval);
    newsCountdown = 60;
    updateTimerUI();
    newsInterval = setInterval(() => {
        if (isNewsPaused) return;
        newsCountdown--;
        updateTimerUI();
        if (newsCountdown <= 0) {
            loadNews(currentNewsQuery, true);
            newsCountdown = 60;
        }
    }, 1000);
}

function updateTimerUI() {
    const bar = document.getElementById('refreshBar');
    const txt = document.getElementById('refreshTimer');
    if (bar) bar.style.width = (newsCountdown / 60 * 100) + "%";
    if (txt) txt.innerText = newsCountdown + "s";
}

function toggleAutoRefresh(btn) {
    isNewsPaused = !isNewsPaused;
    const icon = document.getElementById('refreshIcon');
    const badge = document.getElementById('newsStatusBadge');
    if (isNewsPaused) {
        icon.classList.remove('fa-spin');
        btn.style.opacity = "0.5";
        badge.style.background = "var(--text-sub)";
        document.getElementById('newsStatusLabel').innerText = "DURAKLATILDI";
    } else {
        icon.classList.add('fa-spin');
        btn.style.opacity = "1";
        badge.style.background = "var(--success)";
        document.getElementById('newsStatusLabel').innerText = "CANLI YAYIN";
    }
}

/* --- ZENGİNLEŞTİRİLMİŞ FİLTRE FONKSİYONU --- */
/* --- GELİŞMİŞ GLOBAL ARAMA MOTORU (LİSTEDE YOKSA BİLE BULUR) --- */
let globalSearchTimer;

function filterUnifiedList(val) {
    val = val.trim(); // Boşlukları temizle
    const listContainer = document.getElementById('infiniteMarketList');
    
    // 1. ÖNCE MEVCUT LİSTEYİ FİLTRELE (HIZLI SONUÇ)
    // Ekranda zaten varsa anında gösterelim
    const items = listContainer.querySelectorAll('.infinite-item');
    let visibleCount = 0;

    // Önceki "Global Sonuç" kutusu varsa temizle
    const oldGlobal = document.getElementById('global-search-result');
    if (oldGlobal) oldGlobal.remove();

    if (val.length === 0) {
        // Arama kutusu boşsa her şeyi göster
        items.forEach(item => item.style.display = 'flex');
        return;
    }

    items.forEach(item => {
        // Sembolü al (HTML içinden)
        let symElement = item.querySelector('.ii-sym');
        if (symElement) {
            let text = symElement.innerText.toUpperCase();
            if (text.includes(val.toUpperCase())) {
                item.style.display = 'flex';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        }
    });

    // 2. EĞER LİSTEDE YOKSA VEYA AZ SONUÇ VARSA -> GLOBAL ARA
    // (CoinGecko veya Genel Sistemde Ara)
    if (val.length > 2) {
        
        clearTimeout(globalSearchTimer);

        // Kullanıcı yazmayı bitirince (0.5sn sonra) aramayı başlat
        globalSearchTimer = setTimeout(async () => {
            
            // Eğer daha önce eklemediysek, listenin en altına "Global Sonuçlar" kutusu ekle
            let globalBox = document.getElementById('global-search-result');
            if (!globalBox) {
                globalBox = document.createElement('div');
                globalBox.id = 'global-search-result';
                globalBox.style.padding = "10px";
                globalBox.style.marginTop = "10px";
                globalBox.innerHTML = `<div style="text-align:center; color:var(--text-sub); font-size:11px;"><i class="fas fa-circle-notch fa-spin"></i> Global Piyasalar Taranıyor: <b>${val}</b></div>`;
                listContainer.appendChild(globalBox);
            }

            let foundAny = false;

            // A) COINGECKO ARAMASI (Kripto Modundaysak)
            if (currentCategory === 'kripto' && coingeckoApiKey) {
                try {
                    const url = `https://api.coingecko.com/api/v3/search?query=${val}&x_cg_demo_api_key=${coingeckoApiKey}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    if (data.coins && data.coins.length > 0) {
                        let html = `<div style="font-size:10px; font-weight:700; color:var(--accent); margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">KRİPTO SONUÇLARI</div>`;
                        
                        // İlk 5 sonucu göster
                        data.coins.slice(0, 5).forEach(coin => {
                            html += `
                            <div class="infinite-item" onclick="openCoinGeckoDetail('${coin.id}')" style="background:rgba(59, 130, 246, 0.1); border:1px solid rgba(59, 130, 246, 0.2);">
                                <div class="ii-left">
                                    <img src="${coin.thumb}" style="width:24px; height:24px; border-radius:50%; margin-right:10px;">
                                    <div class="ii-info">
                                        <span class="ii-sym">${coin.symbol}</span>
                                        <span class="ii-vol">${coin.name}</span>
                                    </div>
                                </div>
                                <div class="ii-right">
                                    <span class="ii-price" style="font-size:10px; color:var(--text-sub);">Detay <i class="fas fa-chevron-right"></i></span>
                                </div>
                            </div>`;
                        });
                        globalBox.innerHTML = html;
                        foundAny = true;
                    }
                } catch (e) { console.log("CG Search Error"); }
            }

            // B) MANUEL EŞLEŞTİRME (Hisse/Döviz veya CG Bulamazsa)
            // Kullanıcıya "Bunu Görüntüle" seçeneği sunalım. 
            // openMarketDetail fonksiyonu zaten Binance/Yahoo üzerinden bulmaya çalışacaktır.
            if (!foundAny) {
                globalBox.innerHTML = `
                <div style="font-size:10px; font-weight:700; color:var(--gold); margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">PİYASA ARAMASI</div>
                <div class="infinite-item" onclick="openMarketDetail('${val.toUpperCase()}')" style="background:rgba(255,255,255,0.05);">
                    <div class="ii-left">
                        <div style="width:24px; height:24px; background:var(--bg-input); border-radius:6px; display:flex; align-items:center; justify-content:center; margin-right:10px; font-size:10px;">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="ii-info">
                            <span class="ii-sym">${val.toUpperCase()}</span>
                            <span class="ii-vol">Detaylı Görüntüle</span>
                        </div>
                    </div>
                    <div class="ii-right">
                        <span class="ii-price" style="font-size:10px; color:var(--accent);">Git <i class="fas fa-arrow-right"></i></span>
                    </div>
                </div>`;
            }

        }, 600); // 600ms bekle (Debounce)
    }
}



function filterNews(topic, btn) {
    // 1. Görsel Efekt (Butonu aktif yap)
    document.querySelectorAll('.nf-chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    
    // Arama kutusunu temizle
    document.getElementById('newsSearchInput').value = "";
    
    // 2. Kategoriye Göre ZENGİN Arama Kelimeleri Belirle
    if (topic === 'GENEL') {
        currentNewsQuery = "GENEL"; // Worker bunu Manşet olarak algılar
    } 
    else if (topic === 'EKONOMİ') {
        // Sadece "Ekonomi" değil, ilgili her şeyi getir
        currentNewsQuery = "Ekonomi OR Finans OR Merkez Bankası OR Enflasyon";
    } 
    else if (topic === 'KRİPTO') {
        currentNewsQuery = "Bitcoin OR Kripto Para OR Ethereum OR Altcoin OR Blockchain";
    } 
    else if (topic === 'BORSA') {
        currentNewsQuery = "Borsa İstanbul OR BIST100 OR Hisse Senedi OR KAP";
    } 
    else if (topic === 'EMTİA') {
        currentNewsQuery = "Altın Fiyatları OR Dolar Kuru OR Gram Altın OR Petrol OR Döviz";
    } 
    else {
        currentNewsQuery = topic;
    }

    // 3. Sayacı sıfırla ve haberleri çek
    newsCountdown = 60; 
    loadNews(currentNewsQuery);
}

function runNewsSearch() {
    const val = document.getElementById('newsSearchInput').value.trim();
    if (val.length < 2) return addNotification('warn', 'Arama', 'Lütfen en az 2 karakter girin.');
    document.querySelectorAll('.nf-chip').forEach(c => c.classList.remove('active'));
    currentNewsQuery = val;
    loadNews(val);
    document.getElementById('newsSearchInput').blur();
}

/* --- GOOGLE NEWS (RSS) - FİNAL SÜRÜM (ARAMA & SEMBOL DESTEKLİ) --- */

// 1. Sayfa Yüklendiğinde
document.addEventListener('DOMContentLoaded', () => {
    // Başlangıçta genel ekonomi haberleri gelsin
    loadNews('Ekonomi Finans Borsa');
});

// 2. Kategori Filtreleme Butonları İçin (Ekonomi, Kripto, Borsa...)
function filterNews(topic, btn) {
    // Görsel olarak butonu aktif yap
    document.querySelectorAll('.nf-chip').forEach(c => c.classList.remove('active'));
    if(btn) btn.classList.add('active');

    // Arama kutusunu temizle
    document.getElementById('newsSearchInput').value = "";

    // Konuya göre Google'da en iyi sonuç veren kelimeleri seç
    let query = topic;
    if(topic === 'GENEL') query = 'Ekonomi Finans Gündem';
    if(topic === 'BORSA') query = 'Borsa İstanbul BIST100 Hisse';
    if(topic === 'KRİPTO') query = 'Bitcoin Kripto Para Altcoin Blockchain';
    if(topic === 'EMTİA') query = 'Altın Fiyatları Petrol Gümüş Döviz';

    loadNews(query);
}

// 3. Arama Çubuğu Fonksiyonu (Sembol ve Kelime Arar)
function runNewsSearch() {
    const input = document.getElementById('newsSearchInput');
    if (!input) return;

    let val = input.value.trim();
    
    // Boşsa uyarı ver
    if (val.length < 2) {
        // Eğer bildirim fonksiyonun varsa kullan, yoksa alert
        if(typeof addNotification === 'function') addNotification('warn', 'Arama', 'Lütfen aranacak kelimeyi girin.');
        return;
    }

    // Mobilde klavyeyi kapat
    input.blur();

    // Filtre butonlarının seçimini kaldır (Özel arama yapıyoruz)
    document.querySelectorAll('.nf-chip').forEach(c => c.classList.remove('active'));
    
    // Google News zaten sembolleri tanır (Örn: "ASELS" yazınca Aselsan haberleri gelir)
    loadNews(val);
}

// 4. Ana Haber Çekme Motoru
async function loadNews(query) {
    const container = document.getElementById('newsTimeline');
    if (!container) return;

    // Yükleniyor Animasyonu
    container.innerHTML = `
        <div style="text-align:center; padding:50px; color:var(--text-sub);">
            <i class="fas fa-circle-notch fa-spin" style="font-size:24px; margin-bottom:10px;"></i><br>
            <strong>"${query}"</strong> Haberleri Taranıyor...
        </div>`;

    try {
        // Google RSS Linki (Son 24 saat, Türkçe, Türkiye)
        // q={query} kısmı hem "Ekonomi" kelimesini hem de "BTC" gibi sembolleri arar.
        const googleRssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}+when:1d&hl=tr-TR&gl=TR&ceid=TR:tr`;
        
        // RSS'i JSON'a çeviren servis
        const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(googleRssUrl)}`;

        const response = await fetch(apiUrl);
        const data = await response.json();

        // İçeriği temizle
        container.innerHTML = '';

        if (data.status === 'ok' && data.items.length > 0) {
            let html = "";
            
            // İlk 20 haberi listele
            data.items.slice(0, 20).forEach((item, index) => {
                
                // Tarih formatı
                const date = new Date(item.pubDate);
                const timeStr = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                
                // Başlık temizliği (Sondaki kaynak ismini ayır)
                let title = item.title;
                let source = "Google News";
                
                if (title.includes(' - ')) {
                    const parts = title.split(' - ');
                    source = parts.pop(); 
                    title = parts.join(' - ');
                }

                // Resim bulmaya çalış
                let imgHtml = `<i class="fas fa-newspaper nim-placeholder-icon"></i>`; 
                const imgMatch = item.description.match(/src="([^"]+)"/);
                if (imgMatch) {
                    imgHtml = `<img src="${imgMatch[1]}" alt="Haber" onerror="this.style.display='none'">`;
                }

                // İlk haber Manşet olsun
                let badgeClass = (index === 0) ? "hot" : "";
                let label = (index === 0) ? '<span style="color:var(--danger); background:rgba(239,68,68,0.15); padding:2px 6px; border-radius:4px; margin-left:8px; font-size:9px;">MANŞET</span>' : '';

                html += `
                <div class="news-item-modern ${badgeClass}">
                    <div class="nim-time">
                        <i class="far fa-clock"></i> ${timeStr} ${label}
                    </div>
                    
                    <div class="nim-card" onclick="window.open('${item.link}', '_blank')">
                        <div class="nim-img-box">
                            ${imgHtml}
                        </div>
                        <div class="nim-content">
                            <div class="nim-title">${title}</div>
                            <div class="nim-source">
                                <i class="fas fa-rss" style="font-size:10px; margin-right:4px;"></i> ${source}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
            
        } else {
            container.innerHTML = `
                <div style="text-align:center; padding:30px; color:var(--text-sub);">
                    "${query}" ile ilgili güncel haber bulunamadı.
                </div>`;
        }

    } catch (error) {
        console.error('Haber Hatası:', error);
        container.innerHTML = `
            <div style="text-align:center; padding:30px; color:var(--danger);">
                Haber kaynağına bağlanılamadı. İnternetinizi kontrol edin.
            </div>`;
    }
}

    function toggleTradeMenu() { const content = document.getElementById('tradeContent'); const chevron = document.getElementById('tradeChevron'); const card = document.getElementById('tradeCard'); if (content.classList.contains('collapsed')) { content.classList.remove('collapsed'); chevron.classList.add('rotated'); card.classList.add('open'); } else { content.classList.add('collapsed'); chevron.classList.remove('rotated'); card.classList.remove('open'); } }
    function toggleAssetDetails(id) { const content = document.getElementById('asset-content-' + id); const chevron = document.getElementById('asset-chevron-' + id); if (content.classList.contains('collapsed')) { content.classList.remove('collapsed'); chevron.classList.add('rotated'); } else { content.classList.add('collapsed'); chevron.classList.remove('rotated'); } }
/* --- YENİ GELİŞMİŞ BİLDİRİM SİSTEMİ (DÜZELTİLMİŞ & TELEFON UYUMLU) --- */
function addNotification(type, title, msg) {
    // 1. GİZLİ MOD KONTROLÜ
    const isSecretMode = localStorage.getItem('tm_secret_mode') === 'true';
    if (isSecretMode && title !== 'Gizli Mod Kapalı' && title !== 'Gizli Mod Aktif') {
        return; 
    }

    // 2. UYGULAMA İÇİ KAYIT
    let n = { type: type, title: title, msg: msg, time: new Date().toLocaleTimeString(), read: false };
    
    if(typeof notifications !== 'undefined') {
        notifications.unshift(n);
        if(notifications.length > 50) notifications.pop();
        localStorage.setItem('tm_notifications', JSON.stringify(notifications));
        
        if(typeof updateBadge === 'function') updateBadge();
        
        let pageNotif = document.getElementById('page-notifications');
        if(pageNotif && pageNotif.classList.contains('active') && typeof renderNotifications === 'function') {
            renderNotifications();
        }
    }

    // 3. KATEGORİ AYARLARI KONTROLÜ
    let category = 'trade'; 
    if(title.includes('Alarm') || title.includes('HEDEF') || title.includes('DİKKAT')) category = 'price';
    else if(title.includes('Haber')) category = 'news';
    
    if(typeof notifySettings !== 'undefined' && !notifySettings[category]) return;

    // 4. SES VE TİTREŞİM
    if(typeof notifySettings !== 'undefined' && notifySettings.sound && typeof playNotificationSound === 'function') {
        playNotificationSound(type);
    }

    if(typeof notifySettings !== 'undefined' && notifySettings.vibrate && navigator.vibrate) {
        if(type === 'danger') navigator.vibrate([100, 50, 100, 50, 100]); 
        else navigator.vibrate(200); 
    }

// 5. BROWSER / TELEFON BİLDİRİMİ (TELEFON İÇİN GÜÇLENDİRİLDİ & İKONLU)
if (window.Android && window.Android.showNotification) {
    window.Android.showNotification(title, msg);
    return; // Android halletti, buradan çık.
}

// YÖNTEM B: Web / Mobil Tarayıcı (Service Worker veya Klasik)
if ("Notification" in window && Notification.permission === "granted") {
    
    // --- DEĞİŞİKLİK BURADA: Senin ikonunu tanımladık ---
    let iconUrl = window.location.origin + "/ikon.png?v=2";
    
    
    // Hata durumunda (Danger) kırmızı ikon yerine senin ikonun kalsın istersen burayı silebilirsin
    // veya danger.png gibi bir dosyan varsa onu yazabilirsin.
    if(type === 'danger') iconUrl = "ikon.png"; 

    // Android tepesi için küçük ikon (Şart)
    let badgeIcon = "https://www.tradevia.tr/ikon.png"; 

    let vibPattern = (typeof notifySettings !== 'undefined' && notifySettings.vibrate) ? [200, 100, 200] : [];

    // ÖNCE SERVICE WORKER DENE (Mobil Chrome'da tepeye düşmesi için bu şarttır)
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
        navigator.serviceWorker.ready.then(function(registration) {
            registration.showNotification(title, {
                body: msg,
                icon: iconUrl,    // Senin logon
                badge: badgeIcon, // Tepe ikonu
                vibrate: vibPattern,
                tag: 'tradevia-alert' // Bildirimleri gruplamak için
            });
        }).catch(function(err) {
            console.log("SW Bildirim Hatası, klasike geçiliyor:", err);
            // SW hata verirse aşağıdakini dener
            classicNotification(title, msg, iconUrl, vibPattern);
        });
    } else {
        // SW yoksa klasik yöntemi dene
        classicNotification(title, msg, iconUrl, vibPattern);
    }
}
}

// Yardımcı Fonksiyon: Klasik Bildirim (Masaüstü vb. için)
function classicNotification(title, msg, iconUrl, vibPattern) {
try {
    const notif = new Notification(title, {
        body: msg,
        icon: iconUrl, // Buraya da senin ikonun gelecek
        vibrate: vibPattern
    });
    notif.onclick = function() {
        window.focus();
        notif.close();
        let notifBtn = document.querySelectorAll('.nav-item')[3]; 
        if(notifBtn && typeof switchPage === 'function') switchPage('notifications', notifBtn);
    };
} catch(e) {
    console.warn("Bildirim oluşturulamadı:", e);
}
}

    function renderNotifications(){ let l = document.getElementById('notificationList'); l.innerHTML = ""; if(notifications.length === 0){ l.innerHTML = "<div style='text-align:center; padding:30px; color:var(--text-sub); opacity:0.6;'><i class='fas fa-bell-slash' style='font-size:24px; margin-bottom:10px;'></i><br>Bildirim Yok</div>"; return; } notifications.forEach(n => { let icon = 'info-circle'; let cls = 'n-info'; if(n.type === 'success') { icon = 'check-circle'; cls = 'n-success'; } if(n.type === 'danger') { icon = 'exclamation-circle'; cls = 'n-danger'; } if(n.type === 'warn') { icon = 'bell'; cls = 'n-warn'; } l.innerHTML += `<div class="notif-card ${cls} ${n.read ? '' : 'unread'}"><div class="notif-icon-box"><i class="fas fa-${icon}"></i></div><div class="notif-content"><div class="notif-title">${n.title}</div><div class="notif-msg">${n.msg}</div></div><div class="notif-time">${n.time}</div></div>`; }); notifications.forEach(n => n.read = true); localStorage.setItem('tm_notifications', JSON.stringify(notifications)); updateBadge(); }
    function updateBadge(){ let unread = notifications.filter(n => !n.read).length; let b = document.getElementById('notifBadge'); if(unread > 0){ b.innerText = unread; b.classList.add('active'); } else { b.classList.remove('active'); } }
    function clearNotifications(){ if(confirm("Tüm bildirimler silinsin mi?")){ notifications = []; localStorage.setItem('tm_notifications', JSON.stringify(notifications)); renderNotifications(); updateBadge(); } }
    
    function applyTheme(t){ document.body.setAttribute('data-theme', t); }
    function changeTheme(val){ appSettings.theme = val; localStorage.setItem('tm_settings', JSON.stringify(appSettings)); applyTheme(val); }
    function changeLanguage(val){ appSettings.lang = val; localStorage.setItem('tm_settings', JSON.stringify(appSettings)); applyLang(); }
    function applyLang(){ const t = trans[appSettings.lang]; document.querySelectorAll('[data-lang]').forEach(e => { const key = e.getAttribute('data-lang'); if(t[key]) e.innerText = t[key]; }); }
    function setEntryCurrency(curr) { entryCurrency = curr; let btn = document.getElementById('currencyToggle'); if(btn) { if(curr === 'TRY') { btn.innerText = '₺'; btn.className = 'currency-toggle-btn active-try'; } else { btn.innerText = '$'; btn.className = 'currency-toggle-btn active-usd'; } } calcDca(); calcLiveTotal(); }
    function toggleEntryCurrency() { entryCurrency === 'TRY' ? setEntryCurrency('USD') : setEntryCurrency('TRY'); }
    // --- BAŞLANGIÇ SAYFASI AYARI ---
function changeStartPage(val) {
    appSettings.startPage = val;
    localStorage.setItem('tm_settings', JSON.stringify(appSettings));
    
    // Kullanıcıya küçük bir bildirim verelim (Varsa bildirim sistemin)
    if(typeof addNotification === 'function') {
        addNotification('success', 'Ayar Kaydedildi', 'Uygulama artık bu sayfayla açılacak.');
    }
}

    
        /* --- 1. KISIM: GÜNCELLENMİŞ MARKET PRESETS --- */
    const marketPresets = { 
        'kripto': ['BTC', 'ETH', 'SOL', 'AVAX', 'XRP', 'DOGE', 'PEPE', 'SHIB', 'BNB', 'ADA'], 
        'hisse': ['THYAO.IS', 'ASELS.IS', 'GARAN.IS', 'AKBNK.IS', 'EREGL.IS', 'SASA.IS', 'KCHOL.IS', 'TUPRS.IS', 'SISE.IS', 'BIMAS.IS'], 
        // Yeni Hızlı Motorlar bu anahtarlara ihtiyaç duymadan otomatik liste getirecek, 
        // ancak tanımların burada temiz kalması iyidir.
        'altin': ['ONS', 'GRAM', 'GUMUS'], 
        'doviz': ['USDTRY', 'EURTRY', 'EURUSD', 'GBPTRY'] 
    };

    async function loadMarketTab(category, btn) { currentMarketTab = category; if(btn) { document.querySelectorAll('.m-tab-pro').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } currentRenderId++; const myRenderId = currentRenderId; const container = document.getElementById('marketLiveList'); if(!container) return; container.innerHTML = '<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>'; let list = marketPresets[category] || []; if(list.length > 0) { let firstRaw = list[0]; let firstTv = ""; if(category==='kripto') firstTv = "BINANCE:" + firstRaw + "USDT"; else if(category==='hisse') firstTv = "BIST:" + firstRaw.replace('.IS',''); else if(category==='altin') firstTv = "TVC:GOLD"; else if(category==='doviz') firstTv = "FX:USDTRY"; renderTradingView(firstTv); selectedMarketSymbol = firstTv; } const promises = list.map(async (sym) => { let dName = sym; if(category === 'hisse') dName = sym.replace('.IS',''); else if(displayNames[sym]) dName = displayNames[sym]; let data = await getPrice(sym); if(currentRenderId !== myRenderId) return ""; let priceTxt = "--"; let changeTxt = "--"; let changeClass = "val-neutral"; if(data.price > 0) { let s = data.origin === 'USD' ? '$' : '₺'; priceTxt = s + data.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); changeTxt = "%" + data.change.toFixed(2); changeClass = data.change >= 0 ? "val-up" : "val-down"; } let logo = getAssetLogoHtml(dName); let tvSym = sym; if(category==='kripto') tvSym = "BINANCE:" + sym + "USDT"; else if(category==='hisse') tvSym = "BIST:" + sym.replace('.IS',''); else if(category==='altin' && sym==='GC=F') tvSym = "TVC:GOLD"; else if(category==='doviz' && sym==='TRY=X') tvSym = "FX:USDTRY"; else if(category==='doviz' && sym==='EURTRY=X') tvSym = "FX:EURTRY"; let activeClass = (selectedMarketSymbol === tvSym) ? 'active' : ''; return `<div class="market-row-item ${activeClass}" onclick="selectMarketItem('${tvSym}', this)"><div class="m-row-left">${logo}<div class="m-row-info"><span class="m-row-sym">${dName}</span><span class="m-row-name">${data.source || 'Piyasa'}</span></div></div><div class="m-row-right"><span class="m-row-price">${priceTxt}</span><span class="m-row-change ${changeClass}">${changeTxt}</span></div></div>`; }); const results = await Promise.all(promises); if(currentRenderId === myRenderId) { container.innerHTML = results.join(''); } }
    function selectMarketItem(tvSymbol, el) { selectedMarketSymbol = tvSymbol; if(el) { document.querySelectorAll('.market-row-item').forEach(x => x.classList.remove('active')); el.classList.add('active'); } renderTradingView(tvSymbol); }
    function searchInChart() { let val = document.getElementById('chartSearchInput').value.trim().toUpperCase(); if(!val) return; let cleanVal = val.replace('/', '').replace(' ', '').replace('-', ''); let finalSymbol = cleanVal; if(cleanVal.includes(':')) { renderTradingView(cleanVal); return; } if(currentMarketTab === 'kripto') { const quotes = ['USDT', 'TRY', 'BUSD', 'USDC', 'EUR', 'BTC', 'ETH']; const hasQuote = quotes.some(q => cleanVal.endsWith(q)); if(!hasQuote) finalSymbol = cleanVal + 'USDT'; finalSymbol = 'BINANCE:' + finalSymbol; } else if(currentMarketTab === 'hisse') finalSymbol = 'BIST:' + cleanVal; else if(currentMarketTab === 'doviz') finalSymbol = 'FX:' + cleanVal; else if(currentMarketTab === 'altin') { if(cleanVal === 'ALTIN' || cleanVal === 'ONS') finalSymbol = 'TVC:GOLD'; else if(cleanVal === 'GRAM' || cleanVal === 'GRAMALTIN') finalSymbol = 'FX:XAUTRY'; else finalSymbol = 'TVC:' + cleanVal; } renderTradingView(finalSymbol); }
    /* --- GÜNCELLENMİŞ HİBRİT LOGO MOTORU (Kripto Resimli, Diğerleri Kutulu) --- */
function getAssetLogoHtml(symbol) {
    let s = symbol.toUpperCase().trim().replace('.IS','');
    
    // RENK SEÇİMİ (Kutucuklar için lazım)
    let seed = 0;
    for (let i = 0; i < s.length; i++) seed += s.charCodeAt(i);
    const colors = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef', '#f43f5e'];
    let color = colors[seed % colors.length];

    // KUTUCUK HTML'i (Hisseler ve Resmi Bulunamayanlar İçin Yedek)
    const boxHtml = `
        <div style="
            width:40px; height:40px; 
            background:${color}20; 
            border:1px solid ${color}60; 
            border-radius:12px; 
            display:flex; align-items:center; justify-content:center; 
            color:${color}; font-weight:900; font-size:12px; 
            letter-spacing:-0.5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        ">${s.substring(0,3)}</div>`;

    // --- 1. KRİPTO KONTROLÜ ---
    // Eğer USDT içeriyorsa veya bilinen coin listesindeyse veya uzun isimliyse (BABYDOGE gibi)
    const isCrypto = s.includes('USDT') || 
                     ['BTC','ETH','BNB','SOL','XRP','DOGE','ADA','AVAX','SHIB','PEPE','BABYDOGE','FLOKI','FET','ARB','APT'].includes(s) ||
                     (s.length > 5 && !s.includes(' ')); // Genelde uzun semboller coindir

    if (isCrypto) {
        // Sembolü temizle (BTCUSDT -> btc)
        let cleanSym = s.replace('USDT','').toLowerCase();
        
        // Resim çekmeye çalış (Hata verirse kutucuğa döner)
        return `<div class="asset-logo-wrap" style="background:transparent; border:none; width:40px; margin-right:10px;">
            <img src="https://assets.coincap.io/assets/icons/${cleanSym}@2x.png" 
                 style="width:36px; height:36px; border-radius:50%; object-fit:contain;"
                 
onerror="this.outerHTML=\`<div style='width:40px;height:40px;background:${color}20;border:1px solid ${color}60;border-radius:12px;display:flex;align-items:center;justify-content:center;color:${color};font-weight:900;font-size:12px;'>${s.substring(0,3)}</div>\`">
        </div>`;
    }

    // --- 2. HİSSE VE DÖVİZLER (Kutucuk Göster) ---
    return `<div class="asset-logo-wrap" style="background:transparent; border:none; width:40px; margin-right:10px;">
        ${boxHtml}
    </div>`;
}

    function checkPolyInit() { if(polyApiKey) { document.getElementById('polyIndicator').className='poly-status-dot'; testPolygonConnection(); } else { document.getElementById('polyIndicator').className='poly-status-dot idle'; document.getElementById('polyStatusText').innerText="KOD YOK"; } }
    function savePolyKey(val){ polyApiKey=val.trim(); localStorage.setItem('tm_poly_key',polyApiKey); if(polyApiKey==="") checkPolyInit(); else testPolygonConnection(); }
    async function testPolygonConnection() { if(!polyApiKey) return; const ind=document.getElementById('polyIndicator'); const txt=document.getElementById('polyStatusText'); txt.innerText="BAĞLANILIYOR..."; try{ const response=await fetch(`https://api.polygon.io/v2/aggs/ticker/AAPL/prevClose?adjusted=true&apiKey=${polyApiKey}`); if(!response.ok) throw new Error(response.status); const data=await response.json(); if(data.status==="OK" || data.resultsCount>=0){ ind.className='poly-status-dot active'; txt.innerText="AKTİF"; txt.style.color="var(--success)"; } } catch(e){ ind.className='poly-status-dot error'; txt.innerText="HATA"; txt.style.color="var(--danger)"; } }
    async function getHistoricalChange(s){ let data=await getPrice(s); let r=(Math.random()-0.5)*2; return { ...data, daily: data.change, monthly: data.change*5+r, yearly: data.change*10+r }; }
    async function fetchUsdRate(){ try{ let res=await tryBinance('USDTTRY'); if(res) usdTryRate=res.price; else usdTryRate=36.5; } catch{ usdTryRate=36.5; } }
    
    function switchSettingsTab(tab, btn){ document.querySelectorAll('.settings-content').forEach(c => c.classList.remove('active')); document.getElementById('set-' + tab).classList.add('active'); document.querySelectorAll('.s-tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); }
    function delAsset(i){ if(confirm("Silinsin mi?")){ let as = JSON.parse(localStorage.getItem('myPF_final')); as.splice(i,1); localStorage.setItem('myPF_final', JSON.stringify(as)); loadPF(); addNotification('warn', 'Varlık Silindi', 'Portföyden bir varlık kaldırıldı.'); } }
    function clearAllData(){ if(confirm("Tüm veriler silinsin mi?")){ localStorage.clear(); location.reload(); } }
    function togglePrivacy(){ isPrivacyMode = !isPrivacyMode; loadPF(); }
    function changeBaseCurrency(v){ let oldCurr = appSettings.currency; appSettings.currency = v; if(v !== oldCurr) { if(v === 'USD') cashBalance = cashBalance / usdTryRate; else cashBalance = cashBalance * usdTryRate; localStorage.setItem('tm_cash_balance', cashBalance); } localStorage.setItem('tm_settings',JSON.stringify(appSettings)); loadPF(true); renderHistory(); }
    let wlDebounce; function debouncedWlPreview(val) { clearTimeout(wlDebounce); if(val.length < 2) return; const infoDiv = document.getElementById('wlLiveInfo'); infoDiv.innerText = "Aranıyor..."; wlDebounce = setTimeout(async () => { let res = await getPrice(val); if(res.price > 0) infoDiv.innerHTML = `<span style="color:var(--success)">${val.toUpperCase()}: ${res.price.toFixed(2)}</span>`; else infoDiv.innerText = "Bulunamadı"; }, 600); }
    async function addToWatchlist(){ let s = document.getElementById('wlInput').value.trim().toUpperCase(); if(!s) return; let w = JSON.parse(localStorage.getItem('tm_watchlist')) || []; if(w.includes(s)) { return addNotification('warn', 'Zaten Ekli', 'Bu sembol izleme listesinde var.'); } w.push(s); localStorage.setItem('tm_watchlist', JSON.stringify(w)); document.getElementById('wlInput').value = ""; updateWatchlist(); addNotification('success', 'Eklendi', `${s} izlemeye alındı.`); }
    function removeFromWatchlist(s){ let w = JSON.parse(localStorage.getItem('tm_watchlist')) || []; w = w.filter(i => i !== s); localStorage.setItem('tm_watchlist', JSON.stringify(w)); updateWatchlist(); }
    async function updateWatchlist(){ let wl = JSON.parse(localStorage.getItem('tm_watchlist')) || []; let l = document.getElementById('wlList'); l.innerHTML = ""; if(wl.length === 0) { l.innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-sub)'>Liste boş.</div>"; return; } for(let s of wl){ let r = await getHistoricalChange(s); let priceDisplay = r.price > 0 ? (r.origin === 'USD' ? '$' : '₺') + r.price.toFixed(2) : 'Veri Yok'; let changeDisplay = r.price > 0 ? `%${r.change.toFixed(2)}` : '--'; let color = r.change >= 0 ? '#10b981' : '#ef4444'; let tag = getAssetTag(s); let tagClass = tag.t === 'KRİPTO' ? 'kripto' : (tag.t === 'BORSA' ? 'borsa' : 'doviz'); l.innerHTML += `<div class="wl-card-classic" style="border-left-color: ${color};"><div class="wl-c-header"><div><span class="wl-c-sym">${s}</span><span class="wl-c-tag ${tagClass}">${tag.t}</span></div><div class="wl-c-price-box"><span class="wl-c-price">${priceDisplay}</span><span class="wl-c-change" style="color:${color}">${changeDisplay}</span></div></div><div class="wl-c-stats"><div class="wl-c-stat-item"><span class="wl-c-lbl">GÜNLÜK</span><span class="wl-c-val" style="color:${color}">${(r.daily).toFixed(2)}%</span></div><div class="wl-c-stat-item"><span class="wl-c-lbl">AYLIK</span><span class="wl-c-val" style="color:${color}">${(r.monthly).toFixed(2)}%</span></div><div class="wl-c-stat-item"><span class="wl-c-lbl">YILLIK</span><span class="wl-c-val" style="color:${color}">${(r.yearly).toFixed(2)}%</span></div></div><button class="wl-c-del" onclick="removeFromWatchlist('${s}')"><i class="fas fa-trash"></i></button></div>`; } }
    function getAssetTag(s) { if(['ALTIN','GOLD','GRAM'].includes(s)) return {t:'EMTİA'}; if(s.includes('USDT') || (!s.includes('.') && s.length <= 5)) return {t:'KRİPTO'}; if(['USD','EUR','GBP'].includes(s)) return {t:'DÖVİZ'}; return {t:'BORSA'}; }
    function calcDca(){ let s=document.getElementById('addSymbol').value.toUpperCase(); let a=parseFloat(document.getElementById('addAmount').value); let p=parseFloat(document.getElementById('addBuyPrice').value); if(s&&a&&p){ let as=JSON.parse(localStorage.getItem('myPF_final'))||[]; let ex=as.find(i=>i.name===s); if(ex){ let n=((ex.amt*ex.buy)+(a*p))/(ex.amt+a); document.getElementById('dcaPreview').style.display='block'; document.getElementById('dcaText').innerHTML=`Eski: ${ex.buy.toFixed(2)} -> <span class="dca-val">Yeni: ${n.toFixed(2)}</span>`; } else {document.getElementById('dcaPreview').style.display='none';} } calcLiveTotal(); }
    function closeModal(id){document.getElementById(id).style.display='none';} function openModal(id){document.getElementById(id).style.display='flex';}
    function editNote(i){ let as=JSON.parse(localStorage.getItem('myPF_final')); let n=prompt("Not:",as[i].note||""); if(n!==null){as[i].note=n; localStorage.setItem('myPF_final',JSON.stringify(as)); loadPF();} }
    function downloadBackup(){ const d=localStorage.getItem('myPF_final'); const b=new Blob([d],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='yedek.json'; a.click(); }
/* --- DÜZELTİLMİŞ VE KORUMALI EXCEL YÜKLEYİCİ (V22) --- */

// 1. Gelişmiş Sayı Okuma (Hata Payını Sıfırlar)
const safeParseFloat = (val) => {
    if (val === undefined || val === null || val === '') return 0;
    if (typeof val === 'number') return val; // Zaten sayıysa elleme
    
    let str = val.toString().trim();
    if (str === '-') return 0;

    // Sadece rakam, nokta, virgül ve eksi işaretini bırak
    str = str.replace(/[^0-9.,-]/g, '');

    // 1.250,50 (TR) ile 1,250.50 (US) ayrımı
    if (str.includes('.') && str.includes(',')) {
        // Hem nokta hem virgül varsa: Noktaları sil, virgülü nokta yap
        str = str.replace(/\./g, '').replace(',', '.');
    } else if (str.includes(',')) {
        // Sadece virgül varsa (kuruş ayracı ise): Noktaya çevir
        str = str.replace(',', '.');
    }
    
    return parseFloat(str) || 0;
};

// 2. Düzeltilmiş Yükleme Fonksiyonu
window.baslatExcelYukleme = function(input) {
    const file = input.files[0];
    if (!file) return;

    // Loader Göster
    if (!document.getElementById('tm_loader')) {
        const d = document.createElement('div');
        d.id = 'tm_loader';
        d.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white;";
        d.innerHTML = `<i class="fas fa-sync fa-spin" style="font-size:40px; margin-bottom:20px; color:#3b82f6;"></i><h3>Yedek Dosyası İşleniyor...</h3><div id='tm_log' style='font-size:12px; color:#94a3b8; margin-top:10px;'></div>`;
        document.body.appendChild(d);
    }
    document.getElementById('tm_loader').style.display = 'flex';
    const log = (msg) => document.getElementById('tm_log').innerText = msg;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            
            let newPortfolio = [];
            let newHistory = [];
            let foundCash = null;

            log("Sayfalar taranıyor...");

            workbook.SheetNames.forEach(sheetName => {
                const sheetLower = sheetName.toLocaleLowerCase('tr');
                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {header: 1});
                if(rows.length === 0) return;

                // A) NAKİT BULMA
                if (sheetLower.includes("muhasebe") || sheetLower.includes("özet")) {
                    rows.forEach(row => {
                        let rowStr = row.join(" ").toLocaleLowerCase('tr');
                        if (rowStr.includes("kasadaki nakit") || rowStr.includes("nakit")) {
                            row.forEach(cell => {
                                if (cell && /[0-9]/.test(cell.toString()) && !cell.toString().toLowerCase().includes("nakit")) {
                                    foundCash = safeParseFloat(cell);
                                }
                            });
                        }
                    });
                }

                // B) VARLIKLARIM (Portföy) - KRİTİK KISIM
                if (sheetLower.includes("varlık")) {
                    let headIdx = -1;
                    let map = { name:-1, amt:-1, unitCost:-1, totalCost:-1, curr:-1, origin:-1, source:-1 };

                    // Başlıkları bul
                    for(let i=0; i<Math.min(rows.length, 15); i++) {
                        let r = rows[i].map(x => x ? x.toString().toLocaleLowerCase('tr').trim() : "");
                        if(r.some(c => c.includes("varlık") || c.includes("sembol"))) {
                            headIdx = i;
                            r.forEach((c, idx) => {
                                if(c.includes("varlık") || c.includes("sembol")) map.name = idx;
                                if(c === "adet" || c.includes("miktar")) map.amt = idx;
                                
                                // Maliyet Sütunu (Birim ve Toplam ayrımı)
                                if((c.includes("maliyet") || c.includes("birim") || c.includes("ort")) && !c.includes("toplam") && !c.includes("tutar")) {
                                    map.unitCost = idx;
                                }
                                if(c.includes("toplam") && (c.includes("değer") || c.includes("maliyet") || c.includes("tutar"))) map.totalCost = idx;

                                if(c.includes("para") || c.includes("döviz")) map.origin = idx;
                                if(c.includes("kaynak")) map.source = idx;
                            });
                            break;
                        }
                    }

                    if(headIdx !== -1 && map.name !== -1) {
                        for(let j=headIdx+1; j<rows.length; j++) {
                            let r = rows[j];
                            if(!r || !r[map.name]) continue;
                            
                            let pName = r[map.name].toString().trim().toUpperCase();
                            let pAmt = safeParseFloat(r[map.amt]);
                            
                            // MALİYET HESABI: Önce Birim, Yoksa Toplam/Adet
                            let finalCost = 0;
                            if (map.unitCost !== -1) finalCost = safeParseFloat(r[map.unitCost]);
                            
                            if (finalCost === 0 && map.totalCost !== -1 && pAmt > 0) {
                                let totalVal = safeParseFloat(r[map.totalCost]);
                                if(totalVal > 0) finalCost = totalVal / pAmt;
                            }

                            // Kaynak ve Para Birimi Tahmini
                            let pOrigin = (map.origin !== -1 && r[map.origin]) ? r[map.origin].toString().trim().toUpperCase() : 'TRY';
                            if (pName.includes('USD') || pName.includes('USDT') || pName.includes('USDC')) pOrigin = 'USD';
                            
                            let pSource = (map.source !== -1 && r[map.source]) ? r[map.source].toString().trim().toUpperCase() : 'MANUEL';

                            if(pName && pAmt > 0) {
                                newPortfolio.push({
                                    name: pName, 
                                    amt: pAmt, 
                                    buy: finalCost, // MALİYET BURADA KESİNLEŞİR
                                    curr: finalCost, // Geçici olarak güncel fiyatı maliyet yapıyoruz (Sonra güncellenir)
                                    origin: pOrigin, 
                                    image: null, 
                                    source: pSource 
                                });
                            }
                        }
                    }
                }

                // C) İŞLEM GEÇMİŞİ
                if (sheetLower.includes("işlem") || sheetLower.includes("defter")) {
                    let headIdx = -1;
                    let map = { date:-1, type:-1, sym:-1, qty:-1, price:-1, pnl:-1 };

                    for(let i=0; i<Math.min(rows.length, 15); i++) {
                        let r = rows[i].map(x => x ? x.toString().toLocaleLowerCase('tr') : "");
                        if(r.some(c => c.includes("tür")) && r.some(c => c.includes("tarih"))) {
                            headIdx = i;
                            r.forEach((c, idx) => {
                                if(c.includes("tarih")) map.date = idx;
                                if(c.includes("tür")) map.type = idx;
                                if(c.includes("sembol") || c.includes("varlık")) map.sym = idx;
                                if(c.includes("miktar") || c.includes("adet")) map.qty = idx;
                                if(c.includes("fiyat")) map.price = idx;
                                if(c.includes("sonuç") || c.includes("pnl")) map.pnl = idx;
                            });
                            break;
                        }
                    }

                    if(headIdx !== -1) {
                        for(let j=headIdx+1; j<rows.length; j++) {
                            let r = rows[j];
                            if(!r || !r[map.type]) continue;
                            
                            // Tarih Düzeltme
                            let dVal = r[map.date];
                            let fDate = new Date().toLocaleDateString("tr-TR");
                            if(typeof dVal === 'number') {
                                fDate = new Date(Math.round((dVal - 25569)*86400*1000)).toLocaleDateString("tr-TR");
                            } else if(dVal) fDate = dVal.toString().trim();

                            newHistory.push({
                                date: fDate, 
                                time: "00:00",
                                type: r[map.type].toString().toUpperCase().trim(),
                                sym: (map.sym !== -1 && r[map.sym]) ? r[map.sym].toString().toUpperCase().trim() : "NAKİT",
                                qty: (map.qty !== -1) ? safeParseFloat(r[map.qty]) : 0,
                                price: (map.price !== -1) ? safeParseFloat(r[map.price]) : 0,
                                total: 0, 
                                curr: 'TRY',
                                pnl: (map.pnl !== -1) ? safeParseFloat(r[map.pnl]) : 0
                            });
                            let last = newHistory[newHistory.length-1];
                            last.total = last.qty * last.price;
                        }
                    }
                }
            });

            // --- KAYDETME ---
            if (foundCash !== null) localStorage.setItem('tm_cash_balance', foundCash);
            if (newPortfolio.length > 0) localStorage.setItem('myPF_final', JSON.stringify(newPortfolio));
            if (newHistory.length > 0) {
                newHistory.sort((a,b) => {
                    let pa = a.date.split('.'), pb = b.date.split('.');
                    if(pa.length === 3 && pb.length === 3) return new Date(pa[2], pa[1]-1, pa[0]) - new Date(pb[2], pb[1]-1, pb[0]);
                    return 0;
                });
                localStorage.setItem('tm_full_trade_history', JSON.stringify(newHistory));
            }

            log("TAMAMLANDI! Sayfa yenileniyor...");
            setTimeout(() => location.reload(), 1000);

        } catch (err) {
            alert("Hata: " + err.message);
            document.getElementById('tm_loader').style.display = 'none';
        }
    };
    reader.readAsArrayBuffer(file);
};

// 3. YENİLEME KORUMASI (Maliyetin Silinmesini Engeller)
// Bu fonksiyon, otomatik yenileme sırasında sadece 'curr' (Güncel Fiyat) değerini değiştirir, 'buy' (Maliyet) değerine DOKUNMAZ.
const originalLoadPF = window.loadPF;
window.loadPF = async function(refreshData = false) {
    if(!refreshData) {
        if(originalLoadPF) originalLoadPF(false);
        return;
    }

    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    if (as.length === 0) {
        if(originalLoadPF) originalLoadPF(false);
        return;
    }

    // Fiyatları güncelle ama MALİYETİ koru
    let updatedAssets = [];
    for (let i = 0; i < as.length; i++) {
        let a = as[i];
        // Eski maliyeti yedekle (Garanti olsun)
        let safeBuy = a.buy; 
        
        try {
            if(typeof getPrice === 'function') {
                let live = await getPrice(a.name);
                if (live && live.price > 0) {
                    a.curr = live.price; // Sadece fiyatı güncelle
                }
            }
        } catch (err) { console.log(err); }
        
        // Maliyeti geri yükle (Eğer yanlışlıkla silindiyse)
        if(!a.buy || a.buy === 0) a.buy = safeBuy;
        
        updatedAssets.push(a);
    }

    localStorage.setItem('myPF_final', JSON.stringify(updatedAssets));
    renderPortfolioHTML(updatedAssets);
};


    /* --- GÜNCELLENMİŞ EXCEL RAPORLAMA (V16 - ETİKET VE BİRİM FİYAT DESTEKLİ) --- */
function exportComprehensiveReport() {
    if (typeof XLSX === 'undefined') {
        alert("Excel kütüphanesi hazır değil. Lütfen bekleyin.");
        return; 
    }

    // 1. VERİLERİ HAZIRLA
    const pf = JSON.parse(localStorage.getItem('myPF_final')) || [];
    const history = JSON.parse(localStorage.getItem('tm_full_trade_history')) || [];
    const cash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
    const realizedPnL = parseFloat(localStorage.getItem('tm_realized_pnl')) || 0;
    const settings = JSON.parse(localStorage.getItem('tm_settings')) || { currency: 'TRY' };
    const mainSym = settings.currency === 'TRY' ? '₺' : '$';

    // 2. SAYFA 1: ÖZET
    let totalInvested = 0; 
    let totalSalary = 0;   
    history.forEach(t => {
        let val = parseFloat(t.total) || 0;
        if (t.type === 'YATIRMA') totalInvested += val;
        else if (t.type === 'ÇEKME') totalInvested -= val;
        else if (t.type === 'MAAŞ') totalSalary += val;
    });

    let portfolioValue = 0;
    pf.forEach(item => {
        let p = item.curr || item.buy;
        portfolioValue += (p * item.amt);
    });

    let summaryData = [
        ["RAPOR TARİHİ", new Date().toLocaleString('tr-TR')],
        ["", ""],
        ["--- FİNANSAL DURUM ---", "--- DEĞER ---"],
        ["Toplam Varlık", (cash + portfolioValue).toFixed(2) + " " + mainSym],
        ["Kasadaki Nakit", cash.toFixed(2) + " " + mainSym],
        ["", ""],
        ["--- MUHASEBE ---", ""],
        ["Yatırılan Sermaye", totalInvested.toFixed(2) + " " + mainSym],
        ["Realize Kâr", realizedPnL.toFixed(2) + " " + mainSym],
        ["Çekilen Maaşlar", totalSalary.toFixed(2) + " " + mainSym]
    ];

    // 3. SAYFA 2: VARLIKLARIM (DÜZELTİLDİ: Para Birimi ve Kaynak Eklendi)
    let portfolioData = [];
    portfolioData.push(["Varlık", "Adet", "Birim Maliyet", "Para Birimi", "Kaynak", "Güncel Fiyat", "Toplam Değer", "Kâr/Zarar"]);

    pf.forEach(p => {
        let currentPrice = p.curr || p.buy;
        let totalVal = p.amt * currentPrice;
        let totalCost = p.amt * p.buy;
        let pnl = totalVal - totalCost;

        portfolioData.push([
            p.name,           // Varlık Adı
            p.amt,            // Adet
            p.buy,            // Birim Maliyet (Eskiden toplam yazıyordu, düzeldi)
            p.origin || 'TRY',// Para Birimi (USD/TRY) - YENİ
            p.source || 'MANUEL', // Kaynak (Binance/BIST) - YENİ
            currentPrice,     // Güncel Fiyat
            totalVal,         // Toplam Değer
            pnl               // Kâr/Zarar
        ]);
    });

    // 4. SAYFA 3: İŞLEM GEÇMİŞİ (DÜZELTİLDİ: Para Birimi Eklendi)
    let historyData = [];
    historyData.push(["Tarih", "Saat", "Tür", "Sembol", "Miktar", "Fiyat", "Toplam", "Sonuç", "Para Birimi"]);

    [...history].reverse().forEach(h => {
        historyData.push([
            h.date,
            h.time || "00:00",
            h.type,
            h.sym || "NAKİT",
            h.qty || "-",
            h.price || "-",
            parseFloat(h.total).toFixed(2),
            h.pnl ? parseFloat(h.pnl).toFixed(2) : "-",
            h.curr || "TRY" // İşlemin para birimi - YENİ
        ]);
    });

    // 5. DOSYAYI OLUŞTUR
    const wb = XLSX.utils.book_new();
    
    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
    XLSX.utils.book_append_sheet(wb, wsSummary, "Muhasebe Özeti");

    const wsPortfolio = XLSX.utils.aoa_to_sheet(portfolioData);
    wsPortfolio['!cols'] = [{wch:15}, {wch:10}, {wch:12}, {wch:10}, {wch:12}, {wch:12}, {wch:15}, {wch:12}];
    XLSX.utils.book_append_sheet(wb, wsPortfolio, "Varlıklarım");

    const wsHistory = XLSX.utils.aoa_to_sheet(historyData);
    XLSX.utils.book_append_sheet(wb, wsHistory, "İşlem Defteri");

    let dateStr = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');
    XLSX.writeFile(wb, `TradeVia_Yedek_${dateStr}.xlsx`);
}

    function loadProfile() { document.getElementById('displayProfileName').innerText = userProfile.name; document.getElementById('profileNameInput').value = userProfile.name; document.getElementById('displayProfileBio').innerText = userProfile.bio; document.getElementById('profileBioInput').value = userProfile.bio; document.getElementById('profileJoinDate').innerText = userProfile.joinDate; document.getElementById('profileTradeCount').innerText = tradeHistory.length; if(userProfile.img) document.getElementById('displayProfileImg').src = userProfile.img; }
    function saveProfileData() { let name = document.getElementById('profileNameInput').value; let bio = document.getElementById('profileBioInput').value; if(name) userProfile.name = name; if(bio) userProfile.bio = bio; localStorage.setItem('tm_user_profile', JSON.stringify(userProfile)); loadProfile(); addNotification('success', 'Profil', 'Bilgileriniz güncellendi.'); }
    function uploadProfileImg(input) { if (input.files && input.files[0]) { var reader = new FileReader(); reader.onload = function (e) { try { userProfile.img = e.target.result; localStorage.setItem('tm_user_profile', JSON.stringify(userProfile)); document.getElementById('displayProfileImg').src = userProfile.img; addNotification('success', 'Fotoğraf', 'Profil fotoğrafı yüklendi.'); } catch (error) { addNotification('danger', 'Hata', 'Fotoğraf boyutu çok büyük!'); } }; reader.readAsDataURL(input.files[0]); } }
        function switchMarketMode(mode, btn){ 
        document.querySelectorAll('.ms-btn').forEach(b => b.classList.remove('active')); 
        btn.classList.add('active'); 
        document.querySelectorAll('.market-view-section').forEach(s => s.classList.remove('active')); 
        document.getElementById('mv-'+mode).classList.add('active'); 
        if(mode==='watchlist') updateWatchlist(); 
        // YENİ FONKSİYONU ÇAĞIRIYORUZ:
        if(mode==='main') { setTimeout(() => { loadMarketCategory(currentCategory, null); }, 50); } 
    }

    function renderTradingView(symbol) { let container = document.getElementById('tradingview_container'); if(container) { container.innerHTML = ""; new TradingView.widget({ "autosize": true, "symbol": symbol, "interval": "D", "timezone": "Etc/UTC", "theme": "dark", "style": "1", "locale": "tr", "toolbar_bg": "#f1f3f6", "enable_publishing": false, "hide_top_toolbar": true, "container_id": "tradingview_container" }); } }
    
    
    // --- EKSİK OLAN MALİYET MODU GEÇİŞ FONKSİYONU ---
function switchAvgMode(mode, btn) {
    // 1. Görsel: Tüm butonların aktifliğini kaldır, tıklanana ekle
    if (btn && btn.parentElement) {
        const siblings = btn.parentElement.children;
        for (let i = 0; i < siblings.length; i++) {
            siblings[i].classList.remove('active');
        }
        btn.classList.add('active');
    }

    // 2. MOD DEĞİŞTİĞİNDE SONUÇ EKRANLARINI TEMİZLE
    const aaResultBox = document.getElementById('aaResultBox');
    const aiRescueResult = document.getElementById('aiRescueResult');
    const aiLoadingScreen = document.getElementById('aiLoadingScreen');
    const aiRescueList = document.getElementById('aiRescueList');
    const aaRiskAlert = document.getElementById('aaRiskAlert');
    
    if(aaResultBox) aaResultBox.style.display = 'none';
    if(aiRescueResult) aiRescueResult.style.display = 'none';
    if(aiLoadingScreen) aiLoadingScreen.style.display = 'none';
    if(aiRescueList) aiRescueList.innerHTML = '';
    if(aaRiskAlert) aaRiskAlert.style.display = 'none';
    
    // AI Başlat butonunu sıfırla
    const btnAiStart = document.getElementById('btnAiStart');
    if(btnAiStart) {
        btnAiStart.style.display = 'flex';
        btnAiStart.innerHTML = '<i class="fas fa-brain"></i> ANALİZİ BAŞLAT';
    }

    // 3. İşlev: İlgili paneli göster, diğerini gizle
    const budgetPanel = document.getElementById('avg-mode-budget');
    const targetPanel = document.getElementById('avg-mode-target');

    if (mode === 'budget') {
        if(budgetPanel) budgetPanel.style.display = 'block';
        if(targetPanel) targetPanel.style.display = 'none';
    } else if (mode === 'target') {
        if(budgetPanel) budgetPanel.style.display = 'none';
        if(targetPanel) targetPanel.style.display = 'block';
    }
}


    initApp();
/* --- PARÇACIK AĞI ANİMASYONU (GÜNCELLENMİŞ - TEMA DUYARLI) --- */
function initBackgroundAnimation() {
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    let particles = [];
    
    // Tema renkleri (RGB Formatında)
    const themeColors = {
        'ocean': '59, 130, 246',  // Mavi
        'cyber': '217, 70, 239',  // Neon Pembe
        'oled': '255, 255, 255',  // Beyaz
        'luxury': '245, 158, 11'  // Altın
    };

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    }
    
    class Particle {
        constructor() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.vx = (Math.random() - 0.5) * 0.8; 
            this.vy = (Math.random() - 0.5) * 0.8;
            this.size = Math.random() * 2 + 1;
        }
        
        update() {
            this.x += this.vx;
            this.y += this.vy;
            if (this.x < 0) this.x = width;
            if (this.x > width) this.x = 0;
            if (this.y < 0) this.y = height;
            if (this.y > height) this.y = 0;
        }
        
        draw(rgb) {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(${rgb}, 0.6)`;
            ctx.fill();
        }
    }

    function initParticles() {
        particles = [];
        const particleCount = Math.floor(width / 9); 
        for (let i = 0; i < particleCount; i++) {
            particles.push(new Particle());
        }
    }

    function animate() {
        ctx.clearRect(0, 0, width, height);
        
        // Aktif temayı al, yoksa varsayılan ocean kullan
        let currentTheme = appSettings.theme || 'ocean';
        // Yeni eklediğimiz temalar dışındaysa varsayılanı kullan
        let rgb = themeColors[currentTheme] || themeColors['ocean'];

        particles.forEach((p, index) => {
            p.update();
            p.draw(rgb);
            
            for (let j = index + 1; j < particles.length; j++) {
                const p2 = particles[j];
                const dx = p.x - p2.x;
                const dy = p.y - p2.y;
                const distance = Math.sqrt(dx*dx + dy*dy);
                
                if (distance < 110) {
                    ctx.beginPath();
                    ctx.strokeStyle = `rgba(${rgb}, ${0.15 - distance/1000})`; 
                    ctx.lineWidth = 0.6;
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                }
            }
        });
        
        requestAnimationFrame(animate);
    }

    window.addEventListener('resize', () => { resize(); initParticles(); });
    resize();
    initParticles();
    animate();
}

initBackgroundAnimation();

/* --- MANUEL GERİ BUTONU MANTIĞI --- */

// 1. Ana Sayfaya Dönme Fonksiyonu
function goBackHome() {
    // Alttaki menüden ilk sıradakini (Cüzdan) seçmiş gibi davran
    switchPage('portfolio', document.querySelectorAll('.nav-item')[0]);
}

// 2. Mevcut Sayfa Değiştirme Fonksiyonunu Güncelle
// (Eski fonksiyonu saklayıp üzerine özellik ekliyoruz)
const oldSwitchPage = switchPage;

switchPage = function(p, btn) {
    // Orijinal geçiş işlemini yap
    oldSwitchPage(p, btn);
    
    // Buton kontrolü yap
    const backBtn = document.getElementById('manualBackBtn');
    if(backBtn) {
        if(p === 'portfolio') {
            // Ana sayfadaysak butonu gizle
            backBtn.style.display = 'none';
        } else {
            // Diğer sayfalardaysak butonu göster (flex yaparak ortalıyoruz)
            backBtn.style.display = 'flex';
        }
    }
};

/* --- YENİ INFINITE SCROLL & LIVE MARKET MOTORU --- */

// Genişletilmiş BIST Listesi (Infinite Scroll hissi vermek için)
const bistExtended = [
    'THYAO','GARAN','AKBNK','ASELS','EREGL','SASA','KCHOL','SISE','BIMAS','TUPRS',
    'YKBNK','ISCTR','FROTO','EKGYO','PETKM','HALKB','VAKBN','TCELL','KOZAL','ASTOR',
    'ENKAI','ARCLK','TOASO','HEKTS','ODAS','ALARK','TTKOM','MGROS','GUBRF','OYAKC',
    'PGSUS','SAHOL','SOKM','KONTR','EUPWR','SMRTG','GESAN','CANTE','ISGYO','DOHOL',
    'VESTL','TKFEN','ZOREN','KRDMD','TSKB','SKBNK','QUAGR','BERA','MAVI','CIMSA'
];

let marketDataCache = []; // Tüm çekilen veriyi tutar
let displayedData = [];   // Ekranda o an gösterilen veri
let currentCategory = 'kripto';
let currentSortType = 'vol';
let currentPage = 1;
const itemsPerPage = 20;
let isMarketLoading = false;

// 1. Kategori Değiştirme
function loadMarketCategory(cat, btn) {
    if(btn) {
        document.querySelectorAll('.m-tab-pro').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    currentCategory = cat;
    currentPage = 1;
    marketDataCache = [];
    document.getElementById('infiniteMarketList').innerHTML = '';
    
    // Kategoriye göre veri çekme stratejisi
    fetchMarketData();
}

// 2. Sıralama Değiştirme
function sortMarketData(type, btn) {
    if(btn) {
        document.querySelectorAll('.mf-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    currentSortType = type;
    currentPage = 1;
    
    // Mevcut cache'i sırala ve yeniden render et
    processAndRenderData();
}

/* --- DÜZELTİLMİŞ FETCH MARKET DATA --- */
async function fetchMarketData() {
    const loader = document.getElementById('marketLoader');
    if(loader) loader.classList.add('active');
    isMarketLoading = true;

    try {
        // --- SENARYO 1: KRİPTO (COINGECKO) ---
        if(currentCategory === 'kripto') {
            if (coingeckoApiKey) {
                // Sayfa başına 50 coin çekelim (Daha akıcı olur)
                const fetchLimit = 50; 
                const url = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${fetchLimit}&page=${currentPage}&sparkline=false&x_cg_demo_api_key=${coingeckoApiKey}`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if(Array.isArray(data) && data.length > 0) {
                    const cgData = data.map(d => ({
                        symbol: d.symbol.toUpperCase(),
                        name: d.name,
                        price: d.current_price,
                        change: d.price_change_percentage_24h,
                        vol: d.total_volume,
                        image: d.image,
                        source: 'RANK #' + d.market_cap_rank,
                        id: d.id // ID bilgisini de saklayalım (Çakışma kontrolü için)
                    }));

                    // --- KRİTİK DÜZELTME: DUPLICATE (TEKRAR) KONTROLÜ ---
                    // Sadece marketDataCache içinde OLMAYAN yenileri al
                    const uniqueNewItems = cgData.filter(newItem => 
                        !marketDataCache.some(existing => existing.symbol === newItem.symbol)
                    );

                    if(currentPage === 1) {
                        marketDataCache = uniqueNewItems;
                    } else {
                        marketDataCache = [...marketDataCache, ...uniqueNewItems];
                    }

                    // Sadece yeni gelenleri render et
                    processAndRenderData(uniqueNewItems); 
                } else {
                    // Veri bittiyse loader'ı gizle
                    isMarketLoading = false; 
                    if(loader) loader.classList.remove('active');
                    return;
                }
            }
        } 
        
        // --- SENARYO 2: HİSSE (BIST) ---
        else if(currentCategory === 'hisse') {
            if(currentPage === 1) { // Sadece ilk yüklemede oluştur
                marketDataCache = bistExtended.map(sym => ({
                    symbol: sym, price: 0, change: 0, vol: 0, source: 'BIST', image: null
                }));
                updateBistPrices();
                processAndRenderData(marketDataCache); // Hepsini bas
            }
        } 
        
        // --- SENARYO 3 & 4: DÖVİZ & ALTIN ---
        else if(currentCategory === 'doviz' || currentCategory === 'altin') {
            if(currentPage === 1) {
                if(currentCategory === 'doviz') marketDataCache = await fetchFastForex();
                else marketDataCache = await fetchFastGold();
                
                processAndRenderData(marketDataCache);
            }
        }

    } catch (error) {
        console.error("Veri hatası:", error);
    } finally {
        isMarketLoading = false;
        if(loader) loader.classList.remove('active');
    }
}

// 4. BIST ve Diğerleri İçin Fiyat Güncelleme (Arka Planda)
async function updateBistPrices() {
    for(let item of marketDataCache) {
        // Hızlı sonuç için mevcut getPrice fonksiyonunu kullan
        let s = item.symbol.includes('=') ? item.symbol : item.symbol + '.IS';
        getPrice(s).then(res => {
            if(res && res.price > 0) {
                item.price = res.price;
                item.change = res.change;
                // Değişim olduğunda ilgili DOM elementini güncelle (Live effect)
                updateDomItem(item);
            }
        });
        await new Promise(r => setTimeout(r, 100)); // API limitine takılmamak için gecikme
    }
}

/* --- DÜZELTİLMİŞ RENDER SİSTEMİ --- */
function processAndRenderData(itemsToRender = []) {
    const listEl = document.getElementById('infiniteMarketList');
    
    // Eğer Sayfa 1 ise veya itemsToRender boş gelirse (sıralama değişimi gibi) listeyi temizle
    if(currentPage === 1 && itemsToRender.length === 0) {
        listEl.innerHTML = '';
        itemsToRender = marketDataCache; // Cache'deki her şeyi bas
    }
    
    // Eğer itemsToRender parametresi dolu geldiyse (Sayfa 2, 3...) sadece onları bas
    if(itemsToRender.length > 0) {
        renderSpecificBatch(itemsToRender);
    }
}

// Yeni Render Fonksiyonu (Batch Rendering)
function renderSpecificBatch(batch) {
    const listEl = document.getElementById('infiniteMarketList');
    
    // Mevcut eleman sayısını al (Sıralama numarası vermek için)
    let startIndex = listEl.children.length + 1;

    if(batch.length === 0 && currentPage === 1) {
        listEl.innerHTML = "<div style='text-align:center; padding:30px; color:var(--text-sub); opacity:0.6;'><i class='fas fa-search' style='font-size:24px; margin-bottom:10px;'></i><br>Veri bulunamadı.</div>";
        return;
    }

    let html = "";
    batch.forEach((item, idx) => {
        let globalIdx = startIndex + idx;
        let pStr = "--";
        
        if (item.price !== undefined && item.price !== null) {
            if (currentCategory === 'altin') {
                if (item.symbol.includes('ONS')) pStr = '$' + item.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                else pStr = '₺' + item.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            } 
            else if (currentCategory === 'kripto') {
                // Kripto fiyat formatlaması (küçük coinler için hassas)
                if(item.price < 1) pStr = '$' + item.price.toFixed(6);
                else pStr = '$' + item.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            } 
            else {
                pStr = '₺' + item.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            }
        }

        let isUp = item.change >= 0;
        let cClass = isUp ? 'bg-up' : 'bg-down';
        let cIcon = isUp ? '<i class="fas fa-caret-up"></i>' : '<i class="fas fa-caret-down"></i>';
        let cStr = item.change !== undefined ? `${cIcon}%${Math.abs(item.change).toFixed(2)}` : "--";
        
        let logo = "";
        if (item.image) {
            logo = `<div class="asset-logo-wrap" style="background:transparent; border:none; width:32px; height:32px;"><img src="${item.image}" class="asset-logo-img"></div>`;
        } else {
            logo = getAssetLogoHtml(item.symbol);
        }

        let dName = item.symbol;
        if(dName === 'GC=F') dName = 'ONS ALTIN';
        if(dName === 'TRY=X') dName = 'USD/TRY';

        let rankClass = '';
        if(globalIdx === 1) rankClass = 'rank-gold';
        else if(globalIdx === 2) rankClass = 'rank-silver';
        else if(globalIdx === 3) rankClass = 'rank-bronze';

        let volStr = item.source || '';
        if(currentCategory === 'kripto' && item.vol > 0) {
            if(item.vol > 1000000000) volStr = (item.vol/1000000000).toFixed(1) + 'Md Hacim';
            else if(item.vol > 1000000) volStr = (item.vol/1000000).toFixed(1) + 'M Hacim';
        }

        // Benzersiz ID oluştur (Tekrarı önlemek için sembolü kullan)
        let uniqueId = `m_item_${item.symbol.replace(/[^a-zA-Z0-9]/g, '')}`;

        html += `
        <div class="infinite-item" id="${uniqueId}" onclick="openMarketDetail('${item.symbol}')">
            <div class="ii-left">
                <div class="ii-rank ${rankClass}">${globalIdx}</div>
                ${logo}
                <div class="ii-info">
                    <span class="ii-sym">${dName}</span>
                    <span class="ii-vol">${volStr}</span>
                </div>
            </div>
            <div class="ii-right">
                <span class="ii-price">${pStr}</span>
                <span class="ii-change ${cClass}">${cStr}</span>
            </div>
        </div>`;
    });

    listEl.insertAdjacentHTML('beforeend', html);
}

/* --- DÜZELTİLMİŞ SCROLL LISTENER (3. ADIM - FİNAL) --- */
// 1. Önce mevcut bir container varsa onu değişkene alalım, yoksa işlem yapmayalım.
const existingListContainer = document.getElementById('infiniteMarketList');

if (existingListContainer) {
    // Eski listener'ları temizlemek için klonlama yöntemi
    const newContainer = existingListContainer.cloneNode(true);
    existingListContainer.parentNode.replaceChild(newContainer, existingListContainer);

    // Yeni Scroll Listener'ı ekle
    newContainer.addEventListener('scroll', function() {
        // Listenin sonuna 150px kala tetikle
        if (this.scrollTop + this.clientHeight >= this.scrollHeight - 150) {
            
            // Zaten yükleme yapılıyorsa dur
            if (isMarketLoading) return;

            // Sadece Kripto kategorisinde ve API Key varsa çalıştır
            if (currentCategory === 'kripto' && coingeckoApiKey) {
                isMarketLoading = true;
                currentPage++; 
                fetchMarketData(); 
            }
        }
    });
}




/* --- GÜNCELLENMİŞ FORMAT PRICE FONKSİYONU --- */
function formatPrice(p, cat) {
    // 1. Kripto ise Dolar
    if(cat === 'kripto') return '$' + p.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    
    // 2. Altın ise Kontrol Et
    if(cat === 'altin') {
        // Eğer global ONS ise DOLAR ($), değilse (Gram, Çeyrek vb.) TL (₺) göster
        // Not: 'ONS' kelimesini fonksiyondan gelen symbol içinde arıyoruz.
        // Ancak burada p (fiyat) ve cat (kategori) geliyor. Symbol'ü doğrudan parametre olarak almıyoruz.
        // Hızlı çözüm: ONS fiyatı genelde 2000-3000 arasıdır, Gram 2000-3000 arasıdır karışabilir.
        // EN SAĞLAMI: Bu fonksiyonu çağıran yeri düzeltmektir ama 
        // Basit Hack: ONS Altın haricindekileri TL yapalım.
        
        // EĞER ÇAĞIRAN YERİ DEĞİŞTİREMİYORSAK ŞÖYLE YAPALIM:
        // Bu fonksiyonu çağıran renderNextBatch içinde küçük bir düzeltme yapacağız.
        // Ama şimdilik genel kural:
        // Eğer fiyat TL bazındaysa (Gram, Çeyrek) formatlayalım.
        // Bunu burada ayırt etmek zor olduğu için 3. ADIMI MUTLAKA YAPINIZ.
        return '$' + p.toLocaleString(); // Geçici, 3. Adımı uygulayın.
    }
    
    // 3. Diğerleri (Hisse, Döviz) TL
    return '₺' + p.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
}


// Yardımcı: Tekil DOM Güncelleme (BIST Live Effect için)
function updateDomItem(item) {
    let uniqueId = `m_item_${item.symbol.replace(/[^a-zA-Z0-9]/g, '')}`;
    let el = document.getElementById(uniqueId);
    if(el) {
        let pEl = el.querySelector('.ii-price');
        let cEl = el.querySelector('.ii-change');
        
        if(pEl) pEl.innerText = formatPrice(item.price, currentCategory);
        if(cEl) {
            cEl.innerText = `%${item.change.toFixed(2)}`;
            cEl.className = `ii-change ${item.change >= 0 ? 'bg-up' : 'bg-down'}`;
        }
    }
}

// Liste elemanına tıklayınca ne olsun? (Şimdilik sembolü kopyalasın veya TradingView açsın)
function openMarketDetail(sym) {
    // İstersen burada modal açabilirsin. Şimdilik panoya kopyalayalım
    // veya mevcut grafiği açmak istersen eski fonksiyonu çağırabilirsin.
    addNotification('info', 'Seçildi', `${sym} detayları hazırlanıyor...`);
}

let currentDetailSymbol = ""; // O an incelenen sembolü tutar

// 1. Modalı Açan Fonksiyon
function openMarketDetail(rawSymbol) {
    currentDetailSymbol = rawSymbol; // Sembolü hafızaya al (Örn: BTC, THYAO)
    
    // Başlığı güncelle
    let displayName = rawSymbol;
    if(rawSymbol === 'GC=F') displayName = 'ONS ALTIN';
    else if(rawSymbol === 'TRY=X') displayName = 'USD/TRY';
    
    document.getElementById('mdTitle').innerHTML = getAssetLogoHtml(rawSymbol) + " " + displayName;

    // Modalı göster
    document.getElementById('marketDetailModal').style.display = 'flex';

    // TradingView Grafiğini Oluştur
    let tvSymbol = rawSymbol;
    
    // Kategoriye göre TradingView sembolünü düzelt
    if(currentCategory === 'kripto') {
        tvSymbol = "BINANCE:" + rawSymbol + "USDT";
    } else if(currentCategory === 'hisse') {
        tvSymbol = "BIST:" + rawSymbol.replace('.IS', '');
    } else if(currentCategory === 'altin') {
        if(rawSymbol === 'GC=F') tvSymbol = "TVC:GOLD";
        else if(rawSymbol === 'SI=F') tvSymbol = "TVC:SILVER";
    } else if(currentCategory === 'doviz') {
        if(rawSymbol === 'TRY=X') tvSymbol = "FX:USDTRY";
        else if(rawSymbol === 'EURTRY=X') tvSymbol = "FX:EURTRY";
    }

    // Grafiği bas
    new TradingView.widget({
        "autosize": true,
        "symbol": tvSymbol,
        "interval": "D",
        "timezone": "Etc/UTC",
        "theme": "dark",
        "style": "1",
        "locale": "tr",
        "toolbar_bg": "#f1f3f6",
        "enable_publishing": false,
        "hide_top_toolbar": true, // Mobilde yer kaplamasın
        "hide_legend": false,
        "save_image": false,
        "container_id": "mdChartContainer"
    });
}


// 2. Modalı Kapatan Fonksiyon
function closeMarketDetail() {
    document.getElementById('marketDetailModal').style.display = 'none';
    document.getElementById('mdChartContainer').innerHTML = ""; // Grafiği temizle (Performans için)
}

/* --- GÜNCELLENMİŞ ALIM BUTONU AKSİYONU --- */
function actionBuyFromMarket() {
    // 1. Modalı Kapat
    closeMarketDetail(); 
    
    // 2. Cüzdan Sayfasına Git
    switchPage('portfolio', document.querySelectorAll('.nav-item')[0]);
    
    // 3. "Hızlı İşlem" Menüsü Kapalıysa Zorla Aç
    const content = document.getElementById('tradeContent');
    const chevron = document.getElementById('tradeChevron');
    const card = document.getElementById('tradeCard');
    
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        chevron.classList.add('rotated');
        card.classList.add('open');
    }

    // 4. Sembolü Kutuya Yaz (Değişken ismi düzeltildi: currentMdSymbol)
    const input = document.getElementById('addSymbol');
    if(currentMdSymbol) {
        // Eğer sembol 'BINANCE:BTCUSDT' gibi gelirse temizle, sadece 'BTC' yaz
        let cleanSym = currentMdSymbol.replace('BINANCE:','').replace('BIST:','').replace('USDT','').replace('.IS','');
        input.value = cleanSym;
        
        // 5. Fiyatı Getir (Simülasyon)
        debouncedPreview(cleanSym); 
    }
    
    // 6. Kullanıcı direkt miktar girebilsin diye oraya odaklan
    setTimeout(() => {
        document.getElementById('addAmount').focus();
    }, 300);
}

/* --- YENİ DETAY MODAL JS MOTORU (DÜZELTİLMİŞ) --- */

let currentMdSymbol = ""; // Global değişken

function switchMdTab(tab, btn) {
    document.querySelectorAll('.md-content').forEach(c => c.classList.remove('active'));
    document.getElementById('md-tab-' + tab).classList.add('active');
    document.querySelectorAll('.md-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
}

// FORMAT VOLUME FONKSİYONU
function formatVolume(val, sym) {
    if(!val) return "--";
    if(val > 1000000000) return sym + (val/1000000000).toFixed(2) + " Mr";
    if(val > 1000000) return sym + (val/1000000).toFixed(2) + " M";
    if(val > 1000) return sym + (val/1000).toFixed(2) + " K";
    return sym + val.toFixed(0);
}

/* --- AKILLI GRAFİK MOTORU (DÜZELTİLMİŞ) --- */
function initMdChart(rawSymbol) {
    let s = rawSymbol.toUpperCase().trim();
    let tvSymbol = s;

    // 1. KATEGORİYE GÖRE SEMBOL FORMATI
    if(currentCategory === 'kripto') {
        // Temizlik: İçinde BINANCE, USDT vs varsa temizle, saf ismi al (örn: BTC)
        let clean = s.replace('BINANCE:', '').replace('USDT', '').trim();
        
        // ÖZEL DURUM: Sadece Majör Coinleri Binance'e Zorla (Garantili Veri İçin)
        const majorCoins = ['BTC', 'ETH', 'BNB', 'SOL', 'XRP', 'ADA', 'AVAX', 'DOGE', 'TRX', 'DOT', 'MATIC', 'SHIB', 'LTC'];
        
        if(majorCoins.includes(clean)) {
            tvSymbol = "BINANCE:" + clean + "USDT";
        } else {
            // DİĞERLERİ: Binance zorlamasını kaldır! 
            // Sadece "PEPEUSDT" gönderiyoruz, TradingView en uygun borsayı (OKX, GATE, BYBIT) kendi seçsin.
            tvSymbol = clean + "USDT";
        }
    }
    else if(currentCategory === 'hisse') {
        tvSymbol = "BIST:" + s.replace('.IS', '');
    }
    else if(currentCategory === 'altin') {
        if(s.includes('ONS') || s === 'GOLD' || s === 'XAUUSD' || s === 'GC=F') {
            tvSymbol = "TVC:GOLD"; 
        } 
        else if(s.includes('GÜMÜŞ') || s.includes('SILVER')) {
            tvSymbol = "TVC:SILVER";
        }
        else {
            // Gram altın vb için Dolar/TL grafiği daha mantıklı referanstır
            tvSymbol = "FX:USDTRY"; 
        }
    }
    else if(currentCategory === 'doviz') {
        let cleanFx = s.replace('/','').replace('=X','');
        // Frankfurther API'den gelen veriler (EURUSD, USDTRY) düzgündür
        if(cleanFx.length === 6) tvSymbol = "FX:" + cleanFx;
        else tvSymbol = "FX:USDTRY";
    }

    // 2. GRAFİĞİ ÇİZ
    const container = document.getElementById('mdChartContainer');
    if(container) container.innerHTML = "";

    new TradingView.widget({
        "autosize": true,
        "symbol": tvSymbol,
        "interval": "D",
        "timezone": "Etc/UTC",
        "theme": "dark",
        "style": "1",
        "locale": "tr",
        "toolbar_bg": "#f1f3f6",
        "enable_publishing": false,
        "hide_top_toolbar": false, 
        "hide_legend": false,
        "save_image": false,
        "container_id": "mdChartContainer"
    });
}

// DETAYLARI EKRANA BASAN FONKSİYON (DÜZELTİLMİŞ KUR HESAPLAMALI)
function renderMdUI(d, title) {
    let sym = (currentCategory === 'kripto' || currentCategory === 'altin') ? '$' : '₺';
    
    // Üst Başlık ve Fiyatlar
    document.getElementById('mdSymbolTitle').innerText = title;
    document.getElementById('mdBigPrice').innerText = sym + d.price.toLocaleString(undefined, {minimumFractionDigits:2});
    
    let pill = document.getElementById('mdChangePill');
    let hero = document.getElementById('mdHero');
    
    if(d.change >= 0) {
        pill.innerText = `▲ %${d.change.toFixed(2)}`;
        pill.style.background = 'rgba(16, 185, 129, 0.2)';
        pill.style.color = '#10b981';
        hero.className = 'md-header-hero up';
    } else {
        pill.innerText = `▼ %${d.change.toFixed(2)}`;
        pill.style.background = 'rgba(239, 68, 68, 0.2)';
        pill.style.color = '#ef4444';
        hero.className = 'md-header-hero down';
    }

    // Range Bar (Günlük Aralık)
    let rangePercent = 50;
    if(d.high > d.low) {
        rangePercent = ((d.price - d.low) / (d.high - d.low)) * 100;
    }
    rangePercent = Math.max(0, Math.min(100, rangePercent));
    
    document.getElementById('mdRangeDot').style.left = `${rangePercent}%`;
    document.getElementById('mdLow').innerText = sym + d.low.toLocaleString();
    document.getElementById('mdHigh').innerText = sym + d.high.toLocaleString();

    // İstatistikler
    document.getElementById('mdVol').innerText = formatVolume(d.vol, sym);
    document.getElementById('mdVwap').innerText = sym + d.vwap.toLocaleString(undefined, {maximumFractionDigits:2});
    document.getElementById('mdType').innerText = currentCategory.toUpperCase();

    // Yasal Uyarı Metni
    let disclaimer = document.getElementById('mdDisclaimer');
    if(disclaimer) {
        if(currentCategory === 'hisse' || currentCategory === 'altin' || currentCategory === 'doviz') {
            disclaimer.innerHTML = '<i class="fas fa-clock"></i> Yasalar gereği bu veriler 15 dakika gecikmeli olabilir.';
            disclaimer.style.color = '#f59e0b';
            disclaimer.style.opacity = '1';
        } else {
            disclaimer.innerHTML = '<i class="fas fa-info-circle"></i> Veriler anlık piyasa verisidir.';
            disclaimer.style.color = 'var(--text-sub)';
            disclaimer.style.opacity = '0.7';
        }
    }

    // --- [HESAPLAMA DÜZELTMESİ BAŞLANGIÇ] ---
    
    let myCash = cashBalance; // Global cüzdan bakiyesi
    let currentUsd = (typeof usdTryRate !== 'undefined') ? usdTryRate : 36.50;
    let appCurr = (typeof appSettings !== 'undefined') ? appSettings.currency : 'TRY';

    // 1. Varlığın Para Birimini Tespit Et
    // Kripto, Ons Altın ve Bazı Döviz çiftleri USD bazlıdır.
    let isAssetUsd = (currentCategory === 'kripto' || 
                      (currentCategory === 'altin' && (title.includes('ONS') || title.includes('GOLD') || title.includes('GC=F'))) ||
                      (currentCategory === 'doviz' && title.includes('/USD'))); // EUR/USD gibi

    // 2. Fiyatı Cüzdan Para Birimine Çevir (Normalize Et)
    let normalizedPrice = d.price;

    if (appCurr === 'TRY' && isAssetUsd) {
        // Cüzdan TL, Varlık Dolar -> Varlık Fiyatını TL'ye çevir (Örn: BTC $100k -> 3.65M TL)
        normalizedPrice = d.price * currentUsd;
    } 
    else if (appCurr === 'USD' && !isAssetUsd) {
        // Cüzdan Dolar, Varlık TL -> Varlık Fiyatını Dolara çevir (Örn: THYAO 300 TL -> $8.2)
        normalizedPrice = d.price / currentUsd;
    }

    // 3. Doğru Bölme İşlemi (Bakiye / Kurulanmış Fiyat)
    let maxBuy = normalizedPrice > 0 ? (myCash / normalizedPrice) : 0;
    
    let balanceSym = appCurr === 'TRY' ? '₺' : '$';
    
    // Ekrana Yazdır
    document.getElementById('mdUserBalance').innerText = balanceSym + myCash.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    
    // Adet gösterimini akıllı yap (Kripto ise 6 hane, Hisse ise 0 hane)
    let precision = (currentCategory === 'kripto') ? 6 : 0;
    document.getElementById('mdMaxBuy').innerText = maxBuy.toLocaleString(undefined, {maximumFractionDigits: precision}) + " Adet";

    // --- [HESAPLAMA DÜZELTMESİ BİTİŞ] ---
}

// ANA MARKET DETAY FONKSİYONU
async function openMarketDetail(rawSymbol) {
    currentMdSymbol = rawSymbol; 
    
    document.getElementById('marketDetailModal').style.display = 'flex';
    document.getElementById('mdSymbolTitle').innerText = rawSymbol;
    document.getElementById('mdBigPrice').innerText = "Yükleniyor...";
    
    
    let w = JSON.parse(localStorage.getItem('tm_watchlist')) || [];
    let icon = document.getElementById('mdWatchIcon');
    if(w.includes(rawSymbol)) icon.style.color = "#f59e0b"; 
    else icon.style.color = "var(--text-sub)"; 
    
    switchMdTab('overview', document.querySelectorAll('.md-tab')[0]);
    document.getElementById('mdAssetLogo').innerHTML = getAssetLogoHtml(rawSymbol);

    let details = { price: 0, change: 0, high: 0, low: 0, vol: 0, vwap: 0 };
    let displaySym = rawSymbol;

    try {
        if(currentCategory === 'kripto') {
            let s = rawSymbol.replace('USDT', '') + 'USDT';
            s = s.replace('BINANCE:', ''); 
            
            const res = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${s}`);
            if(!res.ok) throw new Error("Binance Veri Hatası");
            
            const d = await res.json();
            details.price = parseFloat(d.lastPrice);
            details.change = parseFloat(d.priceChangePercent);
            details.high = parseFloat(d.highPrice);
            details.low = parseFloat(d.lowPrice);
            details.vol = parseFloat(d.quoteVolume);
            details.vwap = parseFloat(d.weightedAvgPrice);
            displaySym = rawSymbol.replace('BINANCE:','').replace('USDT','') + " / USDT";
        } else {
            let pData = await getPrice(rawSymbol);
            if(pData.price === 0) throw new Error("Fiyat Çekilemedi");

            details.price = pData.price;
            details.change = pData.change;
            details.high = details.price * 1.02; 
            details.low = details.price * 0.98;
            details.vol = 0; 
            details.vwap = details.price;
        }
        
        renderMdUI(details, displaySym);
        initMdChart(rawSymbol);

    } catch (e) {
        document.getElementById('mdBigPrice').innerText = "Veri Yok";
        document.getElementById('mdDisclaimer').innerHTML = "<span style='color:red'>Veri alınamadı, grafik deneniyor...</span>";
        initMdChart(rawSymbol);
    }
}

// "AL" BUTONU AKSİYONU (DÜZELTİLMİŞ)
function actionBuyFromMarket() {
    closeMarketDetail(); 
    switchPage('portfolio', document.querySelectorAll('.nav-item')[0]);
    
    const content = document.getElementById('tradeContent');
    const chevron = document.getElementById('tradeChevron');
    const card = document.getElementById('tradeCard');
    
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        chevron.classList.add('rotated');
        card.classList.add('open');
    }

    const input = document.getElementById('addSymbol');
    if(currentMdSymbol) {
        let cleanSym = currentMdSymbol.replace('BINANCE:','').replace('BIST:','').replace('USDT','').replace('.IS','');
        input.value = cleanSym;
        debouncedPreview(cleanSym); 
    }
    
    setTimeout(() => { document.getElementById('addAmount').focus(); }, 300);
}

// İZLEMEYE EKLE BUTONU
function actionWatchFromMarket() {
    let w = JSON.parse(localStorage.getItem('tm_watchlist')) || [];
    let icon = document.getElementById('mdWatchIcon');

    if(w.includes(currentMdSymbol)) { 
        icon.style.color = "#f59e0b"; 
        return addNotification('warn', 'Zaten Ekli', 'Bu varlık zaten izleme listenizde.'); 
    } 

    w.push(currentMdSymbol); 
    localStorage.setItem('tm_watchlist', JSON.stringify(w)); 
    updateWatchlist(); 
    
    icon.style.color = "#f59e0b"; 
    icon.style.transform = "scale(1.3)"; 
    setTimeout(() => { icon.style.transform = "scale(1)"; }, 200); 

    addNotification('success', 'Takipte', `${currentMdSymbol} izleme listesine eklendi.`);
}

function closeMarketDetail() {
    document.getElementById('marketDetailModal').style.display = 'none';
    document.getElementById('mdChartContainer').innerHTML = ""; 
}

/* --- YENİ WATCHLIST BUTON MANTIĞI --- */

/* --- ORİJİNAL COINGECKO ENTEGRASYONLU DETAY PENCERESİ --- */
async function openMarketDetail(rawSymbol) {
    currentMdSymbol = rawSymbol; 
    
    // 1. Modalı Aç
    document.getElementById('marketDetailModal').style.display = 'flex';
    document.getElementById('mdSymbolTitle').innerText = rawSymbol;
    document.getElementById('mdBigPrice').innerText = "Yükleniyor...";
    
    // İzleme İkonu
    let w = JSON.parse(localStorage.getItem('tm_watchlist')) || [];
    let icon = document.getElementById('mdWatchIcon');
    icon.style.color = w.includes(rawSymbol) ? "#f59e0b" : "var(--text-sub)"; 
    
    // Sekmeyi 'Genel Bakış'a al
    switchMdTab('overview', document.querySelectorAll('.md-tab')[0]);

    // Değişkenler
    let details = { price: 0, change: 0, high: 0, low: 0, vol: 0, vwap: 0 };
    let logoHtml = getAssetLogoHtml(rawSymbol); // Varsayılan logo
    let dataFound = false;

    // --- 1. ADIM: CACHE (HAZIR LİSTE) KONTROLÜ (EN HIZLI YÖNTEM) ---
    // Eğer ana listede bu coini görüyorsanız, verisi zaten elinizdedir. Tekrar istek atmaya gerek yok.
    if(marketDataCache && marketDataCache.length > 0) {
        // Sembol eşleşmesi yap (Büyük/Küçük harf duyarsız)
        const cachedItem = marketDataCache.find(x => x.symbol.toUpperCase() === rawSymbol.toUpperCase());
        
        if(cachedItem) {
            // Veriler Cache'den alınıyor (Burada her şey doludur)
            details.price = cachedItem.price;
            details.change = cachedItem.change;
            details.vol = cachedItem.vol || 0;
            
            // CoinGecko 'markets' endpoint'i high/low bilgisini de verir.
            // Eğer cache yapımızda high/low saklamıyorsak simüle ederiz.
            if(cachedItem.high_24h) details.high = cachedItem.high_24h;
            else details.high = details.price * 1.05;

            if(cachedItem.low_24h) details.low = cachedItem.low_24h;
            else details.low = details.price * 0.95;
            
            details.vwap = details.price; // VWAP CoinGecko'da standart yok, fiyatı basıyoruz

            // Logo Cache'den
            if(cachedItem.image) {
                logoHtml = `<div class="asset-logo-wrap" style="background:transparent; border:none; width:50px; height:50px;"><img src="${cachedItem.image}" class="asset-logo-img"></div>`;
            }
            
            dataFound = true;
        }
    }

    // --- 2. ADIM: CACHE'DE YOKSA API'YE SOR (ARAMA YAPILDIYSA) ---
    if(!dataFound && currentCategory === 'kripto' && coingeckoApiKey) {
        try {
            // Önce: Sembolden ID bul (Search API)
            const searchUrl = `https://api.coingecko.com/api/v3/search?query=${rawSymbol}&x_cg_demo_api_key=${coingeckoApiKey}`;
            const searchRes = await fetch(searchUrl);
            const searchData = await searchRes.json();
            
            let coinId = null;
            if(searchData.coins && searchData.coins.length > 0) {
                // Tam eşleşme ara, yoksa ilkini al
                const match = searchData.coins.find(c => c.symbol.toUpperCase() === rawSymbol.toUpperCase());
                coinId = match ? match.id : searchData.coins[0].id;
                
                // Logoyu buradan alabiliriz (large versiyonu)
                if(match && match.thumb) {
                    let largeImg = match.thumb.replace('thumb', 'large');
                    logoHtml = `<div class="asset-logo-wrap" style="background:transparent; border:none; width:50px; height:50px;"><img src="${largeImg}" class="asset-logo-img"></div>`;
                }
            }

            if(coinId) {
                // Sonra: ID ile detay çek (Market Data API)
                // Bu endpoint High, Low, Vol her şeyi verir.
                const detailUrl = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${coinId}&x_cg_demo_api_key=${coingeckoApiKey}`;
                const detailRes = await fetch(detailUrl);
                const detailData = await detailRes.json();

                if(detailData && detailData.length > 0) {
                    const d = detailData[0];
                    details.price = d.current_price;
                    details.change = d.price_change_percentage_24h;
                    details.high = d.high_24h;
                    details.low = d.low_24h;
                    details.vol = d.total_volume;
                    details.vwap = d.current_price;
                    
                    // Logo API'den geldiyse güncelle
                    if(d.image) {
                        logoHtml = `<div class="asset-logo-wrap" style="background:transparent; border:none; width:50px; height:50px;"><img src="${d.image}" class="asset-logo-img"></div>`;
                    }
                    dataFound = true;
                }
            }
        } catch(e) {
            console.log("CG Detay Hatası:", e);
        }
    }

    // --- 3. ADIM: HİSSE / ALTIN / DÖVİZ (ESKİ SİSTEM) ---
    if(!dataFound && currentCategory !== 'kripto') {
        let pData = await getPrice(rawSymbol);
        if(pData.price > 0) {
            details.price = pData.price;
            details.change = pData.change;
            details.high = pData.price * 1.02;
            details.low = pData.price * 0.98;
            dataFound = true;
        }
    }

    // Ekrana Bas
    document.getElementById('mdAssetLogo').innerHTML = logoHtml;

    if(dataFound || details.price > 0) {
        // Eksik veri varsa (örn: hisse) simüle et
        if(!details.high) details.high = details.price * 1.05;
        if(!details.low) details.low = details.price * 0.95;
        
        renderMdUI(details, rawSymbol);
    } else {
        document.getElementById('mdBigPrice').innerText = "Veri Yok";
        document.getElementById('mdDisclaimer').innerHTML = "<span style='color:red'>Veri alınamadı.</span>";
    }

    // Grafiği Başlat
    initMdChart(rawSymbol);
}


// 2. Butona Basınca Listeye Ekle ve Sarı Yap
function actionWatchFromMarket() {
    let w = JSON.parse(localStorage.getItem('tm_watchlist')) || [];
    let icon = document.getElementById('mdWatchIcon');

    // Zaten listede mi?
    if(w.includes(currentMdSymbol)) { 
        // İsterseniz burada "Listeden Çıkarma" mantığı da yapabiliriz.
        // Şimdilik sadece uyarı veriyoruz ve rengi sarı tutuyoruz.
        icon.style.color = "#f59e0b"; 
        return addNotification('warn', 'Zaten Ekli', 'Bu varlık zaten izleme listenizde.'); 
    } 

    // Listeye Ekle
    w.push(currentMdSymbol); 
    localStorage.setItem('tm_watchlist', JSON.stringify(w)); 
    updateWatchlist(); 
    
    // RENGİ SARI YAP VE EFEKT VER
    icon.style.color = "#f59e0b"; 
    icon.style.transform = "scale(1.3)"; // Hafif büyüme efekti
    setTimeout(() => { icon.style.transform = "scale(1)"; }, 200); // Geri küçült

    addNotification('success', 'Takipte', `${currentMdSymbol} izleme listesine eklendi.`);
}

/* --- UNIFIED HEADER İŞLEVLERİ --- */

// Arama kutusunu aç/kapa
function toggleUnifiedSearch(btn) {
    const box = document.getElementById('unifiedSearchBox');
    const input = document.getElementById('unifiedSearchInput');
    
    if (box.classList.contains('open')) {
        box.classList.remove('open');
        btn.classList.remove('active');
        btn.innerHTML = '<i class="fas fa-search"></i>';
        input.value = '';
        filterUnifiedList(''); // Listeyi temizle
    } else {
        box.classList.add('open');
        btn.classList.add('active');
        btn.innerHTML = '<i class="fas fa-times"></i>';
        setTimeout(() => input.focus(), 300);
    }
}

// Listeyi Filtrele
function filterUnifiedList(val) {
    val = val.toUpperCase().trim();
    const isMain = document.getElementById('mv-main').classList.contains('active');
    const container = document.getElementById(isMain ? 'infiniteMarketList' : 'wlList');
    const items = container.querySelectorAll(isMain ? '.infinite-item' : '.wl-card-classic');

    items.forEach(item => {
        let text = isMain ? item.querySelector('.ii-sym').innerText : item.querySelector('.wl-c-sym').innerText;
        item.style.display = text.toUpperCase().includes(val) ? (isMain ? 'flex' : 'block') : 'none';
    });
}

// Mod Değiştirme (Piyasa <-> İzleme) - GÜNCELLENMİŞ
switchMarketMode = function(mode, btn) {
    // İçerik alanlarını değiştir
    document.querySelectorAll('.market-view-section').forEach(s => s.classList.remove('active'));
    document.getElementById('mv-' + mode).classList.add('active');

    // Header butonlarını güncelle
    document.querySelectorAll('.vt-btn').forEach(b => b.classList.remove('active'));
    
    // İzleme ve Piyasa moduna göre butonları ayarla
    if(mode === 'main') {
        document.getElementById('btn-view-main').classList.add('active');
        // Piyasa modunda kategori ve filtreleri GÖSTER
        document.getElementById('unifiedCategories').style.display = 'flex';
        document.getElementById('unifiedFilters').style.display = 'flex';
        
        loadMarketCategory(currentCategory, null);
    } else {
        document.getElementById('btn-view-watch').classList.add('active');
        // İzleme modunda kategori ve filtreleri GİZLE (Sade görünüm)
        document.getElementById('unifiedCategories').style.display = 'none';
        document.getElementById('unifiedFilters').style.display = 'none';
        
        updateWatchlist();
    }
};

// Kategori Yükleme Fonksiyonu (Sınıfları yeni yapıya uydurduk)
const oldLoadMarketCategory2 = loadMarketCategory;
loadMarketCategory = function(cat, btn) {
    if(btn) {
        document.querySelectorAll('.muh-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    // Eski mantığı çağır
    currentCategory = cat;
    currentPage = 1;
    marketDataCache = [];
    document.getElementById('infiniteMarketList').innerHTML = '';
    fetchMarketData();
};

/* --- TAM KAPSAMLI GLOBAL ARAMA (COINGECKO ENGINE) --- */
let autoSearchTimer;

function filterUnifiedList(val) {
    val = val.trim(); // Boşlukları al ama uppercase yapma (API hassas olabilir)
    
    // Aktif Listeyi Bul
    const isMain = document.getElementById('mv-main').classList.contains('active');
    const container = document.getElementById(isMain ? 'infiniteMarketList' : 'wlList');
    if(!container) return;

    // Eski sonuçları temizle
    const oldResult = document.getElementById('global-search-result');
    if(oldResult) oldResult.remove();
    clearTimeout(autoSearchTimer);

    // 1. MEVCUT LİSTEYİ FİLTRELE
    const itemClass = isMain ? '.infinite-item' : '.wl-card-classic';
    const items = container.querySelectorAll(itemClass);
    let visibleCount = 0;

    items.forEach(item => {
        let text = isMain ? item.querySelector('.ii-sym').innerText : item.querySelector('.wl-c-sym').innerText;
        if (text.toUpperCase().includes(val.toUpperCase())) {
            item.style.display = isMain ? 'flex' : 'block';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });

    // 2. LİSTEDE YOKSA -> COINGECKO DEV HAVUZUNDA ARA
    if (visibleCount === 0 && val.length > 2) {
        
        // Yükleniyor Mesajı
        const loadingHtml = `
            <div id="global-search-result" style="text-align:center; padding:20px; color:var(--text-sub); animation:fadeIn 0.3s;">
                <i class="fas fa-satellite-dish fa-spin"></i> CoinGecko Veritabanı Taranıyor: <b>${val}</b>
            </div>`;
        container.insertAdjacentHTML('beforeend', loadingHtml);

        autoSearchTimer = setTimeout(async () => {
            const resultBox = document.getElementById('global-search-result');
            if(!resultBox) return;

            // CoinGecko Search API (Her şeyi bulur)
            if(coingeckoApiKey) {
                try {
                    const url = `https://api.coingecko.com/api/v3/search?query=${val}&x_cg_demo_api_key=${coingeckoApiKey}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    // İlk 5 sonucu al (Çok fazla sonuç gelebilir)
                    const coins = data.coins ? data.coins.slice(0, 5) : [];

                    if(coins.length > 0) {
                        resultBox.innerHTML = `<div style="padding:10px; font-size:11px; color:var(--text-sub); text-align:center;">GLOBAL SONUÇLAR</div>`;
                        
                        coins.forEach(coin => {
                            // Kart HTML'i
                            resultBox.innerHTML += `
                                <div class="infinite-item" onclick="openCoinGeckoDetail('${coin.id}')" style="border: 1px solid var(--accent); background: rgba(59, 130, 246, 0.05); margin-bottom:5px;">
                                    <div class="ii-left">
                                        <div class="ii-rank" style="background:#8bc34a; color:white;">CG</div>
                                        <div class="asset-logo-wrap" style="background:transparent; border:none; width:32px; height:32px;">
                                            <img src="${coin.thumb}" class="asset-logo-img">
                                        </div>
                                        <div class="ii-info">
                                            <span class="ii-sym">${coin.symbol}</span>
                                            <span class="ii-vol">${coin.name}</span>
                                        </div>
                                    </div>
                                    <div class="ii-right">
                                        <span class="ii-price" style="font-size:11px; color:var(--accent);">Görüntüle <i class="fas fa-chevron-right"></i></span>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        resultBox.innerHTML = `<div style="opacity:0.5; text-align:center;">"${val}" bulunamadı.</div>`;
                    }
                } catch(e) {
                    resultBox.innerHTML = `<div style="color:var(--danger); text-align:center;">Bağlantı Hatası</div>`;
                }
            } else {
                // Anahtar yoksa eski usul
                filterUnifiedListOld(val); 
            }
        }, 800);
    }
}

/* --- SONSUZ KAYDIRMA VE SAYFALAMA DÜZELTMESİ --- */

// 1. Önce mevcut listener'ı temizleyelim (Varsa çakışmasın)
const listContainer = document.getElementById('infiniteMarketList');
const newContainer = listContainer.cloneNode(true);
listContainer.parentNode.replaceChild(newContainer, listContainer);

// 2. Yeni ve Güçlü Scroll Algılayıcıyı Ekleyelim
newContainer.addEventListener('scroll', function() {
    
    // Listenin sonuna yaklaştık mı? (Son 100px kala tetiklensin)
    if (this.scrollTop + this.clientHeight >= this.scrollHeight - 100) {
        
        // Eğer zaten yükleme yapılıyorsa veya tüm veri bittiyse dur
        if (isMarketLoading) return;

        // --- SENARYO 1: Kripto (CoinGecko) ---
        // CoinGecko sayfa sayfa veri verir, yeni istek atmalıyız.
        if (currentCategory === 'kripto' && coingeckoApiKey) {
            isMarketLoading = true;
            currentPage++; // Sayfayı artır (Örn: 1 -> 2)
            fetchMarketData(); // Yeni sayfayı API'den iste
        } 
        
        // --- SENARYO 2: Diğerleri (Binance/Bist) ---
        // Veri zaten cache'de var, sadece sıradakileri göstermeliyiz.
        else {
            // Cache'de daha gösterilecek veri var mı?
            if ((currentPage * itemsPerPage) < marketDataCache.length) {
                isMarketLoading = true;
                currentPage++;
                renderNextBatch(); // Cache'den sıradaki grubu bas
                isMarketLoading = false; // İşlem bitti
            }
        }
    }
});

/* --- GÜNCELLENMİŞ COINGECKO DETAY AÇMA --- */
async function openCoinGeckoDetail(coinId) {
    // Yükleniyor Modalı Aç
    document.getElementById('marketDetailModal').style.display = 'flex';
    document.getElementById('mdSymbolTitle').innerText = "YÜKLENİYOR...";
    document.getElementById('mdBigPrice').innerText = "--";
    
    try {
        // 1. COİN DETAYLARINI ÇEK
        const detailUrl = `https://api.coingecko.com/api/v3/coins/${coinId}?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false&x_cg_demo_api_key=${coingeckoApiKey}`;
        const detailRes = await fetch(detailUrl);
        const coinData = await detailRes.json();
        
        if(!coinData || !coinData.market_data) throw new Error("Veri yok");

        const md = coinData.market_data;
        
        // Detayları Doldur
        const details = {
            price: md.current_price.usd,
            change: md.price_change_percentage_24h,
            vol: md.total_volume.usd,
            high: md.high_24h.usd,
            low: md.low_24h.usd,
            vwap: md.current_price.usd
        };

        // Sembolü büyük harf yap (örn: pepecto -> PEPECTO)
        const displaySym = coinData.symbol.toUpperCase();
        
        currentMdSymbol = displaySym;
        
        // UI Güncelle
        renderMdUI(details, displaySym + " / USD");
        
        // Logo Ekle
        if(coinData.image && coinData.image.large) {
            document.getElementById('mdAssetLogo').innerHTML = `
                <div class="asset-logo-wrap" style="background:transparent; border:none; width:50px; height:50px;">
                    <img src="${coinData.image.large}" class="asset-logo-img">
                </div>`;
        } else {
            document.getElementById('mdAssetLogo').innerHTML = getAssetLogoHtml(displaySym);
        }
        
        // Grafiği Başlat (displaySym gönderiyoruz, örn: "PEPE")
        // initMdChart bunu alıp "PEPEUSDT" yapacak ve TradingView borsayı kendi bulacak.
        initMdChart(displaySym);

    } catch (e) {
        console.error("CG Detay Hatası:", e);
        document.getElementById('mdBigPrice').innerText = "Hata";
        document.getElementById('mdDisclaimer').innerHTML = "<span style='color:red'>Veri alınamadı.</span>";
        // Yine de grafiği sembol üzerinden denemeye çalışalım
        if(coinId) initMdChart(coinId.toUpperCase()); 
    }
}

/* --- AKILLI SATIŞ (GÖRSEL EFEKTLİ & OTO DÜZELTMELİ) --- */
function actionSellFromMarket() {
    if (!currentMdSymbol) return;

    // 1. Sembol Temizliği
    let cleanSearch = currentMdSymbol
        .replace('BINANCE:', '').replace('BIST:', '').replace('FX:', '').replace('TVC:', '').replace('.IS', '').trim();
    if (cleanSearch.endsWith('USDT') && cleanSearch !== 'USDT') cleanSearch = cleanSearch.slice(0, -4);

    // 2. Cüzdanı Tara
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let targetIndex = as.findIndex(a => {
        let name = a.name.replace('BINANCE:', '').replace('BIST:', '').replace('.IS', '').trim();
        if (name.endsWith('USDT') && name !== 'USDT') name = name.slice(0, -4);
        return name === cleanSearch;
    });

    // A) VARSA -> GİT
    if (targetIndex !== -1) {
        closeMarketDetail();
        switchPage('portfolio', document.querySelectorAll('.nav-item')[0]);
        setTimeout(() => { openSell(targetIndex); }, 300);
    } 
    // B) YOKSA -> EFEKT YAP VE GERİ AL
    else {
        addNotification('warn', 'İşlem Başarısız', `${cleanSearch} portföyünüzde yok.`);
        
        const btn = document.querySelector('.bq-sell');
        if(btn) {
            // Mevcut (orijinal) HTML'i saklamaya gerek yok, elle yazacağız
            
            // 1. KIRMIZI VE "YOK" MODUNA GEÇ
            btn.style.transition = "0.2s";
            btn.style.background = "rgba(239, 68, 68, 0.2)"; // Kırmızı Zemin
            btn.style.border = "1px solid var(--danger)";     // Kırmızı Çerçeve
            btn.style.color = "var(--danger)";                // Kırmızı Yazı
            
            // İçeriği Değiştir
            btn.innerHTML = '<span><i class="fas fa-times"></i> YOK</span><span class="bq-sub" style="opacity:0.8">Portföyde Yok</span>';
            
            // 2. 1.5 SANİYE SONRA ESKİ HALİNE DÖN (Reset)
            setTimeout(() => {
                btn.style.background = ""; 
                btn.style.border = "";
                btn.style.color = ""; // Orijinal CSS rengine döner
                
                // Orijinal Yazıyı Geri Getir
                btn.innerHTML = '<span><i class="fas fa-arrow-up"></i> SATIŞ YAP</span><span class="bq-sub">Portföyden Sat</span>';
            }, 1500);
        }
    }
}

/* --- BİLDİRİM AYARLARI VE İZİN YÖNETİMİ --- */

// İzin İste
function requestNotifyPermission() {
    if (!("Notification" in window)) {
        alert("Tarayıcınız bildirimleri desteklemiyor.");
        return;
    }
    Notification.requestPermission().then((permission) => {
        checkNotifyUI();
        if (permission === "granted") {
            addNotification('success', 'Bildirimler Aktif', 'Artık önemli gelişmeleri kaçırmayacaksınız.');
        }
    });
}

// İzin Durumunu Kontrol Et (UI Göster/Gizle)
function checkNotifyPermission() {
    const card = document.getElementById('permRequestCard');
    if (!("Notification" in window)) return;
    
    if (Notification.permission === "granted" || Notification.permission === "denied") {
        if(card) card.style.display = 'none';
    } else {
        if(card) card.style.display = 'block'; // İzin verilmemişse uyarıyı göster
    }
}

// Ayarları UI'a Yansıt
function loadNotifyUI() {
    document.getElementById('ntf_price').checked = notifySettings.price;
    document.getElementById('ntf_trade').checked = notifySettings.trade;
    document.getElementById('ntf_news').checked = notifySettings.news;
    document.getElementById('ntf_sound').checked = notifySettings.sound;
    document.getElementById('ntf_vibrate').checked = notifySettings.vibrate;
    checkNotifyPermission();
}

// Ayarları Kaydet
function saveNotifySettings() {
    notifySettings.price = document.getElementById('ntf_price').checked;
    notifySettings.trade = document.getElementById('ntf_trade').checked;
    notifySettings.news = document.getElementById('ntf_news').checked;
    notifySettings.sound = document.getElementById('ntf_sound').checked;
    notifySettings.vibrate = document.getElementById('ntf_vibrate').checked;
    
    localStorage.setItem('tm_notify_settings', JSON.stringify(notifySettings));
    
    // Ses önizlemesi (Kullanıcı sesi açarsa 'ding' duysun)
    if(notifySettings.sound && event.target.id === 'ntf_sound') playNotificationSound('success');
}
// --- GİZLİ MOD (SECRET MODE) ---
function toggleSecretMode() {
    const isSecret = document.getElementById('muteAllToggle').checked;
    localStorage.setItem('tm_secret_mode', isSecret);
    
    if(isSecret) {
        // Kullanıcıya son bir bilgi verip susuyoruz
        addNotification('warn', 'Gizli Mod Aktif', 'Artık hiçbir sistem bildirimi ekranda görünmeyecek.');
    } else {
        // Sessizlikten çıkınca haber ver
        addNotification('success', 'Gizli Mod Kapalı', 'Bildirimler tekrar aktif.');
    }
}

// Ses Çalma Fonksiyonu
function playNotificationSound(type) {
    // Basit bip sesleri (Base64 encoded audio - dış dosya gerektirmez)
    let audioSrc = "";
    
    if(type === 'success' || type === 'info') {
        // Success "Ding"
        audioSrc = "data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"; // (Kısaltıldı, gerçek bir ding sesi için URL kullanmak daha iyi olabilir veya kısa beep)
        // Daha güvenilir bir yöntem: Web Audio API Oscillator
        playBeep(600, 200, 'sine');
    } else if (type === 'danger' || type === 'warn') {
        // Error "Buzz"
        playBeep(150, 400, 'sawtooth');
    }
}

// Basit Web Audio Beep (Dosyasız Ses)
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playBeep(freq, duration, type='sine') {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    
    // Fade out
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + (duration/1000));
    
    setTimeout(() => osc.stop(), duration);
}

function testNotification() {
    addNotification('info', 'Test Bildirimi', 'Bu bir test mesajıdır. Ses ve titreşim çalışıyor mu?');
}

// checkNotifyUI fonksiyonu eksikti, ekleyelim
function checkNotifyUI() {
    checkNotifyPermission();
}
/* --- YENİ GELİŞMİŞ VE GENİŞ KAPSAMLI DÖVİZ MOTORU --- */
async function fetchFastForex() {
    try {
        // 1. CANLI VERİ (Binance - Majör Paralar)
        // Dolar, Euro ve Sterlin'i buradan anlık çekiyoruz
        const resBinance = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbols=["USDTTRY","EURUSDT","GBPUSDT"]');
        const dataBinance = await resBinance.json();

        // 2. PARİTE ORANLARI (Diğerleri için - Open Exchange Rates)
        // JPY, CNY, CAD, RUB gibi paraların Dolara olan oranını alıyoruz
        const resParity = await fetch('https://open.er-api.com/v6/latest/USD');
        const dataParity = await resParity.json();
        const rates = dataParity.rates; 

        // --- VERİLERİ AYIKLA ---
        const usdt = dataBinance.find(x => x.symbol === 'USDTTRY');
        const eur = dataBinance.find(x => x.symbol === 'EURUSDT');
        const gbp = dataBinance.find(x => x.symbol === 'GBPUSDT');

        if (!usdt || !eur || !gbp || !rates) return [];

        // Ana Dolar Kuru (Her şey buna bağlı değişecek)
        const usdPrice = parseFloat(usdt.lastPrice);
        const usdChange = parseFloat(usdt.priceChangePercent);

        // --- YARDIMCI: DİĞER PARALARI HESAPLA ---
        // Mantık: (1 Dolar / Parite Oranı) * Canlı Dolar Kuru = Canlı TL Değeri
        const calcOther = (parityVal, name, flagCode, symbolPrefix) => {
            const priceInUsd = 1 / parityVal; 
            const priceInTry = priceInUsd * usdPrice;
            
            return {
                symbol: name,
                price: priceInTry,
                change: usdChange, // Dolar artarsa bunlar da artar
                vol: 0,
                source: 'HESAPLANAN',
                image: `https://flagcdn.com/w80/${flagCode}.png`, // Ülke Bayrağı
                unit: symbolPrefix
            };
        };

        // --- YARDIMCI: MAJÖR PARALAR (EUR, GBP) ---
        const eurPrice = parseFloat(eur.lastPrice) * usdPrice;
        const eurChange = parseFloat(eur.priceChangePercent) + usdChange;
        
        const gbpPrice = parseFloat(gbp.lastPrice) * usdPrice;
        const gbpChange = parseFloat(gbp.priceChangePercent) + usdChange;

        // --- LİSTEYİ OLUŞTUR ---
        return [
            // 1. MAJÖRLER (Binance Destekli)
            { symbol: 'USD/TRY', price: usdPrice, change: usdChange, vol: parseFloat(usdt.quoteVolume), source: 'CANLI PİYASA', image: 'https://flagcdn.com/w80/us.png', unit: '₺' },
            { symbol: 'EUR/TRY', price: eurPrice, change: eurChange, vol: 0, source: 'HESAPLANAN', image: 'https://flagcdn.com/w80/eu.png', unit: '₺' },
            { symbol: 'GBP/TRY', price: gbpPrice, change: gbpChange, vol: 0, source: 'HESAPLANAN', image: 'https://flagcdn.com/w80/gb.png', unit: '₺' },

            // 2. DİĞERLERİ (Otomatik Hesaplananlar)
            calcOther(rates.JPY, 'JPY/TRY', 'jp', '¥'),  // Japon Yeni
            calcOther(rates.CNY, 'CNY/TRY', 'cn', '¥'),  // Çin Yuanı
            calcOther(rates.CAD, 'CAD/TRY', 'ca', '$'),  // Kanada Doları
            calcOther(rates.AUD, 'AUD/TRY', 'au', '$'),  // Avustralya Doları
            calcOther(rates.RUB, 'RUB/TRY', 'ru', '₽'),  // Rus Rublesi
            calcOther(rates.AZN, 'AZN/TRY', 'az', '₼'),  // Azerbaycan Manatı
            
            // 3. PARİTE (Euro/Dolar)
            { symbol: 'EUR/USD', price: parseFloat(eur.lastPrice), change: parseFloat(eur.priceChangePercent), vol: parseFloat(eur.quoteVolume), source: 'PARİTE', image: 'https://flagcdn.com/w80/eu.png', unit: '$' }
        ];

    } catch (e) {
        console.error("Forex Hatası:", e);
        return [];
    }
}

/* --- GÜNCELLENMİŞ ALTIN MOTORU (7/24 CANLI) --- */
async function fetchFastGold() {
    try {
        // 1. Canlı Veriyi Çek (Binance API - En Hızlı ve Ücretsiz)
        // PAXGUSDT = Ons Altın ($), USDTTRY = Dolar Kuru
        const res = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbols=["PAXGUSDT","USDTTRY"]');
        const data = await res.json();

        // Verileri Ayrıştır
        const paxg = data.find(x => x.symbol === 'PAXGUSDT');
        const usdt = data.find(x => x.symbol === 'USDTTRY');

        if (!paxg || !usdt) throw new Error("Veri Eksik");

        const onsPrice = parseFloat(paxg.lastPrice);
        const change = parseFloat(paxg.priceChangePercent); // Ons'un günlük değişimi
        const dolarKuru = parseFloat(usdt.lastPrice);

        // 2. Hesaplamalar (Türkiye Standartları)
        // 1 Ons = 31.1035 Gram
        const gramHas = (onsPrice * dolarKuru) / 31.1035;
        
        // Diğer altın türleri Gram Has fiyata göre oranlanır
        const gram22 = gramHas * 0.916;  // 22 Ayar (Bilezik)
        const ceyrek = gramHas * 1.606;  // Çeyrek (Eski/Yeni ortalama katsayı)
        const yarim = ceyrek * 2;
        const tam = ceyrek * 4;
        const ata = ceyrek * 4.10;       // Cumhuriyet/Ata

        // 3. Basit İkonlar
        const iconBar = "data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='8' y='16' width='48' height='32' fill='%23FFD700' stroke='%23DAA520' stroke-width='2'/%3E%3C/svg%3E";
        const iconCoin = "data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%23FFD700' stroke='%23DAA520' stroke-width='2'/%3E%3C/svg%3E";

        // 4. Listeyi Döndür
        return [
            { symbol: 'ONS ALTIN', price: onsPrice, change: change, vol: 0, source: 'KURESEL', image: iconBar },
            { symbol: 'GRAM HAS (24K)', price: gramHas, change: change, vol: 0, source: 'HESAPLANAN', image: iconBar },
            { symbol: 'ÇEYREK ALTIN', price: ceyrek, change: change, vol: 0, source: 'DARPHANE', image: iconCoin },
            { symbol: 'YARIM ALTIN', price: yarim, change: change, vol: 0, source: 'DARPHANE', image: iconCoin },
            { symbol: 'TAM ALTIN', price: tam, change: change, vol: 0, source: 'DARPHANE', image: iconCoin },
            { symbol: 'CUMHURİYET', price: ata, change: change, vol: 0, source: 'DARPHANE', image: iconCoin },
            { symbol: '22 AYAR GRAM', price: gram22, change: change, vol: 0, source: 'HESAPLANAN', image: iconCoin }
        ];

    } catch (e) {
        console.error("Gold Hata:", e);
        return [];
    }
}

/* --- TRADER KARNESİ HESAPLAMA MOTORU --- */
function calculateTraderScore() {
    let history = JSON.parse(localStorage.getItem('tm_full_trade_history')) || [];
    
    // Sadece SATIŞ işlemlerini al
    let sales = history.filter(t => t.type === 'SATIM');

    // Eğer yeterli satış verisi yoksa hesaplama yapma
    if (sales.length < 2) {
        document.getElementById('scoreBadge').innerText = "VERİ YOK";
        document.getElementById('pfScore').innerText = "--";
        document.getElementById('expScore').innerText = "--";
        document.getElementById('avgWinVal').innerText = "--";
        document.getElementById('avgLossVal').innerText = "--";
        return;
    }

    let grossProfit = 0;
    let grossLoss = 0;
    let winCount = 0;
    let lossCount = 0;
    let totalWinVal = 0;
    let totalLossVal = 0;

    sales.forEach(t => {
        // Eski kayıtlarda pnl yoksa 0 varsay
        let pnl = t.pnl !== undefined ? parseFloat(t.pnl) : 0;
        
        // Para birimi dönüşümü (Hepsini ana para birimine çevir)
        let val = pnl;
        let transCurr = t.curr || (t.isUsdBase ? 'USD' : 'TRY');
        
        if(appSettings.currency === 'TRY' && transCurr === 'USD') val = val * usdTryRate;
        else if(appSettings.currency === 'USD' && transCurr === 'TRY') val = val / usdTryRate;

        if (val > 0) {
            grossProfit += val;
            totalWinVal += val;
            winCount++;
        } else {
            let absLoss = Math.abs(val);
            grossLoss += absLoss;
            totalLossVal += absLoss;
            lossCount++;
        }
    });

    let totalTrades = winCount + lossCount;
    let winRate = totalTrades > 0 ? (winCount / totalTrades) : 0;
    
    // Kâr Faktörü (Profit Factor)
    let profitFactor = grossLoss === 0 ? (grossProfit > 0 ? 5 : 0) : (grossProfit / grossLoss);
    if(profitFactor > 99) profitFactor = 99; // Görsel sınır

    // Ortalama Kazanç ve Kayıp
    let avgWin = winCount > 0 ? (totalWinVal / winCount) : 0;
    let avgLoss = lossCount > 0 ? (totalLossVal / lossCount) : 0;

    // Beklenti Değeri
    let lossRate = 1 - winRate;
    let expectancy = (winRate * avgWin) - (lossRate * avgLoss);

    // --- UI GÜNCELLEME ---
    let sym = appSettings.currency === 'TRY' ? '₺' : '$';

    // 1. Kâr Faktörü
    let pfEl = document.getElementById('pfScore');
    pfEl.innerText = profitFactor.toFixed(2);
    
    let badge = document.getElementById('scoreBadge');
    if(profitFactor >= 2.0) {
        pfEl.style.color = "var(--success)";
        document.getElementById('pfDesc').innerText = "Mükemmel";
        badge.innerText = "MASTER";
        badge.style.color = "var(--success)";
        badge.style.background = "rgba(16, 185, 129, 0.15)";
    } else if(profitFactor >= 1.1) {
        pfEl.style.color = "var(--gold)";
        document.getElementById('pfDesc').innerText = "Kârlı";
        badge.innerText = "PRO";
        badge.style.color = "var(--gold)";
        badge.style.background = "rgba(245, 158, 11, 0.15)";
    } else {
        pfEl.style.color = "var(--danger)";
        document.getElementById('pfDesc').innerText = "Riskli";
        badge.innerText = "ACEMİ";
        badge.style.color = "var(--danger)";
        badge.style.background = "rgba(239, 68, 68, 0.15)";
    }

    // 2. Beklenti
    let expEl = document.getElementById('expScore');
    expEl.innerText = sym + expectancy.toLocaleString(undefined, {maximumFractionDigits:0});
    expEl.style.color = expectancy > 0 ? "var(--success)" : "var(--danger)";

    // 3. Ortalamalar
    document.getElementById('avgWinVal').innerText = sym + avgWin.toLocaleString(undefined, {maximumFractionDigits:0});
    document.getElementById('avgLossVal').innerText = sym + avgLoss.toLocaleString(undefined, {maximumFractionDigits:0});
}

/* --- MANUEL GEÇMİŞ EKLEME FONKSİYONLARI --- */

function openManualHistoryModal() {
    // Tarih alanına bugünü otomatik doldur
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('manualDate').value = today;
    
    // Temizle
    document.getElementById('manualSym').value = '';
    document.getElementById('manualAmt').value = '';
    document.getElementById('manualPrice').value = '';
    document.getElementById('manualBuyCost').value = '';
    
    // Varsayılan ALIM modu
    setManualType('ALIM', document.querySelectorAll('#manualHistoryModal .sim-tab')[0]);
    
    document.getElementById('manualHistoryModal').style.display = 'flex';
}

function setManualType(type, btn) {
    document.getElementById('manualType').value = type;
    
    // Buton stilleri
    const group = btn.parentElement;
    group.querySelectorAll('.sim-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    
    // Satış ise Maliyet sor, Alım ise sorma
    const costArea = document.getElementById('manualCostArea');
    if (type === 'SATIM') {
        costArea.style.display = 'block';
    } else {
        costArea.style.display = 'none';
    }
}

function saveManualHistory() {
    const type = document.getElementById('manualType').value;
    const sym = document.getElementById('manualSym').value.toUpperCase().trim();
    const dateInput = document.getElementById('manualDate').value;
    const amt = parseFloat(document.getElementById('manualAmt').value);
    const price = parseFloat(document.getElementById('manualPrice').value);
    
    if (!sym || !amt || !price || !dateInput) {
        return addNotification('warn', 'Eksik Bilgi', 'Lütfen tüm alanları doldurun.');
    }

    // Tarihi formatla (YYYY-MM-DD -> GG.AA.YYYY)
    const d = new Date(dateInput);
    const formattedDate = d.toLocaleDateString('tr-TR');
    
    let pnl = 0;
    
    // Eğer SATIŞ ise Kâr/Zarar hesapla
    if (type === 'SATIM') {
        const buyCost = parseFloat(document.getElementById('manualBuyCost').value);
        if (!buyCost) {
            return addNotification('warn', 'Maliyet Gerekli', 'Kâr hesabı için alış maliyeti şarttır.');
        }
        // PnL = (Satış Fiyatı - Alış Maliyeti) * Adet
        pnl = (price - buyCost) * amt;
    }

    // Kaydı oluştur
    let t = { 
        date: formattedDate, 
        time: "00:00", // Manuel eklenenler için varsayılan saat
        type: type, 
        sym: sym, 
        qty: amt, 
        price: price, 
        total: amt * price, 
        desc: 'Manuel Kayıt', 
        curr: appSettings.currency, // Varsayılan para birimi
        pnl: pnl
    }; 
    
    // Listeye ekle
    tradeHistory.push(t);
    
    // Tarihe göre sırala (Yeniden eskiye)
    // Not: Basitçe en sona ekliyoruz, renderHistory zaten ters çevirip gösteriyor.
    
    localStorage.setItem('tm_full_trade_history', JSON.stringify(tradeHistory)); 
    
    renderHistory();
    calculateTraderScore(); // Karne puanını anında güncelle
    
    document.getElementById('manualHistoryModal').style.display = 'none';
    addNotification('success', 'Kaydedildi', 'Geçmiş işlem başarıyla eklendi.');
}

// --- YENİ AYARLAR MENÜSÜ FONKSİYONLARI ---

// Alt sayfayı açar (Sağdan gelir)
function openSubPage(pageId) {
    // Ana menüyü gizle
    document.getElementById('settings-home').style.display = 'none';
    // Detay kapsayıcıyı göster (Animasyonlu)
    const detailWrapper = document.getElementById('settings-detail');
    detailWrapper.style.display = 'block';
    detailWrapper.style.animation = 'slideInRight 0.3s forwards';

    // Tüm içerikleri gizle, sadece isteneni aç
    document.querySelectorAll('.settings-content').forEach(el => el.style.display = 'none');
    document.getElementById('set-' + pageId).style.display = 'block';

    // Başlığı güncelle
    let titles = { 'profile': 'Profilim', 'general': 'Genel Ayarlar', 'notify': 'Bildirimler', 'history': 'Geçmiş İşlemler', 'security': 'Güvenlik' };
    document.getElementById('subPageTitle').innerText = titles[pageId] || 'Detay';
}

// Ana menüye döner
function closeSubPage() {
    document.getElementById('settings-detail').style.display = 'none';
    document.getElementById('settings-home').style.display = 'block';
    document.getElementById('settings-home').style.animation = 'fadeIn 0.3s forwards';
}

// Profil yüklendiğinde menüdeki kartı da güncelle
// (Mevcut loadProfile fonksiyonunu bozmadan genişletiyoruz)
const _originalLoadProfile = loadProfile;
loadProfile = function() {
    _originalLoadProfile(); // Eski fonksiyonu çalıştır
    
    // Menüdeki resmi ve ismi güncelle
    if(userProfile.name) document.getElementById('menuProfileName').innerText = userProfile.name;
    if(userProfile.img) document.getElementById('menuProfileImg').src = userProfile.img;
};
    // --- 3. ADIM: PROFİL RESMİ VE PREMIUM GÖRÜNÜM ---

    // Mevcut yükleme fonksiyonunu sakla (hata vermemesi için)
    var eskiLoadProfile = typeof loadProfile === 'function' ? loadProfile : function(){};

    // Yeni ve Gelişmiş Profil Yükleyici
    loadProfile = function() {
        // 1. Önceki işlemleri yap (İsimleri inputlara doldur vs.)
        eskiLoadProfile();

        // 2. Hafızadan bilgileri çek
        let up = JSON.parse(localStorage.getItem('tm_user_profile')) || {};
        let name = up.name || 'Misafir';
        
        // 3. Menüdeki İsim ve Resmi Güncelle
        // (Eğer isim yoksa 'Misafir' yazar)
        let nameEl = document.getElementById('menuProfileName');
        if(nameEl) nameEl.innerText = name;
        
        // 4. Resim Ayarı (Resim yoksa Baş Harf Avatarı oluştur)
        let imgSource = up.img;
        if(!imgSource || imgSource === "null" || imgSource === "") {
            // UI Avatars servisi: İsmin baş harflerinden resim yapar (Örn: Ahmet Yılmaz -> AY)
            imgSource = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=1e2538&color=ffffff&size=128&bold=true`;
        }
        
        // Hem ana menüdeki (küçük) hem detaydaki (büyük) resmi güncelle
        const menuImg = document.getElementById('menuProfileImg');
        const detailImg = document.getElementById('displayProfileImg');
        
        if(menuImg) menuImg.src = imgSource;
        if(detailImg) detailImg.src = imgSource;

        // 5. PREMIUM PARILTISI (GOLD EFEKT)
        // Kartı bul ve parlaması için sınıf ekle
        const card = document.getElementById('mainProfileCard');
        if(card) {
            card.classList.add('premium-glow'); 
        }
    };
    
    // Sayfa açıldığında tetikle
    setTimeout(loadProfile, 500);
    
    function sendFeedback() {
    let sub = document.getElementById('fbSubject').value;
    let msg = document.getElementById('fbMessage').value;
    
    if(msg.length < 5) {
        addNotification('warn', 'Eksik Bilgi', 'Lütfen mesajınızı yazınız.');
        return;
    }

    // Şimdilik simülasyon yapıyoruz (Gerçek sunucu olmadığı için)
    document.getElementById('feedbackModal').style.display = 'none';
    document.getElementById('fbMessage').value = ""; // Temizle
    
    // Yükleniyor efekti verelim
    addNotification('info', 'Gönderiliyor...', 'Mesajınız iletiliyor.');
    
    setTimeout(() => {
        addNotification('success', 'İletildi', 'Geri bildiriminiz için teşekkürler! 🚀');
    }, 1000);
}

// Global değişken: Tıklanan linki burada tutacağız
let currentTargetUrl = "";

// 1. Habere tıklandığında bu çalışır: Linki kaydeder ve Modalı açar
function openNewsRedirect(url) {
    if(!url) return;
    currentTargetUrl = url;
    
    // Modalı göster
    document.getElementById('newsRedirectModal').style.display = 'flex';
}

// 2. Kullanıcı "GİT" butonuna basınca bu çalışır
function proceedToNews() {
    if(currentTargetUrl) {
        // Yeni sekmede güvenli açılış
        window.open(currentTargetUrl, '_blank', 'noopener,noreferrer');
    }
    closeNewsModal();
}

// 3. İptal veya kapatma fonksiyonu
function closeNewsModal() {
    document.getElementById('newsRedirectModal').style.display = 'none';
    currentTargetUrl = ""; // Linki temizle
}

/* --- GERİ GELME (SWIPE / TUŞ) YÖNETİMİ --- */

// 1. Geri hareketini dinle (Ekran kaydırma veya tuş)
window.addEventListener('popstate', function(event) {
    const modal = document.getElementById('newsRedirectModal');
    
    // Eğer Haber Modalı Açıksa:
    if (modal && modal.style.display === 'flex') {
        // Uygulamayı kapatma, sadece modalı gizle
        modal.style.display = 'none';
        currentTargetUrl = ""; 
    }
});

// 2. Modalı açarken tarayıcıya "Sahte Geçmiş" ekle
function openNewsRedirect(url) {
    if(!url) return;
    currentTargetUrl = url;
    
    // BU SATIR ÇOK ÖNEMLİ:
    // Tarayıcıya "Yeni bir sayfaya geçtik" diyoruz.
    // Böylece kullanıcı kaydırınca (swipe yapınca) uygulamadan çıkmıyor,
    // sadece bu eklediğimiz sahte geçmiş siliniyor.
    history.pushState({ popup: 'news' }, null, window.location.href);
    
    document.getElementById('newsRedirectModal').style.display = 'flex';
}

// 3. Vazgeç butonuna basılırsa
function closeNewsModal() {
    // Manuel olarak geri git (Bu, yukarıdaki popstate olayını tetikler)
    history.back(); 
}

// 4. Git butonuna basılırsa
function proceedToNews() {
    if(currentTargetUrl) {
        // Yeni sekmede aç
        window.open(currentTargetUrl, '_blank');
        
        // Kullanıcı haberi okuyup uygulamaya geri döndüğünde modal açık kalmasın
        // Hafif gecikmeli olarak arkadaki modalı kapatıyoruz
        setTimeout(() => {
            const modal = document.getElementById('newsRedirectModal');
            if (modal && modal.style.display === 'flex') {
                history.back(); // Geçmişi temizleyerek kapat
            }
        }, 300);
    }
}

/* --- GOOGLE DRIVE ENTEGRASYONU (GÜNCELLENMİŞ) --- */

// 1. YAPILANDIRMA
const CLIENT_ID = '188241284734-3tdriq9svbm1vh8acq2vqm80lieo5v7u.apps.googleusercontent.com';
const API_KEY = 'AIzaSyCCxeYq1C4mnv-3CRvTDertau_Jlv11OaA';


const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient;
let gapiInited = false;
let gisInited = false;

// Sayfa yüklendiğinde API'leri başlat
document.addEventListener('DOMContentLoaded', () => {
    if(typeof gapi !== 'undefined') gapiLoaded();
    if(typeof google !== 'undefined') gisLoaded();
});

// 2. KÜTÜPHANE YÜKLEME
function gapiLoaded() {
    gapi.load('client', async () => {
        await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        updateDriveUI("Hazır. Giriş yapabilirsiniz.");
        console.log("GAPI Yüklendi");
    });
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // Manuel yöneteceğiz
    });
    gisInited = true;
    console.log("GIS Yüklendi");
}

// 3. GİRİŞ / ÇIKIŞ İŞLEMLERİ
function handleAuthClick() {
    if (!tokenClient) {
        addNotification('warn', 'Yükleniyor', 'Google servisleri hazırlanıyor, bekleyin...');
        // Eğer yüklenmemişse tekrar dene
        if(typeof gapi !== 'undefined' && !gapiInited) gapiLoaded();
        if(typeof google !== 'undefined' && !gisInited) gisLoaded();
        return;
    }

    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            throw (resp);
        }
        updateDriveUI("Bağlandı ✅");
        addNotification('success', 'Başarılı', 'Google hesabına bağlandı.');
        
        // Token'ı gapi'ye ata
        gapi.client.setToken(resp);
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        updateDriveUI("Çıkış yapıldı.");
        addNotification('info', 'Çıkış', 'Bağlantı kesildi.');
    }
}

function updateDriveUI(msg) {
    const el = document.getElementById('drive-status');
    if(el) el.innerText = msg;
}

// 4. YEDEKLEME (UPLOAD) İŞLEMİ
async function uploadToDrive() {
    if(!gapi.client.getToken()) {
        addNotification('warn', 'Giriş Gerekli', 'Önce Google Giriş yapmalısınız.');
        handleAuthClick(); // Otomatik giriş penceresi aç
        return;
    }

    addNotification('info', 'Yedekleniyor', 'Veriler hazırlanıyor...');

    const backupData = {
        myPF_final: localStorage.getItem('myPF_final'),
        tm_cash_balance: localStorage.getItem('tm_cash_balance'),
        tm_full_trade_history: localStorage.getItem('tm_full_trade_history'),
        tm_user_profile: localStorage.getItem('tm_user_profile'),
        tm_watchlist: localStorage.getItem('tm_watchlist'),
        tm_settings: localStorage.getItem('tm_settings'),
        backup_date: new Date().toLocaleString()
    };

    const fileContent = JSON.stringify(backupData);
    const fileName = 'trademaster_backup.json';

    try {
        // Dosya ara
        const response = await gapi.client.drive.files.list({
            q: "name = '" + fileName + "' and trashed = false",
            fields: 'files(id, name)',
            spaces: 'drive'
        });

        const files = response.result.files;
        
        const fileMetadata = {
            'name': fileName,
            'mimeType': 'application/json'
        };

        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";

        // Türkçe karakter sorunu için encode
        const base64Data = btoa(unescape(encodeURIComponent(fileContent)));

        const multipartRequestBody =
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            JSON.stringify(fileMetadata) +
            delimiter +
            'Content-Type: application/json\r\n' +
            'Content-Transfer-Encoding: base64\r\n' +
            '\r\n' +
            base64Data +
            close_delim;

        let request;

        if (files && files.length > 0) {
            // Güncelle
            const fileId = files[0].id;
            request = gapi.client.request({
                'path': '/upload/drive/v3/files/' + fileId,
                'method': 'PATCH',
                'params': {'uploadType': 'multipart'},
                'headers': { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
                'body': multipartRequestBody
            });
        } else {
            // Oluştur
            request = gapi.client.request({
                'path': '/upload/drive/v3/files',
                'method': 'POST',
                'params': {'uploadType': 'multipart'},
                'headers': { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
                'body': multipartRequestBody
            });
        }

        await request;
        addNotification('success', 'Yedeklendi ☁️', 'Verileriniz Google Drive\'a kaydedildi.');

    } catch (err) {
        console.error("Drive Hatası:", err);
        addNotification('danger', 'Hata', 'Yedekleme başarısız oldu. Konsolu kontrol edin.');
    }
}

// 5. GERİ YÜKLEME (DOWNLOAD) İŞLEMİ
async function downloadFromDrive() {
    if(!gapi.client.getToken()) {
        addNotification('warn', 'Giriş Gerekli', 'Önce Google Giriş yapmalısınız.');
        handleAuthClick();
        return;
    }

    addNotification('info', 'Aranıyor', 'Yedek dosyası aranıyor...');

    try {
        const fileName = 'trademaster_backup.json';
        const response = await gapi.client.drive.files.list({
            q: "name = '" + fileName + "' and trashed = false",
            fields: 'files(id, name)',
            spaces: 'drive'
        });

        const files = response.result.files;

        if (files && files.length > 0) {
            const fileId = files[0].id;
            
            const fileRes = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });

            const data = fileRes.result;

            if(data.myPF_final) localStorage.setItem('myPF_final', data.myPF_final);
            if(data.tm_cash_balance) localStorage.setItem('tm_cash_balance', data.tm_cash_balance);
            if(data.tm_full_trade_history) localStorage.setItem('tm_full_trade_history', data.tm_full_trade_history);
            if(data.tm_user_profile) localStorage.setItem('tm_user_profile', data.tm_user_profile);
            if(data.tm_watchlist) localStorage.setItem('tm_watchlist', data.tm_watchlist);
            if(data.tm_settings) localStorage.setItem('tm_settings', data.tm_settings);

            if(confirm("Yedek başarıyla indirildi. Uygulama yeniden başlatılsın mı?")) {
                location.reload();
            } else {
                addNotification('success', 'Tamamlandı', 'Veriler yüklendi.');
                // Sayfayı yenilemeden verileri güncelle
                loadPF(true);
                renderHistory();
                loadProfile();
            }

        } else {
            addNotification('warn', 'Bulunamadı', 'Drive\'da yedek dosyası yok.');
        }

    } catch (err) {
        console.error("İndirme Hatası:", err);
        addNotification('danger', 'Hata', 'Veri indirilemedi.');
    }
}

/* --- HABER ARAMA MOTORU TAMİR KODU --- */

// 1. Arama Fonksiyonunu Tanımlayalım
function runNewsSearch() {
    const input = document.getElementById('newsSearchInput');
    const val = input.value.trim();
    
    // Boş veya çok kısaysa uyarı ver
    if (val.length < 2) {
        return addNotification('warn', 'Arama', 'Lütfen en az 2 karakter girin.');
    }
    
    // Klavyeyi kapat (Mobilde rahatlık sağlar)
    input.blur();

    // Filtre butonlarındaki aktifliği kaldır (Çünkü özel arama yapıyoruz)
    document.querySelectorAll('.nf-chip').forEach(c => c.classList.remove('active'));
    
    // Kullanıcıya bilgi ver
    addNotification('info', 'Aranıyor', `${val} hakkında haberler getiriliyor...`);
    
    // Sayacı sıfırla ve motoru çalıştır
    newsCountdown = 60; 
    
    // Cloudflare Worker'a sorguyu gönder
    loadNews(val);
}

// 2. Enter Tuşu Desteğini Garantiye Alalım
// Sayfa yüklendiğinde input'a olay dinleyicisi ekler
document.addEventListener("DOMContentLoaded", function() {
    const input = document.getElementById('newsSearchInput');
    if(input) {
        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault(); // Form göndermeyi engelle
                runNewsSearch(); // Aramayı başlat
            }
        });
    }
});

/* --- FINAL HOLDER ANALİZİ (AÇIKLAYICI METİNLER GERİ GELDİ) --- */
function calcHolderAnalysis() {
    // 1. Verileri Al
    let years = parseFloat(document.getElementById('hYear').value);
    let annualReturn = parseFloat(document.getElementById('hReturn').value);
    let annualInflation = parseFloat(document.getElementById('hInflation').value);
    
    if(!years || isNaN(annualReturn) || isNaN(annualInflation)) {
        alert("Lütfen tüm alanları doldurunuz.");
        return;
    }

    // Varlık Bilgisi
    let as = JSON.parse(localStorage.getItem('myPF_final'));
    let asset = as[currentSimAssetIndex];
    
    let totalCost = asset.buy * asset.amt;
    let currentVal = (asset.curr || asset.buy) * asset.amt;
    let sym = asset.origin === 'USD' ? '$' : '₺';

    let startPnL = currentVal - totalCost;
    let startPnLPercent = (startPnL / totalCost) * 100;

    // 2. Hesaplamalar
    let futureNominalValue = currentVal * Math.pow((1 + (annualReturn / 100)), years);
    let inflationAdjustedCost = totalCost * Math.pow((1 + (annualInflation / 100)), years);
    
    let gap = futureNominalValue - inflationAdjustedCost;
    let isProfitable = gap >= 0;
    let gapPercent = (gap / inflationAdjustedCost) * 100;

    // 3. UI Hazırlığı
    let box = document.getElementById('simResHolder');
    let verdictColor = isProfitable ? 'var(--success)' : 'var(--danger)';
    let verdictIcon = isProfitable ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>';
    let verdictText = isProfitable ? 'MANTIKLI (Kurtarıyor)' : 'MANTIKSIZ (Kurtarmıyor)';
    
    let verdictDesc = "";
    if (startPnL < 0 && !isProfitable) {
        verdictDesc = `Başlangıçtaki <b>%${Math.abs(startPnLPercent).toFixed(1)}</b> zararı ve enflasyonu kapatamıyor.`;
    } else if (startPnL < 0 && isProfitable) {
        verdictDesc = `<b>${years} yılda</b> hem zararı kapatıp hem enflasyonu yeniyor.`;
    } else if (isProfitable) {
        verdictDesc = `Yatırımın kârda ve enflasyonu eziyor.`;
    } else {
        verdictDesc = `Kârda olsan bile enflasyon daha hızlı koşuyor.`;
    }

    box.style.display = 'block';
    box.className = 'sim-result-box ' + (isProfitable ? 'profit' : 'loss');

    // 4. HTML ÇIKTISI (ORİJİNAL AÇIKLAYICI METİNLERLE)
    let htmlContent = `
        <div style="text-align:center; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1);">
            <div style="font-size:14px; font-weight:800; color:${verdictColor}; letter-spacing:1px;">
                ${verdictIcon} ${verdictText}
            </div>
            <div style="font-size:10px; color:var(--text-sub); margin-top:4px;">${verdictDesc}</div>
        </div>

        <div style="background:rgba(255,255,255,0.05); border-radius:6px; padding:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-size:10px; color:var(--text-sub);">Şu Anki Durum:</div>
            <div style="font-size:11px; font-weight:700; color:${startPnL >= 0 ? 'var(--success)' : 'var(--danger)'};">
                ${startPnL >= 0 ? 'KÂRDA' : 'ZARARDA'} (%${startPnLPercent.toFixed(1)})
            </div>
        </div>

        <div class="sim-row">
            <span class="sim-lbl">Nominal Bakiye:</span>
            <span style="font-weight:700;">${sym}${futureNominalValue.toLocaleString(undefined, {maximumFractionDigits:0})}</span>
        </div>
        <div style="font-size:9px; color:var(--text-sub); text-align:right; margin-bottom:8px;">
            (Ekranda göreceğin rakam)
        </div>

        <div class="sim-row">
            <span class="sim-lbl">Enflasyon Maliyeti:</span>
            <span>${sym}${inflationAdjustedCost.toLocaleString(undefined, {maximumFractionDigits:0})}</span>
        </div>
        <div style="font-size:9px; color:var(--text-sub); text-align:right; margin-bottom:8px;">
            (Paranın değerini koruması için olması gereken)
        </div>

        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 10px; font-weight: 700; color: var(--text-sub); text-align: center; margin-bottom: 5px; text-transform: uppercase;">
                ALIM GÜCÜ FARKI
            </div>
            <div style="background: rgba(0,0,0,0.2); border: 1px dashed ${verdictColor}; border-radius: 8px; padding: 10px; text-align: center;">
                
                <div style="font-size: 10px; color: var(--text-sub); margin-bottom: 2px;">(Nominal Bakiye - Enflasyon Maliyeti)</div>
                
                <div style="font-size: 16px; font-weight: 800; color: ${verdictColor}; display: flex; align-items: center; justify-content: center; gap: 6px;">
                    <span>${gap >= 0 ? '+' : ''}${sym}${gap.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                    <span style="font-size: 13px; opacity: 0.8;">(%${Math.abs(gapPercent).toFixed(1)})</span>
                </div>
                
                <div style="font-size: 9px; color: var(--text-sub); margin-top: 4px;">
                    ${gap >= 0 ? 'Reel Kazanç (Kâr)' : 'Reel Kayıp (Erime)'}
                </div>
            </div>
        </div>
    `;

    box.innerHTML = htmlContent;
}

/* --- ANALİZ SAYFASI SEKME YÖNETİMİ (GÜNCELLENMİŞ) --- */
function switchAnTab(tab, btn) {
    // 1. Tüm sekmeleri gizle
    document.querySelectorAll('.an-view-section').forEach(el => el.style.display = 'none');
    
    // 2. İstenen sekmeyi göster
    const targetSection = document.getElementById('an-view-' + tab);
    if(targetSection) targetSection.style.display = 'block';
    
    // 3. Buton stillerini güncelle
    document.querySelectorAll('.s-tab').forEach(el => el.classList.remove('active'));
    if(btn) btn.classList.add('active');

    // 4. Fonksiyonları Gecikmeli Başlat
    setTimeout(() => {
        // EĞER KULLANICI BAŞKA SEKMEYE GEÇTİYSE İŞLEM YAPMA (HATAYI ÖNLER)
        if(document.getElementById('an-view-' + tab).style.display === 'none') return;

        if(tab === 'vision') {
            loadVisionData();      
            renderDailyChart();    
            updateGoalVisuals();   
        }
        if(tab === 'lab') {
            const netWorthEl = document.getElementById('anNetWorth');
            if(netWorthEl) {
                let currentNet = parseFloat(netWorthEl.innerText.replace(/[^0-9.-]+/g,"")) || 0;
                const labStart = document.getElementById('labStart');
                if(currentNet > 0 && labStart && !labStart.value) labStart.value = currentNet;
            }
        }
        
        // ---> GÜVENLİ ÇAĞRI <---
        if(tab === 'psycho') {
            calcPsychoAnalysis();
        }
        // -----------------------

    }, 100); 
}

/* ==========================================================================
   HEDEFLER (VİZYON) MODÜLÜ - FINAL (DÜZELTİLMİŞ & ÇAKIŞMA YOK)
   ========================================================================== */

// 1. YARDIMCI FONKSİYONLAR
function getCurrencySymbol() {
    let settings = JSON.parse(localStorage.getItem('tm_settings')) || { currency: 'TRY' };
    return settings.currency === 'TRY' ? '₺' : '$';
}

function parseTurkishInput(val) {
    if (!val) return 0;
    val = val.toString().trim();
    if (val.includes('.') && val.includes(',')) {
        val = val.replace(/\./g, '').replace(',', '.');
    } else if (val.includes(',')) {
        val = val.replace(',', '.');
    }
    return parseFloat(val) || 0;
}

// 2. GÜVENLİ BAKİYE HESAPLAYICI
function getSafeBalance() {
    try {
        let cash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
        let pf = JSON.parse(localStorage.getItem('myPF_final')) || [];
        let settings = JSON.parse(localStorage.getItem('tm_settings')) || { currency: 'TRY' };
        let currentUsd = (typeof window.usdTryRate !== 'undefined') ? window.usdTryRate : 36.50; 
        
        let total = 0;
        pf.forEach(item => {
            let p = (item.curr && item.curr > 0) ? item.curr : item.buy;
            if(settings.currency === 'TRY') {
                total += (item.origin === 'USD') ? (p * item.amt * currentUsd) : (p * item.amt);
            } else {
                total += (item.origin === 'TRY') ? ((p * item.amt) / currentUsd) : (p * item.amt);
            }
        });
        return total + cash;
    } catch(e) { return 0; }
}

// 3. GÜNLÜK KAYIT SİSTEMİ
window.checkAndLogDaily = function() {
    let currentTotal = getSafeBalance();
    let logs = JSON.parse(localStorage.getItem('tm_daily_tracking')) || [];
    let today = new Date().toLocaleDateString('tr-TR');
    
    let lastLog = logs.length > 0 ? logs[logs.length - 1] : null;
    
    if (!lastLog || lastLog.date !== today) {
        logs.push({ date: today, val: currentTotal });
        if(logs.length > 30) logs.shift();
    } else {
        lastLog.val = currentTotal;
    }
    
    localStorage.setItem('tm_daily_tracking', JSON.stringify(logs));
    return logs;
};

// 4. BUTON AKSİYONU (GÜNCELLEME)
window.manualUpdateVision = function() {
    const elRate = document.getElementById('visionRate');
    const elAdd = document.getElementById('visionAdd');
    
    if(!elRate || !elAdd) return;

    let rateVal = parseTurkishInput(elRate.value);
    let addVal = parseTurkishInput(elAdd.value);

    // Ayarları kaydet
    localStorage.setItem('tm_vision_settings', JSON.stringify({ rate: rateVal, add: addVal }));
    
    // Yükleme fonksiyonunu çağır
    window.loadVisionData();
    
    if(typeof addNotification === 'function') addNotification('success', 'Güncellendi', 'Grafik yeni ayarlara göre çizildi.');
};

// 5. HEDEF DÜZENLEME
window.editTargetGoal = function() {
    let current = localStorage.getItem('tradevia_main_goal') || 1000000;
    let val = prompt("Yeni Hedef Tutarınız:", current);
    if(val && !isNaN(parseFloat(val))) {
        localStorage.setItem('tradevia_main_goal', parseFloat(val));
        window.loadVisionData();
    }
};

// 6. ANA YÜKLEYİCİ (HER ŞEYİ ÇAĞIRIR)
window.loadVisionData = function() {
    let data = JSON.parse(localStorage.getItem('tm_vision_settings')) || { rate: 5, add: 1000 };
    
    // Inputları doldur (Eğer boşsa)
    const elRate = document.getElementById('visionRate');
    const elAdd = document.getElementById('visionAdd');
    if(elRate && document.activeElement !== elRate) elRate.value = data.rate;
    if(elAdd && document.activeElement !== elAdd) elAdd.value = data.add;

    let logs = window.checkAndLogDaily();
    
    renderListSafe(logs);
    updateBarSafe();
    
    // Grafiği çiz (Gecikmeli çağırarak DOM'un hazır olmasını bekle)
    setTimeout(() => {
        renderDailyChart(logs, data.rate, data.add);
    }, 50);
};

// 7. LİSTE RENDER
function renderListSafe(logs) {
    const list = document.getElementById('dailyLogList');
    if(!list) return;
    
    let html = "";
    let sym = getCurrencySymbol();

    for (let i = logs.length - 1; i >= 0; i--) {
        let curr = logs[i];
        let prev = (i > 0) ? logs[i-1] : null;
        let diffHtml = '<span style="color:var(--text-sub); font-size:11px;">(Başlangıç)</span>';
        
        if(prev) {
            let diff = curr.val - prev.val;
            let color = diff >= 0 ? '#10b981' : '#ef4444';
            let sign = diff > 0 ? '+' : '';
            diffHtml = `<span style="color:${color}; font-weight:800; font-size:13px;">${sign}${sym}${diff.toLocaleString(undefined, {maximumFractionDigits:0})}</span>`;
        }

        html += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid rgba(255,255,255,0.05);">
                    <span style="color:var(--text-sub); font-weight:600;">${curr.date}</span>
                    ${diffHtml}
                 </div>`;
    }
    
    if(html === "") html = "<div style='padding:15px; text-align:center; color:#64748b;'>Kayıt yok.</div>";
    list.innerHTML = html;
}

// 8. PROGRESS BAR GÜNCELLEME
function updateBarSafe() {
    let target = parseFloat(localStorage.getItem('tradevia_main_goal')) || 1000000;
    let total = getSafeBalance();
    let sym = getCurrencySymbol();
    
    let pct = target > 0 ? (total / target) * 100 : 0;
    if(pct > 100) pct = 100; if(pct < 0) pct = 0;

    const bar = document.getElementById('dynamicGoalBar');
    const txtL = document.getElementById('goalCurrentText');
    const txtR = document.getElementById('goalTargetTextRight');
    
    if(bar) {
        bar.style.width = "0%"; 
        setTimeout(() => { bar.style.width = pct + "%"; }, 50);
        
        bar.className = 'goal-strip-fill';
        if(pct < 33) bar.classList.add('gs-red');
        else if(pct < 66) bar.classList.add('gs-yellow');
        else bar.classList.add('gs-green');
    }
    
    if(txtL) txtL.innerText = `%${pct.toFixed(1)} (${sym}${total.toLocaleString(undefined,{maximumFractionDigits:0})})`;
    if(txtR) txtR.innerText = `HEDEF: ${sym}${target.toLocaleString(undefined,{maximumFractionDigits:0})}`;

    const vCurr = document.getElementById('visionCurrentValue');
    const vRem = document.getElementById('visionRemainingValue');
    if(vCurr) vCurr.innerText = sym + total.toLocaleString(undefined,{maximumFractionDigits:0});
    if(vRem) vRem.innerText = sym + Math.max(0, target - total).toLocaleString(undefined,{maximumFractionDigits:0});
}

// 5. Grafik Çizim Motoru (NEON LINE / TRADINGVIEW STYLE)
window.renderDailyChart = function(logs, monthlyRate, monthlyAdd) {
    const canvas = document.getElementById('visionChart');
    if(!canvas) return; 

    // --- ESKİ GRAFİĞİ YOK ET ---
    if (typeof Chart !== 'undefined') {
        const existingChart = Chart.getChart(canvas); 
        if (existingChart) existingChart.destroy(); 
    }

    const ctx = canvas.getContext('2d');

    // --- NEON GLOW GRADYANLARI (Çizginin altına hafif sis verir) ---
    
    // 1. Pembe/Kırmızı (Hedef Çizgisi İçin)
    let gradPink = ctx.createLinearGradient(0, 0, 0, 400);
    gradPink.addColorStop(0, 'rgba(244, 63, 94, 0.4)');   // Neon Kırmızı
    gradPink.addColorStop(1, 'rgba(244, 63, 94, 0.0)');   // Saydam

    // 2. Mavi/Cyan (Mevcut Durum İçin)
    let gradCyan = ctx.createLinearGradient(0, 0, 0, 400);
    gradCyan.addColorStop(0, 'rgba(34, 211, 238, 0.4)');  // Neon Mavi
    gradCyan.addColorStop(1, 'rgba(34, 211, 238, 0.0)');

    // 3. Mor (Anapara İçin)
    let gradPurple = ctx.createLinearGradient(0, 0, 0, 400);
    gradPurple.addColorStop(0, 'rgba(139, 92, 246, 0.2)');
    gradPurple.addColorStop(1, 'rgba(139, 92, 246, 0.0)');

    // --- VERİ HAZIRLIĞI ---
    if(!logs) logs = JSON.parse(localStorage.getItem('tm_daily_tracking')) || [];
    
    if (monthlyRate === undefined) {
        let saved = JSON.parse(localStorage.getItem('tm_vision_settings')) || { rate: 5 };
        monthlyRate = saved.rate;
    }
    if (monthlyAdd === undefined) {
        let saved = JSON.parse(localStorage.getItem('tm_vision_settings')) || { add: 1000 };
        monthlyAdd = saved.add;
    }

    let labels = logs.map(l => l.date.substring(0, 5));
    let actualData = logs.map(l => l.val);
    
    let startBalance = actualData.length > 0 ? actualData[actualData.length - 1] : 0;
    if(startBalance === 0) {
        let netWorthText = document.getElementById('anNetWorth') ? document.getElementById('anNetWorth').innerText : "0";
        startBalance = parseFloat(netWorthText.replace(/[^0-9.-]+/g,"")) || 0;
        if(labels.length === 0) { labels.push("Bugün"); actualData.push(startBalance); }
    }

    let dailyRate = monthlyRate / 30; 
    let dailyAdd = monthlyAdd / 30;
    let projectedData = [];
    let principalData = [];
    let simBal = startBalance;
    let princBal = startBalance;

    for(let i=1; i<=30; i++) {
        princBal += dailyAdd;
        simBal = simBal * (1 + (dailyRate/100)) + dailyAdd;
        projectedData.push(simBal);
        principalData.push(princBal);
        
        if(i === 1) labels.push("Yarın");
        else if(i % 5 === 0) labels.push("+" + i + "g");
        else labels.push(""); 
    }

    let chartDataActual = [...actualData, ...Array(projectedData.length).fill(null)];
    let chartDataProjected = [...Array(actualData.length-1).fill(null), startBalance, ...projectedData];
    let chartDataPrincipal = [...Array(actualData.length-1).fill(null), startBalance, ...principalData];
    
    let target = parseFloat(localStorage.getItem('tradevia_main_goal')) || 1000000;
    let targetData = Array(labels.length).fill(target);

    // --- ÇİZİM ---
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    // TAHMİNİ HEDEF (KIRMIZI/PEMBE - REFERANS GÖRSELDEKİ GİBİ)
                    label: 'Potansiyel',
                    data: chartDataProjected,
                    borderColor: '#f43f5e', // Neon Rose
                    backgroundColor: gradPink,
                    borderWidth: 2,         // İnce ve Keskin
                    pointRadius: 0,
                    fill: true,
                    tension: 0.2,           // Daha sert hatlar (HFT Havası)
                    order: 2
                },
                {
                    // MEVCUT DURUM (MAVİ - PARLAYAN)
                    label: 'Mevcut',
                    data: chartDataActual,
                    borderColor: '#22d3ee', // Neon Cyan
                    backgroundColor: gradCyan,
                    borderWidth: 3,
                    pointRadius: 4,
                    pointBackgroundColor: '#000',
                    pointBorderColor: '#22d3ee',
                    pointBorderWidth: 2,
                    fill: true,
                    tension: 0.2,
                    order: 1 // En önde
                },
                {
                    // ANAPARA (MOR - ALTYAPI)
                    label: 'Anapara',
                    data: chartDataPrincipal,
                    borderColor: '#8b5cf6', // Mor
                    backgroundColor: gradPurple,
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: true,
                    tension: 0.2,
                    order: 3
                },
                {
                    // HEDEF ÇİZGİSİ (SİLİK REHBER)
                    label: 'Hedef',
                    data: targetData,
                    borderColor: 'rgba(255, 255, 255, 0.1)', 
                    borderWidth: 1,
                    borderDash: [2, 2],
                    pointRadius: 0,
                    fill: false,
                    order: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1500,
                easing: 'easeOutExpo' // Hızlı başlayıp yavaşlayan teknik animasyon
            },
            layout: {
                padding: { top: 10, right: 10, left: 0, bottom: 0 }
            },
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: { 
                legend: { display: false }, 
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#94a3b8',
                    bodyColor: '#fff',
                    borderColor: '#334155',
                    borderWidth: 1,
                    padding: 10,
                    displayColors: true,
                    usePointStyle: true,
                    callbacks: {
                        label: function(context) {
                            let val = context.parsed.y;
                            if(val !== null) {
                                return ' ' + val.toLocaleString('tr-TR', {maximumFractionDigits: 0});
                            }
                            return '';
                        }
                    }
                }
            },
            scales: {
                x: { 
                    // Dikey Çizgiler (Zaman)
                    grid: { 
                        color: 'rgba(255,255,255,0.03)', 
                        drawBorder: false 
                    }, 
                    ticks: { color: '#475569', font:{size:9}, maxTicksLimit: 6 } 
                },
                y: { 
                    // Yatay Çizgiler (Fiyat)
                    grid: { 
                        color: 'rgba(255,255,255,0.05)', 
                        borderDash: [4, 4] // Kesikli Grid (Teknik Analiz Havası)
                    }, 
                    ticks: { display: false } // Rakamlar gizli, sadece çizgi var
                }
            }
        }
    });
};

// 10. BAŞLATICI
document.addEventListener("DOMContentLoaded", function() {
    // Sayfa tamamen yüklendiğinde çalıştır
    setTimeout(window.loadVisionData, 500);
});


/* ==========================================================================
   AR-GE (LAB) MASTER MODÜLÜ - (FİNAL SÜRÜM)
    ========================================================================== */

let currentSelectedAssetSym = ""; 

// --- ZAMAN MAKİNESİ YARDIMCI FONKSİYONLARI (YENİ) ---

// 1. Listeyi Doldur: Cüzdandaki varlıkları <select> içine ekler
function populateTimeMachineAssets() {
    const select = document.getElementById('timeMachineSelect');
    if(!select) return; // Eğer element yoksa hata vermesin diye
    
    // Önce listeyi temizle ve varsayılanı ekle
    select.innerHTML = '<option value="-1">Manuel Yazacağım</option>';
    
    // LocalStorage'dan portföyü çek
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    
    // Her varlığı listeye ekle
    as.forEach((a) => {
        select.innerHTML += `<option value="${a.name}">${a.name}</option>`;
    });
}

// 2. Seçileni Inputa Yaz: Listeden seçileni text kutusuna kopyalar
function fillTimeMachineSymbol() {
    let val = document.getElementById('timeMachineSelect').value;
    // Eğer "Manuel" seçili değilse kutuyu doldur
    if(val !== "-1") {
        document.getElementById('statSymbol').value = val; 
    }
}

// --- ANA GEÇİŞ FONKSİYONU (GÜNCELLENMİŞ VE DÜZELTİLMİŞ HALİ) ---

function switchLabTool(tool, btn) {
    // ÖNCELİKLE TÜM SONUÇ EKRANLARINI TEMİZLE
    resetAllLabResults();
    
    // Önce tüm araçları gizle
    document.querySelectorAll('.lab-tool-container').forEach(el => el.style.display = 'none');
    
    // Seçilen aracı bul ve göster
    const targetTool = document.getElementById('lab-tool-' + tool);
    if(targetTool) targetTool.style.display = 'block';
    
    // Üst menü butonunun rengini (aktifliğini) ayarla
    if(btn) {
        const parent = btn.parentElement;
        parent.querySelectorAll('.chart-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // A) Risk Aracı Mantığı
    if(tool === 'risk') {
        populateRiskAssets(); 
        const inputBalance = document.getElementById('riskBalance');
        let storedCash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
        if(inputBalance && inputBalance.value === "") {
            inputBalance.value = Math.floor(storedCash);
            inputBalance.placeholder = "Nakit veya Varlık Değeri";
        }
    }

    // B) Maliyet Düşürme Aracı Mantığı
    if(tool === 'avg') {
        populateAdvAvgAssets(); 
        if(typeof renderSavedStrategies === 'function') renderSavedStrategies();
    }

    // C) Zaman Makinesi Mantığı
    if(tool === 'time') {
        if(typeof populateTimeMachineAssets === 'function') populateTimeMachineAssets();
    }

    // D) RİSK SİHİRBAZI (YENİ EKLENEN KISIM)
    if(tool === 'pos') {
        fillPosBalance(); // <-- Sihirbazı çalıştıran tetikleyici burada olmalı!
    }
}

// --- RİSK SİHİRBAZI FONKSİYONLARI (BU KISIM EKSİKTİ) ---

// 1. Bakiyeyi Çek ve Analizi Başlat
function fillPosBalance() {
    // Bakiyeyi al
    let storedCash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
    
    // Eğer nakit 0 ise toplam portföy değerini bulmaya çalış
    if(storedCash === 0) {
         let saved = JSON.parse(localStorage.getItem('myPF_final')) || [];
         // Basitçe: Miktar * Alış Fiyatı (veya güncel fiyat)
         let totalVal = saved.reduce((acc, item) => acc + (item.amt * (item.curr || item.buy)), 0);
         storedCash = totalVal;
    }
    document.getElementById('posBalance').value = Math.floor(storedCash);

    // --- DNA ANALİZİ VE UI GÜNCELLEME  ---
    if(typeof analyzeTraderDNA === 'function') {
        let dna = analyzeTraderDNA(tradeHistory, storedCash);

        let card = document.getElementById('dnaCard');
        if(card) {
            card.style.display = 'block';
            card.style.borderLeftColor = dna.color;

            let badge = document.getElementById('dnaType');
            badge.innerText = dna.type;
            badge.style.backgroundColor = dna.color + "30"; 
            badge.style.color = dna.color;

            document.getElementById('dnaMsg').innerText = dna.msg;

            // Önerilen Riski Otomatik Seç
            document.getElementById('posRiskPct').value = dna.riskAdvice;
        }
    }

    // İlk hesaplamayı yap
    calcPositionSize();
}

// 2. Hesaplama Motoru
function calcPositionSize() {
    let balance = parseFloat(document.getElementById('posBalance').value) || 0;
    let riskPct = parseFloat(document.getElementById('posRiskPct').value) || 2;
    let stopDist = parseFloat(document.getElementById('posStopDist').value) || 5;

    if(balance <= 0 || stopDist <= 0) return;

    // Matematik: (Kasa * Risk%) / (Stop Uzaklığı%)
    let riskAmount = balance * (riskPct / 100);
    let positionSize = riskAmount / (stopDist / 100);

    // İşlem büyüklüğü kasadan büyük olamaz
    if(positionSize > balance) positionSize = balance;

    // Ekrana Yazdır
    document.getElementById('posResultSize').innerText = positionSize.toLocaleString('tr-TR', {maximumFractionDigits: 0}) + " ₺";
    document.getElementById('posResultRisk').innerText = "-" + riskAmount.toLocaleString('tr-TR', {maximumFractionDigits: 0}) + " ₺";
}

/* --------------------------------------------------------------------------
   BÖLÜM 2: KAYIT VE ARŞİV SİSTEMİ
   -------------------------------------------------------------------------- */

function saveCurrentScenario() {
    let idx = document.getElementById('advAvgSelect').value;
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let assetName = (idx != "-1" && as[idx]) ? as[idx].name : "Manuel Varlık";

    let newAvg = document.getElementById('aaResAvg').innerText;
    let budget = document.getElementById('aaBudget').value;
    let target = document.getElementById('aaTarget').value;
    let qty = document.getElementById('aaResQty').innerText;
    
    let mode = document.getElementById('avg-mode-budget').style.display !== 'none' ? 'Bütçe' : 'Hedef';
    let mainVal = (mode === 'Bütçe') ? budget : target;

    if(newAvg === "--") return addNotification('warn', 'Hata', 'Önce bir hesaplama yapmalısın.');

    let strategy = {
        id: Date.now(), 
        date: new Date().toLocaleDateString('tr-TR'),
        sym: assetName,
        mode: mode,
        val: mainVal,
        result: newAvg,
        qty: qty
    };

    let saved = JSON.parse(localStorage.getItem('tm_saved_strategies')) || [];
    saved.push(strategy);
    localStorage.setItem('tm_saved_strategies', JSON.stringify(saved));

    addNotification('success', 'Kaydedildi', 'Strateji hafızaya alındı.');
    renderSavedStrategies(); 
}

function renderSavedStrategies() {
    let saved = JSON.parse(localStorage.getItem('tm_saved_strategies')) || [];
    let container = document.getElementById('savedStrategiesList');
    if(!container) return;

    if(saved.length === 0) {
        container.innerHTML = "<div style='text-align:center; font-size:10px; color:var(--text-sub); opacity:0.5; padding:10px;'>Henüz kayıtlı plan yok.</div>";
        return;
    }

    let html = "";
    saved.reverse().forEach(item => {
        let icon = item.mode === 'Bütçe' ? 'fa-wallet' : 'fa-crosshairs';
        let color = item.mode === 'Bütçe' ? '#3b82f6' : '#ef4444';
        
        html += `
        <div style="background:rgba(255,255,255,0.03); border-radius:8px; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border-left:3px solid ${color};">
            <div>
                <div style="font-size:12px; font-weight:700; color:white;">${item.sym} <span style="font-size:9px; color:var(--text-sub); font-weight:400;">(${item.date})</span></div>
                <div style="font-size:10px; color:var(--text-sub); margin-top:2px;">
                    <i class="fas ${icon}" style="color:${color}; margin-right:3px;"></i> 
                    ${item.mode}: <b>${parseFloat(item.val).toLocaleString()}</b> -> Hedef Ort: <b style="color:#fff;">${item.result}</b>
                </div>
            </div>
            <button onclick="deleteStrategy(${item.id})" style="background:none; border:none; color:var(--text-sub); cursor:pointer; padding:5px;">
                <i class="fas fa-trash"></i>
            </button>
        </div>`;
    });

    container.innerHTML = html;
}

function deleteStrategy(id) {
    if(!confirm("Bu planı silmek istiyor musun?")) return;
    let saved = JSON.parse(localStorage.getItem('tm_saved_strategies')) || [];
    let newSaved = saved.filter(x => x.id !== id);
    localStorage.setItem('tm_saved_strategies', JSON.stringify(newSaved));
    renderSavedStrategies();
}

/* --------------------------------------------------------------------------
   BÖLÜM 3: RİSK ARACI YARDIMCI (ESKİ KODUN DEVAMI)
   -------------------------------------------------------------------------- */
function populateRiskAssets() {
    const selectBox = document.getElementById('riskAssetSelect');
    if(!selectBox) return;
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    selectBox.innerHTML = '<option value="-1">Manuel Giriş / Seçiniz</option>';
    if(as.length === 0) { selectBox.add(new Option("(Portföy Boş)", "-1")); return; }
    as.forEach((asset, index) => {
        selectBox.add(new Option(`${asset.name} (${asset.amt} Adet)`, index));
    });
}


function fillRiskFromAsset() {
    let idx = document.getElementById('riskAssetSelect').value;
    if(idx == "-1") return;
    
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let asset = as[idx]; 
    
    if(asset) {
        let rawPrice = asset.curr || asset.buy; 
        let amount = asset.amt;
        let currentUsd = (typeof usdTryRate !== 'undefined') ? usdTryRate : 36.50;
        let myCurr = (typeof appSettings !== 'undefined') ? appSettings.currency : 'TRY';
        let totalValConverted = 0;
        let unitPriceConverted = 0;

        if(myCurr === 'TRY') {
            if(asset.origin === 'USD') {
                totalValConverted = rawPrice * amount * currentUsd;
                unitPriceConverted = rawPrice * currentUsd;
            } else {
                totalValConverted = rawPrice * amount;
                unitPriceConverted = rawPrice;
            }
        } else {
            if(asset.origin === 'TRY') {
                totalValConverted = (rawPrice * amount) / currentUsd;
                unitPriceConverted = rawPrice / currentUsd;
            } else {
                totalValConverted = rawPrice * amount;
                unitPriceConverted = rawPrice;
            }
        }
        
        const balInput = document.getElementById('riskBalance');
        const entryInput = document.getElementById('riskEntry');
        
        if(balInput) { balInput.value = totalValConverted.toFixed(2); if(typeof flashInput === 'function') flashInput(balInput); }
        if(entryInput) { entryInput.value = unitPriceConverted.toFixed(2); if(typeof flashInput === 'function') flashInput(entryInput); }
    }
}

function calcLabRisk() {
    let balance = parseFloat(document.getElementById('riskBalance').value);
    let riskPct = parseFloat(document.getElementById('riskPct').value);
    let entry = parseFloat(document.getElementById('riskEntry').value);
    let stop = parseFloat(document.getElementById('riskStop').value);

    if(isNaN(balance) || isNaN(riskPct) || isNaN(entry) || isNaN(stop)) return alert("Lütfen tüm alanları doldurun.");
    
    let riskAmount = balance * (riskPct / 100);
    let diffPerUnit = Math.abs(entry - stop); 
    
    if(diffPerUnit === 0) return alert("Giriş ve Stop fiyatı aynı olamaz.");

    let qty = riskAmount / diffPerUnit;
    let totalPosSize = qty * entry;
    let portfolioImpact = (totalPosSize / balance) * 100;
    let sym = (typeof appSettings !== 'undefined' && appSettings.currency === 'TRY') ? '₺' : '$';

    document.getElementById('resRiskQty').innerText = qty.toLocaleString(undefined, {maximumFractionDigits:2});
    document.getElementById('resRiskLoss').innerText = "-" + sym + riskAmount.toLocaleString(undefined, {maximumFractionDigits:2});
    document.getElementById('resPosSize').innerText = sym + totalPosSize.toLocaleString(undefined, {maximumFractionDigits:2});
    
    let warnEl = document.getElementById('riskWarning');
    let ratioText = document.getElementById('riskRatioText');
    
    if(ratioText) {
        let isManual = document.getElementById('riskAssetSelect') && document.getElementById('riskAssetSelect').value == "-1";
        
        if(portfolioImpact > 100 && isManual) {
            warnEl.style.color = "var(--danger)";
            warnEl.style.border = "1px solid var(--danger)";
            ratioText.innerHTML = `<b>YETERSİZ BAKİYE:</b> %${portfolioImpact.toFixed(0)} gerekiyor.`;
        } else {
            warnEl.style.color = "var(--text-sub)";
            warnEl.style.border = "none";
            ratioText.innerHTML = `Bu işlem sermayenin <b>%${portfolioImpact.toFixed(1)}</b> kadarını kapsar.`;
        }
    }
    document.getElementById('riskResultBox').style.display = 'block';
}

/* --------------------------------------------------------------------------
   BÖLÜM: AKILLI MALİYET SİHİRBAZI (TAM SÜRÜM)
   -------------------------------------------------------------------------- */

// 1. VARLIK SEÇİLİNCE ÇALIŞAN ANA FONKSİYON
function fillAdvAvgData() {
    let idx = document.getElementById('advAvgSelect').value;
    
    // --- A) KASADAKİ PARAYI ÇEK VE SLIDER'I AYARLA ---
    let currentCash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
    
    let budgetInput = document.getElementById('aaBudget');
    let sliderInput = document.getElementById('aaBudgetSlider');
    
    if (budgetInput && sliderInput) {
        // 1. Slider'ın sınırını kasadaki tüm para yap
        sliderInput.max = currentCash > 0 ? currentCash : 100000;
        
        // 2. Varsayılan olarak %50'ye (Güvenli Bölgeye) getir
        let safeAmount = currentCash / 2;
        sliderInput.value = safeAmount;
        budgetInput.value = safeAmount.toFixed(2);
        
        // 3. Görünümü ve Renkleri Güncelle
        updateSliderVisuals(sliderInput);
    }
    // ------------------------------------------------

    // --- B) SEÇİLEN VARLIĞIN BİLGİLERİNİ DOLDUR ---
    if(idx == "-1") {
        // Seçim iptal edilirse temizle
        document.getElementById('aaOldQty').value = "";
        document.getElementById('aaOldPrice').value = "";
        document.getElementById('aaCurPrice').value = "";
        if(typeof currentSelectedAssetSym !== 'undefined') currentSelectedAssetSym = "";
        return;
    }
    
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let asset = as[idx];
    
    if(asset) {
        // Fiyatları al
        let rawBuy = asset.buy; 
        let rawCurr = asset.curr && asset.curr > 0 ? asset.curr : asset.buy;

        // Kutuları doldur
        document.getElementById('aaOldQty').value = asset.amt;
        document.getElementById('aaOldPrice').value = rawBuy.toFixed(2);
        document.getElementById('aaCurPrice').value = rawCurr.toFixed(2);
        
        if(typeof currentSelectedAssetSym !== 'undefined') currentSelectedAssetSym = asset.name;

        // Hesaplamayı tetikle (Otomatik hesaplasın)
        if(typeof calcAdvAvg === 'function') {
            calcAdvAvg('budget');
        }
    }
}

// 2. SLIDER HAREKET ETTİKÇE ÇALIŞAN FONKSİYON
function syncBudgetSlider(source) {
    const slider = document.getElementById('aaBudgetSlider');
    const input = document.getElementById('aaBudget');

    if (!slider || !input) return;

    if(source === 'slider') {
        // Slider oynatıldıysa input'a yaz
        input.value = slider.value;
    } else {
        // Input'a elle yazıldıysa slider'ı güncelle
        let val = parseFloat(input.value) || 0;
        // Eğer elle girilen rakam slider sınırını aşıyorsa sınırı büyüt
        if(val > parseFloat(slider.max)) slider.max = val; 
        slider.value = val;
    }
    
    // --- RENK VE YAZI GÜNCELLEME ---
    updateSliderVisuals(slider);
    
    // Hesaplamayı yap
    if(typeof calcAdvAvg === 'function') {
        calcAdvAvg('budget');
    }
}

// 3. GÖRSEL EFEKT VE RENK YÖNETİMİ (YENİ ÖZELLİK)
function updateSliderVisuals(slider) {
    if (!slider) return;

    let val = parseFloat(slider.value) || 0;
    let max = parseFloat(slider.max) || 100;
    if (max <= 0) max = 100; // Bölme hatası olmasın

    // Yüzdeyi hesapla
    let percent = (val / max) * 100;
    
    // --- RENK MANTIĞI ---
    let color = '#10b981'; // YEŞİL (Güvenli)
    let label = 'Güvenli';
    
    if (percent > 80) {
        color = '#ef4444'; // KIRMIZI (Riskli)
        label = 'Yüksek Risk!';
    } else if (percent > 50) {
        color = '#f59e0b'; // TURUNCU (Dikkat)
        label = 'Dikkat';
    }

    // 1. Slider'ın arka planını boya (CSS Gradient)
    // Sadece doluluk oranı kadar boyanır, gerisi koyu kalır
    slider.style.background = `linear-gradient(to right, ${color} 0%, ${color} ${percent}%, #334155 ${percent}%, #334155 100%)`;

    // 2. Slider'ın tutamacına (topuna) renkli gölge ver
    slider.style.boxShadow = `0 0 15px ${color}60`; 

    // 3. Yazıyı güncelle (₺ sembolü ile)
    let display = document.getElementById('sliderValDisplay');
    if (display) {
        // Para birimi sembolü (Varsayılan ₺)
        let sym = (typeof appSettings !== 'undefined' && appSettings.currency === 'TRY') ? '₺' : '$';
        
        // Binlik ayracı ile formatla (Örn: 15.000)
        let formattedMoney = sym + val.toLocaleString(undefined, {maximumFractionDigits: 0});
        
        // HTML olarak yazdır (Renk ve Yazı)
        display.innerHTML = `
            <span style="color:${color}; font-weight:bold; font-size:1.1em;">${formattedMoney}</span>
            <span style="font-size:11px; color:${color}; margin-left:6px; opacity:0.8; text-transform: uppercase; letter-spacing: 0.5px;">${label}</span>
        `;
    }
}

// 5. PORTFÖY DEĞERİ (Risk Hesabı İçin)
function calculateTotalPortfolioValue() {
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let total = 0;
    
    let currentUsd = (typeof usdTryRate !== 'undefined') ? usdTryRate : 36.50;
    let appCurr = (typeof appSettings !== 'undefined') ? appSettings.currency : 'TRY';

    as.forEach(a => {
        let price = a.curr || a.buy;
        let val = 0;
        // Toplam portföy değeri için mecburen APP para birimine çeviriyoruz
        if(appCurr === 'TRY') {
            val = (a.origin === 'USD') ? (price * a.amt * currentUsd) : (price * a.amt);
        } else {
            val = (a.origin === 'TRY') ? ((price * a.amt) / currentUsd) : (price * a.amt);
        }
        total += val;
    });
    return total + (parseFloat(localStorage.getItem('tm_cash_balance')) || 0); 
}


// 6. ANA HESAPLAMA MOTORU (DOLAR/TL AYRIMI YAPAN FİNAL VERSİYON)
function calcAdvAvg(mode) {
    // Girdileri al
    let oldQty = parseFloat(document.getElementById('aaOldQty').value);
    let oldPrice = parseFloat(document.getElementById('aaOldPrice').value);
    let curPrice = parseFloat(document.getElementById('aaCurPrice').value);

    // Seçili varlığın orijinal para birimini bul
    let idx = document.getElementById('advAvgSelect').value;
    let assetOrigin = 'TRY'; // Varsayılan
    if(idx != "-1") {
        let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
        if(as[idx]) assetOrigin = as[idx].origin;
    }

    // Uygulamanın kullandığı para birimi
    let appCurr = (typeof appSettings !== 'undefined') ? appSettings.currency : 'TRY';
    let currentUsd = (typeof usdTryRate !== 'undefined') ? usdTryRate : 36.50;

    // Veri yoksa çık
    if(!oldQty || !oldPrice || !curPrice) {
        if(mode === 'target' && typeof addNotification === 'function') addNotification('warn', 'Eksik Veri', 'Lütfen önce listeden bir varlık seçin.');
        return;
    }

    let qtyToBuy = 0, costToBuy = 0, newAvg = 0;
    let costToBuyInWalletCurrency = 0; // Cüzdandan düşecek tutar (TL ise TL)

    // --- MOD A: BÜTÇE İLE (Param Kadar) ---
    if(mode === 'budget') {
        let budgetInput = parseFloat(document.getElementById('aaBudget').value);
        if(!budgetInput || budgetInput <= 0) {
             document.getElementById('aaResultBox').style.display = 'none';
             document.getElementById('aaRiskAlert').style.display = 'none';
             return;
        }

        // KRİTİK NOKTA: Bütçe "Cüzdan Para Birimi" (TL) cinsinden girilir.
        // Ama hisse Dolar ise, bu bütçeyi Dolara çevirmeliyiz.
        let effectiveBudget = budgetInput;

        if(appCurr === 'TRY' && assetOrigin === 'USD') {
            effectiveBudget = budgetInput / currentUsd; // TL Bütçeyi Dolara çevir
        } else if(appCurr === 'USD' && assetOrigin === 'TRY') {
            effectiveBudget = budgetInput * currentUsd; // USD Bütçeyi TL'ye çevir
        }

        qtyToBuy = effectiveBudget / curPrice; // Adet = Dolar Bütçe / Dolar Fiyat
        costToBuy = effectiveBudget;           // Maliyet (Varlık biriminden)
        costToBuyInWalletCurrency = budgetInput; // Maliyet (Cüzdan biriminden)

        newAvg = ((oldQty * oldPrice) + costToBuy) / (oldQty + qtyToBuy);
    }
    
    // --- MOD B: HEDEF İLE (Ortalamam şu olsun) ---
    else if(mode === 'target') {
        let target = parseFloat(document.getElementById('aaTarget').value);
        if(!target) return;

        // İmkansız hedef kontrolü...
        if ((oldPrice > curPrice && target <= curPrice) || (oldPrice < curPrice && target >= curPrice)) {
            document.getElementById('aaResultBox').style.display = 'none';
            if(typeof addNotification === 'function') addNotification('danger', 'Hata', 'Bu hedef matematiksel olarak imkansız.');
            return;
        }
        
        qtyToBuy = oldQty * (oldPrice - target) / (target - curPrice);
        
        if(qtyToBuy <= 0) { 
            document.getElementById('aaResultBox').style.display = 'none'; 
            return; 
        }
        
        costToBuy = qtyToBuy * curPrice; // Bu maliyet varlık birimindedir ($)
        newAvg = target;

        // Cüzdandan ne kadar TL çıkacak?
        if(appCurr === 'TRY' && assetOrigin === 'USD') {
            costToBuyInWalletCurrency = costToBuy * currentUsd;
        } else if(appCurr === 'USD' && assetOrigin === 'TRY') {
            costToBuyInWalletCurrency = costToBuy / currentUsd;
        } else {
            costToBuyInWalletCurrency = costToBuy;
        }
    }

    // --- RİSK UYARISI ---
    document.getElementById('aaRiskAlert').style.display = 'none';
    if(mode === 'budget') {
        let totalPFValue = calculateTotalPortfolioValue();
        let newAssetTotalValueVal = 0;
        
        let totalValueInAssetCurr = (oldQty + qtyToBuy) * curPrice;
        if(appCurr === 'TRY' && assetOrigin === 'USD') newAssetTotalValueVal = totalValueInAssetCurr * currentUsd;
        else if(appCurr === 'USD' && assetOrigin === 'TRY') newAssetTotalValueVal = totalValueInAssetCurr / currentUsd;
        else newAssetTotalValueVal = totalValueInAssetCurr;

        if(totalPFValue > 0) {
            let concentrationRatio = (newAssetTotalValueVal / totalPFValue) * 100;
            if(concentrationRatio > 40) {
                 document.getElementById('aaRiskMsg').innerHTML = `Dikkat! Bu eklemeyi yaparsan, portföyünün <b>%${concentrationRatio.toFixed(1)}</b> kısmı sadece bu varlıktan oluşacak.`;
                 document.getElementById('aaRiskAlert').style.display = 'flex';
            }
        }
    }

    // --- SONUÇLARI GÖSTER (SİMGE DÜZELTMESİ) ---
    
    // 1. Yeni Ortalama -> Varlığın Kendi Biriminde ($)
    let resultSym = assetOrigin === 'USD' ? '$' : '₺'; 
    
    // 2. Gereken Nakit -> Cüzdan Biriminde (₺)
    let walletSym = appCurr === 'TRY' ? '₺' : '$';     

    let grandTotal = (oldQty * oldPrice) + costToBuy;
    let avgDropPct = ((oldPrice - newAvg) / oldPrice) * 100;
    
    document.getElementById('aaResAvg').innerText = resultSym + newAvg.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:4});
    document.getElementById('aaResOldAvg').innerText = oldPrice.toFixed(2);
    document.getElementById('aaResDiff').innerText = `-%${Math.abs(avgDropPct).toFixed(2)} İyileşme`;
    document.getElementById('aaResQty').innerText = "+" + qtyToBuy.toLocaleString(undefined, {maximumFractionDigits:4});
    
    // GEREKEN NAKİT (Cüzdan Simgesiyle - Önemli!)
    document.getElementById('aaResCost').innerText = walletSym + costToBuyInWalletCurrency.toLocaleString(undefined, {maximumFractionDigits:2});
    
    // Yeni Toplam Maliyet (Varlık Simgesiyle)
    document.getElementById('aaResTotal').innerText = resultSym + grandTotal.toLocaleString(undefined, {maximumFractionDigits:2});

    // Bakiye Kontrolü
    let badge = document.getElementById('aaSavingBadge');
    let cash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
    
    if(costToBuyInWalletCurrency <= cash) {
        badge.innerText = `BAKİYE UYGUN`;
        badge.style.color = "#10b981";
        badge.style.background = "rgba(16,185,129,0.1)";
    } else {
        let missing = costToBuyInWalletCurrency - cash;
        badge.innerText = `EKSİK: ${walletSym}${missing.toLocaleString(undefined, {maximumFractionDigits:0})}`;
        badge.style.color = "#ef4444";
        badge.style.background = "rgba(239,68,68,0.1)";
    }

    document.getElementById('aaResultBox').style.display = 'block';

    if(mode === 'budget') {
        generateDCAStrategy(costToBuy, curPrice, oldQty, oldPrice, resultSym);
        document.getElementById('aaStrategyBox').style.display = 'block';
    } else {
        document.getElementById('aaStrategyBox').style.display = 'none';
    }
}


// 9. KADEMELİ STRATEJİ ÜRETİCİ
function generateDCAStrategy(totalBudget, curPrice, oldQty, oldPrice, symSign) {
    const container = document.getElementById('strategyStepsContainer');
    container.innerHTML = '';

    let budget1 = totalBudget * 0.30;
    let budget2 = totalBudget * 0.30;
    let budget3 = totalBudget * 0.40;

    let price1 = curPrice;
    let price2 = curPrice * 0.95;
    let price3 = curPrice * 0.90; 

    let qty1 = budget1 / price1;
    let avg1 = ((oldQty * oldPrice) + budget1) / (oldQty + qty1);

    let qty2 = budget2 / price2;
    let totalQty2 = oldQty + qty1 + qty2;
    let totalCost2 = (oldQty * oldPrice) + budget1 + budget2;
    let avg2 = totalCost2 / totalQty2;

    let qty3 = budget3 / price3;
    let totalQty3 = totalQty2 + qty3;
    let totalCost3 = totalCost2 + budget3;
    let avg3 = totalCost3 / totalQty3;

    container.innerHTML += createStrategyCard(1, "Hemen Alım (%30)", price1, avg1, budget1, symSign, "#3b82f6");
    container.innerHTML += createStrategyCard(2, "Fiyat %5 Düşerse (%30)", price2, avg2, budget2, symSign, "#f59e0b");
    container.innerHTML += createStrategyCard(3, "Sniper Girişi (-%10) (%40)", price3, avg3, budget3, symSign, "#10b981");
}

function createStrategyCard(step, title, entryPrice, newAvg, cost, sym, color) {
    return `
    <div class="strategy-step-card" style="border-left-color:${color};">
        <div>
            <span class="step-badge" style="color:${color}; background:${color}20;">ADIM ${step}</span>
            <span style="font-weight:700; color:white;">${title}</span>
            <div style="color:var(--text-sub); margin-top:4px;">Giriş Fiyatı: ${entryPrice.toFixed(2)}</div>
        </div>
        <div style="text-align:right;">
            <div style="font-size:9px; color:var(--text-sub);">Yeni Ortalama</div>
            <div style="font-weight:800; font-size:16px; color:${color};">${sym}${newAvg.toFixed(2)}</div>
            <div style="font-size:9px; color:var(--text-sub);">Maliyet: ${sym}${cost.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
        </div>
    </div>`;
}

/* --------------------------------------------------------------------------
   MODÜL 4: STRATEJİ KAYIT VE YÖNETİM SİSTEMİ
   -------------------------------------------------------------------------- */

function saveCurrentScenario() {
    let idx = document.getElementById('advAvgSelect').value;
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let assetName = (idx != "-1" && as[idx]) ? as[idx].name : "Manuel Varlık";

    let newAvg = document.getElementById('aaResAvg').innerText;
    let budget = document.getElementById('aaBudget').value;
    let target = document.getElementById('aaTarget').value;
    let qty = document.getElementById('aaResQty').innerText;
    
    let mode = document.getElementById('avg-mode-budget').style.display !== 'none' ? 'Bütçe' : 'Hedef';
    let mainVal = (mode === 'Bütçe') ? budget : target;

    if(newAvg === "--") return addNotification('warn', 'Hata', 'Önce bir hesaplama yapmalısın.');

    let strategy = {
        id: Date.now(), 
        date: new Date().toLocaleDateString('tr-TR'),
        sym: assetName,
        mode: mode,
        val: mainVal,
        result: newAvg,
        qty: qty
    };

    let saved = JSON.parse(localStorage.getItem('tm_saved_strategies')) || [];
    saved.push(strategy);
    localStorage.setItem('tm_saved_strategies', JSON.stringify(saved));

    addNotification('success', 'Kaydedildi', 'Strateji hafızaya alındı.');
    renderSavedStrategies(); 
}

function renderSavedStrategies() {
    let saved = JSON.parse(localStorage.getItem('tm_saved_strategies')) || [];
    let container = document.getElementById('savedStrategiesList');
    if(!container) return;

    if(saved.length === 0) {
        container.innerHTML = "<div style='text-align:center; font-size:10px; color:var(--text-sub); opacity:0.5; padding:10px;'>Henüz kayıtlı plan yok.</div>";
        return;
    }

    let html = "";
    saved.reverse().forEach(item => {
        let icon = item.mode === 'Bütçe' ? 'fa-wallet' : 'fa-crosshairs';
        let color = item.mode === 'Bütçe' ? '#3b82f6' : '#ef4444';
        
        html += `
        <div style="background:rgba(255,255,255,0.03); border-radius:8px; padding:10px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; border-left:3px solid ${color};">
            <div>
                <div style="font-size:12px; font-weight:700; color:white;">${item.sym} <span style="font-size:9px; color:var(--text-sub); font-weight:400;">(${item.date})</span></div>
                <div style="font-size:10px; color:var(--text-sub); margin-top:2px;">
                    <i class="fas ${icon}" style="color:${color}; margin-right:3px;"></i> 
                    ${item.mode}: <b>${parseFloat(item.val).toLocaleString()}</b> -> Hedef Ort: <b style="color:#fff;">${item.result}</b>
                </div>
            </div>
            <button onclick="deleteStrategy(${item.id})" style="background:none; border:none; color:var(--text-sub); cursor:pointer; padding:5px;">
                <i class="fas fa-trash"></i>
            </button>
        </div>`;
    });

    container.innerHTML = html;
}

function deleteStrategy(id) {
    if(!confirm("Bu planı silmek istiyor musun?")) return;
    let saved = JSON.parse(localStorage.getItem('tm_saved_strategies')) || [];
    let newSaved = saved.filter(x => x.id !== id);
    localStorage.setItem('tm_saved_strategies', JSON.stringify(newSaved));
    renderSavedStrategies();
}

/* --- YENİ DİNAMİK HEDEF VE GÜNLÜK TAKİP SİSTEMİ (FİNAL) --- */

function updateGoalVisuals() {
    let target = parseFloat(localStorage.getItem('tradevia_main_goal')) || 1000000;
    
    // Toplam Varlığı Hesapla (Nakit + Portföy)
    let totalBalance = 0;
    let pf = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let currentUsd = (typeof usdTryRate !== 'undefined') ? usdTryRate : 36.50; 
    let appCurr = (typeof appSettings !== 'undefined') ? appSettings.currency : 'TRY';
    let cash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;

    pf.forEach(item => {
        let p = item.curr || item.buy;
        if(appCurr === 'TRY') {
            totalBalance += (item.origin === 'USD') ? (p * item.amt * currentUsd) : (p * item.amt);
        } else {
            totalBalance += (item.origin === 'TRY') ? ((p * item.amt) / currentUsd) : (p * item.amt);
        }
    });
    totalBalance += cash;

    // Yüzde Hesapla
    let pct = Math.min(100, Math.max(0, (totalBalance / target) * 100));
    let sym = appCurr === 'TRY' ? '₺' : '$';

    // HTML Elementlerini Seç
    const bar = document.getElementById('dynamicGoalBar');
    const currentTextEl = document.getElementById('goalCurrentText');
    const targetTextEl = document.getElementById('goalTargetTextRight');
    
    // Bar ve Yazıları Güncelle
    if(bar && targetTextEl && currentTextEl) {
        // Genişlik
        bar.style.width = pct + "%";
        
        // Renk
        bar.className = 'goal-strip-fill'; 
        if(pct < 33) bar.classList.add('gs-red');
        else if(pct < 66) bar.classList.add('gs-yellow');
        else bar.classList.add('gs-green');

        // Sol Yazı: % ve Mevcut Tutar
        currentTextEl.innerText = `%${pct.toFixed(1)} (${sym}${totalBalance.toLocaleString(undefined, {maximumFractionDigits:0})})`;
        
        // Sağ Yazı: Hedef Tutarı
        targetTextEl.innerText = `HEDEF: ${sym}${target.toLocaleString(undefined, {maximumFractionDigits:0})}`;
    }
    
    // Günlük kayıt sistemini tetikle (Grafik için)
    if(typeof checkAndLogDaily === 'function') {
        checkAndLogDaily(totalBalance); 
    }
}

// 2. Hedef Düzenleme
function editTargetGoal() {
    let current = localStorage.getItem('tradevia_main_goal') || 1000000;
    let val = prompt("Yeni Hedef Tutarınız:", current);
    if(val && !isNaN(val)) {
        localStorage.setItem('tradevia_main_goal', val);
        updateGoalVisuals();
        renderDailyChart(); 
    }
}

// 3. Günlük Kayıt Sistemi (Canlı Takip)
function checkAndLogDaily(currentTotal) {
    let logs = JSON.parse(localStorage.getItem('tm_daily_tracking')) || [];
    let today = new Date().toLocaleDateString('tr-TR');
    
    let lastLog = logs.length > 0 ? logs[logs.length - 1] : null;
    
    if (!lastLog || lastLog.date !== today) {
        logs.push({ date: today, val: currentTotal });
        if(logs.length > 30) logs.shift();
    } else {
        lastLog.val = currentTotal;
    }
    
    localStorage.setItem('tm_daily_tracking', JSON.stringify(logs));
    
    renderDailyList(logs);
    renderDailyChart(logs);
}

// 4. Liste Fonksiyonu (SADECE GÜNLÜK KÂR/ZARAR FARKI)
function renderDailyList(logs) {
    const list = document.getElementById('dailyLogList');
    if(!list) return;
    
    let html = "";
    // Para birimi simgesi
    let sym = (typeof appSettings !== 'undefined' && appSettings.currency === 'TRY') ? '₺' : '$';

    // En iyi ve en kötü gün hesaplama
    let bestDay = { diff: -Infinity, date: '' };
    let worstDay = { diff: Infinity, date: '' };
    let dailyDiffs = [];

    // Önce tüm günlük farkları hesapla
    for (let i = 1; i < logs.length; i++) {
        let diff = logs[i].val - logs[i-1].val;
        dailyDiffs.push({ date: logs[i].date, diff: diff });
        
        if (diff > bestDay.diff) {
            bestDay = { diff: diff, date: logs[i].date };
        }
        if (diff < worstDay.diff) {
            worstDay = { diff: diff, date: logs[i].date };
        }
    }

    // En iyi/kötü gün elementlerini güncelle
    const bestDayEl = document.getElementById('logBestDay');
    const worstDayEl = document.getElementById('logWorstDay');
    const logCountEl = document.getElementById('logEntryCount');
    
    if (bestDayEl) {
        if (bestDay.diff > -Infinity && bestDay.diff > 0) {
            bestDayEl.textContent = '+' + sym + bestDay.diff.toLocaleString(undefined, {maximumFractionDigits:0});
        } else if (bestDay.diff > -Infinity) {
            bestDayEl.textContent = sym + bestDay.diff.toLocaleString(undefined, {maximumFractionDigits:0});
        } else {
            bestDayEl.textContent = '-';
        }
    }
    
    if (worstDayEl) {
        if (worstDay.diff < Infinity) {
            worstDayEl.textContent = sym + worstDay.diff.toLocaleString(undefined, {maximumFractionDigits:0});
        } else {
            worstDayEl.textContent = '-';
        }
    }
    
    if (logCountEl) {
        logCountEl.textContent = logs.length + ' kayıt';
    }

    // Döngüyü tersten kuruyoruz (En yeni tarih en üstte olsun)
    for (let i = logs.length - 1; i >= 0; i--) {
        let currentLog = logs[i];
        
        // Bir önceki günü bul (Eğer i=0 ise yani ilk kayıtsa öncesi yoktur)
        let prevLog = (i > 0) ? logs[i-1] : null; 
        
        let resultHtml = "";
        
        if(prevLog) {
            // BUGÜNKÜ TOPLAM - DÜNKÜ TOPLAM = GÜNLÜK FARK (KÂR/ZARAR)
            let diff = currentLog.val - prevLog.val;
            
            // Renk ve İşaret Ayarı
            let color = diff >= 0 ? '#10b981' : '#ef4444'; // Yeşil veya Kırmızı
            let sign = diff > 0 ? '+' : ''; // Pozitifse + koy, negatifse zaten eksi çıkar
            
            // Ekrana SADECE aradaki farkı basıyoruz (Toplam bakiye görünmez)
            resultHtml = `<span style="color:${color}; font-weight:800; font-size:13px;">${sign}${sym}${diff.toLocaleString(undefined, {maximumFractionDigits:0})}</span>`;
        } else {
            // İlk kayıt ise kıyaslanacak bir dün olmadığı için nötr bırakıyoruz
            resultHtml = `<span style="color:var(--text-sub); font-size:11px; opacity:0.7;">(Başlangıç)</span>`;
        }

        html += `
        <div class="daily-log-row">
            <span class="log-date">${currentLog.date}</span>
            ${resultHtml}
        </div>`;
    }
    
    if(html === "") html = "<div style='text-align:center; padding:15px; color:var(--text-sub); font-size:11px;'>Henüz kayıt yok.</div>";
    list.innerHTML = html;
}

// Sayı Okuma Yardımcısı (Türkçe virgül/nokta sorununu çözer)
function parseTurkishInput(val) {
    if (!val) return 0;
    val = val.toString().trim();
    // Hem nokta hem virgül varsa (Örn: 1.000,50) -> Noktayı sil, virgülü nokta yap
    if (val.includes('.') && val.includes(',')) {
        val = val.replace(/\./g, '').replace(',', '.');
    } 
    // Sadece virgül varsa (Örn: 10,5) -> Virgülü nokta yap
    else if (val.includes(',')) {
        val = val.replace(',', '.');
    }
    return parseFloat(val) || 0;
}


/* --- YENİ PROJEKSİYON BUTONU FONKSİYONU --- */
function manualUpdateVision() {
    // 1. Kutulardaki değerleri al
    const rate = document.getElementById('visionRate').value;
    const add = document.getElementById('visionAdd').value;

    // 2. Hafızaya kaydet (Sayfayı yenileyince gitmesin)
    const settings = { rate: rate, add: add };
    localStorage.setItem('tm_vision_settings', JSON.stringify(settings));

    // 3. Grafiği çizdir (Mevcut fonksiyonu çağırıyoruz)
    if(typeof renderDailyChart === 'function') {
        renderDailyChart();
        addNotification('success', 'Güncellendi', 'Grafik yeni ayarlara göre çizildi.');
    } else {
        alert("Grafik fonksiyonu bulunamadı!");
    }
}

/* --- AYARLARI HATIRLAMASI İÇİN BUNU DA EKLE --- */
// Sayfa açıldığında eski ayarları kutulara geri doldurur
document.addEventListener("DOMContentLoaded", function() {
    const saved = JSON.parse(localStorage.getItem('tm_vision_settings'));
    if(saved) {
        if(document.getElementById('visionRate')) document.getElementById('visionRate').value = saved.rate;
        if(document.getElementById('visionAdd')) document.getElementById('visionAdd').value = saved.add;
    }
});

/* --- KAOS SİMÜLASYON MOTORU --- */
function runChaosSimulation() {
    let scenario = document.getElementById('chaosScenario').value;
    if(scenario === "0") {
        document.getElementById('chaosResult').style.display = 'none';
        return;
    }

    // 1. Mevcut Portföyü Çek
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let cash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
    
    // Anlık Kurları Al (Global değişkenlerden)
    let currentUsd = (typeof usdTryRate !== 'undefined') ? usdTryRate : 36.50;
    let appCurr = (typeof appSettings !== 'undefined') ? appSettings.currency : 'TRY';
    let sym = appCurr === 'TRY' ? '₺' : '$';

    // 2. Senaryo Etkileri (Çarpanlar)
    // 1.0 = Değişim yok, 0.5 = %50 düşüş, 1.5 = %50 artış
    const impacts = {
        'crypto_winter': { crypto: 0.40, bist: 0.90, gold: 1.00, forex: 1.00, cash: 1.00 }, // Kripto %60 erir
        'market_crash':  { crypto: 0.70, bist: 0.65, gold: 1.10, forex: 1.05, cash: 1.00 }, // Borsa %35 çöküş, Altın artar
        'currency_shock':{ crypto: 1.40, bist: 1.20, gold: 1.40, forex: 1.40, cash: 1.00 }, // Dolar bazlı her şey artar (TL kullanıcısı için)
        'gold_rush':     { crypto: 0.90, bist: 0.90, gold: 1.25, forex: 1.00, cash: 1.00 }, // Altın rallisi
        'black_monday':  { crypto: 0.80, bist: 0.80, gold: 0.80, forex: 0.80, cash: 1.00 }  // Nakit hariç her şey düşer
    };

    let selectedImpact = impacts[scenario];
    let currentTotal = 0;
    let simulatedTotal = 0;

    // 3. Hesaplama Döngüsü
    as.forEach(asset => {
        // Varlığın şu anki değerini hesapla
        let price = asset.curr || asset.buy;
        let val = 0;

        if(appCurr === 'TRY') {
            val = (asset.origin === 'USD') ? (price * asset.amt * currentUsd) : (price * asset.amt);
        } else {
            val = (asset.origin === 'TRY') ? ((price * asset.amt) / currentUsd) : (price * asset.amt);
        }
        
        currentTotal += val;

        // Varlığın Türünü Bul (Senaryo için)
        let tagData = getAssetTag(asset.name); // Mevcut fonksiyonunu kullanıyoruz
        let type = 'bist'; // Varsayılan
        
        if(tagData.t === 'KRİPTO') type = 'crypto';
        else if(tagData.t === 'EMTİA') type = 'gold';
        else if(tagData.t === 'DÖVİZ') type = 'forex';
        
        // Simüle edilmiş değer
        let multiplier = selectedImpact[type];
        simulatedTotal += val * multiplier;
    });

    // Nakit Etkisi
    currentTotal += cash;
    simulatedTotal += cash * selectedImpact.cash; // Genelde nakit sabittir ama enflasyon senaryosu eklenebilir

    // 4. Sonuçları Göster
    let diff = simulatedTotal - currentTotal;
    let diffPercent = (currentTotal > 0) ? (diff / currentTotal) * 100 : 0;
    
    // UI Güncelleme
    document.getElementById('chaosBalance').innerText = sym + simulatedTotal.toLocaleString(undefined, {maximumFractionDigits:0});
    
    const bar = document.getElementById('chaosBar');
    const txt = document.getElementById('chaosChangeText');
    const advice = document.getElementById('chaosAdvice');

    if(diff >= 0) {
        bar.style.width = "100%";
        bar.style.background = "#10b981"; // Yeşil
        txt.innerText = `Dayanıklı: +${sym}${diff.toLocaleString(undefined, {maximumFractionDigits:0})} (+%${diffPercent.toFixed(1)})`;
        advice.innerHTML = "Portföyün bu senaryodan <b>kârlı</b> çıkıyor. Kriz fırsata dönüşebilir.";
    } else {
        // Zarar barı hesapla (Görsel olarak %100'den düşür)
        let width = Math.max(10, 100 - Math.abs(diffPercent)); 
        bar.style.width = width + "%";
        bar.style.background = "#ef4444"; // Kırmızı
        txt.innerText = `Erime: ${diffPercent.toFixed(1)}% (${sym}${Math.abs(diff).toLocaleString(undefined, {maximumFractionDigits:0})})`;
        
        // Dinamik Tavsiye
        if(Math.abs(diffPercent) > 30) advice.innerHTML = "<b>KRİTİK RİSK!</b> Bu senaryo gerçekleşirse varlıkların ciddi erir. Nakit veya Altın oranını artırmayı düşün.";
        else advice.innerHTML = "Portföyün darbe alıyor ama hayatta kalır. Risk dağılımını gözden geçir.";
    }

    document.getElementById('chaosResult').style.display = 'block';
}

// --- PSİKOLOJİ ANALİZ MOTORU (İZOLE VE GÜVENLİ) ---
// --- EKSİK OLAN SEKME DEĞİŞTİRME FONKSİYONU ---
function switchPsychoTab(tabName) {
    // 1. Tüm içerik alanlarını gizle
    document.querySelectorAll('.psycho-view').forEach(el => el.classList.remove('active'));
    
    // 2. Tıklanan hedef alanı göster
    const target = document.getElementById(tabName);
    if(target) target.classList.add('active');

    // 3. Tüm butonların aktiflik rengini kaldır
    document.querySelectorAll('.p-tab-btn').forEach(btn => btn.classList.remove('active'));
    
    // 4. Tıklanan butonu aktif yap (renklendir)
    if(event && event.currentTarget) {
        event.currentTarget.classList.add('active');
    }
}

/* --- HIZLANDIRILMIŞ PSİKOLOJİ ANALİZİ (HİSSE SENEDİ DÜZELTMELİ) --- */
async function calcPsychoAnalysis() {

    // 1. VERİ HAZIRLIĞI
    let history = JSON.parse(localStorage.getItem('tm_full_trade_history')) || [];
    
    // Veri yoksa uyar ve çık
    if(history.length === 0) {
        const emptyMsg = '<div style="text-align:center; padding:20px; color:#64748b;">Henüz işlem geçmişi yok.</div>';
        if(document.getElementById('inject-winrate-modern')) document.getElementById('inject-winrate-modern').innerHTML = emptyMsg;
        return;
    }

    // Tarih Sıralaması (Eskiden Yeniye)
    history.sort((a, b) => convertDate(a.date) - convertDate(b.date));

    let sales = history.filter(t => t.type === 'SATIM');
    let buys = history.filter(t => t.type === 'ALIM');

    // ========================================================================
    // BÖLÜM 1: KARNE (İNTERNET GEREKTİRMEZ - ANINDA ÇALIŞIR)
    // ========================================================================
    setTimeout(() => {
        try {
            let winCount = 0, totalPnL = 0;
            sales.forEach(t => {
                let pnl = parseFloat(t.pnl || 0);
                if(pnl > 0) winCount++;
                totalPnL += pnl;
            });

            let winRate = sales.length > 0 ? ((winCount / sales.length) * 100).toFixed(1) : 0;
            let score = 50 + (parseFloat(winRate) - 50);
            if(sales.length > 10) score += 5;
            if(totalPnL > 0) score += 10;
            score = Math.max(0, Math.min(100, score));

            let scoreColor = score >= 70 ? '#10b981' : (score >= 40 ? '#f59e0b' : '#ef4444');
            let scoreText = score >= 70 ? 'Güçlü Psikoloji' : (score >= 40 ? 'Dengeli' : 'Duygusal');

            let htmlKarne = `
                <div style="display:flex; align-items:center; gap:20px; margin-bottom:20px; background:rgba(255,255,255,0.02); padding:15px; border-radius:12px;">
                    <div style="width:70px; height:70px; border-radius:50%; border:4px solid ${scoreColor}; display:flex; align-items:center; justify-content:center; font-size:22px; font-weight:800; color:#fff; box-shadow:0 0 20px ${scoreColor}40;">
                        ${Math.floor(score)}
                    </div>
                    <div>
                        <div style="color:${scoreColor}; font-weight:700; font-size:18px;">${scoreText}</div>
                        <div style="color:#94a3b8; font-size:11px;">Duygusal Skor</div>
                    </div>
                </div>
                <div class="stat-card-modern success">
                    <div><div class="sc-label">BAŞARI ORANI</div><div class="sc-value">%${winRate}</div><div class="sc-sub">${winCount}/${sales.length} Başarılı İşlem</div></div>
                    <i class="fa-solid fa-crosshairs" style="color:#10b981; font-size:24px;"></i>
                </div>
                <div class="stat-card-modern warning">
                    <div><div class="sc-label">REALİZE KÂR</div><div class="sc-value" style="color:${totalPnL>=0?'#10b981':'#ef4444'}">${totalPnL.toLocaleString()}</div></div>
                    <i class="fa-solid fa-coins" style="color:#f59e0b; font-size:24px;"></i>
                </div>`;
            
            if(document.getElementById('inject-winrate-modern')) 
                document.getElementById('inject-winrate-modern').innerHTML = htmlKarne;

        } catch(e) { console.log("Karne hatası:", e); }
    }, 0); 

    // ========================================================================
    // BÖLÜM 2: FOMO & HOLD (İNTERNET GEREKTİRMEZ - ANINDA ÇALIŞIR)
    // ========================================================================
    setTimeout(() => {
        try {
            let panicCount = 0;
            let fomoCount = 0;
            let recentSalesFomo = [...sales].reverse().slice(0, 10);

            for(let t of recentSalesFomo) {
                if(parseFloat(t.pnl) < 0) panicCount++; 
            }

            for(let b of buys) {
                let prevSell = sales.find(s => s.sym === b.sym && convertDate(s.date) < convertDate(b.date));
                if(prevSell) {
                    if(parseFloat(b.price) > parseFloat(prevSell.price) * 1.10) fomoCount++;
                }
            }

            let avgHold = 0;
            window.psychoHoldings = {}; 
            let holdTotalDays = 0;
            let holdCount = 0;
            let safeSales = [...sales].reverse();

            for (let s of safeSales) {
                let relatedBuy = buys.find(b => b.sym === s.sym);
                if (relatedBuy && s.date && relatedBuy.date) {
                    let d1 = convertDate(relatedBuy.date);
                    let d2 = convertDate(s.date);
                    if(d1 && d2) {
                        let diffTime = Math.abs(d2 - d1);
                        let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if(diffDays >= 0 && diffDays < 10000) {
                            holdTotalDays += diffDays;
                            holdCount++;
                            if(!window.psychoHoldings[s.sym]) window.psychoHoldings[s.sym] = [];
                            window.psychoHoldings[s.sym].push({
                                days: diffDays, buyDate: relatedBuy.date, sellDate: s.date,
                                pnl: parseFloat(s.pnl || 0), curr: s.curr || 'TRY'
                            });
                        }
                    }
                }
            }
            if (holdCount > 0) avgHold = Math.round(holdTotalDays / holdCount);

            let holdListHTML = "";
            let sortedAssets = Object.keys(window.psychoHoldings).map(sym => {
                let recs = window.psychoHoldings[sym];
                let avg = recs.reduce((a, b) => a + b.days, 0) / recs.length;
                return { sym: sym, avg: Math.round(avg), count: recs.length };
            }).sort((a, b) => b.avg - a.avg);

            if(sortedAssets.length > 0) {
                holdListHTML = `<div style="margin-top:10px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                    <div style="font-size:9px; color:var(--text-sub); margin-bottom:5px;">DETAY İÇİN VARLIĞA TIKLA 👇</div>`;
                sortedAssets.slice(0, 5).forEach((item, index) => {
                    let badgeColor = item.avg > 30 ? '#10b981' : (item.avg > 7 ? '#3b82f6' : '#f59e0b');
                    holdListHTML += `
                    <div onclick="openHoldDetail('${item.sym}')" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; font-size:11px; background:rgba(255,255,255,0.03); padding:8px; border-radius:8px; cursor:pointer; transition:0.2s;">
                        <div style="display:flex; gap:8px;"><span style="color:#64748b; font-weight:700;">#${index+1}</span><span style="color:white; font-weight:600;">${item.sym}</span></div>
                        <div style="display:flex; gap:6px;"><span style="color:#64748b; font-size:9px;">(${item.count} İşlem)</span><span style="background:${badgeColor}20; color:${badgeColor}; padding:2px 6px; border-radius:4px; font-weight:700;">Ort. ${item.avg} Gün</span></div>
                    </div>`;
                });
                holdListHTML += `</div>`;
            } else {
                holdListHTML = `<div style="text-align:center; color:#64748b; font-size:10px; margin-top:10px;">Veri yok.</div>`;
            }

            let htmlFomo = `
                <div class="stat-card-modern" style="border-left-color:${panicCount>0?'#ef4444':'#8b5cf6'}">
                    <div><div class="sc-label">PANİK SATIŞ</div><div class="sc-value">${panicCount} İşlem</div><div class="sc-sub">Zararına çıkışlar.</div></div>
                    <i class="fa-solid fa-person-falling-burst" style="color:${panicCount>0?'#ef4444':'#8b5cf6'}; font-size:22px;"></i>
                </div>
                <div class="stat-card-modern" style="border-left-color:${fomoCount>0?'#f59e0b':'#ec4899'}">
                    <div><div class="sc-label">FOMO GİRİŞİ</div><div class="sc-value">${fomoCount} İşlem</div><div class="sc-sub">Pahalı geri alımlar.</div></div>
                    <i class="fa-solid fa-rocket" style="color:${fomoCount>0?'#f59e0b':'#ec4899'}; font-size:22px;"></i>
                </div>
                <div class="stat-card-modern" style="border-left-color:#3b82f6; display:block;">
                    <div style="display:flex; justify-content:space-between;">
                        <div><div class="sc-label">GENEL SABIR ORT.</div><div class="sc-value">${avgHold} Gün</div></div>
                        <i class="fa-solid fa-hourglass-half" style="color:#3b82f6; font-size:22px;"></i>
                    </div>
                    ${holdListHTML}
                </div>`;

            if(document.getElementById('inject-fomo-modern')) 
                document.getElementById('inject-fomo-modern').innerHTML = htmlFomo;

        } catch(e) { console.log("FOMO/Hold hatası:", e); }
    }, 0); 

    // ========================================================================
    // BÖLÜM 3: PİŞMANLIK (DÜZELTİLMİŞ FİYAT KONTROLÜ)
    // ========================================================================
    try {
        const regretContainer = document.getElementById('inject-regret-modern');
        if(regretContainer) regretContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#64748b;"><i class="fas fa-circle-notch fa-spin"></i> Piyasa verileri taranıyor...</div>';

        let recentSales = [...sales].reverse().slice(0, 10);
        let regretHTML = "";

        // Bilinen ABD Hisseleri (Bunları 'BORSA' moduna zorlayacağız)
        const usStocks = ['AAPL','TSLA','AMZN','MSFT','GOOGL','META','NVDA','AMD','NFLX','COIN','GME','INTC','PLTR','MSTR','HOOD','BABA'];

        const pricePromises = recentSales.map(async (t) => {
            let currentPrice = 0;
            try { 
                if(typeof getPrice === 'function') {
                    // Sembole göre modu belirle (Hızlandırıcı)
                    let mode = 'CRYPTO'; // Varsayılan
                    
                    // --- DÜZELTME BAŞLANGICI ---
                    let sUpper = t.sym.toUpperCase();
                    if(sUpper.includes('.IS')) mode = 'BORSA';
                    else if(sUpper.includes('USD') || sUpper.includes('EUR') || sUpper === 'ALTIN' || sUpper === 'GRAM') mode = 'BORSA'; 
                    else if(usStocks.includes(sUpper)) mode = 'BORSA'; // <-- ARTIK TSLA'YI BORSA MODUNDA ARAYACAK
                    // --- DÜZELTME BİTİŞİ ---
                    
                    let res = await getPrice(t.sym, mode); 
                    currentPrice = res.price; 
                }
            } catch(e){}
            return { transaction: t, currentPrice: currentPrice };
        });

        const results = await Promise.all(pricePromises);

        for(let item of results) {
            let t = item.transaction;
            let currentPrice = item.currentPrice;
            
            if(currentPrice > 0) {
                let soldPrice = parseFloat(t.price);
                // Eğer satış USD ile yapıldıysa ve sistem TRY ise, farkı doğru hesaplamak gerekir.
                // Basitlik için birim fiyatlar üzerinden gidiyoruz.
                
                let missedProfit = (currentPrice - soldPrice) * t.qty;
                
                // Eğer satış USD, güncel fiyat TRY ise kur dönüşümü gerekir (Basit modda varsayalım aynı)
                // Daha gelişmiş versiyon için t.curr kontrolü yapılabilir.
                
                let isRegret = missedProfit > 0;
                
                let color = isRegret ? 'danger' : 'success';
                let icon = isRegret ? 'fa-face-frown' : 'fa-face-smile-beam';
                let title = isRegret ? 'ERKEN ÇIKIŞ' : 'İYİ Kİ SATMIŞSIN';
                let symSign = t.curr === 'USD' ? '$' : '₺';

                regretHTML += `
                <div class="stat-card-modern ${color}">
                    <div style="width:100%">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <span style="font-weight:700; color:#fff;">${t.sym}</span>
                            <span style="font-size:9px; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px;">${title}</span>
                        </div>
                        <div class="sc-value" style="font-size:13px;">${isRegret?'-':'+'}${symSign}${Math.abs(missedProfit).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} Fark</div>
                        <div class="sc-sub">Satış: ${soldPrice} -> Güncel: ${currentPrice}</div>
                    </div>
                    <i class="fa-regular ${icon}" style="font-size:20px; margin-left:10px;"></i>
                </div>`;
            }
        }
        
        if(regretContainer) 
            regretContainer.innerHTML = regretHTML || '<div style="text-align:center; padding:15px; color:#64748b;">Piyasa verisi alınamadı veya hesaplanacak satış yok.</div>';

    } catch(e) { console.log("Pişmanlık hatası:", e); }
}


// Yardımcı Fonksiyon (Tarih Çevirici)
function convertDate(str) {
    if(!str || typeof str !== 'string' || !str.includes('.')) return null;
    let p = str.split('.');
    if(p.length !== 3) return null;
    return new Date(p[2], p[1]-1, p[0]);
}

/* --- DETAY PENCERESİ VE FONKSİYONU --- */

// 1. Modalı HTML'e ekle (Eğer yoksa)
if (!document.getElementById('holdDetailModal')) {
    let m = document.createElement('div');
    m.id = 'holdDetailModal';
    m.className = 'modal-overlay';
    m.innerHTML = `
        <div class="modal" style="max-height:60vh; overflow-y:auto;">
            <h3 id="hdTitle" style="text-align:center; color:white; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">Detay</h3>
            <div id="hdList" style="display:flex; flex-direction:column; gap:8px;"></div>
            <button class="btn-main btn-sec" style="margin-top:15px;" onclick="document.getElementById('holdDetailModal').style.display='none'">Kapat</button>
        </div>`;
    document.body.appendChild(m);
}

// 2. Detay Açma Fonksiyonu
window.openHoldDetail = function(sym) {
    let records = window.psychoHoldings[sym];
    if(!records) return;

    document.getElementById('hdTitle').innerText = `${sym} - Geçmiş Hareketler`;
    let l = document.getElementById('hdList');
    l.innerHTML = "";

    // Tarihe göre sırala (Yeniden eskiye)
    records.sort((a, b) => convertDate(b.sellDate) - convertDate(a.sellDate));

    records.forEach(r => {
        let color = r.days > 30 ? '#10b981' : (r.days > 7 ? '#3b82f6' : '#f59e0b');
        let pnlColor = r.pnl >= 0 ? '#10b981' : '#ef4444';
        let symSign = r.curr === 'USD' ? '$' : '₺';
        
        let html = `
        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; border-left:3px solid ${color};">
            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                <span style="font-size:12px; font-weight:800; color:${color};">${r.days} GÜN TUTULDU</span>
                <span style="font-size:11px; font-weight:700; color:${pnlColor};">${r.pnl >= 0 ? '+' : ''}${r.pnl.toLocaleString()} ${symSign}</span>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:10px; color:var(--text-sub);">
                <span>Alış: ${r.buyDate}</span>
                <span><i class="fas fa-arrow-right"></i></span>
                <span>Satış: ${r.sellDate}</span>
            </div>
        </div>`;
        l.insertAdjacentHTML('beforeend', html);
    });

    document.getElementById('holdDetailModal').style.display = 'flex';
}

/* --- ZAMAN MAKİNESİ FİNAL MOTORU (AUTO-CURRENCY) --- */

// ABD Enflasyon Verisi (Motor Dolar çalıştığı için ABD verisi şart)
const statCpiData = {
    2025: 2.5, 2024: 3.4, 2023: 3.4, 2022: 6.5, 2021: 7.0, 
    2020: 1.4, 2019: 2.3, 2018: 1.9, 2017: 2.1, 2016: 2.1, 2015: 0.1, 2014: 1.6
};

// 1. ANA TETİKLEYİCİ
async function runStatisticalAnalysis() {
    let rawSymbol = document.getElementById('statSymbol').value.toUpperCase().trim();
    
    
    function openTimeMachine() {
    // EKLENEN KOD: Limit Kontrolü
    if (!Membership.checkTimeMachineLimit()) return; 

    // ... (Aşağıda senin eski kodların devam edecek)
    document.getElementById('tmModal').style.display = 'flex';
    // ...
}

    
    if(!rawSymbol) return addNotification('warn', 'Hata', 'Lütfen bir sembol girin.');

    const resultDiv = document.getElementById('statResult');
    const tableBody = document.getElementById('statTableBody');
    const projList = document.getElementById('projectionList');

    // Temizle ve Yükleniyor Göster
    resultDiv.style.display = 'block';
    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#94a3b8;"><i class="fas fa-circle-notch fa-spin"></i> Veriler analiz ediliyor...</td></tr>';
    projList.innerHTML = '';

    // A PLAN: CoinGecko (Gerçek Market Cap için öncelikli)
    try {
        await tryCoinGecko(rawSymbol);
        addNotification('success', 'Veri', 'CoinGecko üzerinden analiz yapıldı.');
    } catch (cgError) {
        console.warn("CG Hatası:", cgError);
        
        // B PLAN: Binance (Yedek - Market Cap eksik gelir)
        try {
            await tryBinance(rawSymbol);
            addNotification('info', 'Yedek', 'CoinGecko yanıt vermedi, Binance verisi kullanılıyor.');
        } catch (binError) {
            tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px; color:#ef4444;">
                <i class="fas fa-exclamation-triangle"></i> Veri bulunamadı.
            </td></tr>`;
        }
    }
}

// 2. COINGECKO ENTEGRASYONU
async function tryCoinGecko(symbol) {
    let cleanSym = symbol.replace('USDT', '').replace('TRY', '');
    
    // ID Bul
    const searchRes = await fetch(`https://api.coingecko.com/api/v3/search?query=${cleanSym}`);
    if(!searchRes.ok) throw new Error("Arama başarısız");
    const searchData = await searchRes.json();
    
    if(!searchData.coins || searchData.coins.length === 0) throw new Error("Coin yok");
    
    let coinId = searchData.coins[0].id;
    const exactMatch = searchData.coins.find(c => c.symbol.toUpperCase() === cleanSym);
    if(exactMatch) coinId = exactMatch.id;

    // Tarihçe Çek (Dolar bazlı gelir)
    const historyRes = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=max&interval=daily`);
    const data = await historyRes.json();

    if(!data.prices || data.prices.length === 0) throw new Error("Fiyat verisi yok");

    processAndRenderCompact(data.prices, data.market_caps, data.total_volumes); 
}

// 3. BINANCE ENTEGRASYONU
async function tryBinance(symbol) {
    let binSymbol = symbol.endsWith('USDT') ? symbol : symbol + 'USDT';
    
    const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${binSymbol}&interval=1M&limit=120`);
    if (!response.ok) throw new Error("Binance başarısız");
    const data = await response.json();

    let prices = data.map(d => [d[0], parseFloat(d[4])]); 
    let volumes = data.map(d => [d[0], parseFloat(d[7])]); 
    let mcaps = null; // Binance mcap vermez

    processAndRenderCompact(prices, mcaps, volumes);
}

/* --- HİBRİT MOTOR: FULL VERİ SETİ (MCAP + DEĞİŞİM EKLENDİ) --- */
function processAndRenderCompact(priceData, mcapData, volData) {
    const tableBody = document.getElementById('statTableBody');
    const projList = document.getElementById('projectionList');
    
    let isTR = (typeof appSettings !== 'undefined' && appSettings.currency === 'TRY');
    let currencyRate = (typeof usdTryRate !== 'undefined') ? usdTryRate : 36.50;
    let sym = isTR ? '₺' : '$';

    let yearlyStats = {};
    let dailyChanges = []; 

    // --- 1. VERİ İŞLEME ---
    for(let i=0; i<priceData.length; i++) {
        let timestamp = priceData[i][0];
        let priceUSD = priceData[i][1]; 
        let mcapUSD = (mcapData && mcapData[i]) ? mcapData[i][1] : 0;
        let volUSD = (volData && volData[i]) ? volData[i][1] : 0;
        
        if(i > 0) {
            let prevPrice = priceData[i-1][1];
            dailyChanges.push(((priceUSD - prevPrice) / prevPrice) * 100);
        }

        let year = new Date(timestamp).getFullYear();
        if(!yearlyStats[year]) {
            yearlyStats[year] = { 
                close: priceUSD, high: priceUSD, low: priceUSD, 
                mcap: mcapUSD, vol: volUSD, volCount: 1, lastDate: timestamp 
            };
        } else {
            if(priceUSD > yearlyStats[year].high) yearlyStats[year].high = priceUSD;
            if(priceUSD < yearlyStats[year].low) yearlyStats[year].low = priceUSD;
            
            yearlyStats[year].vol += volUSD;
            yearlyStats[year].volCount++;

            if(timestamp > yearlyStats[year].lastDate) {
                yearlyStats[year].close = priceUSD;
                yearlyStats[year].mcap = mcapUSD;
                yearlyStats[year].lastDate = timestamp;
            }
        }
    }

    // --- 2. ANOMALİ VE RİSK ---
    let mean = dailyChanges.reduce((a,b)=>a+b, 0) / dailyChanges.length;
    let variance = dailyChanges.reduce((a,b)=>a + Math.pow(b-mean, 2), 0) / dailyChanges.length;
    let stdDev = Math.sqrt(variance); 

    let shockThreshold = stdDev * 2; 
    let crashEvents = dailyChanges.filter(c => c < -shockThreshold).length;
    let pumpEvents = dailyChanges.filter(c => c > shockThreshold).length;

    // UI: Risk İbresi
    let riskAngle = -90;
    let riskLabel = "DÜŞÜK";
    let riskColor = "#10b981";
    if(stdDev > 5) { riskAngle = 90; riskLabel = "AŞIRI"; riskColor = "#ef4444"; }
    else if(stdDev > 3) { riskAngle = 45; riskLabel = "YÜKSEK"; riskColor = "#f59e0b"; }
    else if(stdDev > 1.5) { riskAngle = 0; riskLabel = "ORTA"; riskColor = "#3b82f6"; }
    else { riskAngle = -45; }

    document.getElementById('gaugeRiskNeedle').style.transform = `rotate(${riskAngle}deg)`;
    document.getElementById('gaugeRiskText').innerText = riskLabel;
    document.getElementById('gaugeRiskText').style.color = riskColor;

    // --- 3. TABLO ÇİZİMİ (MCAP ve DEĞİŞİM EKLENDİ) ---
    let years = Object.keys(yearlyStats).sort((a,b) => b-a);
    let htmlTable = "";
    let pullbacks = []; 
    let volumeTrend = [];

    // Enflasyon Verisi (Dolar Bazlı)
    const cpiData = { 2025: 2.5, 2024: 3.4, 2023: 3.4, 2022: 6.5, 2021: 7.0, 2020: 1.4, 2019: 2.3 };

    for (let i = 0; i < years.length - 1; i++) {
        let y = years[i];
        let yPrev = years[i+1];
        let curr = yearlyStats[y];
        let prev = yearlyStats[yPrev];
        
        let avgVol = curr.vol / curr.volCount;
        curr.avgVol = avgVol; 
        volumeTrend.push(avgVol);

        let changePct = ((curr.close - prev.close) / prev.close) * 100;
        let yearlyDrawdown = ((curr.high - curr.low) / curr.high); 
        pullbacks.push(yearlyDrawdown);

        // Reel Getiri Hesabı
        let inf = cpiData[y] || 2.5;
        let realReturn = changePct - inf;
        let realColor = realReturn >= 0 ? '#10b981' : '#ef4444';

        let displayClose = isTR ? curr.close * currencyRate : curr.close;
        let displayHigh = isTR ? curr.high * currencyRate : curr.high;
        let displayLow = isTR ? curr.low * currencyRate : curr.low;
        
        // Milyar/Milyon Formatlama
        let mcapStr = (curr.mcap > 1e9) ? (curr.mcap/1e9).toFixed(1)+"Mr" : (curr.mcap/1e6).toFixed(1)+"Mn";
        let volStr = (avgVol > 1e9) ? (avgVol/1e9).toFixed(1)+"Mr" : (avgVol/1e6).toFixed(1)+"Mn";

        htmlTable += `
        <tr style="border-bottom:1px solid rgba(255,255,255,0.05); font-size:11px;">
            <td style="padding:8px; font-weight:700; color:#a78bfa;">${y}</td>
            <td style="padding:8px; color:white; font-weight:700;">${sym}${displayClose.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
            <td style="padding:8px; color:#10b981;">${sym}${parseInt(displayHigh).toLocaleString()}</td>
            <td style="padding:8px; color:#ef4444;">${sym}${parseInt(displayLow).toLocaleString()}</td>
            <td style="padding:8px; color:#f59e0b; font-weight:700;">${mcapStr}</td> <td style="padding:8px; color:#38bdf8;">${volStr}</td>
            <td style="padding:8px; color:${realColor}; font-weight:800;">%${realReturn.toFixed(0)}</td> </tr>`;
    }
    tableBody.innerHTML = htmlTable;

    // --- 4. HACİM UI GÜNCELLEME ---
    let volumeSentiment = 1.0; 
    let volAngle = -90;
    let volText = "NÖTR";
    let volColor = "#94a3b8";

    if(volumeTrend.length >= 3) {
        let recentVol = (volumeTrend[0] + volumeTrend[1]) / 2; 
        let pastVol = 0;
        for(let k=2; k<volumeTrend.length; k++) pastVol += volumeTrend[k];
        pastVol = pastVol / (volumeTrend.length - 2); 

        if(pastVol > 0) {
            let ratio = recentVol / pastVol;
            if(ratio > 1.5) { 
                volumeSentiment = 1.15; volAngle = 60; volText = "YÜKSEK"; volColor = "#d946ef"; 
            } else if(ratio < 0.5) { 
                volumeSentiment = 0.85; volAngle = -60; volText = "DÜŞÜK"; volColor = "#64748b"; 
            } else if(ratio >= 0.8 && ratio <= 1.2) { 
                volumeSentiment = 1.05; volAngle = 0; volText = "STABİL"; volColor = "#3b82f6"; 
            }
        }
    }
    document.getElementById('gaugeVolNeedle').style.transform = `rotate(${volAngle}deg)`;
    document.getElementById('gaugeVolText').innerText = volText;
    document.getElementById('gaugeVolText').style.color = volColor;

    // --- 5. GELECEK TAHMİNİ ---
    let lastData = yearlyStats[years[0]]; 
    let firstData = yearlyStats[years[years.length-1]]; 
    let totalYears = years.length;
    
    let avgPullback = 0.20; 
    if(pullbacks.length > 0) avgPullback = pullbacks.reduce((a, b) => a + b, 0) / pullbacks.length;
    if(avgPullback > 0.60) avgPullback = 0.60; 

    let cagr = 5; 
    if(firstData && lastData && firstData.close > 0) {
        cagr = (Math.pow((lastData.close / firstData.close), (1 / totalYears)) - 1) * 100;
    }

    if(lastData.mcap > 500000000000) cagr *= 0.60; 
    else if(lastData.mcap > 50000000000) cagr *= 0.80; 
    
    cagr = cagr * volumeSentiment;
    if(cagr > 80) cagr = 60 + (cagr - 60) * 0.1; 
    if(cagr < 5) cagr = 5; 

    let avgGrowth = cagr;

    // --- 6. TIMELINE ---
    let warningHtml = `
    <div style="background:rgba(239,68,68,0.1); border:1px dashed rgba(239,68,68,0.3); padding:8px; border-radius:8px; font-size:10px; color:#fca5a5; margin-bottom:15px; margin-left:10px;">
        <i class="fas fa-exclamation-circle"></i> <b>Sapma Uyarısı:</b> Geçmişte ${crashEvents} kez çöküş, ${pumpEvents} kez fırlama (Anomali) tespit edildi.
    </div>`;
    projList.innerHTML = warningHtml;

    let basePriceUSD = lastData.close;
    let currentYear = new Date().getFullYear();
    let projHTML = "";

    for(let j=1; j<=5; j++) {
        let fYear = currentYear + j;
        let decay = 1 - (j * 0.10); 
        if(decay < 0.4) decay = 0.4; 

        let yearlyGrowth = avgGrowth * decay;
        basePriceUSD = basePriceUSD * (1 + (yearlyGrowth/100));
        
        let highPriceUSD = basePriceUSD * (1 + avgPullback/1.5);
        let lowPriceUSD = basePriceUSD * (1 - avgPullback);

        let displayBase = isTR ? basePriceUSD * currencyRate : basePriceUSD;
        let displayHigh = isTR ? highPriceUSD * currencyRate : highPriceUSD;
        let displayLow = isTR ? lowPriceUSD * currencyRate : lowPriceUSD;

        projHTML += `
        <div style="position:relative; margin-bottom:20px;">
            <div style="position:absolute; left:-26px; top:15px; width:12px; height:12px; background:#d8b4fe; border-radius:50%; box-shadow:0 0 10px #8b5cf6;"></div>
            
            <div class="lab-glass-card" style="margin:0; padding:12px; background:linear-gradient(90deg, rgba(139,92,246,0.1), transparent); border-left:3px solid #d8b4fe;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <div style="font-size:14px; font-weight:800; color:#fff;">${fYear}</div>
                    <div style="font-size:10px; color:#a78bfa; background:rgba(167,139,250,0.1); padding:2px 8px; border-radius:10px;">Beklenti</div>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-size:9px; color:#10b981;">ZİRVE</div>
                        <div style="font-size:11px; font-weight:700; color:#fff;">${sym}${parseInt(displayHigh).toLocaleString()}</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:9px; color:#facc15;">MERKEZ</div>
                        <div style="font-size:14px; font-weight:900; color:#facc15; text-shadow:0 0 10px rgba(250,204,21,0.3);">${sym}${parseInt(displayBase).toLocaleString()}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:9px; color:#ef4444;">DİP</div>
                        <div style="font-size:11px; font-weight:700; color:#fff;">${sym}${parseInt(displayLow).toLocaleString()}</div>
                    </div>
                </div>
            </div>
        </div>`;
    }
    projList.insertAdjacentHTML('beforeend', projHTML);
}

/* --- BÜYÜME (STRATEJİ TESTİ) HESAPLAMA MOTORU --- */
function runLabTest() {
    // 1. Girdileri Al
    let startBal = parseFloat(document.getElementById('labStart').value);
    let winPct = parseFloat(document.getElementById('labWinPct').value);
    let freq = parseFloat(document.getElementById('labFreq').value);
    let duration = parseFloat(document.getElementById('labDuration').value);

    // 2. Kontrol Et
    if (isNaN(startBal) || isNaN(winPct) || isNaN(freq) || isNaN(duration)) {
        alert("Lütfen tüm alanları doldurunuz.");
        return;
    }

    // 3. Hesaplama (Bileşik Getiri Formülü)
    let totalTrades = freq * 4 * duration; // Haftalık işlem sayısını aya çevir
    let finalBal = startBal;
    let labList = [];

    for (let m = 1; m <= duration; m++) {
        // Her ay içindeki işlemlerin kümülatif etkisi
        for (let t = 1; t <= (freq * 4); t++) {
            finalBal = finalBal * (1 + (winPct / 100));
        }
        
        // Aylık raporu listeye ekle
        labList.push({
            month: m,
            balance: finalBal,
            profit: finalBal - startBal
        });
    }

    // 4. UI Güncelleme (Sonuçları Göster)
    document.getElementById('labResults').style.display = 'block';
    document.getElementById('resLabStart').innerText = startBal.toLocaleString() + " ₺";
    document.getElementById('resLabEnd').innerText = Math.round(finalBal).toLocaleString() + " ₺";
    
    let growth = ((finalBal - startBal) / startBal) * 100;
    document.getElementById('resLabGrowth').innerText = "%" + growth.toFixed(0);

    // 5. Aylık İlerleme Listesini Çiz
    let container = document.getElementById('labListContainer');
    container.innerHTML = "";
    labList.forEach(item => {
        container.innerHTML += `
            <div class="lab-row">
                <div class="lab-col-left">
                    <span class="lab-month-badge">${item.month}. AY</span>
                    <span class="lab-balance-val">${Math.round(item.balance).toLocaleString()} ₺</span>
                </div>
                <div class="lab-col-right">
                    <span class="lab-profit-lbl">TOPLAM KÂR</span>
                    <span class="lab-profit-val">+${Math.round(item.profit).toLocaleString()} ₺</span>
                </div>
            </div>`;
    });
}

/**
 * GELİŞMİŞ TRADER DNA ANALİZİ v2.0
 * --------------------------------
 * Kullanıcının sadece cüzdanını değil, psikolojisini de analiz eder.
 * @param {Array} history - Geçmiş işlemler listesi (Tarih sıralı: En yeni en başta)
 * @param {Number} currentBalance - Anlık güncel bakiye
 */
function analyzeTraderDNA(history, currentBalance) {
    // 1. VERİ KONTROLÜ
    if (!history || history.length < 5) {
        return {
            type: " Hayalet (Veri Yok)",
            color: "#9ca3af", // Gri
            riskAdvice: 2, 
            msg: "Seni henüz tanımıyorum. Standart prosedür uyguluyorum."
        };
    }

    const lastTx = history[0]; // En son yapılan işlem
    const now = new Date().getTime(); // Şu anki zaman
    const timeDiff = now - lastTx.closeTime; // Son işlemden bu yana geçen süre (ms)
    
    // İşlem istatistiklerini hazırla
    const wins = history.filter(t => t.pnl > 0);
    const losses = history.filter(t => t.pnl < 0);
    const winRate = (wins.length / history.length) * 100;
    
    // Ortalama Kazanç ve Kayıp Hesapla (Paper Hands analizi için)
    const avgWin = wins.length ? wins.reduce((a, t) => a + t.pnl, 0) / wins.length : 0;
    const avgLoss = losses.length ? Math.abs(losses.reduce((a, t) => a + t.pnl, 0) / losses.length) : 0;

    // Ortalama Pozisyon Büyüklüğü (All-In analizi için)
    const avgSize = history.reduce((a, t) => a + (t.amount || 0), 0) / history.length;

    // Ortalama İşlem Süresi (Sabır analizi için)
    const avgDuration = history.reduce((a, t) => a + (t.closeTime - t.openTime), 0) / history.length;


    // --- [KRİTİK PSİKOLOJİ KONTROLLERİ] ---

    // 1. İNTİKAM TİCARETİ (REVENGE TRADING)
    // Kural: Son işlem zarar ise VE üzerinden 15 dakika geçmeden yeni işlem aranıyorsa
    if (lastTx.pnl < 0 && timeDiff < 15 * 60 * 1000) {
        return {
            type: "🤬 Tilt Modu (İntikam)",
            color: "#ef4444", // Kırmızı
            riskAdvice: 0.1, // İşlemi neredeyse engelle
            msg: "DUR! Zarardan hemen sonra işlem açmaya çalışıyorsun. Beynin değil hırsın konuşuyor. Git bir kahve iç."
        };
    }

    // 2. ZAFER SARHOŞLUĞU (FOMO / OVERCONFIDENCE)
    // Kural: Son işlem büyük bir kazançsa (%10+) VE hemen (10 dk) yeni işlem aranıyorsa
    if (lastTx.pnl > currentBalance * 0.10 && timeDiff < 10 * 60 * 1000) {
        return {
            type: "🎉 Zafer Sarhoşluğu",
            color: "#8b5cf6", // Mor
            riskAdvice: 1.0, // Riski düşür
            msg: "Büyük kazandın, tebrikler. Ama özgüven zehirlenmesi yaşama. Şu an hata yapmaya çok müsaitsin."
        };
    }

    // 3. ALL-IN HASTALIĞI (GAMBLER)
    // Kural: Ortalama işlem büyüklüğü kasanın %60'ından fazlaysa
    if (avgSize > currentBalance * 0.60) {
        return {
            type: "🎰 Kumarbaz (All-In)",
            color: "#b91c1c", // Koyu Kırmızı
            riskAdvice: 0.5,
            msg: "Bakiyenin yarısından fazlasını tek işleme bağlıyorsun. Bu yatırım değil, Rus Ruleti."
        };
    }

    // 4. KAĞIT ELLER (PAPER HANDS) - Eklediğim Özellik
    // Kural: Ortalama Zarar, Ortalama Kazancın 2 katıysa (Risk:Reward bozuk)
    if (losses.length > 0 && avgLoss > avgWin * 2) {
        return {
            type: "🧻 Paper Hands",
            color: "#f59e0b", // Turuncu
            riskAdvice: 1.0,
            msg: `Kazançları erken kesip zararları büyütüyorsun (R:R Bozuk). Kârda beklemeyi öğrenmelisin.`
        };
    }

    // --- [KARAKTER ANALİZİ & SONUÇ] ---
    
    // Trader Türünü Belirle
    let traderStyle = "Day Trader";
    if (avgDuration < 60 * 60 * 1000) traderStyle = "⚡ Scalper"; // 1 saat altı
    if (avgDuration > 24 * 60 * 60 * 1000) traderStyle = "🐢 Swing Trader"; // 24 saat üstü

    // Nihai Karar
    if (winRate > 60) {
        return {
            type: `💎 Usta ${traderStyle}`,
            color: "#10b981", // Yeşil
            riskAdvice: 3.0, // Ödül modu
            msg: `Piyasa ile uyumun harika. ${traderStyle} stilinde çok başarılısın. Elini korkak alıştırma.`
        };
    } else if (winRate < 40) {
        return {
            type: "Öğrenci Modu",
            color: "#f97316", // Turuncu
            riskAdvice: 1.0, // Korumacı
            msg: "Piyasa şu an seni zorluyor. Defansif kal, hacmi düşür ve öğrenmeye odaklan."
        };
    }

    // Standart
    return {
        type: "⚖️ Dengeli Trader",
        color: "#3b82f6", // Mavi
        riskAdvice: 2.0,
        msg: "Her şey kontrol altında. Stratejine ve planına sadık kal."
    };
}


// 📰 CANLI HABER MERKEZİ (OTOMATİK YENİLEME:// 
    setInterval(() => {
    if(window.newsService && typeof window.newsService.fetchDualNews === 'function') {
        let currentCat = window.newsService.currentCategory || 'manset';
        window.newsService.fetchDualNews(currentCat, null);
    }
}, 300000);

/* --- GLOBAL NAVİGASYON, ÜST BAR VE VERİ YENİLEME MODÜLÜ (FİNAL V4 - PİYASA EKLENDİ) --- */

document.addEventListener("DOMContentLoaded", () => {
    
    // 1. Orijinal Fonksiyonların Yedeğini Al
    if (!window.originalSwitchPageRef) window.originalSwitchPageRef = window.switchPage || function(){};
    if (!window.originalSwitchAnTabRef) window.originalSwitchAnTabRef = window.switchAnTab || function(){};

    const originalSwitchPage = window.originalSwitchPageRef;
    const originalSwitchAnTab = window.originalSwitchAnTabRef;

    // 2. Analiz Verilerini Tazeleme Motoru
    function refreshAnalysisData() {
        const visionTab = document.getElementById('an-view-vision');
        if (visionTab && visionTab.style.display !== 'none') {
            if(typeof window.loadVisionData === 'function') window.loadVisionData();
            if(typeof window.renderDailyChart === 'function') window.renderDailyChart();
            if(typeof window.updateGoalVisuals === 'function') window.updateGoalVisuals();
        }
    }

    // 3. MERKEZİ KONTROL: Üst Bar Görünmeli mi?
    function updateTopBarState(targetPageId = null) {
        const topBar = document.querySelector('.top-bar'); 
        if (!topBar) return;

        let activePageID = targetPageId;
        if (!activePageID) {
            const activePage = document.querySelector('.page.active');
            activePageID = activePage ? activePage.id : '';
        }

        let cleanID = activePageID;
        if (cleanID && !cleanID.startsWith('page-')) {
            cleanID = 'page-' + cleanID;
        }

        /* --- KURAL SETİ (GÜNCELLENDİ) --- */
        
        // KURAL 1: Piyasa, Ayarlar veya Haberler ise KESİN GİZLE
        if (cleanID === '' || cleanID === 'page-settings' || cleanID === 'page-news') {
            topBar.style.setProperty('display', 'none', 'important');
        }
        // KURAL 2: Analiz sayfası ise ve Alt Modüller (Lab/Vision) açıksa GİZLE
        else if (cleanID === 'page-analysis') {
            const isLabActive = document.getElementById('an-view-lab') && document.getElementById('an-view-lab').style.display !== 'none';
            const isVisionActive = document.getElementById('an-view-vision') && document.getElementById('an-view-vision').style.display !== 'none';
            
            if (isLabActive || isVisionActive) {
                topBar.style.setProperty('display', 'none', 'important');
            } else {
                topBar.style.setProperty('display', 'flex', 'important');
            }
        } 
        // KURAL 3: Diğer durumlarda (Cüzdan vb.) GÖSTER
        else {
            topBar.style.setProperty('display', 'flex', 'important');
        }
    }

    // 4. Alt Navigasyon (SwitchPage) Sarmalayıcısı
    window.switchPage = function(pageId, btn) {
        originalSwitchPage(pageId, btn);
        
        // 1. Bar durumunu güncelle
        updateTopBarState(pageId);

        // 2. Analiz sayfasına dönüldüyse verileri tazele
        if (pageId === 'analysis' || pageId === 'page-analysis') {
            setTimeout(refreshAnalysisData, 50); 
        }
        
        // 3. Analiz sayfası dışına çıkıldığında Lab sonuçlarını temizle
        if (pageId !== 'analysis' && pageId !== 'page-analysis') {
            if (typeof resetAllLabResults === 'function') {
                resetAllLabResults();
            }
        }
    };

    // 5. Analiz İçi Sekme (SwitchAnTab) Sarmalayıcısı
    window.switchAnTab = function(tab, btn) {
        originalSwitchAnTab(tab, btn);
        updateTopBarState(); // Sekme değişince barı kontrol et
        
        // Lab sekmesinden çıkıldığında sonuçları temizle
        if (tab !== 'lab' && typeof resetAllLabResults === 'function') {
            resetAllLabResults();
        }
    };

    // 6. Kapatma Helper'ı
    function closeOverlayAndReset(elementId) {
        const el = document.getElementById(elementId);
        if (el) {
            el.style.display = 'none';
            el.classList.remove('active');
        }
        
        // Lab sonuçlarını temizle
        if (typeof resetAllLabResults === 'function') {
            resetAllLabResults();
        }
        
        // Varsayılan sekmeye (Performans) dön
        const perfBtn = document.querySelector(".s-tab.seg-style"); 
        if (perfBtn) {
            document.querySelectorAll('.s-tab').forEach(t => t.classList.remove('active'));
            perfBtn.classList.add('active');
            if(typeof window.switchAnTab === 'function') {
                 originalSwitchAnTab('perf', perfBtn);
            }
        }
        // Kapatınca bar durumunu güncelle
        setTimeout(() => updateTopBarState('page-analysis'), 50);
    }

    window.closeLabView = function() {
        closeOverlayAndReset('an-view-lab');
    };

    window.closeVisionView = function() {
        closeOverlayAndReset('an-view-vision');
    };
    
    // Açılışta kontrol et (Direkt Piyasa sayfası açılırsa diye)
    setTimeout(() => {
        const active = document.querySelector('.page.active');
        if(active) updateTopBarState(active.id);
    }, 100);
});

/* ======================================================
   DOLAR/TL UYUMLU RISK HESAPLAYICI & ÜST BAR YÖNETİMİ
   ====================================================== */

/* 1. RİSK HESAPLAMA MOTORU */
window.calcLabRisk = function() {
    // A) Sayı Okuma Yardımcısı (Türkçe/İngilizce uyumlu)
    function parseNum(val) {
        if (!val) return 0;
        val = val.toString().trim();
        // 1.000,50 formatı (TR) -> 1000.50
        if (val.includes('.') && val.includes(',')) {
            val = val.replace(/\./g, '').replace(',', '.');
        } 
        // 10,5 formatı (TR) -> 10.5
        else if (val.includes(',')) {
            val = val.replace(',', '.');
        }
        return parseFloat(val) || 0;
    }

    // B) Değerleri Al
    let balance = parseNum(document.getElementById('riskBalance').value);
    let riskPct = parseNum(document.getElementById('riskPct').value);
    let entry = parseNum(document.getElementById('riskEntry').value);
    let stop = parseNum(document.getElementById('riskStop').value);

    // C) Hata Kontrolleri
    if (balance <= 0) return alert("Lütfen Kasa Bakiyesini girin.");
    if (entry <= 0 || stop <= 0) return alert("Fiyatlar 0 olamaz.");
    if (entry === stop) return alert("Giriş ve Stop fiyatı aynı olamaz.");

    // D) Hesaplama
    let riskAmount = balance * (riskPct / 100); // Riske edilen para
    let diff = Math.abs(entry - stop);          // Birim başına fark
    let qty = riskAmount / diff;                // Adet
    let totalSize = qty * entry;                // Toplam Pozisyon Büyüklüğü

    // E) PARA BİRİMİ TESPİTİ (ÖNEMLİ DÜZELTME BURADA)
    let sym = '₺'; // Varsayılan TL
    let currencyCode = 'TRY';

    // 1. appSettings kontrolü
    if (typeof appSettings !== 'undefined' && appSettings.currency) {
        if (appSettings.currency === 'USD') {
            sym = '$';
            currencyCode = 'USD';
        }
    } 
    // 2. HTML dilinden yedek kontrol
    else if (document.documentElement.lang === 'en') {
        sym = '$';
        currencyCode = 'USD';
    }

    // F) Sonuçları Ekrana Yazdır (Para birimine uygun formatta)
    // Adet (Lot) her zaman düz sayıdır
    document.getElementById('resRiskQty').innerText = qty.toLocaleString('tr-TR', {maximumFractionDigits: 4});
    
    // Para değerleri
    document.getElementById('resRiskLoss').innerText = "-" + sym + riskAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    document.getElementById('resPosSize').innerText = sym + totalSize.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

    // Alt Bilgi
    let ratio = (totalSize / balance) * 100;
    let ratioText = document.getElementById('riskRatioText');
    if(ratioText) {
        ratioText.innerHTML = `Bu işlem kasanın <b>%${ratio.toFixed(1)}</b> kadarını kullanır.`;
    }

    // Sonuç kutusunu aç
    document.getElementById('riskResultBox').style.display = 'block';
};

/* 2. ÜST BAR YÖNETİMİ (KARIŞIKLIK ÖNLEYİCİ) */
window.switchAnTab = function(tab, btn) {
    // Sekmeleri yönet
    document.querySelectorAll('.an-view-section').forEach(el => el.style.display = 'none');
    const target = document.getElementById('an-view-' + tab);
    if(target) target.style.display = 'block';
    
    // Buton aktifliği
    document.querySelectorAll('.s-tab').forEach(el => el.classList.remove('active'));
    if(btn) btn.classList.add('active');

    // --- BAR GİZLEME OPERASYONU ---
    // Eğer HTML'e id="mainTopBar" eklediysen onu kullanır, yoksa ilk .top-bar'ı bulur
    const mainBar = document.getElementById('mainTopBar') || document.querySelector('.top-bar'); 
    
    if (mainBar) {
        // Arge veya Hedefler açılırsa ANA BARI GİZLE (Kendi barları görünsün diye)
        if (tab === 'lab' || tab === 'vision') {
            mainBar.style.setProperty('display', 'none', 'important');
        } else {
            // Diğerlerinde ANA BARI GERİ GETİR
            mainBar.style.setProperty('display', 'flex', 'important');
        }
    }

    // Veri yükleyiciler
    if(tab === 'vision' && typeof loadVisionData === 'function') loadVisionData();
    if(tab === 'lab' && typeof populateRiskAssets === 'function') populateRiskAssets();
};

/* 3. ÇIKIŞ FONKSİYONLARI */
window.closeLabView = function() {
    document.getElementById('an-view-lab').style.display = 'none';
    
    const mainBar = document.getElementById('mainTopBar') || document.querySelector('.top-bar');
    if(mainBar) mainBar.style.setProperty('display', 'flex', 'important');
    
    const perfBtn = document.querySelector(".s-tab[onclick*='perf']");
    if(perfBtn) window.switchAnTab('perf', perfBtn);
};

window.closeVisionView = function() {
    document.getElementById('an-view-vision').style.display = 'none';
    
    const mainBar = document.getElementById('mainTopBar') || document.querySelector('.top-bar');
    if(mainBar) mainBar.style.setProperty('display', 'flex', 'important');
    
    const perfBtn = document.querySelector(".s-tab[onclick*='perf']");
    if(perfBtn) window.switchAnTab('perf', perfBtn);
};

/* --- NAVİGASYON RENK ZORLAYICI (SOFT DARK MOD) --- */

function forceNavColor() {
    const nav = document.querySelector('.nav-container');
    const settingsPage = document.getElementById('page-settings');
    
    if (!nav || !settingsPage) return;

    // Ayarlar sayfası açık mı?
    const isSettingsOpen = settingsPage.classList.contains('active') || 
                           settingsPage.style.display === 'flex' || 
                           settingsPage.style.display === 'block';

    if (isSettingsOpen) {
        // === AYARLAR MODU (YUMUŞAK KOYU & GOLD) ===
        
        // 1. Arka Plan: Simsiyah (5,5,5) yerine "Koyu Gri/Antrasit" (20,20,25) yaptık.
        // Şeffaflığı 0.90 yaptık ki cam efekti belli olsun.
        nav.style.setProperty('background', 'rgba(20, 20, 25, 0.95)', 'important');
        
        // 2. Çizgi: Gold rengini koruduk ama biraz incelttik.
        nav.style.setProperty('border-top', '1px solid rgba(245, 158, 11, 0.2)', 'important');
        
        // 3. Gölge: Daha hafif bir altın ışıltısı.
        nav.style.setProperty('box-shadow', '0 -5px 30px rgba(245, 158, 11, 0.08)', 'important');
        
        // 4. İkonlar: Gold
        const activeItem = nav.querySelector('.nav-item.active');
        if (activeItem) {
            activeItem.style.setProperty('color', '#f59e0b', 'important');
            activeItem.style.textShadow = '0 0 15px rgba(245, 158, 11, 0.4)';
            
            const icon = activeItem.querySelector('i');
            if(icon) icon.style.setProperty('color', '#f59e0b', 'important');
        }

    } else {
        // === VARSAYILAN MOD (LACİVERT/OKYANUS) ===
        // Burası uygulamanın ana rengi, buraya dokunmadık.
        nav.style.setProperty('background', 'rgba(21, 27, 43, 0.95)', 'important');
        nav.style.setProperty('border-top', '1px solid rgba(255, 255, 255, 0.08)', 'important');
        nav.style.setProperty('box-shadow', '0 -5px 20px rgba(0, 0, 0, 0.3)', 'important');
        
        // İkonları normale döndür
        const activeItem = nav.querySelector('.nav-item.active');
        if (activeItem) {
            activeItem.style.removeProperty('color');
            activeItem.style.removeProperty('text-shadow');
            const icon = activeItem.querySelector('i');
            if(icon) icon.style.removeProperty('color');
        }
    }
}

// 1. Sayfa geçişini yakala
if (typeof window.switchPage === 'function') {
    const originalSwitch = window.switchPage;
    window.switchPage = function(pageId, btn) {
        originalSwitch(pageId, btn);
        setTimeout(forceNavColor, 50);
    };
}

// 2. Sürekli kontrol (Hata payını sıfırlar)
setInterval(forceNavColor, 500);

/* --- YENİ ALARM YÖNETİM SİSTEMİ --- */

// 1. Sekme Değiştirme
function showNotifTab(tab) {
    // Başlıkları Ayarla
    document.querySelectorAll('.notif-tab-btn').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');

    // Panelleri Ayarla
    document.querySelectorAll('.notif-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('panel-' + tab).classList.add('active');

    // Eğer "Bekleyenler" açıldıysa listeyi yenile
    if (tab === 'alarms') renderActiveAlarmsList();
}

// 2. Kurulu Alarmları Listele (SİLME BUTONLU) - TASARIM DÜZELTİLDİ
function renderActiveAlarmsList() {
    const list = document.getElementById('activeAlarmsList');
    const alarms = JSON.parse(localStorage.getItem('tradeVia_alarms')) || [];

    list.innerHTML = '';

    if (alarms.length === 0) {
        list.innerHTML = `
            <div style="text-align:center; padding:40px; color:var(--text-sub);">
                <i class="fas fa-bell-slash" style="font-size:30px; margin-bottom:10px; opacity:0.5;"></i><br>
                Aktif alarm bulunmuyor.
            </div>`;
        return;
    }

    alarms.forEach(alarm => {
        let icon = alarm.direction === 'UP' ? 'fa-arrow-up' : 'fa-arrow-down';
        let color = alarm.direction === 'UP' ? '#10b981' : '#ef4444';
        
        let descriptionText = "";
        
        if (alarm.type === 'PRICE') {
            descriptionText = `Hedef: <span style="color:${color}; font-weight:bold;">$${alarm.target}</span>`;
        } 
        else if (alarm.type === 'VOLATILITY') {
            icon = 'fa-bolt'; 
            color = '#f59e0b'; 
            descriptionText = `Ani Hareket: <span style="color:${color}; font-weight:bold;">%${alarm.percent}</span>`;
        } 
        else if (alarm.type === 'RSI') {
            icon = 'fa-brain'; 
            color = '#8b5cf6'; 
            descriptionText = `<span style="color:${color}; font-weight:bold;">AI Trend Analizi (30G)</span>`;
        }

        const li = document.createElement('li');
        
        // --- DÜZELTME BURADA ---
        // 'deep-inset' sınıfını kaldırdım.
        // 'notif-card' sınıfını ekledim (Diğer bildirimlerle aynı görünüm için).
        li.className = 'notif-card'; 
        
        // Hizalama ayarları
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.marginBottom = '10px'; // Kartlar birbirine yapışmasın

        li.innerHTML = `
            <div>
                <strong style="color:#fff; font-size:15px;">${alarm.symbol}</strong>
                <div style="font-size:12px; color:var(--text-sub); margin-top:2px;">
                    ${descriptionText} 
                    <i class="fas ${icon}" style="font-size:10px; color:${color}; margin-left:5px;"></i>
                </div>
            </div>
            <button onclick="removeAlarm(${alarm.id})" style="background:rgba(239, 68, 68, 0.1); border:none; width:36px; height:36px; border-radius:10px; color:#ef4444; cursor:pointer;">
                <i class="fas fa-trash"></i>
            </button>
        `;
        list.appendChild(li);
    });
}

// 3. Alarm Silme
function removeAlarm(id) {
    if(!confirm("Bu alarmı silmek istiyor musunuz?")) return;

    let alarms = JSON.parse(localStorage.getItem('tradeVia_alarms')) || [];
    alarms = alarms.filter(a => a.id !== id);
    localStorage.setItem('tradeVia_alarms', JSON.stringify(alarms));
    
    // Listeyi yenile
    renderActiveAlarmsList();
    
    // Cüzdandaki ikonun sönmesi için sayfayı yenilemek gerekebilir veya UI update çağrılır
    // Eğer cüzdan sayfası açıksa updatePortfolioUI() çağırabilirsin.
    if(typeof updatePortfolioUI === 'function') updatePortfolioUI(); 
}

/* --- ÇOKLU PORTFÖY YÖNETİCİSİ (SWAP SİSTEMİ) --- */
const MultiPortfolio = {
    // Başlangıç Ayarları
    init: function() {
        // Eğer sistemde hiç portföy veritabanı yoksa oluştur
        let db = JSON.parse(localStorage.getItem('tm_all_portfolios'));
        if (!db) {
            // Mevcut veriyi 'Ana Cüzdan' olarak kaydet
            let currentData = localStorage.getItem('myPF_final') || '[]';
            let currentCash = localStorage.getItem('tm_cash_balance') || '0';
            
            db = {
                activeID: 'main',
                list: {
                    'main': { name: 'Ana Cüzdan', data: currentData, cash: currentCash }
                }
            };
            localStorage.setItem('tm_all_portfolios', JSON.stringify(db));
        }
        
        // Aktif cüzdan ismini başlığa yaz
        this.updateHeader();
    },

    // Modalı Aç ve Listeyi Göster
    open: function() {
        this.syncCurrentToStorage(); // Önce şu anki hali kaydet
        let db = JSON.parse(localStorage.getItem('tm_all_portfolios'));
        let container = document.getElementById('portfolioListContainer');
        let html = '';

        Object.keys(db.list).forEach(key => {
            let p = db.list[key];
            let isActive = (key === db.activeID) ? 'border-color:var(--accent); background:rgba(59,130,246,0.1);' : 'border-color:rgba(255,255,255,0.1);';
            let icon = (key === db.activeID) ? '<i class="fas fa-check-circle" style="color:var(--accent)"></i>' : '<i class="far fa-circle" style="color:var(--text-sub)"></i>';
            let delBtn = (key !== 'main' && key !== db.activeID) ? `<button onclick="MultiPortfolio.delete('${key}')" style="background:none; border:none; color:var(--danger); cursor:pointer; padding:5px;"><i class="fas fa-trash"></i></button>` : '';

            html += `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border:1px solid; border-radius:10px; margin-bottom:8px; cursor:pointer; transition:0.2s; ${isActive}" onclick="MultiPortfolio.switch('${key}')">
                <div style="display:flex; align-items:center; gap:10px;">
                    ${icon}
                    <div style="font-weight:700; font-size:13px;">${p.name}</div>
                </div>
                <div onclick="event.stopPropagation()">
                    ${delBtn}
                </div>
            </div>`;
        });

        container.innerHTML = html;
        document.getElementById('portfolioModal').style.display = 'flex';
    },

    // Yeni Portföy Oluştur
    create: function() {
        let name = document.getElementById('newPortfolioName').value.trim();
        if (!name) return alert("Lütfen bir isim girin.");

        this.syncCurrentToStorage(); // Mevcut işleri kaydet
        let db = JSON.parse(localStorage.getItem('tm_all_portfolios'));
        
        // Benzersiz ID oluştur
        let newID = 'pf_' + Date.now();
        
        db.list[newID] = {
            name: name,
            data: '[]', // Boş portföy
            cash: '0'   // 0 Nakit
        };

        localStorage.setItem('tm_all_portfolios', JSON.stringify(db));
        document.getElementById('newPortfolioName').value = '';
        this.open(); // Listeyi yenile
    },

    // Portföy Değiştir (SWAP İŞLEMİ)
    switch: function(targetID) {
        let db = JSON.parse(localStorage.getItem('tm_all_portfolios'));
        if (targetID === db.activeID) return; // Zaten seçili

        // 1. Mevcut (Aktif) Cüzdanı Hafızaya Yedekle
        let currentPF = localStorage.getItem('myPF_final') || '[]';
        let currentCash = localStorage.getItem('tm_cash_balance') || '0';
        db.list[db.activeID].data = currentPF;
        db.list[db.activeID].cash = currentCash;

        // 2. Hedef Cüzdanı Aktif Yap
        db.activeID = targetID;
        localStorage.setItem('tm_all_portfolios', JSON.stringify(db));

        // 3. Hedef Veriyi Uygulamanın Ana Belleğine (localStorage) Yaz
        let targetWallet = db.list[targetID];
        localStorage.setItem('myPF_final', targetWallet.data);
        localStorage.setItem('tm_cash_balance', targetWallet.cash);

        // 4. Uygulamayı Yenile
        location.reload(); 
    },

    // Silme
    delete: function(targetID) {
        if (!confirm("Bu cüzdan ve içindeki tüm veriler silinecek. Emin misiniz?")) return;
        let db = JSON.parse(localStorage.getItem('tm_all_portfolios'));
        delete db.list[targetID];
        localStorage.setItem('tm_all_portfolios', JSON.stringify(db));
        this.open();
    },

    // Mevcut durumu ana veritabanına eşitle (Yedekleme)
    syncCurrentToStorage: function() {
        let db = JSON.parse(localStorage.getItem('tm_all_portfolios')) || { activeID: 'main', list: {'main':{}} };
        if (db.list[db.activeID]) {
            db.list[db.activeID].data = localStorage.getItem('myPF_final') || '[]';
            db.list[db.activeID].cash = localStorage.getItem('tm_cash_balance') || '0';
            localStorage.setItem('tm_all_portfolios', JSON.stringify(db));
        }
    },

    // Başlığı Güncelle
    updateHeader: function() {
        let db = JSON.parse(localStorage.getItem('tm_all_portfolios'));
        if (db && db.list[db.activeID]) {
            let el = document.getElementById('activePortfolioName');
            if(el) el.innerHTML = `${db.list[db.activeID].name.toUpperCase()} <i class="fas fa-chevron-down" style="font-size:10px; margin-left:3px;"></i>`;
        }
    }
};

// Modal Açma Yardımcısı
function openPortfolioModal() {
    MultiPortfolio.open();
}

// Uygulama başladığında sistemi kontrol et
document.addEventListener('DOMContentLoaded', () => {
    MultiPortfolio.init();
});

// --- GELİŞMİŞ ANALİZ MOTORU (Düzeltilmiş) ---

async function runDeepDiveAnalysis() {
    // LocalStorage verisini güvenli çekme
    var asData = localStorage.getItem('myPF_final');
    var as = asData ? JSON.parse(asData) : [];
    
    var cashData = localStorage.getItem('tm_cash_balance');
    var cash = cashData ? parseFloat(cashData) : 0;
    
    // UI Hazırlığı
    var btnStart = document.getElementById('btnAiStart');
    var screenLoad = document.getElementById('aiLoadingScreen');
    var resultArea = document.getElementById('aiRescueResult');
    var logText = document.getElementById('aiLoadingText');
    
    if(btnStart) btnStart.style.display = 'none';
    if(screenLoad) screenLoad.style.display = 'block';
    if(resultArea) resultArea.style.display = 'none';
    
    function updateLog(msg) {
        if(logText) logText.innerText = msg;
    }

    // 1. Zarardaki Varlıkları Seç
    var losers = as.filter(function(a) {
        var price = a.curr || a.buy;
        return price < a.buy;
    });
    
    if (losers.length === 0) {
        finishAiAnalysis([], cash, "Zararda varlık yok.");
        return;
    }

    var analyzedAssets = [];
    updateLog(losers.length + " varlık için geçmiş veriler taranıyor...");

    // 2. Her Varlık İçin Derinlemesine Veri Çek
    for (var i = 0; i < losers.length; i++) {
        var asset = losers[i];
        
        // Sembolü temizle
        var rawSym = asset.name.replace('BINANCE:','').replace('BIST:','').replace('USDT','').replace('.IS','').trim();
        
        // Veri Çekme
        var candles = await fetchCandleHistory(rawSym, asset.name);
        
        // Teknik Analiz Hesapla
        var metrics = calculateTechnicalMetrics(candles, asset.buy, (asset.curr || asset.buy));
        
        // Güvenli nesne birleştirme (Spread operator yerine assign kullanıldı)
        var newObj = Object.assign({}, asset);
        newObj.metrics = metrics;
        newObj.cleanSym = rawSym;
        
        analyzedAssets.push(newObj);
        
        // API limitine takılmamak için bekleme
        await new Promise(function(resolve) { setTimeout(resolve, 200); });
    }

    // 3. Puanlama ve Bütçe Dağıtımı
    updateLog("Yapay zeka puanlaması yapılıyor...");
    var finalPlan = generateAiStrategy(analyzedAssets, cash);
    
    finishAiAnalysis(finalPlan, cash);
}

/* ==========================================================================
   GELİŞMİŞ AI ANALİZ MOTORU (FİNAL SÜRÜM - V4 STABLE)
   Düzeltmeler:
   1. Veri formatı (Array vs Object) uyumsuzluğu giderildi.
   2. "Hepsine Güçlü Al" deme sorunu çözüldü (Puanlama zorlaştırıldı).
   3. RSI ve Trend analizleri gerçek matematiksel verilere bağlandı.
   ========================================================================== */

async function runDeepDiveAnalysis() {
    // 1. Verileri Çek
    var asData = localStorage.getItem('myPF_final');
    var as = asData ? JSON.parse(asData) : [];
    
    var cashData = localStorage.getItem('tm_cash_balance');
    var cash = cashData ? parseFloat(cashData) : 0;
    
    // UI Hazırlığı
    var btnStart = document.getElementById('btnAiStart');
    var screenLoad = document.getElementById('aiLoadingScreen');
    var resultArea = document.getElementById('aiRescueResult');
    var logText = document.getElementById('aiLoadingText');
    var subText = document.getElementById('aiLoadingSub');
    
    // UI Durumunu Güncelle
    if(btnStart) btnStart.style.display = 'none';
    if(screenLoad) screenLoad.style.display = 'block';
    if(resultArea) resultArea.style.display = 'none';
    
    function updateLog(msg, sub) {
        if(logText) logText.innerText = msg;
        if(subText && sub) subText.innerText = sub;
    }

    // 2. Zarardaki Varlıkları Seç
    var losers = as.filter(function(a) {
        var price = a.curr || a.buy;
        return price < a.buy;
    });
    
    if (losers.length === 0) {
        finishAiAnalysis([], cash, "Zararda varlık yok, keyfine bak! ☕");
        return;
    }

    var analyzedAssets = [];
    
    // 3. Her Varlık İçin Döngü
    for (var i = 0; i < losers.length; i++) {
        var asset = losers[i];
        var progress = "(" + (i + 1) + "/" + losers.length + ")";
        
        updateLog(progress + " " + asset.name + " Analiz Ediliyor...", "Veri kaynakları taranıyor...");
        
        try {
            // Sembolü temizle (Örn: BINANCE:BTCUSDT -> BTC)
            var rawSym = asset.name.replace('BINANCE:','').replace('BIST:','').replace('USDT','').replace('BUSD','').replace('.IS','').trim();
            
            // Veri Çekme (Promise.race ile 5 Saniye Zaman Aşımı)
            var candles = await Promise.race([
                fetchCandleHistory(rawSym, asset.name),
                new Promise(resolve => setTimeout(() => resolve(null), 5000)) 
            ]);
            
            var metrics;
            var currentPrice = asset.curr || asset.buy;

            if (candles && candles.length > 0) {
                // Veri geldiyse: Teknik Analiz
                metrics = calculateTechnicalMetrics(candles, asset.buy, currentPrice);
            } else {
                // Veri gelmediyse: Matematiksel Analiz
                metrics = generateBasicAnalysis(asset.buy, currentPrice);
            }
            
            // Sonuçları kaydet
            var newObj = Object.assign({}, asset);
            newObj.metrics = metrics;
            newObj.cleanSym = rawSym;
            analyzedAssets.push(newObj);

        } catch (err) {
            console.error("AI Analiz Hatası (" + asset.name + "):", err);
            // Hata durumunda döngüyü kırma, matematiksel analizle devam et
            var fallbackMetrics = generateBasicAnalysis(asset.buy, (asset.curr || asset.buy));
            var failObj = Object.assign({}, asset);
            failObj.metrics = fallbackMetrics;
            analyzedAssets.push(failObj);
        }
        
        // API limitine takılmamak için 1 sn bekle
        await new Promise(function(resolve) { setTimeout(resolve, 1000); });
    }

    // 4. Sonuçları Hesapla
    updateLog("Strateji Oluşturuluyor...", "Yapay zeka verileri işliyor");
    
    // generateAiStrategy artık bu blokta tanımlı, güvenle çağırabiliriz
    var finalPlan = generateAiStrategy(analyzedAssets, cash);
    
    setTimeout(function() {
        finishAiAnalysis(finalPlan, cash);
    }, 800);
}

// ==========================================
// 1. VERİ ÇEKME MOTORU (Düz Array Döndürür)
// ==========================================
async function fetchCandleHistory(symbol, originalName) {
    var cleanSym = symbol.toUpperCase();

    // BIST hissesi ise veri çekme
    if (originalName && originalName.includes('.IS')) {
        return null; 
    }

    // A) CryptoCompare (90 GÜN)
    try {
        const response = await fetch(`https://min-api.cryptocompare.com/data/v2/histoday?fsym=${cleanSym}&tsym=USD&limit=90`);
        if (response.ok) {
            const data = await response.json();
            if (data.Response === 'Success' && data.Data && data.Data.Data) {
                // Sadece kapanış fiyatlarını (sayı) döndür: [42000, 41500, ...]
                return data.Data.Data.map(d => d.close);
            }
        }
    } catch (err) {
        console.warn("CryptoCompare yanıt vermedi, yedeğe geçiliyor.");
    }

    // B) Binance (YEDEK)
    try {
        let binanceSym = cleanSym + "USDT";
        const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${binanceSym}&interval=1d&limit=90`);
        if (response.ok) {
            const data = await response.json();
            // Binance formatında 4. index kapanış fiyatıdır
            return data.map(d => parseFloat(d[4]));
        }
    } catch (err) {
        console.warn("Binance verisi de alınamadı.");
    }

    return null;
}

// ==========================================
// 2. TEKNİK ANALİZ (Sayı Dizisi ile Çalışan Düzeltilmiş Versiyon)
// ==========================================
function calculateTechnicalMetrics(candles, myCost, currentPrice) {
    // Veri yetersizse basic analize yolla
    if (!candles || candles.length < 15) {
        return generateBasicAnalysis(myCost, currentPrice);
    }

    // A) RSI Hesapla (14 Günlük)
    // candles dizisi artık doğrudan fiyatları içeriyor: [10, 12, 11...]
    var gains = 0, losses = 0;
    // Son 14 güne bak
    for (var i = candles.length - 14; i < candles.length; i++) {
        var diff = candles[i] - candles[i-1];
        if (diff >= 0) gains += diff;
        else losses -= diff;
    }
    
    var avgGain = gains / 14;
    var avgLoss = losses / 14;
    var rs = avgLoss === 0 ? 0 : avgGain / avgLoss;
    var rsi = avgLoss === 0 ? 100 : 100 - (100 / (1 + rs));

    // B) SMA 50 (Hareketli Ortalama)
    var period = Math.min(50, candles.length);
    var sum = 0;
    for (var j = candles.length - period; j < candles.length; j++) {
        sum += candles[j];
    }
    var sma = sum / period;

    // C) Drawdown (Tepeden Düşüş)
    var maxHigh = Math.max(...candles); // Dizideki en yüksek fiyat
    var drawdown = ((maxHigh - currentPrice) / maxHigh) * 100;

    // --- PUANLAMA ALGORİTMASI (DAHA ZEKİ) ---
    var score = 50; // Nötr başlangıç
    var desc = "";

    // 1. RSI Değerlendirmesi
    if (rsi < 30) { 
        score += 25; 
        desc += "RSI dipte (Aşırı Satış). "; 
    } else if (rsi < 45) { 
        score += 10; 
        desc += "Fiyat makul bölgede. "; 
    } else if (rsi > 70) { 
        score -= 25; 
        desc += "RSI tepede (Aşırı Alış). "; 
    } else {
        desc += "RSI nötr. ";
    }

    // 2. Trend (SMA) Değerlendirmesi
    if (currentPrice > sma) { 
        score += 15; 
        desc += "Yükseliş trendi korunuyor. "; 
    } else { 
        score -= 10; 
        desc += "Düşüş trendinde. "; 
    }

    // 3. Maliyet Uygunluğu (Drawdown)
    if (drawdown > 60) {
        // Çok düşmüş ama hala düşüyor olabilir, RSI kontrolü şart
        if (rsi < 35) {
            score += 20; 
            desc += "Dip oluşumu var, fırsat. ";
        } else {
            score -= 5;
            desc += "Sert düşüş sürüyor, dikkatli ol. ";
        }
    } else if (drawdown > 30) {
        score += 10; 
        desc += "Düzeltme seviyesi. ";
    }

    // Puanı 0-100 arasına sabitle
    score = Math.max(0, Math.min(100, score));

    return { 
        score: score, 
        rsi: rsi, 
        trend: (currentPrice > sma ? 'Yükseliş' : 'Düşüş'), 
        volatility: 'Orta', 
        desc: desc, 
        drop: drawdown 
    };
}

// ==========================================
// 3. BASİT ANALİZ (YEDEK - Veri Yoksa)
// ==========================================
function generateBasicAnalysis(cost, current) {
    var drop = ((cost - current) / cost) * 100;
    
    // Varsayılan puanı düşürdük, her şeye atlamasın
    var score = 40; 
    var desc = "Veri alınamadı, matematiksel risk analizi.";
    
    if(drop > 60) { 
        score = 75; 
        desc += " Fiyat %60 erimiş, risk alınıp ortalama düşürülebilir."; 
    } else if(drop > 30) { 
        score = 55; 
        desc += " Makul iskonto var."; 
    } else { 
        score = 30; 
        desc += " Henüz yeterli düşüş yok."; 
    }

    return { 
        score: score, 
        rsi: 50, // Varsayılan
        trend: 'Bilinmiyor', 
        volatility: 'Standart', 
        desc: desc, 
        drop: drop 
    };
}

// ==========================================
// 4. STRATEJİ ÜRETİCİ (Renklendirme ve Etiketleme)
// ==========================================
function generateAiStrategy(assets, cash) {
    // Negatif puanları temizle
    assets.forEach(a => { if (a.metrics.score < 1) a.metrics.score = 1; });

    var totalScore = assets.reduce((acc, curr) => acc + curr.metrics.score, 0);

    return assets.map(function(a) {
        // Puanına göre parayı bölüştür
        var allocation = totalScore > 0 ? (a.metrics.score / totalScore) * cash : 0;
        
        var color, label;
        
        // --- YENİ EŞİKLER (DAHA ZORLU) ---
        // Sadece gerçekten iyi durumda olanlara Yeşil yakar
        if(a.metrics.score >= 70) { 
            color = "#10b981"; // Yeşil
            label = "💎 GÜÇLÜ AL"; 
        } else if(a.metrics.score >= 50) { 
            color = "#3b82f6"; // Mavi
            label = "KADEMELİ AL"; 
        } else if(a.metrics.score >= 35) {
            color = "#f59e0b"; // Turuncu
            label = "İZLE"; 
            allocation = allocation * 0.5; // Paranın yarısını öner
        } else {
            color = "#ef4444"; // Kırmızı
            label = "BEKLE"; 
            allocation = 0; // Para önerme
        }

        var resObj = Object.assign({}, a);
        resObj.allocation = allocation;
        resObj.color = color;
        resObj.label = label;
        return resObj;
        
    }).sort(function(a,b) { return b.metrics.score - a.metrics.score; });
}

// ==========================================
// 5. SONUÇLARI EKRANA BAS
// ==========================================
function finishAiAnalysis(plan, cash, errorMsg) {
    var screenLoad = document.getElementById('aiLoadingScreen');
    var resultArea = document.getElementById('aiRescueResult');
    var btnStart = document.getElementById('btnAiStart');
    
    if(screenLoad) screenLoad.style.display = 'none';
    if(resultArea) resultArea.style.display = 'block';
    if(btnStart) {
        btnStart.style.display = 'flex';
        btnStart.innerHTML = '<i class="fas fa-sync-alt"></i> ANALİZİ YENİLE';
    }

    var container = document.getElementById('aiRescueList');
    
    if (!plan || plan.length === 0) {
        container.innerHTML = "<div style='padding:20px; text-align:center; color:#94a3b8;'>" + (errorMsg || "Sonuç yok") + "</div>";
        return;
    }

    var html = "";
    var sym = '₺'; // Varsayılan TL
    if (typeof appSettings !== 'undefined' && appSettings.currency === 'USD') sym = '$';

    plan.forEach(function(p) {
        // Yeni ortalama hesabı
        var curP = p.curr || p.buy;
        var qtyAdd = curP > 0 ? p.allocation / curP : 0;
        var totalCost = (p.amt * p.buy) + p.allocation;
        var totalQty = p.amt + qtyAdd;
        var newAvg = totalQty > 0 ? totalCost / totalQty : 0;
        
        // RSI Rengi
        var rsiVal = p.metrics.rsi || 50;
        var rsiColor = rsiVal < 30 ? '#10b981' : (rsiVal > 70 ? '#ef4444' : '#f59e0b');

        html += `
        <div style="background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.05); border-radius:12px; padding:12px; margin-bottom:10px; border-left:3px solid ${p.color};">
            
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <div>
                    <div style="font-weight:800; font-size:14px; color:white;">${p.name}</div>
                    <div style="font-size:10px; color:${p.color}; font-weight:700; background:${p.color}15; padding:2px 6px; border-radius:4px; display:inline-block; margin-top:2px;">
                        ${p.label} (Puan: ${Math.round(p.metrics.score)})
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:9px; color:#94a3b8;">ÖNERİLEN EKLEME</div>
                    <div style="font-weight:800; font-size:14px; color:#a78bfa;">${sym}${p.allocation.toLocaleString(undefined, {maximumFractionDigits:0})}</div>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:10px; background:rgba(0,0,0,0.2); padding:8px; border-radius:8px;">
                <div style="font-size:10px; color:#94a3b8;">
                    RSI: <span style="color:${rsiColor}; font-weight:700;">${rsiVal.toFixed(0)}</span>
                </div>
                <div style="font-size:10px; color:#94a3b8; text-align:right;">
                    Trend: <span style="color:white;">${p.metrics.trend}</span>
                </div>
                <div style="grid-column: span 2; font-size:9px; color:#64748b; font-style:italic;">
                    "${p.metrics.desc}"
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; font-size:11px;">
                <span style="color:#ef4444; text-decoration:line-through;">Maliyet: ${p.buy.toFixed(2)}</span>
                <i class="fas fa-arrow-right" style="color:#64748b; font-size:10px;"></i>
                <span style="color:#10b981; font-weight:700;">Yeni: ${newAvg.toFixed(2)}</span>
            </div>

        </div>`;
    });

    container.innerHTML = html;
}

// --- 3'LÜ MOD GEÇİŞ SİSTEMİ (GİZLEME ÖZELLİKLİ) ---
function switchAvgMode(mode, btn) {
    // 1. Butonların Rengini Ayarla
    if (btn && btn.parentElement) {
        const siblings = btn.parentElement.children;
        for (let i = 0; i < siblings.length; i++) {
            siblings[i].classList.remove('active');
        }
        btn.classList.add('active');
    }

    // 2. MOD DEĞİŞTİĞİNDE SONUÇ EKRANLARINI TEMİZLE
    const aaResultBox = document.getElementById('aaResultBox');
    const aiRescueResult = document.getElementById('aiRescueResult');
    const aiLoadingScreen = document.getElementById('aiLoadingScreen');
    const aiRescueList = document.getElementById('aiRescueList');
    const aaRiskAlert = document.getElementById('aaRiskAlert');
    
    if(aaResultBox) aaResultBox.style.display = 'none';
    if(aiRescueResult) aiRescueResult.style.display = 'none';
    if(aiLoadingScreen) aiLoadingScreen.style.display = 'none';
    if(aiRescueList) aiRescueList.innerHTML = '';
    if(aaRiskAlert) aaRiskAlert.style.display = 'none';
    
    // AI Başlat butonunu sıfırla
    const btnAiStart = document.getElementById('btnAiStart');
    if(btnAiStart) {
        btnAiStart.style.display = 'flex';
        btnAiStart.innerHTML = '<i class="fas fa-brain"></i> ANALİZİ BAŞLAT';
    }

    // 3. Tüm Panelleri Tanımla
    const budgetPanel = document.getElementById('avg-mode-budget');
    const targetPanel = document.getElementById('avg-mode-target');
    const autoPanel = document.getElementById('avg-mode-auto');
    
    // GİZLENECEK ALAN (Manuel Giriş Kutuları)
    const manualInputs = document.getElementById('avg-manual-inputs');
    const assetSelect = document.getElementById('advAvgSelect'); // Varlık seçimi de gizlensin mi? (Opsiyonel)

    // 4. Önce Hepsini Gizle (Temizlik)
    if(budgetPanel) budgetPanel.style.display = 'none';
    if(targetPanel) targetPanel.style.display = 'none';
    if(autoPanel) autoPanel.style.display = 'none';

    // 5. Seçilen Modu Göster
    if (mode === 'budget') {
        if(budgetPanel) budgetPanel.style.display = 'block';
        if(manualInputs) manualInputs.style.display = 'grid'; // Kutuları GÖSTER
    } 
    else if (mode === 'target') {
        if(targetPanel) targetPanel.style.display = 'block';
        if(manualInputs) manualInputs.style.display = 'grid'; // Kutuları GÖSTER
    } 
    else if (mode === 'auto') {
        if(autoPanel) {
            autoPanel.style.display = 'block';
            if(manualInputs) manualInputs.style.display = 'none'; // Kutuları GİZLE
            
            // Kasa bilgisini anında güncelle
            let cash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
            let sym = (typeof appSettings !== 'undefined' && appSettings.currency === 'TRY') ? '₺' : '$';
            let cashDisplay = document.getElementById('aiRescueCash');
            if(cashDisplay) cashDisplay.innerText = sym + cash.toLocaleString();
        }
    }
}

</script>

<script>
/* ======================================================
   TRADEVIA MASTER SİSTEM (LİMİTLER + VERİ GİZLEME + TEK ÖDEME)
   ====================================================== */

/* 0. STİL YÖNETİCİSİ */
(function injectStyles() {
    const style = document.createElement('style');
    style.innerHTML = `
        .profile-frame-free { border: 3px solid #475569 !important; }
        .profile-frame-pro { border: 3px solid #f59e0b !important; box-shadow: 0 0 15px rgba(245, 158, 11, 0.6) !important; animation: proGlow 2s infinite alternate; }
        @keyframes proGlow { from { box-shadow: 0 0 5px rgba(245, 158, 11, 0.4); border-color: #f59e0b; } to { box-shadow: 0 0 25px rgba(245, 158, 11, 0.9); border-color: #fbbf24; } }
        .membership-card { border-radius: 16px; padding: 20px; margin-bottom: 20px; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: all 0.3s ease; }
        .card-free { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border: 1px solid #334155; }
        .card-pro { background: linear-gradient(135deg, #f59e0b 0%, #b45309 100%); border: 1px solid #fbbf24; color: white; }
        .card-pro::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%); transform: rotate(45deg); pointer-events: none; }
        .mc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .mc-title { font-size: 18px; font-weight: 800; letter-spacing: 1px; }
        .mc-badge { padding: 5px 12px; border-radius: 20px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .badge-free { background: rgba(255,255,255,0.1); color: #94a3b8; }
        .badge-pro { background: rgba(0,0,0,0.3); color: #fbbf24; border: 1px solid rgba(255,255,255,0.2); color:white; }
        .mc-dates { font-size: 11px; opacity: 0.9; margin-top: 10px; line-height: 1.6; }
        .mc-progress-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-top: 15px; overflow: hidden; }
        .mc-progress-fill { height: 100%; background: white; border-radius: 10px; width: 0%; transition: width 1s ease; }
    `;
    document.head.appendChild(style);
})();

/* 1. ÜYELİK YÖNETİM SİSTEMİ */
const MembershipSystem = {
    isPro: function() { 
        this.checkExpiration();
        return localStorage.getItem('userPlan') === 'PRO'; 
    },
    
    // --- ANA YÖNLENDİRİCİ ---
    showUpsell: function() {
        this.redirectToSettings();
    },

    // --- AYARLARA GİT VE PENCEREYİ AÇ ---
    redirectToSettings: function() {
        const settingsBtn = document.querySelector(".nav-item:last-child"); 
        if (typeof switchPage === 'function') switchPage('settings', settingsBtn || null);

        setTimeout(() => {
            if (typeof openPremiumModal === 'function') {
                openPremiumModal();
            } else {
                const modal = document.getElementById('premiumModalOverlay');
                if(modal) {
                    modal.style.display = 'flex';
                    setTimeout(() => modal.classList.add('active'), 10);
                }
            }
        }, 300);
    },

    // --- ÖDEME İŞLEMİ (MERKEZİ) ---
    processPayment: function() {
        if (typeof closePremiumModal === 'function') closePremiumModal();
        const modal = document.getElementById('premiumModalOverlay');
        if(modal) { modal.classList.remove('active'); setTimeout(() => modal.style.display = 'none', 300); }

        if (window.Android && window.Android.buyPro) {
            window.Android.buyPro(); 
        } else {
            if(confirm("🛠️ TEST MODU: Google Play bağlantısı yok. Ödeme başarılı sayılsın mı?")) {
                this.activatePro();
            }
        }
    },
    
    activatePro: function() {
        const now = new Date();
        const endDate = new Date();
        endDate.setDate(now.getDate() + 30); 
        localStorage.setItem('userPlan', 'PRO');
        localStorage.setItem('proStartDate', now.toISOString()); 
        localStorage.setItem('proEndDate', endDate.toISOString()); 
        alert("🎉 TEBRİKLER! Ödeme Başarılı.\nPro üyeliğiniz 30 gün boyunca aktif!");
        location.reload();
    },
    
    downgrade: function() {
        if(confirm("Free pakete dönmek istediğine emin misin?")) {
            this.setFree();
            location.reload();
        }
    },

    setFree: function() {
        localStorage.setItem('userPlan', 'FREE');
        localStorage.removeItem('proStartDate');
        localStorage.removeItem('proEndDate');
        alert("Paketiniz Free'ye düşürüldü.");
    },
    
    checkExpiration: function() {
        if (localStorage.getItem('userPlan') !== 'PRO') return;
        const endDateStr = localStorage.getItem('proEndDate');
        if (!endDateStr) return; 
        const now = new Date();
        const endDate = new Date(endDateStr);
        if (now > endDate) {
            alert("⚠️ PRO SÜRENİZ DOLDU.");
            this.setFree();
            location.reload();
        }
    },
    
    // --- GÜNLÜK LİMİT KONTROLÜ (3 HAK) ---
    checkUsageLimit: function(featureName, maxLimit, title) {
        if (this.isPro()) return true; // Pro ise limit yok
        
        let today = new Date().toLocaleDateString();
        let key = 'limit_' + featureName;
        let usage = JSON.parse(localStorage.getItem(key)) || { date: today, count: 0 };
        
        // Gün değiştiyse sıfırla
        if (usage.date !== today) { usage = { date: today, count: 0 }; localStorage.setItem(key, JSON.stringify(usage)); }
        
        // LİMİT DOLDU MU? (3 HAK)
        if (usage.count >= maxLimit) {
            alert(`🔒 GÜNLÜK LİMİT DOLDU!\n\nFree pakette '${title}' özelliğini günde ${maxLimit} kez kullanabilirsin.\nDevam etmek için yükselt.`);
            this.showUpsell(); // Ayarlara yönlendir
            return false;
        }
        
        // Kullanımı artır ve devam et
        usage.count++; 
        localStorage.setItem(key, JSON.stringify(usage)); 
        return true;
    },

    refreshUI: function() {
        const isPro = this.isPro();
        
        let img = document.getElementById('menuProfileImg');
        if(img) {
            img.classList.remove('profile-frame-free', 'profile-frame-pro');
            img.classList.add(isPro ? 'profile-frame-pro' : 'profile-frame-free');
        }
        
        let badge = document.querySelector('.pbc-badge');
        if(badge) {
            if(isPro) {
                badge.innerHTML = '<i class="fas fa-crown"></i> PRO ÜYE';
                badge.style.background = 'linear-gradient(45deg, #f59e0b, #d97706)'; badge.style.color = '#000';
            } else {
                badge.innerHTML = '<i class="fas fa-user"></i> FREE ÜYE';
                badge.style.background = '#334155'; badge.style.color = '#94a3b8';
            }
        }

        let btnUp = document.getElementById('btnUpgrade');
        let btnDown = document.getElementById('btnDowngrade');
        
        if(btnUp) btnUp.style.display = isPro ? 'none' : 'flex';
        if(btnDown) btnDown.style.display = isPro ? 'block' : 'none';
        
        if(btnUp) btnUp.onclick = () => this.processPayment();
        if(btnDown) btnDown.onclick = () => this.downgrade();

        let statusContainer = document.getElementById('planStatusText');
        if(statusContainer) {
            if (!isPro) {
                statusContainer.innerHTML = `
                    <div class="membership-card card-free">
                        <div class="mc-header"><div class="mc-title">FREE PLAN</div><div class="mc-badge badge-free">STANDART</div></div>
                        <div style="font-size:12px; color:#cbd5e1; margin-bottom:10px;">Kısıtlı erişim.</div>
                        <div class="mc-progress-bg"><div class="mc-progress-fill" style="width:0%"></div></div>
                    </div>`;
            } else {
                const start = new Date(localStorage.getItem('proStartDate'));
                const end = new Date(localStorage.getItem('proEndDate'));
                const formatDate = (d) => d.toLocaleDateString('tr-TR');
                const now = new Date();
                const diffTime = Math.abs(end - now);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                let percent = ((30 - diffDays) / 30) * 100;
                if(percent > 100) percent = 100; if(percent < 0) percent = 0;

                statusContainer.innerHTML = `
                    <div class="membership-card card-pro">
                        <div class="mc-header"><div class="mc-title"><i class="fas fa-crown"></i> PRO MEMBER</div><div class="mc-badge badge-pro">PREMIUM</div></div>
                        <div class="mc-dates">
                            <div style="margin-top:8px; font-size:13px; font-weight:bold; color:#fbbf24;">Kalan: ${diffDays} Gün</div>
                        </div>
                        <div class="mc-progress-bg"><div class="mc-progress-fill" style="width:${100 - percent}%"></div></div>
                    </div>`;
            }
        }
    }
};

window.onPaymentSuccess = function() { MembershipSystem.activatePro(); };

/* --- 1. PSİKOLOJİ KİLİDİ --- */
if (!window.original_switchAnTab) window.original_switchAnTab = window.switchAnTab;
window.switchAnTab = function(tabName, btn) {
    if (tabName === 'psycho' && !MembershipSystem.isPro()) {
        MembershipSystem.showUpsell(); // Yönlendir
        return; 
    }
    if(typeof window.original_switchAnTab === 'function') window.original_switchAnTab(tabName, btn);
};

/* --- 2. ZAMAN MAKİNESİ (3 HAK KURALI) --- */
if (!window.original_runStatisticalAnalysis) window.original_runStatisticalAnalysis = window.runStatisticalAnalysis;
window.runStatisticalAnalysis = async function() {
    let symbolInput = document.getElementById('statSymbol');
    if (!symbolInput || !symbolInput.value || symbolInput.value.trim() === "") { alert("⚠️ Lütfen sembol girin."); return; }
    
    // BURASI 3 HAKKI KONTROL EDER
    // 3'ten az ise izin verir, 3 dolunca Ayarlara yönlendirir.
    if (!MembershipSystem.checkUsageLimit('timeMachine', 3, 'Zaman Makinesi')) return; 
    
    if(typeof window.original_runStatisticalAnalysis === 'function') await window.original_runStatisticalAnalysis();
};

/* --- 3. TRADER KARNESİ (TAM KİLİT) --- */
if (!window.original_calculateTraderScore) window.original_calculateTraderScore = window.calculateTraderScore;
window.calculateTraderScore = function() {
    if (!MembershipSystem.isPro()) {
        let scoreEl = document.getElementById('pfScore'); 
        if (scoreEl && scoreEl.closest('.dash-card')) {
            let card = scoreEl.closest('.dash-card');
            card.style.position = 'relative';
            if (card.querySelector('.pro-lock-overlay')) card.querySelector('.pro-lock-overlay').remove();
            let overlay = document.createElement('div');
            overlay.className = 'pro-lock-overlay';
            overlay.style.cssText = `position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 16px; text-align: center; border:1px solid rgba(255,255,255,0.1); opacity: 1 !important;`;
            overlay.innerHTML = `<div style="margin-bottom:15px;"><i class="fas fa-lock" style="font-size:28px; color:#f59e0b;"></i></div><div style="color:white; font-weight:800; font-size:16px; margin-bottom:8px;">KARNE KİLİTLİ</div>
            <button onclick="MembershipSystem.redirectToSettings()" style="background: linear-gradient(90deg, #f59e0b, #d97706); color: white; border: none; padding: 10px 25px; border-radius: 20px; font-weight: 700; cursor: pointer;">PRO OL</button>`;
            card.appendChild(overlay);
        }
        return; 
    }
    if(typeof window.original_calculateTraderScore === 'function') window.original_calculateTraderScore();
    let locks = document.querySelectorAll('.pro-lock-overlay'); locks.forEach(l => l.remove());
};

/* --- 4. MALİYET SİHİRBAZI (VERİ GİZLEME) --- */
if (!window.original_populateAdvAvgAssets) window.original_populateAdvAvgAssets = window.populateAdvAvgAssets;
window.populateAdvAvgAssets = function() {
    const select = document.getElementById('advAvgSelect');
    if(!select) return;
    select.innerHTML = '<option value="-1">Manuel Giriş Yap / Seçiniz</option>';
    let assets = JSON.parse(localStorage.getItem('myPF_final')) || [];
    assets.forEach((a, i) => {
        let text = ""; let symbol = a.name || "Bilinmeyen"; 
        
        // SADECE PRO İSE FİYATI GÖSTER
        if (MembershipSystem.isPro()) { 
            let cost = parseFloat(a.buy); if(isNaN(cost)) cost = 0;
            let sym = a.origin === 'USD' ? '$' : '₺'; 
            text = `${symbol} (Ort: ${cost.toFixed(2)} ${sym})`; 
        } else { 
            // PRO DEĞİLSE FİYATI GİZLE
            text = `${symbol} (🔒 Kilitli Veri)`; 
        }
        select.innerHTML += `<option value="${i}">${text}</option>`;
    });
};

/* --- 5. MALİYET SİHİRBAZI (AUTO-FILL ENGELLEME) --- */
if (!window.original_fillAdvAvgData) window.original_fillAdvAvgData = window.fillAdvAvgData;
window.fillAdvAvgData = function(avg, amount, price) {
    // Pro değilse engelle ve yönlendir
    if (MembershipSystem.isPro()) { 
        if(typeof window.original_fillAdvAvgData === 'function') window.original_fillAdvAvgData(avg, amount, price); 
        return; 
    }
    
    // Pro değilse:
    MembershipSystem.showUpsell(); // Yönlendir
    
    // Inputları temizle ki kullanamasın
    if(document.getElementById('aaCurrentCost')) document.getElementById('aaCurrentCost').value = "";
    if(document.getElementById('aaCurrentAmount')) document.getElementById('aaCurrentAmount').value = "";
    if(document.getElementById('aaOldQty')) document.getElementById('aaOldQty').value = "";
    if(document.getElementById('aaOldPrice')) document.getElementById('aaOldPrice').value = "";
    let sel = document.getElementById('advAvgSelect'); if(sel) sel.value = "-1";
};

/* BAŞLATICI */
document.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
        MembershipSystem.refreshUI();
        if(typeof window.calculateTraderScore === 'function') window.calculateTraderScore(); 
        if(typeof window.populateAdvAvgAssets === 'function') window.populateAdvAvgAssets();
        
        if(typeof window.calcPsychoAnalysis === 'function') {
            window.calcPsychoAnalysis();
        }
    }, 500);
});

 
</script>

<script>
    /* --- 1. SERVICE WORKER KAYDI (PWA ve Bildirim İçin Şart) --- */
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('sw.js')
            .then(function(registration) {
                console.log('✅ Service Worker yüklendi:', registration.scope);
            }, function(err) {
                console.log('❌ Service Worker hatası:', err);
            });
        });
    }

    /* --- 2. AYARLAR SAYFASI: TEST BİLDİRİM BUTONU --- */
    document.addEventListener("DOMContentLoaded", () => {
        // Butonu bul
        const testBtn = document.getElementById('btnTestNotify');

        if (testBtn) {
            // Tıklama olayını ekle
            testBtn.onclick = function() {
                // İzin kontrolü
                if ("Notification" in window) {
                    if (Notification.permission === "granted") {
                        sendDemo(); 
                    } else if (Notification.permission !== "denied") {
                        Notification.requestPermission().then(permission => {
                            if (permission === "granted") sendDemo();
                        });
                    } else {
                        alert("⚠️ Bildirim izni tarayıcıdan engellenmiş. Ayarlardan izin verin.");
                    }
                } else {
                    alert("Tarayıcınız bildirim desteklemiyor.");
                }
            };
        }

        // Demo Gönderme Fonksiyonu
        function sendDemo() {
            if(typeof addNotification === 'function') {
                // Hem uygulama içine hem telefona bildirim yolla
                addNotification('success', '🔔 Test Başarılı', 'Bildirim sistemi sorunsuz çalışıyor!');
            } else {
                alert("HATA: addNotification fonksiyonu bulunamadı.");
            }
        }
    });
</script>

<!-- === UYGULAMA KİLİDİ SİSTEMİ === -->
<script>
const AppLock = {
    // Sabitler
    PIN_KEY: 'tradevia_app_pin',
    LOCK_ENABLED_KEY: 'tradevia_lock_enabled',
    MAX_ATTEMPTS: 5,
    LOCKOUT_TIME: 30000, // 30 saniye
    
    // Durum
    enteredPin: '',
    attempts: 0,
    isLocked: false,
    setupMode: null, // 'new', 'change', 'verify'
    tempPin: '',
    
    // === BAŞLATMA ===
    init: function() {
        // Sayfa yüklendiğinde kilit kontrolü
        if (this.isLockEnabled() && this.hasPin()) {
            this.showLockScreen();
        }
        
        // Ayarlar sayfası UI'ını güncelle
        this.updateSettingsUI();
        this.updateSecurityBadge();
    },
    
    // === KİLİT DURUMU ===
    isLockEnabled: function() {
        return localStorage.getItem(this.LOCK_ENABLED_KEY) === 'true';
    },
    
    hasPin: function() {
        return localStorage.getItem(this.PIN_KEY) !== null;
    },
    
    getStoredPin: function() {
        return localStorage.getItem(this.PIN_KEY);
    },
    
    // === KİLİT EKRANI ===
    showLockScreen: function() {
        const lockScreen = document.getElementById('lock-screen');
        if (lockScreen) {
            lockScreen.classList.add('active');
            this.isLocked = true;
            this.enteredPin = '';
            this.updatePinDots();
            document.getElementById('lockErrorMsg').innerText = '';
        }
    },
    
    hideLockScreen: function() {
        const lockScreen = document.getElementById('lock-screen');
        if (lockScreen) {
            lockScreen.classList.add('hidden');
            setTimeout(() => {
                lockScreen.classList.remove('active', 'hidden');
            }, 400);
            this.isLocked = false;
            this.enteredPin = '';
            this.attempts = 0;
        }
    },
    
    // === PIN GİRİŞİ ===
    enterDigit: function(digit) {
        if (this.enteredPin.length >= 4) return;
        
        // Haptic feedback
        if (navigator.vibrate) navigator.vibrate(10);
        
        this.enteredPin += digit;
        this.updatePinDots();
        
        // 4 hane girilince kontrol et
        if (this.enteredPin.length === 4) {
            setTimeout(() => this.verifyPin(), 200);
        }
    },
    
    deleteDigit: function() {
        if (this.enteredPin.length > 0) {
            if (navigator.vibrate) navigator.vibrate(10);
            this.enteredPin = this.enteredPin.slice(0, -1);
            this.updatePinDots();
        }
    },
    
    updatePinDots: function() {
        const dots = document.querySelectorAll('#pinDots .pin-dot');
        dots.forEach((dot, index) => {
            dot.classList.remove('filled', 'error');
            if (index < this.enteredPin.length) {
                dot.classList.add('filled');
            }
        });
    },
    
    verifyPin: function() {
        const storedPin = this.getStoredPin();
        
        if (this.enteredPin === storedPin) {
            // Doğru PIN
            if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
            this.hideLockScreen();
            this.attempts = 0;
        } else {
            // Yanlış PIN
            this.attempts++;
            this.showPinError();
            
            if (this.attempts >= this.MAX_ATTEMPTS) {
                this.handleLockout();
            }
        }
    },
    
    showPinError: function() {
        const dots = document.querySelectorAll('#pinDots .pin-dot');
        dots.forEach(dot => dot.classList.add('error'));
        
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        
        const remaining = this.MAX_ATTEMPTS - this.attempts;
        document.getElementById('lockErrorMsg').innerText = 
            remaining > 0 ? `Yanlış PIN! ${remaining} deneme hakkınız kaldı.` : '';
        
        setTimeout(() => {
            this.enteredPin = '';
            this.updatePinDots();
        }, 500);
    },
    
    handleLockout: function() {
        document.getElementById('lockErrorMsg').innerText = 
            `Çok fazla yanlış deneme! ${this.LOCKOUT_TIME / 1000} saniye bekleyin.`;
        
        // Numpad'i devre dışı bırak
        document.querySelectorAll('.numpad-btn').forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = '0.5';
        });
        
        setTimeout(() => {
            this.attempts = 0;
            document.querySelectorAll('.numpad-btn').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
            });
            document.getElementById('lockErrorMsg').innerText = '';
        }, this.LOCKOUT_TIME);
    },
    
    // === ŞİFREMİ UNUTTUM ===
    forgotPin: function() {
        const confirmed = confirm(
            '⚠️ DİKKAT!\n\n' +
            'PIN\'inizi sıfırlamak için tüm uygulama verilerinizi silmeniz gerekecektir.\n\n' +
            'Portföy, işlem geçmişi ve tüm ayarlarınız kalıcı olarak silinecektir.\n\n' +
            'Devam etmek istiyor musunuz?'
        );
        
        if (confirmed) {
            const doubleConfirm = confirm(
                '🚨 SON UYARI!\n\n' +
                'Bu işlem geri alınamaz. Tüm verileriniz silinecek.\n\n' +
                'Emin misiniz?'
            );
            
            if (doubleConfirm) {
                // Tüm verileri sil
                localStorage.clear();
                sessionStorage.clear();
                alert('✅ Veriler silindi. Uygulama yeniden başlatılıyor...');
                location.reload();
            }
        }
    },
    
    // === AYARLAR SAYFASI ===
    toggleLock: function(enabled) {
        if (enabled) {
            // Kilit açılıyor, PIN oluştur
            if (!this.hasPin()) {
                this.openSetupModal('new');
            } else {
                localStorage.setItem(this.LOCK_ENABLED_KEY, 'true');
                this.updateSettingsUI();
                this.updateSecurityBadge();
            }
        } else {
            // Kilit kapatılıyor, PIN'i doğrula
            if (this.hasPin()) {
                this.openSetupModal('verify-disable');
            } else {
                localStorage.setItem(this.LOCK_ENABLED_KEY, 'false');
                this.updateSettingsUI();
                this.updateSecurityBadge();
            }
        }
    },
    
    openChangePin: function() {
        this.openSetupModal('change');
    },
    
    removePin: function() {
        this.openSetupModal('verify-remove');
    },
    
    // === SETUP MODAL ===
    openSetupModal: function(mode) {
        // Sadece yeni bir akış başlıyorsa tempPin'i sıfırla
        // confirm moduna geçerken tempPin'i KORUMALIYZ
        if (mode !== 'confirm') {
            this.setupMode = mode;
        } else {
            this.setupMode = 'confirm';
        }
        
        // enteredPin her zaman sıfırlanmalı (yeni giriş için)
        this.enteredPin = '';
        
        // tempPin sadece 'new' modunda sıfırlanmalı
        if (mode === 'new') {
            this.tempPin = '';
        }
        
        const modal = document.getElementById('pinSetupModal');
        const content = document.getElementById('pinSetupContent');
        
        let title, desc, dotsCount = 4;
        
        switch(mode) {
            case 'new':
                title = '🔐 Yeni PIN Oluştur';
                desc = 'Uygulamanızı korumak için 4 haneli bir PIN belirleyin.';
                break;
            case 'confirm':
                title = '✓ PIN\'i Onayla';
                desc = 'PIN kodunuzu tekrar girin.';
                break;
            case 'change':
                title = '🔑 Mevcut PIN';
                desc = 'Önce mevcut PIN kodunuzu girin.';
                break;
            case 'new-after-verify':
                title = '🆕 Yeni PIN';
                desc = 'Yeni PIN kodunuzu girin.';
                break;
            case 'verify-disable':
                title = '🔓 PIN Doğrula';
                desc = 'Kilidi kapatmak için PIN kodunuzu girin.';
                break;
            case 'verify-remove':
                title = '🗑️ PIN Doğrula';
                desc = 'PIN\'i kaldırmak için mevcut kodunuzu girin.';
                break;
        }
        
        content.innerHTML = `
            <div style="font-size: 32px; margin-bottom: 15px;">${title.split(' ')[0]}</div>
            <div class="pin-setup-title">${title.substring(title.indexOf(' ') + 1)}</div>
            <div class="pin-setup-desc">${desc}</div>
            
            <div class="pin-dots" id="setupPinDots" style="justify-content: center; margin: 25px 0;">
                ${Array(dotsCount).fill('<div class="pin-dot"></div>').join('')}
            </div>
            
            <div class="pin-numpad" style="max-width: 240px; margin: 0 auto;">
                <button class="numpad-btn" onclick="AppLock.setupEnterDigit('1')">1</button>
                <button class="numpad-btn" onclick="AppLock.setupEnterDigit('2')">2</button>
                <button class="numpad-btn" onclick="AppLock.setupEnterDigit('3')">3</button>
                <button class="numpad-btn" onclick="AppLock.setupEnterDigit('4')">4</button>
                <button class="numpad-btn" onclick="AppLock.setupEnterDigit('5')">5</button>
                <button class="numpad-btn" onclick="AppLock.setupEnterDigit('6')">6</button>
                <button class="numpad-btn" onclick="AppLock.setupEnterDigit('7')">7</button>
                <button class="numpad-btn" onclick="AppLock.setupEnterDigit('8')">8</button>
                <button class="numpad-btn" onclick="AppLock.setupEnterDigit('9')">9</button>
                <button class="numpad-btn action" onclick="AppLock.closeSetupModal()"><i class="fas fa-times"></i></button>
                <button class="numpad-btn" onclick="AppLock.setupEnterDigit('0')">0</button>
                <button class="numpad-btn action" onclick="AppLock.setupDeleteDigit()"><i class="fas fa-backspace"></i></button>
            </div>
            
            <div id="setupErrorMsg" style="color: #ef4444; font-size: 12px; margin-top: 15px; min-height: 18px;"></div>
        `;
        
        modal.classList.add('active');
    },
    
    closeSetupModal: function() {
        const modal = document.getElementById('pinSetupModal');
        modal.classList.remove('active');
        this.setupMode = null;
        this.tempPin = '';
        this.enteredPin = '';
        
        // Toggle'ı senkronize et
        const toggle = document.getElementById('appLockToggle');
        if (toggle) {
            toggle.checked = this.isLockEnabled() && this.hasPin();
        }
        
        this.updateSettingsUI();
    },
    
    setupEnterDigit: function(digit) {
        if (this.enteredPin.length >= 4) return;
        
        if (navigator.vibrate) navigator.vibrate(10);
        
        this.enteredPin += digit;
        this.updateSetupDots();
        
        if (this.enteredPin.length === 4) {
            setTimeout(() => this.processSetupPin(), 200);
        }
    },
    
    setupDeleteDigit: function() {
        if (this.enteredPin.length > 0) {
            if (navigator.vibrate) navigator.vibrate(10);
            this.enteredPin = this.enteredPin.slice(0, -1);
            this.updateSetupDots();
        }
    },
    
    updateSetupDots: function() {
        const dots = document.querySelectorAll('#setupPinDots .pin-dot');
        dots.forEach((dot, index) => {
            dot.classList.remove('filled', 'error');
            if (index < this.enteredPin.length) {
                dot.classList.add('filled');
            }
        });
    },
    
    processSetupPin: function() {
        const errorEl = document.getElementById('setupErrorMsg');
        
        switch(this.setupMode) {
            case 'new':
            case 'new-after-verify':
                // Basit PIN kontrolü
                if (['0000', '1234', '1111', '2222', '3333', '4444', '5555', '6666', '7777', '8888', '9999'].includes(this.enteredPin)) {
                    this.showSetupError('Bu PIN çok kolay tahmin edilebilir. Farklı bir PIN seçin.');
                    return;
                }
                this.tempPin = this.enteredPin;
                this.enteredPin = '';
                this.setupMode = 'confirm';
                this.openSetupModal('confirm');
                break;
                
            case 'confirm':
                if (this.enteredPin === this.tempPin) {
                    // PIN'i kaydet
                    localStorage.setItem(this.PIN_KEY, this.enteredPin);
                    localStorage.setItem(this.LOCK_ENABLED_KEY, 'true');
                    
                    if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
                    
                    this.closeSetupModal();
                    this.updateSettingsUI();
                    this.updateSecurityBadge();
                    
                    // Başarı bildirimi
                    if (typeof addNotification === 'function') {
                        addNotification('success', '🔐 PIN Oluşturuldu', 'Uygulama kilidi aktif edildi.');
                    }
                } else {
                    this.showSetupError('PIN\'ler eşleşmiyor. Tekrar deneyin.');
                    this.tempPin = '';
                    this.enteredPin = '';
                    setTimeout(() => {
                        this.setupMode = 'new';
                        this.openSetupModal('new');
                    }, 1000);
                }
                break;
                
            case 'change':
                if (this.enteredPin === this.getStoredPin()) {
                    this.enteredPin = '';
                    this.setupMode = 'new-after-verify';
                    this.openSetupModal('new-after-verify');
                } else {
                    this.showSetupError('Yanlış PIN!');
                }
                break;
                
            case 'verify-disable':
                if (this.enteredPin === this.getStoredPin()) {
                    localStorage.setItem(this.LOCK_ENABLED_KEY, 'false');
                    this.closeSetupModal();
                    this.updateSettingsUI();
                    this.updateSecurityBadge();
                    
                    if (typeof addNotification === 'function') {
                        addNotification('warn', '🔓 Kilit Kapatıldı', 'Uygulama kilidi devre dışı bırakıldı.');
                    }
                } else {
                    this.showSetupError('Yanlış PIN!');
                }
                break;
                
            case 'verify-remove':
                if (this.enteredPin === this.getStoredPin()) {
                    localStorage.removeItem(this.PIN_KEY);
                    localStorage.setItem(this.LOCK_ENABLED_KEY, 'false');
                    this.closeSetupModal();
                    this.updateSettingsUI();
                    this.updateSecurityBadge();
                    
                    if (typeof addNotification === 'function') {
                        addNotification('danger', '🗑️ PIN Kaldırıldı', 'Uygulama kilidi tamamen kaldırıldı.');
                    }
                } else {
                    this.showSetupError('Yanlış PIN!');
                }
                break;
        }
    },
    
    showSetupError: function(msg) {
        const dots = document.querySelectorAll('#setupPinDots .pin-dot');
        dots.forEach(dot => dot.classList.add('error'));
        
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        
        document.getElementById('setupErrorMsg').innerText = msg;
        
        setTimeout(() => {
            this.enteredPin = '';
            this.updateSetupDots();
            document.getElementById('setupErrorMsg').innerText = '';
        }, 1500);
    },
    
    // === UI GÜNCELLEME ===
    updateSettingsUI: function() {
        const toggle = document.getElementById('appLockToggle');
        const btnRow = document.getElementById('securityBtnRow');
        const statusDisplay = document.getElementById('pinStatusDisplay');
        
        const isEnabled = this.isLockEnabled() && this.hasPin();
        
        if (toggle) {
            toggle.checked = isEnabled;
        }
        
        if (btnRow) {
            btnRow.style.display = isEnabled ? 'flex' : 'none';
        }
        
        if (statusDisplay) {
            if (isEnabled) {
                statusDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 10px;">
                        <i class="fas fa-check-circle" style="color: #10b981; font-size: 18px;"></i>
                        <div>
                            <div style="font-size: 13px; font-weight: 600; color: #10b981;">Koruma Aktif</div>
                            <div style="font-size: 11px; color: #94a3b8;">Uygulamanız PIN ile korunuyor</div>
                        </div>
                    </div>
                `;
            } else if (this.hasPin()) {
                statusDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); border-radius: 10px;">
                        <i class="fas fa-pause-circle" style="color: #f59e0b; font-size: 18px;"></i>
                        <div>
                            <div style="font-size: 13px; font-weight: 600; color: #f59e0b;">Kilit Devre Dışı</div>
                            <div style="font-size: 11px; color: #94a3b8;">PIN mevcut ama kilit kapalı</div>
                        </div>
                    </div>
                `;
            } else {
                statusDisplay.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 12px; background: rgba(148, 163, 184, 0.1); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 10px;">
                        <i class="fas fa-shield-alt" style="color: #94a3b8; font-size: 18px;"></i>
                        <div>
                            <div style="font-size: 13px; font-weight: 600; color: #94a3b8;">Koruma Yok</div>
                            <div style="font-size: 11px; color: #64748b;">PIN oluşturarak uygulamanızı koruyun</div>
                        </div>
                    </div>
                `;
            }
        }
    },
    
    updateSecurityBadge: function() {
        const badge = document.getElementById('securityStatusBadge');
        if (badge) {
            const isEnabled = this.isLockEnabled() && this.hasPin();
            if (isEnabled) {
                badge.innerHTML = '<span class="pin-status-badge active"><i class="fas fa-check"></i> Aktif</span>';
            } else {
                badge.innerHTML = '<span class="pin-status-badge inactive"><i class="fas fa-minus"></i> Kapalı</span>';
            }
        }
    }
};

// Sayfa yüklendiğinde başlat
document.addEventListener('DOMContentLoaded', function() {
    // Splash screen bittikten sonra kilit kontrolü
    setTimeout(function() {
        AppLock.init();
    }, 2000); // Splash screen animasyonunun bitmesini bekle
});

// Uygulama arka plandan döndüğünde kilit kontrolü (Mobil için)
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
        if (AppLock.isLockEnabled() && AppLock.hasPin() && !AppLock.isLocked) {
            AppLock.showLockScreen();
        }
    }
});

/* ======================================================
   TRADEVİA DAVRANIŞ TAKİP & AI KOÇ SİSTEMİ
   Kullanıcının TÜM davranışlarını analiz eder
   ====================================================== */

// ==========================================
// 1. DAVRANIŞ TAKİP SİSTEMİ (Behavior Tracker)
// ==========================================
const BehaviorTracker = {
    STORAGE_KEY: 'tv_behavior_data',
    
    // Varsayılan veri yapısı
    getDefaultData: function() {
        return {
            // Sayfa/Sekme kullanımı
            pageVisits: {}, // { portfolio: 150, market: 80, ... }
            tabVisits: {}, // { kripto: 50, hisse: 30, ... }
            
            // Özellik kullanımı
            featureUsage: {}, // { search: 45, addAsset: 20, ... }
            
            // Arama geçmişi
            searchHistory: [], // ['BTC', 'ETH', 'THYAO', ...]
            searchCounts: {}, // { BTC: 15, ETH: 10, ... }
            
            // Zaman takibi
            sessionTimes: [], // [{ date: '01.01.2025', duration: 1800 }, ...]
            pageTimeSpent: {}, // { portfolio: 3600, market: 1200, ... }
            
            // Tıklama/Etkileşim
            clickCounts: {}, // { refreshBtn: 30, settingsBtn: 10, ... }
            
            // İşlem davranışları
            tradePatterns: {
                hourlyTrades: {}, // Saat bazlı işlem dağılımı
                dailyTrades: {}, // Gün bazlı işlem dağılımı
                quickSells: 0, // Hızlı satışlar (<24 saat)
                avgHoldTime: 0
            },
            
            // Son güncelleme
            lastUpdate: Date.now(),
            totalSessions: 0
        };
    },
    
    // Veriyi yükle
    load: function() {
        try {
            let data = localStorage.getItem(this.STORAGE_KEY);
            return data ? JSON.parse(data) : this.getDefaultData();
        } catch(e) {
            return this.getDefaultData();
        }
    },
    
    // Veriyi kaydet
    save: function(data) {
        try {
            data.lastUpdate = Date.now();
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
        } catch(e) {}
    },
    
    // Sayfa ziyaretini kaydet
    trackPageVisit: function(pageName) {
        let data = this.load();
        data.pageVisits[pageName] = (data.pageVisits[pageName] || 0) + 1;
        this.save(data);
    },
    
    // Sekme ziyaretini kaydet
    trackTabVisit: function(tabName) {
        let data = this.load();
        data.tabVisits[tabName] = (data.tabVisits[tabName] || 0) + 1;
        this.save(data);
    },
    
    // Özellik kullanımını kaydet
    trackFeatureUse: function(featureName) {
        let data = this.load();
        data.featureUsage[featureName] = (data.featureUsage[featureName] || 0) + 1;
        this.save(data);
    },
    
    // Arama kaydı
    trackSearch: function(query) {
        if (!query || query.length < 2) return;
        let data = this.load();
        let q = query.toUpperCase().trim();
        
        // Son 100 aramayı tut
        data.searchHistory.unshift(q);
        if (data.searchHistory.length > 100) data.searchHistory.pop();
        
        // Sayacı artır
        data.searchCounts[q] = (data.searchCounts[q] || 0) + 1;
        this.save(data);
    },
    
    // Tıklama kaydı
    trackClick: function(elementId) {
        let data = this.load();
        data.clickCounts[elementId] = (data.clickCounts[elementId] || 0) + 1;
        this.save(data);
    },
    
    // Oturum süresini kaydet
    trackSessionTime: function(seconds) {
        let data = this.load();
        let today = new Date().toLocaleDateString('tr-TR');
        
        let existing = data.sessionTimes.find(s => s.date === today);
        if (existing) {
            existing.duration += seconds;
        } else {
            data.sessionTimes.push({ date: today, duration: seconds });
        }
        
        // Son 30 günü tut
        if (data.sessionTimes.length > 30) data.sessionTimes.shift();
        data.totalSessions++;
        this.save(data);
    },
    
    // Sayfa süresini kaydet
    trackPageTime: function(pageName, seconds) {
        let data = this.load();
        data.pageTimeSpent[pageName] = (data.pageTimeSpent[pageName] || 0) + seconds;
        this.save(data);
    },
    
    // Özet istatistikler
    getSummary: function() {
        let data = this.load();
        
        // En çok ziyaret edilen sayfa
        let topPage = Object.entries(data.pageVisits).sort((a,b) => b[1] - a[1])[0];
        
        // En çok kullanılan özellik
        let topFeature = Object.entries(data.featureUsage).sort((a,b) => b[1] - a[1])[0];
        
        // En çok aranan
        let topSearch = Object.entries(data.searchCounts).sort((a,b) => b[1] - a[1])[0];
        
        // Toplam süre
        let totalTime = data.sessionTimes.reduce((a, s) => a + s.duration, 0);
        
        // En uzun kalınan sayfa
        let longestPage = Object.entries(data.pageTimeSpent).sort((a,b) => b[1] - a[1])[0];
        
        return {
            topPage: topPage ? topPage[0] : null,
            topPageCount: topPage ? topPage[1] : 0,
            topFeature: topFeature ? topFeature[0] : null,
            topFeatureCount: topFeature ? topFeature[1] : 0,
            topSearch: topSearch ? topSearch[0] : null,
            topSearchCount: topSearch ? topSearch[1] : 0,
            totalTimeMinutes: Math.round(totalTime / 60),
            longestPage: longestPage ? longestPage[0] : null,
            longestPageMinutes: longestPage ? Math.round(longestPage[1] / 60) : 0,
            totalSessions: data.totalSessions,
            searchHistory: data.searchHistory.slice(0, 20),
            pageVisits: data.pageVisits,
            featureUsage: data.featureUsage
        };
    }
};

// ==========================================
// 2. OTOMATİK TAKİP BAŞLAT
// ==========================================
(function initBehaviorTracking() {
    let currentPage = 'portfolio';
    let pageStartTime = Date.now();
    let sessionStartTime = Date.now();
    
    // Sayfa değişikliğini takip et
    const origSwitchPage = window.switchPage;
    if (typeof origSwitchPage === 'function') {
        window.switchPage = function(pageId, btn) {
            // Önceki sayfanın süresini kaydet
            let elapsed = Math.round((Date.now() - pageStartTime) / 1000);
            if (elapsed > 2) BehaviorTracker.trackPageTime(currentPage, elapsed);
            
            // Yeni sayfa
            currentPage = pageId;
            pageStartTime = Date.now();
            BehaviorTracker.trackPageVisit(pageId);
            
            return origSwitchPage.apply(this, arguments);
        };
    }
    
    // Piyasa sekme değişikliğini takip et
    const origLoadMarket = window.loadMarketCategory;
    if (typeof origLoadMarket === 'function') {
        window.loadMarketCategory = function(cat) {
            BehaviorTracker.trackTabVisit(cat);
            return origLoadMarket.apply(this, arguments);
        };
    }
    
    // Arama takibi
    const origSearch = window.handleSmartSearch || window.performSearch;
    if (typeof origSearch === 'function') {
        window.handleSmartSearch = function(query) {
            BehaviorTracker.trackSearch(query);
            BehaviorTracker.trackFeatureUse('search');
            return origSearch.apply(this, arguments);
        };
    }
    
    // Oturum süresini kaydet (sayfa kapatılırken)
    window.addEventListener('beforeunload', function() {
        let sessionDuration = Math.round((Date.now() - sessionStartTime) / 1000);
        if (sessionDuration > 10) BehaviorTracker.trackSessionTime(sessionDuration);
        
        let pageElapsed = Math.round((Date.now() - pageStartTime) / 1000);
        if (pageElapsed > 2) BehaviorTracker.trackPageTime(currentPage, pageElapsed);
    });
    
    // Belirli butonlara tıklama takibi
    document.addEventListener('click', function(e) {
        let target = e.target.closest('button, .btn-main, .nav-item, .chart-filter-btn');
        if (target) {
            let id = target.id || target.className.split(' ')[0] || 'unknown';
            BehaviorTracker.trackClick(id);
        }
    });
})();

// ==========================================
// 3. TÜM VERİLERİ TOPLAYAN ANALİZ MOTORU
// ==========================================
const AIDataCollector = {
    
    collectAll: function() {
        // 1. İşlem Geçmişi
        let tradeHistory = JSON.parse(localStorage.getItem('tm_full_trade_history')) || [];
        let sales = tradeHistory.filter(t => t.type === 'SATIM');
        let buys = tradeHistory.filter(t => t.type === 'ALIM');
        
        // 2. Portföy
        let portfolio = JSON.parse(localStorage.getItem('myPF_final')) || [];
        let cash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
        
        // 3. Davranış verileri
        let behavior = BehaviorTracker.getSummary();
        
        // 4. Hedefler
        let mainGoal = parseFloat(localStorage.getItem('tradevia_main_goal')) || 0;
        let goals = JSON.parse(localStorage.getItem('tv_goals')) || [];
        
        // 5. Alarmlar
        let alarms = JSON.parse(localStorage.getItem('tm_alarms')) || [];
        
        // 6. Ayarlar
        let settings = JSON.parse(localStorage.getItem('tradevia_settings')) || {};
        
        // 7. Günlük takip
        let dailyTracking = JSON.parse(localStorage.getItem('tm_daily_tracking')) || [];
        
        // İşlem metrikleri hesapla
        let winRate = sales.length > 0 ? (sales.filter(s => parseFloat(s.pnl) > 0).length / sales.length * 100) : 0;
        let totalPnL = sales.reduce((a, t) => a + parseFloat(t.pnl || 0), 0);
        
        // Tutma süreleri
        let holdDays = [];
        sales.forEach(s => {
            let buy = buys.find(b => b.sym === s.sym);
            if (buy) {
                let d1 = this.parseDate(buy.date);
                let d2 = this.parseDate(s.date);
                let days = (d2 - d1) / (1000*60*60*24);
                if (days >= 0 && days < 1000) holdDays.push(days);
            }
        });
        let avgHold = holdDays.length > 0 ? holdDays.reduce((a,b) => a+b, 0) / holdDays.length : 0;
        
        // Panik satış
        let panicSells = 0;
        sales.forEach(s => {
            let buy = buys.find(b => b.sym === s.sym);
            if (buy && parseFloat(s.pnl) < 0) {
                let days = (this.parseDate(s.date) - this.parseDate(buy.date)) / (1000*60*60*24);
                if (days < 3 && days >= 0) panicSells++;
            }
        });
        
        // İşlem yapılan varlıklar
        let tradedAssets = {};
        tradeHistory.forEach(t => {
            tradedAssets[t.sym] = (tradedAssets[t.sym] || 0) + 1;
        });
        let topTradedAsset = Object.entries(tradedAssets).sort((a,b) => b[1] - a[1])[0];
        
        // Gün bazlı işlem dağılımı
        let dayDistribution = {};
        tradeHistory.forEach(t => {
            let d = new Date(t.date.split('.').reverse().join('-'));
            let day = d.toLocaleDateString('tr-TR', { weekday: 'long' });
            dayDistribution[day] = (dayDistribution[day] || 0) + 1;
        });
        let mostActiveDay = Object.entries(dayDistribution).sort((a,b) => b[1] - a[1])[0];
        
        return {
            // İşlem verileri
            totalTrades: tradeHistory.length,
            totalBuys: buys.length,
            totalSales: sales.length,
            winRate,
            totalPnL,
            avgHold,
            panicSells,
            topTradedAsset: topTradedAsset ? topTradedAsset[0] : null,
            topTradedCount: topTradedAsset ? topTradedAsset[1] : 0,
            uniqueAssets: Object.keys(tradedAssets).length,
            mostActiveDay: mostActiveDay ? mostActiveDay[0] : null,
            
            // Portföy verileri
            portfolioSize: portfolio.length,
            cashBalance: cash,
            
            // Davranış verileri
            behavior,
            
            // Hedef verileri
            mainGoal,
            goalsCount: goals.length,
            
            // Alarm verileri
            alarmsCount: alarms.length,
            
            // Diğer
            dailyTrackingDays: dailyTracking.length,
            currency: settings.currency || 'TRY'
        };
    },
    
    parseDate: function(dateStr) {
        if (!dateStr) return new Date();
        let parts = dateStr.split('.');
        if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
        return new Date(dateStr);
    }
};

// ==========================================
// 4. GELİŞMİŞ AI KOÇ MOTORU
// ==========================================
const AdvancedAICoach = {
    
    // Trader tipini belirle
    classifyTrader: function(data) {
        if (data.totalTrades < 5) return { emoji: '🆕', name: 'Yeni', color: '#64748b' };
        
        let scores = { scalper: 0, swing: 0, investor: 0, analyst: 0 };
        
        // İşlem sıklığına göre
        let tradesPerDay = data.behavior.totalSessions > 0 ? data.totalTrades / Math.max(data.behavior.totalSessions, 1) : 0;
        if (tradesPerDay > 0.5) scores.scalper += 30;
        else if (tradesPerDay > 0.1) scores.swing += 25;
        else scores.investor += 30;
        
        // Tutma süresine göre
        if (data.avgHold < 3) scores.scalper += 25;
        else if (data.avgHold < 14) scores.swing += 25;
        else scores.investor += 30;
        
        // Analiz sayfası kullanımına göre
        let analysisVisits = data.behavior.pageVisits['analysis'] || 0;
        let totalVisits = Object.values(data.behavior.pageVisits).reduce((a,b) => a+b, 0) || 1;
        if (analysisVisits / totalVisits > 0.3) scores.analyst += 35;
        
        // Piyasa takibi
        let marketVisits = data.behavior.pageVisits['market'] || 0;
        if (marketVisits / totalVisits > 0.4) scores.scalper += 15;
        
        let maxScore = Math.max(...Object.values(scores));
        let type = Object.keys(scores).find(k => scores[k] === maxScore);
        
        let types = {
            scalper: { emoji: '⚡', name: 'Scalper', color: '#f59e0b' },
            swing: { emoji: '🎯', name: 'Swing', color: '#3b82f6' },
            investor: { emoji: '🏔️', name: 'Yatırımcı', color: '#10b981' },
            analyst: { emoji: '📊', name: 'Analist', color: '#8b5cf6' }
        };
        
        return types[type] || types.swing;
    },
    
    // Risk seviyesi
    classifyRisk: function(data) {
        let risk = 50;
        
        if (data.panicSells > 3) risk += 20;
        if (data.avgHold < 3) risk += 15;
        if (data.uniqueAssets < 3) risk += 15;
        if (data.portfolioSize > 10) risk -= 10;
        if (data.avgHold > 14) risk -= 15;
        if (data.winRate > 60) risk -= 10;
        
        risk = Math.max(0, Math.min(100, risk));
        
        if (risk <= 35) return { text: 'Düşük', color: '#10b981' };
        if (risk <= 65) return { text: 'Orta', color: '#f59e0b' };
        return { text: 'Yüksek', color: '#ef4444' };
    },
    
    // Odak alanı
    detectFocus: function(data) {
        // En çok aranan varlığa göre
        if (data.behavior.topSearch) {
            let search = data.behavior.topSearch.toUpperCase();
            if (search.includes('BTC') || search.includes('ETH') || search.includes('USDT')) return { text: 'Kripto', color: '#f59e0b' };
            if (search.includes('.IS') || search.includes('THYAO') || search.includes('GARAN')) return { text: 'Hisse', color: '#3b82f6' };
        }
        
        // En çok işlem yapılan varlığa göre
        if (data.topTradedAsset) {
            if (data.topTradedAsset.includes('USDT') || data.topTradedAsset.includes('BTC')) return { text: 'Kripto', color: '#f59e0b' };
            if (data.topTradedAsset.includes('.IS')) return { text: 'Hisse', color: '#3b82f6' };
        }
        
        // Piyasa sekmesi kullanımına göre
        let tabs = data.behavior.tabVisits || {};
        if ((tabs.kripto || 0) > (tabs.hisse || 0)) return { text: 'Kripto', color: '#f59e0b' };
        if ((tabs.hisse || 0) > (tabs.kripto || 0)) return { text: 'Hisse', color: '#3b82f6' };
        
        return { text: 'Karma', color: '#8b5cf6' };
    },
    
    // AI Skoru
    calculateScore: function(data) {
        if (data.totalTrades < 3) return 50;
        
        let score = 50;
        
        // Win rate
        score += (data.winRate - 50) * 0.4;
        
        // Düzenli kullanım
        if (data.behavior.totalSessions > 10) score += 5;
        if (data.behavior.totalTimeMinutes > 60) score += 5;
        
        // Çeşitlilik
        if (data.uniqueAssets >= 5) score += 10;
        
        // Olumsuz davranışlar
        score -= data.panicSells * 3;
        
        // Hedef belirleme
        if (data.mainGoal > 0) score += 5;
        if (data.goalsCount > 0) score += 5;
        
        // Alarm kullanımı
        if (data.alarmsCount > 0) score += 3;
        
        return Math.max(0, Math.min(100, Math.round(score)));
    },
    
    // Ana mesaj oluştur
    generateMainMessage: function(data) {
        if (data.totalTrades < 3 && data.behavior.totalSessions < 3) {
            return `👋 <b>Hoş geldin!</b><br><br>Seni tanımaya yeni başlıyorum. Uygulama kullandıkça ve işlem yaptıkça sana özel öneriler sunacağım.<br><br>💡 Şimdilik: Portföyünü oluştur, piyasaları keşfet!`;
        }
        
        let messages = [];
        let traderType = this.classifyTrader(data);
        let focus = this.detectFocus(data);
        
        // Kişiselleştirilmiş selamlama
        messages.push(`Merhaba! Seni <b style="color:${traderType.color}">${traderType.emoji} ${traderType.name}</b> olarak tanımlıyorum.`);
        
        // Odak alanı
        if (focus.text !== 'Karma') {
            messages.push(`📍 Odak alanın: <b style="color:${focus.color}">${focus.text}</b> piyasası.`);
        }
        
        // Davranış bazlı öneriler
        if (data.behavior.topPage === 'market' && data.totalTrades < 5) {
            messages.push(`👀 Piyasayı çok takip ediyorsun ama az işlem yapıyorsun. Analiz felci mi yaşıyorsun?`);
        }
        
        if (data.panicSells > 2) {
            messages.push(`⚠️ <b>${data.panicSells}</b> panik satış tespit ettim. Sabırlı olmayı öğrenmelisin.`);
        }
        
        // Win rate
        if (data.winRate > 60 && data.totalSales >= 5) {
            messages.push(`🏆 <b>%${data.winRate.toFixed(0)}</b> win rate ile harika gidiyorsun!`);
        } else if (data.winRate < 40 && data.totalSales >= 5) {
            messages.push(`📉 Win rate düşük (%${data.winRate.toFixed(0)}). Giriş stratejini gözden geçir.`);
        }
        
        // En aktif gün
        if (data.mostActiveDay) {
            messages.push(`📅 En aktif olduğun gün: <b>${data.mostActiveDay}</b>`);
        }
        
        return messages.join('<br><br>');
    },
    
    // Detaylı analizler
    analyzeStrengths: function(data) {
        let strengths = [];
        
        if (data.winRate > 55 && data.totalSales >= 5) 
            strengths.push(`✅ <b>Yüksek Başarı:</b> %${data.winRate.toFixed(0)} win rate ortalamanın üstünde.`);
        
        if (data.avgHold > 7) 
            strengths.push(`✅ <b>Sabırlı:</b> Ortalama ${Math.round(data.avgHold)} gün tutabiliyorsun.`);
        
        if (data.uniqueAssets >= 5) 
            strengths.push(`✅ <b>Çeşitlendirilmiş:</b> ${data.uniqueAssets} farklı varlıkla risk dağıtımı.`);
        
        if (data.behavior.totalTimeMinutes > 30) 
            strengths.push(`✅ <b>Düzenli Takip:</b> Toplam ${data.behavior.totalTimeMinutes} dakika aktif kullanım.`);
        
        if (data.mainGoal > 0) 
            strengths.push(`✅ <b>Hedef Odaklı:</b> Finansal hedef belirlemişsin.`);
        
        if (data.alarmsCount > 0) 
            strengths.push(`✅ <b>Planlı:</b> ${data.alarmsCount} fiyat alarmı kurmuşsun.`);
        
        if (data.behavior.pageVisits['analysis'] > 5) 
            strengths.push(`✅ <b>Analitik:</b> Analiz araçlarını aktif kullanıyorsun.`);
        
        return strengths.length > 0 ? strengths.join('<br><br>') : '🔍 Daha fazla veri toplandıkça güçlü yönlerini keşfedeceğim.';
    },
    
    analyzeWeaknesses: function(data) {
        let weaknesses = [];
        
        if (data.winRate < 45 && data.totalSales >= 5) 
            weaknesses.push(`❌ <b>Düşük Başarı:</b> %${data.winRate.toFixed(0)} win rate. Giriş noktalarını gözden geçir.`);
        
        if (data.panicSells > 2) 
            weaknesses.push(`❌ <b>Panik Satış:</b> ${data.panicSells} kez erken zararla sattın.`);
        
        if (data.avgHold < 3 && data.totalSales >= 3) 
            weaknesses.push(`❌ <b>Sabırsızlık:</b> Ortalama ${data.avgHold.toFixed(1)} gün çok kısa.`);
        
        if (data.uniqueAssets < 3 && data.totalTrades >= 5) 
            weaknesses.push(`❌ <b>Konsantrasyon Riski:</b> Sadece ${data.uniqueAssets} varlık. Çeşitlendir.`);
        
        if (data.behavior.topPage === 'market' && data.totalTrades < 3) 
            weaknesses.push(`❌ <b>Analiz Felci:</b> Çok bakıyorsun ama az işlem yapıyorsun.`);
        
        if (data.mainGoal === 0) 
            weaknesses.push(`❌ <b>Hedefsiz:</b> Finansal hedef belirlemeni öneririm.`);
        
        return weaknesses.length > 0 ? weaknesses.join('<br><br>') : '🎉 Belirgin zayıf yön tespit edilmedi!';
    },
    
    analyzeBehavior: function(data) {
        let report = [];
        
        report.push(`<b>📊 KULLANIM RAPORU</b>`);
        report.push(`• Toplam Oturum: ${data.behavior.totalSessions}`);
        report.push(`• Toplam Süre: ${data.behavior.totalTimeMinutes} dakika`);
        
        if (data.behavior.topPage) {
            let pageNames = { portfolio: 'Cüzdan', market: 'Piyasa', analysis: 'Analiz', news: 'Haberler', settings: 'Ayarlar' };
            report.push(`• En Çok Ziyaret: ${pageNames[data.behavior.topPage] || data.behavior.topPage} (${data.behavior.topPageCount}x)`);
        }
        
        if (data.behavior.topFeature) {
            report.push(`• En Çok Kullanılan: ${data.behavior.topFeature} (${data.behavior.topFeatureCount}x)`);
        }
        
        if (data.behavior.topSearch) {
            report.push(`• En Çok Aranan: ${data.behavior.topSearch} (${data.behavior.topSearchCount}x)`);
        }
        
        report.push(``);
        report.push(`<b>📈 İŞLEM RAPORU</b>`);
        report.push(`• Toplam İşlem: ${data.totalTrades} (${data.totalBuys} alım, ${data.totalSales} satım)`);
        report.push(`• Win Rate: %${data.winRate.toFixed(0)}`);
        report.push(`• Toplam K/Z: ${data.totalPnL >= 0 ? '+' : ''}${data.totalPnL.toFixed(0)}`);
        report.push(`• Ort. Tutma: ${Math.round(data.avgHold)} gün`);
        
        if (data.topTradedAsset) {
            report.push(`• En Çok İşlem: ${data.topTradedAsset} (${data.topTradedCount}x)`);
        }
        
        return report.join('<br>');
    },
    
    generateAdvice: function(data) {
        let advice = [];
        let traderType = this.classifyTrader(data);
        
        advice.push(`<b>💡 ${traderType.name.toUpperCase()} İÇİN TAVSİYELER</b>`);
        
        // Trader tipine göre öneriler
        if (traderType.name === 'Scalper') {
            advice.push(`• Komisyon maliyetlerini hesapla, çok işlem kârı eritebilir.`);
            advice.push(`• Stop-loss'suz işlem yapma.`);
        } else if (traderType.name === 'Yatırımcı') {
            advice.push(`• Uzun vadeli düşün, günlük dalgalanmalara takılma.`);
            advice.push(`• Düzenli alım (DCA) stratejisi uygula.`);
        } else if (traderType.name === 'Swing') {
            advice.push(`• Trend yönünde işlem yap.`);
            advice.push(`• Destek/direnç seviyelerini takip et.`);
        }
        
        // Genel öneriler
        advice.push(``);
        advice.push(`<b>🎯 KİŞİSEL ÖNERİLER</b>`);
        
        if (data.panicSells > 0) {
            advice.push(`• Panik satışlardan kaçın. Plan yap ve uygula.`);
        }
        
        if (data.winRate < 50 && data.totalSales >= 5) {
            advice.push(`• Giriş stratejini gözden geçir, daha seçici ol.`);
        }
        
        if (data.mainGoal === 0) {
            advice.push(`• Hedefler bölümünden finansal hedef belirle.`);
        }
        
        if (data.behavior.pageVisits['analysis'] < 3) {
            advice.push(`• Analiz araçlarını (Ar-Ge Lab) daha çok kullan.`);
        }
        
        return advice.join('<br>');
    }
};

// ==========================================
// 5. NABIZ VE PATTERN FONKSİYONLARI
// ==========================================
function parseDateTR(dateStr) {
    if (!dateStr) return new Date();
    let parts = dateStr.split('.');
    if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
    return new Date(dateStr);
}

function calculateNabiz() {
    let history = JSON.parse(localStorage.getItem('tm_full_trade_history')) || [];
    let sales = history.filter(t => t.type === 'SATIM');
    let buys = history.filter(t => t.type === 'ALIM');
    
    if (sales.length < 2) return { score: 50, label: 'Veri Bekleniyor', color: '#64748b' };
    
    let score = 50;
    
    let uniqueDays = new Set(history.slice(-20).map(t => t.date)).size;
    let freq = history.slice(-20).length / Math.max(uniqueDays, 1);
    if (freq > 3) score += 15;
    else if (freq < 0.5) score -= 10;
    
    let recent = sales.slice(-10);
    let wins = recent.filter(s => parseFloat(s.pnl) > 0).length;
    let losses = recent.filter(s => parseFloat(s.pnl) < 0).length;
    if (losses > wins) score -= (losses - wins) * 8;
    if (wins > losses) score += (wins - losses) * 5;
    
    let panicCount = 0;
    sales.slice(-10).forEach(s => {
        let buy = buys.find(b => b.sym === s.sym);
        if (buy && parseFloat(s.pnl) < 0) {
            let days = (parseDateTR(s.date) - parseDateTR(buy.date)) / (1000*60*60*24);
            if (days < 3 && days >= 0) panicCount++;
        }
    });
    score -= panicCount * 10;
    
    score = Math.max(0, Math.min(100, Math.round(score)));
    
    let label, color;
    if (score <= 20) { label = 'Aşırı Korku'; color = '#ef4444'; }
    else if (score <= 40) { label = 'Korku'; color = '#f97316'; }
    else if (score <= 60) { label = 'Nötr'; color = '#eab308'; }
    else if (score <= 80) { label = 'Açgözlü'; color = '#84cc16'; }
    else { label = 'Aşırı Açgözlü'; color = '#10b981'; }
    
    return { score, label, color };
}

function renderNabiz() {
    let data = calculateNabiz();
    let scoreEl = document.getElementById('nabizScore');
    let labelEl = document.getElementById('nabizLabel');
    let needleEl = document.getElementById('nabizNeedle');
    
    if (scoreEl) { scoreEl.innerText = data.score; scoreEl.style.color = data.color; }
    if (labelEl) { labelEl.innerText = data.label; labelEl.style.color = data.color; }
    if (needleEl) needleEl.style.left = data.score + '%';
}

function detectPatterns() {
    let history = JSON.parse(localStorage.getItem('tm_full_trade_history')) || [];
    let sales = history.filter(t => t.type === 'SATIM');
    let buys = history.filter(t => t.type === 'ALIM');
    let patterns = [];
    
    if (history.length < 5) {
        return [{ type: 'info', icon: 'fa-info-circle', title: 'Veri Bekleniyor', desc: 'En az 5 işlem gerekli' }];
    }
    
    // Panik Satış
    let panicCount = 0;
    sales.forEach(s => {
        let buy = buys.find(b => b.sym === s.sym);
        if (buy && parseFloat(s.pnl) < 0) {
            let days = (parseDateTR(s.date) - parseDateTR(buy.date)) / (1000*60*60*24);
            if (days < 3 && days >= 0) panicCount++;
        }
    });
    if (panicCount > 2) patterns.push({ type: 'danger', icon: 'fa-ghost', title: 'Panik Satış', desc: panicCount + ' kez erken sattın' });
    
    // FOMO
    let fomo = 0;
    buys.forEach(b => {
        let prevSell = sales.find(s => s.sym === b.sym && parseDateTR(s.date) < parseDateTR(b.date));
        if (prevSell && parseFloat(b.price) > parseFloat(prevSell.price) * 1.15) fomo++;
    });
    if (fomo > 1) patterns.push({ type: 'warning', icon: 'fa-fire', title: 'FOMO Alım', desc: fomo + ' kez yüksekten aldın' });
    
    // Win Rate
    let winRate = sales.length > 0 ? (sales.filter(s => parseFloat(s.pnl) > 0).length / sales.length * 100) : 0;
    if (winRate > 60 && sales.length >= 5) patterns.push({ type: 'success', icon: 'fa-trophy', title: 'Yüksek Başarı', desc: '%' + winRate.toFixed(0) + ' win rate' });
    
    if (patterns.length === 0) patterns.push({ type: 'info', icon: 'fa-check', title: 'Dengeli', desc: 'Belirgin pattern yok' });
    
    return patterns.slice(0, 3);
}

function renderPatterns() {
    let patterns = detectPatterns();
    let container = document.getElementById('patternCards');
    if (!container) return;
    
    let colors = { danger: '#ef4444', warning: '#f59e0b', success: '#10b981', info: '#3b82f6' };
    let html = patterns.map(p => `
        <div style="background: ${colors[p.type]}10; border-left: 3px solid ${colors[p.type]}; border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 10px;">
            <i class="fas ${p.icon}" style="color: ${colors[p.type]}; font-size: 14px;"></i>
            <div>
                <div style="font-size: 11px; font-weight: 700; color: #fff;">${p.title}</div>
                <div style="font-size: 9px; color: #94a3b8;">${p.desc}</div>
            </div>
        </div>
    `).join('');
    container.innerHTML = html;
}

// ==========================================
// 6. AI KOÇ RENDER FONKSİYONLARI
// ==========================================
function renderAICoach() {
    let data = AIDataCollector.collectAll();
    
    // Veri sayısı
    let dataCount = data.totalTrades + data.behavior.totalSessions + (data.behavior.searchHistory?.length || 0);
    let dataCountEl = document.getElementById('aiDataCount');
    if (dataCountEl) dataCountEl.innerText = dataCount + ' veri';
    
    // Ana mesaj
    let messageEl = document.getElementById('aiCoachMessage');
    if (messageEl) messageEl.innerHTML = AdvancedAICoach.generateMainMessage(data);
    
    // Profil özeti
    let traderType = AdvancedAICoach.classifyTrader(data);
    let risk = AdvancedAICoach.classifyRisk(data);
    let focus = AdvancedAICoach.detectFocus(data);
    let score = AdvancedAICoach.calculateScore(data);
    
    let typeEl = document.getElementById('aiTraderType');
    let riskEl = document.getElementById('aiRiskLevel');
    let focusEl = document.getElementById('aiFocusArea');
    let scoreEl = document.getElementById('aiScore');
    
    if (typeEl) typeEl.innerText = traderType.emoji;
    if (riskEl) { riskEl.innerText = risk.text; riskEl.style.color = risk.color; }
    if (focusEl) { focusEl.innerText = focus.text; focusEl.style.color = focus.color; }
    if (scoreEl) { 
        scoreEl.innerText = score; 
        scoreEl.style.color = score >= 60 ? '#10b981' : score >= 40 ? '#f59e0b' : '#ef4444';
    }
    
    // Kullanım istatistikleri
    let mostUsedEl = document.getElementById('statMostUsedFeature');
    let mostSearchEl = document.getElementById('statMostSearched');
    let timeSpentEl = document.getElementById('statTimeSpent');
    
    let pageNames = { portfolio: '💼', market: '📈', analysis: '🔬', news: '📰', settings: '⚙️' };
    if (mostUsedEl) mostUsedEl.innerText = pageNames[data.behavior.topPage] || '📱';
    if (mostSearchEl) mostSearchEl.innerText = data.behavior.topSearch || '-';
    if (timeSpentEl) timeSpentEl.innerText = data.behavior.totalTimeMinutes + 'dk';
}

function runAIAnalysis(type) {
    let data = AIDataCollector.collectAll();
    let el = document.getElementById('aiCoachMessage');
    if (!el) return;
    
    el.innerHTML = '<i class="fas fa-circle-notch fa-spin" style="color:#64748b;"></i> <span style="color:#64748b;">Analiz ediliyor...</span>';
    
    setTimeout(() => {
        let result = '';
        switch(type) {
            case 'strength': result = AdvancedAICoach.analyzeStrengths(data); break;
            case 'weakness': result = AdvancedAICoach.analyzeWeaknesses(data); break;
            case 'behavior': result = AdvancedAICoach.analyzeBehavior(data); break;
            case 'advice': result = AdvancedAICoach.generateAdvice(data); break;
            default: result = AdvancedAICoach.generateMainMessage(data);
        }
        el.innerHTML = result;
    }, 400);
}

// ==========================================
// 7. SEKME GEÇİŞ YÖNETİMİ
// ==========================================
const _origSwitchPsychoTab = window.switchPsychoTab;
window.switchPsychoTab = function(tabName) {
    document.querySelectorAll('.psycho-view').forEach(el => el.classList.remove('active'));
    const target = document.getElementById(tabName);
    if(target) target.classList.add('active');
    
    document.querySelectorAll('.p-tab-btn').forEach(btn => btn.classList.remove('active'));
    if(event && event.currentTarget) event.currentTarget.classList.add('active');
    
    // Davranış takibi
    BehaviorTracker.trackTabVisit('psycho_' + tabName);
    
    if (tabName === 'tab-karne') { renderNabiz(); renderPatterns(); }
    if (tabName === 'tab-coach') renderAICoach();
};

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => { 
        renderNabiz(); 
        renderPatterns(); 
    }, 2500);
});


</script>

<script src="lang.js"></script>

</body>
</html>



