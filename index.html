<!DOCTYPE html>
<html lang="tr">
<head>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
   <title>TradeVia (Live Edition)</title>
   
   <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0f19">

<link rel="icon" type="image/svg+xml" href="/icon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

        <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <style>
                    .bottom-nav {
            position: fixed;       /* Ekrana çivile */
            bottom: 0 !important;  /* Kesinlikle en altta olsun */
            left: 0 !important;    /* Kesinlikle en solda olsun */
            right: 0 !important;   /* Kesinlikle en sağa kadar gitsin */
            width: 100%;           /* Ekranı tam kapla */
            height: 70px;          
            background: rgba(21, 27, 43, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 99999;        /* Her şeyin en en üstünde */
            margin: 0;             /* Dış boşluk yok */
            padding-bottom: env(safe-area-inset-bottom); /* iPhone çizgisi için */
        }

        
        /* --- TEMALAR & DEĞİŞKENLER --- */
        :root { --bg-body: #0b0f19; --bg-card: #151b2b; --bg-input: #1e2538; --text-main: #ffffff; --text-sub: #94a3b8; --accent: #3b82f6; --success: #10b981; --danger: #ef4444; --gold: #f59e0b; --kap: #8b5cf6; --radius: 16px; --accent-glow: rgba(59, 130, 246, 0.5); }
        [data-theme="purple"] { --bg-body: #0f0718; --bg-card: #1a0b2e; --bg-input: #261245; --accent: #8b5cf6; --text-sub: #a78bfa; --accent-glow: rgba(139, 92, 246, 0.5); }
        [data-theme="dark"] { --bg-body: #000000; --bg-card: #111111; --bg-input: #222222; --accent: #ffffff; --text-sub: #666666; --accent-glow: rgba(255, 255, 255, 0.3); }
        
        /* --- ARKA PLAN ANİMASYONU --- */
#bg-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1; /* Her şeyin arkasında */
    pointer-events: none; /* Tıklamaları engellemez */
    opacity: 0.6; /* Çok baskın olmaması için */
}

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
                body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: background 0.3s; }


        /* ÜST BAR */
        .top-bar { height: 60px; flex-shrink: 0; background: var(--bg-body); border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 50; }
        .app-title { font-size: 20px; font-weight: 800; background: linear-gradient(to right, #fff, var(--text-sub)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-icons { display: flex; gap: 10px; }
        .icon-btn { position: relative; width: 38px; height: 38px; border-radius: 10px; background: var(--bg-input); color: var(--text-main); border: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.95); }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; font-size: 10px; font-weight: 800; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid var(--bg-body); display: none; }
        .notif-badge.active { display: flex; animation: bounce 0.3s; }
        @keyframes bounce { 0%{transform:scale(0);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }

        .content-area { flex: 1; overflow: hidden; position: relative; }
        .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; overflow-y: auto; padding: 15px; padding-bottom: 140px; }
        .page.active { display: flex; z-index: 10; }

        /* GENEL BİLEŞENLER */
        .card, .analysis-card { background: var(--bg-card); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.03); color: var(--text-main); }
        .modern-input { width: 100%; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px; border-radius: 10px; font-size: 16px; margin-bottom: 5px; outline: none; }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-main { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: 700; font-size: 13px; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-sec { background: var(--bg-input); color: var(--text-main); border: 1px solid rgba(255,255,255,0.05); }
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }

        /* --- SKELETON LOADING (Modern/Soft) --- */
        .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.02) 25%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.02) 75%); background-size: 200% 100%; animation: shimmer 2s infinite; border-radius: 16px; height: 70px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.02); }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* --- CÜZDAN SIRALAMA BUTONLARI --- */
        .sort-scroll-wrapper { display: flex; gap: 8px; overflow-x: auto; padding: 5px 2px 10px 2px; margin-bottom: 5px; scrollbar-width: none; }
        .sort-chip { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); color: var(--text-sub); padding: 8px 16px; border-radius: 12px; font-size: 11px; font-weight: 600; white-space: nowrap; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; align-items: center; gap: 6px; backdrop-filter: blur(5px); }
        .sort-chip i { font-size: 11px; opacity: 0.7; }
        .sort-chip.active { background: rgba(59, 130, 246, 0.15); color: var(--accent); border-color: var(--accent); box-shadow: 0 0 15px rgba(59, 130, 246, 0.25); transform: translateY(-1px); }
        .sort-chip:active { transform: scale(0.96); }

        /* --- PİYASA LİSTESİ --- */
        .market-list-container { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; max-height: 250px; overflow-y: auto; }
        .market-row-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); border: 1px solid rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .market-row-item:active { transform: scale(0.98); background: var(--bg-input); }
        .market-row-item:hover { border-color: rgba(255,255,255,0.15); }
        .market-row-item.active { border: 1px solid var(--accent); background: rgba(59, 130, 246, 0.05); }
        .m-row-left { display: flex; align-items: center; gap: 10px; }
        .m-row-info { display: flex; flex-direction: column; }
        .m-row-sym { font-size: 13px; font-weight: 800; color: white; }
        .m-row-name { font-size: 10px; color: var(--text-sub); }
        .m-row-right { text-align: right; }
        .m-row-price { font-size: 14px; font-weight: 700; color: white; display: block; }
        .m-row-change { font-size: 11px; font-weight: 700; display: block; margin-top: 2px; }
        .val-up { color: var(--success); } .val-down { color: var(--danger); } .val-neutral { color: var(--text-sub); }

        /* SATIŞ MODALI & DİĞERLERİ */
        .sell-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sell-ratio-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .ratio-btn { flex: 1; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: var(--text-sub); font-size: 11px; font-weight: 700; padding: 8px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .ratio-btn.active, .ratio-btn:active { background: var(--accent); color: white; }
        .sell-summary-box { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 12px; margin-top: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .ss-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 12px; }
        .ss-row:last-child { margin-bottom: 0; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 8px; margin-top: 5px; }
        .ss-lbl { color: var(--text-sub); font-weight: 600; }
        .ss-val { color: white; font-weight: 800; }
        .ss-pnl { font-weight: 800; }

        /* SİMÜLATÖR */
        .sim-tab-group { display: flex; gap: 5px; background: var(--bg-input); padding: 4px; border-radius: 12px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.05); }
        .sim-tab { flex: 1; text-align: center; padding: 10px 5px; font-size: 11px; font-weight: 700; color: var(--text-sub); border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .sim-tab i { font-size: 14px; margin-bottom: 2px; }
        .sim-tab.active { background: var(--bg-card); color: var(--accent); box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }
        .sim-content-pane { display: none; animation: fadeIn 0.3s; }
        .sim-content-pane.active { display: block; }
        .sim-result-box { background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%); border: 1px solid rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-top: 15px; position: relative; overflow: hidden; }
        .sim-result-box::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--text-sub); }
        .sim-result-box.profit::before { background: var(--success); }
        .sim-result-box.loss::before { background: var(--danger); }
        .sim-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; align-items: center; }
        .sim-row.big { font-size: 14px; font-weight: 800; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; margin-top: 10px; margin-bottom: 0; }
        .sim-lbl { color: var(--text-sub); }

        /* PROFİL & DİĞERLERİ */
        .profile-section { text-align: center; margin-bottom: 20px; margin-top: 10px; }
        .profile-img-wrap { width: 90px; height: 90px; margin: 0 auto 10px auto; position: relative; border-radius: 50%; border: 2px solid var(--accent); padding: 3px; box-shadow: 0 0 25px var(--accent-glow); }
        .profile-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; background: var(--bg-input); }
        .profile-upload-btn { position: absolute; bottom: 0; right: 0; background: var(--accent); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid var(--bg-card); font-size: 14px; transition: 0.2s; }
        .profile-name { font-size: 18px; font-weight: 800; color: white; margin-bottom: 2px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .profile-tag { font-size: 12px; color: var(--accent); margin-bottom: 10px; display: block; font-weight: 600; }
        .membership-badge { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 800; display: inline-flex; align-items: center; gap: 5px; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.3); text-transform: uppercase; letter-spacing: 1px; }
        .membership-card-pro { background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(59, 130, 246, 0.15) 100%); border: 1px solid rgba(59, 130, 246, 0.3); padding: 15px; border-radius: 16px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .mc-left { display: flex; flex-direction: column; }
        .mc-title { font-size: 15px; font-weight: 800; color: white; margin-bottom: 4px; }
        .mc-sub { font-size: 11px; color: var(--text-sub); opacity: 0.8; }
        .stat-box { background: linear-gradient(180deg, var(--bg-input) 0%, var(--bg-card) 100%); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .stat-val { color: var(--text-main); font-size: 15px; text-shadow: 0 0 10px rgba(255,255,255,0.1); }
        .stat-label { color: var(--text-sub); font-weight: 700; }
        .collapsible-header { cursor: pointer; user-select: none; display: flex; justify-content: space-between; align-items: center; }
        .rotate-icon { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .rotate-icon.rotated { transform: rotate(180deg); }
        .collapsible-content { max-height: 1200px; opacity: 1; overflow: hidden; transition: max-height 0.4s ease, opacity 0.4s ease, margin 0.3s ease; }
        .collapsible-content.collapsed { max-height: 0; opacity: 0; margin-top: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; border:none !important; }
        .trade-card { background: linear-gradient(145deg, var(--bg-card) 0%, rgba(21, 27, 43, 0.6) 100%); border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; padding: 20px; margin-bottom: 15px; position: relative; box-shadow: 0 4px 20px rgba(0,0,0,0.2); transition: 0.3s; }
        .trade-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0; }
        .trade-card.open .trade-header { margin-bottom: 15px; } 
        .trade-title { font-size: 14px; font-weight: 800; color: white; display: flex; align-items: center; gap: 8px; }
        .currency-toggle-btn { width: 32px; height: 32px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); background: var(--bg-input); color: var(--text-sub); font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; z-index: 2; }
        .currency-toggle-btn.active-try { color: var(--success); border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .currency-toggle-btn.active-usd { color: var(--accent); border-color: var(--accent); background: rgba(59, 130, 246, 0.1); }
        .trade-input-group { position: relative; margin-bottom: 10px; }
        .trade-input { width: 100%; background: var(--bg-body); border: 1px solid rgba(255,255,255,0.08); color: white; padding: 14px 14px 14px 40px; border-radius: 12px; font-size: 15px; font-weight: 600; outline: none; transition: 0.3s; }
        .trade-input:focus { border-color: var(--accent); background: var(--bg-input); }
        .input-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 14px; pointer-events: none; }
        .trade-summary-box { background: rgba(255,255,255,0.03); border-radius: 10px; padding: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .ts-label { color: var(--text-sub); font-weight: 600; }
        .ts-val { color: white; font-weight: 800; font-size: 14px; }
        .add-btn-pro { width: 100%; background: linear-gradient(90deg, var(--accent) 0%, #2563eb 100%); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 800; font-size: 14px; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); transition: 0.2s; }
        .add-btn-pro:active { transform: scale(0.98); }
        .balance-hero { text-align: center; padding: 20px; background: linear-gradient(180deg, var(--bg-input) 0%, var(--bg-body) 100%); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; transition: 0.5s; }
        .balance-hero.profit { background: linear-gradient(180deg, rgba(16, 185, 129, 0.2) 0%, var(--bg-body) 100%); border-color: rgba(16, 185, 129, 0.4); box-shadow: 0 10px 30px rgba(16, 185, 129, 0.1); }
        .balance-hero.loss { background: linear-gradient(180deg, rgba(239, 68, 68, 0.2) 0%, var(--bg-body) 100%); border-color: rgba(239, 68, 68, 0.4); box-shadow: 0 10px 30px rgba(239, 68, 68, 0.1); }
        .val-lg { font-size: 38px; font-weight: 800; margin: 5px 0 15px 0; color: white; letter-spacing: -1px; }
        .hero-stats-row { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .hero-pill { background: rgba(255,255,255,0.05); padding: 8px 14px; border-radius: 20px; font-size: 11px; font-weight: 600; border: 1px solid rgba(255,255,255,0.1); display: inline-flex; align-items: center; gap: 6px; color:white; }
        .hero-pill.cash { background: rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        .hero-actions { display: flex; gap: 8px; justify-content: center; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.08); padding-top: 15px; }
        .hero-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.08); color: white; padding: 10px 18px; border-radius: 12px; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .asset-card { background: var(--bg-card); border-radius: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.03); overflow: hidden; position: relative; color: white; transition: 0.3s; }
        .asset-card.profit-bg { background: linear-gradient(135deg, rgba(16, 185, 129, 0.12) 0%, var(--bg-card) 100%); border-color: rgba(16, 185, 129, 0.25); }
        .asset-card.loss-bg { background: linear-gradient(135deg, rgba(239, 68, 68, 0.12) 0%, var(--bg-card) 100%); border-color: rgba(239, 68, 68, 0.25); }
        .asset-header { display: flex; justify-content: space-between; align-items: center; padding: 16px; cursor: pointer; user-select: none; }
        .asset-left { display: flex; align-items: center; }
        .asset-logo-wrap { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: var(--bg-input); margin-right: 12px; border: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; overflow: hidden; }
        .asset-logo-img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .asset-avatar-text { font-size: 14px; font-weight: 800; color: var(--text-sub); }
        .asset-name { font-size: 15px; font-weight: 800; display: block; color:white; }
        .asset-meta { font-size: 11px; color: var(--text-sub); }
        .asset-pnl { font-size: 13px; font-weight: 700; padding: 4px 8px; border-radius: 6px; display:flex; align-items:center; gap:8px;}
        .pnl-up { color: var(--success); background: rgba(16, 185, 129, 0.1); } .pnl-down { color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .asset-body-content { padding-bottom: 5px; } 
        .asset-details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; padding: 0 16px 16px 16px; font-size: 12px; }
        .detail-item { display: flex; flex-direction: column; }
        .detail-label { color: var(--text-sub); font-size: 9px; font-weight: 600; text-transform: uppercase; }
        .detail-val { font-weight: 700; color:white; }
        .asset-footer { background: rgba(0,0,0,0.2); padding: 8px 16px; display: flex; justify-content: flex-end; gap: 12px; }
        .tool-btn { background: none; border: none; font-size: 14px; color: var(--text-sub); cursor: pointer; transition: 0.2s; padding: 4px 8px; } 
        .tool-btn:hover { color:white; }
        .tool-btn.active-sim { color: var(--kap) !important; background: rgba(139, 92, 246, 0.15); border-radius: 6px; }
        .active-alarm { color: var(--gold) !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0%{opacity:1;} 50%{opacity:0.5;} 100%{opacity:1;} }
        .asset-note { font-size: 11px; color: var(--gold); background: rgba(245, 158, 11, 0.1); padding: 6px; margin: 0 16px 10px 16px; border-radius: 6px; }
        .asset-mini-chart { height: 0; overflow: hidden; transition: height 0.4s cubic-bezier(0.25, 1, 0.5, 1); background: #131722; border-radius: 0 0 16px 16px; position: relative; }
        .asset-mini-chart.active { height: 320px; border-top: 1px solid rgba(255,255,255,0.05); }
        .chart-loader-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-sub); font-size: 12px; z-index: 0; }
        .tool-btn.chart-on { color: var(--accent) !important; background: rgba(59, 130, 246, 0.15); border-radius: 6px; }
        .notif-card { background: var(--bg-card); padding: 16px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; display: flex; gap: 12px; align-items: flex-start; animation: slideIn 0.3s ease; position: relative; }
        .notif-card.unread { border-left: 3px solid var(--accent); background: rgba(59, 130, 246, 0.05); }
        .notif-icon-box { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-size: 14px; }
        .notif-content { flex: 1; }
        .notif-title { font-size: 13px; font-weight: 700; color: white; margin-bottom: 2px; }
        .notif-msg { font-size: 11px; color: var(--text-sub); line-height: 1.4; }
        .notif-time { font-size: 9px; color: var(--text-sub); opacity: 0.6; position: absolute; top: 12px; right: 12px; }
        .n-success .notif-icon-box { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .n-danger .notif-icon-box { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .n-info .notif-icon-box { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
        .n-warn .notif-icon-box { background: rgba(245, 158, 11, 0.15); color: var(--gold); }
        @keyframes slideIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
        .currency-pill-wrapper { display: flex; justify-content: flex-end; margin-bottom: 8px; }
        .analysis-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
        .an-card { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.05); border-radius: 16px; padding: 16px; color: white; }
        .an-card.full-width { grid-column: span 2; }
        .an-label { font-size: 10px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; margin-bottom: 6px; display: flex; justify-content: space-between; }
        .an-val { font-size: 22px; font-weight: 800; color: white; }
        .an-card.up .an-val { color: var(--success); } .an-card.down .an-val { color: var(--danger); }
        .goal-wrapper { margin-top: 10px; background: var(--bg-input); border-radius: 6px; padding: 2px; }
        .goal-fill { height: 10px; width: 0%; border-radius: 4px; transition: width 1s; }
        .goal-fill.low { background: linear-gradient(90deg, #ef4444, #f87171); } 
        .goal-fill.mid { background: linear-gradient(90deg, #f59e0b, #fbbf24); } 
        .goal-fill.high { background: linear-gradient(90deg, #10b981, #34d399); }
        .chart-toggle-group { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
        .chart-time-btn { background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: var(--text-sub); padding: 6px 16px; border-radius: 8px; font-size: 11px; font-weight: 700; cursor: pointer; }
        .chart-time-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .stat-circle { width: 100%; height: 250px; position: relative; min-height:250px; }
        .market-switcher { display: flex; background: var(--bg-input); border-radius: 12px; padding: 4px; margin-bottom: 15px; }
        .ms-btn { flex: 1; text-align: center; padding: 12px; font-size: 13px; font-weight: 800; color: var(--text-sub); border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .ms-btn.active { background: var(--bg-card); color: var(--accent); }
        .market-view-section { display: none; } .market-view-section.active { display: block; }
        .market-tabs-pro { display: flex; background: rgba(0,0,0,0.2); padding: 4px; border-radius: 12px; margin-bottom: 10px; overflow-x: auto; scrollbar-width: none; }
        .m-tab-pro { flex: 1; text-align: center; padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: 700; color: var(--text-sub); cursor: pointer; white-space: nowrap; }
        .m-tab-pro.active { background: var(--accent); color: white; }
        .chart-container-pro { position: relative; height: 420px; width: 100%; background: #131722; border-radius: 16px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05); }
        .chart-search-overlay { position: absolute; top: 10px; right: 10px; z-index: 10; background: rgba(30, 41, 59, 0.9); padding: 5px 10px; border-radius: 8px; display: flex; gap: 5px; width: 160px; }
        .cso-input { background: transparent; border: none; color: white; font-size: 11px; width: 100%; outline: none; font-weight: 600; text-transform: uppercase; }
        #tradingview_container { width: 100%; height: 100%; min-height: 420px; }
        .wl-card-classic { background-color: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; position: relative; border: 1px solid rgba(255,255,255,0.05); border-left: 5px solid var(--text-sub); }
        .wl-c-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .wl-c-sym { font-size: 18px; font-weight: 800; color: white; display: block; }
        .wl-c-tag { font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; margin-top: 5px; display: inline-block; color: #1e293b; }
        .wl-c-tag.kripto { background: #f59e0b; color: #451a03; } .wl-c-tag.borsa { background: #3b82f6; color: #172554; }
        .wl-c-price-box { text-align: right; }
        .wl-c-price { font-size: 24px; font-weight: 800; color: white; display: block; line-height: 1; }
        .wl-c-change { font-size: 12px; font-weight: 700; margin-top: 4px; display: block; }
        .wl-c-stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 12px; }
        .wl-c-stat-item { text-align: center; border-right: 1px solid rgba(255,255,255,0.05); }
        .wl-c-stat-item:last-child { border-right: none; }
        .wl-c-lbl { font-size: 9px; color: var(--text-sub); display: block; margin-bottom: 3px; font-weight: 600; }
        .wl-c-val { font-size: 12px; font-weight: 700; color:white; }
        .wl-c-del { position: absolute; bottom: 12px; right: 12px; background: rgba(239, 68, 68, 0.2); color: var(--danger); width: 32px; height: 32px; border-radius: 8px; border:none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .wl-search-wrapper { position: sticky; top: 0; background: var(--bg-body); padding: 10px 0; z-index: 20; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .wl-search-box { display: flex; gap: 10px; align-items: center; background: var(--bg-input); border-radius: 12px; padding: 5px 10px; border: 1px solid rgba(255,255,255,0.1); }
        .wl-search-input { flex: 1; background: transparent; border: none; color: white; padding: 10px; font-size: 14px; outline: none; }
        .wl-add-btn { background: var(--accent); color: white; border: none; width: 40px; height: 40px; border-radius: 10px; font-size: 18px; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; }
        #wlLiveInfo { font-size: 12px; color: var(--text-sub); padding: 5px; height: 20px; font-weight: 600; display: block; }
        .news-card-pro { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.05); border-left: 4px solid var(--text-sub); transition: transform 0.2s; }
        .nc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap:5px; }
        .nc-tags-row { display: flex; gap: 4px; flex-wrap: wrap; }
        .nc-tag { font-size: 9px; font-weight: 800; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; color: #1e293b; display: inline-block; }
        .nc-tag.kripto { background: #f59e0b; color: #451a03; } .nc-tag.borsa { background: #3b82f6; color: #172554; } .nc-tag.finans { background: #10b981; color: #064e3b; }
        .nc-asset-tag { background: rgba(255,255,255,0.1); color: white; border:1px solid rgba(255,255,255,0.15); display: flex; align-items: center; gap: 4px; }
        .nc-title { font-size: 14px; font-weight: 700; line-height: 1.4; color: white; margin-bottom: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .nc-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px; }
        .nc-source { font-size: 11px; color: var(--text-sub); font-weight: 500; display: flex; align-items: center; gap: 5px; }
        .nc-read-btn { background: rgba(255,255,255,0.05); color: var(--text-main); padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-decoration: none; display: flex; align-items: center; gap: 4px; transition: 0.2s; }
        .news-toolbar-fixed { display: flex; gap: 8px; margin-bottom: 20px; align-items: stretch; }
        .news-input-fix { flex: 1; background: var(--bg-input); border: 1px solid rgba(255,255,255,0.08); color: white; padding: 0 12px; border-radius: 12px; font-size: 13px; height: 44px; outline: none; }
        .news-btn-fix { width: 44px; height: 44px; background: var(--accent); color: white; border: none; border-radius: 12px; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .kap-btn-fix { background: var(--kap); color: white; border: none; border-radius: 12px; padding: 0 15px; font-weight: 800; font-size: 12px; height: 44px; cursor: pointer; }
        .hist-filter-scroll { display: flex; gap: 8px; overflow-x: auto; margin-bottom: 15px; scrollbar-width: none; }
        .h-filter-btn { background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: var(--text-sub); padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; cursor: pointer; white-space: nowrap; }
        .h-filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
       
                  .nav-container {
            position: fixed;
            bottom: 0 !important;        /* En alta yapıştır */
            left: 0 !important;          /* En sola yasla */
            width: 100% !important;      /* Ekranı tam kapla */
            height: 60px;                /* Yükseklik (İdeal incelik) */
            
            background: rgba(21, 27, 43, 0.95); /* Arka plan rengi */
            backdrop-filter: blur(15px);        /* Buzlu cam efekti */
            -webkit-backdrop-filter: blur(15px);
            
            border: none;
            border-top: 1px solid rgba(255, 255, 255, 0.08); /* Sadece üstte ince çizgi */
            border-radius: 0;            /* Köşeler düz */
            
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 9999;
            
            transform: none !important;  /* Ortalamayı iptal et */
            max-width: none !important;  /* Genişlik sınırını kaldır */
            padding-bottom: env(safe-area-inset-bottom); /* iPhone alt çizgi payı */
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.2); /* Hafif gölge */
        }

                     .nav-item { 
            color: #64748b;        /* Pasif ikon rengi (Gri) */
            padding: 0;
            height: 100%;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            gap: 4px;              /* İkon ve yazı arası boşluk */
            flex: 1; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
        }

        .nav-item i {
            font-size: 20px;       /* İkon boyutu */
            transition: 0.3s;
        }
        
        .nav-item span {
            font-size: 10px;       /* Yazı boyutu */
            font-weight: 600;
        }

        /* Aktif Olduğunda Ne Olsun? */
        .nav-item.active { 
            color: white; 
            transform: translateY(-4px); /* Seçilince hafif yukarı çıksın */
        }
        
        .nav-item.active i {
            color: #3b82f6;       /* Mavi renk */
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.6)); /* NEON PARLAMA */
        }

            /* --- GÜNCELLENMİŞ MODAL & AYARLAR STİLİ (TAŞMA KORUMALI) --- */
        
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.85); 
            z-index: 200; 
            
            /* Merkezleme ve Dış Boşluk */
            display: none; 
            align-items: center !important; 
            justify-content: center !important; 
            
            backdrop-filter: blur(5px); 
            padding: 20px; /* Dış çerçeve güvenli alanı */
        }

        .modal { 
            background: var(--bg-card); 
            /* İç boşluğu artırdık, içerik kenara yapışmaz */
            padding: 25px; 
            
            border-radius: 24px;
            width: 100%; 
            max-width: 360px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: white; 
            
            /* Ekranın tepesine/altına çok yapışmaması için %80 yaptık */
            max-height: 80vh; 
            
            /* Kaydırma Ayarları */
            overflow-y: auto; 
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            
            /* SİHİRLİ KOD: Kaydırırken arka planın oynamasını engeller */
            overscroll-behavior: contain; 
            
            /* Açılış Animasyonu */
            animation: zoomInModal 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Scroll çubuğunu gizle ama kaydırmaya izin ver */
        .modal::-webkit-scrollbar { display: none; }

        @keyframes zoomInModal {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* --- DİĞER MEVCUT STİLLER (AYNEN KORUNDU) --- */
        .privacy-blur { filter: blur(8px); opacity: 0.5; transition: 0.3s; }
        .settings-tabs { display: flex; background: var(--bg-input); border-radius: 12px; padding: 4px; margin-bottom: 15px; }
        .s-tab { flex: 1; text-align: center; padding: 10px; font-size: 12px; font-weight: 700; color: var(--text-sub); border-radius: 8px; cursor: pointer; }
        .s-tab.active { background: var(--bg-card); color: var(--accent); }
        .settings-content { display: none; } .settings-content.active { display: block; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .setting-select { background: var(--bg-input); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 8px 12px; border-radius: 8px; font-size: 12px; outline: none; }
        .poly-wrapper { position: relative; display: flex; align-items: center; gap: 10px; }
        .poly-status-dot { width: 12px; height: 12px; border-radius: 50%; background-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); transition: 0.3s; flex-shrink: 0; }
        .poly-status-dot.active { background-color: var(--success); box-shadow: 0 0 15px var(--success); }
        .poly-status-dot.error { background-color: var(--danger); box-shadow: 0 0 15px var(--danger); }
        .poly-status-dot.idle { background-color: var(--text-sub); box-shadow: none; opacity: 0.5; }
        .nav-container { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .nav-hidden { transform: translate(-50%, 200%) !important; }

        /* --- ORİJİNAL LOGO SPLASH SCREEN (HIZLI & LÜKS) --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            z-index: 9999999; display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.4s ease-out, visibility 0.4s;
        }
        #splash-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .original-logo-container { width: 200px; height: 200px; animation: zoomInLogo 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
        .tm-part { opacity: 0; animation: fadeInPart 0.5s ease-out forwards; }
        .tm-shield-outer { animation-delay: 0.1s; } .tm-shield-blue { animation-delay: 0.2s; } .tm-shield-gold { animation-delay: 0.3s; }
        .tm-bull-bear { animation-delay: 0.4s; } .tm-letters { animation-delay: 0.5s; } .tm-arrow { animation-delay: 0.6s; transform-origin: center; animation: drawArrowOriginal 0.6s ease-out forwards 0.6s; opacity: 0; }
        .splash-brand-name { margin-top: 30px; font-family: 'Inter', sans-serif; font-size: 28px; letter-spacing: 4px; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; opacity: 0; animation: fadeUpText 0.5s ease-out forwards 0.7s; }
        .splash-loader-bar { width: 140px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 20px; overflow: hidden; opacity: 0; animation: fadeInPart 0.3s ease-out forwards 0.8s; }
        .splash-loader-bar::after { content: ''; display: block; width: 40%; height: 100%; background: linear-gradient(90deg, #f59e0b, #d97706); animation: loadingMove 1s infinite ease-in-out; }
        @keyframes zoomInLogo { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fadeInPart { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeUpText { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes drawArrowOriginal { from { opacity: 0; transform: translate(-20px, 20px) scale(0.8); } to { opacity: 1; transform: translate(0, 0) scale(1); } }
        @keyframes loadingMove { 0% { transform: translateX(-100%); } 100% { transform: translateX(300%); } }

        /* --- YENİ ANALİZ DASHBOARD STİLLERİ --- */
        .dashboard-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding-bottom: 20px; }
        .dash-card { background: var(--bg-card); border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; padding: 20px; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .dash-card.full-width { grid-column: span 2; }
        .dash-card::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, var(--accent), transparent); opacity: 0.5; }
        .metric-title { font-size: 11px; color: var(--text-sub); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .metric-value { font-size: 26px; font-weight: 800; color: white; letter-spacing: -0.5px; }
        .metric-sub { font-size: 11px; font-weight: 600; margin-top: 5px; display: flex; align-items: center; gap: 5px; }
        .trend-up { color: var(--success); background: rgba(16, 185, 129, 0.1); padding: 3px 8px; border-radius: 6px; }
        .trend-down { color: var(--danger); background: rgba(239, 68, 68, 0.1); padding: 3px 8px; border-radius: 6px; }
        .win-rate-container { display: flex; align-items: center; justify-content: center; position: relative; height: 140px; }
        .win-rate-text { position: absolute; text-align: center; }
        .wr-val { font-size: 28px; font-weight: 800; display: block; color: white; }
        .wr-lbl { font-size: 10px; color: var(--text-sub); font-weight: 700; }
        .top-performer-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .top-performer-row:last-child { border-bottom: none; }
        .tp-name { font-weight: 700; font-size: 13px; color: white; display: flex; align-items: center; gap: 8px; }
        .tp-val { font-weight: 800; font-size: 13px; }
        .rank-badge { width: 20px; height: 20px; background: var(--bg-input); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 800; color: var(--text-sub); }
        .rank-1 { background: rgba(245, 158, 11, 0.2); color: var(--gold); border: 1px solid rgba(245, 158, 11, 0.3); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-filter-btn { background: var(--bg-input); border: 1px solid rgba(255,255,255,0.05); color: var(--text-sub); font-size: 10px; padding: 4px 10px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .chart-filter-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* --- PRO MUHASEBE STİLLERİ --- */
        .accounting-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .acc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .acc-item { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 10px; }
        .acc-lbl { font-size: 10px; color: var(--text-sub); text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 4px; }
        .acc-val { font-size: 16px; font-weight: 800; color: white; letter-spacing: 0.5px; font-family: 'Inter', monospace; }
        .acc-net { grid-column: span 2; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.2); }
        .month-separator { font-size: 11px; font-weight: 800; color: var(--text-sub); margin: 20px 0 10px 5px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        .month-separator::after { content:''; flex:1; height:1px; background: rgba(255,255,255,0.1); }
        .ledger-card { background: var(--bg-card); border-radius: 12px; padding: 14px; margin-bottom: 8px; border: 1px solid rgba(255,255,255,0.03); display: flex; align-items: center; justify-content: space-between; transition: transform 0.2s; position: relative; overflow: hidden; }
        .ledger-card:active { transform: scale(0.98); background: var(--bg-input); }
        .ledger-card::before { content:''; position: absolute; left:0; top:0; bottom:0; width: 4px; }
        .l-type-in { border-left-color: var(--success); } .l-type-in::before { background: var(--success); }
        .l-type-out { border-left-color: var(--danger); } .l-type-out::before { background: var(--danger); }
        .l-type-neutral { border-left-color: var(--text-sub); } .l-type-neutral::before { background: var(--text-sub); }
        .lc-left { display: flex; align-items: center; gap: 12px; }
        .lc-icon { width: 36px; height: 36px; border-radius: 10px; background: var(--bg-input); display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--text-sub); }
        .lc-info { display: flex; flex-direction: column; }
        .lc-title { font-weight: 700; font-size: 13px; color: white; }
        .lc-date { font-size: 10px; color: var(--text-sub); margin-top: 2px; }
        .lc-right { text-align: right; }
        .lc-amount { font-family: 'Inter', monospace; font-weight: 700; font-size: 14px; display: block; }
        .lc-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.05); color: var(--text-sub); font-weight: 600; margin-top: 4px; display: inline-block; }
        .cash-modal-btn { flex: 1; padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: var(--bg-input); color: white; font-weight: 700; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 5px; transition: 0.2s; }
        .cash-modal-btn.deposit:hover, .cash-modal-btn.deposit.active { background: rgba(16, 185, 129, 0.15); border-color: var(--success); color: var(--success); }
        .cash-modal-btn.withdraw:hover, .cash-modal-btn.withdraw.active { background: rgba(239, 68, 68, 0.15); border-color: var(--danger); color: var(--danger); }
      /* --- YENİ PİYASA LİSTE STİLLERİ (PREMIUM TASARIM) --- */
.market-filter-group { 
    display: flex; gap: 8px; padding: 0 5px 10px 5px; 
    overflow-x: auto; scrollbar-width: none; 
}
.mf-chip { 
    background: rgba(255,255,255,0.03); 
    border: 1px solid rgba(255,255,255,0.08); 
    color: var(--text-sub); 
    padding: 8px 16px; 
    border-radius: 12px; 
    font-size: 11px; font-weight: 700; 
    cursor: pointer; white-space: nowrap; 
    transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
}
.mf-chip.active { 
    background: rgba(59, 130, 246, 0.15); 
    color: var(--accent); 
    border-color: var(--accent); 
    box-shadow: 0 0 15px rgba(59, 130, 246, 0.25);
}

.infinite-list-container { 
    height: calc(100vh - 280px); /* Alt navigasyon payı */
    overflow-y: auto; 
    padding: 5px; 
    padding-bottom: 80px; 
}

/* Kart Tasarımı */
.infinite-item { 
    display: flex; justify-content: space-between; align-items: center; 
    background: linear-gradient(145deg, var(--bg-card) 0%, rgba(30, 41, 59, 0.4) 100%);
    border: 1px solid rgba(255,255,255,0.05); 
    padding: 12px 14px; 
    border-radius: 16px; 
    margin-bottom: 8px; /* Kartlar arası boşluk */
    cursor: pointer; 
    transition: transform 0.2s, background 0.2s;
    position: relative;
    overflow: hidden;
}
.infinite-item:active { 
    transform: scale(0.98); 
    background: var(--bg-input); 
}

/* Sol Taraf */
.ii-left { display: flex; align-items: center; gap: 12px; }

/* Sıralama Rozeti */
.ii-rank { 
    font-size: 10px; color: var(--text-sub); 
    width: 22px; height: 22px; 
    display: flex; align-items: center; justify-content: center;
    border-radius: 6px; 
    font-weight: 800; 
    background: rgba(255,255,255,0.03);
}
/* İlk 3 Sıra İçin Özel Renkler */
.rank-gold { background: rgba(245, 158, 11, 0.15); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
.rank-silver { background: rgba(148, 163, 184, 0.15); color: #e2e8f0; border: 1px solid rgba(148, 163, 184, 0.3); }
.rank-bronze { background: rgba(180, 83, 9, 0.15); color: #fdba74; border: 1px solid rgba(180, 83, 9, 0.3); }

.ii-info { display: flex; flex-direction: column; gap: 2px; }
.ii-sym { font-size: 14px; font-weight: 800; color: white; letter-spacing: 0.3px; }
.ii-vol { font-size: 10px; color: var(--text-sub); opacity: 0.7; font-weight: 500; }

/* Sağ Taraf */
.ii-right { text-align: right; display: flex; flex-direction: column; gap: 4px; align-items: flex-end; }
.ii-price { font-size: 15px; font-weight: 700; color: white; letter-spacing: -0.5px; }

/* Yüzde Rozeti */
.ii-change { 
    font-size: 11px; font-weight: 800; 
    padding: 4px 10px; 
    border-radius: 8px; 
    min-width: 65px; 
    text-align: center;
    display: flex; align-items: center; justify-content: center; gap: 4px;
}
.bg-up { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
.bg-down { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }

.loader-spinner { text-align: center; padding: 20px; color: var(--text-sub); font-size: 11px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; display: none; }
.loader-spinner.active { display: block; animation: pulse 1s infinite; }
/* --- MARKET DETAY MODAL (BOTTOM SHEET) --- */
.market-sheet {
    width: 100%;
    max-width: 100%;
    border-radius: 20px 20px 0 0; /* Sadece üst köşeler yuvarlak */
    padding: 20px;
    background: var(--bg-card);
    border-top: 1px solid rgba(255,255,255,0.1);
    animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    margin: 0;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.sheet-title { font-size: 18px; font-weight: 800; color: white; display: flex; align-items: center; gap: 10px; }
.sheet-close-btn { background: var(--bg-input); border: none; color: var(--text-sub); width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display:flex; align-items:center; justify-content:center;}

.chart-box-lg {
    width: 100%;
    height: 300px;
    background: #131722;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 15px;
    border: 1px solid rgba(255,255,255,0.05);
}

.sheet-actions { display: flex; gap: 10px; }
.sheet-actions .btn-main { padding: 16px; font-size: 14px; }

/* --- GELİŞMİŞ DETAY MODAL STİLLERİ --- */
.md-header-hero {
    text-align: center; padding: 20px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05); margin-bottom: 15px;
    transition: background 0.3s; border-radius: 20px 20px 0 0;
}
.md-header-hero.up { background: linear-gradient(180deg, rgba(16, 185, 129, 0.15) 0%, transparent 100%); }
.md-header-hero.down { background: linear-gradient(180deg, rgba(239, 68, 68, 0.15) 0%, transparent 100%); }

.md-big-price { font-size: 32px; font-weight: 900; color: white; letter-spacing: -1px; margin: 5px 0; }
.md-change-pill { font-size: 14px; font-weight: 700; padding: 4px 12px; border-radius: 12px; display: inline-block; }

/* Sekmeler */
.md-tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.md-tab { padding: 10px 15px; font-size: 13px; font-weight: 700; color: var(--text-sub); cursor: pointer; border-bottom: 2px solid transparent; transition: 0.2s; }
.md-tab.active { color: var(--accent); border-bottom-color: var(--accent); }

/* İçerik Alanları */
.md-content { display: none; animation: fadeIn 0.3s; }
.md-content.active { display: block; }

/* İstatistik Grid */
.md-stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.md-stat-box { background: var(--bg-input); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
.md-stat-lbl { font-size: 10px; color: var(--text-sub); text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
.md-stat-val { font-size: 14px; font-weight: 800; color: white; }

/* Range Bar (Günlük Aralık) */
.range-container { margin: 15px 0; padding: 10px; background: rgba(255,255,255,0.02); border-radius: 12px; }
.range-labels { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-sub); margin-bottom: 5px; font-weight: 700; }
.range-track { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; position: relative; overflow: hidden; }
.range-fill { height: 100%; background: linear-gradient(90deg, var(--danger), var(--gold), var(--success)); width: 100%; opacity: 0.5; }
.range-dot { position: absolute; top: 50%; transform: translate(-50%, -50%); width: 12px; height: 12px; background: white; border: 2px solid var(--bg-card); border-radius: 50%; box-shadow: 0 0 10px rgba(255,255,255,0.5); transition: left 1s cubic-bezier(0.2, 0.8, 0.2, 1); }

/* Hızlı Aksiyonlar */
.md-action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
.btn-quick { padding: 12px; border-radius: 12px; font-weight: 800; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; transition: 0.2s; }
.btn-quick:active { transform: scale(0.96); }
.bq-buy { background: rgba(16, 185, 129, 0.15); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
.bq-sell { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
.bq-sub { font-size: 9px; opacity: 0.8; font-weight: 600; }

/* --- ORTALI MODAL DÜZELTMESİ --- */

/* Dış Kaplayıcıyı Ortala */
#marketDetailModal {
    align-items: center !important; /* En alttan ortaya çeker */
    justify-content: center !important;
    padding: 20px; /* Kenarlardan biraz boşluk kalsın */
}

/* Modal Kutusunun Şeklini Değiştir */
.market-sheet {
    width: 95% !important;        /* Mobilde ekranı tam kaplamasın, kenar kalsın */
    max-width: 400px !important;  /* Tablet/PC'de çok genişlemesin */
    border-radius: 24px !important; /* Sadece üstler değil, her köşe yuvarlak olsun */
    max-height: 85vh;             /* Ekranın %85'inden büyük olmasın */
    margin: 0 auto !important;    /* Ortala */
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); /* Derinlik gölgesi ekle */
    
    /* Animasyonu değiştirelim (Alttan kayma yerine, ortada büyüme) */
    animation: modalZoomIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) !important;
}

/* Yeni Animasyon: Hafif Büyüyerek Açılma */
@keyframes modalZoomIn {
    0% { opacity: 0; transform: scale(0.9) translateY(20px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
}

/* --- GÜNCELLENMİŞ KOMPAKT & DÜZ MARKET HEADER --- */
.market-unified-header {
    /* KONUMLANDIRMA */
    position: sticky;
    top: 0;
    z-index: 100;
    
    /* BOYUTLANDIRMA & GÖRÜNÜM */
    width: 100%;
    margin: 0;
    margin-bottom: 0; /* Alt boşluğu sıfırladık */
    
    /* YENİ SIKI BOŞLUKLAR */
    padding: 8px 12px; 
    gap: 6px; /* Satırlar arası mesafe azaldı */
    
    /* ŞEKİL */
    border-radius: 0;
    border: none;
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);

    /* ARKA PLAN */
    background: rgba(21, 27, 43, 0.95);
    backdrop-filter: blur(15px);        
    -webkit-backdrop-filter: blur(15px);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);

    /* İÇ DÜZEN */
    display: flex;
    flex-direction: column;
}

/* 1. SATIR: Başlık ve Kontroller */
.muh-top-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    
    margin-bottom: 2px !important;
}

/* Sol Taraf: Toggle Switch (Daha ince) */
.view-toggle-group {
    background: var(--bg-input);
    border-radius: 20px;
    padding: 2px; /* Küçüldü */
    display: flex;
    border: 1px solid rgba(255,255,255,0.05);
}
.vt-btn {
    padding: 5px 12px; /* Butonlar inceldi */
    font-size: 11px;
    font-weight: 700;
    color: var(--text-sub);
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}
.vt-btn.active {
    background: var(--accent);
    color: white;
    box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
}

/* Sağ Taraf: Arama İkonu (Küçüldü) */
.muh-search-btn {
    width: 32px;  /* 38px -> 32px */
    height: 32px; /* 38px -> 32px */
    border-radius: 8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.05);
    color: var(--text-main);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 13px;
    transition: 0.2s;
}
.muh-search-btn.active {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
}

/* 2. SATIR: Gizli Arama Inputu */
.muh-search-container {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.muh-search-container.open {
    max-height: 50px; /* Biraz kısıldı */
    margin-bottom: 5px;
}
.muh-input-wrap {
    position: relative;
    width: 100%;
}
.muh-input {
    width: 100%;
    background: var(--bg-input);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 8px 10px 8px 35px; /* Input inceldi */
    color: white;
    font-size: 12px;
    outline: none;
}
.muh-search-icon-pos {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-sub);
    font-size: 12px;
}


/* 3. SATIR: Kategoriler (Tabs) */
/* --- GÜNCELLENMİŞ KOMPAKT TABLAR --- */

.muh-tabs-scroll {
    display: flex;
    gap: 6px; /* Butonlar arası boşluğu azalttık (10px -> 6px) */
    overflow-x: auto;
    scrollbar-width: none;
    border-bottom: none;
    padding-bottom: 0px;
    width: 100%; /* Genişliği tam kapla */
}

.muh-tab {
    flex: 1; /* SİHİRLİ KOD: Hepsi eşit genişlikte olsun ve ekrana yayılsın */
    display: flex;
    align-items: center;
    justify-content: center; /* İçeriği ortala */
    
    background: var(--bg-input); 
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 10px; /* Biraz daha az yuvarlak */
    
    /* Küçültülmüş Değerler: */
    padding: 8px 4px; /* Üst-Alt: 8px, Sağ-Sol: 4px (Kenarlardan kıstık) */
    gap: 5px; /* İkon ve yazı arasını yaklaştırdık */
    
    font-size: 11px; /* Yazı boyutu küçüldü (12px -> 11px) */
    font-weight: 700;
    color: var(--text-sub);
    white-space: nowrap;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

/* İkon Boyutu ve Renklendirme */
.muh-tab i {
    font-size: 16px; 
    opacity: 0.6; 
    transition: all 0.2s ease;
}

.muh-tab.active i {
    opacity: 1;
    transform: scale(1.15);
}

/* Kategoriye Özel Renkler */
.muh-tab:nth-child(1).active i { color: #f59e0b; } /* Kripto - Turuncu */
.muh-tab:nth-child(2).active i { color: #3b82f6; } /* BIST - Mavi */
.muh-tab:nth-child(3).active i { color: #eab308; } /* Emtia - Sarı */
.muh-tab:nth-child(4).active i { color: #10b981; } /* Döviz - Yeşil */

/* Aktif Durum */
.muh-tab.active {
    background: var(--bg-card);
    border-color: var(--accent);
    color: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

/* Aktif olunca alt çizgi yok */
.muh-tab.active::after { display: none; }


/* 4. SATIR: Filtre Çipleri (Chips) */
.muh-filters {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scrollbar-width: none;
    padding-bottom: 15px; /* Alt boşluk */
}
.muh-chip {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.05);
    color: var(--text-sub);
    padding: 6px 12px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 700;
    white-space: nowrap;
    cursor: pointer;
    transition: 0.2s;
}
.muh-chip.active {
    background: rgba(59, 130, 246, 0.15);
    color: var(--accent);
    border-color: var(--accent);
}

/* --- TOGGLE SWITCH (ANAHTAR) STİLLERİ --- */
.switch-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.switch-row:last-child { border-bottom: none; }
.switch-label { font-size: 13px; color: white; font-weight: 600; }
.switch-desc { font-size: 10px; color: var(--text-sub); display: block; margin-top: 2px; }

.tgl-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
.tgl-switch input { opacity: 0; width: 0; height: 0; }
.tgl-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-input); transition: .4s; border-radius: 34px; border: 1px solid rgba(255,255,255,0.1); }
.tgl-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .tgl-slider { background-color: var(--success); border-color: var(--success); }
input:checked + .tgl-slider:before { transform: translateX(20px); }

/* --- APP SETTINGS (DÜZELTİLMİŞ & SABİTLENMİŞ) --- */
.app-settings-container { 
    /* Üstten 80px boşluk bırakarak menünün altında kalmasını engelliyoruz */
    padding: 80px 20px 100px 20px !important; 
    
    /* İçeriğin taşmasını engellemek için */
    width: 100%;
    box-sizing: border-box;
    overflow-y: auto;
    height: 100vh;
}


/* 1. PROFİL KARTI (Aynen Koruyoruz) */
.profile-banner-card {
    background: var(--bg-card);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 20px;
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 25px;
    position: relative;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}
.profile-banner-card.premium-glow {
    background: linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(180, 83, 9, 0.05) 100%);
    border: 1px solid rgba(245, 158, 11, 0.4);
    box-shadow: 0 10px 30px rgba(245, 158, 11, 0.15);
}
.pbc-img {
    width: 60px; height: 60px; border-radius: 50%; object-fit: cover;
    border: 2px solid var(--accent); flex-shrink: 0; /* Küçülmeyi önle */
}
.profile-banner-card.premium-glow .pbc-img { border-color: var(--gold); }
.pbc-info { display: flex; flex-direction: column; }
.pbc-name { font-size: 18px; font-weight: 800; color: white; margin-bottom: 4px; }
.pbc-badge { font-size: 10px; font-weight: 700; background: rgba(255,255,255,0.1); padding: 3px 8px; border-radius: 8px; width: fit-content; }
.profile-banner-card.premium-glow .pbc-badge { background: linear-gradient(90deg, #f59e0b, #d97706); color:white; }

/* 2. TAB MENÜSÜ (SEGMENTED) */
.settings-tabs.segmented {
    display: flex; gap: 5px;
    background: rgba(255,255,255,0.03);
    padding: 4px; border-radius: 12px; margin-bottom: 20px;
}
.s-tab.seg-style {
    flex: 1; text-align: center; padding: 10px; font-size: 12px; font-weight: 600;
    color: var(--text-sub); border-radius: 8px; cursor: pointer; transition: 0.2s;
}
.s-tab.seg-style.active {
    background: var(--bg-card); color: white; font-weight: 700;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}


/* Segmented Control (iOS tarzı sekmeler) */
.settings-tabs.segmented {
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 4px;
    display: flex;
    gap: 5px;
}
.s-tab.seg-style {
    flex: 1;
    text-align: center;
    padding: 8px;
    font-size: 11px;
    font-weight: 600;
    color: var(--text-sub);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}
.s-tab.seg-style.active {
    background: var(--bg-card);
    color: white;
    font-weight: 800;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border: 1px solid rgba(255,255,255,0.05);
}



/* 3. MENÜ LİSTESİ (SORUNLU KISIM DÜZELTİLDİ) */
.menu-list-wrapper {
    background: var(--bg-card);
    border-radius: 16px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.05);
    margin-bottom: 20px;
}

/* Satır Yapısı - Flexbox Zorlaması */
.menu-list-item {
    display: flex !important; /* Kesinlikle yan yana */
    align-items: center !important;
    justify-content: space-between !important;
    width: 100% !important;
    padding: 16px !important;
    background: transparent !important; /* Arka plan karışmasın */
    border-bottom: 1px solid rgba(255,255,255,0.05);
    cursor: pointer;
    box-sizing: border-box;
}
.menu-list-item:active { background: rgba(255,255,255,0.03) !important; }
.menu-list-item:last-child { border-bottom: none; }

/* Sol Taraf (İkon + Yazı) */
.mli-left {
    display: flex !important;
    align-items: center !important;
    gap: 15px !important;
}

/* İkon Kutusu - Boyut Sabitleme */
.mli-icon-box {
    width: 36px !important;
    height: 36px !important;
    min-width: 36px !important; /* Asla küçülme */
    min-height: 36px !important;
    border-radius: 10px;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: 16px;
    color: white;
    flex-shrink: 0 !important; /* Sıkışmayı önle */
}

/* İkon Renkleri (Gradientli) */
.bg-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.bg-orange { background: linear-gradient(135deg, #f59e0b, #d97706); }
.bg-green { background: linear-gradient(135deg, #10b981, #059669); }
.bg-red { background: linear-gradient(135deg, #ef4444, #dc2626); }

.mli-text {
    font-size: 15px !important;
    font-weight: 600 !important;
    color: white !important;
    white-space: nowrap;
}

.mli-arrow { font-size: 12px; color: var(--text-sub); opacity: 0.5; }

/* Detay Sayfaları */
.settings-detail-wrapper { display: none; padding-top: 10px; }
.sub-header { 
    display: flex; 
    align-items: center; 
    margin-bottom: 20px; 
    padding-bottom: 15px; 
    border-bottom: 1px solid rgba(255,255,255,0.1);
    
    /* Geri tuşunun tıklanabilir olduğundan emin olmak için */
    position: relative; 
    z-index: 10; 
    background: var(--bg-body); /* Arka plan karışmasın */
}

.back-btn { background:none; border:none; color:var(--accent); font-size:16px; font-weight:600; display:flex; align-items:center; gap:5px; cursor:pointer;}
.sub-title { flex:1; text-align:center; font-weight:700; font-size:16px; transform:translateX(-30px); color:white; }

/* --- HABERLER SAYFASI: TIMELINE + STICKY HEADER --- */

/* 1. Üst Sabit Alan (Header) */
.news-hero-section {
    position: sticky;
    top: 0;
    z-index: 50;
    background-color: var(--bg-body); /* Arka plan rengi */
    padding: 15px 15px 0 15px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); /* Koyu gölge ile ayrım */
    display: flex;
    flex-direction: column;
    gap: 12px;
}

/* 2. Modern Arama Çubuğu */
.news-search-box {
    display: flex;
    align-items: center;
    background: var(--bg-input);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 8px 12px;
    transition: 0.3s;
}
.news-search-box:focus-within {
    border-color: var(--accent);
    box-shadow: 0 0 10px rgba(59, 130, 246, 0.2);
}
.ns-input {
    flex: 1;
    background: transparent;
    border: none;
    color: white;
    font-size: 13px;
    outline: none;
    padding: 0 10px;
}
.ns-btn {
    background: var(--accent);
    color: white;
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* 3. Durum ve Sayaç Satırı */
.news-status-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 5px;
}
.status-badge {
    font-size: 10px;
    font-weight: 800;
    color: var(--success);
    display: flex;
    align-items: center;
    gap: 6px;
    letter-spacing: 0.5px;
}
.dot-pulse {
    width: 8px;
    height: 8px;
    background: var(--success);
    border-radius: 50%;
    box-shadow: 0 0 10px var(--success);
    animation: pulseDot 2s infinite;
}
@keyframes pulseDot { 0%{opacity:1;} 50%{opacity:0.3;} 100%{opacity:1;} }

.timer-btn {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--text-sub);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* 4. Filtre Butonları */
.news-filter-chips {
    display: flex;
    gap: 8px;
    padding-bottom: 15px; /* Alt boşluk */
    overflow-x: auto;
    scrollbar-width: none;
}
.nf-chip {
    background: var(--bg-input);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--text-sub);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    white-space: nowrap;
    cursor: pointer;
}
.nf-chip.active {
    background: linear-gradient(90deg, #2563eb, #3b82f6);
    color: white;
    border: none;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
}

/* 5. Timeline (Çizgili Akış) Tasarımı */
.news-timeline-container {
    padding: 20px 20px 100px 20px;
    border-left: 2px solid rgba(255,255,255,0.1); /* Dikey Çizgi */
    margin-left: 25px; /* Soldan boşluk */
    position: relative;
}

.news-item-modern {
    position: relative;
    margin-bottom: 30px;
    padding-left: 20px;
    animation: slideIn 0.4s ease;
}

/* Timeline Noktaları (Yuvarlaklar) */
.news-item-modern::before {
    content: '';
    position: absolute;
    left: -27px; /* Çizginin tam üstüne denk gelir */
    top: 18px;   /* Kartın başlığına denk gelir */
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--bg-body); /* Ortası delik görünümü */
    border: 2px solid var(--text-sub);
    z-index: 2;
    transition: 0.3s;
}

/* İlk Haber (Son Dakika) - Kırmızı Nokta */
.news-item-modern.hot::before {
    border-color: var(--danger);
    box-shadow: 0 0 15px rgba(239, 68, 68, 0.8);
    background: var(--danger); /* İçi dolu olsun */
}

/* Yeni Haberler - Yeşil Nokta */
.news-item-modern.new::before {
    border-color: var(--success);
    box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
}

/* Haber Kartı */
.nim-card {
    background: var(--bg-card);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 16px;
    padding: 16px;
    cursor: pointer;
    transition: transform 0.2s;
}
.nim-card:active { transform: scale(0.98); background: var(--bg-input); }

.nim-time {
    font-size: 11px;
    color: var(--text-sub);
    font-weight: 700;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.nim-title {
    font-size: 14px;
    font-weight: 700;
    color: white;
    line-height: 1.5;
    margin-bottom: 12px;
}
.nim-source {
    font-size: 11px;
    color: var(--accent);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 5px;
}

/* --- HABER GÖRSELLERİ İÇİN YENİ CSS --- */

/* Haber kartını yatay düzen (flex row) yapıyoruz */
.nim-card {
    display: flex !important; /* Flex düzeni zorla */
    flex-direction: row !important; /* Yan yana sırala */
    align-items: center;
    gap: 12px; /* Görsel ile metin arası boşluk */
    padding: 10px !important; /* İç boşluğu düzenle */
}

/* Görsel Kutusu */
/* Görsel Kutusu - GÜNCELLENDİ (DAHA BÜYÜK) */
.nim-img-box {
    flex-shrink: 0;       /* Kutunun küçülmesini engelle */
    width: 90px;          /* ESKİSİ: 64px -> YENİSİ: 90px */
    height: 90px;         /* ESKİSİ: 64px -> YENİSİ: 90px */
    border-radius: 12px;  /* Köşeleri biraz daha yumuşattık */
    overflow: hidden;
    background: rgba(255,255,255,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid rgba(255,255,255,0.05);
    box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* Hafif gölge ekledik */
}

/* Görselin Kendisi */
.nim-img-box img {
    width: 100%;
    height: 100%;
    object-fit: cover; /* Görseli kutuya doldur, bozma */
}

/* Görsel Yoksa Çıkacak İkon */
.nim-placeholder-icon {
    font-size: 24px;
    color: var(--text-sub);
    opacity: 0.5;
}

/* Metin Alanı */
.nim-content {
    flex: 1; /* Kalan alanı kapla */
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-width: 0; /* Metin taşmasını önlemek için kritik */
}

/* Başlık stili güncellemesi */
.nim-title {
    margin-bottom: 6px;
    line-height: 1.3;
    max-height: 40px; /* Çok uzun başlıkları sınırla */
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Max 2 satır göster */
    -webkit-box-orient: vertical;
}

/* --- SPLASH SCREEN YASAL LİNKLER --- */
.splash-legal-footer {
    position: absolute;
    bottom: 30px;        /* Ekranın en altından 30px yukarıda */
    width: 100%;
    text-align: center;
    z-index: 2;
    opacity: 0;          /* Başlangıçta gizli */
    animation: fadeUpText 0.5s ease-out forwards 1s; /* Logo geldikten sonra belirsin */
}

.splash-legal-footer a {
    color: rgba(255, 255, 255, 0.5); /* Hafif silik beyaz */
    text-decoration: none;
    font-size: 11px;
    font-weight: 600;
    transition: color 0.3s;
    font-family: 'Inter', sans-serif;
}

.splash-legal-footer a:hover {
    color: #ffffff;      /* Üzerine gelince parlasın */
    text-decoration: underline;
}

.splash-legal-footer .sep {
    color: rgba(255, 255, 255, 0.2);
    margin: 0 8px;
    font-size: 10px;
}

/* --- YENİ LAB LİSTE TASARIMI --- */
.lab-list-container {
    max-height: 350px;
    overflow-y: auto;
    padding-right: 5px; /* Scrollbar için boşluk */
}

.lab-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(145deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 12px 15px;
    margin-bottom: 8px;
    transition: transform 0.2s;
}

.lab-row:hover {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.1);
}

.lab-col-left {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.lab-month-badge {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-sub);
    text-transform: uppercase;
    letter-spacing: 1px;
    background: rgba(255,255,255,0.05);
    padding: 3px 8px;
    border-radius: 6px;
    width: fit-content;
}

.lab-balance-val {
    font-size: 15px;
    font-weight: 800;
    color: white;
    letter-spacing: 0.5px;
}

.lab-col-right {
    text-align: right;
}

.lab-profit-lbl {
    font-size: 9px;
    color: var(--text-sub);
    display: block;
    margin-bottom: 2px;
}

.lab-profit-val {
    font-size: 13px;
    font-weight: 800;
    color: var(--success);
    text-shadow: 0 0 10px rgba(16, 185, 129, 0.2);
}

/* --- MUHASEBE & DENETİM TASARIMI --- */
.accounting-hero {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid rgba(255,255,255,0.05);
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.acc-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.acc-row:last-child { margin-bottom: 0; padding-bottom: 0; border: none; }

.acc-stat-box { flex: 1; }
.acc-stat-box.right { text-align: right; }

.acc-val-lg { font-size: 24px; font-weight: 800; color: white; letter-spacing: -0.5px; }
.acc-val-sm { font-size: 16px; font-weight: 700; color: white; }
.acc-lbl-sub { font-size: 10px; color: var(--text-sub); text-transform: uppercase; font-weight: 700; }

.trash-btn {
    width: 100%;
    background: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    border: 1px dashed rgba(239, 68, 68, 0.3);
    padding: 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 15px;
    transition: 0.2s;
}
.trash-btn:hover { background: rgba(239, 68, 68, 0.2); }

/* Silinen Öğe Kartı */
.deleted-item {
    background: rgba(0,0,0,0.3);
    border-left: 3px solid var(--text-sub);
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    opacity: 0.7;
}
.del-restore-btn {
    background: var(--success);
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 700;
    cursor: pointer;
}
/* --- YENİ HEDEF BARI VE LİSTE STİLLERİ (FİNAL) --- */

/* 1. İnce Barın Dış Çerçevesi */
.goal-strip-container {
    height: 24px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    position: relative;
    overflow: hidden;
    margin-top: 5px;
    border: 1px solid rgba(255,255,255,0.1);
}

/* 2. Barın İçindeki Renkli Dolgu */
.goal-strip-fill {
    height: 100%;
    width: 0%; /* JS ile artacak */
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    font-size: 11px;
    font-weight: 800;
    color: #fff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    transition: width 1s ease, background 1s ease;
    white-space: nowrap;
}

/* 3. Renk Aşamaları (Kırmızı -> Sarı -> Yeşil) */
.gs-red { background: linear-gradient(90deg, #7f1d1d, #ef4444); } 
.gs-yellow { background: linear-gradient(90deg, #b45309, #f59e0b); } 
.gs-green { background: linear-gradient(90deg, #065f46, #10b981); }

/* 4. Günlük Kayıt Listesi Kutusu */
.daily-log-container {
    max-height: 200px;
    overflow-y: auto;
    background: rgba(0,0,0,0.2);
    border-radius: 12px;
    padding: 5px;
    border: 1px solid rgba(255,255,255,0.05);
}

/* 5. Listedeki Satırlar */
.daily-log-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    font-size: 11px;
    transition: background 0.2s;
}
.daily-log-row:last-child { border-bottom: none; }
.log-date { color: var(--text-sub); font-weight: 600; }
/* Hedef Barı Yazı Katmanı */
.goal-text-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: space-between; /* Yazıları iki uca yasla */
    align-items: center;
    padding: 0 10px;
    font-size: 10px;
    font-weight: 800;
    z-index: 5; /* Barın üstünde dursun */
    pointer-events: none; /* Tıklamayı engellemesin */
}

/* PSİKOLOJİ SEKMESİ STİLLERİ */
.regret-item {
    background: rgba(255,255,255,0.03);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 8px;
    border: 1px solid rgba(255,255,255,0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.regret-item.missed { border-left: 3px solid var(--danger); } /* Kaçan Fırsat (Kırmızı) */
.regret-item.saved { border-left: 3px solid var(--success); }  /* İyi ki satmışsın (Yeşil) */

.ri-left { display: flex; flex-direction: column; }
.ri-sym { font-weight: 800; font-size: 13px; color: white; }
.ri-date { font-size: 10px; color: var(--text-sub); }

.ri-right { text-align: right; }
.ri-val { font-weight: 800; font-size: 13px; }
.ri-badge { font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: 700; display: inline-block; margin-top: 2px; }

.missed .ri-val { color: var(--danger); }
.missed .ri-badge { background: rgba(239, 68, 68, 0.15); color: var(--danger); }

.saved .ri-val { color: var(--success); }
.saved .ri-badge { background: rgba(16, 185, 129, 0.15); color: var(--success); }

    </style>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5912166843737955"
     crossorigin="anonymous"></script>
     
     
     <head>
    
<body>
    <canvas id="bg-canvas"></canvas>
 

<div id="splash-screen">
    
    <div class="original-logo-container">
        <div class="original-logo-container" style="
            display:flex; 
            flex-direction:column; 
            align-items:center; 
            position:relative;
            background: radial-gradient(circle at center, rgba(30, 58, 138, 0.2) 0%, rgba(0,0,0,0) 70%);
            padding: 40px;
            border-radius: 50%;
        ">
    
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 240 240" width="160" height="160">
                <defs>
                    <linearGradient id="deepCoreGrad" x1="0" y1="240" x2="240" y2="0" gradientUnits="userSpaceOnUse">
                        <stop offset="0%" stop-color="#0f172a"/> <stop offset="50%" stop-color="#1e3a8a"/> <stop offset="100%" stop-color="#3b82f6"/> 
                    </linearGradient>
                    
                    <linearGradient id="activePathGrad" x1="0" y1="100" x2="240" y2="100" gradientUnits="userSpaceOnUse">
                        <stop offset="0%" stop-color="#3b82f6"/>
                        <stop offset="50%" stop-color="#06b6d4"/> <stop offset="100%" stop-color="#10b981"/> 
                    </linearGradient>

                    <filter id="internalGlow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur"/>
                        <feColorMatrix in="blur" type="matrix" values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 18 -7" result="goo" />
                        <feComposite in="SourceGraphic" in2="goo" operator="atop"/>
                    </filter>
                    
                    <filter id="outerGlow" height="300%" width="300%" x="-75%" y="-75%">
                        <feMorphology operator="dilate" radius="2" in="SourceAlpha" result="thicken" />
                        <feGaussianBlur in="thicken" stdDeviation="8" result="blurred" />
                        <feFlood flood-color="rgba(59, 130, 246, 0.6)" result="glowColor" />
                        <feComposite in="glowColor" in2="blurred" operator="in" result="softGlow_colored" />
                        <feMerge>
                            <feMergeNode in="softGlow_colored"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>

                <g opacity="0.2" stroke="#64748b" stroke-width="1" fill="none">
                    <path d="M40 200 L 90 150 L 200 180" />
                    <path d="M20 120 L 80 140 L 160 100" />
                    <circle cx="90" cy="150" r="3" fill="#64748b"/>
                    <circle cx="160" cy="100" r="3" fill="#64748b"/>
                </g>

                <path d="M120 30 L 190 80 L 190 160 L 120 210 L 50 160 L 50 80 Z" 
                    fill="url(#deepCoreGrad)" stroke="rgba(59, 130, 246, 0.3)" stroke-width="2" opacity="0.9"/>
                
                <path d="M50 80 L 120 30 L 190 80" stroke="rgba(255,255,255,0.4)" stroke-width="1" fill="none"/>

                <g filter="url(#outerGlow)">
                    <path d="M75 150 L 110 170 L 150 140 L 150 70 L 185 40" 
                        stroke="url(#activePathGrad)" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </g>

                <circle cx="185" cy="40" r="6" fill="#ffffff" filter="url(#internalGlow)">
                    <animate attributeName="r" values="6;9;6" dur="2.5s" repeatCount="indefinite"/>
                    <animate attributeName="opacity" values="1;0.6;1" dur="2.5s" repeatCount="indefinite"/>
                </circle>
            </svg>

            <div style="text-align:center; z-index:1; margin-top: 5px;">
                <h1 style="
                    margin: 0;
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
                    font-size: 38px; 
                    font-weight: 900; 
                    color: #ffffff; 
                    letter-spacing: -1px;
                    text-shadow: 0 4px 20px rgba(59, 130, 246, 0.5);
                ">
                    TRADE<span style="
                        background: linear-gradient(to right, #60a5fa, #34d399); 
                        -webkit-background-clip: text; 
                        -webkit-text-fill-color: transparent;
                        font-weight: 900;
                    ">VIA</span>
                </h1>
                
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    margin-top: 8px;
                ">
                    <div style="width: 20px; height: 1px; background: rgba(148, 163, 184, 0.5);"></div>
                    <p style="
                        margin: 0;
                        font-family: 'Inter', sans-serif; 
                        font-size: 11px; 
                        font-weight: 600; 
                        color: #cbd5e1; 
                        letter-spacing: 3px; 
                        text-transform: uppercase;
                    ">
                        Gelişmiş Finans Terminali
                    </p>
                    <div style="width: 20px; height: 1px; background: rgba(148, 163, 184, 0.5);"></div>
                </div>
            </div>
        </div>
    </div> <div class="splash-loader-bar"></div>

    <div class="splash-legal-footer">
        <a href="gizlilik.html" target="_blank">Gizlilik Politikası</a>
        <span class="sep">•</span>
        <a href="kullanim-kosullari.html" target="_blank">Yasal Uyarı</a>
        <span class="sep">•</span>
        <a href="iletisim.html" target="_blank">İletişim</a>
    </div>

        
    </div>

</div>

    </div>
    


    
</div>

<div class="top-bar">
    <div style="display:flex; align-items:center;">
        <div id="manualBackBtn" onclick="goBackHome()" style="display:none; margin-right:10px; cursor:pointer; width:30px; height:30px; align-items:center; justify-content:center;">
            <i class="fas fa-arrow-left" style="font-size:18px; color:white;"></i>
        </div>
        
        <div class="app-title">Trade<span>Via</span></div>
        
        <div  
        <span style="font-size:12px; color:#f59e0b; opacity:0.8;">BETA</span></div>

        
    </div>
    
    <div class="header-icons">
        <div class="icon-btn" onclick="switchPage('notifications', document.querySelector('.nav-item'))">
            <i class="fas fa-bell"></i>
            <span id="notifBadge" class="notif-badge">0</span>
        </div>
    </div>
</div>


<div class="content-area">
    <div id="page-portfolio" class="page active">
        <div class="balance-hero">
            <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:5px;">
                <span class="lbl-sm" data-lang="total_assets">TOPLAM VARLIK</span>
                <button onclick="togglePrivacy()" style="background:none; border:none; color:var(--text-sub); cursor:pointer;"><i class="fas fa-eye"></i></button>
            </div>
            <div class="val-lg" id="totalWallet">--</div>
            <div class="hero-stats-row">
                <div class="hero-pill"><i class="fas fa-coins"></i> Kâr: <span id="realizedPnLVal">--</span></div>
                <div class="hero-pill cash"><i class="fas fa-wallet"></i> Nakit: <span id="cashBalance">--</span></div>
            </div>
            <div class="hero-actions">
                <button class="hero-btn" onclick="modifyCash(1)"><i class="fas fa-plus"></i> Yatır</button>
                <button class="hero-btn" onclick="modifyCash(-1)"><i class="fas fa-minus"></i> Çek</button>
                <button class="hero-btn" onclick="addDividend()"><i class="fas fa-gift"></i> Temettü</button>
            </div>
        </div>

        <div class="trade-card" id="tradeCard">
            <div class="trade-header collapsible-header" onclick="toggleTradeMenu()">
                <div class="trade-title">
                    <i class="fas fa-chevron-down rotate-icon" id="tradeChevron" style="font-size:12px; margin-right:5px; color:var(--text-sub);"></i>
                    <i class="fas fa-bolt" style="color:var(--gold)"></i> Hızlı İşlem
                </div>
                <button id="currencyToggle" class="currency-toggle-btn active-try" onclick="event.stopPropagation(); toggleEntryCurrency()">₺</button>
            </div>
            <div id="tradeContent" class="collapsible-content collapsed">
                <div style="padding-top:10px;">
                    <div class="trade-input-group">
                        <i class="fas fa-search input-icon"></i>
                        <input type="text" id="addSymbol" class="trade-input" style="text-transform:uppercase;" placeholder="Sembol (BTC, THYAO, ARB...)" onkeyup="debouncedPreview(this.value); calcDca();">
                    </div>
                    <div id="liveInfo" style="font-size:11px; color:var(--text-sub); margin-bottom:10px; height:15px; padding-left:5px; font-weight:600;"></div>
                    <div class="input-row">
                        <div class="trade-input-group"><i class="fas fa-layer-group input-icon"></i><input type="number" id="addAmount" class="trade-input" placeholder="Adet" onkeyup="calcDca(); calcLiveTotal();"></div>
                        <div class="trade-input-group"><i class="fas fa-tag input-icon"></i><input type="number" id="addBuyPrice" class="trade-input" placeholder="Fiyat" onkeyup="calcDca(); calcLiveTotal();"></div>
                    </div>
                    <div id="dcaPreview" style="display:none; margin-bottom:10px; font-size:11px; padding:8px; background:rgba(59,130,246,0.1); border-radius:8px; color:var(--accent);"><i class="fas fa-calculator"></i> <span id="dcaText">--</span></div>
                    <div class="trade-summary-box"><span class="ts-label">TOPLAM TUTAR</span><span class="ts-val" id="liveTradeTotal">0.00</span></div>
                    <button class="add-btn-pro" onclick="addToPortfolio()" data-lang="add_btn">PORTFÖYE EKLE</button>
                </div>
            </div>
        </div>
        <div id="portfolioList"></div>
    </div>

    <div id="page-notifications" class="page"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><div class="ac-title" style="font-weight:800; font-size:16px; color:white;">BİLDİRİMLER</div><button class="tool-btn" onclick="clearNotifications()" style="font-size:11px; color:var(--text-sub);">TEMİZLE</button></div><div id="notificationList"></div></div>
    
    <div id="page-market" class="page" style="padding: 0; padding-bottom: 80px;">
    
    <div class="market-unified-header">
        
        <div class="muh-top-row">
            <div class="view-toggle-group">
                <div id="btn-view-main" class="vt-btn active" onclick="switchMarketMode('main', this)">Piyasa</div>
                <div id="btn-view-watch" class="vt-btn" onclick="switchMarketMode('watchlist', this)">İzleme Listem</div>
            </div>
            
            <div class="muh-search-btn" onclick="toggleUnifiedSearch(this)">
                <i class="fas fa-search"></i>
            </div>
        </div>

        <div id="unifiedSearchBox" class="muh-search-container">
            <div class="muh-input-wrap">
                <i class="fas fa-search muh-search-icon-pos"></i>
                <input type="text" id="unifiedSearchInput" class="muh-input" placeholder="Sembol ara..." onkeyup="filterUnifiedList(this.value)">
            </div>
        </div>

        <div id="unifiedCategories" class="muh-tabs-scroll">
    <div class="muh-tab active" onclick="loadMarketCategory('kripto', this)">
        <i class="fab fa-bitcoin"></i>
        <span>Kripto</span>
    </div>
    
    <div class="muh-tab" onclick="loadMarketCategory('hisse', this)">
        <i class="fas fa-chart-line"></i>
        <span>BIST 100</span>
    </div>
    
    <div class="muh-tab" onclick="loadMarketCategory('altin', this)">
        <i class="fas fa-gem"></i>
        <span>Emtia</span>
    </div>
    
    <div class="muh-tab" onclick="loadMarketCategory('doviz', this)">
        <i class="fas fa-money-bill-wave"></i>
        <span>Döviz</span>
    </div>
</div>
        <div id="unifiedFilters" class="muh-filters" style="display:none !important;"></div>


    </div>
    <div style="padding: 0 15px;">
        
        <div id="mv-main" class="market-view-section active">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:10px; color:var(--text-sub); font-weight:700; text-transform:uppercase; padding:0 5px;">
                <span>Varlık</span>
                <span>Fiyat / 24S</span>
            </div>
            <div id="infiniteMarketList" class="infinite-list-container" style="height: calc(100vh - 280px); overflow-y: auto; padding-bottom: 20px;"></div>

            <div id="marketLoader" class="loader-spinner">Yükleniyor...</div>
        </div>

        <div id="mv-watchlist" class="market-view-section">
            <div id="wlLiveInfo" style="font-size:11px; color:var(--text-sub); text-align:center; margin-bottom:10px;"></div>
            <div id="wlList" style="padding-bottom:100px;"></div>
        </div>

    </div>
</div>
  <div id="page-news" class="page" style="padding:0;">

    <div class="news-hero-section">
        
        <div class="news-search-box">
            <i class="fas fa-search" style="color:var(--text-sub)"></i>
            <input type="text" id="newsSearchInput" class="ns-input" placeholder="Haberlerde ara... (Örn: Fed, Altın)" onkeyup="if(event.key === 'Enter') runNewsSearch()">
            <button class="ns-btn" onclick="runNewsSearch()"><i class="fas fa-arrow-right"></i></button>
        </div>
        
        <div class="news-status-row">
            <div class="status-badge">
                <div class="dot-pulse"></div>
                CANLI YAYIN
            </div>
            <button class="timer-btn" onclick="toggleAutoRefresh(this)">
                <i class="fas fa-sync-alt fa-spin" id="refreshIcon"></i> 
                <span id="refreshTimer">57s</span>
            </button>
        </div>

        <div class="refresh-bar-container" style="margin:0;">
            <div id="refreshBar" class="refresh-bar-fill"></div>
        </div>

        <div class="news-filter-chips">
            <div class="nf-chip active" onclick="filterNews('GENEL', this)">🔥 Manşet</div>
            <div class="nf-chip" onclick="filterNews('EKONOMİ', this)">Ekonomi</div>
            <div class="nf-chip" onclick="filterNews('KRİPTO', this)">Kripto</div>
            <div class="nf-chip" onclick="filterNews('BORSA', this)">Borsa</div>
            <div class="nf-chip" onclick="filterNews('EMTİA', this)">Altın</div>
        </div>
    </div> 

    <div id="newsTimeline" class="news-timeline-container">
        <div style="text-align:center; padding:40px; color:var(--text-sub);">
            <i class="fas fa-circle-notch fa-spin"></i> Yükleniyor...
        </div>
    </div>

</div>

    <div id="page-analysis" class="page">
    
    <div style="margin-bottom: 20px;">
        <h2 style="margin:0; font-size:22px; font-weight:800; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Finansal Planlama</h2>
        <span style="font-size:12px; color:var(--text-sub);">Gelecekteki Varlığınızı Bugünden Kurgulayın</span>
    </div>

    <div class="settings-tabs segmented" style="margin-bottom: 20px;">
        <div class="s-tab seg-style active" onclick="switchAnTab('perf', this)">PERFORMANS</div>
        
        <div class="s-tab seg-style" onclick="switchAnTab('vision', this)">HEDEFLERİM</div>
        <div class="s-tab seg-style" onclick="switchAnTab('psycho', this)">PSİKOLOJİ</div>

        <div class="s-tab seg-style" onclick="switchAnTab('lab', this)">AR-GE</div>
    </div>

    
        <div id="an-view-perf" class="an-view-section active">
        <div class="dashboard-container">
            
            <div class="dash-card full-width">
                <div class="metric-title">
                    <i class="fas fa-wallet"></i> TOPLAM NET VARLIK
                </div>
                <div class="metric-value" id="anNetWorth">--</div>
                <div class="metric-sub" id="anNetWorthSub">
                    <span id="anPnlPill">--</span> <span style="color:var(--text-sub)">Toplam Kâr/Zarar</span>
                </div>
            </div>

            <div class="dash-card">
                <div class="metric-title">BAŞARI ORANI</div>
                <div class="win-rate-container">
                    <canvas id="winRateChart"></canvas>
                    <div class="win-rate-text">
                        <span class="wr-val" id="winRateVal">%--</span>
                        <span class="wr-lbl">Win Rate</span>
                    </div>
                </div>
            </div>

            <div class="dash-card">
                <div class="metric-title">NAKİT ORANI</div>
                <div style="display:flex; flex-direction:column; height:100%; justify-content:center;">
                    <div class="metric-value" id="anCashRatioVal" style="font-size:20px;">--</div>
                    <div class="goal-wrapper" style="margin-top:5px;">
                        <div id="cashRatioBar" class="goal-fill" style="width:0%"></div>
                    </div>
                    <div style="font-size:10px; color:var(--text-sub); margin-top:5px;">Kasada: <span id="anCashRaw">--</span></div>
                </div>
            </div>

            <div class="dash-card full-width" style="background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%); border: 1px solid rgba(255,255,255,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <div class="metric-title" style="margin:0;"><i class="fas fa-graduation-cap" style="color:var(--gold)"></i> TRADER KARNESİ</div>
                    <div id="scoreBadge" style="background:rgba(255,255,255,0.1); padding:4px 10px; border-radius:8px; font-size:10px; font-weight:800; color:var(--text-sub);">VERİ YOK</div>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:10px; text-align:center;">
                        <div style="font-size:9px; color:var(--text-sub); font-weight:700;">KÂR FAKTÖRÜ</div>
                        <div id="pfScore" style="font-size:18px; font-weight:800; margin-top:2px;">--</div>
                        <div id="pfDesc" style="font-size:9px; opacity:0.6;">Bekleniyor</div>
                    </div>

                    <div style="background:rgba(255,255,255,0.03); padding:10px; border-radius:10px; text-align:center;">
                        <div style="font-size:9px; color:var(--text-sub); font-weight:700;">İŞLEM BEKLENTİSİ</div>
                        <div id="expScore" style="font-size:18px; font-weight:800; margin-top:2px;">--</div>
                        <div id="expDesc" style="font-size:9px; opacity:0.6;">Bekleniyor</div>
                    </div>
                    
                    <div style="grid-column: span 2; background:rgba(255,255,255,0.03); padding:10px 15px; border-radius:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div style="text-align:left;">
                            <div style="font-size:9px; color:var(--success); font-weight:700;">ORT. KAZANÇ</div>
                            <div id="avgWinVal" style="font-size:14px; font-weight:800;">--</div>
                        </div>
                        <div style="height:25px; width:1px; background:rgba(255,255,255,0.1);"></div>
                        <div style="text-align:right;">
                            <div style="font-size:9px; color:var(--danger); font-weight:700;">ORT. KAYIP</div>
                            <div id="avgLossVal" style="font-size:14px; font-weight:800;">--</div>
                        </div>
                    </div>
                </div>
                
                <div style="font-size:9px; color:var(--text-sub); text-align:center; font-style:italic; margin-top:10px;">
                    * Geçmiş satış işlemleriniz üzerinden hesaplanır.
                </div>
            </div>

            <div class="dash-card full-width">
                <div class="chart-header">
                    <div class="metric-title"><i class="fas fa-chart-line"></i> PORTFÖY BÜYÜMESİ</div>
                    <div style="display:flex; gap:5px;">
                        <button class="chart-filter-btn active" onclick="updateGrowthChart(7)">7G</button>
                        <button class="chart-filter-btn" onclick="updateGrowthChart(30)">30G</button>
                    </div>
                </div>
                <div style="height: 220px; width: 100%;">
                    <canvas id="realGrowthChart"></canvas>
                </div>
                <div style="font-size:10px; color:var(--text-sub); text-align:center; margin-top:10px;">
                    <i class="fas fa-info-circle"></i> Grafik, her gün sisteme giriş yaptığınızda otomatik kaydedilir.
                </div>
            </div>

            <div class="dash-card full-width">
                <div class="metric-title">EN ÇOK KAZANDIRANLAR</div>
                <div id="topPerformersList"></div>
            </div>

            <div class="dash-card full-width">
                <div class="metric-title">VARLIK DAĞILIMI</div>
                <div style="height: 200px; display:flex; justify-content:center;">
                    <canvas id="newAllocationChart"></canvas>
                </div>
            </div>
        </div> 
    </div>

    <div id="an-view-vision" class="an-view-section" style="display:none;">
    
    <div style="margin-bottom: 20px;">
        <div style="display:flex; justify-content:flex-end; align-items:center; margin-bottom:5px;">
            <button onclick="editTargetGoal()" style="background:none; border:none; color:var(--text-sub); font-size:10px; cursor:pointer;">
                <i class="fas fa-edit"></i> Hedefi Düzenle
            </button>
        </div>
        <div class="goal-strip-container" style="position: relative;">
            <div id="dynamicGoalBar" class="goal-strip-fill gs-red" style="width: 0%;"></div>
            <div class="goal-text-overlay">
                <span id="goalCurrentText" style="color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">%0</span>
                <span id="goalTargetTextRight" style="color: #d8b4fe; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">HEDEF: --</span>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="lbl-sm">SİMÜLASYON AYARLARI</div>
        <div class="input-row">
            <div>
                <span style="font-size:11px; color:var(--text-sub);">Aylık Kâr Beklentisi (%)</span>
                <input type="number" id="visionRate" class="modern-input" value="5" placeholder="Örn: 5">
            </div>
            <div>
                <span style="font-size:11px; color:var(--text-sub);">Aylık Ek Yatırım (Nakit)</span>
                <input type="number" id="visionAdd" class="modern-input" value="1000" placeholder="Örn: 1000">
            </div>
        </div>
        
        <button class="btn-main" style="margin-top:10px; background: linear-gradient(90deg, #8b5cf6, #d946ef);" onclick="manualUpdateVision()">
            <i class="fas fa-calculator"></i> SİMÜLASYONU GÜNCELLE
        </button>
    </div>

    <div class="dash-card full-width" style="padding-bottom: 10px;">
        <div class="metric-title" style="display:flex; justify-content:space-between;">
            <span>BÜYÜME GRAFİĞİ</span>
            <div style="display:flex; gap:8px; font-size:9px;">
                <span style="color:#d946ef;">● Tahmini</span>
                <span style="color:#f97316;">● Anapara</span>
            </div>
        </div>
        
        <div style="position: relative; height: 250px; width: 100%;">
            <canvas id="visionChart"></canvas>
        </div>
    </div>

    <div style="margin-top:20px;">
        <div class="lbl-sm">GÜNLÜK KAZANÇ RAPORU</div>
        <div id="dailyLogList" class="daily-log-container">
            <div style="text-align:center; padding:20px; color:var(--text-sub);">Veriler yükleniyor...</div>
        </div>
    </div>
</div>


    <div id="an-view-lab" class="an-view-section" style="display:none;">
        
        <div style="display:flex; gap:10px; overflow-x:auto; margin-bottom:15px; padding-bottom:5px;">
            <button class="chart-filter-btn active" onclick="switchLabTool('growth', this)">Büyüme</button>
            <button class="chart-filter-btn" onclick="switchLabTool('risk', this)">Risk Hesabı</button>
            <button class="chart-filter-btn" onclick="switchLabTool('avg', this)">Maliyet Düşür</button>
            <button class="chart-filter-btn" onclick="switchLabTool('time', this)" style="border:1px solid #8b5cf6; color:#a78bfa;">
    Zaman Makinesi
</button>

        </div>

        <div id="lab-tool-growth" class="lab-tool-container">
            <div style="background:var(--bg-card); padding:20px; border-radius:16px; border:1px dashed var(--accent); margin-bottom:20px; text-align:center;">
                <i class="fas fa-flask" style="font-size:32px; color:var(--accent); margin-bottom:10px;"></i>
                <div style="font-weight:800; font-size:16px;">Strateji Test Laboratuvarı</div>
                <div style="font-size:11px; color:var(--text-sub);">Bileşik getirinin gücünü test edin.</div>
            </div>

            <div class="card">
                <div class="lbl-sm">DENEY PARAMETRELERİ</div>
                <div class="input-row">
                    <div><span style="font-size:11px; color:var(--text-sub);">Başlangıç Sermayesi</span><input type="number" id="labStart" class="modern-input" placeholder="Örn: 10000"></div>
                    <div><span style="font-size:11px; color:var(--text-sub);">İşlem Başı Kâr Hedefi (%)</span><input type="number" id="labWinPct" class="modern-input" value="2"></div>
                </div>
                <div class="input-row">
                    <div><span style="font-size:11px; color:var(--text-sub);">Haftalık İşlem Sayısı</span><input type="number" id="labFreq" class="modern-input" value="2"></div>
                    <div><span style="font-size:11px; color:var(--text-sub);">Süre (Ay)</span><input type="number" id="labDuration" class="modern-input" value="12"></div>
                </div>
                <button class="btn-main" onclick="runLabTest()">DENEYİ BAŞLAT</button>
            </div>

            <div id="labResults" style="display:none;">
                <div class="dash-card full-width" style="background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%); margin-bottom: 15px;">
                    <div class="metric-title">DENEY SONUCU</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:10px;">
                        <div><div style="font-size:10px; color:var(--text-sub);">BAŞLANGIÇ</div><div id="resLabStart" style="font-size:16px; font-weight:700; color:white;">--</div></div>
                        <div style="text-align:right;"><div style="font-size:10px; color:var(--text-sub);">BİTİŞ (TAHMİNİ)</div><div id="resLabEnd" style="font-size:20px; font-weight:800; color:var(--success);">--</div></div>
                    </div>
                    <div style="margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1);">
                        <span style="font-size:11px; color:var(--text-sub);">Toplam Büyüme:</span> <span id="resLabGrowth" style="font-weight:700; color:var(--accent);">--</span>
                    </div>
                </div>
                <div style="margin-bottom: 10px;"><div class="lbl-sm" style="margin-bottom: 10px;">AYLIK İLERLEME RAPORU</div><div id="labListContainer" class="lab-list-container"></div></div>
            </div>
        </div>

        <div id="lab-tool-risk" class="lab-tool-container" style="display:none;">
            <div class="card" style="border-left: 3px solid var(--danger);">
                <div class="lbl-sm" style="color:var(--danger)">RİSK & POZİSYON YÖNETİMİ</div>
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
        <div style="width:40px; height:40px; background:rgba(239, 68, 68, 0.2); border-radius:10px; display:flex; align-items:center; justify-content:center;">
            <i class="fas fa-radiation" style="color:#ef4444; font-size:20px;"></i>
        </div>
        <div>
            <div style="font-weight:800; font-size:16px; color:white;">KAOS ODASI</div>
            <div style="font-size:10px; color:var(--text-sub);">Portföyün krizlere ne kadar dayanıklı?</div>
        </div>
    </div>

    <div class="card" style="background: linear-gradient(145deg, #2a0a0a 0%, #1a0505 100%); border: 1px solid #450a0a;">
        <div class="lbl-sm" style="color:#fca5a5;">SENARYO SEÇ</div>
        
        <select id="chaosScenario" class="modern-input" style="background:rgba(0,0,0,0.3); border-color:#7f1d1d; color:#fecaca;" onchange="runChaosSimulation()">
            <option value="0">Senaryo Seçiniz...</option>
            <option value="crypto_winter"> Kripto Kışı (Bitcoin -%60)</option>
            <option value="market_crash"> Küresel Borsa Çöküşü (-%35)</option>
            <option value="currency_shock">Kur Şoku (Dolar +%40)</option>
            <option value="gold_rush"> Güvenli Liman (Altın +%25)</option>
            <option value="black_monday"> Kara Pazartesi (Her Şey -%20)</option>
        </select>

        <div id="chaosResult" style="display:none; margin-top:15px; animation: fadeIn 0.5s;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <span style="font-size:11px; color:#fca5a5;">Senaryo Sonrası Tahmini Bakiye</span>
            </div>
            
            <div style="font-size:24px; font-weight:800; color:white;" id="chaosBalance">--</div>
            
            <div class="goal-strip-container" style="background:rgba(0,0,0,0.5); margin-top:5px; height:30px;">
                <div id="chaosBar" class="goal-strip-fill" style="width: 100%; background:var(--text-sub);"></div>
                <div class="goal-text-overlay">
                    <span id="chaosChangeText" style="color:white; text-shadow:0 1px 2px black;">--</span>
                </div>
            </div>

            <div style="margin-top:15px; font-size:11px; line-height:1.4; color:#d1d5db; background:rgba(0,0,0,0.3); padding:10px; border-radius:8px;">
                <i class="fas fa-info-circle" style="color:#fca5a5;"></i> 
                <span id="chaosAdvice">--</span>
            </div>
        </div>
    </div>
</div>

                <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:10px; color:var(--text-sub); font-weight:700;">PORTFÖYDEN SEÇ</span>
                        <button onclick="populateRiskAssets()" style="background:none; border:none; color:var(--accent); font-size:12px; cursor:pointer;">
                            <i class="fas fa-sync-alt"></i> Yenile
                        </button>
                    </div>
                    <select id="riskAssetSelect" class="modern-input" style="margin-top:5px; border-color:var(--accent);" onchange="fillRiskFromAsset()">
                        <option value="-1">Manuel Giriş / Seçiniz</option>
                    </select>
                </div>

                <div class="input-row">
                    <div>
                        <span style="font-size:11px; color:var(--text-sub);">Sermaye (Varlık Değeri)</span>
                        <input type="number" id="riskBalance" class="modern-input" placeholder="Otomatik Çekilir">
                    </div>
                    <div>
                        <span style="font-size:11px; color:var(--text-sub);">Risk İştahı (%)</span>
                        <input type="number" id="riskPct" class="modern-input" value="1" placeholder="%1">
                    </div>
                </div>
                <div class="input-row">
                    <div>
                        <span style="font-size:11px; color:var(--text-sub);">Giriş Fiyatı</span>
                        <input type="number" id="riskEntry" class="modern-input" placeholder="0.00">
                    </div>
                    <div>
                        <span style="font-size:11px; color:var(--text-sub);">Stop Fiyatı</span>
                        <input type="number" id="riskStop" class="modern-input" placeholder="0.00">
                    </div>
                </div>
                <button class="btn-main" onclick="calcLabRisk()">POZİSYON HESAPLA</button>
            </div>

            <div id="riskResultBox" class="dash-card full-width" style="display:none; background: linear-gradient(145deg, #451a03 0%, #171717 100%); border:1px solid var(--danger);">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:10px;">
                    <div class="metric-title" style="color:var(--danger); margin:0;">İŞLEM PLANI</div>
                    <div style="font-size:10px; color:var(--text-sub);">STOP ZARARI: <span id="resRiskLoss" style="color:white; font-weight:800;">--</span></div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div><div style="font-size:10px; color:var(--text-sub);">ALINACAK ADET</div><div id="resRiskQty" style="font-size:20px; font-weight:800; color:white;">--</div></div>
                    <div style="text-align:right;"><div style="font-size:10px; color:#f59e0b; font-weight:700;">GEREKEN NAKİT</div><div id="resPosSize" style="font-size:20px; font-weight:800; color:#f59e0b;">--</div></div>
                </div>
                <div id="riskWarning" style="margin-top:15px; font-size:11px; background:rgba(255,255,255,0.05); padding:8px; border-radius:6px; display:flex; align-items:center; gap:8px;">
                    <i class="fas fa-wallet"></i> <span id="riskRatioText">--</span>
                </div>
            </div>
        </div>

        <div id="lab-tool-avg" class="lab-tool-container" style="display:none;">
            <div class="card" style="border-left: 3px solid var(--gold);">
                <div class="lbl-sm" style="color:var(--gold)">MALİYET DÜŞÜRME SİMÜLATÖRÜ</div>
                <p style="font-size:11px; color:var(--text-sub); margin-bottom:15px;">Terste kaldığınız işlem için yeni ortalama hesabı.</p>
                <div class="input-row">
                    <div><span style="font-size:11px; color:var(--text-sub);">Eldeki Adet</span><input type="number" id="avgOldQty" class="modern-input"></div>
                    <div><span style="font-size:11px; color:var(--text-sub);">Eski Ortalama</span><input type="number" id="avgOldPrice" class="modern-input"></div>
                </div>
                <div class="input-row">
                    <div><span style="font-size:11px; color:var(--text-sub);">Yeni Alım Fiyatı</span><input type="number" id="avgNewPrice" class="modern-input" placeholder="Güncel Fiyat"></div>
                    <div><span style="font-size:11px; color:var(--text-sub);">Alınacak Yeni Adet</span><input type="number" id="avgNewQty" class="modern-input" placeholder="Kaç tane alacaksın?"></div>
                </div>
                <button class="btn-main" onclick="calcLabAvg()">YENİ ORTALAMAYI GÖR</button>
            </div>
            <div id="avgResultBox" class="dash-card full-width" style="display:none; background: linear-gradient(145deg, #0f172a 0%, #1e1b4b 100%); border:1px solid var(--accent);">
                <div class="metric-title" style="color:var(--accent)">SONUÇLAR</div>
                <div style="text-align:center; padding:15px 0;">
                    <div style="font-size:11px; color:var(--text-sub);">YENİ ORTALAMANIZ</div>
                    <div id="resAvgNew" style="font-size:32px; font-weight:800; color:white;">--</div>
                </div>
                <div style="display:flex; justify-content:space-between; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                    <div><span style="font-size:10px; color:var(--text-sub);">TOPLAM ADET</span><br><b id="resAvgTotalQty">--</b></div>
                    <div style="text-align:right;"><span style="font-size:10px; color:var(--text-sub);">TOPLAM MALİYET</span><br><b id="resAvgTotalCost">--</b></div>
                </div>
            </div>
        </div>
                <div id="lab-tool-chaos" class="lab-tool-container" style="display:none;">
            </div>
            <div id="lab-tool-time" class="lab-tool-container" style="display:none;">
    
    <div class="card" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px;">
        <div style="display:flex; flex-direction:column; gap:10px;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                <div style="width:36px; height:36px; background:rgba(99, 102, 241, 0.2); border-radius:8px; display:flex; align-items:center; justify-content:center; color:#818cf8;">
                    <i class="fas fa-history"></i>
                </div>
                <div>
                    <div style="font-size:16px; font-weight:800; color:white;">ZAMAN MAKİNESİ</div>
                    <div style="font-size:11px; color:#94a3b8;">Geçmiş Veri & Gelecek Simülasyonu</div>
                </div>
            </div>

            <div style="display:flex; gap:10px;">
                <input type="text" id="statSymbol" class="modern-input" placeholder="Örn: BTC, ETH..." style="text-transform:uppercase; font-weight:700; letter-spacing:1px;">
                <button onclick="runStatisticalAnalysis()" class="btn-main" style="width:auto; white-space:nowrap; background:#6366f1;">
                    <i class="fas fa-search"></i> ANALİZ ET
                </button>
            </div>
            <div style="font-size:9px; color:#64748b;">* Veriler: CoinGecko (Öncelikli) > Binance (Yedek)</div>
        </div>
    </div>

    <div id="statResult" style="display:none;">
        
        <div class="card" style="border:1px solid #3b82f6; background: linear-gradient(180deg, rgba(59, 130, 246, 0.1) 0%, rgba(15, 23, 42, 1) 100%); margin-bottom:20px;">
            <div class="lbl-sm" style="color:#60a5fa; border-bottom:1px solid rgba(59, 130, 246, 0.3); padding-bottom:5px; margin-bottom:10px;">
                GELECEK 5 YIL (OLASILIK BANDI)
            </div>
            <div id="projectionList" style="display:flex; flex-direction:column; gap:6px;">
                </div>
        </div>

        <div class="card" style="padding:0; overflow:hidden;">
            <div class="lbl-sm" style="padding:10px; background:rgba(255,255,255,0.02);">GEÇMİŞ PERFORMANS</div>
            <div style="overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse; font-size:10px; color:white; white-space:nowrap;">
                    <thead>
                        <tr style="background:rgba(255,255,255,0.05); color:#94a3b8; text-align:right;">
                            <th style="padding:8px 4px; text-align:left;">YIL</th>
                            <th style="padding:8px 4px;">KAPANIŞ</th>
                            <th style="padding:8px 4px; color:#10b981;">YÜKSEK</th>
                            <th style="padding:8px 4px; color:#ef4444;">DÜŞÜK</th>
                            <th style="padding:8px 4px; color:#f59e0b;">M.CAP</th> 
                            <th style="padding:8px 4px; color:#38bdf8;">HACİM</th> 
                            <th style="padding:8px 4px;">REEL</th>
                        </tr>
                    </thead>
                    <tbody id="statTableBody">
                        </tbody>
                </table>
            </div>
        </div>
        
        <div style="margin-top:10px; font-size:9px; color:var(--text-sub); text-align:center; padding:0 20px;">
            Yasal Uyarı: Bu tablo bir yatırım tavsiyesi değildir. Geçmiş performans geleceği garanti etmez.
        </div>
    </div>
</div>

    </div> <div id="an-view-psycho" class="an-view-section" style="display:none;">
    
        <div class="dash-card full-width" style="background: linear-gradient(135deg, #312e81 0%, #1e1b4b 100%); border: 1px solid #4338ca; margin-bottom: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <div class="metric-title" style="color:#a5b4fc;"><i class="fas fa-brain"></i> DUYGUSAL KONTROL SKORU</div>
                    <div class="metric-value" id="psyScore">--</div>
                    <div class="metric-sub" id="psyStatus">Analiz Ediliyor...</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:32px;" id="psyEmoji">😐</div>
                </div>
            </div>
            <div class="goal-wrapper" style="margin-top:15px; background:rgba(0,0,0,0.3);">
                <div id="psyScoreBar" class="goal-fill" style="width:50%; background: linear-gradient(90deg, #ef4444, #eab308, #10b981);"></div>
            </div>
        </div>

        <div class="card" style="border-left: 3px solid var(--accent);">
            <div class="lbl-sm" style="color:var(--accent)">REGRET MINIMIZER (PİŞMANLIK ANALİZİ)</div>
            <p style="font-size:11px; color:var(--text-sub); margin-bottom:15px;">
                "Keşke satmasaydım" dediğiniz veya "İyi ki satmışım" dediğiniz işlemlerin bugünkü değeri.
            </p>
            
            <div id="regretList" style="max-height: 300px; overflow-y: auto;">
                <div style="text-align:center; color:var(--text-sub); font-size:11px;">Satış geçmişi taranıyor...</div>
            </div>
        </div>

        <div class="dashboard-container" style="margin-top:15px;">
            
            <div class="dash-card">
                <div class="metric-title" style="color:#f87171;">PANİK SATIŞLARI</div>
                <div style="text-align:center; padding:10px 0;">
                    <i class="fas fa-running" style="font-size:24px; color:#ef4444; margin-bottom:5px;"></i>
                    <div class="metric-value" id="panicCount" style="font-size:20px;">0</div>
                    <div class="metric-sub">Adet Tespit Edildi</div>
                </div>
            </div>

            <div class="dash-card">
                <div class="metric-title" style="color:#fbbf24;">FOMO ALIMLARI</div>
                <div style="text-align:center; padding:10px 0;">
                    <i class="fas fa-rocket" style="font-size:24px; color:#f59e0b; margin-bottom:5px;"></i>
                    <div class="metric-value" id="fomoCount" style="font-size:20px;">0</div>
                    <div class="metric-sub">Tepe Fiyattan Giriş</div>
                </div>
            </div>

                    <div class="dash-card full-width" style="max-height: 400px; display:flex; flex-direction:column;">
            <div class="metric-title" style="margin-bottom:10px;">
                <i class="fas fa-hourglass-half"></i> VARLIK BAZLI SABIR ANALİZİ
            </div>
            
            <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:9px; color:var(--text-sub); font-weight:700;">
                <span>VARLIK / İŞLEM</span>
                <span>SÜRE / TİP</span>
            </div>

            <div id="holdListDetailed" style="overflow-y: auto; flex:1; padding-top:5px;">
                <div style="text-align:center; padding:15px; color:var(--text-sub); font-size:11px;">Veri hazırlanıyor...</div>
            </div>
        </div>

    </div> <div style="height: 100px; width: 100%; clear: both;"></div>

</div> 


    </div>

</div>

        <div id="page-settings" class="page" style="padding:0; background:var(--bg-body);">
    <div class="app-settings-container" style="padding: 20px;">

        <div id="settings-home" class="settings-home-wrapper">
            
            <div id="mainProfileCard" class="profile-banner-card" onclick="openSubPage('profile')">
                <img id="menuProfileImg" 
                     src="https://via.placeholder.com/150/1e2538/ffffff?text=TR" 
                     class="pbc-img"
                     onerror="this.src='https://via.placeholder.com/150/1e2538/ffffff?text=USER'">
                
                <div class="pbc-info">
                    <span class="pbc-name" id="menuProfileName">Yükleniyor...</span>
                    <div class="pbc-badge"><i class="fas fa-crown"></i> PRO ÜYE</div>
                </div>
            </div>

            <div style="font-size:11px; font-weight:700; color:var(--text-sub); margin-bottom:10px; margin-left:10px;">UYGULAMA AYARLARI</div>
            
            <div class="menu-list-wrapper">
    <div class="menu-list-item" onclick="openSubPage('general')">
        <div class="mli-left">
            <div class="mli-icon-box bg-blue"><i class="fas fa-sliders-h"></i></div>
            <span class="mli-text">Genel & Görünüm</span>
        </div>
        <div class="mli-arrow"><i class="fas fa-chevron-right"></i></div>
    </div>

    <div class="menu-list-item" onclick="openSubPage('notify')">
        <div class="mli-left">
            <div class="mli-icon-box bg-orange"><i class="fas fa-bell"></i></div>
            <span class="mli-text">Bildirimler</span>
        </div>
        <div class="mli-arrow"><i class="fas fa-chevron-right"></i></div>
    </div>

    <div class="menu-list-item" onclick="openSubPage('history')">
        <div class="mli-left">
            <div class="mli-icon-box bg-green"><i class="fas fa-history"></i></div>
            <span class="mli-text">Kasa & Geçmiş</span>
        </div>
        <div class="mli-arrow"><i class="fas fa-chevron-right"></i></div>
    </div>
</div>

<div style="font-size:11px; font-weight:700; color:var(--text-sub); margin:15px 0 10px 10px;">DESTEK & YASAL</div>

<div class="menu-list-wrapper">
    
    <div class="menu-list-item" onclick="window.open('iletisim.html', '_blank')">
        <div class="mli-left">
            <div class="mli-icon-box" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"><i class="fas fa-envelope"></i></div>
            <span class="mli-text">Bize Ulaşın</span>
        </div>
        <div class="mli-arrow"><i class="fas fa-chevron-right"></i></div>
    </div>

    <div class="menu-list-item" onclick="window.open('gizlilik.html', '_blank')">
        <div class="mli-left">
            <div class="mli-icon-box" style="background: linear-gradient(135deg, #10b981, #059669);"><i class="fas fa-shield-alt"></i></div>
            <span class="mli-text">Gizlilik Politikası</span>
        </div>
        <div class="mli-arrow"><i class="fas fa-chevron-right"></i></div>
    </div>

    <div class="menu-list-item" onclick="window.open('kullanim-kosullari.html', '_blank')">
        <div class="mli-left">
            <div class="mli-icon-box" style="background: linear-gradient(135deg, #64748b, #475569);"><i class="fas fa-file-contract"></i></div>
            <span class="mli-text">Kullanım Koşulları</span>
        </div>
        <div class="mli-arrow"><i class="fas fa-chevron-right"></i></div>
    </div>

</div>

<div class="menu-list-wrapper" style="margin-top:20px; margin-bottom: 120px;">
    <div class="menu-list-item" onclick="clearAllData()">
        <div class="mli-left">
            <div class="mli-icon-box bg-red"><i class="fas fa-trash-alt"></i></div>
            <span class="mli-text" style="color:#ef4444;" data-lang="reset_data">Verileri Sıfırla</span>
        </div>
    </div>
</div>


        </div>

        <div id="settings-detail" class="settings-detail-wrapper">
            
            <div class="sub-header">
                <button class="back-btn" onclick="closeSubPage()">
                    <i class="fas fa-chevron-left"></i> Geri
                </button>
                <span class="sub-title" id="subPageTitle">Detay</span>
            </div>

            <div id="set-profile" class="settings-content" style="display:none;">
                <div style="text-align:center; margin-bottom:20px;">
                    <div class="profile-img-wrap" style="margin:0 auto 10px auto;">
                        <img id="displayProfileImg" src="" class="profile-img">
                        <label class="profile-upload-btn"><i class="fas fa-camera"></i><input type="file" id="imgUploadInput" style="display:none;" accept="image/*" onchange="uploadProfileImg(this)"></label>
                    </div>
                    <div style="font-size:11px; color:var(--text-sub);">Fotoğrafı güncellemek için ikona tıkla</div>
                </div>

                <div class="card">
                    <div class="lbl-sm">BİLGİLER</div>
                    <div style="margin-bottom:15px;">
                        <span style="font-size:11px; color:var(--text-sub); display:block; margin-bottom:5px;">Ad Soyad</span>
                        <input type="text" id="profileNameInput" class="modern-input" onchange="saveProfileData()">
                    </div>
                    <div>
                        <span style="font-size:11px; color:var(--text-sub); display:block; margin-bottom:5px;">Bio / Ünvan</span>
                        <input type="text" id="profileBioInput" class="modern-input" onchange="saveProfileData()">
                    </div>
                    <div id="displayProfileName" style="display:none;"></div>
                    <div id="displayProfileBio" style="display:none;"></div>
                    <div id="membershipBadge" style="display:none;"></div>
                </div>

                <div class="card">
                    <div class="lbl-sm">İSTATİSTİKLER</div>
                    <div class="stats-grid">
                        <div class="stat-box"><span class="stat-label">İŞLEM</span><div class="stat-val" id="profileTradeCount">0</div></div>
                        <div class="stat-box"><span class="stat-label">TARİH</span><div class="stat-val" id="profileJoinDate">--</div></div>
                    </div>
                </div>
            </div>

            <div id="set-general" class="settings-content" style="display:none;">
                <div class="card">
                    <div class="lbl-sm">TERCİHLER</div>
                    <div class="setting-item"><span>Para Birimi</span><select id="currSelect" class="setting-select" onchange="changeBaseCurrency(this.value)"><option value="TRY">TRY (₺)</option><option value="USD">USD ($)</option></select></div>
                    <div class="setting-item"><span>Dil</span><select id="langSelect" class="setting-select" onchange="changeLanguage(this.value)"><option value="tr">Türkçe</option><option value="en">English</option></select></div>
                    <div class="setting-item"><span>Tema</span><select id="themeSelect" class="setting-select" onchange="changeTheme(this.value)"><option value="ocean">Okyanus</option><option value="purple">Mor Gece</option><option value="dark">Zifiri</option></select></div>
                </div>
                <div class="card">
                    <div class="lbl-sm">VERİ API</div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span id="polyStatusText" style="font-size:10px;">DURUM: BEKLİYOR</span><div id="polyIndicator" class="poly-status-dot idle"></div></div>
                    <input type="text" id="polyKey" class="modern-input" placeholder="API Key..." onchange="savePolyKey(this.value)">
                    <button class="btn-main" onclick="testPolygonConnection()">Bağlantıyı Test Et</button>
                </div>
                <div class="card">
                    <div class="lbl-sm">YEDEKLEME</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                        <button class="btn-main btn-sec" onclick="downloadBackup()">İndir</button>
                        <label class="btn-main btn-sec" style="margin:0;">Yükle <input type="file" style="display:none;" onchange="uploadBackup(this)"></label>
                    </div>
                    <button class="btn-main btn-sec" onclick="exportExcel()">Excel Raporu</button>
                    <div style="margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,255,255,0.1);">
    <div class="lbl-sm" style="margin-bottom:10px;"><i class="fab fa-google-drive"></i> GOOGLE DRIVE YEDEKLEME</div>
    <div id="drive-status" style="font-size:10px; color:var(--text-sub); margin-bottom:5px;">Bağlantı Bekleniyor...</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <button class="btn-main" style="background:#1f2937; border:1px solid rgba(255,255,255,0.1);" onclick="handleAuthClick()">
            <i class="fas fa-sign-in-alt"></i> Giriş Yap
        </button>
        <button class="btn-main" style="background:#1f2937; border:1px solid rgba(255,255,255,0.1);" onclick="handleSignoutClick()">
            <i class="fas fa-sign-out-alt"></i> Çıkış
        </button>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
        <button class="btn-main" style="background:#10b981;" onclick="uploadToDrive()">
            <i class="fas fa-cloud-upload-alt"></i> Buluta Yedekle
        </button>
        <button class="btn-main" style="background:#3b82f6;" onclick="downloadFromDrive()">
            <i class="fas fa-cloud-download-alt"></i> Buluttan Yükle
        </button>
        <div style="height: 80px; width: 100%; clear: both;"></div>

    </div>
</div>

                </div>
            </div>

            <div id="set-notify" class="settings-content" style="display:none;">
                <div class="card" id="permRequestCard" style="display:none; background:rgba(245, 158, 11, 0.1); border-left:3px solid var(--gold);">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-size:12px; color:var(--gold); font-weight:700;">İzin Gerekli</div>
                        <button class="btn-main" style="width:auto; padding:5px 10px; font-size:10px;" onclick="requestNotifyPermission()">İZİN VER</button>
                    </div>
                </div>
                <div class="card">
                    <div class="switch-row"><div><span class="switch-label">Fiyat Alarmları</span></div><label class="tgl-switch"><input type="checkbox" id="ntf_price" onchange="saveNotifySettings()"><span class="tgl-slider"></span></label></div>
                    <div class="switch-row"><div><span class="switch-label">İşlem Onayları</span></div><label class="tgl-switch"><input type="checkbox" id="ntf_trade" onchange="saveNotifySettings()"><span class="tgl-slider"></span></label></div>
                    <div class="switch-row"><div><span class="switch-label">Haberler</span></div><label class="tgl-switch"><input type="checkbox" id="ntf_news" onchange="saveNotifySettings()"><span class="tgl-slider"></span></label></div>
                </div>
                <div class="card">
                    <div class="switch-row"><div><span class="switch-label">Ses</span></div><label class="tgl-switch"><input type="checkbox" id="ntf_sound" onchange="saveNotifySettings()"><span class="tgl-slider"></span></label></div>
                    <div class="switch-row"><div><span class="switch-label">Titreşim</span></div><label class="tgl-switch"><input type="checkbox" id="ntf_vibrate" onchange="saveNotifySettings()"><span class="tgl-slider"></span></label></div>
                </div>
                <button class="btn-main btn-sec" onclick="testNotification()">Test Bildirimi</button>
            </div>

            <div id="set-history" class="settings-content" style="display:none;">
    
    <div class="accounting-hero">
        <div class="acc-row">
            <div class="acc-stat-box">
                <div class="acc-lbl-sub">TOPLAM ÖZKAYNAK</div>
                <div class="acc-val-lg" id="accTotalEquity">--</div>
            </div>
            <div class="acc-stat-box right">
                <div class="acc-lbl-sub">NET KÂR/ZARAR</div>
                <div class="acc-val-lg" id="accNetPnl">--</div>
            </div>
        </div>
        
        <div class="acc-row">
            <div class="acc-stat-box">
                <div class="acc-lbl-sub" style="color:var(--text-sub)">YATIRIM SERMAYESİ</div>
                <div class="acc-val-sm" id="accCapital">--</div>
            </div>
            <div class="acc-stat-box right">
                <div class="acc-lbl-sub" style="color:var(--success)">ÇEKİLEN KÂR (MAAŞ)</div>
                <div class="acc-val-sm" id="accDividend" style="color:var(--success)">--</div>
            </div>
        </div>

        <button class="btn-main" style="margin-top:10px; background:linear-gradient(90deg, #10b981, #059669);" onclick="openSalaryModal()">
            <i class="fas fa-hand-holding-usd"></i> KÂR DAĞITIMI YAP (MAAŞ ÖDE)
        </button>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <span class="lbl-sm">DEFTER KAYITLARI</span>
        <button class="tool-btn" onclick="openCashModal()" style="background:var(--bg-input); padding:5px 10px; border-radius:8px; color:white;">+ İşlem Ekle</button>
    </div>

    <div class="hist-filter-scroll">
        <div class="h-filter-btn active" onclick="filterHistory('all', this)">Tümü</div>
        <div class="h-filter-btn" onclick="filterHistory('NAKİT', this)">Kasa</div>
        <div class="h-filter-btn" onclick="filterHistory('ALIM', this)">Alım</div>
        <div class="h-filter-btn" onclick="filterHistory('SATIM', this)">Satım</div>
        <div class="h-filter-btn" onclick="filterHistory('MAAŞ', this)">Maaş</div>
    </div>

    <div id="historyListFull"></div>

    <button class="trash-btn" onclick="openTrashModal()">
        <i class="fas fa-trash-restore"></i> SİLİNEN KAYITLAR (<span id="trashCount">0</span>)
    </button>
</div>

        </div>

    </div> 
</div>

<div class="nav-container">
    <div class="nav-item active" onclick="switchPage('portfolio', this)"><i class="fas fa-wallet"></i><span data-lang="nav_wallet">Cüzdan</span></div>
    <div class="nav-item" onclick="switchPage('market', this)"><i class="fas fa-chart-line"></i><span data-lang="nav_market">Piyasa</span></div>
    <div class="nav-item" onclick="switchPage('analysis', this)"><i class="fas fa-chart-pie"></i><span>Analiz</span></div>
    <div class="nav-item" onclick="switchPage('news', this)"><i class="far fa-newspaper"></i><span data-lang="nav_news">Haber</span></div>
    <div class="nav-item" onclick="switchPage('settings', this)"><i class="fas fa-cog"></i><span data-lang="nav_settings">Ayarlar</span></div>
</div>
<div id="sellModal" class="modal-overlay">
    <div class="modal">
        <div class="sell-header-row">
            <div class="card-title" style="margin:0; font-size:14px;">SATIŞ EMRİ</div>
            <button id="sellCurrencyToggle" class="currency-toggle-btn active-try" onclick="toggleExitCurrency()">₺</button>
        </div>
        <input type="hidden" id="sellIdx">
        <div style="margin-bottom:5px; font-size:11px; color:var(--text-sub);">Miktar (<span id="sellMaxAmt">0</span> Mevcut)</div>
        <div class="sell-ratio-group">
            <button class="ratio-btn" onclick="setSellRatio(0.25)">%25</button>
            <button class="ratio-btn" onclick="setSellRatio(0.50)">%50</button>
            <button class="ratio-btn" onclick="setSellRatio(0.75)">%75</button>
            <button class="ratio-btn" onclick="setSellRatio(1.0)">TÜMÜ</button>
        </div>
        <input type="number" id="sellAmt" class="modern-input" placeholder="Adet Giriniz" onkeyup="calcSellPreview()">
        <div style="margin-bottom:5px; font-size:11px; color:var(--text-sub); margin-top:5px;">Satış Fiyatı (Birim)</div>
        <input type="number" id="sellPrice" class="modern-input" placeholder="Fiyat Giriniz" onkeyup="calcSellPreview()">
        <div class="sell-summary-box" id="sellSummaryBox" style="display:none;">
            <div class="ss-row"><span class="ss-lbl">Tahmini Tutar:</span><span class="ss-val" id="ssTotal">0.00</span></div>
            <div class="ss-row"><span class="ss-lbl">Bu İşlemden Kâr/Zarar:</span><span class="ss-pnl" id="ssPnL">0.00</span></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn-main btn-sec" onclick="document.getElementById('sellModal').style.display='none'">İptal</button>
            <button class="btn-main" onclick="confirmSell()">SATIŞI ONAYLA</button>
        </div>
    </div>
</div>

<div id="legalModal" class="modal-overlay">
    <div class="modal" style="max-height: 80vh; overflow-y: auto;">
        <h3 style="text-align:center; color:var(--text-sub); margin-bottom:15px;"><i class="fas fa-balance-scale"></i> Yasal Uyarı</h3>
        <div style="font-size:11px; line-height:1.6; color:var(--text-sub); text-align:justify;">
            <p style="margin-bottom:10px;"><strong>Burada yer alan yatırım bilgi, yorum ve tavsiyeleri yatırım danışmanlığı kapsamında değildir.</strong></p>
            <p style="margin-bottom:10px;">Yatırım danışmanlığı hizmeti; aracı kurumlar, portföy yönetim şirketleri, mevduat kabul etmeyen bankalar ile müşteri arasında imzalanacak yatırım danışmanlığı sözleşmesi çerçevesinde sunulmaktadır.</p>
            <p style="margin-bottom:10px;">Burada yer alan yorum ve tavsiyeler, yorum ve tavsiyede bulunanların kişisel görüşlerine dayanmaktadır. Bu görüşler mali durumunuz ile risk ve getiri tercihlerinize uygun olmayabilir.</p>
            <p>Bu nedenle, sadece burada yer alan bilgilere dayanılarak yatırım kararı verilmesi beklentilerinize uygun sonuçlar doğurmayabilir. TradeMaster uygulaması bir simülasyon ve takip aracıdır, gerçek piyasa emri iletmez.</p>
        </div>
        <button class="btn-main btn-sec" style="margin-top:15px;" onclick="document.getElementById('legalModal').style.display='none'">Okudum, Anladım</button>
    </div>
</div>

<div id="feedbackModal" class="modal-overlay">
    <div class="modal">
        <h3 style="text-align:center; margin-bottom:15px;">Bize Ulaşın</h3>
        <p style="font-size:12px; color:var(--text-sub); text-align:center; margin-bottom:15px;">Hata bildirimi, özellik isteği veya görüşleriniz için yazabilirsiniz.</p>
        
        <div style="margin-bottom:10px;">
            <span style="font-size:11px; color:var(--text-sub);">Konu</span>
            <select id="fbSubject" class="modern-input">
                <option>Hata Bildirimi (Bug)</option>
                <option>Özellik İsteği</option>
                <option>Teşekkür / Diğer</option>
            </select>
        </div>
        
        <div style="margin-bottom:10px;">
            <span style="font-size:11px; color:var(--text-sub);">Mesajınız</span>
            <textarea id="fbMessage" class="modern-input" rows="4" placeholder="Mesajınızı buraya yazın..."></textarea>
        </div>

        <button class="btn-main" onclick="sendFeedback()">GÖNDER</button>
        <button class="btn-main btn-sec" style="margin-top:10px;" onclick="document.getElementById('feedbackModal').style.display='none'">Vazgeç</button>
    </div>
</div>


<div id="manualHistoryModal" class="modal-overlay">
    <div class="modal">
        <h3 style="text-align:center; margin-bottom:15px;">Geçmiş İşlem Ekle</h3>
        
        <div style="background:rgba(245, 158, 11, 0.1); padding:10px; border-radius:8px; font-size:11px; color:var(--gold); margin-bottom:15px; line-height:1.4;">
            <i class="fas fa-info-circle"></i> Bu özellik sadece <b>Geçmiş</b> ve <b>Trader Karnesi</b> verilerini etkiler. Cüzdan bakiyenizi veya portföyünüzü değiştirmez.
        </div>

        <div class="sim-tab-group">
            <div class="sim-tab active" onclick="setManualType('ALIM', this)">ALIM</div>
            <div class="sim-tab" onclick="setManualType('SATIM', this)">SATIM</div>
        </div>
        <input type="hidden" id="manualType" value="ALIM">

        <div class="input-row">
            <div>
                <span style="font-size:11px; color:var(--text-sub);">Sembol</span>
                <input type="text" id="manualSym" class="modern-input" placeholder="BTC, THYAO..." style="text-transform:uppercase;">
            </div>
            <div>
                <span style="font-size:11px; color:var(--text-sub);">Tarih</span>
                <input type="date" id="manualDate" class="modern-input" style="padding: 10px;">
            </div>
        </div>

        <div class="input-row">
            <div>
                <span style="font-size:11px; color:var(--text-sub);">Adet</span>
                <input type="number" id="manualAmt" class="modern-input" placeholder="0">
            </div>
            <div>
                <span style="font-size:11px; color:var(--text-sub);">Fiyat</span>
                <input type="number" id="manualPrice" class="modern-input" placeholder="0.00">
            </div>
        </div>

        <div id="manualCostArea" style="display:none; margin-top:5px;">
            <span style="font-size:11px; color:var(--text-sub);">Bu malı kaçtan almıştınız? (Kâr Hesabı İçin)</span>
            <input type="number" id="manualBuyCost" class="modern-input" placeholder="Alış Maliyeti Giriniz">
        </div>

        <button class="btn-main" style="margin-top:15px;" onclick="saveManualHistory()">KAYDET</button>
        <button class="btn-main btn-sec" style="margin-top:10px;" onclick="document.getElementById('manualHistoryModal').style.display='none'">İptal</button>
    </div>
</div>

<div id="alarmModal" class="modal-overlay">
    <div class="modal">
        <h3 id="alarmAssetTitle" style="text-align:center; margin-bottom:15px; color:var(--accent);">Fiyat Alarmı</h3>
        <input type="hidden" id="alarmIdx">
        <div class="sim-tab-group" style="margin-bottom:15px;">
            <div class="sim-tab active" onclick="switchAlarmTab('price', this)"><i class="fas fa-tag"></i> Fiyat Hedefi</div>
            <div class="sim-tab" onclick="switchAlarmTab('percent', this)"><i class="fas fa-percent"></i> Yüzde (%)</div>
        </div>
        <div id="alarm-pane-price" class="alarm-pane active" style="display:block;">
            <div style="font-size:11px; color:var(--text-sub); margin-bottom:5px;">Yükseliş Hedefi (Üst Sınır)</div>
            <div class="trade-input-group" style="margin-bottom:10px;"><i class="fas fa-arrow-up input-icon" style="color:var(--success);"></i><input type="number" id="alarmUpper" class="trade-input" placeholder="Örn: 150.00"></div>
            <div style="font-size:11px; color:var(--text-sub); margin-bottom:5px;">Düşüş Sınırı (Stop-Loss)</div>
            <div class="trade-input-group"><i class="fas fa-arrow-down input-icon" style="color:var(--danger);"></i><input type="number" id="alarmLower" class="trade-input" placeholder="Örn: 130.00"></div>
        </div>
        <div id="alarm-pane-percent" class="alarm-pane" style="display:none;">
            <div style="background:rgba(59,130,246,0.1); padding:10px; border-radius:8px; font-size:11px; color:var(--accent); margin-bottom:10px;"><i class="fas fa-info-circle"></i> Maliyetinize göre hesaplanır.</div>
            <div style="font-size:11px; color:var(--text-sub); margin-bottom:5px;">% Kaç Kâr Edince Uyar?</div>
            <div class="trade-input-group" style="margin-bottom:10px;"><i class="fas fa-plus input-icon" style="color:var(--success);"></i><input type="number" id="alarmPctUp" class="trade-input" placeholder="Örn: 10 (Yüzde 10 artarsa)"></div>
            <div style="font-size:11px; color:var(--text-sub); margin-bottom:5px;">% Kaç Düşüşte Uyar?</div>
            <div class="trade-input-group"><i class="fas fa-minus input-icon" style="color:var(--danger);"></i><input type="number" id="alarmPctDown" class="trade-input" placeholder="Örn: 5 (Yüzde 5 düşerse)"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn-main btn-danger" style="flex:1;" onclick="clearAssetAlarms()">Sıfırla</button>
            <button class="btn-main" style="flex:2;" onclick="saveAlarm()">KAYDET</button>
        </div>
        <button class="btn-main btn-sec" style="margin-top:10px;" onclick="closeModal('alarmModal')">Vazgeç</button>
    </div>
</div>

<div id="simModal" class="modal-overlay">
    <div class="modal" style="max-width:360px; padding-top: 15px;"> <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
            
            <div onclick="closeModal('simModal')" style="cursor:pointer; width:30px; height:30px; display:flex; align-items:center; justify-content:flex-start; color:var(--text-sub);">
                <i class="fas fa-times" style="font-size:20px;"></i>
            </div>

            <h3 id="simAssetTitle" style="margin:0; font-size:16px; font-weight:700; text-align:center; flex:1;">--</h3>

            <div style="width:30px;"></div>
        </div>
        
        <div class="sim-tab-group">
            <div class="sim-tab active" onclick="switchSimTab('scenario', this)"><i class="fas fa-chart-bar"></i> Senaryo</div>
            <div class="sim-tab" onclick="switchSimTab('avg', this)"><i class="fas fa-balance-scale"></i> Maliyet</div>
            <div class="sim-tab" onclick="switchSimTab('holder', this)"><i class="fas fa-piggy-bank"></i> Holder</div>
            <div class="sim-tab" onclick="switchSimTab('realize', this)"><i class="fas fa-hand-holding-usd"></i> Satış</div>
        </div>

        <div id="sim-pane-scenario" class="sim-content-pane active">
            <div style="margin-bottom:5px; font-size:11px; color:var(--text-sub);">Varsayım Fiyatı:</div>
            <input type="number" id="simTargetPrice" class="modern-input" placeholder="Örn: 100.00" onkeyup="calcSimScenario()">
            <div style="margin-bottom:5px; font-size:11px; color:var(--text-sub); margin-top:5px;">Veya Yüzde Değişim (%):</div>
            <div class="input-row">
                <input type="number" id="simPercent" class="modern-input" placeholder="Örn: 10" onkeyup="calcSimScenarioPercent()">
                <button class="btn-main" style="padding:0;" onclick="calcSimScenarioPercent()">Hesapla</button>
            </div>
            <div id="simResScenario" class="sim-result-box" style="display:none;">
                <div class="sim-row"><span class="sim-lbl">Potansiyel Değer:</span><span id="resSimVal" style="font-weight:700;">--</span></div>
                <div class="sim-row"><span class="sim-lbl">Fiyat Farkı:</span><span id="resSimDiff">--</span></div>
                <div class="sim-row big"><span class="sim-lbl">Tahmini Kâr/Zarar:</span><span id="resSimPnL">--</span></div>
            </div>
        </div>

        <div id="sim-pane-avg" class="sim-content-pane">
            <div class="input-row">
                <div><div style="font-size:11px; color:var(--text-sub); margin-bottom:3px;">Alınacak Adet</div><input type="number" id="simAddAmt" class="modern-input" placeholder="Adet"></div>
                <div><div style="font-size:11px; color:var(--text-sub); margin-bottom:3px;">Alım Fiyatı</div><input type="number" id="simAddPrice" class="modern-input" placeholder="Fiyat"></div>
            </div>
            <button class="btn-main" onclick="calcSimAvg()">Yeni Ortalamayı Gör</button>
            <div id="simResAvg" class="sim-result-box" style="display:none;">
                <div class="sim-row"><span class="sim-lbl">Eski Ortalama:</span><span id="resOldAvg">--</span></div>
                <div class="sim-row big"><span class="sim-lbl">YENİ ORTALAMA:</span><span id="resNewAvg" style="color:var(--accent);">--</span></div>
                <div class="sim-row"><span class="sim-lbl">Toplam Yeni Maliyet:</span><span id="resTotalCost">--</span></div>
            </div>
        </div>

        <div id="sim-pane-holder" class="sim-content-pane">
            <div class="input-row">
                <div>
                    <div style="font-size:10px; color:var(--text-sub); margin-bottom:3px;">Vade (Yıl)</div>
                    <input type="number" id="hYear" class="modern-input" placeholder="1" value="1">
                </div>
                <div>
                    <div style="font-size:10px; color:var(--text-sub); margin-bottom:3px;">Beklenen Artış (%)</div>
                    <input type="number" id="hReturn" class="modern-input" placeholder="Yıllık %">
                </div>
            </div>
            <div style="margin-bottom:10px;">
                <div style="font-size:10px; color:var(--text-sub); margin-bottom:3px;">Tahmini Yıllık Enflasyon (%)</div>
                <input type="number" id="hInflation" class="modern-input" placeholder="Örn: 50" value="45">
            </div>
            <button class="btn-main" onclick="calcHolderAnalysis()">ANALİZ ET</button>
            <div id="simResHolder" class="sim-result-box" style="display:none; margin-top:10px;"></div>
        </div>

        <div id="sim-pane-realize" class="sim-content-pane">
            <div style="margin-bottom:5px; font-size:11px; color:var(--text-sub);">Satılacak Miktar (Adet):</div>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="number" id="simSellAmt" class="modern-input" placeholder="Adet" style="margin:0;">
                <button class="btn-main btn-sec" style="width:auto; padding:0 15px;" onclick="fillSimSell(0.5)">%50</button>
                <button class="btn-main btn-sec" style="width:auto; padding:0 15px;" onclick="fillSimSell(1)">Tümü</button>
            </div>
            <div style="margin-bottom:5px; font-size:11px; color:var(--text-sub);">Satış Fiyatı:</div>
            <input type="number" id="simRealizePrice" class="modern-input" placeholder="Güncel Fiyat">
            <button class="btn-main" onclick="calcSimRealize()">Analiz Et</button>
            <div id="simResRealize" class="sim-result-box" style="display:none;">
                <div class="sim-row big"><span class="sim-lbl">KASAYA GİRECEK:</span><span id="resCashIn" style="color:var(--success);">--</span></div>
                <div class="sim-row"><span class="sim-lbl">Realize Edilen Kâr:</span><span id="resRealizedPnL">--</span></div>
                <div class="sim-row"><span class="sim-lbl">Kalan Adet:</span><span id="resLeftAmt">--</span></div>
            </div>
        </div>

    </div>
</div>

</div>

<div id="marketDetailModal" class="modal-overlay" style="align-items: center; justify-content: center;">
    <div class="modal market-sheet" style="padding: 0; overflow: hidden; max-height: 85vh; display: flex; flex-direction: column; width: 95%; max-width: 400px; border-radius: 24px;">
        
        <div id="mdHero" class="md-header-hero">
            <div style="display:flex; justify-content:space-between; padding: 0 20px;">
                <button class="sheet-close-btn" onclick="closeMarketDetail()" style="background:rgba(0,0,0,0.2); color: white;">
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                <div id="mdAssetLogo" style="transform: scale(0.8);"></div>
                
                <button class="sheet-close-btn" onclick="actionWatchFromMarket()" style="background:rgba(0,0,0,0.2);">
                    <i id="mdWatchIcon" class="fas fa-star" style="transition: color 0.3s; color: var(--text-sub);"></i>
                </button>
            </div>
            
            <div id="mdSymbolTitle" style="font-size:12px; font-weight:800; color:var(--text-sub); margin-top:5px; letter-spacing:1px;">--</div>
            <div id="mdBigPrice" class="md-big-price">--</div>
            <div id="mdChangePill" class="md-change-pill">--</div>
        </div>

        <div style="padding: 0 20px 20px 20px; overflow-y: auto;">
            <div class="md-tabs">
                <div class="md-tab active" onclick="switchMdTab('overview', this)">GENEL BAKIŞ</div>
                <div class="md-tab" onclick="switchMdTab('chart', this)">GRAFİK</div>
                <div class="md-tab" onclick="switchMdTab('calc', this)">İŞLEM</div>
            </div>

            <div id="md-tab-overview" class="md-content active">
    <div class="range-container">
        <div class="range-labels">
            <span>GÜN DÜŞÜK: <span id="mdLow" style="color:var(--text-main)">--</span></span>
            <span>GÜN YÜKSEK: <span id="mdHigh" style="color:var(--text-main)">--</span></span>
        </div>
        <div class="range-track">
            <div class="range-fill"></div>
            <div id="mdRangeDot" class="range-dot" style="left: 50%;"></div>
        </div>
    </div>

    <div class="md-stat-grid">
        <div class="md-stat-box"><div class="md-stat-lbl">24S HACİM</div><div class="md-stat-val" id="mdVol">--</div></div>
        <div class="md-stat-box"><div class="md-stat-lbl">TÜR</div><div class="md-stat-val" id="mdType" style="color:var(--accent)">--</div></div>
        <div class="md-stat-box"><div class="md-stat-lbl">ORTALAMA (VWAP)</div><div class="md-stat-val" id="mdVwap">--</div></div>
        <div class="md-stat-box"><div class="md-stat-lbl">DURUM</div><div class="md-stat-val" id="mdStatus">AÇIK</div></div>
    </div>

    <div id="mdDisclaimer" style="font-size:10px; color:var(--text-sub); text-align:center; margin-top:10px; font-style: italic; opacity: 0.7; line-height: 1.5;">
    <i class="fas fa-info-circle"></i> Veri yükleniyor...
</div>
</div>


            <div id="md-tab-chart" class="md-content">
                <div id="mdChartContainer" class="chart-box-lg" style="height: 350px;"></div>
            </div>

            <div id="md-tab-calc" class="md-content">
                <div class="card" style="background: rgba(255,255,255,0.02);">
                    <div class="lbl-sm">BAKİYENİZ</div>
                    <div style="font-size:18px; font-weight:800; color:white; margin-bottom:10px;" id="mdUserBalance">--</div>
                    <div style="font-size:11px; color:var(--text-sub);">Tahmini Alınabilir Miktar: <span id="mdMaxBuy" style="color:var(--success); font-weight:700;">--</span></div>
                </div>
                <div class="md-action-grid">
                    <button class="btn-quick bq-buy" onclick="actionBuyFromMarket()"><span><i class="fas fa-arrow-down"></i> ALIM YAP</span><span class="bq-sub">Portföye Ekle</span></button>
                    <button class="btn-quick bq-sell" onclick="actionSellFromMarket()">
    <span><i class="fas fa-arrow-up"></i> SATIŞ YAP</span><span class="bq-sub">Portföyden Sat</span>
</button>

                </div>
            </div>
        </div>
    </div>
</div>

<div id="newsRedirectModal" class="modal-overlay" style="align-items: center; justify-content: center; backdrop-filter: blur(5px);">
    
    <div class="modal market-sheet" style="padding: 0; width: 90%; max-width: 360px; height: 65vh; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; background: #151b2b; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 20px 40px rgba(0,0,0,0.6);">
        
        <div style="flex: 1; padding: 16px; display: flex; flex-direction: column; background: #151b2b;">
            
            <div id="newsAdSpace" style="
                flex: 1; 
                width: 100%; 
                background: rgba(0, 0, 0, 0.2); /* Daha koyu ve nötr zemin */
                border-radius: 16px; 
                border: 2px dashed rgba(255, 255, 255, 0.1); /* Göze batmayan çerçeve */
                display: flex; 
                align-items: center; 
                justify-content: center; 
                flex-direction: column;
                margin-bottom: 15px;
                position: relative;
                overflow: hidden;">
                
                <div style="width: 60px; height: 60px; border-radius: 50%; background: rgba(255, 255, 255, 0.05); display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-ad" style="font-size: 24px; color: var(--text-sub); opacity: 0.5;"></i>
                </div>
                
                <span style="font-size: 10px; color: var(--text-sub); opacity: 0.5; font-weight: 700; margin-top: 15px; letter-spacing: 1px;">REKLAM</span>
            </div>

            <div style="flex-shrink: 0; display: flex; gap: 10px; height: 44px;">
                
                <button onclick="closeNewsModal()" style="
                    flex: 1;
                    height: 100%;
                    background: #1e2538; /* Uygulama input rengi */
                    color: #94a3b8;      /* Uygulama yan metin rengi */
                    border: 1px solid rgba(255,255,255,0.05);
                    border-radius: 12px;
                    font-weight: 600;
                    font-size: 12px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: 0.2s;">
                    Vazgeç
                </button>

                <button onclick="proceedToNews()" style="
                    flex: 2;
                    height: 100%;
                    background: #3b82f6; /* TradeMaster Mavisi */
                    color: white;
                    border: none;
                    border-radius: 12px;
                    font-weight: 700;
                    font-size: 13px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.2); /* Hafif gölge */
                    transition: 0.1s;">
                    <span>Kaynağa Git</span>
                    <i class="fas fa-chevron-right" style="font-size: 10px;"></i>
                </button>
            </div>
            
            <div style="text-align: center; margin-top: 10px;">
                <span style="font-size: 9px; color: var(--text-sub); opacity: 0.3;">Güvenli Bağlantı</span>
            </div>
        </div>
    </div>
</div>

<div id="cashModal" class="modal-overlay">
    <div class="modal">
        <h3 style="text-align:center; margin-bottom:15px;">Nakit İşlemi</h3>
        
        <input type="hidden" id="cashTypeVal" value="in">

        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <div id="btnCashIn" class="cash-modal-btn deposit active" onclick="setCashType('in', this)">
                <i class="fas fa-arrow-down"></i>
                <span>YATIR</span>
            </div>
            <div id="btnCashOut" class="cash-modal-btn withdraw" onclick="setCashType('out', this)">
                <i class="fas fa-arrow-up"></i>
                <span>ÇEK</span>
            </div>
        </div>

        <div style="margin-bottom:10px;">
            <span style="font-size:11px; color:var(--text-sub);">Miktar</span>
            <input type="number" id="cashAmountInput" class="modern-input" placeholder="0.00">
        </div>

        <div style="margin-bottom:15px;">
            <span style="font-size:11px; color:var(--text-sub);">Açıklama (Opsiyonel)</span>
            <input type="text" id="cashDescInput" class="modern-input" placeholder="Örn: Banka transferi">
        </div>

        <button class="btn-main" onclick="submitCashTransaction()">İŞLEMİ ONAYLA</button>
        <button class="btn-main btn-sec" style="margin-top:10px;" onclick="document.getElementById('cashModal').style.display='none'">İptal</button>
    </div>
</div>

<div id="salaryModal" class="modal-overlay">
    <div class="modal">
        <h3 style="text-align:center; color:var(--success); margin-bottom:10px;">Kâr Dağıtımı</h3>
        <p style="font-size:11px; color:var(--text-sub); text-align:center; margin-bottom:20px;">
            Şirketinizden (Portföyünüzden) kendinize maaş ödemesi yapın. Bu işlem, sermayenizi düşürmez, kâr hanesinden düşülür.
        </p>
        
        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:8px; margin-bottom:15px; text-align:center;">
            <div style="font-size:10px; color:var(--text-sub);">Çekilebilir Kâr Tutarı</div>
            <div id="salaryAvailable" style="font-size:18px; font-weight:800; color:white;">--</div>
        </div>

        <span style="font-size:11px; color:var(--text-sub);">Çekilecek Tutar</span>
        <input type="number" id="salaryAmt" class="modern-input" placeholder="0.00">

        <button class="btn-main" style="background:#10b981; margin-top:10px;" onclick="confirmSalary()">ONAYLA VE ÇEK</button>
        <button class="btn-main btn-sec" style="margin-top:10px;" onclick="closeModal('salaryModal')">İptal</button>
    </div>
</div>

<div id="trashModal" class="modal-overlay">
    <div class="modal">
        <h3 style="text-align:center; margin-bottom:15px;"><i class="fas fa-trash-restore"></i> Geri Dönüşüm</h3>
        <div style="font-size:11px; color:var(--text-sub); margin-bottom:15px; text-align:center;">
            Yanlışlıkla silinen kayıtlar burada tutulur. Sermaye tutarsızlığını önlemek için geri yükleyebilirsiniz.
        </div>
        <div id="trashList" style="max-height:300px; overflow-y:auto;">
            </div>
        <button class="btn-main btn-sec" style="margin-top:15px;" onclick="closeModal('trashModal')">Kapat</button>
    </div>
</div>



<script>
    /* --- GÜVENLİ VERSİYON KONTROL SİSTEMİ (VERİ SİLMEZ) --- */
(function() {
    // BURAYI HER GÜNCELLEMEDE 1 ARTTIR (Örn: "2.5", "2.6"...)
    const CURRENT_VERSION = "2.1"; 

    const savedVersion = localStorage.getItem('TradeVia_Version');

    if (savedVersion !== CURRENT_VERSION) {
        console.log("Yeni sürüm (" + CURRENT_VERSION + ") tespit edildi. Sistem güncelleniyor...");

        // 1. Sadece Versiyon Numarasını Güncelle (Diğer verilere dokunma!)
        localStorage.setItem('TradeVia_Version', CURRENT_VERSION);

        // 2. Service Worker (PWA) Varsa Önbelleğini Temizle
        // (Bu sadece eski kod dosyalarını siler, portföy verisini silmez)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }

        // 3. Sayfayı Sunucudan Taze Şekilde Yeniden Yükle
        // (Cache'deki eski HTML/JS'yi yok sayar)
        window.location.reload(true);
    }
})();

    
    // 1. Sağ Tık Engelleme
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
    });

    // 2. Geliştirici Araçları Kısayollarını Engelleme (F12, Ctrl+Shift+I, Ctrl+U vb.)
    document.onkeydown = function(e) {
        if (event.keyCode == 123) { // F12
            return false;
        }
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) { // Ctrl+Shift+I
            return false;
        }
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) { // Ctrl+Shift+C
            return false;
        }
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) { // Ctrl+Shift+J
            return false;
        }
        if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) { // Ctrl+U (Kaynak Görüntüle)
            return false;
        }
    }

    // 3. Konsol Açıldığında Sayfayı Zorlaştırma (Debugger Tuzağı)
    // Konsol açılırsa tarayıcı sürekli duraklatılır ve kod akışı kesilir.
    setInterval(function() {
        const startTime = performance.now();
        debugger; // Burası konsol açıksa çalışmayı durdurur
        const endTime = performance.now();
        
        // Eğer debugger'da çok vakit geçtiyse konsol açık demektir, sayfayı temizle veya yönlendir
        if (endTime - startTime > 100) {
            document.body.innerHTML = "Lütfen Geliştirici Araçlarını Kapatın!";
            window.location.reload(); 
        }
    }, 1000);

    // 4. Konsol Loglarını Temizleme (Console.log'ları siler)
    console.log = function() {};
    console.warn = function() {};
    console.error = function() {};


/* --- PWA İPTAL VE TEMİZLİK KODU --- */
if ('serviceWorker' in navigator) {
    // Mevcut tüm Service Worker'ları bul ve hepsini sil (unregister)
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
            registration.unregister().then(function(boolean) {
                console.log('Eski Service Worker silindi: ' + boolean);
            });
        }
    });

    // Önbellekleri (Cache) temizle
    caches.keys().then(function(names) {
        for (let name of names) {
            caches.delete(name);
        }
    });
}


    
        /* --- AYARLAR VE GLOBAL DEĞİŞKENLER --- */
        
  const AUTO_CG_KEY = "CG-68G2B22hNhYhkGUHp5GbSLhA";
let coingeckoApiKey = AUTO_CG_KEY; 


  
let notifySettings = JSON.parse(localStorage.getItem('tm_notify_settings')) || {
    price: true, trade: true, news: false, sound: true, vibrate: true
};

    const trans = { tr: { loading:"Yükleniyor..." }, en: { loading:"Loading..." } };
    let appSettings = JSON.parse(localStorage.getItem('tm_settings')) || {currency:'TRY', lang:'tr', theme:'ocean'};
    let userProfile = JSON.parse(localStorage.getItem('tm_user_profile')) || { name: 'Misafir', bio: 'Yatırımcı', joinDate: new Date().toLocaleDateString(), img: null };
    let polyApiKey = localStorage.getItem('tm_poly_key') || '';
    let usdTryRate = 36.5; 
    let cashBalance = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
    let tradeHistory = JSON.parse(localStorage.getItem('tm_full_trade_history')) || [];
    let notifications = JSON.parse(localStorage.getItem('tm_notifications')) || [];
    let realizedPnL = parseFloat(localStorage.getItem('tm_realized_pnl')) || 0;
    
    let entryCurrency = 'TRY'; let exitCurrency = 'TRY';
    let isPrivacyMode = false; let currentSortMode = 'value_desc';
    let currentMarketTab = 'kripto'; 
    let currentHistoryFilter = 'all';
    let currentSimAssetIndex = -1;
    let selectedMarketSymbol = ""; 
    let currentRenderId = 0; 
    let liveUpdateInterval; 

 /* --- BAŞLATMA VE AÇILIŞ EKRANI (DÜZELTİLMİŞ FİNAL) --- */
function initApp(){
    // Ayarları yükle
    document.getElementById('currSelect').value = appSettings.currency;
    document.getElementById('langSelect').value = appSettings.lang;
    document.getElementById('themeSelect').value = appSettings.theme || 'ocean';
    document.getElementById('polyKey').value = polyApiKey;
    
    applyTheme(appSettings.theme);
    applyLang();
    loadNotifyUI();
    checkNotifyPermission();
    updateBadge();
    loadProfile();
    checkPolyInit();
    
    // Cüzdanı hazırla (Ama göstermeyeceğiz)
    renderPortfolioHTML(JSON.parse(localStorage.getItem('myPF_final')) || []);

    fetchUsdRate().then(async ()=>{ 
        await loadPF(true); 
        takePortfolioSnapshot(); 
        
        // --- DEĞİŞİKLİK 1: BURADAKİ SATIRI SİLDİM ---
        // (loadMarketCategory satırını kaldırdık çünkü aşağıda sayfayı açınca kendi yüklenecek)
        
        updateWatchlist();
        setTimeout(() => { if(document.getElementById('newsFeed') && document.getElementById('newsFeed').innerHTML==="") fetchNewsCustom(); }, 2500); 
        startLiveUpdates();
    });

    setTimeout(() => { hideSplashScreen(); }, 3500); 

    renderHistory();
    setEntryCurrency('TRY'); 

    // --- DEĞİŞİKLİK 2: AÇILIŞTA DİREKT PİYASA SAYFASINA GİT ---
    // Bu kod çalıştığı an Piyasa butonuna basılmış gibi yapar ve listeyi doldurur.
    setTimeout(() => {
        const marketBtn = document.querySelectorAll('.nav-item')[1]; // 2. sıradaki buton (Piyasa)
        if(marketBtn) switchPage('market', marketBtn);
    }, 100); // 100ms gecikme ile DOM'un hazır olmasını garantiye alıyoruz
}

function hideSplashScreen() {
    const splash = document.getElementById('splash-screen');
    if(splash && !splash.classList.contains('hidden')) {
        splash.classList.add('hidden');
        setTimeout(() => { splash.remove(); }, 400); 
    }
}

   /* --- GÜNCELLENMİŞ SAYFA GEÇİŞ FONKSİYONU --- */
function switchPage(p, btn){ 
    // 1. Sayfa Görünürlüğünü Ayarla
    document.querySelectorAll('.page').forEach(x=>x.classList.remove('active')); 
    document.getElementById('page-'+p).classList.add('active'); 
    
    // 2. Alt Menü İkonunu Aktif Yap
    document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); 
    if(btn) btn.classList.add('active'); 
    
    // 3. Sayfaya Özel İşlemler
    if(p==='market') switchMarketMode('main', document.querySelector('.ms-btn')); 
    if(p==='analysis') { renderAnalyticsPage(); } 
    
    // --- BURASI DEĞİŞTİ (YENİ HABER TETİKLEYİCİSİ) ---
    if(p==='news') {
        // Eğer haberler hiç yüklenmediyse veya "Yükleniyor" yazıyorsa sistemi başlat
        const tl = document.getElementById('newsTimeline');
        if(tl && (tl.innerHTML.trim() === "" || tl.innerHTML.includes('Yükleniyor'))) {
            initNewsSystem();
        } else {
            // Zaten yüklüyse sadece sayacı devam ettir
            startNewsTimer();
        }
    } else {
        // Haber sayfasından çıkınca sayacı durdur (Performans tasarrufu)
        clearInterval(newsInterval);
    }
    // ------------------------------------------------
    
    if(p==='notifications') renderNotifications(); 
    
    // Manuel Geri Butonu Kontrolü (Varsa)
    const backBtn = document.getElementById('manualBackBtn');
    if(backBtn) {
        backBtn.style.display = (p === 'portfolio') ? 'none' : 'flex';
    }
}

    /* --- CANLI GÜNCELLEME MOTORU --- */
    function startLiveUpdates() {
        if(liveUpdateInterval) clearInterval(liveUpdateInterval);
        liveUpdateInterval = setInterval(async () => {
            if(!document.getElementById('page-portfolio').classList.contains('active')) return;

            let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
            if(as.length === 0) return;

            await fetchUsdRate();
            let totalPortfolioValue = 0; let totalPortfolioPnL = 0;
            let chartData = { bist: 0, crypto: 0, other: 0, cash: cashBalance };
            let uCurr = appSettings.currency; let sym = uCurr === 'TRY' ? '₺' : '$';

            for(let i = 0; i < as.length; i++) {
                let a = as[i];
                let res = await getPrice(a.name);
                
                if(res && res.price > 0) {
                    a.curr = res.price; 
                    let rp = res.price;
                    let dVal = 0; let dCost = 0;

                    if(uCurr === 'TRY') { 
                        if(a.origin === 'USD') { dVal = rp * a.amt * usdTryRate; dCost = a.buy * a.amt * usdTryRate; } 
                        else { dVal = rp * a.amt; dCost = a.buy * a.amt; } 
                    } else { 
                        if(a.origin === 'TRY') { dVal = (rp * a.amt) / usdTryRate; dCost = (a.buy * a.amt) / usdTryRate; } 
                        else { dVal = rp * a.amt; dCost = a.buy * a.amt; } 
                    }

                    let pnl = dVal - dCost;
                    let pnlPercent = (dCost > 0) ? (pnl / dCost) * 100 : 0;
                    totalPortfolioValue += dVal;
                    totalPortfolioPnL += pnl;

                    let tag = getAssetTag(a.name).t;
                    if(tag === 'KRİPTO') chartData.crypto += dVal; else if(tag === 'BORSA') chartData.bist += dVal; else chartData.other += dVal;

                    let elPrice = document.getElementById(`live_price_${i}`);
                    if(elPrice) {
                        elPrice.innerText = (a.origin === 'USD' ? '$' : '₺') + rp.toFixed(2);
                        let elTotalVal = document.getElementById(`live_total_val_${i}`);
                        if(elTotalVal) elTotalVal.innerText = sym + dVal.toFixed(0);
                        let elPnlVal = document.getElementById(`live_pnl_val_${i}`);
                        if(elPnlVal) elPnlVal.innerText = pnl.toFixed(0);
                        let elPct = document.getElementById(`live_pct_${i}`);
                        if(elPct) elPct.innerText = `(%${pnlPercent.toFixed(1)})`;
                        
                        let badge = document.getElementById(`live_pnl_badge_${i}`);
                        let card = document.getElementById(`card_bg_${i}`);
                        if(badge && card) {
                            if(pnl >= 0) { badge.className = 'asset-pnl pnl-up'; card.className = 'asset-card profit-bg'; } 
                            else { badge.className = 'asset-pnl pnl-down'; card.className = 'asset-card loss-bg'; }
                        }
                    }
                }
            }
            localStorage.setItem('myPF_final', JSON.stringify(as));
            updateHeaderTotals(totalPortfolioValue, totalPortfolioPnL, chartData);
            checkAllAlarms();
        }, 5000); 
    }
    /* --- PORTFÖY VE FİYAT FONKSİYONLARI --- */
   /* --- FİYAT MOTORU (ÖNCELİK: COINGECKO API & ALTIN) --- */
async function getPrice(s) {
    s = s.toUpperCase().trim(); 
    if(!s) return { price: 0, origin: 'TRY', change: 0 };

    // 1. ÖZEL ALTIN TANIMLARI (Çeyrek, Gram vb. için)
    const goldKeywords = [
        { key: 'ONS', type: 'ONS', factor: 0 }, 
        { key: 'GRAM HAS', type: 'GRAM24', factor: 1 },
        { key: '24K', type: 'GRAM24', factor: 1 },
        { key: '22 AYAR', type: 'GRAM22', factor: 0.916 },
        { key: 'ÇEYREK', type: 'CEYREK', factor: 1.635 },
        { key: 'YARIM', type: 'YARIM', factor: 3.27 },
        { key: 'TAM', type: 'TAM', factor: 6.54 },
        { key: 'CUMHURİYET', type: 'ATA', factor: 6.72 },
        { key: 'ATA', type: 'ATA', factor: 6.72 }
    ];

    const goldMatch = goldKeywords.find(k => s.includes(k.key));
    if (goldMatch) {
        try {
            const res = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbols=["PAXGUSDT","USDTTRY"]');
            const data = await res.json();
            const paxg = data.find(x => x.symbol === 'PAXGUSDT');
            const usdt = data.find(x => x.symbol === 'USDTTRY');
            if (paxg && usdt) {
                const ons = parseFloat(paxg.lastPrice);
                const usdTry = parseFloat(usdt.lastPrice);
                const change = parseFloat(paxg.priceChangePercent);
                const gramTL = (ons * usdTry) / 31.1035;
                let finalPrice = (goldMatch.type === 'ONS') ? ons : (gramTL * goldMatch.factor);
                let originCurrency = (goldMatch.type === 'ONS') ? 'USD' : 'TRY';
                
                // Basit Altın İkonları
                let icon = "data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='8' y='16' width='48' height='32' fill='%23FFD700' stroke='%23DAA520' stroke-width='2'/%3E%3C/svg%3E";
                if(goldMatch.type === 'GRAM22') icon = "data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='26' fill='none' stroke='%23FFD700' stroke-width='8'/%3E%3C/svg%3E"; 
                else if(goldMatch.type !== 'ONS' && goldMatch.type !== 'GRAM24') icon = "data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%23FFD700' stroke='%23DAA520' stroke-width='2'/%3E%3C/svg%3E"; 

                return { price: finalPrice, origin: originCurrency, change: change, source: 'KUYUMCU', image: icon, correctedSymbol: s };
            }
        } catch(e) {}
    }

    // 2. HİSSE SENEDİ KONTROLÜ (.IS)
    if (s.includes('.IS') || (s.includes('.') && s.length <= 6)) {
        let res = await tryYahoo(s);
        if(res) return res;
    }

    // --- 3. COINGECKO (KRİPTO İÇİN İLK SIRADA!) ---
    // Elimizdeki API Key ile en geniş arama burada yapılır.
    if(coingeckoApiKey) {
        try {
            const searchUrl = `https://api.coingecko.com/api/v3/search?query=${s}&x_cg_demo_api_key=${coingeckoApiKey}`;
            const searchRes = await fetch(searchUrl);
            const searchData = await searchRes.json();

            if(searchData.coins && searchData.coins.length > 0) {
                // En iyi eşleşmeyi bul
                let coin = searchData.coins.find(c => c.symbol.toUpperCase() === s) || searchData.coins[0];

                if(coin) {
                    const priceUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${coin.id}&vs_currencies=usd&include_24hr_change=true&x_cg_demo_api_key=${coingeckoApiKey}`;
                    const priceRes = await fetch(priceUrl);
                    const priceData = await priceRes.json();

                    if(priceData[coin.id]) {
                        return { 
                            price: priceData[coin.id].usd, 
                            origin: 'USD', 
                            change: priceData[coin.id].usd_24h_change, 
                            source: 'CG', // CoinGecko Kaynaklı
                            image: coin.thumb, // Orijinal Logo
                            correctedSymbol: coin.symbol.toUpperCase() 
                        };
                    }
                }
            }
        } catch(e) { console.log("CG Hatası, yedeğe geçiliyor..."); }
    }

    // --- 4. YEDEKLER (Binance, Polygon, Yahoo) ---
    if(s.includes('USDT') || (!s.includes('=') && !s.includes('USD') && !s.includes('EUR'))) {
         let res = await tryBinance(s); 
         if(res) return res; 
    }

    if(polyApiKey) { 
        let res = await tryPolygon(s); 
        if(res) return res; 
    }
    
    let res = await tryYahoo(s); 
    if(res) return res;

    return { price: 0, origin: 'TRY', change: 0 };
}

    async function tryBinance(symbol) {
        let s = symbol.replace('BINANCE:', '').trim();
        if(!s.includes('USDT') && !s.includes('TRY') && !s.includes('BUSD') && !s.includes('USDC')) s += 'USDT';
        try { let r = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${s}`); if(r.ok) { let d = await r.json(); let origin = s.includes('TRY') ? 'TRY' : 'USD'; return { price: parseFloat(d.lastPrice), origin: origin, change: parseFloat(d.priceChangePercent), source: 'BINANCE' }; } } catch(e){} return null;
    }

    async function tryPolygon(symbol) {
        if(!polyApiKey) return null; if(symbol.includes('.IS') || symbol.includes('=') || symbol.includes('TRY')) return null; 
        try { let r = await fetch(`https://api.polygon.io/v2/aggs/ticker/${symbol}/prevClose?adjusted=true&apiKey=${polyApiKey}`); if(r.ok) { let d = await r.json(); if(d.results && d.results[0]) { let res = d.results[0]; return { price: res.c, origin: 'USD', change: ((res.c - res.o) / res.o) * 100, source: 'POLYGON' }; } } } catch(e) {} return null;
    }
 
        /* --- ZIRHLI YAHOO FONKSİYONU (3 Aşamalı) --- */
    async function tryYahoo(symbol) {
        // 1. Sembol Düzeltme: Borsa İstanbul hissesi ise ve .IS yoksa ekle
        let s = symbol.toUpperCase().trim();
        if(!s.includes('=') && !s.includes('.') && s.length <= 5 && !s.includes('USD') && !s.includes('EUR')) {
             s += '.IS';
        }

        // Yahoo API URL'si
        const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${s}?interval=1d&range=1d`;
        
        // Denenecek Proxy Listesi (Sırayla dener)
        const proxies = [
            { url: 'https://api.allorigins.win/raw?url=', name: 'AllOrigins' },
            { url: 'https://corsproxy.io/?', name: 'CorsProxy' },
            { url: 'https://api.codetabs.com/v1/proxy?quest=', name: 'CodeTabs' }
        ];

        // Döngü: Sırayla proxy'leri dene
        for (let proxy of proxies) {
            try {
                // console.log(`Denenen Kaynak: ${proxy.name} -> ${s}`); // Test için konsola yazar
                
                const response = await fetch(proxy.url + encodeURIComponent(targetUrl));
                
                if (response.ok) {
                    const d = await response.json();
                    
                    // Veri yapısını kontrol et (Yahoo JSON formatı)
                    if (d.chart && d.chart.result && d.chart.result[0]) {
                        let meta = d.chart.result[0].meta;
                        let price = meta.regularMarketPrice;
                        let prevClose = meta.chartPreviousClose;
                        
                        // Fiyat sıfır veya null gelirse diğer proxy'ye geç
                        if(!price) throw new Error("Fiyat boş");

                        let change = 0;
                        if (prevClose > 0) change = ((price - prevClose) / prevClose) * 100;

                        // Para birimi belirleme
                        let origin = 'TRY';
                        if (s.includes('=F') || (s.includes('=X') && !s.includes('TRY=X') && !s.includes('EURTRY=X'))) {
                            origin = 'USD';
                        }
                        
                        // Başarılı olursa döndür ve döngüden çık
                        return { 
                            price: parseFloat(price), 
                            origin: origin, 
                            change: change, 
                            source: 'YAHOO' // Hangi proxy ile çalıştığını görmek istersen: proxy.name yazabilirsin
                        };
                    }
                }
            } catch (err) {
                // Bu proxy başarısız olduysa, sessizce bir sonrakine geç
                continue;
            }
        }

        // Hiçbiri çalışmazsa null dön
        return null;
    }


    function setSortMode(mode) { currentSortMode = mode; loadPF(); }
    
    /* --- GÜNCELLENMİŞ VERİ YÜKLEYİCİ (KAYNAK KAYITLI) --- */
async function loadPF(refreshData = false){
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    if(as.length === 0) { renderPortfolioHTML([]); return; }

    if(refreshData) {
        document.getElementById('totalWallet').style.opacity = "0.5";
        
        // 1. COINGECKO VARSA
        if(coingeckoApiKey) {
            try {
                const url = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=250&page=1&sparkline=false&x_cg_demo_api_key=${coingeckoApiKey}`;
                const res = await fetch(url);
                if(res.ok) {
                    const cgData = await res.json();
                    as.forEach(asset => {
                        const isCrypto = asset.name.includes('USDT') || (!asset.name.includes('.') && !asset.name.includes('='));
                        if(isCrypto) {
                            let cleanSym = asset.name.replace('USDT','').replace('BINANCE:','').toLowerCase();
                            const matchedCoin = cgData.find(c => c.symbol === cleanSym);
                            if(matchedCoin) {
                                asset.curr = matchedCoin.current_price;
                                asset.image = matchedCoin.image;
                                asset.source = 'CG'; // GECKO ETİKETİ İÇİN BU LAZIM
                            }
                        }
                    });
                }
            } catch(e) {}
        }

        // 2. DİĞERLERİ
        const promises = as.map(async (a) => {
            if(a.source === 'CG') return a; // Zaten CG ise geç
            
            let s = a.name; 
            if(!s.includes('USDT') && !s.includes('.') && s.length<=5 && s !== 'ALTIN' && !s.includes('=') && !s.includes('USD')) s += '.IS';
            
            let live = await getPrice(s); 
            if(live.price > 0) {
                a.curr = live.price;
                a.source = live.source || 'Piyasa'; // Kaynağı kaydet
            }
            return a;
        });

        await Promise.all(promises);
        localStorage.setItem('myPF_final', JSON.stringify(as));
        document.getElementById('totalWallet').style.opacity = "1";
    }

    renderPortfolioHTML(as);
}

    /* --- GÜNCELLENMİŞ CÜZDAN GÖRÜNÜMÜ (KAYNAK ETİKETLİ) --- */
function renderPortfolioHTML(as) {
    let l = document.getElementById('portfolioList'); 
    if(!l) return;
    
    if(!as || as.length === 0) {
        if(cashBalance > 0 && tradeHistory.length === 0 && (!as || as.length === 0)) { 
            l.innerHTML = "<div style='text-align:center; padding:30px; color:var(--text-sub); opacity:0.6;'><i class='fas fa-wallet' style='font-size:32px; margin-bottom:10px;'></i><br>Portföy Boş</div>"; 
        } else { 
            l.innerHTML = '<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>'; 
        }
        updateHeaderTotals(0, 0, { bist: 0, crypto: 0, other: 0, cash: cashBalance });
        return;
    }

    let totalVal = 0; 
    let chartData = { bist: 0, crypto: 0, other: 0, cash: cashBalance }; 
    let uCurr = appSettings.currency; 
    let sym = uCurr==='TRY'?'₺':'$'; 
    let totalUnrealizedPnL = 0;
    
    // Sıralama ve Hesaplama Mantığı
    let displayAssets = (as || []).map((a, i) => { 
        let rp = (a.curr && a.curr > 0) ? a.curr : a.buy; 
        let dVal = 0; let dCost = 0; 
        if(uCurr === 'TRY') { 
            if(a.origin === 'USD') { dVal = rp * a.amt * usdTryRate; dCost = a.buy * a.amt * usdTryRate; } 
            else { dVal = rp * a.amt; dCost = a.buy * a.amt; } 
        } else { 
            if(a.origin === 'TRY') { dVal = (rp * a.amt) / usdTryRate; dCost = (a.buy * a.amt) / usdTryRate; } 
            else { dVal = rp * a.amt; dCost = a.buy * a.amt; } 
        } 
        let pnl = dVal - dCost; 
        let pnlPercent = (dCost > 0) ? (pnl / dCost) * 100 : 0; 
        totalUnrealizedPnL += pnl; 
        return { ...a, originalIndex: i, dVal, dCost, pnl, pnlPercent, rp }; 
    });

    // Sıralama
    if(currentSortMode === 'value_desc') displayAssets.sort((a,b) => b.dVal - a.dVal); 
    else if(currentSortMode === 'pnl_desc') displayAssets.sort((a,b) => b.pnl - a.pnl); 
    else if(currentSortMode === 'pnl_asc') displayAssets.sort((a,b) => a.pnl - b.pnl); 
    else if(currentSortMode === 'percent_desc') displayAssets.sort((a,b) => b.pnlPercent - a.pnlPercent); 
    else if(currentSortMode === 'alpha_asc') displayAssets.sort((a,b) => a.name.localeCompare(b.name));

    let htmlBuilder = ""; 
    if(displayAssets.length > 0) { 
        htmlBuilder += `<div class="sort-scroll-wrapper"><div class="sort-chip ${currentSortMode==='value_desc'?'active':''}" onclick="setSortMode('value_desc')"><i class="fas fa-coins"></i> Değer</div><div class="sort-chip ${currentSortMode==='percent_desc'?'active':''}" onclick="setSortMode('percent_desc')"><i class="fas fa-percent"></i> Kâr (%)</div><div class="sort-chip ${currentSortMode==='pnl_desc'?'active':''}" onclick="setSortMode('pnl_desc')"><i class="fas fa-arrow-up"></i> Kazanç</div><div class="sort-chip ${currentSortMode==='pnl_asc'?'active':''}" onclick="setSortMode('pnl_asc')"><i class="fas fa-arrow-down"></i> Kayıp</div><div class="sort-chip ${currentSortMode==='alpha_asc'?'active':''}" onclick="setSortMode('alpha_asc')">A-Z</div></div>`; 
    }

    displayAssets.forEach((a) => { 
        totalVal += a.dVal; 
        let tag = getAssetTag(a.name).t; 
        if(tag === 'KRİPTO') chartData.crypto += a.dVal; 
        else if(tag === 'BORSA') chartData.bist += a.dVal; 
        else chartData.other += a.dVal;

        let cls = a.pnl >= 0 ? 'pnl-up' : 'pnl-down'; 
        let priceUnit = a.origin === 'USD' ? `<b id="live_price_${a.originalIndex}">$${a.rp.toFixed(2)}</b>` : `<b id="live_price_${a.originalIndex}">₺${a.rp.toFixed(2)}</b>`; 
        
        let logoHtml = "";
        if(a.image) logoHtml = `<div class="asset-logo-wrap" style="background:transparent; border:none;"><img src="${a.image}" class="asset-logo-img"></div>`;
        else logoHtml = getAssetLogoHtml(a.name.replace('.IS',''));
        
        let cardColorClass = 'asset-card' + (a.pnl > 0 ? ' profit-bg' : (a.pnl < 0 ? ' loss-bg' : '')); 
        let chartId = `mini_chart_${a.originalIndex}`; 
        let percentBadge = `<span id="live_pct_${a.originalIndex}" style="font-size:10px; opacity:0.8; margin-right:4px;">(%${a.pnlPercent.toFixed(1)})</span>`; 
        
        // --- YENİ ETİKET MANTIĞI BURADA ---
        let sourceBadge = "";
        if(a.source) {
            let sColor = "#94a3b8"; // Varsayılan Gri
            let sText = a.source;
            
            if(a.source === 'CG' || a.source.includes('RANK')) { sColor = "#8bc34a"; sText = "GECKO"; } // Yeşil
            else if(a.source === 'BINANCE') { sColor = "#f59e0b"; } // Turuncu
            else if(a.source === 'BIST') { sColor = "#3b82f6"; } // Mavi
            else if(a.source === 'YAHOO') { sColor = "#8b5cf6"; } // Mor
            
            sourceBadge = `<span style="font-size:8px; font-weight:800; background:${sColor}20; color:${sColor}; padding:2px 6px; border-radius:4px; margin-left:6px; letter-spacing:0.5px;">${sText}</span>`;
        }
        // ----------------------------------

        htmlBuilder += `<div class="${cardColorClass}" id="card_bg_${a.originalIndex}"><div class="asset-header collapsible-header" onclick="toggleAssetDetails(${a.originalIndex})"><div class="asset-left">${logoHtml}<div><span class="asset-name">${a.name.replace('.IS','')}${sourceBadge}</span><div class="asset-meta">${a.amt} Adet</div></div></div><div style="display:flex; align-items:center; gap:10px;"><div class="asset-pnl ${cls}" id="live_pnl_badge_${a.originalIndex}">${percentBadge}${sym}<span id="live_pnl_val_${a.originalIndex}">${a.pnl.toFixed(0)}</span></div><i id="asset-chevron-${a.originalIndex}" class="fas fa-chevron-down rotate-icon" style="font-size:12px; color:var(--text-sub);"></i></div></div><div id="asset-content-${a.originalIndex}" class="collapsible-content collapsed"><div class="asset-body-content"><div class="asset-details-grid"><div class="detail-item"><span class="detail-label">Ortalama</span><span class="detail-val">${a.buy.toFixed(2)} ${a.origin==='USD'?'$':'₺'}</span></div><div class="detail-item" style="text-align:right;"><span class="detail-label">Güncel</span><span class="detail-val accent">${priceUnit}</span></div><div class="detail-item"><span class="detail-label">Maliyet</span><span class="detail-val">${sym}${a.dCost.toFixed(0)}</span></div><div class="detail-item" style="text-align:right;"><span class="detail-label">Toplam Değer</span><span class="detail-val" id="live_total_val_${a.originalIndex}">${sym}${a.dVal.toFixed(0)}</span></div></div>${a.note ? `<div class="asset-note"><i class="fas fa-sticky-note"></i> ${a.note}</div>` : ''}<div class="asset-footer"><button class="tool-btn" onclick="toggleAssetChart('${a.name}', '${chartId}', this)"><i class="fas fa-chart-area"></i></button><button class="tool-btn ${a.alarm?'active-alarm':''}" onclick="openAlarmModal(${a.originalIndex})"><i class="fas fa-bell"></i></button><button class="tool-btn active-sim" onclick="openSimulator(${a.originalIndex})"><i class="fas fa-magic"></i></button><button class="tool-btn" onclick="editNote(${a.originalIndex})"><i class="fas fa-edit"></i></button><button class="tool-btn" onclick="openSell(${a.originalIndex})"><i class="fas fa-coins"></i></button><button class="tool-btn" onclick="delAsset(${a.originalIndex})"><i class="fas fa-trash"></i></button></div><div id="${chartId}" class="asset-mini-chart"></div></div></div></div>`; 
    });
    
    l.innerHTML = htmlBuilder;
    updateHeaderTotals(totalVal, totalUnrealizedPnL, chartData);
    checkAllAlarms();
}


    function updateHeaderTotals(totalVal, totalUnrealizedPnL, chartData) {
        let sym = appSettings.currency==='TRY'?'₺':'$';
        let grandTotal = totalVal + cashBalance; 
        document.getElementById('totalWallet').innerText = sym + grandTotal.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}); 
        document.getElementById('cashBalance').innerText = sym + cashBalance.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0}); 
        document.getElementById('realizedPnLVal').innerText = sym + realizedPnL.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        const hero = document.querySelector('.balance-hero'); 
        if(hero) { if(totalUnrealizedPnL >= 0) { hero.classList.remove('loss'); hero.classList.add('profit'); } else { hero.classList.remove('profit'); hero.classList.add('loss'); } }
        if(isPrivacyMode) document.getElementById('totalWallet').classList.add('privacy-blur'); else document.getElementById('totalWallet').classList.remove('privacy-blur');
    }
/* --- YENİ MUHASEBE VE GÜVENLİ SİLME MOTORU (FİNAL - DETAY KARTLI) --- */

// Global Değişken: Silinenleri hafızadan çek
let deletedHistory = JSON.parse(localStorage.getItem('tm_deleted_history')) || [];

/* 1. Gelişmiş Render History */
function renderHistory() {
    let l = document.getElementById('historyListFull');
    if (!l) return;
    l.innerHTML = "";

    // Çöp Kutusu Sayacını Güncelle
    let trashCountEl = document.getElementById('trashCount');
    if(trashCountEl) trashCountEl.innerText = deletedHistory.length;

    let globalSym = appSettings.currency === 'TRY' ? '₺' : '$';
    
    // --- MUHASEBE HESAPLAMALARI ---
    let totalInvested = 0; 
    let totalRealizedProfit = 0; 
    let totalSalaryPaid = 0; 

    tradeHistory.forEach(t => {
        let val = parseFloat(t.total || 0);
        let pnl = parseFloat(t.pnl || 0);
        
        let transCurr = t.curr || appSettings.currency;
        if (appSettings.currency === 'TRY' && transCurr === 'USD') { val *= usdTryRate; pnl *= usdTryRate; }
        else if (appSettings.currency === 'USD' && transCurr === 'TRY') { val /= usdTryRate; pnl /= usdTryRate; }

        if (t.type === 'YATIRMA') totalInvested += val;
        else if (t.type === 'ÇEKME') totalInvested -= val;
        else if (t.type === 'MAAŞ') totalSalaryPaid += val;
        else if (t.type === 'SATIM') totalRealizedProfit += pnl;
        else if (t.type === 'TEMETTÜ') totalRealizedProfit += val;
    });

    let currentPortfolioValue = 0;
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    as.forEach(a => {
        let p = a.curr || a.buy;
        let v = (a.origin === 'USD' && appSettings.currency === 'TRY') ? (p * a.amt * usdTryRate) : 
                (a.origin === 'TRY' && appSettings.currency === 'USD') ? ((p * a.amt) / usdTryRate) : (p * a.amt);
        currentPortfolioValue += v;
    });
    
    let totalEquity = cashBalance + currentPortfolioValue;
    let netPnL = totalEquity - totalInvested;

    let elEq = document.getElementById('accTotalEquity');
    let elCap = document.getElementById('accCapital');
    let elDiv = document.getElementById('accDividend');
    let elNet = document.getElementById('accNetPnl');

    if(elEq) elEq.innerText = globalSym + totalEquity.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0});
    if(elCap) elCap.innerText = globalSym + totalInvested.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0});
    if(elDiv) elDiv.innerText = globalSym + totalSalaryPaid.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0});
    
    if(elNet) {
        elNet.innerText = (netPnL >= 0 ? '+' : '') + globalSym + netPnL.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:0});
        elNet.style.color = netPnL >= 0 ? 'var(--success)' : 'var(--danger)';
    }

    let withdrawableProfit = Math.max(0, totalRealizedProfit - totalSalaryPaid);
    let elSalAvail = document.getElementById('salaryAvailable');
    if(elSalAvail) elSalAvail.innerText = globalSym + withdrawableProfit.toLocaleString();

    // --- LİSTELEME ---
    let filteredHistory = tradeHistory.slice().reverse().filter(t => {
        if (currentHistoryFilter === 'all') return true;
        if (currentHistoryFilter === 'NAKİT') return (t.type === 'YATIRMA' || t.type === 'ÇEKME');
        return t.type === currentHistoryFilter;
    });

    if (filteredHistory.length === 0) {
        l.innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-sub); opacity:0.6;'>Kayıt Yok</div>";
        return;
    }

    filteredHistory.forEach((t) => {
        let realIndex = tradeHistory.indexOf(t);
        
        let displayVal = parseFloat(t.total);
        let transCurr = t.curr || appSettings.currency;
        if (appSettings.currency === 'TRY' && transCurr === 'USD') displayVal *= usdTryRate;
        else if (appSettings.currency === 'USD' && transCurr === 'TRY') displayVal /= usdTryRate;

        let icon = 'circle'; let cls = 'l-type-neutral'; let sign = ''; let color = 'white'; let desc = t.sym;

        if (t.type === 'ALIM') { icon = 'arrow-down'; cls = 'l-type-out'; color = 'var(--danger)'; desc = `${t.sym} Alımı`; } 
        else if (t.type === 'SATIM') { icon = 'arrow-up'; cls = 'l-type-in'; color = 'var(--success)'; sign = '+'; desc = `${t.sym} Satışı`; } 
        else if (t.type === 'MAAŞ') { icon = 'hand-holding-usd'; cls = 'l-type-out'; color = '#10b981'; sign = '-'; desc = 'Kâr Dağıtımı'; }
        else if (t.type === 'YATIRMA') { icon = 'plus'; cls = 'l-type-in'; color = 'var(--success)'; sign = '+'; desc = t.desc || 'Sermaye Girişi'; } 
        else if (t.type === 'ÇEKME') { icon = 'minus'; cls = 'l-type-out'; color = 'var(--danger)'; sign = '-'; desc = t.desc || 'Sermaye Çıkışı'; }

        // --- DETAY KARTI GERİ GELDİ (DÜZELTME BURADA) ---
        let detailCardHtml = "";
        if (t.type === 'SATIM' && t.avgCost) {
            let isProfit = t.pnl >= 0;
            let profitColor = isProfit ? 'var(--success)' : 'var(--danger)';
            let profitSign = isProfit ? '+' : '';
            let cardBg = isProfit ? 'rgba(16, 185, 129, 0.05)' : 'rgba(239, 68, 68, 0.05)';
            let itemSym = transCurr === 'USD' ? '$' : '₺';

            detailCardHtml = `
            <div style="margin-top:10px; background:${cardBg}; border-radius:8px; padding:10px; font-size:11px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:6px; padding-bottom:6px; border-bottom:1px solid rgba(255,255,255,0.05);">
                    <span style="color:var(--text-sub);">Alış: <b style="color:white;">${itemSym}${parseFloat(t.avgCost).toFixed(2)}</b></span>
                    <span style="color:var(--text-sub); opacity:0.5;"><i class="fas fa-arrow-right"></i></span>
                    <span style="color:var(--text-sub);">Satış: <b style="color:white;">${itemSym}${parseFloat(t.price).toFixed(2)}</b></span>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <span style="font-weight:700; color:var(--text-sub);">SONUÇ:</span>
                    <span style="color:${profitColor}; font-weight:800; font-size:12px;">${profitSign}${itemSym}${parseFloat(t.pnl).toLocaleString(undefined, {minimumFractionDigits:2})} (%${parseFloat(t.plPercent).toFixed(2)})</span>
                </div>
                <div style="font-style:italic; opacity:0.8; margin-bottom:4px; line-height:1.3; color:var(--text-sub);">"${t.note || 'İşlem notu yok.'}"</div>
            </div>`;
        }

        // Kart HTML
        l.innerHTML += `
        <div class="ledger-card ${cls}" style="flex-direction:column; align-items:stretch;">
            <div style="display:flex; justify-content:space-between; align-items:center; width:100%;">
                <div class="lc-left">
                    <div class="lc-icon"><i class="fas fa-${icon}"></i></div>
                    <div class="lc-info">
                        <span class="lc-title">${desc}</span>
                        <span class="lc-date">${t.date} • ${t.type}</span>
                    </div>
                </div>
                <div class="lc-right">
                    <span class="lc-amount" style="color:${color}">${sign}${globalSym}${displayVal.toLocaleString(undefined, {minimumFractionDigits:2})}</span>
                    <button onclick="safeDeleteHistory(${realIndex})" style="background:none; border:none; color:var(--text-sub); margin-left:10px; cursor:pointer;"><i class="fas fa-trash"></i></button>
                </div>
            </div>
            ${detailCardHtml}
        </div>`;
    });
}

/* 2. Güvenli Silme (Safe Delete) */
function safeDeleteHistory(index) {
    if(index === -1) return;
    let item = tradeHistory[index];
    if(!confirm(`"${item.type}" işlemini silmek istediğinize emin misiniz?`)) return;

    deletedHistory.push(item);
    localStorage.setItem('tm_deleted_history', JSON.stringify(deletedHistory));

    tradeHistory.splice(index, 1);
    localStorage.setItem('tm_full_trade_history', JSON.stringify(tradeHistory));

    addNotification('info', 'Arşivlendi', 'İşlem çöp kutusuna taşındı.');
    renderHistory();
}

/* 3. Çöp Kutusunu Aç ve Yönet */
function openTrashModal() {
    let l = document.getElementById('trashList');
    l.innerHTML = "";
    
    if(deletedHistory.length === 0) {
        l.innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-sub);'>Çöp kutusu boş.</div>";
    } else {
        deletedHistory.forEach((item, idx) => {
            l.innerHTML += `
            <div class="deleted-item">
                <div>
                    <div style="font-weight:700; font-size:12px; color:white;">${item.type} - ${item.sym || 'Nakit'}</div>
                    <div style="font-size:10px; color:var(--text-sub);">${item.date} • ${item.total}</div>
                </div>
                <button class="del-restore-btn" onclick="restoreHistory(${idx})">GERİ YÜKLE</button>
            </div>`;
        });
    }
    openModal('trashModal');
}

function restoreHistory(idx) {
    let item = deletedHistory[idx];
    tradeHistory.push(item);
    tradeHistory.sort((a, b) => new Date(convertToDate(a.date)) - new Date(convertToDate(b.date)));
    deletedHistory.splice(idx, 1);
    
    localStorage.setItem('tm_deleted_history', JSON.stringify(deletedHistory));
    localStorage.setItem('tm_full_trade_history', JSON.stringify(tradeHistory));
    
    addNotification('success', 'Geri Yüklendi', 'Kayıt deftere geri eklendi.');
    openTrashModal();
    renderHistory();
}

function convertToDate(dateStr) {
    if(!dateStr) return new Date();
    let parts = dateStr.split('.');
    if(parts.length < 3) return new Date();
    return new Date(parts[2], parts[1] - 1, parts[0]);
}

/* 4. Maaş Ödeme Fonksiyonu */
function openSalaryModal() { openModal('salaryModal'); }

function confirmSalary() {
    let amt = parseFloat(document.getElementById('salaryAmt').value);
    if(!amt || amt <= 0) return alert("Tutar giriniz.");
    if(amt > cashBalance) return alert("Kasada bu kadar nakit yok!");

    cashBalance -= amt;
    localStorage.setItem('tm_cash_balance', cashBalance);

    logHistory('MAAŞ', 'NAKİT', 1, amt, 'Kâr Dağıtımı', appSettings.currency);

    addNotification('success', 'Ödeme Yapıldı', `Kendinize ${amt} ödeme yaptınız. Bereketli olsun!`);
    closeModal('salaryModal');
    renderHistory();
    loadPF(false);
}

    /* --- GÜNCELLENMİŞ KAYIT FONKSİYONU (KARNE DESTEKLİ) --- */
function logHistory(type, s, a, p, desc='', curr = null, pnl = 0, details = {}) { 
    let d = new Date(); 
    let transactionCurrency = curr ? curr : appSettings.currency;
    
    let t = { 
        date: d.toLocaleDateString('tr-TR'), 
        time: d.toLocaleTimeString('tr-TR').substring(0,5), 
        type: type, 
        sym: s, 
        qty: a, 
        price: p, 
        total: a*p, 
        desc: desc, 
        curr: transactionCurrency,
        pnl: pnl, // Net Kâr/Zarar
        
        // --- YENİ EKLENEN KARNE VERİLERİ ---
        avgCost: details.avgCost || 0,          // Maliyetimiz neydi?
        plPercent: details.plPercent || 0,      // Yüzde kaç kazandık?
        usdRateAtSell: details.usdRateAtSell || 0, // Dolar kuru kaçtı?
        note: details.note || ''                // İşlem notu
    }; 
    
    tradeHistory.push(t); 
    localStorage.setItem('tm_full_trade_history', JSON.stringify(tradeHistory)); 
    renderHistory(); 
}

    // --- NAKİT İŞLEMLERİ ---
    function modifyCash(m) { openCashModal(); }
    function openCashModal() { document.getElementById('cashModal').style.display = 'flex'; document.getElementById('cashAmountInput').value = ''; document.getElementById('cashDescInput').value = ''; }
    function setCashType(type, btn) { document.getElementById('cashTypeVal').value = type; document.querySelectorAll('.cash-modal-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
    
    function submitCashTransaction() {
        let type = document.getElementById('cashTypeVal').value; let amt = parseFloat(document.getElementById('cashAmountInput').value); let desc = document.getElementById('cashDescInput').value.trim();
        if(!amt || amt <= 0) return addNotification('warn', 'Hata', 'Geçerli miktar giriniz.');
        let currentAppCurrency = appSettings.currency;
        if(type === 'in') { 
            cashBalance += amt; 
            logHistory('YATIRMA', 'NAKİT', 1, amt, desc ? desc : 'Kasa Girişi', currentAppCurrency); 
            addNotification('success', 'Nakit Eklendi', `${amt} tutarında giriş yapıldı.`); 
        } else { 
            if(amt > cashBalance) return addNotification('danger', 'Yetersiz Bakiye', 'Kasada bu kadar nakit yok.'); 
            cashBalance -= amt; 
            logHistory('ÇEKME', 'NAKİT', 1, amt, desc ? desc : 'Kasa Çıkışı', currentAppCurrency); 
            addNotification('warn', 'Nakit Çekildi', `${amt} tutarında çıkış yapıldı.`); 
        }
        localStorage.setItem('tm_cash_balance', cashBalance); 
        loadPF(false); 
        takePortfolioSnapshot(); 
        closeModal('cashModal');
    }

    function addDividend(){ let v=parseFloat(prompt("Temettü:")); if(v){cashBalance+=v; logHistory('TEMETTÜ','NAKİT',1,v, '', appSettings.currency); localStorage.setItem('tm_cash_balance',cashBalance); loadPF(); addNotification('success', 'Temettü Eklendi', `Kasa giriş: ${v}`); }}
    function filterHistory(type, btn) { currentHistoryFilter = type; document.querySelectorAll('.h-filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderHistory(); }

    /* --- PRO ANALİZ MOTORU --- */
    function takePortfolioSnapshot() {
        let history = JSON.parse(localStorage.getItem('tm_networth_history')) || []; let today = new Date().toLocaleDateString('tr-TR'); let as = JSON.parse(localStorage.getItem('myPF_final')) || []; let assetVal = 0;
        as.forEach(a => { let p = a.curr || a.buy; let v = (a.origin === 'USD' && appSettings.currency === 'TRY') ? (p * a.amt * usdTryRate) : (a.origin === 'TRY' && appSettings.currency === 'USD') ? ((p * a.amt) / usdTryRate) : (p * a.amt); assetVal += v; });
        let total = assetVal + cashBalance; let lastEntry = history[history.length - 1];
        if (!lastEntry || lastEntry.date !== today) { history.push({ date: today, val: total }); if(history.length > 30) history.shift(); localStorage.setItem('tm_networth_history', JSON.stringify(history)); } else { lastEntry.val = total; localStorage.setItem('tm_networth_history', JSON.stringify(history)); }
    }
    
    function renderAnalyticsPage() {
        let as = JSON.parse(localStorage.getItem('myPF_final')) || []; let sym = appSettings.currency === 'TRY' ? '₺' : '$'; let totalAssetVal = 0; let totalCost = 0;
        as.forEach(a => { let p = a.curr || a.buy; let val = 0; let cost = 0; if(appSettings.currency === 'TRY') { val = (a.origin === 'USD') ? (p * a.amt * usdTryRate) : (p * a.amt); cost = (a.origin === 'USD') ? (a.buy * a.amt * usdTryRate) : (a.buy * a.amt); } else { val = (a.origin === 'TRY') ? ((p * a.amt) / usdTryRate) : (p * a.amt); cost = (a.origin === 'TRY') ? ((a.buy * a.amt) / usdTryRate) : (a.buy * a.amt); } totalAssetVal += val; totalCost += cost; });
        let netWorth = totalAssetVal + cashBalance; let unrealizedPnL = totalAssetVal - totalCost;
        document.getElementById('anNetWorth').innerText = sym + netWorth.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        let pnlEl = document.getElementById('anPnlPill'); pnlEl.innerText = `${unrealizedPnL >= 0 ? '+' : ''}${sym}${unrealizedPnL.toLocaleString(undefined, {minimumFractionDigits:0})}`; pnlEl.className = unrealizedPnL >= 0 ? 'trend-up' : 'trend-down';
        let wins = 0; let totalTrades = 0; if(as.length > 0) { as.forEach(a => { totalTrades++; if((a.curr || a.buy) >= a.buy) wins++; }); } let winRate = totalTrades > 0 ? Math.round((wins / totalTrades) * 100) : 0;
        document.getElementById('winRateVal').innerText = `%${winRate}`; renderWinRateChart(winRate);
        let cashRatio = netWorth > 0 ? (cashBalance / netWorth) * 100 : 0; document.getElementById('anCashRatioVal').innerText = `%${cashRatio.toFixed(1)}`; document.getElementById('anCashRaw').innerText = sym + cashBalance.toLocaleString();
        let bar = document.getElementById('cashRatioBar'); bar.style.width = `${cashRatio}%`; bar.className = 'goal-fill ' + (cashRatio > 50 ? 'mid' : (cashRatio > 20 ? 'high' : 'low'));
        renderRealGrowthChart();
        let sortedAssets = [...as].sort((a, b) => { let valA = (a.curr || a.buy) * a.amt; let costA = a.buy * a.amt; let pnlA = valA - costA; let valB = (b.curr || b.buy) * b.amt; let costB = b.buy * b.amt; let pnlB = valB - costB; return pnlB - pnlA; }).slice(0, 3);
        let topListHTML = ""; if(sortedAssets.length === 0) topListHTML = "<div style='text-align:center; font-size:11px; color:var(--text-sub); padding:10px;'>Veri Yok</div>";
        sortedAssets.forEach((a, i) => { let currentP = a.curr || a.buy; let rawPnL = (currentP - a.buy) * a.amt; let pnlColor = rawPnL >= 0 ? 'var(--success)' : 'var(--danger)'; topListHTML += `<div class="top-performer-row"><div class="tp-name"><div class="rank-badge ${i===0 ? 'rank-1' : ''}">${i+1}</div>${a.name.replace('.IS','')}</div><div class="tp-val" style="color:${pnlColor}">${rawPnL >= 0 ? '+' : ''}${rawPnL.toFixed(0)}</div></div>`; });
        document.getElementById('topPerformersList').innerHTML = topListHTML; renderNewAllocationChart(as);
        
    calculateTraderScore();
}

    
    let wrChartInstance = null; function renderWinRateChart(rate) { const ctx = document.getElementById('winRateChart').getContext('2d'); if(wrChartInstance) wrChartInstance.destroy(); let color = rate >= 50 ? '#10b981' : '#ef4444'; wrChartInstance = new Chart(ctx, { type: 'doughnut', data: { labels: ['Win', 'Loss'], datasets: [{ data: [rate, 100 - rate], backgroundColor: [color, 'rgba(255,255,255,0.05)'], borderWidth: 0, cutout: '85%', borderRadius: 20 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } } }); }
    let growthChartReal = null; function renderRealGrowthChart() { const ctx = document.getElementById('realGrowthChart').getContext('2d'); if(growthChartReal) growthChartReal.destroy(); let history = JSON.parse(localStorage.getItem('tm_networth_history')) || []; if(history.length === 0) history.push({ date: new Date().toLocaleDateString('tr-TR'), val: 0 }); let labels = history.map(h => h.date.substring(0, 5)); let data = history.map(h => h.val); let gradient = ctx.createLinearGradient(0, 0, 0, 400); gradient.addColorStop(0, 'rgba(59, 130, 246, 0.5)'); gradient.addColorStop(1, 'rgba(59, 130, 246, 0.0)'); growthChartReal = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Net Varlık', data: data, borderColor: '#3b82f6', backgroundColor: gradient, borderWidth: 2, pointBackgroundColor: '#1e1e1e', pointBorderColor: '#3b82f6', pointRadius: 4, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#64748b', font: {size: 10} } }, y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: {size: 10} } } } } }); }
    let allocChartNew = null; function renderNewAllocationChart(as) { const ctx = document.getElementById('newAllocationChart').getContext('2d'); if(allocChartNew) allocChartNew.destroy(); let crypto = 0, bist = 0, forex = 0, cash = cashBalance; as.forEach(a => { let val = (a.curr || a.buy) * a.amt; if(appSettings.currency === 'TRY' && a.origin === 'USD') val *= usdTryRate; let tag = getAssetTag(a.name).t; if(tag === 'KRİPTO') crypto += val; else if(tag === 'BORSA') bist += val; else forex += val; }); allocChartNew = new Chart(ctx, { type: 'doughnut', data: { labels: ['Kripto', 'Borsa', 'Döviz', 'Nakit'], datasets: [{ data: [crypto, bist, forex, cash], backgroundColor: ['#f59e0b', '#3b82f6', '#8b5cf6', '#10b981'], borderWidth: 0, hoverOffset: 10 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: 'white', boxWidth: 10, font: {size: 10} } } } } }); }
    function updateGrowthChart(days) { document.querySelectorAll('.chart-filter-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); renderRealGrowthChart(); }
    /* --- DİĞER YARDIMCI FONKSİYONLAR --- */
    /* --- GÜNCELLENMİŞ ÖNİZLEME (KAYNAK GÖSTERGELİ) --- */
let debounceTimer; 
function debouncedPreview(val) { 
    clearTimeout(debounceTimer); 
    const infoDiv = document.getElementById('liveInfo'); 
    
    if(val.length < 2) { 
        infoDiv.innerText = ""; 
        return; 
    } 
    
    infoDiv.innerHTML = "<i class='fas fa-circle-notch fa-spin'></i> Aranıyor..."; 
    
    debounceTimer = setTimeout(async () => { 
        let res = await getPrice(val); 
        
        if (res.price > 0) { 
            let sym = res.origin === 'USD' ? '$' : '₺'; 
            let sourceColor = "var(--text-sub)";
            let sourceText = res.source || "PİYASA";

            // Kaynağa göre renkler
            if(sourceText === 'CG') { sourceText = "COINGECKO"; sourceColor = "#8bc34a"; }
            else if(sourceText === 'BINANCE') { sourceColor = "#f59e0b"; }
            else if(sourceText === 'BIST') { sourceColor = "#3b82f6"; }

            infoDiv.innerHTML = `
                <span style="color:var(--success); font-weight:700;">
                    ${val.toUpperCase()} 
                    <span style="font-size:9px; background:${sourceColor}20; color:${sourceColor}; padding:2px 5px; border-radius:4px; margin-left:5px;">${sourceText}</span>
                </span>
                <span style="color:white; margin-left:5px;">
                    : ${sym}${res.price.toFixed(2)}
                </span>`; 
        } else { 
            infoDiv.innerText = "Bulunamadı"; 
            infoDiv.style.color = "var(--text-sub)"; 
        } 
    }, 800); // 0.8 sn bekleme (API tasarrufu için)
}

    
    // --- GÜNCELLENMİŞ: ANLIK TUTAR HESAPLAMA VE RENK DEĞİŞİMİ ---
    function calcLiveTotal() { 
        let amt = parseFloat(document.getElementById('addAmount').value) || 0; 
        let pr = parseFloat(document.getElementById('addBuyPrice').value) || 0; 
        
        // Toplam Tutar
        let total = amt * pr; 
        let sym = entryCurrency === 'TRY' ? '₺' : '$'; 
        let totalEl = document.getElementById('liveTradeTotal');
        
        totalEl.innerText = sym + total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}); 

        // --- GÖRSEL UYARI KONTROLÜ ---
        let costInWallet = 0;
        if (appSettings.currency === entryCurrency) {
            costInWallet = total;
        } else {
            if (appSettings.currency === 'TRY' && entryCurrency === 'USD') costInWallet = total * usdTryRate;
            else if (appSettings.currency === 'USD' && entryCurrency === 'TRY') costInWallet = total / usdTryRate;
        }

        // Para yetmiyorsa Kırmızı, yetiyorsa Beyaz yap
        if(costInWallet > cashBalance) {
            totalEl.style.color = 'var(--danger)'; 
            totalEl.style.fontWeight = '800';
        } else {
            totalEl.style.color = 'white';
            totalEl.style.fontWeight = '800';
        }
    }
    
 /* --- GÜNCELLENMİŞ PORTFÖYE EKLEME (IŞIK HIZINDA) --- */
async function addToPortfolio(){ 
    // 1. Kullanıcının yazdığını al
    let rawInput = document.getElementById('addSymbol').value.trim();
    let a = parseFloat(document.getElementById('addAmount').value); 
    let b = parseFloat(document.getElementById('addBuyPrice').value); 
    
    if(!rawInput || !a || !b) return addNotification('danger', 'Hata', 'Eksik bilgi girdiniz.'); 

    // 2. Fiyatı ve DOĞRU SEMBOLÜ tekrar çek
    addNotification('info', 'İşleniyor', 'Varlık doğrulanıyor...');
    let checkRes = await getPrice(rawInput);
    
    let s = checkRes.correctedSymbol ? checkRes.correctedSymbol : rawInput.toUpperCase();

    let totalCostInEntry = a * b; 
    let costInWallet = 0; 
    
    if (appSettings.currency === entryCurrency) { 
        costInWallet = totalCostInEntry; 
    } else { 
        if (appSettings.currency === 'TRY' && entryCurrency === 'USD') costInWallet = totalCostInEntry * usdTryRate;
        else if (appSettings.currency === 'USD' && entryCurrency === 'TRY') costInWallet = totalCostInEntry / usdTryRate;
    } 
    
    if(costInWallet > cashBalance) { 
        openModal('noCashModal');
        return; 
    } 
    
    cashBalance -= costInWallet; 
    localStorage.setItem('tm_cash_balance', cashBalance); 
    
    let as = JSON.parse(localStorage.getItem('myPF_final')) || []; 
    let ex = as.find(i=>i.name===s); 
    let assetOrigin = entryCurrency; 
    
    if(ex){ 
        let existingTotal = ex.amt * ex.buy; 
        let newTotal = 0;
        if(ex.origin === entryCurrency) newTotal = totalCostInEntry;
        else newTotal = (ex.origin === 'USD') ? totalCostInEntry / usdTryRate : totalCostInEntry * usdTryRate;
        
        let finalTotal = existingTotal + newTotal; 
        let finalAmt = ex.amt + a; 
        ex.buy = finalTotal / finalAmt; 
        ex.amt = finalAmt; 
        
        if(checkRes.image) ex.image = checkRes.image;
        if(checkRes.source) ex.source = checkRes.source;

    } else { 
        as.push({
            name: s, 
            amt: a, 
            buy: b, 
            curr: checkRes.price || b, 
            origin: assetOrigin,
            image: checkRes.image || null, 
            source: checkRes.source || null 
        }); 
    } 
    
    localStorage.setItem('myPF_final', JSON.stringify(as)); 
    logHistory('ALIM', s, a, b, '', entryCurrency); 
    
    addNotification('success', 'İşlem Başarılı', `${s} portföye eklendi.`); 
    
    document.getElementById('addSymbol').value=""; 
    document.getElementById('addAmount').value=""; 
    document.getElementById('addBuyPrice').value=""; 
    document.getElementById('liveInfo').innerText=""; 
    document.getElementById('dcaPreview').style.display='none'; 
    document.getElementById('liveTradeTotal').innerText="0.00"; 
    
    // --- HIZ AYARI BURADA YAPILDI ---
    // Eskiden: loadPF(true); -> Her şeyi yeniden indiriyordu.
    // Şimdi: loadPF(false); -> Sadece listeyi çiziyor (İnterneti meşgul etmiyor).
    loadPF(false); 
    
    fetchNewsCustom(); 
    loadProfile(); 
}


    function toggleAssetChart(symbol, id, btn) { let el = document.getElementById(id); let isActive = el.classList.contains('active'); if (isActive) { el.classList.remove('active'); btn.classList.remove('chart-on'); setTimeout(() => { el.innerHTML = ''; }, 400); } else { el.classList.add('active'); btn.classList.add('chart-on'); el.innerHTML = '<div class="chart-loader-text">Grafik Yükleniyor...</div><div id="tv_'+id+'" style="height:100%; width:100%; border-radius:0 0 16px 16px; overflow:hidden;"></div>'; let tvSymbol = symbol; let s = symbol.toUpperCase().trim(); if(s.includes('BIST:') || s.includes('BINANCE:') || s.includes('TVC:') || s.includes('FX:')) { tvSymbol = s; } else if(s.includes('USDT')) { tvSymbol = "BINANCE:" + s; } else if(s.endsWith('.IS')) { tvSymbol = "BIST:" + s.replace('.IS',''); } else if(s === 'ALTIN' || s === 'GOLD') { tvSymbol = "TVC:GOLD"; } else if(s === 'GRAM') { tvSymbol = "FX:XAUTRY"; } else if(['USD','EUR','GBP'].includes(s)) { tvSymbol = "FX:" + s + "TRY"; } else if(s.length <= 5 && !s.includes('.')) { if(s === 'THYAO' || s === 'ASELS' || s === 'GARAN') tvSymbol = "BIST:" + s; else tvSymbol = "BINANCE:" + s + "USDT"; } new TradingView.widget({ "autosize": true, "symbol": tvSymbol, "interval": "D", "timezone": "Etc/UTC", "theme": "dark", "style": "1", "locale": "tr", "toolbar_bg": "#f1f3f6", "enable_publishing": false, "hide_top_toolbar": true, "hide_legend": false, "save_image": false, "container_id": "tv_" + id }); } }
    function openAlarmModal(i){ let as = JSON.parse(localStorage.getItem('myPF_final')) || []; let asset = as[i]; if(!asset) return; document.getElementById('alarmIdx').value = i; document.getElementById('alarmAssetTitle').innerText = `${asset.name} Alarmları`; document.getElementById('alarmUpper').value = asset.alarmUpper || ""; document.getElementById('alarmLower').value = asset.alarmLower || ""; document.getElementById('alarmPctUp').value = asset.alarmPctUp || ""; document.getElementById('alarmPctDown').value = asset.alarmPctDown || ""; switchAlarmTab('price', document.querySelector('.sim-tab-group .sim-tab')); document.getElementById('alarmModal').style.display='flex'; } 
    function switchAlarmTab(mode, btn) { document.querySelectorAll('.alarm-pane').forEach(el => el.style.display = 'none'); document.getElementById('alarm-pane-' + mode).style.display = 'block'; const group = btn.parentElement; group.querySelectorAll('.sim-tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); }
    function saveAlarm(){ let i = document.getElementById('alarmIdx').value; let as = JSON.parse(localStorage.getItem('myPF_final')); let up = parseFloat(document.getElementById('alarmUpper').value); let low = parseFloat(document.getElementById('alarmLower').value); let pUp = parseFloat(document.getElementById('alarmPctUp').value); let pDown = parseFloat(document.getElementById('alarmPctDown').value); as[i].alarmUpper = up || null; as[i].alarmLower = low || null; as[i].alarmPctUp = pUp || null; as[i].alarmPctDown = pDown || null; delete as[i].alarm; localStorage.setItem('myPF_final', JSON.stringify(as)); document.getElementById('alarmModal').style.display='none'; addNotification('success', 'Alarm Kuruldu', `${as[i].name} için bekçiler aktif.`); loadPF(true); } 
    function clearAssetAlarms() { let i = document.getElementById('alarmIdx').value; let as = JSON.parse(localStorage.getItem('myPF_final')); as[i].alarmUpper = null; as[i].alarmLower = null; as[i].alarmPctUp = null; as[i].alarmPctDown = null; localStorage.setItem('myPF_final', JSON.stringify(as)); document.getElementById('alarmUpper').value = ""; document.getElementById('alarmLower').value = ""; document.getElementById('alarmPctUp').value = ""; document.getElementById('alarmPctDown').value = ""; addNotification('info', 'Temizlendi', 'Alarmlar kaldırıldı.'); }
    async function checkAllAlarms(){ let as = JSON.parse(localStorage.getItem('myPF_final')) || []; let updated=false; for(let asset of as){ if(!asset.alarmUpper && !asset.alarmLower && !asset.alarmPctUp && !asset.alarmPctDown) continue; let currentPrice = asset.curr || 0; if(currentPrice === 0) { let p = await getPrice(asset.name); currentPrice = p.price; } if(currentPrice > 0){ if(asset.alarmUpper && currentPrice >= asset.alarmUpper){ addNotification('success', 'HEDEF GELDİ! 🚀', `${asset.name} yükseldi: ${currentPrice}`); asset.alarmUpper = null; updated = true; } if(asset.alarmLower && currentPrice <= asset.alarmLower){ addNotification('danger', 'DÜŞÜŞ UYARISI 🔻', `${asset.name} düştü: ${currentPrice}`); asset.alarmLower = null; updated = true; } let cost = asset.buy; if(cost > 0) { let percentChange = ((currentPrice - cost) / cost) * 100; if(asset.alarmPctUp && percentChange >= asset.alarmPctUp) { addNotification('success', `TEBRİKLER (%${percentChange.toFixed(1)}) 🚀`, `${asset.name} hedef kârına ulaştı.`); asset.alarmPctUp = null; updated = true; } if(asset.alarmPctDown && percentChange <= -(asset.alarmPctDown)) { addNotification('warn', `DİKKAT (%${percentChange.toFixed(1)}) ⚠️`, `${asset.name} zarar limitine indi.`); asset.alarmPctDown = null; updated = true; } } } } if(updated) { localStorage.setItem('myPF_final', JSON.stringify(as)); let l = document.getElementById('portfolioList'); if(l && l.innerHTML !== "") loadPF(); } }
    function toggleExitCurrency() { exitCurrency = (exitCurrency === 'TRY') ? 'USD' : 'TRY'; let btn = document.getElementById('sellCurrencyToggle'); if(exitCurrency === 'TRY') { btn.innerText = '₺'; btn.className = 'currency-toggle-btn active-try'; } else { btn.innerText = '$'; btn.className = 'currency-toggle-btn active-usd'; } calcSellPreview(); }
    
    function openSell(i) { let as = JSON.parse(localStorage.getItem('myPF_final')) || []; let asset = as[i]; if(!asset) return; document.getElementById('sellIdx').value = i; document.getElementById('sellMaxAmt').innerText = asset.amt; document.getElementById('sellAmt').value = ""; exitCurrency = asset.origin; let btn = document.getElementById('sellCurrencyToggle'); if(exitCurrency === 'TRY') { btn.innerText = '₺'; btn.className = 'currency-toggle-btn active-try'; } else { btn.innerText = '$'; btn.className = 'currency-toggle-btn active-usd'; } let currentP = asset.curr || asset.buy; document.getElementById('sellPrice').value = currentP.toFixed(2); document.getElementById('sellSummaryBox').style.display = 'none'; document.getElementById('sellModal').style.display = 'flex'; calcSellPreview(); }
    
    function setSellRatio(ratio) { let i = document.getElementById('sellIdx').value; let as = JSON.parse(localStorage.getItem('myPF_final')); if(as[i]) { let val = Math.floor(as[i].amt * ratio * 1000) / 1000; document.getElementById('sellAmt').value = val; calcSellPreview(); } }
    
    function calcSellPreview() { let i = document.getElementById('sellIdx').value; let as = JSON.parse(localStorage.getItem('myPF_final')); let asset = as[i]; let amt = parseFloat(document.getElementById('sellAmt').value) || 0; let price = parseFloat(document.getElementById('sellPrice').value) || 0; if(amt > 0 && price > 0) { let total = amt * price; let sym = exitCurrency === 'TRY' ? '₺' : '$'; let buyPriceNormalized = asset.buy; if(asset.origin === 'USD' && exitCurrency === 'TRY') buyPriceNormalized = asset.buy * usdTryRate; else if(asset.origin === 'TRY' && exitCurrency === 'USD') buyPriceNormalized = asset.buy / usdTryRate; let pnl = (price - buyPriceNormalized) * amt; document.getElementById('ssTotal').innerText = sym + total.toLocaleString(undefined, {minimumFractionDigits:2}); let pnlEl = document.getElementById('ssPnL'); pnlEl.innerText = (pnl >= 0 ? '+' : '') + sym + pnl.toLocaleString(undefined, {minimumFractionDigits:2}); pnlEl.style.color = pnl >= 0 ? 'var(--success)' : 'var(--danger)'; document.getElementById('sellSummaryBox').style.display = 'block'; } else { document.getElementById('sellSummaryBox').style.display = 'none'; } }
    
/* --- DÜZELTİLMİŞ VE GARANTİLİ SATIŞ ONAYI --- */
function confirmSell() { 
    let i = document.getElementById('sellIdx').value; 
    
    // Girdileri Sayıya Çevir (Hata payını sıfırla)
    let amt = parseFloat(document.getElementById('sellAmt').value); 
    let pr = parseFloat(document.getElementById('sellPrice').value); 
    
    if (!amt || !pr) return addNotification('warn', 'Eksik Bilgi', 'Miktar ve fiyat giriniz.'); 
    
    let as = JSON.parse(localStorage.getItem('myPF_final')) || []; 
    let ast = as[i]; 
    
    if (!ast) return addNotification('danger', 'Hata', 'Varlık bulunamadı.');
    if (amt > ast.amt) return addNotification('danger', 'Hata', 'Sahip olduğunuzdan fazlasını satamazsınız.'); 

    // Satışın yapıldığı para birimi (USD mi TL mi?)
    let transactionCurrency = exitCurrency; 
    let globalUsdRate = (typeof usdTryRate !== 'undefined' && usdTryRate > 0) ? usdTryRate : 36.50;

    // --- 1. MALİYET HESABI (CRITICAL FIX) ---
    // Varlığın alış maliyetini, satış yaptığımız para birimine çevirelim
    let buyCostPerUnit = parseFloat(ast.buy); // Varlığın orijinal alış fiyatı
    
    // Eğer varlık USD ise ama biz TL satıyorsak -> Maliyeti TL'ye çevir
    if(ast.origin === 'USD' && transactionCurrency === 'TRY') {
        buyCostPerUnit = buyCostPerUnit * globalUsdRate;
    }
    // Eğer varlık TL ise ama biz USD satıyorsak -> Maliyeti USD'ye çevir
    else if(ast.origin === 'TRY' && transactionCurrency === 'USD') {
        buyCostPerUnit = buyCostPerUnit / globalUsdRate;
    }
    
    // --- 2. KÂR/ZARAR HESABI ---
    let totalSaleRevenue = amt * pr;               // Kasaya Girecek Para
    let totalCostBasis = amt * buyCostPerUnit;     // Bu malın bize maliyeti
    let tradePnL = totalSaleRevenue - totalCostBasis; // NET KÂR

    // --- 3. DETAYLARI OLUŞTUR (Analiz Sayfası İçin) ---
    let plPercent = 0;
    if(buyCostPerUnit > 0) {
        plPercent = ((pr - buyCostPerUnit) / buyCostPerUnit) * 100;
    }

    let note = "";
    if(tradePnL > 0) note = `Kâr: %${plPercent.toFixed(2)}`;
    else if(tradePnL < 0) note = `Zarar: %${plPercent.toFixed(2)}`;
    else note = "Başabaş İşlem";

    let detailObj = {
        avgCost: buyCostPerUnit, // Dönüştürülmüş maliyet
        plPercent: plPercent,
        usdRateAtSell: globalUsdRate,
        note: note
    };

    // --- 4. KASAYA İŞLEME (Dönüşümlü) ---
    // Kasaya her zaman uygulamanın ana para birimi (appSettings.currency) cinsinden eklenir
    let cashToAdd = 0;
    let profitToAdd = 0;

    if(appSettings.currency === transactionCurrency) {
        cashToAdd = totalSaleRevenue;
        profitToAdd = tradePnL;
    } else {
        // Eğer uygulama TL ise ama işlem USD ise -> TL'ye çevirip kasaya koy
        if(appSettings.currency === 'TRY' && transactionCurrency === 'USD') {
            cashToAdd = totalSaleRevenue * globalUsdRate;
            profitToAdd = tradePnL * globalUsdRate;
        } 
        // Eğer uygulama USD ise ama işlem TRY ise -> USD'ye çevirip kasaya koy
        else if(appSettings.currency === 'USD' && transactionCurrency === 'TRY') {
            cashToAdd = totalSaleRevenue / globalUsdRate;
            profitToAdd = tradePnL / globalUsdRate;
        }
    }

    cashBalance += cashToAdd; 
    realizedPnL += profitToAdd; 
    
    localStorage.setItem('tm_cash_balance', cashBalance); 
    localStorage.setItem('tm_realized_pnl', realizedPnL); 
    
    // 5. GEÇMİŞE KAYDET
    logHistory('SATIM', ast.name, amt, pr, '', transactionCurrency, tradePnL, detailObj); 
    
    // Portföyden Düş
    ast.amt -= amt; 
    if (ast.amt <= 0) as.splice(i, 1); // Hepsi satıldıysa listeden sil
    localStorage.setItem('myPF_final', JSON.stringify(as)); 
    
    addNotification('success', 'Satış Başarılı', `Kâr/Zarar: ${tradePnL.toFixed(2)} ${transactionCurrency === 'USD' ? '$' : '₺'}`); 
    document.getElementById('sellModal').style.display = 'none'; 
    
    loadPF(true); 
    renderHistory(); 
    loadProfile(); 
}

    function openSimulator(idx) { currentSimAssetIndex = idx; let as = JSON.parse(localStorage.getItem('myPF_final')) || []; let asset = as[idx]; if(!asset) return; document.getElementById('simAssetTitle').innerText = `${asset.name} Simülatörü`; let currentPrice = asset.curr || asset.buy; document.getElementById('simTargetPrice').value = currentPrice.toFixed(2); document.getElementById('simAddPrice').value = currentPrice.toFixed(2); document.getElementById('simRealizePrice').value = currentPrice.toFixed(2); document.querySelectorAll('.sim-result-box').forEach(x => x.style.display = 'none'); document.getElementById('simPercent').value = ""; document.getElementById('simAddAmt').value = ""; document.getElementById('simSellAmt').value = ""; switchSimTab('scenario', document.querySelectorAll('.sim-tab')[0]); document.getElementById('simModal').style.display = 'flex'; }
    function switchSimTab(tabName, btn) { document.querySelectorAll('.sim-content-pane').forEach(p => p.classList.remove('active')); document.getElementById('sim-pane-' + tabName).classList.add('active'); document.querySelectorAll('.sim-tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); }
    function fillSimSell(ratio) { let as = JSON.parse(localStorage.getItem('myPF_final')); let asset = as[currentSimAssetIndex]; if(asset) { document.getElementById('simSellAmt').value = Math.floor(asset.amt * ratio); } }
    function calcSimScenario() { let targetP = parseFloat(document.getElementById('simTargetPrice').value); if(isNaN(targetP)) return; let as = JSON.parse(localStorage.getItem('myPF_final')); let asset = as[currentSimAssetIndex]; let diffPerUnit = targetP - asset.buy; let totalPnL = diffPerUnit * asset.amt; let totalVal = targetP * asset.amt; let percentChange = ((targetP - asset.buy) / asset.buy) * 100; let sym = asset.origin === 'USD' ? '$' : '₺'; document.getElementById('resSimVal').innerText = sym + totalVal.toLocaleString(undefined, {minimumFractionDigits:2}); document.getElementById('resSimDiff').innerText = `%${percentChange.toFixed(2)}`; let pnlEl = document.getElementById('resSimPnL'); pnlEl.innerText = (totalPnL >= 0 ? '+' : '') + sym + totalPnL.toLocaleString(undefined, {minimumFractionDigits:2}); pnlEl.className = totalPnL >= 0 ? 'val-up' : 'val-down'; let box = document.getElementById('simResScenario'); box.style.display = 'block'; box.className = 'sim-result-box ' + (totalPnL >= 0 ? 'profit' : 'loss'); }
    function calcSimScenarioPercent() { let p = parseFloat(document.getElementById('simPercent').value); if(isNaN(p)) return; let as = JSON.parse(localStorage.getItem('myPF_final')); let asset = as[currentSimAssetIndex]; let targetP = asset.buy * (1 + (p/100)); document.getElementById('simTargetPrice').value = targetP.toFixed(2); calcSimScenario(); }
    function calcSimAvg() { let newAmt = parseFloat(document.getElementById('simAddAmt').value); let newPrice = parseFloat(document.getElementById('simAddPrice').value); if(!newAmt || !newPrice) return; let as = JSON.parse(localStorage.getItem('myPF_final')); let asset = as[currentSimAssetIndex]; let oldTotal = asset.amt * asset.buy; let newTotal = newAmt * newPrice; let finalAmt = asset.amt + newAmt; let finalAvg = (oldTotal + newTotal) / finalAmt; let sym = asset.origin === 'USD' ? '$' : '₺'; document.getElementById('resOldAvg').innerText = sym + asset.buy.toFixed(2); document.getElementById('resNewAvg').innerText = sym + finalAvg.toFixed(2); document.getElementById('resTotalCost').innerText = sym + (oldTotal + newTotal).toLocaleString(undefined, {minimumFractionDigits:2}); let box = document.getElementById('simResAvg'); box.style.display = 'block'; box.className = 'sim-result-box'; }
    function calcSimRealize() { let sellAmt = parseFloat(document.getElementById('simSellAmt').value); let sellPrice = parseFloat(document.getElementById('simRealizePrice').value); if(!sellAmt || !sellPrice) return; let as = JSON.parse(localStorage.getItem('myPF_final')); let asset = as[currentSimAssetIndex]; if(sellAmt > asset.amt) { alert("Fazla miktar!"); return; } let cashIn = sellAmt * sellPrice; let profit = (sellPrice - asset.buy) * sellAmt; let remaining = asset.amt - sellAmt; let sym = asset.origin === 'USD' ? '$' : '₺'; document.getElementById('resCashIn').innerText = sym + cashIn.toLocaleString(undefined, {minimumFractionDigits:2}); let pnlEl = document.getElementById('resRealizedPnL'); pnlEl.innerText = (profit >= 0 ? '+' : '') + sym + profit.toLocaleString(undefined, {minimumFractionDigits:2}); pnlEl.className = profit >= 0 ? 'val-up' : 'val-down'; document.getElementById('resLeftAmt').innerText = remaining + " Adet"; let box = document.getElementById('simResRealize'); box.style.display = 'block'; box.className = 'sim-result-box ' + (profit >= 0 ? 'profit' : 'loss'); }
    
    /* --- YENİ GELİŞMİŞ HABER MOTORU --- */
let newsInterval;
let newsCountdown = 60;
let isNewsPaused = false;
let currentNewsQuery = "Ekonomi";

function initNewsSystem() {
    loadNews(currentNewsQuery);
    startNewsTimer();
}

function startNewsTimer() {
    clearInterval(newsInterval);
    newsCountdown = 60;
    updateTimerUI();
    newsInterval = setInterval(() => {
        if (isNewsPaused) return;
        newsCountdown--;
        updateTimerUI();
        if (newsCountdown <= 0) {
            loadNews(currentNewsQuery, true);
            newsCountdown = 60;
        }
    }, 1000);
}

function updateTimerUI() {
    const bar = document.getElementById('refreshBar');
    const txt = document.getElementById('refreshTimer');
    if (bar) bar.style.width = (newsCountdown / 60 * 100) + "%";
    if (txt) txt.innerText = newsCountdown + "s";
}

function toggleAutoRefresh(btn) {
    isNewsPaused = !isNewsPaused;
    const icon = document.getElementById('refreshIcon');
    const badge = document.getElementById('newsStatusBadge');
    if (isNewsPaused) {
        icon.classList.remove('fa-spin');
        btn.style.opacity = "0.5";
        badge.style.background = "var(--text-sub)";
        document.getElementById('newsStatusLabel').innerText = "DURAKLATILDI";
    } else {
        icon.classList.add('fa-spin');
        btn.style.opacity = "1";
        badge.style.background = "var(--success)";
        document.getElementById('newsStatusLabel').innerText = "CANLI YAYIN";
    }
}

/* --- ZENGİNLEŞTİRİLMİŞ FİLTRE FONKSİYONU --- */
/* --- GELİŞMİŞ GLOBAL ARAMA MOTORU (LİSTEDE YOKSA BİLE BULUR) --- */
let globalSearchTimer;

function filterUnifiedList(val) {
    val = val.trim(); // Boşlukları temizle
    const listContainer = document.getElementById('infiniteMarketList');
    
    // 1. ÖNCE MEVCUT LİSTEYİ FİLTRELE (HIZLI SONUÇ)
    // Ekranda zaten varsa anında gösterelim
    const items = listContainer.querySelectorAll('.infinite-item');
    let visibleCount = 0;

    // Önceki "Global Sonuç" kutusu varsa temizle
    const oldGlobal = document.getElementById('global-search-result');
    if (oldGlobal) oldGlobal.remove();

    if (val.length === 0) {
        // Arama kutusu boşsa her şeyi göster
        items.forEach(item => item.style.display = 'flex');
        return;
    }

    items.forEach(item => {
        // Sembolü al (HTML içinden)
        let symElement = item.querySelector('.ii-sym');
        if (symElement) {
            let text = symElement.innerText.toUpperCase();
            if (text.includes(val.toUpperCase())) {
                item.style.display = 'flex';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        }
    });

    // 2. EĞER LİSTEDE YOKSA VEYA AZ SONUÇ VARSA -> GLOBAL ARA
    // (CoinGecko veya Genel Sistemde Ara)
    if (val.length > 2) {
        
        clearTimeout(globalSearchTimer);

        // Kullanıcı yazmayı bitirince (0.5sn sonra) aramayı başlat
        globalSearchTimer = setTimeout(async () => {
            
            // Eğer daha önce eklemediysek, listenin en altına "Global Sonuçlar" kutusu ekle
            let globalBox = document.getElementById('global-search-result');
            if (!globalBox) {
                globalBox = document.createElement('div');
                globalBox.id = 'global-search-result';
                globalBox.style.padding = "10px";
                globalBox.style.marginTop = "10px";
                globalBox.innerHTML = `<div style="text-align:center; color:var(--text-sub); font-size:11px;"><i class="fas fa-circle-notch fa-spin"></i> Global Piyasalar Taranıyor: <b>${val}</b></div>`;
                listContainer.appendChild(globalBox);
            }

            let foundAny = false;

            // A) COINGECKO ARAMASI (Kripto Modundaysak)
            if (currentCategory === 'kripto' && coingeckoApiKey) {
                try {
                    const url = `https://api.coingecko.com/api/v3/search?query=${val}&x_cg_demo_api_key=${coingeckoApiKey}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    if (data.coins && data.coins.length > 0) {
                        let html = `<div style="font-size:10px; font-weight:700; color:var(--accent); margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">KRİPTO SONUÇLARI</div>`;
                        
                        // İlk 5 sonucu göster
                        data.coins.slice(0, 5).forEach(coin => {
                            html += `
                            <div class="infinite-item" onclick="openCoinGeckoDetail('${coin.id}')" style="background:rgba(59, 130, 246, 0.1); border:1px solid rgba(59, 130, 246, 0.2);">
                                <div class="ii-left">
                                    <img src="${coin.thumb}" style="width:24px; height:24px; border-radius:50%; margin-right:10px;">
                                    <div class="ii-info">
                                        <span class="ii-sym">${coin.symbol}</span>
                                        <span class="ii-vol">${coin.name}</span>
                                    </div>
                                </div>
                                <div class="ii-right">
                                    <span class="ii-price" style="font-size:10px; color:var(--text-sub);">Detay <i class="fas fa-chevron-right"></i></span>
                                </div>
                            </div>`;
                        });
                        globalBox.innerHTML = html;
                        foundAny = true;
                    }
                } catch (e) { console.log("CG Search Error"); }
            }

            // B) MANUEL EŞLEŞTİRME (Hisse/Döviz veya CG Bulamazsa)
            // Kullanıcıya "Bunu Görüntüle" seçeneği sunalım. 
            // openMarketDetail fonksiyonu zaten Binance/Yahoo üzerinden bulmaya çalışacaktır.
            if (!foundAny) {
                globalBox.innerHTML = `
                <div style="font-size:10px; font-weight:700; color:var(--gold); margin-bottom:8px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:5px;">PİYASA ARAMASI</div>
                <div class="infinite-item" onclick="openMarketDetail('${val.toUpperCase()}')" style="background:rgba(255,255,255,0.05);">
                    <div class="ii-left">
                        <div style="width:24px; height:24px; background:var(--bg-input); border-radius:6px; display:flex; align-items:center; justify-content:center; margin-right:10px; font-size:10px;">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="ii-info">
                            <span class="ii-sym">${val.toUpperCase()}</span>
                            <span class="ii-vol">Detaylı Görüntüle</span>
                        </div>
                    </div>
                    <div class="ii-right">
                        <span class="ii-price" style="font-size:10px; color:var(--accent);">Git <i class="fas fa-arrow-right"></i></span>
                    </div>
                </div>`;
            }

        }, 600); // 600ms bekle (Debounce)
    }
}



function filterNews(topic, btn) {
    // 1. Görsel Efekt (Butonu aktif yap)
    document.querySelectorAll('.nf-chip').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    
    // Arama kutusunu temizle
    document.getElementById('newsSearchInput').value = "";
    
    // 2. Kategoriye Göre ZENGİN Arama Kelimeleri Belirle
    if (topic === 'GENEL') {
        currentNewsQuery = "GENEL"; // Worker bunu Manşet olarak algılar
    } 
    else if (topic === 'EKONOMİ') {
        // Sadece "Ekonomi" değil, ilgili her şeyi getir
        currentNewsQuery = "Ekonomi OR Finans OR Merkez Bankası OR Enflasyon";
    } 
    else if (topic === 'KRİPTO') {
        currentNewsQuery = "Bitcoin OR Kripto Para OR Ethereum OR Altcoin OR Blockchain";
    } 
    else if (topic === 'BORSA') {
        currentNewsQuery = "Borsa İstanbul OR BIST100 OR Hisse Senedi OR KAP";
    } 
    else if (topic === 'EMTİA') {
        currentNewsQuery = "Altın Fiyatları OR Dolar Kuru OR Gram Altın OR Petrol OR Döviz";
    } 
    else {
        currentNewsQuery = topic;
    }

    // 3. Sayacı sıfırla ve haberleri çek
    newsCountdown = 60; 
    loadNews(currentNewsQuery);
}

function runNewsSearch() {
    const val = document.getElementById('newsSearchInput').value.trim();
    if (val.length < 2) return addNotification('warn', 'Arama', 'Lütfen en az 2 karakter girin.');
    document.querySelectorAll('.nf-chip').forEach(c => c.classList.remove('active'));
    currentNewsQuery = val;
    loadNews(val);
    document.getElementById('newsSearchInput').blur();
}

/* --- GOOGLE NEWS (RSS) - FİNAL SÜRÜM (ARAMA & SEMBOL DESTEKLİ) --- */

// 1. Sayfa Yüklendiğinde
document.addEventListener('DOMContentLoaded', () => {
    // Başlangıçta genel ekonomi haberleri gelsin
    loadNews('Ekonomi Finans Borsa');
});

// 2. Kategori Filtreleme Butonları İçin (Ekonomi, Kripto, Borsa...)
function filterNews(topic, btn) {
    // Görsel olarak butonu aktif yap
    document.querySelectorAll('.nf-chip').forEach(c => c.classList.remove('active'));
    if(btn) btn.classList.add('active');

    // Arama kutusunu temizle
    document.getElementById('newsSearchInput').value = "";

    // Konuya göre Google'da en iyi sonuç veren kelimeleri seç
    let query = topic;
    if(topic === 'GENEL') query = 'Ekonomi Finans Gündem';
    if(topic === 'BORSA') query = 'Borsa İstanbul BIST100 Hisse';
    if(topic === 'KRİPTO') query = 'Bitcoin Kripto Para Altcoin Blockchain';
    if(topic === 'EMTİA') query = 'Altın Fiyatları Petrol Gümüş Döviz';

    loadNews(query);
}

// 3. Arama Çubuğu Fonksiyonu (Sembol ve Kelime Arar)
function runNewsSearch() {
    const input = document.getElementById('newsSearchInput');
    if (!input) return;

    let val = input.value.trim();
    
    // Boşsa uyarı ver
    if (val.length < 2) {
        // Eğer bildirim fonksiyonun varsa kullan, yoksa alert
        if(typeof addNotification === 'function') addNotification('warn', 'Arama', 'Lütfen aranacak kelimeyi girin.');
        return;
    }

    // Mobilde klavyeyi kapat
    input.blur();

    // Filtre butonlarının seçimini kaldır (Özel arama yapıyoruz)
    document.querySelectorAll('.nf-chip').forEach(c => c.classList.remove('active'));
    
    // Google News zaten sembolleri tanır (Örn: "ASELS" yazınca Aselsan haberleri gelir)
    loadNews(val);
}

// 4. Ana Haber Çekme Motoru
async function loadNews(query) {
    const container = document.getElementById('newsTimeline');
    if (!container) return;

    // Yükleniyor Animasyonu
    container.innerHTML = `
        <div style="text-align:center; padding:50px; color:var(--text-sub);">
            <i class="fas fa-circle-notch fa-spin" style="font-size:24px; margin-bottom:10px;"></i><br>
            <strong>"${query}"</strong> Haberleri Taranıyor...
        </div>`;

    try {
        // Google RSS Linki (Son 24 saat, Türkçe, Türkiye)
        // q={query} kısmı hem "Ekonomi" kelimesini hem de "BTC" gibi sembolleri arar.
        const googleRssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}+when:1d&hl=tr-TR&gl=TR&ceid=TR:tr`;
        
        // RSS'i JSON'a çeviren servis
        const apiUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(googleRssUrl)}`;

        const response = await fetch(apiUrl);
        const data = await response.json();

        // İçeriği temizle
        container.innerHTML = '';

        if (data.status === 'ok' && data.items.length > 0) {
            let html = "";
            
            // İlk 20 haberi listele
            data.items.slice(0, 20).forEach((item, index) => {
                
                // Tarih formatı
                const date = new Date(item.pubDate);
                const timeStr = date.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
                
                // Başlık temizliği (Sondaki kaynak ismini ayır)
                let title = item.title;
                let source = "Google News";
                
                if (title.includes(' - ')) {
                    const parts = title.split(' - ');
                    source = parts.pop(); 
                    title = parts.join(' - ');
                }

                // Resim bulmaya çalış
                let imgHtml = `<i class="fas fa-newspaper nim-placeholder-icon"></i>`; 
                const imgMatch = item.description.match(/src="([^"]+)"/);
                if (imgMatch) {
                    imgHtml = `<img src="${imgMatch[1]}" alt="Haber" onerror="this.style.display='none'">`;
                }

                // İlk haber Manşet olsun
                let badgeClass = (index === 0) ? "hot" : "";
                let label = (index === 0) ? '<span style="color:var(--danger); background:rgba(239,68,68,0.15); padding:2px 6px; border-radius:4px; margin-left:8px; font-size:9px;">MANŞET</span>' : '';

                html += `
                <div class="news-item-modern ${badgeClass}">
                    <div class="nim-time">
                        <i class="far fa-clock"></i> ${timeStr} ${label}
                    </div>
                    
                    <div class="nim-card" onclick="window.open('${item.link}', '_blank')">
                        <div class="nim-img-box">
                            ${imgHtml}
                        </div>
                        <div class="nim-content">
                            <div class="nim-title">${title}</div>
                            <div class="nim-source">
                                <i class="fas fa-rss" style="font-size:10px; margin-right:4px;"></i> ${source}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
            
        } else {
            container.innerHTML = `
                <div style="text-align:center; padding:30px; color:var(--text-sub);">
                    "${query}" ile ilgili güncel haber bulunamadı.
                </div>`;
        }

    } catch (error) {
        console.error('Haber Hatası:', error);
        container.innerHTML = `
            <div style="text-align:center; padding:30px; color:var(--danger);">
                Haber kaynağına bağlanılamadı. İnternetinizi kontrol edin.
            </div>`;
    }
}

    function toggleTradeMenu() { const content = document.getElementById('tradeContent'); const chevron = document.getElementById('tradeChevron'); const card = document.getElementById('tradeCard'); if (content.classList.contains('collapsed')) { content.classList.remove('collapsed'); chevron.classList.add('rotated'); card.classList.add('open'); } else { content.classList.add('collapsed'); chevron.classList.remove('rotated'); card.classList.remove('open'); } }
    function toggleAssetDetails(id) { const content = document.getElementById('asset-content-' + id); const chevron = document.getElementById('asset-chevron-' + id); if (content.classList.contains('collapsed')) { content.classList.remove('collapsed'); chevron.classList.add('rotated'); } else { content.classList.add('collapsed'); chevron.classList.remove('rotated'); } }
        /* --- YENİ GELİŞMİŞ BİLDİRİM SİSTEMİ (C KISMI) --- */
    function addNotification(type, title, msg) {
        // 1. Uygulama İçi Kayıt (Eski Yöntem)
        let n = { type: type, title: title, msg: msg, time: new Date().toLocaleTimeString(), read: false };
        notifications.unshift(n);
        if(notifications.length > 50) notifications.pop();
        localStorage.setItem('tm_notifications', JSON.stringify(notifications));
        updateBadge();
        if(document.getElementById('page-notifications') && document.getElementById('page-notifications').classList.contains('active')) renderNotifications();

        // 2. Kategori Tespiti
        let category = 'trade'; // Varsayılan
        if(title.includes('Alarm') || title.includes('HEDEF') || title.includes('DİKKAT')) category = 'price';
        else if(title.includes('Haber')) category = 'news';
        
        // 3. Ayar Kontrolü: Kullanıcı bu kategoriyi kapatmış mı?
        // (Eğer ayar yoksa varsayılan olarak göster)
        if(notifySettings && !notifySettings[category]) return;

        // 4. SES VE TİTREŞİM
        if(notifySettings && notifySettings.sound) playNotificationSound(type);
        if(notifySettings && notifySettings.vibrate && navigator.vibrate) {
            if(type === 'danger') navigator.vibrate([100, 50, 100, 50, 100]); // 3 kere titret (Hata)
            else navigator.vibrate(200); // Tek titret (Normal)
        }

        // 5. BROWSER / TELEFON BİLDİRİMİ (PUSH)
        if ("Notification" in window && Notification.permission === "granted") {
            // Mobilde ikonun düzgün görünmesi için app iconu
            let iconUrl = "https://cdn-icons-png.flaticon.com/512/3429/3429170.png"; 
            if(type === 'danger') iconUrl = "https://cdn-icons-png.flaticon.com/512/190/190406.png"; 

            const notif = new Notification(title, {
                body: msg,
                icon: iconUrl,
                vibrate: (notifySettings && notifySettings.vibrate) ? [200, 100, 200] : []
            });

            // Bildirime tıklayınca uygulamaya odaklan
            notif.onclick = function() {
                window.focus();
                notif.close();
                // Bildirim sayfasına yönlendir (index 3 genelde bildirim sayfasıdır)
                let notifBtn = document.querySelectorAll('.nav-item')[3]; 
                if(notifBtn) switchPage('notifications', notifBtn);
            };
        }
    }

    function renderNotifications(){ let l = document.getElementById('notificationList'); l.innerHTML = ""; if(notifications.length === 0){ l.innerHTML = "<div style='text-align:center; padding:30px; color:var(--text-sub); opacity:0.6;'><i class='fas fa-bell-slash' style='font-size:24px; margin-bottom:10px;'></i><br>Bildirim Yok</div>"; return; } notifications.forEach(n => { let icon = 'info-circle'; let cls = 'n-info'; if(n.type === 'success') { icon = 'check-circle'; cls = 'n-success'; } if(n.type === 'danger') { icon = 'exclamation-circle'; cls = 'n-danger'; } if(n.type === 'warn') { icon = 'bell'; cls = 'n-warn'; } l.innerHTML += `<div class="notif-card ${cls} ${n.read ? '' : 'unread'}"><div class="notif-icon-box"><i class="fas fa-${icon}"></i></div><div class="notif-content"><div class="notif-title">${n.title}</div><div class="notif-msg">${n.msg}</div></div><div class="notif-time">${n.time}</div></div>`; }); notifications.forEach(n => n.read = true); localStorage.setItem('tm_notifications', JSON.stringify(notifications)); updateBadge(); }
    function updateBadge(){ let unread = notifications.filter(n => !n.read).length; let b = document.getElementById('notifBadge'); if(unread > 0){ b.innerText = unread; b.classList.add('active'); } else { b.classList.remove('active'); } }
    function clearNotifications(){ if(confirm("Tüm bildirimler silinsin mi?")){ notifications = []; localStorage.setItem('tm_notifications', JSON.stringify(notifications)); renderNotifications(); updateBadge(); } }
    
    function applyTheme(t){ document.body.setAttribute('data-theme', t); }
    function changeTheme(val){ appSettings.theme = val; localStorage.setItem('tm_settings', JSON.stringify(appSettings)); applyTheme(val); }
    function changeLanguage(val){ appSettings.lang = val; localStorage.setItem('tm_settings', JSON.stringify(appSettings)); applyLang(); }
    function applyLang(){ const t = trans[appSettings.lang]; document.querySelectorAll('[data-lang]').forEach(e => { const key = e.getAttribute('data-lang'); if(t[key]) e.innerText = t[key]; }); }
    function setEntryCurrency(curr) { entryCurrency = curr; let btn = document.getElementById('currencyToggle'); if(btn) { if(curr === 'TRY') { btn.innerText = '₺'; btn.className = 'currency-toggle-btn active-try'; } else { btn.innerText = '$'; btn.className = 'currency-toggle-btn active-usd'; } } calcDca(); calcLiveTotal(); }
    function toggleEntryCurrency() { entryCurrency === 'TRY' ? setEntryCurrency('USD') : setEntryCurrency('TRY'); }
    
        /* --- 1. KISIM: GÜNCELLENMİŞ MARKET PRESETS --- */
    const marketPresets = { 
        'kripto': ['BTC', 'ETH', 'SOL', 'AVAX', 'XRP', 'DOGE', 'PEPE', 'SHIB', 'BNB', 'ADA'], 
        'hisse': ['THYAO.IS', 'ASELS.IS', 'GARAN.IS', 'AKBNK.IS', 'EREGL.IS', 'SASA.IS', 'KCHOL.IS', 'TUPRS.IS', 'SISE.IS', 'BIMAS.IS'], 
        // Yeni Hızlı Motorlar bu anahtarlara ihtiyaç duymadan otomatik liste getirecek, 
        // ancak tanımların burada temiz kalması iyidir.
        'altin': ['ONS', 'GRAM', 'GUMUS'], 
        'doviz': ['USDTRY', 'EURTRY', 'EURUSD', 'GBPTRY'] 
    };

    async function loadMarketTab(category, btn) { currentMarketTab = category; if(btn) { document.querySelectorAll('.m-tab-pro').forEach(b => b.classList.remove('active')); btn.classList.add('active'); } currentRenderId++; const myRenderId = currentRenderId; const container = document.getElementById('marketLiveList'); if(!container) return; container.innerHTML = '<div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>'; let list = marketPresets[category] || []; if(list.length > 0) { let firstRaw = list[0]; let firstTv = ""; if(category==='kripto') firstTv = "BINANCE:" + firstRaw + "USDT"; else if(category==='hisse') firstTv = "BIST:" + firstRaw.replace('.IS',''); else if(category==='altin') firstTv = "TVC:GOLD"; else if(category==='doviz') firstTv = "FX:USDTRY"; renderTradingView(firstTv); selectedMarketSymbol = firstTv; } const promises = list.map(async (sym) => { let dName = sym; if(category === 'hisse') dName = sym.replace('.IS',''); else if(displayNames[sym]) dName = displayNames[sym]; let data = await getPrice(sym); if(currentRenderId !== myRenderId) return ""; let priceTxt = "--"; let changeTxt = "--"; let changeClass = "val-neutral"; if(data.price > 0) { let s = data.origin === 'USD' ? '$' : '₺'; priceTxt = s + data.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}); changeTxt = "%" + data.change.toFixed(2); changeClass = data.change >= 0 ? "val-up" : "val-down"; } let logo = getAssetLogoHtml(dName); let tvSym = sym; if(category==='kripto') tvSym = "BINANCE:" + sym + "USDT"; else if(category==='hisse') tvSym = "BIST:" + sym.replace('.IS',''); else if(category==='altin' && sym==='GC=F') tvSym = "TVC:GOLD"; else if(category==='doviz' && sym==='TRY=X') tvSym = "FX:USDTRY"; else if(category==='doviz' && sym==='EURTRY=X') tvSym = "FX:EURTRY"; let activeClass = (selectedMarketSymbol === tvSym) ? 'active' : ''; return `<div class="market-row-item ${activeClass}" onclick="selectMarketItem('${tvSym}', this)"><div class="m-row-left">${logo}<div class="m-row-info"><span class="m-row-sym">${dName}</span><span class="m-row-name">${data.source || 'Piyasa'}</span></div></div><div class="m-row-right"><span class="m-row-price">${priceTxt}</span><span class="m-row-change ${changeClass}">${changeTxt}</span></div></div>`; }); const results = await Promise.all(promises); if(currentRenderId === myRenderId) { container.innerHTML = results.join(''); } }
    function selectMarketItem(tvSymbol, el) { selectedMarketSymbol = tvSymbol; if(el) { document.querySelectorAll('.market-row-item').forEach(x => x.classList.remove('active')); el.classList.add('active'); } renderTradingView(tvSymbol); }
    function searchInChart() { let val = document.getElementById('chartSearchInput').value.trim().toUpperCase(); if(!val) return; let cleanVal = val.replace('/', '').replace(' ', '').replace('-', ''); let finalSymbol = cleanVal; if(cleanVal.includes(':')) { renderTradingView(cleanVal); return; } if(currentMarketTab === 'kripto') { const quotes = ['USDT', 'TRY', 'BUSD', 'USDC', 'EUR', 'BTC', 'ETH']; const hasQuote = quotes.some(q => cleanVal.endsWith(q)); if(!hasQuote) finalSymbol = cleanVal + 'USDT'; finalSymbol = 'BINANCE:' + finalSymbol; } else if(currentMarketTab === 'hisse') finalSymbol = 'BIST:' + cleanVal; else if(currentMarketTab === 'doviz') finalSymbol = 'FX:' + cleanVal; else if(currentMarketTab === 'altin') { if(cleanVal === 'ALTIN' || cleanVal === 'ONS') finalSymbol = 'TVC:GOLD'; else if(cleanVal === 'GRAM' || cleanVal === 'GRAMALTIN') finalSymbol = 'FX:XAUTRY'; else finalSymbol = 'TVC:' + cleanVal; } renderTradingView(finalSymbol); }
    /* --- GÜNCELLENMİŞ HİBRİT LOGO MOTORU (Kripto Resimli, Diğerleri Kutulu) --- */
function getAssetLogoHtml(symbol) {
    let s = symbol.toUpperCase().trim().replace('.IS','');
    
    // RENK SEÇİMİ (Kutucuklar için lazım)
    let seed = 0;
    for (let i = 0; i < s.length; i++) seed += s.charCodeAt(i);
    const colors = ['#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#6366f1', '#8b5cf6', '#d946ef', '#f43f5e'];
    let color = colors[seed % colors.length];

    // KUTUCUK HTML'i (Hisseler ve Resmi Bulunamayanlar İçin Yedek)
    const boxHtml = `
        <div style="
            width:40px; height:40px; 
            background:${color}20; 
            border:1px solid ${color}60; 
            border-radius:12px; 
            display:flex; align-items:center; justify-content:center; 
            color:${color}; font-weight:900; font-size:12px; 
            letter-spacing:-0.5px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        ">${s.substring(0,3)}</div>`;

    // --- 1. KRİPTO KONTROLÜ ---
    // Eğer USDT içeriyorsa veya bilinen coin listesindeyse veya uzun isimliyse (BABYDOGE gibi)
    const isCrypto = s.includes('USDT') || 
                     ['BTC','ETH','BNB','SOL','XRP','DOGE','ADA','AVAX','SHIB','PEPE','BABYDOGE','FLOKI','FET','ARB','APT'].includes(s) ||
                     (s.length > 5 && !s.includes(' ')); // Genelde uzun semboller coindir

    if (isCrypto) {
        // Sembolü temizle (BTCUSDT -> btc)
        let cleanSym = s.replace('USDT','').toLowerCase();
        
        // Resim çekmeye çalış (Hata verirse kutucuğa döner)
        return `<div class="asset-logo-wrap" style="background:transparent; border:none; width:40px; margin-right:10px;">
            <img src="https://assets.coincap.io/assets/icons/${cleanSym}@2x.png" 
                 style="width:36px; height:36px; border-radius:50%; object-fit:contain;"
                 
onerror="this.outerHTML=\`<div style='width:40px;height:40px;background:${color}20;border:1px solid ${color}60;border-radius:12px;display:flex;align-items:center;justify-content:center;color:${color};font-weight:900;font-size:12px;'>${s.substring(0,3)}</div>\`">
        </div>`;
    }

    // --- 2. HİSSE VE DÖVİZLER (Kutucuk Göster) ---
    return `<div class="asset-logo-wrap" style="background:transparent; border:none; width:40px; margin-right:10px;">
        ${boxHtml}
    </div>`;
}

    function checkPolyInit() { if(polyApiKey) { document.getElementById('polyIndicator').className='poly-status-dot'; testPolygonConnection(); } else { document.getElementById('polyIndicator').className='poly-status-dot idle'; document.getElementById('polyStatusText').innerText="KOD YOK"; } }
    function savePolyKey(val){ polyApiKey=val.trim(); localStorage.setItem('tm_poly_key',polyApiKey); if(polyApiKey==="") checkPolyInit(); else testPolygonConnection(); }
    async function testPolygonConnection() { if(!polyApiKey) return; const ind=document.getElementById('polyIndicator'); const txt=document.getElementById('polyStatusText'); txt.innerText="BAĞLANILIYOR..."; try{ const response=await fetch(`https://api.polygon.io/v2/aggs/ticker/AAPL/prevClose?adjusted=true&apiKey=${polyApiKey}`); if(!response.ok) throw new Error(response.status); const data=await response.json(); if(data.status==="OK" || data.resultsCount>=0){ ind.className='poly-status-dot active'; txt.innerText="AKTİF"; txt.style.color="var(--success)"; } } catch(e){ ind.className='poly-status-dot error'; txt.innerText="HATA"; txt.style.color="var(--danger)"; } }
    async function getHistoricalChange(s){ let data=await getPrice(s); let r=(Math.random()-0.5)*2; return { ...data, daily: data.change, monthly: data.change*5+r, yearly: data.change*10+r }; }
    async function fetchUsdRate(){ try{ let res=await tryBinance('USDTTRY'); if(res) usdTryRate=res.price; else usdTryRate=36.5; } catch{ usdTryRate=36.5; } }
    
    function switchSettingsTab(tab, btn){ document.querySelectorAll('.settings-content').forEach(c => c.classList.remove('active')); document.getElementById('set-' + tab).classList.add('active'); document.querySelectorAll('.s-tab').forEach(t => t.classList.remove('active')); btn.classList.add('active'); }
    function delAsset(i){ if(confirm("Silinsin mi?")){ let as = JSON.parse(localStorage.getItem('myPF_final')); as.splice(i,1); localStorage.setItem('myPF_final', JSON.stringify(as)); loadPF(); addNotification('warn', 'Varlık Silindi', 'Portföyden bir varlık kaldırıldı.'); } }
    function clearAllData(){ if(confirm("Tüm veriler silinsin mi?")){ localStorage.clear(); location.reload(); } }
    function togglePrivacy(){ isPrivacyMode = !isPrivacyMode; loadPF(); }
    function changeBaseCurrency(v){ let oldCurr = appSettings.currency; appSettings.currency = v; if(v !== oldCurr) { if(v === 'USD') cashBalance = cashBalance / usdTryRate; else cashBalance = cashBalance * usdTryRate; localStorage.setItem('tm_cash_balance', cashBalance); } localStorage.setItem('tm_settings',JSON.stringify(appSettings)); loadPF(true); renderHistory(); }
    let wlDebounce; function debouncedWlPreview(val) { clearTimeout(wlDebounce); if(val.length < 2) return; const infoDiv = document.getElementById('wlLiveInfo'); infoDiv.innerText = "Aranıyor..."; wlDebounce = setTimeout(async () => { let res = await getPrice(val); if(res.price > 0) infoDiv.innerHTML = `<span style="color:var(--success)">${val.toUpperCase()}: ${res.price.toFixed(2)}</span>`; else infoDiv.innerText = "Bulunamadı"; }, 600); }
    async function addToWatchlist(){ let s = document.getElementById('wlInput').value.trim().toUpperCase(); if(!s) return; let w = JSON.parse(localStorage.getItem('tm_watchlist')) || []; if(w.includes(s)) { return addNotification('warn', 'Zaten Ekli', 'Bu sembol izleme listesinde var.'); } w.push(s); localStorage.setItem('tm_watchlist', JSON.stringify(w)); document.getElementById('wlInput').value = ""; updateWatchlist(); addNotification('success', 'Eklendi', `${s} izlemeye alındı.`); }
    function removeFromWatchlist(s){ let w = JSON.parse(localStorage.getItem('tm_watchlist')) || []; w = w.filter(i => i !== s); localStorage.setItem('tm_watchlist', JSON.stringify(w)); updateWatchlist(); }
    async function updateWatchlist(){ let wl = JSON.parse(localStorage.getItem('tm_watchlist')) || []; let l = document.getElementById('wlList'); l.innerHTML = ""; if(wl.length === 0) { l.innerHTML = "<div style='text-align:center; padding:20px; color:var(--text-sub)'>Liste boş.</div>"; return; } for(let s of wl){ let r = await getHistoricalChange(s); let priceDisplay = r.price > 0 ? (r.origin === 'USD' ? '$' : '₺') + r.price.toFixed(2) : 'Veri Yok'; let changeDisplay = r.price > 0 ? `%${r.change.toFixed(2)}` : '--'; let color = r.change >= 0 ? '#10b981' : '#ef4444'; let tag = getAssetTag(s); let tagClass = tag.t === 'KRİPTO' ? 'kripto' : (tag.t === 'BORSA' ? 'borsa' : 'doviz'); l.innerHTML += `<div class="wl-card-classic" style="border-left-color: ${color};"><div class="wl-c-header"><div><span class="wl-c-sym">${s}</span><span class="wl-c-tag ${tagClass}">${tag.t}</span></div><div class="wl-c-price-box"><span class="wl-c-price">${priceDisplay}</span><span class="wl-c-change" style="color:${color}">${changeDisplay}</span></div></div><div class="wl-c-stats"><div class="wl-c-stat-item"><span class="wl-c-lbl">GÜNLÜK</span><span class="wl-c-val" style="color:${color}">${(r.daily).toFixed(2)}%</span></div><div class="wl-c-stat-item"><span class="wl-c-lbl">AYLIK</span><span class="wl-c-val" style="color:${color}">${(r.monthly).toFixed(2)}%</span></div><div class="wl-c-stat-item"><span class="wl-c-lbl">YILLIK</span><span class="wl-c-val" style="color:${color}">${(r.yearly).toFixed(2)}%</span></div></div><button class="wl-c-del" onclick="removeFromWatchlist('${s}')"><i class="fas fa-trash"></i></button></div>`; } }
    function getAssetTag(s) { if(['ALTIN','GOLD','GRAM'].includes(s)) return {t:'EMTİA'}; if(s.includes('USDT') || (!s.includes('.') && s.length <= 5)) return {t:'KRİPTO'}; if(['USD','EUR','GBP'].includes(s)) return {t:'DÖVİZ'}; return {t:'BORSA'}; }
    function calcDca(){ let s=document.getElementById('addSymbol').value.toUpperCase(); let a=parseFloat(document.getElementById('addAmount').value); let p=parseFloat(document.getElementById('addBuyPrice').value); if(s&&a&&p){ let as=JSON.parse(localStorage.getItem('myPF_final'))||[]; let ex=as.find(i=>i.name===s); if(ex){ let n=((ex.amt*ex.buy)+(a*p))/(ex.amt+a); document.getElementById('dcaPreview').style.display='block'; document.getElementById('dcaText').innerHTML=`Eski: ${ex.buy.toFixed(2)} -> <span class="dca-val">Yeni: ${n.toFixed(2)}</span>`; } else {document.getElementById('dcaPreview').style.display='none';} } calcLiveTotal(); }
    function closeModal(id){document.getElementById(id).style.display='none';} function openModal(id){document.getElementById(id).style.display='flex';}
    function editNote(i){ let as=JSON.parse(localStorage.getItem('myPF_final')); let n=prompt("Not:",as[i].note||""); if(n!==null){as[i].note=n; localStorage.setItem('myPF_final',JSON.stringify(as)); loadPF();} }
    function downloadBackup(){ const d=localStorage.getItem('myPF_final'); const b=new Blob([d],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='yedek.json'; a.click(); }
    function uploadBackup(i){ const f=i.files[0]; const r=new FileReader(); r.onload=function(e){localStorage.setItem('myPF_final',e.target.result); location.reload();}; r.readAsText(f); }
    function exportExcel(){const as=JSON.parse(localStorage.getItem('myPF_final'))||[];let c="Sembol,Adet,Maliyet\n";as.forEach(r=>{c+=`${r.name},${r.amt},${r.buy}\n`});const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURI(c);a.download='portfoy.csv';a.click();}
    function loadProfile() { document.getElementById('displayProfileName').innerText = userProfile.name; document.getElementById('profileNameInput').value = userProfile.name; document.getElementById('displayProfileBio').innerText = userProfile.bio; document.getElementById('profileBioInput').value = userProfile.bio; document.getElementById('profileJoinDate').innerText = userProfile.joinDate; document.getElementById('profileTradeCount').innerText = tradeHistory.length; if(userProfile.img) document.getElementById('displayProfileImg').src = userProfile.img; }
    function saveProfileData() { let name = document.getElementById('profileNameInput').value; let bio = document.getElementById('profileBioInput').value; if(name) userProfile.name = name; if(bio) userProfile.bio = bio; localStorage.setItem('tm_user_profile', JSON.stringify(userProfile)); loadProfile(); addNotification('success', 'Profil', 'Bilgileriniz güncellendi.'); }
    function uploadProfileImg(input) { if (input.files && input.files[0]) { var reader = new FileReader(); reader.onload = function (e) { try { userProfile.img = e.target.result; localStorage.setItem('tm_user_profile', JSON.stringify(userProfile)); document.getElementById('displayProfileImg').src = userProfile.img; addNotification('success', 'Fotoğraf', 'Profil fotoğrafı yüklendi.'); } catch (error) { addNotification('danger', 'Hata', 'Fotoğraf boyutu çok büyük!'); } }; reader.readAsDataURL(input.files[0]); } }
        function switchMarketMode(mode, btn){ 
        document.querySelectorAll('.ms-btn').forEach(b => b.classList.remove('active')); 
        btn.classList.add('active'); 
        document.querySelectorAll('.market-view-section').forEach(s => s.classList.remove('active')); 
        document.getElementById('mv-'+mode).classList.add('active'); 
        if(mode==='watchlist') updateWatchlist(); 
        // YENİ FONKSİYONU ÇAĞIRIYORUZ:
        if(mode==='main') { setTimeout(() => { loadMarketCategory(currentCategory, null); }, 50); } 
    }

    function renderTradingView(symbol) { let container = document.getElementById('tradingview_container'); if(container) { container.innerHTML = ""; new TradingView.widget({ "autosize": true, "symbol": symbol, "interval": "D", "timezone": "Etc/UTC", "theme": "dark", "style": "1", "locale": "tr", "toolbar_bg": "#f1f3f6", "enable_publishing": false, "hide_top_toolbar": true, "container_id": "tradingview_container" }); } }

    initApp();
    /* --- PARÇACIK AĞI ANİMASYONU (Final Versiyon) --- */
function initBackgroundAnimation() {
    const canvas = document.getElementById('bg-canvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    let particles = [];
    
    // Tema renkleri (RGB Formatında)
    const themeColors = {
        'ocean': '59, 130, 246', // Mavi
        'purple': '139, 92, 246', // Mor
        'dark': '255, 255, 255'   // Beyaz
    };

    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    }
    
    class Particle {
        constructor() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            // Hızları çok hafif artırdım, daha akıcı görünsün
            this.vx = (Math.random() - 0.5) * 0.8; 
            this.vy = (Math.random() - 0.5) * 0.8;
            this.size = Math.random() * 2 + 1;
        }
        
        update() {
            this.x += this.vx;
            this.y += this.vy;
            
            // Ekrandan çıkarsa karşıdan geri girsin (Sonsuz döngü)
            if (this.x < 0) this.x = width;
            if (this.x > width) this.x = 0;
            if (this.y < 0) this.y = height;
            if (this.y > height) this.y = 0;
        }
        
        draw(rgb) {
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(${rgb}, 0.6)`; // Noktalar biraz daha belirgin
            ctx.fill();
        }
    }

    function initParticles() {
        particles = [];
        // Yoğunluk ayarı: Ekran genişliğine göre dinamik sayı
        // Eskiden width/10 idi, şimdi width/9 yaptık (biraz daha fazla nokta)
        const particleCount = Math.floor(width / 9); 
        for (let i = 0; i < particleCount; i++) {
            particles.push(new Particle());
        }
    }

    function animate() {
        ctx.clearRect(0, 0, width, height);
        
        let currentTheme = appSettings.theme || 'ocean';
        let rgb = themeColors[currentTheme] || themeColors['ocean'];

        particles.forEach((p, index) => {
            p.update();
            p.draw(rgb);
            
            // Ağ bağlantılarını çiz
            for (let j = index + 1; j < particles.length; j++) {
                const p2 = particles[j];
                const dx = p.x - p2.x;
                const dy = p.y - p2.y;
                const distance = Math.sqrt(dx*dx + dy*dy);
                
                // Bağlantı mesafesi: 110px (Eskiden 100'dü, ağlar daha kolay oluşacak)
                if (distance < 110) {
                    ctx.beginPath();
                    // Uzaklığa göre şeffaflık (Yakınsa koyu, uzaksa silik)
                    ctx.strokeStyle = `rgba(${rgb}, ${0.15 - distance/1000})`; 
                    ctx.lineWidth = 0.6;
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p2.x, p2.y);
                    ctx.stroke();
                }
            }
        });
        
        requestAnimationFrame(animate);
    }

    window.addEventListener('resize', () => { resize(); initParticles(); });
    resize();
    initParticles();
    animate();
}

initBackgroundAnimation();

/* --- MANUEL GERİ BUTONU MANTIĞI --- */

// 1. Ana Sayfaya Dönme Fonksiyonu
function goBackHome() {
    // Alttaki menüden ilk sıradakini (Cüzdan) seçmiş gibi davran
    switchPage('portfolio', document.querySelectorAll('.nav-item')[0]);
}

// 2. Mevcut Sayfa Değiştirme Fonksiyonunu Güncelle
// (Eski fonksiyonu saklayıp üzerine özellik ekliyoruz)
const oldSwitchPage = switchPage;

switchPage = function(p, btn) {
    // Orijinal geçiş işlemini yap
    oldSwitchPage(p, btn);
    
    // Buton kontrolü yap
    const backBtn = document.getElementById('manualBackBtn');
    if(backBtn) {
        if(p === 'portfolio') {
            // Ana sayfadaysak butonu gizle
            backBtn.style.display = 'none';
        } else {
            // Diğer sayfalardaysak butonu göster (flex yaparak ortalıyoruz)
            backBtn.style.display = 'flex';
        }
    }
};

/* --- YENİ INFINITE SCROLL & LIVE MARKET MOTORU --- */

// Genişletilmiş BIST Listesi (Infinite Scroll hissi vermek için)
const bistExtended = [
    'THYAO','GARAN','AKBNK','ASELS','EREGL','SASA','KCHOL','SISE','BIMAS','TUPRS',
    'YKBNK','ISCTR','FROTO','EKGYO','PETKM','HALKB','VAKBN','TCELL','KOZAL','ASTOR',
    'ENKAI','ARCLK','TOASO','HEKTS','ODAS','ALARK','TTKOM','MGROS','GUBRF','OYAKC',
    'PGSUS','SAHOL','SOKM','KONTR','EUPWR','SMRTG','GESAN','CANTE','ISGYO','DOHOL',
    'VESTL','TKFEN','ZOREN','KRDMD','TSKB','SKBNK','QUAGR','BERA','MAVI','CIMSA'
];

let marketDataCache = []; // Tüm çekilen veriyi tutar
let displayedData = [];   // Ekranda o an gösterilen veri
let currentCategory = 'kripto';
let currentSortType = 'vol';
let currentPage = 1;
const itemsPerPage = 20;
let isMarketLoading = false;

// 1. Kategori Değiştirme
function loadMarketCategory(cat, btn) {
    if(btn) {
        document.querySelectorAll('.m-tab-pro').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    currentCategory = cat;
    currentPage = 1;
    marketDataCache = [];
    document.getElementById('infiniteMarketList').innerHTML = '';
    
    // Kategoriye göre veri çekme stratejisi
    fetchMarketData();
}

// 2. Sıralama Değiştirme
function sortMarketData(type, btn) {
    if(btn) {
        document.querySelectorAll('.mf-chip').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    currentSortType = type;
    currentPage = 1;
    
    // Mevcut cache'i sırala ve yeniden render et
    processAndRenderData();
}

/* --- DÜZELTİLMİŞ FETCH MARKET DATA --- */
async function fetchMarketData() {
    const loader = document.getElementById('marketLoader');
    if(loader) loader.classList.add('active');
    isMarketLoading = true;

    try {
        // --- SENARYO 1: KRİPTO (COINGECKO) ---
        if(currentCategory === 'kripto') {
            if (coingeckoApiKey) {
                // Sayfa başına 50 coin çekelim (Daha akıcı olur)
                const fetchLimit = 50; 
                const url = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=${fetchLimit}&page=${currentPage}&sparkline=false&x_cg_demo_api_key=${coingeckoApiKey}`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if(Array.isArray(data) && data.length > 0) {
                    const cgData = data.map(d => ({
                        symbol: d.symbol.toUpperCase(),
                        name: d.name,
                        price: d.current_price,
                        change: d.price_change_percentage_24h,
                        vol: d.total_volume,
                        image: d.image,
                        source: 'RANK #' + d.market_cap_rank,
                        id: d.id // ID bilgisini de saklayalım (Çakışma kontrolü için)
                    }));

                    // --- KRİTİK DÜZELTME: DUPLICATE (TEKRAR) KONTROLÜ ---
                    // Sadece marketDataCache içinde OLMAYAN yenileri al
                    const uniqueNewItems = cgData.filter(newItem => 
                        !marketDataCache.some(existing => existing.symbol === newItem.symbol)
                    );

                    if(currentPage === 1) {
                        marketDataCache = uniqueNewItems;
                    } else {
                        marketDataCache = [...marketDataCache, ...uniqueNewItems];
                    }

                    // Sadece yeni gelenleri render et
                    processAndRenderData(uniqueNewItems); 
                } else {
                    // Veri bittiyse loader'ı gizle
                    isMarketLoading = false; 
                    if(loader) loader.classList.remove('active');
                    return;
                }
            }
        } 
        
        // --- SENARYO 2: HİSSE (BIST) ---
        else if(currentCategory === 'hisse') {
            if(currentPage === 1) { // Sadece ilk yüklemede oluştur
                marketDataCache = bistExtended.map(sym => ({
                    symbol: sym, price: 0, change: 0, vol: 0, source: 'BIST', image: null
                }));
                updateBistPrices();
                processAndRenderData(marketDataCache); // Hepsini bas
            }
        } 
        
        // --- SENARYO 3 & 4: DÖVİZ & ALTIN ---
        else if(currentCategory === 'doviz' || currentCategory === 'altin') {
            if(currentPage === 1) {
                if(currentCategory === 'doviz') marketDataCache = await fetchFastForex();
                else marketDataCache = await fetchFastGold();
                
                processAndRenderData(marketDataCache);
            }
        }

    } catch (error) {
        console.error("Veri hatası:", error);
    } finally {
        isMarketLoading = false;
        if(loader) loader.classList.remove('active');
    }
}

// 4. BIST ve Diğerleri İçin Fiyat Güncelleme (Arka Planda)
async function updateBistPrices() {
    for(let item of marketDataCache) {
        // Hızlı sonuç için mevcut getPrice fonksiyonunu kullan
        let s = item.symbol.includes('=') ? item.symbol : item.symbol + '.IS';
        getPrice(s).then(res => {
            if(res && res.price > 0) {
                item.price = res.price;
                item.change = res.change;
                // Değişim olduğunda ilgili DOM elementini güncelle (Live effect)
                updateDomItem(item);
            }
        });
        await new Promise(r => setTimeout(r, 100)); // API limitine takılmamak için gecikme
    }
}

/* --- DÜZELTİLMİŞ RENDER SİSTEMİ --- */
function processAndRenderData(itemsToRender = []) {
    const listEl = document.getElementById('infiniteMarketList');
    
    // Eğer Sayfa 1 ise veya itemsToRender boş gelirse (sıralama değişimi gibi) listeyi temizle
    if(currentPage === 1 && itemsToRender.length === 0) {
        listEl.innerHTML = '';
        itemsToRender = marketDataCache; // Cache'deki her şeyi bas
    }
    
    // Eğer itemsToRender parametresi dolu geldiyse (Sayfa 2, 3...) sadece onları bas
    if(itemsToRender.length > 0) {
        renderSpecificBatch(itemsToRender);
    }
}

// Yeni Render Fonksiyonu (Batch Rendering)
function renderSpecificBatch(batch) {
    const listEl = document.getElementById('infiniteMarketList');
    
    // Mevcut eleman sayısını al (Sıralama numarası vermek için)
    let startIndex = listEl.children.length + 1;

    if(batch.length === 0 && currentPage === 1) {
        listEl.innerHTML = "<div style='text-align:center; padding:30px; color:var(--text-sub); opacity:0.6;'><i class='fas fa-search' style='font-size:24px; margin-bottom:10px;'></i><br>Veri bulunamadı.</div>";
        return;
    }

    let html = "";
    batch.forEach((item, idx) => {
        let globalIdx = startIndex + idx;
        let pStr = "--";
        
        if (item.price !== undefined && item.price !== null) {
            if (currentCategory === 'altin') {
                if (item.symbol.includes('ONS')) pStr = '$' + item.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
                else pStr = '₺' + item.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            } 
            else if (currentCategory === 'kripto') {
                // Kripto fiyat formatlaması (küçük coinler için hassas)
                if(item.price < 1) pStr = '$' + item.price.toFixed(6);
                else pStr = '$' + item.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            } 
            else {
                pStr = '₺' + item.price.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
            }
        }

        let isUp = item.change >= 0;
        let cClass = isUp ? 'bg-up' : 'bg-down';
        let cIcon = isUp ? '<i class="fas fa-caret-up"></i>' : '<i class="fas fa-caret-down"></i>';
        let cStr = item.change !== undefined ? `${cIcon}%${Math.abs(item.change).toFixed(2)}` : "--";
        
        let logo = "";
        if (item.image) {
            logo = `<div class="asset-logo-wrap" style="background:transparent; border:none; width:32px; height:32px;"><img src="${item.image}" class="asset-logo-img"></div>`;
        } else {
            logo = getAssetLogoHtml(item.symbol);
        }

        let dName = item.symbol;
        if(dName === 'GC=F') dName = 'ONS ALTIN';
        if(dName === 'TRY=X') dName = 'USD/TRY';

        let rankClass = '';
        if(globalIdx === 1) rankClass = 'rank-gold';
        else if(globalIdx === 2) rankClass = 'rank-silver';
        else if(globalIdx === 3) rankClass = 'rank-bronze';

        let volStr = item.source || '';
        if(currentCategory === 'kripto' && item.vol > 0) {
            if(item.vol > 1000000000) volStr = (item.vol/1000000000).toFixed(1) + 'Md Hacim';
            else if(item.vol > 1000000) volStr = (item.vol/1000000).toFixed(1) + 'M Hacim';
        }

        // Benzersiz ID oluştur (Tekrarı önlemek için sembolü kullan)
        let uniqueId = `m_item_${item.symbol.replace(/[^a-zA-Z0-9]/g, '')}`;

        html += `
        <div class="infinite-item" id="${uniqueId}" onclick="openMarketDetail('${item.symbol}')">
            <div class="ii-left">
                <div class="ii-rank ${rankClass}">${globalIdx}</div>
                ${logo}
                <div class="ii-info">
                    <span class="ii-sym">${dName}</span>
                    <span class="ii-vol">${volStr}</span>
                </div>
            </div>
            <div class="ii-right">
                <span class="ii-price">${pStr}</span>
                <span class="ii-change ${cClass}">${cStr}</span>
            </div>
        </div>`;
    });

    listEl.insertAdjacentHTML('beforeend', html);
}

/* --- DÜZELTİLMİŞ SCROLL LISTENER (3. ADIM - FİNAL) --- */
// 1. Önce mevcut bir container varsa onu değişkene alalım, yoksa işlem yapmayalım.
const existingListContainer = document.getElementById('infiniteMarketList');

if (existingListContainer) {
    // Eski listener'ları temizlemek için klonlama yöntemi
    const newContainer = existingListContainer.cloneNode(true);
    existingListContainer.parentNode.replaceChild(newContainer, existingListContainer);

    // Yeni Scroll Listener'ı ekle
    newContainer.addEventListener('scroll', function() {
        // Listenin sonuna 150px kala tetikle
        if (this.scrollTop + this.clientHeight >= this.scrollHeight - 150) {
            
            // Zaten yükleme yapılıyorsa dur
            if (isMarketLoading) return;

            // Sadece Kripto kategorisinde ve API Key varsa çalıştır
            if (currentCategory === 'kripto' && coingeckoApiKey) {
                isMarketLoading = true;
                currentPage++; 
                fetchMarketData(); 
            }
        }
    });
}




/* --- GÜNCELLENMİŞ FORMAT PRICE FONKSİYONU --- */
function formatPrice(p, cat) {
    // 1. Kripto ise Dolar
    if(cat === 'kripto') return '$' + p.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    
    // 2. Altın ise Kontrol Et
    if(cat === 'altin') {
        // Eğer global ONS ise DOLAR ($), değilse (Gram, Çeyrek vb.) TL (₺) göster
        // Not: 'ONS' kelimesini fonksiyondan gelen symbol içinde arıyoruz.
        // Ancak burada p (fiyat) ve cat (kategori) geliyor. Symbol'ü doğrudan parametre olarak almıyoruz.
        // Hızlı çözüm: ONS fiyatı genelde 2000-3000 arasıdır, Gram 2000-3000 arasıdır karışabilir.
        // EN SAĞLAMI: Bu fonksiyonu çağıran yeri düzeltmektir ama 
        // Basit Hack: ONS Altın haricindekileri TL yapalım.
        
        // EĞER ÇAĞIRAN YERİ DEĞİŞTİREMİYORSAK ŞÖYLE YAPALIM:
        // Bu fonksiyonu çağıran renderNextBatch içinde küçük bir düzeltme yapacağız.
        // Ama şimdilik genel kural:
        // Eğer fiyat TL bazındaysa (Gram, Çeyrek) formatlayalım.
        // Bunu burada ayırt etmek zor olduğu için 3. ADIMI MUTLAKA YAPINIZ.
        return '$' + p.toLocaleString(); // Geçici, 3. Adımı uygulayın.
    }
    
    // 3. Diğerleri (Hisse, Döviz) TL
    return '₺' + p.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
}


// Yardımcı: Tekil DOM Güncelleme (BIST Live Effect için)
function updateDomItem(item) {
    let uniqueId = `m_item_${item.symbol.replace(/[^a-zA-Z0-9]/g, '')}`;
    let el = document.getElementById(uniqueId);
    if(el) {
        let pEl = el.querySelector('.ii-price');
        let cEl = el.querySelector('.ii-change');
        
        if(pEl) pEl.innerText = formatPrice(item.price, currentCategory);
        if(cEl) {
            cEl.innerText = `%${item.change.toFixed(2)}`;
            cEl.className = `ii-change ${item.change >= 0 ? 'bg-up' : 'bg-down'}`;
        }
    }
}

// Liste elemanına tıklayınca ne olsun? (Şimdilik sembolü kopyalasın veya TradingView açsın)
function openMarketDetail(sym) {
    // İstersen burada modal açabilirsin. Şimdilik panoya kopyalayalım
    // veya mevcut grafiği açmak istersen eski fonksiyonu çağırabilirsin.
    addNotification('info', 'Seçildi', `${sym} detayları hazırlanıyor...`);
}

let currentDetailSymbol = ""; // O an incelenen sembolü tutar

// 1. Modalı Açan Fonksiyon
function openMarketDetail(rawSymbol) {
    currentDetailSymbol = rawSymbol; // Sembolü hafızaya al (Örn: BTC, THYAO)
    
    // Başlığı güncelle
    let displayName = rawSymbol;
    if(rawSymbol === 'GC=F') displayName = 'ONS ALTIN';
    else if(rawSymbol === 'TRY=X') displayName = 'USD/TRY';
    
    document.getElementById('mdTitle').innerHTML = getAssetLogoHtml(rawSymbol) + " " + displayName;

    // Modalı göster
    document.getElementById('marketDetailModal').style.display = 'flex';

    // TradingView Grafiğini Oluştur
    let tvSymbol = rawSymbol;
    
    // Kategoriye göre TradingView sembolünü düzelt
    if(currentCategory === 'kripto') {
        tvSymbol = "BINANCE:" + rawSymbol + "USDT";
    } else if(currentCategory === 'hisse') {
        tvSymbol = "BIST:" + rawSymbol.replace('.IS', '');
    } else if(currentCategory === 'altin') {
        if(rawSymbol === 'GC=F') tvSymbol = "TVC:GOLD";
        else if(rawSymbol === 'SI=F') tvSymbol = "TVC:SILVER";
    } else if(currentCategory === 'doviz') {
        if(rawSymbol === 'TRY=X') tvSymbol = "FX:USDTRY";
        else if(rawSymbol === 'EURTRY=X') tvSymbol = "FX:EURTRY";
    }

    // Grafiği bas
    new TradingView.widget({
        "autosize": true,
        "symbol": tvSymbol,
        "interval": "D",
        "timezone": "Etc/UTC",
        "theme": "dark",
        "style": "1",
        "locale": "tr",
        "toolbar_bg": "#f1f3f6",
        "enable_publishing": false,
        "hide_top_toolbar": true, // Mobilde yer kaplamasın
        "hide_legend": false,
        "save_image": false,
        "container_id": "mdChartContainer"
    });
}

// 2. Modalı Kapatan Fonksiyon
function closeMarketDetail() {
    document.getElementById('marketDetailModal').style.display = 'none';
    document.getElementById('mdChartContainer').innerHTML = ""; // Grafiği temizle (Performans için)
}

/* --- GÜNCELLENMİŞ ALIM BUTONU AKSİYONU --- */
function actionBuyFromMarket() {
    // 1. Modalı Kapat
    closeMarketDetail(); 
    
    // 2. Cüzdan Sayfasına Git
    switchPage('portfolio', document.querySelectorAll('.nav-item')[0]);
    
    // 3. "Hızlı İşlem" Menüsü Kapalıysa Zorla Aç
    const content = document.getElementById('tradeContent');
    const chevron = document.getElementById('tradeChevron');
    const card = document.getElementById('tradeCard');
    
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        chevron.classList.add('rotated');
        card.classList.add('open');
    }

    // 4. Sembolü Kutuya Yaz (Değişken ismi düzeltildi: currentMdSymbol)
    const input = document.getElementById('addSymbol');
    if(currentMdSymbol) {
        // Eğer sembol 'BINANCE:BTCUSDT' gibi gelirse temizle, sadece 'BTC' yaz
        let cleanSym = currentMdSymbol.replace('BINANCE:','').replace('BIST:','').replace('USDT','').replace('.IS','');
        input.value = cleanSym;
        
        // 5. Fiyatı Getir (Simülasyon)
        debouncedPreview(cleanSym); 
    }
    
    // 6. Kullanıcı direkt miktar girebilsin diye oraya odaklan
    setTimeout(() => {
        document.getElementById('addAmount').focus();
    }, 300);
}

/* --- YENİ DETAY MODAL JS MOTORU (DÜZELTİLMİŞ) --- */

let currentMdSymbol = ""; // Global değişken

function switchMdTab(tab, btn) {
    document.querySelectorAll('.md-content').forEach(c => c.classList.remove('active'));
    document.getElementById('md-tab-' + tab).classList.add('active');
    document.querySelectorAll('.md-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
}

// FORMAT VOLUME FONKSİYONU
function formatVolume(val, sym) {
    if(!val) return "--";
    if(val > 1000000000) return sym + (val/1000000000).toFixed(2) + " Mr";
    if(val > 1000000) return sym + (val/1000000).toFixed(2) + " M";
    if(val > 1000) return sym + (val/1000).toFixed(2) + " K";
    return sym + val.toFixed(0);
}

/* --- AKILLI GRAFİK MOTORU (DÜZELTİLMİŞ) --- */
function initMdChart(rawSymbol) {
    let s = rawSymbol.toUpperCase().trim();
    let tvSymbol = s;

    // 1. KATEGORİYE GÖRE SEMBOL FORMATI
    if(currentCategory === 'kripto') {
        // Temizlik: İçinde BINANCE, USDT vs varsa temizle, saf ismi al (örn: BTC)
        let clean = s.replace('BINANCE:', '').replace('USDT', '').trim();
        
        // ÖZEL DURUM: Sadece Majör Coinleri Binance'e Zorla (Garantili Veri İçin)
        const majorCoins = ['BTC', 'ETH', 'BNB', 'SOL', 'XRP', 'ADA', 'AVAX', 'DOGE', 'TRX', 'DOT', 'MATIC', 'SHIB', 'LTC'];
        
        if(majorCoins.includes(clean)) {
            tvSymbol = "BINANCE:" + clean + "USDT";
        } else {
            // DİĞERLERİ: Binance zorlamasını kaldır! 
            // Sadece "PEPEUSDT" gönderiyoruz, TradingView en uygun borsayı (OKX, GATE, BYBIT) kendi seçsin.
            tvSymbol = clean + "USDT";
        }
    }
    else if(currentCategory === 'hisse') {
        tvSymbol = "BIST:" + s.replace('.IS', '');
    }
    else if(currentCategory === 'altin') {
        if(s.includes('ONS') || s === 'GOLD' || s === 'XAUUSD' || s === 'GC=F') {
            tvSymbol = "TVC:GOLD"; 
        } 
        else if(s.includes('GÜMÜŞ') || s.includes('SILVER')) {
            tvSymbol = "TVC:SILVER";
        }
        else {
            // Gram altın vb için Dolar/TL grafiği daha mantıklı referanstır
            tvSymbol = "FX:USDTRY"; 
        }
    }
    else if(currentCategory === 'doviz') {
        let cleanFx = s.replace('/','').replace('=X','');
        // Frankfurther API'den gelen veriler (EURUSD, USDTRY) düzgündür
        if(cleanFx.length === 6) tvSymbol = "FX:" + cleanFx;
        else tvSymbol = "FX:USDTRY";
    }

    // 2. GRAFİĞİ ÇİZ
    const container = document.getElementById('mdChartContainer');
    if(container) container.innerHTML = "";

    new TradingView.widget({
        "autosize": true,
        "symbol": tvSymbol,
        "interval": "D",
        "timezone": "Etc/UTC",
        "theme": "dark",
        "style": "1",
        "locale": "tr",
        "toolbar_bg": "#f1f3f6",
        "enable_publishing": false,
        "hide_top_toolbar": false, 
        "hide_legend": false,
        "save_image": false,
        "container_id": "mdChartContainer"
    });
}

// DETAYLARI EKRANA BASAN FONKSİYON
function renderMdUI(d, title) {
    let sym = (currentCategory === 'kripto' || currentCategory === 'altin') ? '$' : '₺';
    
    document.getElementById('mdSymbolTitle').innerText = title;
    document.getElementById('mdBigPrice').innerText = sym + d.price.toLocaleString(undefined, {minimumFractionDigits:2});
    
    let pill = document.getElementById('mdChangePill');
    let hero = document.getElementById('mdHero');
    
    if(d.change >= 0) {
        pill.innerText = `▲ %${d.change.toFixed(2)}`;
        pill.style.background = 'rgba(16, 185, 129, 0.2)';
        pill.style.color = '#10b981';
        hero.className = 'md-header-hero up';
    } else {
        pill.innerText = `▼ %${d.change.toFixed(2)}`;
        pill.style.background = 'rgba(239, 68, 68, 0.2)';
        pill.style.color = '#ef4444';
        hero.className = 'md-header-hero down';
    }

    let rangePercent = 50;
    if(d.high > d.low) {
        rangePercent = ((d.price - d.low) / (d.high - d.low)) * 100;
    }
    rangePercent = Math.max(0, Math.min(100, rangePercent));
    
    document.getElementById('mdRangeDot').style.left = `${rangePercent}%`;
    document.getElementById('mdLow').innerText = sym + d.low.toLocaleString();
    document.getElementById('mdHigh').innerText = sym + d.high.toLocaleString();

    document.getElementById('mdVol').innerText = formatVolume(d.vol, sym);
    document.getElementById('mdVwap').innerText = sym + d.vwap.toLocaleString(undefined, {maximumFractionDigits:2});
    document.getElementById('mdType').innerText = currentCategory.toUpperCase();

    let disclaimer = document.getElementById('mdDisclaimer');
    if(disclaimer) {
        if(currentCategory === 'hisse' || currentCategory === 'altin' || currentCategory === 'doviz') {
            disclaimer.innerHTML = '<i class="fas fa-clock"></i> Yasalar gereği bu veriler 15 dakika gecikmeli olabilir.';
            disclaimer.style.color = '#f59e0b';
            disclaimer.style.opacity = '1';
        } else {
            disclaimer.innerHTML = '<i class="fas fa-info-circle"></i> Veriler anlık piyasa verisidir.';
            disclaimer.style.color = 'var(--text-sub)';
            disclaimer.style.opacity = '0.7';
        }
    }

    let myCash = cashBalance;
    let maxBuy = d.price > 0 ? (myCash / d.price) : 0;
    let balanceSym = appSettings.currency === 'TRY' ? '₺' : '$';
    
    document.getElementById('mdUserBalance').innerText = balanceSym + myCash.toLocaleString();
    document.getElementById('mdMaxBuy').innerText = maxBuy.toFixed(4) + " Adet";
}

// ANA MARKET DETAY FONKSİYONU
async function openMarketDetail(rawSymbol) {
    currentMdSymbol = rawSymbol; 
    
    document.getElementById('marketDetailModal').style.display = 'flex';
    document.getElementById('mdSymbolTitle').innerText = rawSymbol;
    document.getElementById('mdBigPrice').innerText = "Yükleniyor...";
    
    
    let w = JSON.parse(localStorage.getItem('tm_watchlist')) || [];
    let icon = document.getElementById('mdWatchIcon');
    if(w.includes(rawSymbol)) icon.style.color = "#f59e0b"; 
    else icon.style.color = "var(--text-sub)"; 
    
    switchMdTab('overview', document.querySelectorAll('.md-tab')[0]);
    document.getElementById('mdAssetLogo').innerHTML = getAssetLogoHtml(rawSymbol);

    let details = { price: 0, change: 0, high: 0, low: 0, vol: 0, vwap: 0 };
    let displaySym = rawSymbol;

    try {
        if(currentCategory === 'kripto') {
            let s = rawSymbol.replace('USDT', '') + 'USDT';
            s = s.replace('BINANCE:', ''); 
            
            const res = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${s}`);
            if(!res.ok) throw new Error("Binance Veri Hatası");
            
            const d = await res.json();
            details.price = parseFloat(d.lastPrice);
            details.change = parseFloat(d.priceChangePercent);
            details.high = parseFloat(d.highPrice);
            details.low = parseFloat(d.lowPrice);
            details.vol = parseFloat(d.quoteVolume);
            details.vwap = parseFloat(d.weightedAvgPrice);
            displaySym = rawSymbol.replace('BINANCE:','').replace('USDT','') + " / USDT";
        } else {
            let pData = await getPrice(rawSymbol);
            if(pData.price === 0) throw new Error("Fiyat Çekilemedi");

            details.price = pData.price;
            details.change = pData.change;
            details.high = details.price * 1.02; 
            details.low = details.price * 0.98;
            details.vol = 0; 
            details.vwap = details.price;
        }
        
        renderMdUI(details, displaySym);
        initMdChart(rawSymbol);

    } catch (e) {
        document.getElementById('mdBigPrice').innerText = "Veri Yok";
        document.getElementById('mdDisclaimer').innerHTML = "<span style='color:red'>Veri alınamadı, grafik deneniyor...</span>";
        initMdChart(rawSymbol);
    }
}

// "AL" BUTONU AKSİYONU (DÜZELTİLMİŞ)
function actionBuyFromMarket() {
    closeMarketDetail(); 
    switchPage('portfolio', document.querySelectorAll('.nav-item')[0]);
    
    const content = document.getElementById('tradeContent');
    const chevron = document.getElementById('tradeChevron');
    const card = document.getElementById('tradeCard');
    
    if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        chevron.classList.add('rotated');
        card.classList.add('open');
    }

    const input = document.getElementById('addSymbol');
    if(currentMdSymbol) {
        let cleanSym = currentMdSymbol.replace('BINANCE:','').replace('BIST:','').replace('USDT','').replace('.IS','');
        input.value = cleanSym;
        debouncedPreview(cleanSym); 
    }
    
    setTimeout(() => { document.getElementById('addAmount').focus(); }, 300);
}

// İZLEMEYE EKLE BUTONU
function actionWatchFromMarket() {
    let w = JSON.parse(localStorage.getItem('tm_watchlist')) || [];
    let icon = document.getElementById('mdWatchIcon');

    if(w.includes(currentMdSymbol)) { 
        icon.style.color = "#f59e0b"; 
        return addNotification('warn', 'Zaten Ekli', 'Bu varlık zaten izleme listenizde.'); 
    } 

    w.push(currentMdSymbol); 
    localStorage.setItem('tm_watchlist', JSON.stringify(w)); 
    updateWatchlist(); 
    
    icon.style.color = "#f59e0b"; 
    icon.style.transform = "scale(1.3)"; 
    setTimeout(() => { icon.style.transform = "scale(1)"; }, 200); 

    addNotification('success', 'Takipte', `${currentMdSymbol} izleme listesine eklendi.`);
}

function closeMarketDetail() {
    document.getElementById('marketDetailModal').style.display = 'none';
    document.getElementById('mdChartContainer').innerHTML = ""; 
}

/* --- YENİ WATCHLIST BUTON MANTIĞI --- */

/* --- ORİJİNAL COINGECKO ENTEGRASYONLU DETAY PENCERESİ --- */
async function openMarketDetail(rawSymbol) {
    currentMdSymbol = rawSymbol; 
    
    // 1. Modalı Aç
    document.getElementById('marketDetailModal').style.display = 'flex';
    document.getElementById('mdSymbolTitle').innerText = rawSymbol;
    document.getElementById('mdBigPrice').innerText = "Yükleniyor...";
    
    // İzleme İkonu
    let w = JSON.parse(localStorage.getItem('tm_watchlist')) || [];
    let icon = document.getElementById('mdWatchIcon');
    icon.style.color = w.includes(rawSymbol) ? "#f59e0b" : "var(--text-sub)"; 
    
    // Sekmeyi 'Genel Bakış'a al
    switchMdTab('overview', document.querySelectorAll('.md-tab')[0]);

    // Değişkenler
    let details = { price: 0, change: 0, high: 0, low: 0, vol: 0, vwap: 0 };
    let logoHtml = getAssetLogoHtml(rawSymbol); // Varsayılan logo
    let dataFound = false;

    // --- 1. ADIM: CACHE (HAZIR LİSTE) KONTROLÜ (EN HIZLI YÖNTEM) ---
    // Eğer ana listede bu coini görüyorsanız, verisi zaten elinizdedir. Tekrar istek atmaya gerek yok.
    if(marketDataCache && marketDataCache.length > 0) {
        // Sembol eşleşmesi yap (Büyük/Küçük harf duyarsız)
        const cachedItem = marketDataCache.find(x => x.symbol.toUpperCase() === rawSymbol.toUpperCase());
        
        if(cachedItem) {
            // Veriler Cache'den alınıyor (Burada her şey doludur)
            details.price = cachedItem.price;
            details.change = cachedItem.change;
            details.vol = cachedItem.vol || 0;
            
            // CoinGecko 'markets' endpoint'i high/low bilgisini de verir.
            // Eğer cache yapımızda high/low saklamıyorsak simüle ederiz.
            if(cachedItem.high_24h) details.high = cachedItem.high_24h;
            else details.high = details.price * 1.05;

            if(cachedItem.low_24h) details.low = cachedItem.low_24h;
            else details.low = details.price * 0.95;
            
            details.vwap = details.price; // VWAP CoinGecko'da standart yok, fiyatı basıyoruz

            // Logo Cache'den
            if(cachedItem.image) {
                logoHtml = `<div class="asset-logo-wrap" style="background:transparent; border:none; width:50px; height:50px;"><img src="${cachedItem.image}" class="asset-logo-img"></div>`;
            }
            
            dataFound = true;
        }
    }

    // --- 2. ADIM: CACHE'DE YOKSA API'YE SOR (ARAMA YAPILDIYSA) ---
    if(!dataFound && currentCategory === 'kripto' && coingeckoApiKey) {
        try {
            // Önce: Sembolden ID bul (Search API)
            const searchUrl = `https://api.coingecko.com/api/v3/search?query=${rawSymbol}&x_cg_demo_api_key=${coingeckoApiKey}`;
            const searchRes = await fetch(searchUrl);
            const searchData = await searchRes.json();
            
            let coinId = null;
            if(searchData.coins && searchData.coins.length > 0) {
                // Tam eşleşme ara, yoksa ilkini al
                const match = searchData.coins.find(c => c.symbol.toUpperCase() === rawSymbol.toUpperCase());
                coinId = match ? match.id : searchData.coins[0].id;
                
                // Logoyu buradan alabiliriz (large versiyonu)
                if(match && match.thumb) {
                    let largeImg = match.thumb.replace('thumb', 'large');
                    logoHtml = `<div class="asset-logo-wrap" style="background:transparent; border:none; width:50px; height:50px;"><img src="${largeImg}" class="asset-logo-img"></div>`;
                }
            }

            if(coinId) {
                // Sonra: ID ile detay çek (Market Data API)
                // Bu endpoint High, Low, Vol her şeyi verir.
                const detailUrl = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${coinId}&x_cg_demo_api_key=${coingeckoApiKey}`;
                const detailRes = await fetch(detailUrl);
                const detailData = await detailRes.json();

                if(detailData && detailData.length > 0) {
                    const d = detailData[0];
                    details.price = d.current_price;
                    details.change = d.price_change_percentage_24h;
                    details.high = d.high_24h;
                    details.low = d.low_24h;
                    details.vol = d.total_volume;
                    details.vwap = d.current_price;
                    
                    // Logo API'den geldiyse güncelle
                    if(d.image) {
                        logoHtml = `<div class="asset-logo-wrap" style="background:transparent; border:none; width:50px; height:50px;"><img src="${d.image}" class="asset-logo-img"></div>`;
                    }
                    dataFound = true;
                }
            }
        } catch(e) {
            console.log("CG Detay Hatası:", e);
        }
    }

    // --- 3. ADIM: HİSSE / ALTIN / DÖVİZ (ESKİ SİSTEM) ---
    if(!dataFound && currentCategory !== 'kripto') {
        let pData = await getPrice(rawSymbol);
        if(pData.price > 0) {
            details.price = pData.price;
            details.change = pData.change;
            details.high = pData.price * 1.02;
            details.low = pData.price * 0.98;
            dataFound = true;
        }
    }

    // Ekrana Bas
    document.getElementById('mdAssetLogo').innerHTML = logoHtml;

    if(dataFound || details.price > 0) {
        // Eksik veri varsa (örn: hisse) simüle et
        if(!details.high) details.high = details.price * 1.05;
        if(!details.low) details.low = details.price * 0.95;
        
        renderMdUI(details, rawSymbol);
    } else {
        document.getElementById('mdBigPrice').innerText = "Veri Yok";
        document.getElementById('mdDisclaimer').innerHTML = "<span style='color:red'>Veri alınamadı.</span>";
    }

    // Grafiği Başlat
    initMdChart(rawSymbol);
}


// 2. Butona Basınca Listeye Ekle ve Sarı Yap
function actionWatchFromMarket() {
    let w = JSON.parse(localStorage.getItem('tm_watchlist')) || [];
    let icon = document.getElementById('mdWatchIcon');

    // Zaten listede mi?
    if(w.includes(currentMdSymbol)) { 
        // İsterseniz burada "Listeden Çıkarma" mantığı da yapabiliriz.
        // Şimdilik sadece uyarı veriyoruz ve rengi sarı tutuyoruz.
        icon.style.color = "#f59e0b"; 
        return addNotification('warn', 'Zaten Ekli', 'Bu varlık zaten izleme listenizde.'); 
    } 

    // Listeye Ekle
    w.push(currentMdSymbol); 
    localStorage.setItem('tm_watchlist', JSON.stringify(w)); 
    updateWatchlist(); 
    
    // RENGİ SARI YAP VE EFEKT VER
    icon.style.color = "#f59e0b"; 
    icon.style.transform = "scale(1.3)"; // Hafif büyüme efekti
    setTimeout(() => { icon.style.transform = "scale(1)"; }, 200); // Geri küçült

    addNotification('success', 'Takipte', `${currentMdSymbol} izleme listesine eklendi.`);
}

/* --- UNIFIED HEADER İŞLEVLERİ --- */

// Arama kutusunu aç/kapa
function toggleUnifiedSearch(btn) {
    const box = document.getElementById('unifiedSearchBox');
    const input = document.getElementById('unifiedSearchInput');
    
    if (box.classList.contains('open')) {
        box.classList.remove('open');
        btn.classList.remove('active');
        btn.innerHTML = '<i class="fas fa-search"></i>';
        input.value = '';
        filterUnifiedList(''); // Listeyi temizle
    } else {
        box.classList.add('open');
        btn.classList.add('active');
        btn.innerHTML = '<i class="fas fa-times"></i>';
        setTimeout(() => input.focus(), 300);
    }
}

// Listeyi Filtrele
function filterUnifiedList(val) {
    val = val.toUpperCase().trim();
    const isMain = document.getElementById('mv-main').classList.contains('active');
    const container = document.getElementById(isMain ? 'infiniteMarketList' : 'wlList');
    const items = container.querySelectorAll(isMain ? '.infinite-item' : '.wl-card-classic');

    items.forEach(item => {
        let text = isMain ? item.querySelector('.ii-sym').innerText : item.querySelector('.wl-c-sym').innerText;
        item.style.display = text.toUpperCase().includes(val) ? (isMain ? 'flex' : 'block') : 'none';
    });
}

// Mod Değiştirme (Piyasa <-> İzleme) - GÜNCELLENMİŞ
switchMarketMode = function(mode, btn) {
    // İçerik alanlarını değiştir
    document.querySelectorAll('.market-view-section').forEach(s => s.classList.remove('active'));
    document.getElementById('mv-' + mode).classList.add('active');

    // Header butonlarını güncelle
    document.querySelectorAll('.vt-btn').forEach(b => b.classList.remove('active'));
    
    // İzleme ve Piyasa moduna göre butonları ayarla
    if(mode === 'main') {
        document.getElementById('btn-view-main').classList.add('active');
        // Piyasa modunda kategori ve filtreleri GÖSTER
        document.getElementById('unifiedCategories').style.display = 'flex';
        document.getElementById('unifiedFilters').style.display = 'flex';
        
        loadMarketCategory(currentCategory, null);
    } else {
        document.getElementById('btn-view-watch').classList.add('active');
        // İzleme modunda kategori ve filtreleri GİZLE (Sade görünüm)
        document.getElementById('unifiedCategories').style.display = 'none';
        document.getElementById('unifiedFilters').style.display = 'none';
        
        updateWatchlist();
    }
};

// Kategori Yükleme Fonksiyonu (Sınıfları yeni yapıya uydurduk)
const oldLoadMarketCategory2 = loadMarketCategory;
loadMarketCategory = function(cat, btn) {
    if(btn) {
        document.querySelectorAll('.muh-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    // Eski mantığı çağır
    currentCategory = cat;
    currentPage = 1;
    marketDataCache = [];
    document.getElementById('infiniteMarketList').innerHTML = '';
    fetchMarketData();
};

/* --- TAM KAPSAMLI GLOBAL ARAMA (COINGECKO ENGINE) --- */
let autoSearchTimer;

function filterUnifiedList(val) {
    val = val.trim(); // Boşlukları al ama uppercase yapma (API hassas olabilir)
    
    // Aktif Listeyi Bul
    const isMain = document.getElementById('mv-main').classList.contains('active');
    const container = document.getElementById(isMain ? 'infiniteMarketList' : 'wlList');
    if(!container) return;

    // Eski sonuçları temizle
    const oldResult = document.getElementById('global-search-result');
    if(oldResult) oldResult.remove();
    clearTimeout(autoSearchTimer);

    // 1. MEVCUT LİSTEYİ FİLTRELE
    const itemClass = isMain ? '.infinite-item' : '.wl-card-classic';
    const items = container.querySelectorAll(itemClass);
    let visibleCount = 0;

    items.forEach(item => {
        let text = isMain ? item.querySelector('.ii-sym').innerText : item.querySelector('.wl-c-sym').innerText;
        if (text.toUpperCase().includes(val.toUpperCase())) {
            item.style.display = isMain ? 'flex' : 'block';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });

    // 2. LİSTEDE YOKSA -> COINGECKO DEV HAVUZUNDA ARA
    if (visibleCount === 0 && val.length > 2) {
        
        // Yükleniyor Mesajı
        const loadingHtml = `
            <div id="global-search-result" style="text-align:center; padding:20px; color:var(--text-sub); animation:fadeIn 0.3s;">
                <i class="fas fa-satellite-dish fa-spin"></i> CoinGecko Veritabanı Taranıyor: <b>${val}</b>
            </div>`;
        container.insertAdjacentHTML('beforeend', loadingHtml);

        autoSearchTimer = setTimeout(async () => {
            const resultBox = document.getElementById('global-search-result');
            if(!resultBox) return;

            // CoinGecko Search API (Her şeyi bulur)
            if(coingeckoApiKey) {
                try {
                    const url = `https://api.coingecko.com/api/v3/search?query=${val}&x_cg_demo_api_key=${coingeckoApiKey}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    // İlk 5 sonucu al (Çok fazla sonuç gelebilir)
                    const coins = data.coins ? data.coins.slice(0, 5) : [];

                    if(coins.length > 0) {
                        resultBox.innerHTML = `<div style="padding:10px; font-size:11px; color:var(--text-sub); text-align:center;">GLOBAL SONUÇLAR</div>`;
                        
                        coins.forEach(coin => {
                            // Kart HTML'i
                            resultBox.innerHTML += `
                                <div class="infinite-item" onclick="openCoinGeckoDetail('${coin.id}')" style="border: 1px solid var(--accent); background: rgba(59, 130, 246, 0.05); margin-bottom:5px;">
                                    <div class="ii-left">
                                        <div class="ii-rank" style="background:#8bc34a; color:white;">CG</div>
                                        <div class="asset-logo-wrap" style="background:transparent; border:none; width:32px; height:32px;">
                                            <img src="${coin.thumb}" class="asset-logo-img">
                                        </div>
                                        <div class="ii-info">
                                            <span class="ii-sym">${coin.symbol}</span>
                                            <span class="ii-vol">${coin.name}</span>
                                        </div>
                                    </div>
                                    <div class="ii-right">
                                        <span class="ii-price" style="font-size:11px; color:var(--accent);">Görüntüle <i class="fas fa-chevron-right"></i></span>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        resultBox.innerHTML = `<div style="opacity:0.5; text-align:center;">"${val}" bulunamadı.</div>`;
                    }
                } catch(e) {
                    resultBox.innerHTML = `<div style="color:var(--danger); text-align:center;">Bağlantı Hatası</div>`;
                }
            } else {
                // Anahtar yoksa eski usul
                filterUnifiedListOld(val); 
            }
        }, 800);
    }
}

/* --- SONSUZ KAYDIRMA VE SAYFALAMA DÜZELTMESİ --- */

// 1. Önce mevcut listener'ı temizleyelim (Varsa çakışmasın)
const listContainer = document.getElementById('infiniteMarketList');
const newContainer = listContainer.cloneNode(true);
listContainer.parentNode.replaceChild(newContainer, listContainer);

// 2. Yeni ve Güçlü Scroll Algılayıcıyı Ekleyelim
newContainer.addEventListener('scroll', function() {
    
    // Listenin sonuna yaklaştık mı? (Son 100px kala tetiklensin)
    if (this.scrollTop + this.clientHeight >= this.scrollHeight - 100) {
        
        // Eğer zaten yükleme yapılıyorsa veya tüm veri bittiyse dur
        if (isMarketLoading) return;

        // --- SENARYO 1: Kripto (CoinGecko) ---
        // CoinGecko sayfa sayfa veri verir, yeni istek atmalıyız.
        if (currentCategory === 'kripto' && coingeckoApiKey) {
            isMarketLoading = true;
            currentPage++; // Sayfayı artır (Örn: 1 -> 2)
            fetchMarketData(); // Yeni sayfayı API'den iste
        } 
        
        // --- SENARYO 2: Diğerleri (Binance/Bist) ---
        // Veri zaten cache'de var, sadece sıradakileri göstermeliyiz.
        else {
            // Cache'de daha gösterilecek veri var mı?
            if ((currentPage * itemsPerPage) < marketDataCache.length) {
                isMarketLoading = true;
                currentPage++;
                renderNextBatch(); // Cache'den sıradaki grubu bas
                isMarketLoading = false; // İşlem bitti
            }
        }
    }
});

/* --- GÜNCELLENMİŞ COINGECKO DETAY AÇMA --- */
async function openCoinGeckoDetail(coinId) {
    // Yükleniyor Modalı Aç
    document.getElementById('marketDetailModal').style.display = 'flex';
    document.getElementById('mdSymbolTitle').innerText = "YÜKLENİYOR...";
    document.getElementById('mdBigPrice').innerText = "--";
    
    try {
        // 1. COİN DETAYLARINI ÇEK
        const detailUrl = `https://api.coingecko.com/api/v3/coins/${coinId}?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false&sparkline=false&x_cg_demo_api_key=${coingeckoApiKey}`;
        const detailRes = await fetch(detailUrl);
        const coinData = await detailRes.json();
        
        if(!coinData || !coinData.market_data) throw new Error("Veri yok");

        const md = coinData.market_data;
        
        // Detayları Doldur
        const details = {
            price: md.current_price.usd,
            change: md.price_change_percentage_24h,
            vol: md.total_volume.usd,
            high: md.high_24h.usd,
            low: md.low_24h.usd,
            vwap: md.current_price.usd
        };

        // Sembolü büyük harf yap (örn: pepecto -> PEPECTO)
        const displaySym = coinData.symbol.toUpperCase();
        
        currentMdSymbol = displaySym;
        
        // UI Güncelle
        renderMdUI(details, displaySym + " / USD");
        
        // Logo Ekle
        if(coinData.image && coinData.image.large) {
            document.getElementById('mdAssetLogo').innerHTML = `
                <div class="asset-logo-wrap" style="background:transparent; border:none; width:50px; height:50px;">
                    <img src="${coinData.image.large}" class="asset-logo-img">
                </div>`;
        } else {
            document.getElementById('mdAssetLogo').innerHTML = getAssetLogoHtml(displaySym);
        }
        
        // Grafiği Başlat (displaySym gönderiyoruz, örn: "PEPE")
        // initMdChart bunu alıp "PEPEUSDT" yapacak ve TradingView borsayı kendi bulacak.
        initMdChart(displaySym);

    } catch (e) {
        console.error("CG Detay Hatası:", e);
        document.getElementById('mdBigPrice').innerText = "Hata";
        document.getElementById('mdDisclaimer').innerHTML = "<span style='color:red'>Veri alınamadı.</span>";
        // Yine de grafiği sembol üzerinden denemeye çalışalım
        if(coinId) initMdChart(coinId.toUpperCase()); 
    }
}

/* --- AKILLI SATIŞ (GÖRSEL EFEKTLİ & OTO DÜZELTMELİ) --- */
function actionSellFromMarket() {
    if (!currentMdSymbol) return;

    // 1. Sembol Temizliği
    let cleanSearch = currentMdSymbol
        .replace('BINANCE:', '').replace('BIST:', '').replace('FX:', '').replace('TVC:', '').replace('.IS', '').trim();
    if (cleanSearch.endsWith('USDT') && cleanSearch !== 'USDT') cleanSearch = cleanSearch.slice(0, -4);

    // 2. Cüzdanı Tara
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let targetIndex = as.findIndex(a => {
        let name = a.name.replace('BINANCE:', '').replace('BIST:', '').replace('.IS', '').trim();
        if (name.endsWith('USDT') && name !== 'USDT') name = name.slice(0, -4);
        return name === cleanSearch;
    });

    // A) VARSA -> GİT
    if (targetIndex !== -1) {
        closeMarketDetail();
        switchPage('portfolio', document.querySelectorAll('.nav-item')[0]);
        setTimeout(() => { openSell(targetIndex); }, 300);
    } 
    // B) YOKSA -> EFEKT YAP VE GERİ AL
    else {
        addNotification('warn', 'İşlem Başarısız', `${cleanSearch} portföyünüzde yok.`);
        
        const btn = document.querySelector('.bq-sell');
        if(btn) {
            // Mevcut (orijinal) HTML'i saklamaya gerek yok, elle yazacağız
            
            // 1. KIRMIZI VE "YOK" MODUNA GEÇ
            btn.style.transition = "0.2s";
            btn.style.background = "rgba(239, 68, 68, 0.2)"; // Kırmızı Zemin
            btn.style.border = "1px solid var(--danger)";     // Kırmızı Çerçeve
            btn.style.color = "var(--danger)";                // Kırmızı Yazı
            
            // İçeriği Değiştir
            btn.innerHTML = '<span><i class="fas fa-times"></i> YOK</span><span class="bq-sub" style="opacity:0.8">Portföyde Yok</span>';
            
            // 2. 1.5 SANİYE SONRA ESKİ HALİNE DÖN (Reset)
            setTimeout(() => {
                btn.style.background = ""; 
                btn.style.border = "";
                btn.style.color = ""; // Orijinal CSS rengine döner
                
                // Orijinal Yazıyı Geri Getir
                btn.innerHTML = '<span><i class="fas fa-arrow-up"></i> SATIŞ YAP</span><span class="bq-sub">Portföyden Sat</span>';
            }, 1500);
        }
    }
}

/* --- BİLDİRİM AYARLARI VE İZİN YÖNETİMİ --- */

// İzin İste
function requestNotifyPermission() {
    if (!("Notification" in window)) {
        alert("Tarayıcınız bildirimleri desteklemiyor.");
        return;
    }
    Notification.requestPermission().then((permission) => {
        checkNotifyUI();
        if (permission === "granted") {
            addNotification('success', 'Bildirimler Aktif', 'Artık önemli gelişmeleri kaçırmayacaksınız.');
        }
    });
}

// İzin Durumunu Kontrol Et (UI Göster/Gizle)
function checkNotifyPermission() {
    const card = document.getElementById('permRequestCard');
    if (!("Notification" in window)) return;
    
    if (Notification.permission === "granted" || Notification.permission === "denied") {
        if(card) card.style.display = 'none';
    } else {
        if(card) card.style.display = 'block'; // İzin verilmemişse uyarıyı göster
    }
}

// Ayarları UI'a Yansıt
function loadNotifyUI() {
    document.getElementById('ntf_price').checked = notifySettings.price;
    document.getElementById('ntf_trade').checked = notifySettings.trade;
    document.getElementById('ntf_news').checked = notifySettings.news;
    document.getElementById('ntf_sound').checked = notifySettings.sound;
    document.getElementById('ntf_vibrate').checked = notifySettings.vibrate;
    checkNotifyPermission();
}

// Ayarları Kaydet
function saveNotifySettings() {
    notifySettings.price = document.getElementById('ntf_price').checked;
    notifySettings.trade = document.getElementById('ntf_trade').checked;
    notifySettings.news = document.getElementById('ntf_news').checked;
    notifySettings.sound = document.getElementById('ntf_sound').checked;
    notifySettings.vibrate = document.getElementById('ntf_vibrate').checked;
    
    localStorage.setItem('tm_notify_settings', JSON.stringify(notifySettings));
    
    // Ses önizlemesi (Kullanıcı sesi açarsa 'ding' duysun)
    if(notifySettings.sound && event.target.id === 'ntf_sound') playNotificationSound('success');
}

// Ses Çalma Fonksiyonu
function playNotificationSound(type) {
    // Basit bip sesleri (Base64 encoded audio - dış dosya gerektirmez)
    let audioSrc = "";
    
    if(type === 'success' || type === 'info') {
        // Success "Ding"
        audioSrc = "data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"; // (Kısaltıldı, gerçek bir ding sesi için URL kullanmak daha iyi olabilir veya kısa beep)
        // Daha güvenilir bir yöntem: Web Audio API Oscillator
        playBeep(600, 200, 'sine');
    } else if (type === 'danger' || type === 'warn') {
        // Error "Buzz"
        playBeep(150, 400, 'sawtooth');
    }
}

// Basit Web Audio Beep (Dosyasız Ses)
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playBeep(freq, duration, type='sine') {
    if(audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    
    // Fade out
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + (duration/1000));
    
    setTimeout(() => osc.stop(), duration);
}

function testNotification() {
    addNotification('info', 'Test Bildirimi', 'Bu bir test mesajıdır. Ses ve titreşim çalışıyor mu?');
}

// checkNotifyUI fonksiyonu eksikti, ekleyelim
function checkNotifyUI() {
    checkNotifyPermission();
}
/* --- YENİ GELİŞMİŞ VE GENİŞ KAPSAMLI DÖVİZ MOTORU --- */
async function fetchFastForex() {
    try {
        // 1. CANLI VERİ (Binance - Majör Paralar)
        // Dolar, Euro ve Sterlin'i buradan anlık çekiyoruz
        const resBinance = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbols=["USDTTRY","EURUSDT","GBPUSDT"]');
        const dataBinance = await resBinance.json();

        // 2. PARİTE ORANLARI (Diğerleri için - Open Exchange Rates)
        // JPY, CNY, CAD, RUB gibi paraların Dolara olan oranını alıyoruz
        const resParity = await fetch('https://open.er-api.com/v6/latest/USD');
        const dataParity = await resParity.json();
        const rates = dataParity.rates; 

        // --- VERİLERİ AYIKLA ---
        const usdt = dataBinance.find(x => x.symbol === 'USDTTRY');
        const eur = dataBinance.find(x => x.symbol === 'EURUSDT');
        const gbp = dataBinance.find(x => x.symbol === 'GBPUSDT');

        if (!usdt || !eur || !gbp || !rates) return [];

        // Ana Dolar Kuru (Her şey buna bağlı değişecek)
        const usdPrice = parseFloat(usdt.lastPrice);
        const usdChange = parseFloat(usdt.priceChangePercent);

        // --- YARDIMCI: DİĞER PARALARI HESAPLA ---
        // Mantık: (1 Dolar / Parite Oranı) * Canlı Dolar Kuru = Canlı TL Değeri
        const calcOther = (parityVal, name, flagCode, symbolPrefix) => {
            const priceInUsd = 1 / parityVal; 
            const priceInTry = priceInUsd * usdPrice;
            
            return {
                symbol: name,
                price: priceInTry,
                change: usdChange, // Dolar artarsa bunlar da artar
                vol: 0,
                source: 'HESAPLANAN',
                image: `https://flagcdn.com/w80/${flagCode}.png`, // Ülke Bayrağı
                unit: symbolPrefix
            };
        };

        // --- YARDIMCI: MAJÖR PARALAR (EUR, GBP) ---
        const eurPrice = parseFloat(eur.lastPrice) * usdPrice;
        const eurChange = parseFloat(eur.priceChangePercent) + usdChange;
        
        const gbpPrice = parseFloat(gbp.lastPrice) * usdPrice;
        const gbpChange = parseFloat(gbp.priceChangePercent) + usdChange;

        // --- LİSTEYİ OLUŞTUR ---
        return [
            // 1. MAJÖRLER (Binance Destekli)
            { symbol: 'USD/TRY', price: usdPrice, change: usdChange, vol: parseFloat(usdt.quoteVolume), source: 'CANLI PİYASA', image: 'https://flagcdn.com/w80/us.png', unit: '₺' },
            { symbol: 'EUR/TRY', price: eurPrice, change: eurChange, vol: 0, source: 'HESAPLANAN', image: 'https://flagcdn.com/w80/eu.png', unit: '₺' },
            { symbol: 'GBP/TRY', price: gbpPrice, change: gbpChange, vol: 0, source: 'HESAPLANAN', image: 'https://flagcdn.com/w80/gb.png', unit: '₺' },

            // 2. DİĞERLERİ (Otomatik Hesaplananlar)
            calcOther(rates.JPY, 'JPY/TRY', 'jp', '¥'),  // Japon Yeni
            calcOther(rates.CNY, 'CNY/TRY', 'cn', '¥'),  // Çin Yuanı
            calcOther(rates.CAD, 'CAD/TRY', 'ca', '$'),  // Kanada Doları
            calcOther(rates.AUD, 'AUD/TRY', 'au', '$'),  // Avustralya Doları
            calcOther(rates.RUB, 'RUB/TRY', 'ru', '₽'),  // Rus Rublesi
            calcOther(rates.AZN, 'AZN/TRY', 'az', '₼'),  // Azerbaycan Manatı
            
            // 3. PARİTE (Euro/Dolar)
            { symbol: 'EUR/USD', price: parseFloat(eur.lastPrice), change: parseFloat(eur.priceChangePercent), vol: parseFloat(eur.quoteVolume), source: 'PARİTE', image: 'https://flagcdn.com/w80/eu.png', unit: '$' }
        ];

    } catch (e) {
        console.error("Forex Hatası:", e);
        return [];
    }
}

/* --- GÜNCELLENMİŞ ALTIN MOTORU (7/24 CANLI) --- */
async function fetchFastGold() {
    try {
        // 1. Canlı Veriyi Çek (Binance API - En Hızlı ve Ücretsiz)
        // PAXGUSDT = Ons Altın ($), USDTTRY = Dolar Kuru
        const res = await fetch('https://api.binance.com/api/v3/ticker/24hr?symbols=["PAXGUSDT","USDTTRY"]');
        const data = await res.json();

        // Verileri Ayrıştır
        const paxg = data.find(x => x.symbol === 'PAXGUSDT');
        const usdt = data.find(x => x.symbol === 'USDTTRY');

        if (!paxg || !usdt) throw new Error("Veri Eksik");

        const onsPrice = parseFloat(paxg.lastPrice);
        const change = parseFloat(paxg.priceChangePercent); // Ons'un günlük değişimi
        const dolarKuru = parseFloat(usdt.lastPrice);

        // 2. Hesaplamalar (Türkiye Standartları)
        // 1 Ons = 31.1035 Gram
        const gramHas = (onsPrice * dolarKuru) / 31.1035;
        
        // Diğer altın türleri Gram Has fiyata göre oranlanır
        const gram22 = gramHas * 0.916;  // 22 Ayar (Bilezik)
        const ceyrek = gramHas * 1.606;  // Çeyrek (Eski/Yeni ortalama katsayı)
        const yarim = ceyrek * 2;
        const tam = ceyrek * 4;
        const ata = ceyrek * 4.10;       // Cumhuriyet/Ata

        // 3. Basit İkonlar
        const iconBar = "data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='8' y='16' width='48' height='32' fill='%23FFD700' stroke='%23DAA520' stroke-width='2'/%3E%3C/svg%3E";
        const iconCoin = "data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='28' fill='%23FFD700' stroke='%23DAA520' stroke-width='2'/%3E%3C/svg%3E";

        // 4. Listeyi Döndür
        return [
            { symbol: 'ONS ALTIN', price: onsPrice, change: change, vol: 0, source: 'KURESEL', image: iconBar },
            { symbol: 'GRAM HAS (24K)', price: gramHas, change: change, vol: 0, source: 'HESAPLANAN', image: iconBar },
            { symbol: 'ÇEYREK ALTIN', price: ceyrek, change: change, vol: 0, source: 'DARPHANE', image: iconCoin },
            { symbol: 'YARIM ALTIN', price: yarim, change: change, vol: 0, source: 'DARPHANE', image: iconCoin },
            { symbol: 'TAM ALTIN', price: tam, change: change, vol: 0, source: 'DARPHANE', image: iconCoin },
            { symbol: 'CUMHURİYET', price: ata, change: change, vol: 0, source: 'DARPHANE', image: iconCoin },
            { symbol: '22 AYAR GRAM', price: gram22, change: change, vol: 0, source: 'HESAPLANAN', image: iconCoin }
        ];

    } catch (e) {
        console.error("Gold Hata:", e);
        return [];
    }
}

/* --- TRADER KARNESİ HESAPLAMA MOTORU --- */
function calculateTraderScore() {
    let history = JSON.parse(localStorage.getItem('tm_full_trade_history')) || [];
    
    // Sadece SATIŞ işlemlerini al
    let sales = history.filter(t => t.type === 'SATIM');

    // Eğer yeterli satış verisi yoksa hesaplama yapma
    if (sales.length < 2) {
        document.getElementById('scoreBadge').innerText = "VERİ YOK";
        document.getElementById('pfScore').innerText = "--";
        document.getElementById('expScore').innerText = "--";
        document.getElementById('avgWinVal').innerText = "--";
        document.getElementById('avgLossVal').innerText = "--";
        return;
    }

    let grossProfit = 0;
    let grossLoss = 0;
    let winCount = 0;
    let lossCount = 0;
    let totalWinVal = 0;
    let totalLossVal = 0;

    sales.forEach(t => {
        // Eski kayıtlarda pnl yoksa 0 varsay
        let pnl = t.pnl !== undefined ? parseFloat(t.pnl) : 0;
        
        // Para birimi dönüşümü (Hepsini ana para birimine çevir)
        let val = pnl;
        let transCurr = t.curr || (t.isUsdBase ? 'USD' : 'TRY');
        
        if(appSettings.currency === 'TRY' && transCurr === 'USD') val = val * usdTryRate;
        else if(appSettings.currency === 'USD' && transCurr === 'TRY') val = val / usdTryRate;

        if (val > 0) {
            grossProfit += val;
            totalWinVal += val;
            winCount++;
        } else {
            let absLoss = Math.abs(val);
            grossLoss += absLoss;
            totalLossVal += absLoss;
            lossCount++;
        }
    });

    let totalTrades = winCount + lossCount;
    let winRate = totalTrades > 0 ? (winCount / totalTrades) : 0;
    
    // Kâr Faktörü (Profit Factor)
    let profitFactor = grossLoss === 0 ? (grossProfit > 0 ? 5 : 0) : (grossProfit / grossLoss);
    if(profitFactor > 99) profitFactor = 99; // Görsel sınır

    // Ortalama Kazanç ve Kayıp
    let avgWin = winCount > 0 ? (totalWinVal / winCount) : 0;
    let avgLoss = lossCount > 0 ? (totalLossVal / lossCount) : 0;

    // Beklenti Değeri
    let lossRate = 1 - winRate;
    let expectancy = (winRate * avgWin) - (lossRate * avgLoss);

    // --- UI GÜNCELLEME ---
    let sym = appSettings.currency === 'TRY' ? '₺' : '$';

    // 1. Kâr Faktörü
    let pfEl = document.getElementById('pfScore');
    pfEl.innerText = profitFactor.toFixed(2);
    
    let badge = document.getElementById('scoreBadge');
    if(profitFactor >= 2.0) {
        pfEl.style.color = "var(--success)";
        document.getElementById('pfDesc').innerText = "Mükemmel";
        badge.innerText = "MASTER";
        badge.style.color = "var(--success)";
        badge.style.background = "rgba(16, 185, 129, 0.15)";
    } else if(profitFactor >= 1.1) {
        pfEl.style.color = "var(--gold)";
        document.getElementById('pfDesc').innerText = "Kârlı";
        badge.innerText = "PRO";
        badge.style.color = "var(--gold)";
        badge.style.background = "rgba(245, 158, 11, 0.15)";
    } else {
        pfEl.style.color = "var(--danger)";
        document.getElementById('pfDesc').innerText = "Riskli";
        badge.innerText = "ACEMİ";
        badge.style.color = "var(--danger)";
        badge.style.background = "rgba(239, 68, 68, 0.15)";
    }

    // 2. Beklenti
    let expEl = document.getElementById('expScore');
    expEl.innerText = sym + expectancy.toLocaleString(undefined, {maximumFractionDigits:0});
    expEl.style.color = expectancy > 0 ? "var(--success)" : "var(--danger)";

    // 3. Ortalamalar
    document.getElementById('avgWinVal').innerText = sym + avgWin.toLocaleString(undefined, {maximumFractionDigits:0});
    document.getElementById('avgLossVal').innerText = sym + avgLoss.toLocaleString(undefined, {maximumFractionDigits:0});
}

/* --- MANUEL GEÇMİŞ EKLEME FONKSİYONLARI --- */

function openManualHistoryModal() {
    // Tarih alanına bugünü otomatik doldur
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('manualDate').value = today;
    
    // Temizle
    document.getElementById('manualSym').value = '';
    document.getElementById('manualAmt').value = '';
    document.getElementById('manualPrice').value = '';
    document.getElementById('manualBuyCost').value = '';
    
    // Varsayılan ALIM modu
    setManualType('ALIM', document.querySelectorAll('#manualHistoryModal .sim-tab')[0]);
    
    document.getElementById('manualHistoryModal').style.display = 'flex';
}

function setManualType(type, btn) {
    document.getElementById('manualType').value = type;
    
    // Buton stilleri
    const group = btn.parentElement;
    group.querySelectorAll('.sim-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    
    // Satış ise Maliyet sor, Alım ise sorma
    const costArea = document.getElementById('manualCostArea');
    if (type === 'SATIM') {
        costArea.style.display = 'block';
    } else {
        costArea.style.display = 'none';
    }
}

function saveManualHistory() {
    const type = document.getElementById('manualType').value;
    const sym = document.getElementById('manualSym').value.toUpperCase().trim();
    const dateInput = document.getElementById('manualDate').value;
    const amt = parseFloat(document.getElementById('manualAmt').value);
    const price = parseFloat(document.getElementById('manualPrice').value);
    
    if (!sym || !amt || !price || !dateInput) {
        return addNotification('warn', 'Eksik Bilgi', 'Lütfen tüm alanları doldurun.');
    }

    // Tarihi formatla (YYYY-MM-DD -> GG.AA.YYYY)
    const d = new Date(dateInput);
    const formattedDate = d.toLocaleDateString('tr-TR');
    
    let pnl = 0;
    
    // Eğer SATIŞ ise Kâr/Zarar hesapla
    if (type === 'SATIM') {
        const buyCost = parseFloat(document.getElementById('manualBuyCost').value);
        if (!buyCost) {
            return addNotification('warn', 'Maliyet Gerekli', 'Kâr hesabı için alış maliyeti şarttır.');
        }
        // PnL = (Satış Fiyatı - Alış Maliyeti) * Adet
        pnl = (price - buyCost) * amt;
    }

    // Kaydı oluştur
    let t = { 
        date: formattedDate, 
        time: "00:00", // Manuel eklenenler için varsayılan saat
        type: type, 
        sym: sym, 
        qty: amt, 
        price: price, 
        total: amt * price, 
        desc: 'Manuel Kayıt', 
        curr: appSettings.currency, // Varsayılan para birimi
        pnl: pnl
    }; 
    
    // Listeye ekle
    tradeHistory.push(t);
    
    // Tarihe göre sırala (Yeniden eskiye)
    // Not: Basitçe en sona ekliyoruz, renderHistory zaten ters çevirip gösteriyor.
    
    localStorage.setItem('tm_full_trade_history', JSON.stringify(tradeHistory)); 
    
    renderHistory();
    calculateTraderScore(); // Karne puanını anında güncelle
    
    document.getElementById('manualHistoryModal').style.display = 'none';
    addNotification('success', 'Kaydedildi', 'Geçmiş işlem başarıyla eklendi.');
}

// --- YENİ AYARLAR MENÜSÜ FONKSİYONLARI ---

// Alt sayfayı açar (Sağdan gelir)
function openSubPage(pageId) {
    // Ana menüyü gizle
    document.getElementById('settings-home').style.display = 'none';
    // Detay kapsayıcıyı göster (Animasyonlu)
    const detailWrapper = document.getElementById('settings-detail');
    detailWrapper.style.display = 'block';
    detailWrapper.style.animation = 'slideInRight 0.3s forwards';

    // Tüm içerikleri gizle, sadece isteneni aç
    document.querySelectorAll('.settings-content').forEach(el => el.style.display = 'none');
    document.getElementById('set-' + pageId).style.display = 'block';

    // Başlığı güncelle
    let titles = { 'profile': 'Profilim', 'general': 'Genel Ayarlar', 'notify': 'Bildirimler', 'history': 'Geçmiş İşlemler' };
    document.getElementById('subPageTitle').innerText = titles[pageId] || 'Detay';
}

// Ana menüye döner
function closeSubPage() {
    document.getElementById('settings-detail').style.display = 'none';
    document.getElementById('settings-home').style.display = 'block';
    document.getElementById('settings-home').style.animation = 'fadeIn 0.3s forwards';
}

// Profil yüklendiğinde menüdeki kartı da güncelle
// (Mevcut loadProfile fonksiyonunu bozmadan genişletiyoruz)
const _originalLoadProfile = loadProfile;
loadProfile = function() {
    _originalLoadProfile(); // Eski fonksiyonu çalıştır
    
    // Menüdeki resmi ve ismi güncelle
    if(userProfile.name) document.getElementById('menuProfileName').innerText = userProfile.name;
    if(userProfile.img) document.getElementById('menuProfileImg').src = userProfile.img;
};
    // --- 3. ADIM: PROFİL RESMİ VE PREMIUM GÖRÜNÜM ---

    // Mevcut yükleme fonksiyonunu sakla (hata vermemesi için)
    var eskiLoadProfile = typeof loadProfile === 'function' ? loadProfile : function(){};

    // Yeni ve Gelişmiş Profil Yükleyici
    loadProfile = function() {
        // 1. Önceki işlemleri yap (İsimleri inputlara doldur vs.)
        eskiLoadProfile();

        // 2. Hafızadan bilgileri çek
        let up = JSON.parse(localStorage.getItem('tm_user_profile')) || {};
        let name = up.name || 'Misafir';
        
        // 3. Menüdeki İsim ve Resmi Güncelle
        // (Eğer isim yoksa 'Misafir' yazar)
        let nameEl = document.getElementById('menuProfileName');
        if(nameEl) nameEl.innerText = name;
        
        // 4. Resim Ayarı (Resim yoksa Baş Harf Avatarı oluştur)
        let imgSource = up.img;
        if(!imgSource || imgSource === "null" || imgSource === "") {
            // UI Avatars servisi: İsmin baş harflerinden resim yapar (Örn: Ahmet Yılmaz -> AY)
            imgSource = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=1e2538&color=ffffff&size=128&bold=true`;
        }
        
        // Hem ana menüdeki (küçük) hem detaydaki (büyük) resmi güncelle
        const menuImg = document.getElementById('menuProfileImg');
        const detailImg = document.getElementById('displayProfileImg');
        
        if(menuImg) menuImg.src = imgSource;
        if(detailImg) detailImg.src = imgSource;

        // 5. PREMIUM PARILTISI (GOLD EFEKT)
        // Kartı bul ve parlaması için sınıf ekle
        const card = document.getElementById('mainProfileCard');
        if(card) {
            card.classList.add('premium-glow'); 
        }
    };
    
    // Sayfa açıldığında tetikle
    setTimeout(loadProfile, 500);
    
    function sendFeedback() {
    let sub = document.getElementById('fbSubject').value;
    let msg = document.getElementById('fbMessage').value;
    
    if(msg.length < 5) {
        addNotification('warn', 'Eksik Bilgi', 'Lütfen mesajınızı yazınız.');
        return;
    }

    // Şimdilik simülasyon yapıyoruz (Gerçek sunucu olmadığı için)
    document.getElementById('feedbackModal').style.display = 'none';
    document.getElementById('fbMessage').value = ""; // Temizle
    
    // Yükleniyor efekti verelim
    addNotification('info', 'Gönderiliyor...', 'Mesajınız iletiliyor.');
    
    setTimeout(() => {
        addNotification('success', 'İletildi', 'Geri bildiriminiz için teşekkürler! 🚀');
    }, 1000);
}

// Global değişken: Tıklanan linki burada tutacağız
let currentTargetUrl = "";

// 1. Habere tıklandığında bu çalışır: Linki kaydeder ve Modalı açar
function openNewsRedirect(url) {
    if(!url) return;
    currentTargetUrl = url;
    
    // Modalı göster
    document.getElementById('newsRedirectModal').style.display = 'flex';
}

// 2. Kullanıcı "GİT" butonuna basınca bu çalışır
function proceedToNews() {
    if(currentTargetUrl) {
        // Yeni sekmede güvenli açılış
        window.open(currentTargetUrl, '_blank', 'noopener,noreferrer');
    }
    closeNewsModal();
}

// 3. İptal veya kapatma fonksiyonu
function closeNewsModal() {
    document.getElementById('newsRedirectModal').style.display = 'none';
    currentTargetUrl = ""; // Linki temizle
}

/* --- GERİ GELME (SWIPE / TUŞ) YÖNETİMİ --- */

// 1. Geri hareketini dinle (Ekran kaydırma veya tuş)
window.addEventListener('popstate', function(event) {
    const modal = document.getElementById('newsRedirectModal');
    
    // Eğer Haber Modalı Açıksa:
    if (modal && modal.style.display === 'flex') {
        // Uygulamayı kapatma, sadece modalı gizle
        modal.style.display = 'none';
        currentTargetUrl = ""; 
    }
});

// 2. Modalı açarken tarayıcıya "Sahte Geçmiş" ekle
function openNewsRedirect(url) {
    if(!url) return;
    currentTargetUrl = url;
    
    // BU SATIR ÇOK ÖNEMLİ:
    // Tarayıcıya "Yeni bir sayfaya geçtik" diyoruz.
    // Böylece kullanıcı kaydırınca (swipe yapınca) uygulamadan çıkmıyor,
    // sadece bu eklediğimiz sahte geçmiş siliniyor.
    history.pushState({ popup: 'news' }, null, window.location.href);
    
    document.getElementById('newsRedirectModal').style.display = 'flex';
}

// 3. Vazgeç butonuna basılırsa
function closeNewsModal() {
    // Manuel olarak geri git (Bu, yukarıdaki popstate olayını tetikler)
    history.back(); 
}

// 4. Git butonuna basılırsa
function proceedToNews() {
    if(currentTargetUrl) {
        // Yeni sekmede aç
        window.open(currentTargetUrl, '_blank');
        
        // Kullanıcı haberi okuyup uygulamaya geri döndüğünde modal açık kalmasın
        // Hafif gecikmeli olarak arkadaki modalı kapatıyoruz
        setTimeout(() => {
            const modal = document.getElementById('newsRedirectModal');
            if (modal && modal.style.display === 'flex') {
                history.back(); // Geçmişi temizleyerek kapat
            }
        }, 300);
    }
}

/* --- GOOGLE DRIVE ENTEGRASYONU (GÜNCELLENMİŞ) --- */

// 1. YAPILANDIRMA
const CLIENT_ID = '188241284734-3tdriq9svbm1vh8acq2vqm80lieo5v7u.apps.googleusercontent.com';
const API_KEY = 'AIzaSyCCxeYq1C4mnv-3CRvTDertau_Jlv11OaA';


const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file';

let tokenClient;
let gapiInited = false;
let gisInited = false;

// Sayfa yüklendiğinde API'leri başlat
document.addEventListener('DOMContentLoaded', () => {
    if(typeof gapi !== 'undefined') gapiLoaded();
    if(typeof google !== 'undefined') gisLoaded();
});

// 2. KÜTÜPHANE YÜKLEME
function gapiLoaded() {
    gapi.load('client', async () => {
        await gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        updateDriveUI("Hazır. Giriş yapabilirsiniz.");
        console.log("GAPI Yüklendi");
    });
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // Manuel yöneteceğiz
    });
    gisInited = true;
    console.log("GIS Yüklendi");
}

// 3. GİRİŞ / ÇIKIŞ İŞLEMLERİ
function handleAuthClick() {
    if (!tokenClient) {
        addNotification('warn', 'Yükleniyor', 'Google servisleri hazırlanıyor, bekleyin...');
        // Eğer yüklenmemişse tekrar dene
        if(typeof gapi !== 'undefined' && !gapiInited) gapiLoaded();
        if(typeof google !== 'undefined' && !gisInited) gisLoaded();
        return;
    }

    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            throw (resp);
        }
        updateDriveUI("Bağlandı ✅");
        addNotification('success', 'Başarılı', 'Google hesabına bağlandı.');
        
        // Token'ı gapi'ye ata
        gapi.client.setToken(resp);
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        updateDriveUI("Çıkış yapıldı.");
        addNotification('info', 'Çıkış', 'Bağlantı kesildi.');
    }
}

function updateDriveUI(msg) {
    const el = document.getElementById('drive-status');
    if(el) el.innerText = msg;
}

// 4. YEDEKLEME (UPLOAD) İŞLEMİ
async function uploadToDrive() {
    if(!gapi.client.getToken()) {
        addNotification('warn', 'Giriş Gerekli', 'Önce Google Giriş yapmalısınız.');
        handleAuthClick(); // Otomatik giriş penceresi aç
        return;
    }

    addNotification('info', 'Yedekleniyor', 'Veriler hazırlanıyor...');

    const backupData = {
        myPF_final: localStorage.getItem('myPF_final'),
        tm_cash_balance: localStorage.getItem('tm_cash_balance'),
        tm_full_trade_history: localStorage.getItem('tm_full_trade_history'),
        tm_user_profile: localStorage.getItem('tm_user_profile'),
        tm_watchlist: localStorage.getItem('tm_watchlist'),
        tm_settings: localStorage.getItem('tm_settings'),
        backup_date: new Date().toLocaleString()
    };

    const fileContent = JSON.stringify(backupData);
    const fileName = 'trademaster_backup.json';

    try {
        // Dosya ara
        const response = await gapi.client.drive.files.list({
            q: "name = '" + fileName + "' and trashed = false",
            fields: 'files(id, name)',
            spaces: 'drive'
        });

        const files = response.result.files;
        
        const fileMetadata = {
            'name': fileName,
            'mimeType': 'application/json'
        };

        const boundary = '-------314159265358979323846';
        const delimiter = "\r\n--" + boundary + "\r\n";
        const close_delim = "\r\n--" + boundary + "--";

        // Türkçe karakter sorunu için encode
        const base64Data = btoa(unescape(encodeURIComponent(fileContent)));

        const multipartRequestBody =
            delimiter +
            'Content-Type: application/json\r\n\r\n' +
            JSON.stringify(fileMetadata) +
            delimiter +
            'Content-Type: application/json\r\n' +
            'Content-Transfer-Encoding: base64\r\n' +
            '\r\n' +
            base64Data +
            close_delim;

        let request;

        if (files && files.length > 0) {
            // Güncelle
            const fileId = files[0].id;
            request = gapi.client.request({
                'path': '/upload/drive/v3/files/' + fileId,
                'method': 'PATCH',
                'params': {'uploadType': 'multipart'},
                'headers': { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
                'body': multipartRequestBody
            });
        } else {
            // Oluştur
            request = gapi.client.request({
                'path': '/upload/drive/v3/files',
                'method': 'POST',
                'params': {'uploadType': 'multipart'},
                'headers': { 'Content-Type': 'multipart/related; boundary="' + boundary + '"' },
                'body': multipartRequestBody
            });
        }

        await request;
        addNotification('success', 'Yedeklendi ☁️', 'Verileriniz Google Drive\'a kaydedildi.');

    } catch (err) {
        console.error("Drive Hatası:", err);
        addNotification('danger', 'Hata', 'Yedekleme başarısız oldu. Konsolu kontrol edin.');
    }
}

// 5. GERİ YÜKLEME (DOWNLOAD) İŞLEMİ
async function downloadFromDrive() {
    if(!gapi.client.getToken()) {
        addNotification('warn', 'Giriş Gerekli', 'Önce Google Giriş yapmalısınız.');
        handleAuthClick();
        return;
    }

    addNotification('info', 'Aranıyor', 'Yedek dosyası aranıyor...');

    try {
        const fileName = 'trademaster_backup.json';
        const response = await gapi.client.drive.files.list({
            q: "name = '" + fileName + "' and trashed = false",
            fields: 'files(id, name)',
            spaces: 'drive'
        });

        const files = response.result.files;

        if (files && files.length > 0) {
            const fileId = files[0].id;
            
            const fileRes = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });

            const data = fileRes.result;

            if(data.myPF_final) localStorage.setItem('myPF_final', data.myPF_final);
            if(data.tm_cash_balance) localStorage.setItem('tm_cash_balance', data.tm_cash_balance);
            if(data.tm_full_trade_history) localStorage.setItem('tm_full_trade_history', data.tm_full_trade_history);
            if(data.tm_user_profile) localStorage.setItem('tm_user_profile', data.tm_user_profile);
            if(data.tm_watchlist) localStorage.setItem('tm_watchlist', data.tm_watchlist);
            if(data.tm_settings) localStorage.setItem('tm_settings', data.tm_settings);

            if(confirm("Yedek başarıyla indirildi. Uygulama yeniden başlatılsın mı?")) {
                location.reload();
            } else {
                addNotification('success', 'Tamamlandı', 'Veriler yüklendi.');
                // Sayfayı yenilemeden verileri güncelle
                loadPF(true);
                renderHistory();
                loadProfile();
            }

        } else {
            addNotification('warn', 'Bulunamadı', 'Drive\'da yedek dosyası yok.');
        }

    } catch (err) {
        console.error("İndirme Hatası:", err);
        addNotification('danger', 'Hata', 'Veri indirilemedi.');
    }
}

/* --- HABER ARAMA MOTORU TAMİR KODU --- */

// 1. Arama Fonksiyonunu Tanımlayalım
function runNewsSearch() {
    const input = document.getElementById('newsSearchInput');
    const val = input.value.trim();
    
    // Boş veya çok kısaysa uyarı ver
    if (val.length < 2) {
        return addNotification('warn', 'Arama', 'Lütfen en az 2 karakter girin.');
    }
    
    // Klavyeyi kapat (Mobilde rahatlık sağlar)
    input.blur();

    // Filtre butonlarındaki aktifliği kaldır (Çünkü özel arama yapıyoruz)
    document.querySelectorAll('.nf-chip').forEach(c => c.classList.remove('active'));
    
    // Kullanıcıya bilgi ver
    addNotification('info', 'Aranıyor', `${val} hakkında haberler getiriliyor...`);
    
    // Sayacı sıfırla ve motoru çalıştır
    newsCountdown = 60; 
    
    // Cloudflare Worker'a sorguyu gönder
    loadNews(val);
}

// 2. Enter Tuşu Desteğini Garantiye Alalım
// Sayfa yüklendiğinde input'a olay dinleyicisi ekler
document.addEventListener("DOMContentLoaded", function() {
    const input = document.getElementById('newsSearchInput');
    if(input) {
        input.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault(); // Form göndermeyi engelle
                runNewsSearch(); // Aramayı başlat
            }
        });
    }
});

/* --- FINAL HOLDER ANALİZİ (AÇIKLAYICI METİNLER GERİ GELDİ) --- */
function calcHolderAnalysis() {
    // 1. Verileri Al
    let years = parseFloat(document.getElementById('hYear').value);
    let annualReturn = parseFloat(document.getElementById('hReturn').value);
    let annualInflation = parseFloat(document.getElementById('hInflation').value);
    
    if(!years || isNaN(annualReturn) || isNaN(annualInflation)) {
        alert("Lütfen tüm alanları doldurunuz.");
        return;
    }

    // Varlık Bilgisi
    let as = JSON.parse(localStorage.getItem('myPF_final'));
    let asset = as[currentSimAssetIndex];
    
    let totalCost = asset.buy * asset.amt;
    let currentVal = (asset.curr || asset.buy) * asset.amt;
    let sym = asset.origin === 'USD' ? '$' : '₺';

    let startPnL = currentVal - totalCost;
    let startPnLPercent = (startPnL / totalCost) * 100;

    // 2. Hesaplamalar
    let futureNominalValue = currentVal * Math.pow((1 + (annualReturn / 100)), years);
    let inflationAdjustedCost = totalCost * Math.pow((1 + (annualInflation / 100)), years);
    
    let gap = futureNominalValue - inflationAdjustedCost;
    let isProfitable = gap >= 0;
    let gapPercent = (gap / inflationAdjustedCost) * 100;

    // 3. UI Hazırlığı
    let box = document.getElementById('simResHolder');
    let verdictColor = isProfitable ? 'var(--success)' : 'var(--danger)';
    let verdictIcon = isProfitable ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-times-circle"></i>';
    let verdictText = isProfitable ? 'MANTIKLI (Kurtarıyor)' : 'MANTIKSIZ (Kurtarmıyor)';
    
    let verdictDesc = "";
    if (startPnL < 0 && !isProfitable) {
        verdictDesc = `Başlangıçtaki <b>%${Math.abs(startPnLPercent).toFixed(1)}</b> zararı ve enflasyonu kapatamıyor.`;
    } else if (startPnL < 0 && isProfitable) {
        verdictDesc = `<b>${years} yılda</b> hem zararı kapatıp hem enflasyonu yeniyor.`;
    } else if (isProfitable) {
        verdictDesc = `Yatırımın kârda ve enflasyonu eziyor.`;
    } else {
        verdictDesc = `Kârda olsan bile enflasyon daha hızlı koşuyor.`;
    }

    box.style.display = 'block';
    box.className = 'sim-result-box ' + (isProfitable ? 'profit' : 'loss');

    // 4. HTML ÇIKTISI (ORİJİNAL AÇIKLAYICI METİNLERLE)
    let htmlContent = `
        <div style="text-align:center; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.1);">
            <div style="font-size:14px; font-weight:800; color:${verdictColor}; letter-spacing:1px;">
                ${verdictIcon} ${verdictText}
            </div>
            <div style="font-size:10px; color:var(--text-sub); margin-top:4px;">${verdictDesc}</div>
        </div>

        <div style="background:rgba(255,255,255,0.05); border-radius:6px; padding:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-size:10px; color:var(--text-sub);">Şu Anki Durum:</div>
            <div style="font-size:11px; font-weight:700; color:${startPnL >= 0 ? 'var(--success)' : 'var(--danger)'};">
                ${startPnL >= 0 ? 'KÂRDA' : 'ZARARDA'} (%${startPnLPercent.toFixed(1)})
            </div>
        </div>

        <div class="sim-row">
            <span class="sim-lbl">Nominal Bakiye:</span>
            <span style="font-weight:700;">${sym}${futureNominalValue.toLocaleString(undefined, {maximumFractionDigits:0})}</span>
        </div>
        <div style="font-size:9px; color:var(--text-sub); text-align:right; margin-bottom:8px;">
            (Ekranda göreceğin rakam)
        </div>

        <div class="sim-row">
            <span class="sim-lbl">Enflasyon Maliyeti:</span>
            <span>${sym}${inflationAdjustedCost.toLocaleString(undefined, {maximumFractionDigits:0})}</span>
        </div>
        <div style="font-size:9px; color:var(--text-sub); text-align:right; margin-bottom:8px;">
            (Paranın değerini koruması için olması gereken)
        </div>

        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 10px; font-weight: 700; color: var(--text-sub); text-align: center; margin-bottom: 5px; text-transform: uppercase;">
                ALIM GÜCÜ FARKI
            </div>
            <div style="background: rgba(0,0,0,0.2); border: 1px dashed ${verdictColor}; border-radius: 8px; padding: 10px; text-align: center;">
                
                <div style="font-size: 10px; color: var(--text-sub); margin-bottom: 2px;">(Nominal Bakiye - Enflasyon Maliyeti)</div>
                
                <div style="font-size: 16px; font-weight: 800; color: ${verdictColor}; display: flex; align-items: center; justify-content: center; gap: 6px;">
                    <span>${gap >= 0 ? '+' : ''}${sym}${gap.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                    <span style="font-size: 13px; opacity: 0.8;">(%${Math.abs(gapPercent).toFixed(1)})</span>
                </div>
                
                <div style="font-size: 9px; color: var(--text-sub); margin-top: 4px;">
                    ${gap >= 0 ? 'Reel Kazanç (Kâr)' : 'Reel Kayıp (Erime)'}
                </div>
            </div>
        </div>
    `;

    box.innerHTML = htmlContent;
}

/* --- ANALİZ SAYFASI SEKME YÖNETİMİ (GÜNCELLENMİŞ) --- */
function switchAnTab(tab, btn) {
    // 1. Tüm sekmeleri gizle
    document.querySelectorAll('.an-view-section').forEach(el => el.style.display = 'none');
    
    // 2. İstenen sekmeyi göster
    const targetSection = document.getElementById('an-view-' + tab);
    if(targetSection) targetSection.style.display = 'block';
    
    // 3. Buton stillerini güncelle
    document.querySelectorAll('.s-tab').forEach(el => el.classList.remove('active'));
    if(btn) btn.classList.add('active');

    // 4. Fonksiyonları Gecikmeli Başlat
    setTimeout(() => {
        // EĞER KULLANICI BAŞKA SEKMEYE GEÇTİYSE İŞLEM YAPMA (HATAYI ÖNLER)
        if(document.getElementById('an-view-' + tab).style.display === 'none') return;

        if(tab === 'vision') {
            loadVisionData();      
            renderDailyChart();    
            updateGoalVisuals();   
        }
        if(tab === 'lab') {
            const netWorthEl = document.getElementById('anNetWorth');
            if(netWorthEl) {
                let currentNet = parseFloat(netWorthEl.innerText.replace(/[^0-9.-]+/g,"")) || 0;
                const labStart = document.getElementById('labStart');
                if(currentNet > 0 && labStart && !labStart.value) labStart.value = currentNet;
            }
        }
        
        // ---> GÜVENLİ ÇAĞRI <---
        if(tab === 'psycho') {
            calcPsychoAnalysis();
        }
        // -----------------------

    }, 100); 
}

/* --- HEDEFLERİM (VİZYON) MODÜLÜ - (FİNAL TAMİR) --- */

// 1. Grafik Nesnesini Güvenli Tanımla
if (typeof window.visionChartInstance === 'undefined') {
    window.visionChartInstance = null;
}

// YARDIMCI: Türkçe Sayı Düzeltici (50.000 -> 50000 / 50,5 -> 50.5)
function parseTurkishInput(val) {
    if (!val) return 0;
    let str = val.toString();
    // 1. Sadece nokta var (Örn: 50.000) -> Noktayı sil (Binlik)
    if (str.includes('.') && !str.includes(',')) {
        str = str.replace(/\./g, '');
    }
    // 2. Hem nokta hem virgül var (Örn: 50.000,50) -> Noktayı sil, virgülü nokta yap
    else if (str.includes('.') && str.includes(',')) {
        str = str.replace(/\./g, '').replace(',', '.');
    }
    // 3. Sadece virgül var -> Nokta yap
    else {
        str = str.replace(',', '.');
    }
    return parseFloat(str) || 0;
}

// 2. Ayarları Yükle
function loadVisionData() {
    try {
        // İki anahtarı da kontrol et (Eski/Yeni uyumluluğu)
        let data = JSON.parse(localStorage.getItem('tm_vision_settings')) || 
                   JSON.parse(localStorage.getItem('tm_vision_data')) || 
                   { rate: 5, add: 1000 };
        
        const elRate = document.getElementById('visionRate');
        const elAdd = document.getElementById('visionAdd');

        if(elRate) elRate.value = data.rate;
        if(elAdd) elAdd.value = data.add;
    } catch(e) { console.error(e); }
}

// 3. Buton Fonksiyonu (Hem kaydeder hem çizer)
function manualUpdateVision() {
    const elRate = document.getElementById('visionRate');
    const elAdd = document.getElementById('visionAdd');

    if(!elRate || !elAdd) return;

    // Türkçe karakter temizliği yaparak al
    let rateVal = parseTurkishInput(elRate.value);
    let addVal = parseTurkishInput(elAdd.value);

    // Ayarları kaydet (Standart anahtar: tm_vision_settings)
    let data = { rate: rateVal, add: addVal };
    localStorage.setItem('tm_vision_settings', JSON.stringify(data));

    // Grafiği çiz
    renderDailyChart(null, rateVal, addVal); 
    
    if(typeof addNotification === 'function') {
        addNotification('success', 'Hesaplandı', `Eklenen: ${addVal.toLocaleString()} | Kâr: %${rateVal}`);
    }
}

/* --- GÜNCELLENMİŞ VE AYRIŞTIRILMIŞ GRAFİK MOTORU --- */
let dailyChartInstance = null;

function renderDailyChart(logs, monthlyRate, monthlyAdd) {
    const ctx = document.getElementById('visionChart');
    if(!ctx) return; 

    const context = ctx.getContext('2d');

    // --- 1. Geçmiş Verileri Hazırla ---
    if(!logs) logs = JSON.parse(localStorage.getItem('tm_daily_tracking')) || [];
    let labels = logs.map(l => l.date.substring(0, 5));
    let actualData = logs.map(l => l.val);

    // --- 2. Parametreleri Al ---
    if (monthlyRate === undefined || monthlyRate === null) {
        const elRate = document.getElementById('visionRate');
        monthlyRate = elRate ? parseTurkishInput(elRate.value) : 5;
    }
    if (monthlyAdd === undefined || monthlyAdd === null) {
        const elAdd = document.getElementById('visionAdd');
        monthlyAdd = elAdd ? parseTurkishInput(elAdd.value) : 1000;
    }

    // --- 3. Başlangıç Değerini Belirle ---
    let startBalance = 0;
    if (actualData.length > 0) {
        startBalance = actualData[actualData.length - 1];
    } else {
        try {
            const nwEl = document.getElementById('anNetWorth');
            if(nwEl) startBalance = parseTurkishInput(nwEl.innerText.replace('₺', '').replace('$', ''));
        } catch(e) {}
        if(startBalance <= 0) startBalance = 1000; 
        
        labels.push("Bugün");
        actualData.push(startBalance);
    }

    // --- 4. AYRIŞTIRILMIŞ HESAPLAMA (30 GÜNLÜK) ---
    const dailyRate = monthlyRate / 30; 
    const dailyAdd = monthlyAdd / 30;

    let projectedData = []; // Mor Çizgi (Kâr + Anapara)
    let principalData = []; // Turuncu Çizgi (Sadece Anapara + Ekleme)

    let simBalance = startBalance;      // Bileşik faizli büyüyecek
    let principalBalance = startBalance; // Sadece ekleme ile büyüyecek (Faizsiz)

    for(let i=1; i<=30; i++) {
        // A) Sadece Anapara Hesabı (Kârı katma, sadece ekleneni topla)
        principalBalance = principalBalance + dailyAdd;

        // B) Toplam Büyüme Hesabı (Kârı da ekle, eklemeyi de ekle)
        simBalance = simBalance * (1 + (dailyRate/100)) + dailyAdd;
        
        projectedData.push(simBalance);
        principalData.push(principalBalance);

        if(i === 1) labels.push("Yarın");
        else if(i % 5 === 0) labels.push("+" + i + " Gün");
        else labels.push(""); 
    }

    // --- 5. Grafik Verilerini Birleştir ---
    // Actual Data bittiği yerden diğerleri başlasın diye null ekliyoruz
    let chartDataActual = [...actualData, ...Array(projectedData.length).fill(null)];
    
    // Tahmin çizgileri, son gerçek veriden başlayarak devam etsin
    let chartDataProjected = [...Array(actualData.length-1).fill(null), actualData[actualData.length-1], ...projectedData];
    let chartDataPrincipal = [...Array(actualData.length-1).fill(null), actualData[actualData.length-1], ...principalData];

    let target = parseFloat(localStorage.getItem('tradevia_main_goal')) || 1000000;
    let targetData = Array(labels.length).fill(target);

    // --- 6. Çizim ---
    if(dailyChartInstance) dailyChartInstance.destroy();

    dailyChartInstance = new Chart(context, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Mevcut Durum',
                    data: chartDataActual,
                    borderColor: '#3b82f6', // Mavi
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    pointRadius: 3,
                    fill: true,
                    order: 1
                },
                {
                    label: 'Toplam Hedef (Kâr Dahil)',
                    data: chartDataProjected,
                    borderColor: '#d946ef', // Mor (En üstte)
                    backgroundColor: 'rgba(217, 70, 239, 0.15)', // Mor Alan
                    borderWidth: 3,
                    pointRadius: 0,
                    fill: true, // Altını boya
                    tension: 0.4,
                    order: 2
                },
                {
                    label: 'Sadece Anapara (Kârsız)',
                    data: chartDataPrincipal,
                    borderColor: '#f97316', // Turuncu (Ortada)
                    borderWidth: 2,
                    borderDash: [5, 5], // Kesikli Çizgi
                    pointRadius: 0,
                    fill: false,
                    tension: 0.1,
                    order: 3
                },
                {
                    label: 'Hedef',
                    data: targetData,
                    borderColor: '#10b981', // Yeşil
                    borderWidth: 1,
                    borderDash: [2, 2],
                    pointRadius: 0,
                    fill: false,
                    order: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toLocaleString('tr-TR', {maximumFractionDigits: 0});
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: { grid: { display: false }, ticks: { color: '#64748b', font:{size:9}, maxTicksLimit: 7 } },
                y: { 
                    grid: { color: 'rgba(255,255,255,0.05)' }, 
                    ticks: { 
                        color: '#64748b', 
                        font:{size:10},
                        callback: function(value) {
                            if(value >= 1000000) return (value/1000000).toFixed(1) + 'M';
                            if(value >= 1000) return (value/1000).toFixed(0) + 'k';
                            return value;
                        }
                    } 
                }
            }
        }
    });
}

// 5. Uyumluluk (Eski isimler hata vermesin)
window.calcVision = renderDailyChart;
window.saveVisionData = manualUpdateVision;

// 6. Başlatma
document.addEventListener("DOMContentLoaded", function() {
    loadVisionData();
    // Sayfa tam oturunca grafiği çiz
    setTimeout(() => {
        let r = document.getElementById('visionRate') ? document.getElementById('visionRate').value : 5;
        let a = document.getElementById('visionAdd') ? document.getElementById('visionAdd').value : 0;
        renderDailyChart(null, parseTurkishInput(r), parseTurkishInput(a));
    }, 1500);
});


/* --- AR-GE (LAB) FİNAL FONKSİYONLAR (GÜNCELLENDİ: AKILLI VARLIK SEÇİMİ) --- */

// 1. ARAÇ GEÇİŞLERİ
function switchLabTool(tool, btn) {
    document.querySelectorAll('.lab-tool-container').forEach(el => el.style.display = 'none');
    document.getElementById('lab-tool-' + tool).style.display = 'block';
    
    if(btn) {
        const parent = btn.parentElement;
        parent.querySelectorAll('.chart-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    // Risk aracına geçince listeyi hazırla
    if(tool === 'risk') {
        populateRiskAssets(); 
        
        // Eğer kutu boşsa varsayılan olarak Nakit Bakiyeyi yaz (Boşta duran para)
        const inputBalance = document.getElementById('riskBalance');
        let storedCash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
        
        if(inputBalance && inputBalance.value === "") {
            inputBalance.value = Math.floor(storedCash);
            // Kullanıcı bilsin diye placeholder ekle
            inputBalance.placeholder = "Nakit veya Varlık Değeri";
        }
    }
}

// 2. LİSTEYİ DOLDUR (SIRA NUMARASI İLE)
function populateRiskAssets() {
    const selectBox = document.getElementById('riskAssetSelect');
    if(!selectBox) return;

    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    
    // Önce temizle
    selectBox.innerHTML = '<option value="-1">Manuel Giriş / Seçiniz</option>';
    
    if(as.length === 0) {
        let opt = document.createElement("option");
        opt.text = "(Portföy Boş)";
        selectBox.add(opt);
        return;
    }

    // Listeyi oluştur (Value olarak INDEX saklıyoruz ki tüm veriye ulaşalım)
    as.forEach((asset, index) => {
        let price = asset.curr || asset.buy;
        let sym = asset.origin === 'USD' ? '$' : '₺';
        
        let option = document.createElement("option");
        option.text = `${asset.name} (${asset.amt} Adet)`; // İsimde miktar görünsün
        option.value = index; // ÖNEMLİ: Fiyat değil, sıra no saklıyoruz
        selectBox.add(option);
    });
}
// ============================================================
// --- 3. BÖLÜM: LAB ARAÇLARI (RİSK, BÜYÜME, ORTALAMA) ---
// ============================================================

// 1. RİSK ANALİZİ İÇİN VARLIK VERİLERİNİ ÇEK (DÜZELTİLMİŞ & KUR ÇEVİRİLİ)
function fillRiskFromAsset() {
    let idx = document.getElementById('riskAssetSelect').value;
    
    // Eğer "Seçiniz" veya manuel seçildiyse dur
    if(idx == "-1") return;

    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let asset = as[idx]; // Seçilen varlık

    if(asset) {
        // A) Varlığın Orijinal Verilerini Al
        let rawPrice = asset.curr || asset.buy; 
        let amount = asset.amt;
        
        // B) Kur Bilgilerini Al
        let currentUsd = (typeof usdTryRate !== 'undefined') ? usdTryRate : 36.50;
        let myCurr = (typeof appSettings !== 'undefined') ? appSettings.currency : 'TRY';

        // C) DÖNÜŞÜM HESAPLAMALARI (HEM TOPLAM DEĞER HEM BİRİM FİYAT İÇİN)
        let totalValConverted = 0;
        let unitPriceConverted = 0;

        if(myCurr === 'TRY') {
            // Uygulama TL modundaysa
            if(asset.origin === 'USD') {
                totalValConverted = rawPrice * amount * currentUsd; // Toplam ($ -> TL)
                unitPriceConverted = rawPrice * currentUsd;         // Birim Fiyat ($ -> TL) [KRİTİK DÜZELTME]
            } else {
                totalValConverted = rawPrice * amount;
                unitPriceConverted = rawPrice;
            }
        } else {
            // Uygulama USD modundaysa
            if(asset.origin === 'TRY') {
                totalValConverted = (rawPrice * amount) / currentUsd; // Toplam (TL -> $)
                unitPriceConverted = rawPrice / currentUsd;           // Birim Fiyat (TL -> $) [KRİTİK DÜZELTME]
            } else {
                totalValConverted = rawPrice * amount;
                unitPriceConverted = rawPrice;
            }
        }

        // D) Kutuları Doldur
        const balInput = document.getElementById('riskBalance');
        const entryInput = document.getElementById('riskEntry');

        if(balInput) {
            balInput.value = totalValConverted.toFixed(2); 
            flashInput(balInput);
        }
        
        if(entryInput) {
            // Artık birim fiyat da dönüşmüş olarak geliyor
            entryInput.value = unitPriceConverted.toFixed(2); 
            flashInput(entryInput);
        }
    }
}

// Görsel Efekt Yardımcısı
function flashInput(el) {
    el.style.transition = "background 0.3s";
    el.style.background = "rgba(16, 185, 129, 0.2)"; // Yeşil yanıp sönme
    setTimeout(() => { el.style.background = ""; }, 500);
}

// 2. POZİSYON BÜYÜKLÜĞÜ VE RİSK HESAPLAYICI (STABİL)
function calcLabRisk() {
    let balance = parseFloat(document.getElementById('riskBalance').value);
    let riskPct = parseFloat(document.getElementById('riskPct').value);
    let entry = parseFloat(document.getElementById('riskEntry').value);
    let stop = parseFloat(document.getElementById('riskStop').value);

    if(isNaN(balance) || isNaN(riskPct) || isNaN(entry) || isNaN(stop)) return alert("Lütfen tüm alanları doldurun.");
    
    let riskAmount = balance * (riskPct / 100);
    let diffPerUnit = Math.abs(entry - stop); 
    
    if(diffPerUnit === 0) return alert("Giriş ve Stop fiyatı aynı olamaz.");

    let qty = riskAmount / diffPerUnit;
    let totalPosSize = qty * entry;
    
    // Portföydeki oranı
    let portfolioImpact = (totalPosSize / balance) * 100;

    // Para birimi simgesini ayarlardan çek
    let sym = (typeof appSettings !== 'undefined' && appSettings.currency === 'TRY') ? '₺' : '$';

    document.getElementById('resRiskQty').innerText = qty.toLocaleString(undefined, {maximumFractionDigits:2});
    document.getElementById('resRiskLoss').innerText = "-" + sym + riskAmount.toLocaleString(undefined, {maximumFractionDigits:2});
    document.getElementById('resPosSize').innerText = sym + totalPosSize.toLocaleString(undefined, {maximumFractionDigits:2});
    
    let warnEl = document.getElementById('riskWarning');
    let ratioText = document.getElementById('riskRatioText');
    
    if(ratioText) {
        let isManual = document.getElementById('riskAssetSelect') && document.getElementById('riskAssetSelect').value == "-1";
        
        if(portfolioImpact > 100 && isManual) {
            // Sadece manuel girişte ve para yetmiyorsa uyar
            warnEl.style.color = "var(--danger)";
            warnEl.style.border = "1px solid var(--danger)";
            ratioText.innerHTML = `<b>YETERSİZ BAKİYE:</b> %${portfolioImpact.toFixed(0)} gerekiyor.`;
        } else {
            // Portföyden seçildiyse sadece bilgi ver
            warnEl.style.color = "var(--text-sub)";
            warnEl.style.border = "none";
            ratioText.innerHTML = `Bu işlem sermayenin <b>%${portfolioImpact.toFixed(1)}</b> kadarını kapsar.`;
        }
    }
    document.getElementById('riskResultBox').style.display = 'block';
}

// 3. BİLEŞİK GETİRİ SİMÜLATÖRÜ (STABİL)
function runLabTest() {
    const elStart = document.getElementById('labStart');
    const elWin = document.getElementById('labWinPct');
    const elFreq = document.getElementById('labFreq');
    const elDur = document.getElementById('labDuration');

    if(!elStart || !elWin || !elFreq || !elDur) return;

    let start = parseFloat(elStart.value) || 1000;
    let winPct = parseFloat(elWin.value) || 2; 
    let freq = parseFloat(elFreq.value) || 1; 
    let duration = parseFloat(elDur.value) || 12; 

    let totalWeeks = duration * 4;
    let balance = start;
    let listHtml = ""; 
    let sym = (typeof appSettings !== 'undefined' && appSettings.currency === 'TRY') ? '₺' : '$';

    for(let i=1; i<=totalWeeks; i++) {
        for(let j=0; j<freq; j++) { balance = balance * (1 + (winPct/100)); }
        if(i % 4 === 0) {
            let month = i / 4;
            let profit = balance - start;
            listHtml += `<div class="lab-row"><div class="lab-col-left"><span class="lab-month-badge">${month}. AY</span><span class="lab-balance-val">${sym}${balance.toLocaleString(undefined, {maximumFractionDigits:0})}</span></div><div class="lab-col-right"><span class="lab-profit-lbl">NET KÂR</span><span class="lab-profit-val">+${sym}${profit.toLocaleString(undefined, {maximumFractionDigits:0})}</span></div></div>`;
        }
    }

    const resStart = document.getElementById('resLabStart');
    const resEnd = document.getElementById('resLabEnd');
    const resGrowth = document.getElementById('resLabGrowth');
    const listContainer = document.getElementById('labListContainer');
    const resBox = document.getElementById('labResults');

    if(resStart) resStart.innerText = sym + start.toLocaleString();
    if(resEnd) resEnd.innerText = sym + balance.toLocaleString(undefined, {maximumFractionDigits:0});
    if(resGrowth) {
        let growthPct = ((balance - start) / start) * 100;
        resGrowth.innerText = `%${growthPct.toFixed(0)} Büyüme`;
    }
    if(listContainer) listContainer.innerHTML = listHtml;
    
    if(resBox) {
        resBox.style.display = 'block';
        setTimeout(() => { resBox.scrollIntoView({behavior: "smooth", block: "start"}); }, 100);
    }
}

// 4. MALİYET DÜŞÜRME HESAPLAYICI (STABİL)
function calcLabAvg() {
    let oldQty = parseFloat(document.getElementById('avgOldQty').value);
    let oldPrice = parseFloat(document.getElementById('avgOldPrice').value);
    let newPrice = parseFloat(document.getElementById('avgNewPrice').value);
    let newQty = parseFloat(document.getElementById('avgNewQty').value);

    if(isNaN(oldQty) || isNaN(oldPrice) || isNaN(newPrice) || isNaN(newQty)) {
        return alert("Lütfen tüm alanları doldurun.");
    }

    let oldTotal = oldQty * oldPrice;
    let newTotal = newQty * newPrice;
    let totalQty = oldQty + newQty;
    let grandTotal = oldTotal + newTotal;
    let newAvg = grandTotal / totalQty;

    let sym = (typeof appSettings !== 'undefined' && appSettings.currency === 'TRY') ? '₺' : '$';

    document.getElementById('resAvgNew').innerText = sym + newAvg.toFixed(2);
    document.getElementById('resAvgTotalQty').innerText = totalQty;
    document.getElementById('resAvgTotalCost').innerText = sym + grandTotal.toLocaleString(undefined, {maximumFractionDigits:2});
    document.getElementById('avgResultBox').style.display = 'block';
}

/* --- YENİ DİNAMİK HEDEF VE GÜNLÜK TAKİP SİSTEMİ (FİNAL) --- */

function updateGoalVisuals() {
    let target = parseFloat(localStorage.getItem('tradevia_main_goal')) || 1000000;
    
    // Toplam Varlığı Hesapla (Nakit + Portföy)
    let totalBalance = 0;
    let pf = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let currentUsd = (typeof usdTryRate !== 'undefined') ? usdTryRate : 36.50; 
    let appCurr = (typeof appSettings !== 'undefined') ? appSettings.currency : 'TRY';
    let cash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;

    pf.forEach(item => {
        let p = item.curr || item.buy;
        if(appCurr === 'TRY') {
            totalBalance += (item.origin === 'USD') ? (p * item.amt * currentUsd) : (p * item.amt);
        } else {
            totalBalance += (item.origin === 'TRY') ? ((p * item.amt) / currentUsd) : (p * item.amt);
        }
    });
    totalBalance += cash;

    // Yüzde Hesapla
    let pct = Math.min(100, Math.max(0, (totalBalance / target) * 100));
    let sym = appCurr === 'TRY' ? '₺' : '$';

    // HTML Elementlerini Seç
    const bar = document.getElementById('dynamicGoalBar');
    const currentTextEl = document.getElementById('goalCurrentText');
    const targetTextEl = document.getElementById('goalTargetTextRight');
    
    // Bar ve Yazıları Güncelle
    if(bar && targetTextEl && currentTextEl) {
        // Genişlik
        bar.style.width = pct + "%";
        
        // Renk
        bar.className = 'goal-strip-fill'; 
        if(pct < 33) bar.classList.add('gs-red');
        else if(pct < 66) bar.classList.add('gs-yellow');
        else bar.classList.add('gs-green');

        // Sol Yazı: % ve Mevcut Tutar
        currentTextEl.innerText = `%${pct.toFixed(1)} (${sym}${totalBalance.toLocaleString(undefined, {maximumFractionDigits:0})})`;
        
        // Sağ Yazı: Hedef Tutarı
        targetTextEl.innerText = `HEDEF: ${sym}${target.toLocaleString(undefined, {maximumFractionDigits:0})}`;
    }
    
    // Günlük kayıt sistemini tetikle (Grafik için)
    if(typeof checkAndLogDaily === 'function') {
        checkAndLogDaily(totalBalance); 
    }
}

// 2. Hedef Düzenleme
function editTargetGoal() {
    let current = localStorage.getItem('tradevia_main_goal') || 1000000;
    let val = prompt("Yeni Hedef Tutarınız:", current);
    if(val && !isNaN(val)) {
        localStorage.setItem('tradevia_main_goal', val);
        updateGoalVisuals();
        renderDailyChart(); 
    }
}

// 3. Günlük Kayıt Sistemi (Canlı Takip)
function checkAndLogDaily(currentTotal) {
    let logs = JSON.parse(localStorage.getItem('tm_daily_tracking')) || [];
    let today = new Date().toLocaleDateString('tr-TR');
    
    let lastLog = logs.length > 0 ? logs[logs.length - 1] : null;
    
    if (!lastLog || lastLog.date !== today) {
        logs.push({ date: today, val: currentTotal });
        if(logs.length > 30) logs.shift();
    } else {
        lastLog.val = currentTotal;
    }
    
    localStorage.setItem('tm_daily_tracking', JSON.stringify(logs));
    
    renderDailyList(logs);
    renderDailyChart(logs);
}

// 4. Liste Fonksiyonu (SADECE GÜNLÜK KÂR/ZARAR FARKI)
function renderDailyList(logs) {
    const list = document.getElementById('dailyLogList');
    if(!list) return;
    
    let html = "";
    // Para birimi simgesi
    let sym = (typeof appSettings !== 'undefined' && appSettings.currency === 'TRY') ? '₺' : '$';

    // Döngüyü tersten kuruyoruz (En yeni tarih en üstte olsun)
    for (let i = logs.length - 1; i >= 0; i--) {
        let currentLog = logs[i];
        
        // Bir önceki günü bul (Eğer i=0 ise yani ilk kayıtsa öncesi yoktur)
        let prevLog = (i > 0) ? logs[i-1] : null; 
        
        let resultHtml = "";
        
        if(prevLog) {
            // BUGÜNKÜ TOPLAM - DÜNKÜ TOPLAM = GÜNLÜK FARK (KÂR/ZARAR)
            let diff = currentLog.val - prevLog.val;
            
            // Renk ve İşaret Ayarı
            let color = diff >= 0 ? '#10b981' : '#ef4444'; // Yeşil veya Kırmızı
            let sign = diff > 0 ? '+' : ''; // Pozitifse + koy, negatifse zaten eksi çıkar
            
            // Ekrana SADECE aradaki farkı basıyoruz (Toplam bakiye görünmez)
            resultHtml = `<span style="color:${color}; font-weight:800; font-size:13px;">${sign}${sym}${diff.toLocaleString(undefined, {maximumFractionDigits:0})}</span>`;
        } else {
            // İlk kayıt ise kıyaslanacak bir dün olmadığı için nötr bırakıyoruz
            resultHtml = `<span style="color:var(--text-sub); font-size:11px; opacity:0.7;">(Başlangıç)</span>`;
        }

        html += `
        <div class="daily-log-row">
            <span class="log-date">${currentLog.date}</span>
            ${resultHtml}
        </div>`;
    }
    
    if(html === "") html = "<div style='text-align:center; padding:15px; color:var(--text-sub); font-size:11px;'>Henüz kayıt yok.</div>";
    list.innerHTML = html;
}


/* --- YENİ PROJEKSİYON BUTONU FONKSİYONU --- */
function manualUpdateVision() {
    // 1. Kutulardaki değerleri al
    const rate = document.getElementById('visionRate').value;
    const add = document.getElementById('visionAdd').value;

    // 2. Hafızaya kaydet (Sayfayı yenileyince gitmesin)
    const settings = { rate: rate, add: add };
    localStorage.setItem('tm_vision_settings', JSON.stringify(settings));

    // 3. Grafiği çizdir (Mevcut fonksiyonu çağırıyoruz)
    if(typeof renderDailyChart === 'function') {
        renderDailyChart();
        addNotification('success', 'Güncellendi', 'Grafik yeni ayarlara göre çizildi.');
    } else {
        alert("Grafik fonksiyonu bulunamadı!");
    }
}

/* --- AYARLARI HATIRLAMASI İÇİN BUNU DA EKLE --- */
// Sayfa açıldığında eski ayarları kutulara geri doldurur
document.addEventListener("DOMContentLoaded", function() {
    const saved = JSON.parse(localStorage.getItem('tm_vision_settings'));
    if(saved) {
        if(document.getElementById('visionRate')) document.getElementById('visionRate').value = saved.rate;
        if(document.getElementById('visionAdd')) document.getElementById('visionAdd').value = saved.add;
    }
});

/* --- KAOS SİMÜLASYON MOTORU --- */
function runChaosSimulation() {
    let scenario = document.getElementById('chaosScenario').value;
    if(scenario === "0") {
        document.getElementById('chaosResult').style.display = 'none';
        return;
    }

    // 1. Mevcut Portföyü Çek
    let as = JSON.parse(localStorage.getItem('myPF_final')) || [];
    let cash = parseFloat(localStorage.getItem('tm_cash_balance')) || 0;
    
    // Anlık Kurları Al (Global değişkenlerden)
    let currentUsd = (typeof usdTryRate !== 'undefined') ? usdTryRate : 36.50;
    let appCurr = (typeof appSettings !== 'undefined') ? appSettings.currency : 'TRY';
    let sym = appCurr === 'TRY' ? '₺' : '$';

    // 2. Senaryo Etkileri (Çarpanlar)
    // 1.0 = Değişim yok, 0.5 = %50 düşüş, 1.5 = %50 artış
    const impacts = {
        'crypto_winter': { crypto: 0.40, bist: 0.90, gold: 1.00, forex: 1.00, cash: 1.00 }, // Kripto %60 erir
        'market_crash':  { crypto: 0.70, bist: 0.65, gold: 1.10, forex: 1.05, cash: 1.00 }, // Borsa %35 çöküş, Altın artar
        'currency_shock':{ crypto: 1.40, bist: 1.20, gold: 1.40, forex: 1.40, cash: 1.00 }, // Dolar bazlı her şey artar (TL kullanıcısı için)
        'gold_rush':     { crypto: 0.90, bist: 0.90, gold: 1.25, forex: 1.00, cash: 1.00 }, // Altın rallisi
        'black_monday':  { crypto: 0.80, bist: 0.80, gold: 0.80, forex: 0.80, cash: 1.00 }  // Nakit hariç her şey düşer
    };

    let selectedImpact = impacts[scenario];
    let currentTotal = 0;
    let simulatedTotal = 0;

    // 3. Hesaplama Döngüsü
    as.forEach(asset => {
        // Varlığın şu anki değerini hesapla
        let price = asset.curr || asset.buy;
        let val = 0;

        if(appCurr === 'TRY') {
            val = (asset.origin === 'USD') ? (price * asset.amt * currentUsd) : (price * asset.amt);
        } else {
            val = (asset.origin === 'TRY') ? ((price * asset.amt) / currentUsd) : (price * asset.amt);
        }
        
        currentTotal += val;

        // Varlığın Türünü Bul (Senaryo için)
        let tagData = getAssetTag(asset.name); // Mevcut fonksiyonunu kullanıyoruz
        let type = 'bist'; // Varsayılan
        
        if(tagData.t === 'KRİPTO') type = 'crypto';
        else if(tagData.t === 'EMTİA') type = 'gold';
        else if(tagData.t === 'DÖVİZ') type = 'forex';
        
        // Simüle edilmiş değer
        let multiplier = selectedImpact[type];
        simulatedTotal += val * multiplier;
    });

    // Nakit Etkisi
    currentTotal += cash;
    simulatedTotal += cash * selectedImpact.cash; // Genelde nakit sabittir ama enflasyon senaryosu eklenebilir

    // 4. Sonuçları Göster
    let diff = simulatedTotal - currentTotal;
    let diffPercent = (currentTotal > 0) ? (diff / currentTotal) * 100 : 0;
    
    // UI Güncelleme
    document.getElementById('chaosBalance').innerText = sym + simulatedTotal.toLocaleString(undefined, {maximumFractionDigits:0});
    
    const bar = document.getElementById('chaosBar');
    const txt = document.getElementById('chaosChangeText');
    const advice = document.getElementById('chaosAdvice');

    if(diff >= 0) {
        bar.style.width = "100%";
        bar.style.background = "#10b981"; // Yeşil
        txt.innerText = `Dayanıklı: +${sym}${diff.toLocaleString(undefined, {maximumFractionDigits:0})} (+%${diffPercent.toFixed(1)})`;
        advice.innerHTML = "Portföyün bu senaryodan <b>kârlı</b> çıkıyor. Kriz fırsata dönüşebilir.";
    } else {
        // Zarar barı hesapla (Görsel olarak %100'den düşür)
        let width = Math.max(10, 100 - Math.abs(diffPercent)); 
        bar.style.width = width + "%";
        bar.style.background = "#ef4444"; // Kırmızı
        txt.innerText = `Erime: ${diffPercent.toFixed(1)}% (${sym}${Math.abs(diff).toLocaleString(undefined, {maximumFractionDigits:0})})`;
        
        // Dinamik Tavsiye
        if(Math.abs(diffPercent) > 30) advice.innerHTML = "<b>KRİTİK RİSK!</b> Bu senaryo gerçekleşirse varlıkların ciddi erir. Nakit veya Altın oranını artırmayı düşün.";
        else advice.innerHTML = "Portföyün darbe alıyor ama hayatta kalır. Risk dağılımını gözden geçir.";
    }

    document.getElementById('chaosResult').style.display = 'block';
}


/* --- GÜNCELLENMİŞ PSİKOLOJİ ANALİZİ (FİNAL: KÂR/ZARAR ETİKETLİ) --- */
let isPsychoAnalyzing = false;

async function calcPsychoAnalysis() {
    if(isPsychoAnalyzing) return;
    isPsychoAnalyzing = true;

    try {
        let history = JSON.parse(localStorage.getItem('tm_full_trade_history')) || [];
        
        // Tarihe göre sırala
        history.sort((a, b) => {
            let da = convertToDate(a.date);
            let db = convertToDate(b.date);
            return da - db;
        });

        let sales = history.filter(t => t.type === 'SATIM');
        
        const regretListEl = document.getElementById('regretList');
        const holdListEl = document.getElementById('holdListDetailed');

        if(regretListEl) regretListEl.innerHTML = '<div style="text-align:center; padding:10px;"><i class="fas fa-circle-notch fa-spin"></i> Analiz ediliyor...</div>';
        
        let regretHTML = "";
        let holdHTML = "";
        let panicSales = 0;
        let fomoBuys = 0;
        
        // --- 1. REGRET & PANİK & KÂR ANALİZİ ---
        let recentSales = [...sales].reverse().slice(0, 10);
        let currentUsdRate = (typeof usdTryRate !== 'undefined') ? usdTryRate : 36.50;
        
        for (let t of recentSales) {
             if(document.getElementById('an-view-psycho').style.display === 'none') break;

             let currentData = { price: 0 };
             try { currentData = await getPrice(t.sym); } catch(e){}
             
             let currentPrice = currentData.price;
             let appSym = appSettings.currency === 'TRY' ? '₺' : '$';

             if (currentPrice > 0) {
                let soldPrice = parseFloat(t.price);
                let soldTotal = t.total ? parseFloat(t.total) : (soldPrice * t.qty);
                let currentTotalIfHeld = t.qty * currentPrice;
                
                // 1. PİŞMANLIK FARKI (Current - Sold)
                let diff = currentTotalIfHeld - soldTotal;

                // Para birimi dönüşümü (Pişmanlık hesabı için)
                let transCurr = t.curr || 'TRY'; 
                if (appSettings.currency === 'TRY' && transCurr === 'USD') diff *= currentUsdRate;
                else if (appSettings.currency === 'USD' && transCurr === 'TRY') diff /= currentUsdRate;

                // 2. GERÇEKLEŞEN KÂR (Sold - Buy)
                let realizedPnL = t.pnl ? parseFloat(t.pnl) : 0;
                // Kârı da uygulama para birimine çevir
                if (appSettings.currency === 'TRY' && transCurr === 'USD') realizedPnL *= currentUsdRate;
                else if (appSettings.currency === 'USD' && transCurr === 'TRY') realizedPnL /= currentUsdRate;

                // --- DÜZELTME BURADA: "KÂR" veya "ZARAR" YAZISI ---
                let pnlColor = realizedPnL >= 0 ? '#4ade80' : '#f87171'; // Yeşil veya Kırmızı
                let pnlLabel = realizedPnL >= 0 ? 'Kâr' : 'Zarar';       // Kelime Seçimi
                let pnlSign = realizedPnL >= 0 ? '+' : '-';              // İşaret Seçimi

                let pnlText = `<span style="color:${pnlColor}; font-weight:700; font-size:10px;">(${pnlLabel}: ${pnlSign}${appSym}${Math.abs(realizedPnL).toLocaleString(undefined, {maximumFractionDigits:0})})</span>`;

                // Kart Yapısı
                if (diff > 0) {
                    // Fiyat Artmış -> Kaçan Fırsat
                    let status = realizedPnL > 0 ? "Erken Çıkış" : "Kaçan Fırsat";
                    
                    regretHTML += `
                    <div class="regret-item missed">
                        <div class="ri-left">
                            <span class="ri-sym">${t.sym} ${pnlText}</span>
                            <span class="ri-date">Satış: ${soldPrice.toFixed(2)} | Şu An: ${currentPrice.toFixed(2)}</span>
                        </div>
                        <div class="ri-right">
                            <span class="ri-val" style="color:var(--danger)">-${appSym}${Math.abs(diff).toLocaleString(undefined, {maximumFractionDigits:0})}</span>
                            <span class="ri-badge">${status}</span>
                        </div>
                    </div>`;
                } else {
                    // Fiyat Düşmüş veya Aynı -> İyi ki Satmışsın / Nötr
                    let statusText = diff === 0 ? "Nötr" : "Zarardan Kurtuluş";
                    let valColor = diff === 0 ? "var(--text-sub)" : "var(--success)";
                    
                    regretHTML += `
                    <div class="regret-item saved">
                        <div class="ri-left">
                            <span class="ri-sym">${t.sym} ${pnlText}</span>
                            <span class="ri-date">Satış: ${soldPrice.toFixed(2)} | Şu An: ${currentPrice.toFixed(2)}</span>
                        </div>
                        <div class="ri-right">
                            <span class="ri-val" style="color:${valColor}">+${appSym}${Math.abs(diff).toLocaleString(undefined, {maximumFractionDigits:0})}</span>
                            <span class="ri-badge" style="background:rgba(16, 185, 129, 0.15); color:${valColor}">${statusText}</span>
                        </div>
                    </div>`;
                }

                // Panik Analizi
                let cost = parseFloat(t.avgCost) || 0;
                if(cost > 0) {
                    let lossPct = ((soldPrice - cost) / cost) * 100;
                    if(lossPct < -5 && currentPrice > soldPrice) panicSales++;
                }
             }
        }
        if(regretListEl) regretListEl.innerHTML = regretHTML || "<div style='text-align:center; font-size:11px; color:var(--text-sub); padding:10px;'>Veri yok.</div>";

        // --- 2. FOMO ANALİZİ ---
        let buys = history.filter(t => t.type === 'ALIM');
        for (let b of buys) {
            let bDate = convertToDate(b.date);
            let prevSell = sales.find(s => s.sym === b.sym && convertToDate(s.date) < bDate);
            if(prevSell && parseFloat(b.price) > parseFloat(prevSell.price) * 1.15) {
                fomoBuys++;
            }
        }

        // --- 3. DETAYLI SABIR (HOLD) ANALİZİ ---
        let reversedSales = [...sales].reverse();
        let totalHoldScore = 0;
        let holdCount = 0;

        for (let s of reversedSales) {
            let sellDate = convertToDate(s.date);
            let relatedBuys = history.filter(h => h.type === 'ALIM' && h.sym === s.sym && convertToDate(h.date) <= sellDate);
            
            if(relatedBuys.length > 0) {
                let matchingBuy = relatedBuys[relatedBuys.length - 1]; 
                let buyDate = convertToDate(matchingBuy.date);
                let diffTime = Math.abs(sellDate - buyDate);
                let diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                
                let dayText = diffDays === 0 ? "Gün İçi (Scalp)" : diffDays + " Gün";
                let badgeClass = "rank-bronze"; 
                let badgeText = "KISA VADE";
                let barColor = "#ef4444"; 
                
                if(diffDays > 365) { badgeClass = "rank-gold"; badgeText = "HODL (UZUN)"; barColor = "#10b981"; } 
                else if (diffDays > 30) { badgeClass = "rank-silver"; badgeText = "ORTA VADE"; barColor = "#f59e0b"; }

                holdHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid rgba(255,255,255,0.05);">
                    <div style="display:flex; align-items:center; gap:10px;">
                        ${getAssetLogoHtml(s.sym)}
                        <div>
                            <div style="font-weight:800; font-size:13px; color:white;">${s.sym}</div>
                            <div style="font-size:10px; color:var(--text-sub);">Satış: ${s.date}</div>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:800; font-size:14px; color:${barColor};">${dayText}</div>
                        <span style="font-size:9px; padding:2px 6px; background:rgba(255,255,255,0.05); border-radius:4px; margin-top:2px; display:inline-block;">${badgeText}</span>
                    </div>
                </div>`;
                
                totalHoldScore += diffDays;
                holdCount++;
            }
        }

        if(holdListEl) holdListEl.innerHTML = holdHTML || "<div style='text-align:center; padding:20px; color:var(--text-sub);'>Henüz tamamlanmış işlem yok.</div>";

        // --- 4. SKORLAMA VE GÖSTERGELER ---
        if(document.getElementById('panicCount')) document.getElementById('panicCount').innerText = panicSales;
        if(document.getElementById('fomoCount')) document.getElementById('fomoCount').innerText = fomoBuys;

        let score = 100;
        score -= (panicSales * 15);
        score -= (fomoBuys * 10);
        let avgDays = holdCount > 0 ? (totalHoldScore / holdCount) : 0;
        if(holdCount > 5 && avgDays < 5) score -= 10; 
        if(score < 0) score = 0;

        if(document.getElementById('psyScore')) {
            document.getElementById('psyScore').innerText = score;
            document.getElementById('psyScoreBar').style.width = score + "%";
            let statusEl = document.getElementById('psyStatus');
            let emojiEl = document.getElementById('psyEmoji');
            
            if(score >= 80) { statusEl.innerText = "Çelik Gibi Sinirler"; statusEl.style.color = "#10b981"; emojiEl.innerText = "🧘‍♂️"; }
            else if (score >= 50) { statusEl.innerText = "Duygusal Kararlar"; statusEl.style.color = "#f59e0b"; emojiEl.innerText = "🤔"; }
            else { statusEl.innerText = "Yüksek Stres / Panik"; statusEl.style.color = "#ef4444"; emojiEl.innerText = "🤯"; }
        }

    } catch (e) {
        console.error("Analiz Hatası:", e);
    } finally {
        isPsychoAnalyzing = false;
    }
}
/* --- ZAMAN MAKİNESİ FİNAL MOTORU (AUTO-CURRENCY) --- */

// ABD Enflasyon Verisi (Motor Dolar çalıştığı için ABD verisi şart)
const statCpiData = {
    2025: 2.5, 2024: 3.4, 2023: 3.4, 2022: 6.5, 2021: 7.0, 
    2020: 1.4, 2019: 2.3, 2018: 1.9, 2017: 2.1, 2016: 2.1, 2015: 0.1, 2014: 1.6
};

// 1. ANA TETİKLEYİCİ
async function runStatisticalAnalysis() {
    let rawSymbol = document.getElementById('statSymbol').value.toUpperCase().trim();
    if(!rawSymbol) return addNotification('warn', 'Hata', 'Lütfen bir sembol girin.');

    const resultDiv = document.getElementById('statResult');
    const tableBody = document.getElementById('statTableBody');
    const projList = document.getElementById('projectionList');

    // Temizle ve Yükleniyor Göster
    resultDiv.style.display = 'block';
    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:20px; color:#94a3b8;"><i class="fas fa-circle-notch fa-spin"></i> Veriler analiz ediliyor...</td></tr>';
    projList.innerHTML = '';

    // A PLAN: CoinGecko (Gerçek Market Cap için öncelikli)
    try {
        await tryCoinGecko(rawSymbol);
        addNotification('success', 'Veri', 'CoinGecko üzerinden analiz yapıldı.');
    } catch (cgError) {
        console.warn("CG Hatası:", cgError);
        
        // B PLAN: Binance (Yedek - Market Cap eksik gelir)
        try {
            await tryBinance(rawSymbol);
            addNotification('info', 'Yedek', 'CoinGecko yanıt vermedi, Binance verisi kullanılıyor.');
        } catch (binError) {
            tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px; color:#ef4444;">
                <i class="fas fa-exclamation-triangle"></i> Veri bulunamadı.
            </td></tr>`;
        }
    }
}

// 2. COINGECKO ENTEGRASYONU
async function tryCoinGecko(symbol) {
    let cleanSym = symbol.replace('USDT', '').replace('TRY', '');
    
    // ID Bul
    const searchRes = await fetch(`https://api.coingecko.com/api/v3/search?query=${cleanSym}`);
    if(!searchRes.ok) throw new Error("Arama başarısız");
    const searchData = await searchRes.json();
    
    if(!searchData.coins || searchData.coins.length === 0) throw new Error("Coin yok");
    
    let coinId = searchData.coins[0].id;
    const exactMatch = searchData.coins.find(c => c.symbol.toUpperCase() === cleanSym);
    if(exactMatch) coinId = exactMatch.id;

    // Tarihçe Çek (Dolar bazlı gelir)
    const historyRes = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=max&interval=daily`);
    const data = await historyRes.json();

    if(!data.prices || data.prices.length === 0) throw new Error("Fiyat verisi yok");

    processAndRenderCompact(data.prices, data.market_caps, data.total_volumes); 
}

// 3. BINANCE ENTEGRASYONU
async function tryBinance(symbol) {
    let binSymbol = symbol.endsWith('USDT') ? symbol : symbol + 'USDT';
    
    const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${binSymbol}&interval=1M&limit=120`);
    if (!response.ok) throw new Error("Binance başarısız");
    const data = await response.json();

    let prices = data.map(d => [d[0], parseFloat(d[4])]); 
    let volumes = data.map(d => [d[0], parseFloat(d[7])]); 
    let mcaps = null; // Binance mcap vermez

    processAndRenderCompact(prices, mcaps, volumes);
}

// 4. İŞLEME VE GÖRÜNTÜLEME MOTORU (HACİM + RİSK + ANOMALİ UYARISI)
function processAndRenderCompact(priceData, mcapData, volData) {
    const tableBody = document.getElementById('statTableBody');
    const projList = document.getElementById('projectionList');
    
    let isTR = (typeof appSettings !== 'undefined' && appSettings.currency === 'TRY');
    let currencyRate = (typeof usdTryRate !== 'undefined') ? usdTryRate : 36.50;
    let sym = isTR ? '₺' : '$';

    let yearlyStats = {};
    let dailyChanges = []; // Anlık sapmaları yakalamak için

    // --- A) VERİ İŞLEME VE ANOMALİ TESPİTİ ---
    for(let i=0; i<priceData.length; i++) {
        let timestamp = priceData[i][0];
        let priceUSD = priceData[i][1]; 
        let mcapUSD = (mcapData && mcapData[i]) ? mcapData[i][1] : 0;
        let volUSD = (volData && volData[i]) ? volData[i][1] : 0;
        
        // Günlük değişim hesapla (Sapma analizi için)
        if(i > 0) {
            let prevPrice = priceData[i-1][1];
            let dailyChange = ((priceUSD - prevPrice) / prevPrice) * 100;
            dailyChanges.push(dailyChange);
        }

        let year = new Date(timestamp).getFullYear();

        if(!yearlyStats[year]) {
            yearlyStats[year] = { 
                close: priceUSD, high: priceUSD, low: priceUSD, 
                mcap: mcapUSD, vol: volUSD, volCount: 1, lastDate: timestamp 
            };
        } else {
            if(priceUSD > yearlyStats[year].high) yearlyStats[year].high = priceUSD;
            if(priceUSD < yearlyStats[year].low) yearlyStats[year].low = priceUSD;
            
            yearlyStats[year].vol += volUSD;
            yearlyStats[year].volCount++;

            if(timestamp > yearlyStats[year].lastDate) {
                yearlyStats[year].close = priceUSD;
                yearlyStats[year].mcap = mcapUSD;
                yearlyStats[year].lastDate = timestamp;
            }
        }
    }

    // --- SAPMA (ANOMALİ) HESAPLAMASI ---
    // Standart Sapma: Fiyatın "norm"dan ne kadar saptığını bulur.
    let mean = dailyChanges.reduce((a,b)=>a+b, 0) / dailyChanges.length;
    let variance = dailyChanges.reduce((a,b)=>a + Math.pow(b-mean, 2), 0) / dailyChanges.length;
    let stdDev = Math.sqrt(variance); // Standart Sapma Değeri

    // Anomali Sınırları (2 Sigma Kuralı: %95 ihtimalle fiyat bu aralıkta kalmalı)
    let shockThreshold = stdDev * 2; 
    
    // Geçmişte kaç kez "Şok" yaşanmış?
    let crashEvents = dailyChanges.filter(c => c < -shockThreshold).length;
    let pumpEvents = dailyChanges.filter(c => c > shockThreshold).length;
    let riskLabel = "Düşük";
    let riskColor = "#10b981";

    if(stdDev > 5) { riskLabel = "Aşırı Yüksek"; riskColor = "#ef4444"; }
    else if(stdDev > 3) { riskLabel = "Yüksek"; riskColor = "#f59e0b"; }
    else if(stdDev > 1.5) { riskLabel = "Orta"; riskColor = "#3b82f6"; }

    // --- B) TABLO ÇİZİMİ ---
    let years = Object.keys(yearlyStats).sort((a,b) => b-a);
    let html = "";
    let pullbacks = []; 
    let volumeTrend = [];

    for (let i = 0; i < years.length - 1; i++) {
        let y = years[i];
        let yPrev = years[i+1];
        let curr = yearlyStats[y];
        let prev = yearlyStats[yPrev];
        
        let avgVol = curr.vol / curr.volCount;
        curr.avgVol = avgVol; 
        volumeTrend.push(avgVol);

        let changePct = ((curr.close - prev.close) / prev.close) * 100;
        let yearlyDrawdown = ((curr.high - curr.low) / curr.high); 
        pullbacks.push(yearlyDrawdown);

        let inf = statCpiData[y] || 2.5;
        let realReturn = changePct - inf;

        let displayClose = isTR ? curr.close * currencyRate : curr.close;
        let displayHigh = isTR ? curr.high * currencyRate : curr.high;
        let displayLow = isTR ? curr.low * currencyRate : curr.low;
        let mcapStr = (curr.mcap > 1e9) ? (curr.mcap/1e9).toFixed(1)+"Mr" : (curr.mcap/1e6).toFixed(1)+"Mn";
        let volStr = (avgVol > 1e9) ? (avgVol/1e9).toFixed(1)+"Mr" : (avgVol/1e6).toFixed(1)+"Mn";
        let realColor = realReturn >= 0 ? '#10b981' : '#ef4444';
        
        html += `
        <tr style="border-bottom:1px solid rgba(255,255,255,0.05); text-align:right;">
            <td style="padding:6px 4px; font-weight:700; text-align:left; color:#a78bfa;">${y}</td>
            <td style="padding:6px 4px; color:white; font-weight:700;">${sym}${displayClose.toLocaleString(undefined, {maximumFractionDigits:2})}</td>
            <td style="padding:6px 4px; color:#10b981;">${sym}${displayHigh.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
            <td style="padding:6px 4px; color:#ef4444;">${sym}${displayLow.toLocaleString(undefined, {maximumFractionDigits:0})}</td>
            <td style="padding:6px 4px; color:#f59e0b; font-weight:600;">${mcapStr}</td>
            <td style="padding:6px 4px; color:#38bdf8;">${volStr}</td>
            <td style="padding:6px 4px; color:${realColor}; font-weight:700;">%${realReturn.toFixed(0)}</td>
        </tr>`;
    }
    tableBody.innerHTML = html;

    // --- C) GELECEK TAHMİNİ (MOTOR) ---
    let lastData = yearlyStats[years[0]]; 
    let firstData = yearlyStats[years[years.length-1]]; 
    let totalYears = years.length;
    
    let avgPullback = 0.20; 
    if(pullbacks.length > 0) avgPullback = pullbacks.reduce((a, b) => a + b, 0) / pullbacks.length;
    if(avgPullback > 0.60) avgPullback = 0.60; 

    let cagr = 5; 
    if(firstData && lastData && firstData.close > 0) {
        cagr = (Math.pow((lastData.close / firstData.close), (1 / totalYears)) - 1) * 100;
    }

    let volumeSentiment = 1.0; 
    let sentimentLabel = "Nötr";
    if(volumeTrend.length >= 3) {
        let recentVol = (volumeTrend[0] + volumeTrend[1]) / 2; 
        let pastVol = 0;
        for(let k=2; k<volumeTrend.length; k++) pastVol += volumeTrend[k];
        pastVol = pastVol / (volumeTrend.length - 2); 

        if(pastVol > 0) {
            let ratio = recentVol / pastVol;
            if(ratio > 1.5) { volumeSentiment = 1.15; sentimentLabel = "Hacim İlgisi Yüksek"; }
            else if(ratio < 0.5) { volumeSentiment = 0.85; sentimentLabel = "İlgi Kaybı / Hacim Düşük"; }
            else if(ratio >= 0.8 && ratio <= 1.2) { volumeSentiment = 1.05; sentimentLabel = "İstikrarlı / Toplama"; }
        }
    }

    if(lastData.mcap > 500000000000) cagr *= 0.60; 
    else if(lastData.mcap > 50000000000) cagr *= 0.80; 
    
    cagr = cagr * volumeSentiment;
    if(cagr > 80) cagr = 60 + (cagr - 60) * 0.1; 
    if(cagr < 5) cagr = 5; 

    let avgGrowth = cagr;

    // --- D) UI BİLGİ KUTULARI (EXTRA UYARI) ---
    // Anomali ve Risk Bilgisini Liste Başına Basıyoruz
    let warningHtml = `
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px;">
        <div style="background:rgba(255,255,255,0.05); padding:8px; border-radius:8px; text-align:center;">
            <div style="font-size:9px; color:var(--text-sub);">HACİM ANALİZİ</div>
            <div style="font-size:11px; font-weight:700; color:${volumeSentiment > 1 ? '#10b981' : (volumeSentiment < 1 ? '#ef4444' : '#f59e0b')}">${sentimentLabel}</div>
        </div>
        <div style="background:rgba(255,255,255,0.05); padding:8px; border-radius:8px; text-align:center;">
            <div style="font-size:9px; color:var(--text-sub);">ANLIK SAPMA RİSKİ</div>
            <div style="font-size:11px; font-weight:700; color:${riskColor};">${riskLabel} (σ:${stdDev.toFixed(1)})</div>
        </div>
    </div>
    
    <div style="background:rgba(239,68,68,0.1); border:1px dashed rgba(239,68,68,0.3); padding:8px; border-radius:8px; font-size:10px; color:#fca5a5; margin-bottom:10px; line-height:1.4;">
        <i class="fas fa-exclamation-circle"></i> <b>Sapma Uyarısı:</b> Geçmişte ${crashEvents} kez ani çöküş, ${pumpEvents} kez ani fırlama (Anomali) yaşanmış. Tahminlerde bu sapmaları dikkate alınız.
    </div>
    `;

    projList.innerHTML = warningHtml;

    // --- E) PROJEKSİYON DÖNGÜSÜ ---
    let basePriceUSD = lastData.close;
    let currentYear = new Date().getFullYear();
    let projHTML = "";

    for(let j=1; j<=5; j++) {
        let fYear = currentYear + j;
        let decay = 1 - (j * 0.10); 
        if(decay < 0.4) decay = 0.4; 

        let yearlyGrowth = avgGrowth * decay;
        basePriceUSD = basePriceUSD * (1 + (yearlyGrowth/100));
        
        let highPriceUSD = basePriceUSD * (1 + avgPullback/1.5);
        let lowPriceUSD = basePriceUSD * (1 - avgPullback);

        let displayBase = isTR ? basePriceUSD * currencyRate : basePriceUSD;
        let displayHigh = isTR ? highPriceUSD * currencyRate : highPriceUSD;
        let displayLow = isTR ? lowPriceUSD * currencyRate : lowPriceUSD;

        projHTML += `
        <div style="background:rgba(255,255,255,0.03); padding:8px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
            <div style="display:flex; align-items:center; gap:8px;">
                <div style="font-weight:700; color:#60a5fa; font-size:12px;">${fYear}</div>
                <div style="font-size:9px; color:#94a3b8;">
                    <span style="display:block; color:#10b981;">Üst: ${sym}${parseInt(displayHigh).toLocaleString()}</span>
                    <span style="display:block; color:#ef4444;">Alt: ${sym}${parseInt(displayLow).toLocaleString()}</span>
                </div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:10px; color:#94a3b8; margin-bottom:1px;">Olası Merkez</div>
                <div style="font-weight:800; font-size:13px; color:white;">${sym}${parseInt(displayBase).toLocaleString()}</div>
            </div>
        </div>`;
    }
    projList.insertAdjacentHTML('beforeend', projHTML);
}

</script>
</body>
</html>

